(window.webpackJsonp=window.webpackJsonp||[]).push([[7],[function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(5),i=s.n(n);i.a.methodFactory=function(e,t,s){return function(...t){return"error"===e||"warn"===e||"trace"===e||"info"===e?console[e](...t):console.log(...t)}};const o=i.a.getLogger("matrix");o.setLevel(i.a.levels.DEBUG)},function(e,t,s){"use strict";s.d(t,"e",(function(){return o})),s.d(t,"f",(function(){return r})),s.d(t,"u",(function(){return a})),s.d(t,"j",(function(){return c})),s.d(t,"t",(function(){return l})),s.d(t,"B",(function(){return d})),s.d(t,"l",(function(){return u})),s.d(t,"k",(function(){return h})),s.d(t,"y",(function(){return m})),s.d(t,"q",(function(){return p})),s.d(t,"p",(function(){return g})),s.d(t,"a",(function(){return f})),s.d(t,"c",(function(){return _})),s.d(t,"b",(function(){return v})),s.d(t,"i",(function(){return y})),s.d(t,"o",(function(){return b})),s.d(t,"v",(function(){return E})),s.d(t,"s",(function(){return S})),s.d(t,"z",(function(){return w})),s.d(t,"h",(function(){return R})),s.d(t,"n",(function(){return k})),s.d(t,"g",(function(){return I})),s.d(t,"A",(function(){return O})),s.d(t,"r",(function(){return T})),s.d(t,"d",(function(){return x})),s.d(t,"w",(function(){return N})),s.d(t,"x",(function(){return j})),s.d(t,"m",(function(){return D}));var n=s(17),i=s.n(n);function o(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(t+="&"+encodeURIComponent(s)+"="+encodeURIComponent(e[s]));return t.substring(1)}function r(e,t){for(const s in t)t.hasOwnProperty(s)&&(e=e.replace(s,encodeURIComponent(t[s])));return e}function a(e,t){const s=new Array(e.length);for(let n=0;n<e.length;n++)s[n]=t(e[n]);return s}function c(e,t){const s=[];for(let n=0;n<e.length;n++)t(e[n],n,e)&&s.push(e[n]);return s}function l(e){const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push(s);return t}function d(e){const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push(e[s]);return t}function u(e,t){for(let s=0;s<e.length;s++)t(e[s],s)}function h(e,t,s){let n;if(s){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e[n]}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e[n]}function m(e,t,s){let n,i;if(s){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i;return!1}function p(e){return"[object Function]"===Object.prototype.toString.call(e)}function g(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)}function f(e,t){for(let s=0;s<t.length;s++)if(!e.hasOwnProperty(t[s]))throw new Error("Missing required key: "+t[s])}function _(e){return JSON.parse(JSON.stringify(e))}function v(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(e instanceof Array){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!v(e[s],t[s]))return!1}else{let s;for(s in t)if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;for(s in t){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(!v(e[s],t[s]))return!1}}return!0}function y(...e){const t=e[0]||{};for(let s=1;s<e.length;s++){const n=e[s];if(n)for(const e in n)t[e]=n[e]}return t}function b(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function E(e,t,...s){try{t.call(e,...s)}catch(n){const i=new t(...s);Object.assign(e,i)}}function S(e){return"number"==typeof e&&isFinite(e)}function w(e){return"string"==typeof e?i()(e.normalize("NFD").replace(C,"")):""}const C=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(e,t){t="boolean"!=typeof t||t;let s=R(e);return s=s.replace(/\\\*/g,".*"),s=s.replace(/\?/g,"."),t&&(s=s.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,s,n,i){return"["+(t?"^":"")+s.replace(/\\-/,"-")+"]"}))),s}function I(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e}function O(e,t){return new Promise(s=>{setTimeout(s,e,t)})}function T(e){return null==e}function x(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}}async function N(e,t){for(const s of await e)await t(await s)}function j(e){return new Promise(t=>t(e()))}let P;function D(){return P}},,function(e,t,s){"use strict";function n(e){return e.slice(0,e.length)}function i(e,t){if(e.length===t.length){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!0;return!1}return!0}function o(e,t){return e.length!==t.length||(!!t.some(t=>!e.includes(t))||!!e.some(e=>!t.includes(e)))}function r(e,t){return{added:t.filter(t=>!e.includes(t)),removed:e.filter(e=>!t.includes(e))}}function a(e,t){return e.filter(e=>t.includes(e))}function c(...e){return Array.from(e.reduce((e,t)=>(t.forEach(t=>e.add(t)),e),new Set))}s.d(t,"c",(function(){return n})),s.d(t,"e",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"b",(function(){return r})),s.d(t,"g",(function(){return a})),s.d(t,"f",(function(){return c})),s.d(t,"a",(function(){return l}));class l{constructor(e){this.a=e}get value(){return this.a}groupBy(e){const t=this.a.reduce((t,s)=>{const n=e(s);return t.has(n)||t.set(n,[]),t.get(n).push(s),t},new Map);return new d(t)}}class d{constructor(e){this.val=e}orderBy(e){const t=[];for(const s of e)this.val.has(s)&&t.push(...this.val.get(s));return new l(t)}}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return u}));var n=s(2),i=s.n(n),o=s(12),r=s(10),a=s(11);let c,l,d;!function(e){e.Screenshot="m.capability.screenshot",e.Sticker="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.ReceiveTerminate="im.vector.receive_terminate"}(c||(c={})),function(e){e.GetSupportedApiVersions="supported_api_versions",e.TakeScreenshot="screenshot",e.GetCapabilities="capabilities",e.SendEvent="send_event",e.UpdateVisibility="visibility",e.GetOpenIDCredentials="get_openid",e.ReceiveOpenIDCredentials="openid_credentials",e.SetAlwaysOnScreen="set_always_on_screen",e.ClientReady="im.vector.ready",e.Terminate="im.vector.terminate"}(l||(l={})),function(e){e.ToWidget="toWidget",e.FromWidget="fromWidget"}(d||(d={}));class u extends r.EventEmitter{constructor(e,t,s){super(),this.widgetId=t,this.requestedCapabilities=s,i()(this,"origin",void 0),i()(this,"inFlightRequests",{}),i()(this,"readyPromise",void 0),i()(this,"readyPromiseResolve",void 0),i()(this,"openIDCredentialsCallback",void 0),i()(this,"openIDCredentials",void 0),i()(this,"expectingExplicitReady",!1),this.origin=new URL(e).origin,this.readyPromise=new Promise(e=>this.readyPromiseResolve=e),window.addEventListener("message",e=>{if(e.origin!==this.origin)return;if(!e.data)return;if(e.data.widgetId!==this.widgetId)return;const t=e.data;if(t.api===d.ToWidget&&t.action)if(console.log("[WidgetAPI] Got request: "+JSON.stringify(t)),t.action===l.GetCapabilities)this.onCapabilitiesRequest(t),this.expectingExplicitReady||this.readyPromiseResolve();else if(t.action===l.ClientReady)this.readyPromiseResolve(),this.replyToRequest(t,{});else if(t.action===l.Terminate){let e=Promise.resolve();const s=t=>{e=e.then(()=>t)};this.emit("terminate",s),Promise.resolve(e).then(()=>{this.replyToRequest(t,{})})}else t.action===l.ReceiveOpenIDCredentials?(this.setOpenIDCredentials(t),this.replyToRequest(t,{})):console.warn("[WidgetAPI] Got unexpected action: "+t.action);else if(t.api===d.FromWidget&&this.inFlightRequests[t.requestId]){console.log("[WidgetAPI] Got reply: "+JSON.stringify(t));const e=this.inFlightRequests[t.requestId];delete this.inFlightRequests[t.requestId],e(t)}else console.warn("[WidgetAPI] Unhandled payload: "+JSON.stringify(t))})}setOpenIDCredentials(e){const t=e.data;"allowed"===t.state?this.openIDCredentials={accessToken:t.access_token,tokenType:t.token_type,matrixServerName:t.matrix_server_name,expiresIn:t.expires_in}:"blocked"===t.state&&(this.openIDCredentials=null),["allowed","blocked"].includes(t.state)&&this.openIDCredentialsCallback&&this.openIDCredentialsCallback()}requestOpenIDCredentials(e){this.openIDCredentialsCallback=e,this.callAction(l.GetOpenIDCredentials,{},this.setOpenIDCredentials)}waitReady(){return this.readyPromise}replyToRequest(e,t){if(!window.parent)return;const s=Object(a.a)(e);s.response=t,window.parent.postMessage(s,this.origin)}onCapabilitiesRequest(e){return this.replyToRequest(e,{capabilities:this.requestedCapabilities})}callAction(e,t,s){if(!window.parent)return;const n={api:d.FromWidget,widgetId:this.widgetId,action:e,requestId:Object(o.a)(160),data:t,response:{}};s&&(this.inFlightRequests[n.requestId]=s),console.log("[WidgetAPI] Sending request: ",n),window.parent.postMessage(n,"*")}setAlwaysOnScreen(e){return new Promise(t=>{this.callAction(l.SetAlwaysOnScreen,{value:e},null),t()})}}},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"f",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"c",(function(){return a})),s.d(t,"d",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(3);function i(e,t){const s=new Map(Object.entries(e));for(const e of t)s.delete(e);return Array.from(s.entries()).reduce((e,[t,s])=>(e[t]=s,e),{})}function o(e,t){const s=Object.keys(e),o=Object(n.b)(s,t);return 0===o.removed.length?r(e):i(e,o.removed)}function r(e,t){const s={};for(const[n,i]of Object.entries(e))s[n]=i,t&&(s[n]=t(n,i));return s}function a(e,t){const s=Object.keys(e),i=Object.keys(t);if(Object(n.d)(s,i))return!0;return Object(n.g)(s,i).some(s=>e[s]!==t[s])}function c(e,t){const s=function(e,t){const s=Object.keys(e),i=Object.keys(t),o=Object(n.b)(s,i);return{changed:Object(n.g)(s,i).filter(s=>e[s]!==t[s]),added:o.added,removed:o.removed}}(e,t);return Object(n.f)(s.removed,s.added,s.changed)}function l(e){return JSON.parse(JSON.stringify(e))}},function(e,t,s){"use strict";function n(e){let t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;++n)t+=s.charAt(Math.floor(Math.random()*s.length));return t}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(1);class o{constructor(e){(e=e||{}).maxTimelineEntries=e.maxTimelineEntries||50,this.opts=e,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}accumulate(e){this._accumulateRooms(e),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}_accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}_accumulateRooms(e){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(t=>{this._accumulateRoom(t,"invite",e.rooms.invite[t])}),e.rooms.join&&Object.keys(e.rooms.join).forEach(t=>{this._accumulateRoom(t,"join",e.rooms.join[t])}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(t=>{this._accumulateRoom(t,"leave",e.rooms.leave[t])}))}_accumulateRoom(e,t,s){switch(t){case"invite":this._accumulateInviteState(e,s);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,s);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:n.a.error("Unknown cateogory: ",t)}}_accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const s=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let n=0;n<s.invite_state.events.length;n++){const i=s.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(s.invite_state.events[n]=e,t=!0)}t||s.invite_state.events.push(e)})}_accumulateJoinState(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const s=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{s._accountData[e.type]=e}),t.unread_notifications&&(s._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",i="m.joined_member_count",o=s._summary,r=t.summary;o[e]=r[e]||o[e],o[i]=r[i]||o[i],o[n]=r[n]||o[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(n=>{s._readReceipts[n]={data:e.content[t]["m.read"][n],eventId:t}})})}),t.timeline&&t.timeline.limited&&(s._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{r(s._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,n)=>{r(s._currentState,e),s._timeline.push({event:e,token:0===n?t.timeline.prev_batch:null})}),s._timeline.length>this.opts.maxTimelineEntries){for(let e=s._timeline.length-this.opts.maxTimelineEntries;e<s._timeline.length;e++)if(s._timeline[e].token){s._timeline=s._timeline.slice(e,s._timeline.length);break}}}_accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach(t=>{this._accumulateGroup(t,"invite",e.groups.invite[t])}),e.groups.join&&Object.keys(e.groups.join).forEach(t=>{this._accumulateGroup(t,"join",e.groups.join[t])}),e.groups.leave&&Object.keys(e.groups.leave).forEach(t=>{this._accumulateGroup(t,"leave",e.groups.leave[t])}))}_accumulateGroup(e,t,s){for(const t of["invite","join","leave"])delete this.groups[t][e];this.groups[t][e]=s}getJSON(){const e={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(t=>{e.invite[t]=this.inviteRooms[t]}),Object.keys(this.joinRooms).forEach(t=>{const s=this.joinRooms[t],n={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:s._unreadNotifications,summary:s._summary};Object.keys(s._accountData).forEach(e=>{n.account_data.events.push(s._accountData[e])});const o={type:"m.receipt",room_id:t,content:{}};Object.keys(s._readReceipts).forEach(e=>{const t=s._readReceipts[e];o.content[t.eventId]||(o.content[t.eventId]={"m.read":{}}),o.content[t.eventId]["m.read"][e]=t.data}),Object.keys(o.content).length>0&&n.ephemeral.events.push(o),s._timeline.forEach(e=>{if(!n.timeline.prev_batch){if(!e.token)return;n.timeline.prev_batch=e.token}n.timeline.events.push(e.event)});const a=Object.create(null);for(let e=n.timeline.events.length-1;e>=0;e--){const t=n.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const s=Object(i.c)(t);s.unsigned&&(s.unsigned.prev_content&&(s.content=s.unsigned.prev_content),s.unsigned.prev_sender&&(s.sender=s.unsigned.prev_sender)),r(a,s)}Object.keys(s._currentState).forEach(e=>{Object.keys(s._currentState[e]).forEach(t=>{let i=s._currentState[e][t];a[e]&&a[e][t]&&(i=a[e][t]),n.state.events.push(i)})}),e.join[t]=n});const t=[];return Object.keys(this.accountData).forEach(e=>{t.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:e,groupsData:this.groups,accountData:t}}getNextBatchToken(){return this.nextBatch}}function r(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},function(e,t,s){"use strict";function n(e,t){return new Promise((s,n)=>{let i=!0;const o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),s(i)},o.onerror=e=>n(e.target.error)})}s.d(t,"a",(function(){return n}))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(13),i=s(1),o=s(14),r=s(0);function a(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(i.push(s(n)),n.continue()):e(i)}})}function c(e){return new Promise((t,s)=>{e.oncomplete=function(e){t(e)},e.onerror=function(e){s(e.target.error)}})}function l(e){return new Promise((t,s)=>{e.onsuccess=function(e){t(e)},e.onerror=function(e){s(e.target.error)}})}function d(e){return l(e).then(e=>e.target.result)}function u(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new n.a,this._isNewlyCreated=!1}u.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),o.a(e,t)},u.prototype={connect:function(){if(!this._disconnected)return r.a.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,r.a.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this._dbName,3);return e.onupgradeneeded=e=>{const t=e.target.result,s=e.oldVersion;r.a.log("LocalIndexedDBStoreBackend.connect: upgrading from "+s),s<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(t)),s<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(t),s<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(t)},e.onblocked=()=>{r.a.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},r.a.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),l(e).then(e=>(r.a.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.target.result,this.db.onversionchange=()=>{this.db.close()},this._init()))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){return Promise.all([this._loadAccountData(),this._loadSyncData()]).then(([e,t])=>{r.a.log("LocalIndexedDBStoreBackend: loaded initial data"),this._syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}})})},getOutOfBandMembers:function(e){return new Promise((t,s)=>{const n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=n.openCursor(i),r=[];let a=!1;o.onsuccess=e=>{const s=e.target.result;if(!s)return r.length||a?t(r):t(null);const n=s.value;n.oob_written?a=!0:r.push(n),s.continue()},o.onerror=e=>{s(e)}}).then(t=>(r.a.log("LL: got "+(t&&t.length)+` membershipEvents from storage for room ${e} ...`),t))},setOutOfBandMembers:async function(e,t){r.a.log("LL: backend about to store "+t.length+" members for "+e);const s=this.db.transaction(["oob_membership_events"],"readwrite"),n=s.objectStore("oob_membership_events");t.forEach(e=>{n.put(e)});const i={room_id:e,oob_written:!0,state_key:0};n.put(i),await c(s),r.a.log(`LL: backend done storing for ${e}!`)},clearOutOfBandMembers:async function(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),n=d(t.openKeyCursor(s,"next")).then(e=>e&&e.primaryKey[1]),i=d(t.openKeyCursor(s,"prev")).then(e=>e&&e.primaryKey[1]),[o,a]=await Promise.all([n,i]),c=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),l=IDBKeyRange.bound([e,o],[e,a]);var u;r.a.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,a]),await(u=c.delete(l),new Promise((e,t)=>{u.onsuccess=()=>e(u),u.onerror=e=>t(e)}))},clearDatabase:function(){return new Promise((e,t)=>{r.a.log("Removing indexeddb instance: "+this._dbName);const s=this.indexedDB.deleteDatabase(this._dbName);s.onblocked=()=>{r.a.log("can't yet delete indexeddb "+this._dbName+" because it is open elsewhere")},s.onerror=t=>{r.a.warn("unable to delete js-sdk store indexeddb: "+t.target.error),e()},s.onsuccess=()=>{r.a.log("Removed indexeddb instance: "+this._dbName),e()}})},getSavedSync:function(e){void 0===e&&(e=!0);const t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(i.c(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){return Promise.resolve().then(()=>{this._syncAccumulator.accumulate(e)})},syncToDatabase:function(e){const t=this._syncAccumulator.getJSON();return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,s){return r.a.log("Persisting sync data up to ",e),i.x(()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:s}),c(n)})},_persistAccountData:function(e){return i.x(()=>{const t=this.db.transaction(["accountData"],"readwrite"),s=t.objectStore("accountData");for(let t=0;t<e.length;t++)s.put(e[t]);return c(t)})},_persistUserPresenceEvents:function(e){return i.x(()=>{const t=this.db.transaction(["users"],"readwrite"),s=t.objectStore("users");for(const t of e)s.put({userId:t[0],event:t[1]});return c(t)})},getUserPresenceEvents:function(){return i.x(()=>a(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))},_loadAccountData:function(){return r.a.log("LocalIndexedDBStoreBackend: loading account data..."),i.x(()=>a(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(r.a.log("LocalIndexedDBStoreBackend: loaded account data"),e)))},_loadSyncData:function(){return r.a.log("LocalIndexedDBStoreBackend: loading sync data..."),i.x(()=>a(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(r.a.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&r.a.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))},getClientOptions:function(){return Promise.resolve().then(()=>a(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{if(e.value&&e.value&&e.value.options)return e.value.options}).then(e=>e[0]))},storeClientOptions:async function(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await c(t)}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(15),i=s.n(n);async function o(e=""){""===e||e.endsWith("/")||(e+="/");const t=r(`${e}config.${document.domain}.json`),s=r(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return await s}}function r(e){return new Promise((function(t,s){i()({method:"GET",url:e,qs:{cachebuster:Date.now()}},(e,n,i)=>{try{if(e||n.status<200||n.status>=300)return n&&(404==n.status||0==n.status&&""==i)&&t({}),void s({err:e,response:n});t(JSON.parse(i))}catch(e){s({err:e})}})}))}},,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"rageshakePromise",(function(){return z})),s.d(t,"preparePlatform",(function(){return Y})),s.d(t,"loadConfig",(function(){return J})),s.d(t,"loadOlm",(function(){return Q})),s.d(t,"loadLanguage",(function(){return X})),s.d(t,"loadSkin",(function(){return Z})),s.d(t,"loadTheme",(function(){return ee})),s.d(t,"loadApp",(function(){return te})),s.d(t,"showError",(function(){return se})),s.d(t,"showIncompatibleBrowser",(function(){return ne})),s.d(t,"_t",(function(){return ie}));var n=s(553),i=s(554),o=s.n(i),r=s(79),a=s(43),c=s.n(a),l=s(44),d=s(50),u=s(154),h=s.n(u),m=s(180),p=s(18),g=s(1143);class f extends m.d{constructor(...e){super(...e),h()(this,"_favicon",void 0)}async getConfig(){return Object(p.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon?this._favicon:this._favicon=new g.a}_updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this._updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this._updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(l.a)("Unknown device")}}var _=s(48),v=s(53),y=s(358),b=s(49),E=s(538),S=s(99),w=s(338),C=s(58),R=s(12),k=s(54),I=s(336),O=s(78),T=s(548);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const N=window.ipcRenderer,j=navigator.platform.toUpperCase().includes("MAC");function P(e){["call_state"].includes(e.action)&&N.send("app_onAction",e)}class D extends class{async supportsEventIndexing(){return!0}async initEventIndex(){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,s){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}{constructor(){super(),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),N.on("seshatReply",this._onIpcReply)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.ipcRenderer.send("seshat",{id:s,name:e,args:t})})}async supportsEventIndexing(){return this._ipcCall("supportsEventIndexing")}async initEventIndex(){return this._ipcCall("initEventIndex")}async addEventToIndex(e,t){return this._ipcCall("addEventToIndex",e,t)}async deleteEvent(e){return this._ipcCall("deleteEvent",e)}async isEventIndexEmpty(){return this._ipcCall("isEventIndexEmpty")}async isRoomIndexed(e){return this._ipcCall("isRoomIndexed",e)}async commitLiveEvents(){return this._ipcCall("commitLiveEvents")}async searchEventIndex(e){return this._ipcCall("searchEventIndex",e)}async addHistoricEvents(e,t,s){return this._ipcCall("addHistoricEvents",e,t,s)}async addCrawlerCheckpoint(e){return this._ipcCall("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this._ipcCall("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this._ipcCall("loadFileEvents",e)}async loadCheckpoints(){return this._ipcCall("loadCheckpoints")}async closeEventIndex(){return this._ipcCall("closeEventIndex")}async getStats(){return this._ipcCall("getStats")}async getUserVersion(){return this._ipcCall("getUserVersion")}async setUserVersion(e){return this._ipcCall("setUserVersion",e)}async deleteEventIndex(){return this._ipcCall("deleteEventIndex")}}class A extends f{constructor(){super(),h()(this,"eventIndexManager",new D),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"ssoID",Object(R.a)(32)),h()(this,"onUpdateDownloaded",async(e,{releaseNotes:t,releaseName:s})=>{_.a.dispatch({action:k.a.CheckUpdates,status:m.c.Ready}),this.shouldShowUpdate(s)&&Object(I.b)(await this.getAppVersion(),s,t)}),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),_.a.register(P),N.on("check_updates",(e,t)=>{_.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:k.a.CheckUpdates},function(e){return!0===e?{status:m.c.Downloading}:!1===e?{status:m.c.NotAvailable}:{status:m.c.Error,detail:e}}(t)))}),N.on("before-quit",(function(){console.log("riot-desktop closing"),y.b()})),N.on("ipcReply",this._onIpcReply),N.on("update-downloaded",this.onUpdateDownloaded),N.on("preferences",()=>{_.a.fire(k.a.ViewUserSettings)}),N.on("userDownloadCompleted",(e,{path:t,name:s})=>{O.a.sharedInstance().addOrReplaceToast({key:"DOWNLOAD_TOAST_"+t,title:Object(l.a)("Download Completed"),props:{description:s,acceptLabel:Object(l.a)("Open"),onAccept:()=>{N.send("userDownloadOpen",{path:t})},dismissLabel:Object(l.a)("Dismiss"),numSeconds:10},component:T.a,priority:99})}),j?(Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.COMMAND],key:C.a.COMMA}],description:Object(l.b)("Open user settings")}),Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.COMMAND],key:C.a.SQUARE_BRACKET_LEFT},{modifiers:[w.b.COMMAND],key:C.a.SQUARE_BRACKET_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")})):Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.ALT],key:C.a.ARROW_LEFT},{modifiers:[w.b.ALT],key:C.a.ARROW_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")}),this._ipcCall("startSSOFlow",this.ssoID)}async getConfig(){return this._ipcCall("getConfig")}getHumanReadableName(){return"Electron Platform"}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),N.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,s,n){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const i={body:t,silent:!0};s&&(i.icon=s);const o=new window.Notification(e,i);return o.onclick=()=>{_.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),this._ipcCall("focusWindow")},o}loudNotification(e,t){N.send("loudNotification")}async getAppVersion(){return this._ipcCall("getAppVersion")}supportsAutoLaunch(){return!0}async getAutoLaunchEnabled(){return this._ipcCall("getAutoLaunchEnabled")}async setAutoLaunchEnabled(e){return this._ipcCall("setAutoLaunchEnabled",e)}supportsAutoHideMenuBar(){return!j}async getAutoHideMenuBarEnabled(){return this._ipcCall("getAutoHideMenuBarEnabled")}async setAutoHideMenuBarEnabled(e){return this._ipcCall("setAutoHideMenuBarEnabled",e)}supportsMinimizeToTray(){return!j}async getMinimizeToTrayEnabled(){return this._ipcCall("getMinimizeToTrayEnabled")}async setMinimizeToTrayEnabled(e){return this._ipcCall("setMinimizeToTrayEnabled",e)}async canSelfUpdate(){const e=await this._ipcCall("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),N.send("check_updates")}installUpdate(){N.send("install_update")}getDefaultDeviceDisplayName(){const e=v.a.get().brand;return Object(l.a)("%(brand)s Desktop (%(platformName)s)",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}screenCaptureErrorString(){return null}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload(!1)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.ipcRenderer.send("ipcCall",{id:s,name:e,args:t})})}getEventIndexingManager(){return this.eventIndexManager}setLanguage(e){this._ipcCall("setLanguage",e).catch(e=>{console.log("Failed to send setLanguage IPC to Electron"),console.error(e)})}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,s){super.startSingleSignOn(e,t,s),b.a.createTrackedDialog("Electron","SSO",E.a,{title:Object(l.a)("Go to your browser to complete Sign In"),description:c.a.createElement(S.a,null)})}_navigateForwardBack(e){this._ipcCall(e?"navigateBack":"navigateForward")}onKeyDown(e){let t=!1;switch(e.key){case C.a.SQUARE_BRACKET_LEFT:case C.a.SQUARE_BRACKET_RIGHT:!j||!e.metaKey||e.altKey||e.ctrlKey||e.shiftKey||(this._navigateForwardBack(e.key===C.a.SQUARE_BRACKET_LEFT),t=!0);break;case C.a.ARROW_LEFT:case C.a.ARROW_RIGHT:j||!e.altKey||e.metaKey||e.ctrlKey||e.shiftKey||(this._navigateForwardBack(e.key===C.a.ARROW_LEFT),t=!0)}return t}async getPickleKey(e,t){try{return await this._ipcCall("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this._ipcCall("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this._ipcCall("destroyPickleKey",e,t)}catch(e){}}}var U=s(15),M=s.n(U),L=s(66),F=s.n(L),B=s(1144),V=s.n(B);function K(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class q extends f{constructor(...e){super(...e),h()(this,"runningVersion",null),h()(this,"pollForUpdate",()=>this._getVersion().then(e=>{if(null===this.runningVersion)this.runningVersion=e;else{if(this.runningVersion!==e)return this.shouldShowUpdate(e)&&Object(I.b)(this.runningVersion,e),{status:m.c.Ready};Object(I.a)()}return{status:m.c.NotAvailable}},e=>(console.error("Failed to poll for update",e),{status:m.c.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"})))}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e,t){window.Notification.requestPermission(t=>{e(t)})}))}displayNotification(e,t,s,n){const i={body:t,tag:"vector",silent:!0};s&&(i.icon=s);const o=new window.Notification(e,i);o.onclick=function(){_.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),o.close()}}_getVersion(){return new Promise((function(e,t){M()({method:"GET",url:"version",qs:{cachebuster:Date.now()}},(s,n,i)=>{if(s||n.status<200||n.status>=300)return null===s&&(s={status:n.status}),void t(s);const o=i.trim();e(o)})}))}getAppVersion(){return null!==this.runningVersion?Promise.resolve(this.runningVersion):this._getVersion()}startUpdater(){this.pollForUpdate(),setInterval(this.pollForUpdate,6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate().then(e=>{_.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?K(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):K(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:k.a.CheckUpdates},e))})}installUpdate(){window.location.reload(!0)}getDefaultDeviceDisplayName(){const e=F.a.parse(window.location.href);e.protocol="",e.search="",e.hash="",e.pathname=e.pathname.replace(/\/$/,"");let t=e.format();t=t.replace(/^\/\//,"");const s=new V.a,n=s.getBrowser().name||"unknown browser";let i=s.getOS().name||"unknown OS";return"Mac OS"===i&&(i="macOS"),Object(l.a)("%(appName)s (%(browserName)s, %(osName)s)",{appName:t,browserName:n,osName:i})}screenCaptureErrorString(){return"https:"!==window.location.protocol?Object(l.a)("You need to be using HTTPS to place a screen-sharing call."):null}reload(){window.location.reload(!1)}}class G extends q{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch(e=>{console.error("Failed to update PWA app badge",e)}))}}var W=s(62),H=s(216),$=s(526);window.mxSendRageshake=function(e,t){void 0===t&&(t=!0),e&&e.trim()?Object($.a)(v.a.get().bug_report_endpoint_url,{userText:e,sendLogs:t,progressCallback:console.log.bind(console)}).then(()=>{console.log("Bug report sent!")},e=>{console.error(e)}):console.error("Cannot send a rageshake without a message - please tell us what went wrong")};const z=function(){const e=y.d();return e.then(()=>{console.log("Initialised rageshake."),console.log("To fix line numbers in Chrome: Meatball menu → Settings → Blackboxing → Add /rageshake\\.js$"),window.addEventListener("beforeunload",e=>{console.log("riot-web closing"),y.b()}),y.a()},e=>{console.error("Failed to initialise rageshake: "+e)}),e}();function Y(){window.ipcRenderer?(console.log("Using Electron platform"),W.a.set(new A)):window.matchMedia("(display-mode: standalone)").matches?(console.log("Using PWA platform"),W.a.set(new G)):(console.log("Using Web platform"),W.a.set(new q))}async function J(){v.a.put(await W.a.get().getConfig()||{})}function Q(){return o.a.init({locateFile:()=>n.a}).then(()=>{console.log("Using WebAssembly Olm")}).catch(e=>(console.log("Failed to load Olm: trying legacy version",e),new Promise((e,t)=>{const s=document.createElement("script");s.src="olm_legacy.js",s.onload=e,s.onerror=t,document.body.appendChild(s)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})))}async function X(){const e=d.a.getValue("language",null,!0);let t=[];e?t=[e]:l.f().forEach(e=>{t.push(...l.g(e))});try{await l.k(t),document.documentElement.setAttribute("lang",l.d())}catch(e){console.error("Unable to set language",e)}}async function Z(){console.log("Loading skin...");const[e,t]=await Promise.all([Promise.resolve().then(s.bind(null,46)),s.e(11).then(s.bind(null,1168))]);e.loadSkin(t),console.log("Skin loaded!")}async function ee(){Object(H.d)()}async function te(e){const t=await s.e(10).then(s.bind(null,1160));window.matrixChat=r.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function se(e,t){const n=(await s.e(5).then(s.bind(null,1161))).default;window.matrixChat=r.render(a.createElement(n,{title:e,messages:t}),document.getElementById("matrixchat"))}async function ne(e){const t=(await s.e(4).then(s.bind(null,1162))).default;window.matrixChat=r.render(a.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}const ie=l.a},,function(e,t,s){"use strict";s.d(t,"h",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"a",(function(){return g})),s.d(t,"k",(function(){return _})),s.d(t,"c",(function(){return v})),s.d(t,"f",(function(){return y})),s.d(t,"e",(function(){return b})),s.d(t,"g",(function(){return E})),s.d(t,"i",(function(){return S})),s.d(t,"d",(function(){return w})),s.d(t,"j",(function(){return C}));var n=s(188),i=s.n(n),o=s(559),r=s.n(o),a=s(43),c=s.n(a),l=s(50),d=s(62),u=s.p+"i18n/languages.8d36ff3.json",h=s(57);function m(e){const t=new Error(e);return t.translatedMessage=g(e),t}function p(e){return e}function g(e,t,s){const n=function(e,t,s){let n=e;if(void 0!==t){const e={};for(const s in t)e[`%\\(${s}\\)s`]=t[s];n=f(n,e)}if(void 0!==s){const e={};for(const t in s)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=s[t];n=f(n,e)}return n}(function(e,t){let s;t&&"object"==typeof t&&(s=t.count,Object.keys(t).forEach(e=>{void 0===t[e]&&(console.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),t[e]="undefined"),null===t[e]&&(console.warn("safeCounterpartTranslate called with null interpolation name: "+e),t[e]="null")}));let n=r.a.translate(e,t);return void 0===n&&void 0!==s&&(n=r.a.translate(e,Object.assign({},t,{locale:"en"}))),n}(e,Object.assign({interpolate:!1},t)),t,s);return n}function f(e,t){const s=[e];let n=!1;for(const i in t){const o=new RegExp(i,"g");let r=!1;for(let e=0;e<s.length;e++){const a=s[e];if("string"!=typeof a)continue;let c=o.exec(a);if(!c)continue;r=!0;const l=a.substr(0,c.index),d=[];let u;for(;c;){u=c;const e=c.slice(2);let s,r;if(s=t[i]instanceof Function?t[i].apply(null,e):t[i],"object"==typeof s&&(n=!0),"string"==typeof s&&""===s||d.push(s),c=o.exec(a),c){const e=u.index+u[0].length;r=a.substr(e,c.index-e)}else r=a.substr(u.index+u[0].length);r&&d.push(r)}s.splice(e,1,...d),""!==l&&s.splice(e,0,l)}r||"%\\(count\\)s"!==i&&console.log(`Could not find ${o} in ${e}`)}return n?c.a.createElement("span",null,...s):s.join("")}function _(e){Array.isArray(e)||(e=[e]);const t=d.a.get();let s,n;return t&&t.setLanguage(e),R().then(t=>{n=t;for(let t=0;t<e.length;++t)if(n.hasOwnProperty(e[t])){s=e[t];break}return s||(s="en",console.error("Unable to find an appropriate language")),k("i18n/"+n[s].fileName)}).then(e=>{if(r.a.registerTranslations(s,e),r.a.setLocale(s),l.a.setValue("language",null,h.a.DEVICE,s),console.log("set language to "+s),"en"!==s)return k("i18n/"+n.en.fileName)}).then(e=>{e&&r.a.registerTranslations("en",e)})}function v(){return R().then(e=>{const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push({value:s,label:e[s].label});return t})}function y(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function b(){return y()[0]}function E(e){const t=[],s=S(e),n=s.split("-");return 2===n.length&&n[0]===n[1]?t.push(n[0]):(t.push(s),2===n.length&&t.push(n[0])),t}function S(e){return e.toLowerCase().replace("_","-")}function w(){return r.a.getLocale()}function C(e){const t=w(),s=e.map(S);{const n=s.indexOf(t);if(n>-1)return e[n]}{const n=s.findIndex(e=>e.substr(0,2)===t.substr(0,2));if(n>-1)return e[n]}{const t=s.findIndex(e=>e.startsWith("en"));if(t>-1)return e[t]}return e[0]}function R(){return new Promise((e,t)=>{let s;s="string"==typeof u?u:"i18n/languages.json",i()({method:"GET",url:s},(s,n,i)=>{s||n.status<200||n.status>=300?t(s):e(JSON.parse(i))})})}function k(e){return new Promise((t,s)=>{i()({method:"GET",url:e},(e,n,i)=>{e||n.status<200||n.status>=300?s(e):t(function(e){const t={};for(const s of Object.keys(e)){const n=s.split("|",2);if(2===n.length){let i=t[n[0]];void 0===i&&(i={},t[n[0]]=i),i[n[1]]=e[s]}else t[s]=e[s]}return t}(JSON.parse(i)))})})}r.a.setSeparator("|"),r.a.setFallbackLocale("en")},,function(e,t,s){"use strict";s.r(t),s.d(t,"loadSkin",(function(){return i})),s.d(t,"resetSkin",(function(){return o})),s.d(t,"getComponent",(function(){return r}));var n=s(597);function i(e){n.a.load(e)}function o(){n.a.reset()}function r(e){return n.a.getComponent(e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n=s(2),i=s.n(n),o=s(189),r=s(1),a=s(107),c=s(265),l=s(370),d=s(50),u=s(48);function h(e,t,s){return{action:"MatrixActions.sync",state:t,prevState:s,matrixClient:e}}function m(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function p(e,t,s){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:s}}function g(e,t){return{action:"MatrixActions.Room",room:t}}function f(e,t,s){return{action:"MatrixActions.Room.tags",room:s}}function _(e,t,s){return{action:"MatrixActions.Room.receipt",event:t,room:s,matrixClient:e}}function v(e,t,s,n,i,o){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:o.liveEvent,isLiveUnfilteredRoomTimelineEvent:s&&o.timeline.getTimelineSet()===s.getUnfilteredTimelineSet()}}function y(e,t,s,n){return{action:"MatrixActions.Room.myMembership",room:t,membership:s,oldMembership:n}}function b(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}var E={_matrixClientListenersStop:[],start(e){this._addMatrixClientListener(e,"sync",h),this._addMatrixClientListener(e,"accountData",m),this._addMatrixClientListener(e,"Room.accountData",p),this._addMatrixClientListener(e,"Room",g),this._addMatrixClientListener(e,"Room.tags",f),this._addMatrixClientListener(e,"Room.receipt",_),this._addMatrixClientListener(e,"Room.timeline",v),this._addMatrixClientListener(e,"Room.myMembership",y),this._addMatrixClientListener(e,"Event.decrypted",b)},_addMatrixClientListener(e,t,s){const n=(...t)=>{const n=s(e,...t);n&&u.a.dispatch(n,!0)};e.on(t,n),this._matrixClientListenersStop.push(()=>{e.removeListener(t,n)})},stop(){this._matrixClientListenersStop.forEach(e=>e())}},S=s(227),w=s(231),C=s(281),R=s(123),k=s(105),I=s(193);class O{constructor(){i()(this,"opts",{initialSyncLimit:20}),i()(this,"matrixClient",null),i()(this,"justRegisteredUserId",void 0),i()(this,"currentClientCreds",void 0)}setIndexedDbWorkerScript(e){l.a.indexedDbWorkerScript=e}get(){return this.matrixClient}unset(){this.matrixClient=null,E.stop()}setJustRegisteredUserId(e){this.justRegisteredUserId=e}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();console.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw console.error("Failed to start memory store!",t),t;console.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new o.a({localStorage:localStorage})}C.b(this.matrixClient);const e=r.c(this.opts);return e.pendingEventOrdering="detached",e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,E.start(this.matrixClient),w.a.matrixClient=this.matrixClient,e}async start(){const e=await this.assign();console.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),console.log("MatrixClientPeg: MatrixClient started")}getCredentials(){return{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()}}getHomeserverName(){const e=/^@.+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!d.a.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!d.a.getValue("fallbackICEServerAllowed"),verificationMethods:[S.d.SAS,I.d,S.d.RECIPROCATE_QR_CODE],unstableClientRelationAggregation:!0,identityServer:new R.a,cryptoCallbacks:{}};Object.assign(t.cryptoCallbacks,k.c),this.matrixClient=Object(l.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const s=new c.a(null,{timelineSupport:!0});s.getLiveTimeline().setPaginationToken("",a.a.BACKWARDS),this.matrixClient.setNotifTimelineSet(s)}}window.mxMatrixClientPeg||(window.mxMatrixClientPeg=new O);const T=window.mxMatrixClientPeg},function(e,t,s){"use strict";(function(e){var n=s(595),i=s(280);class o extends n.Dispatcher{dispatch(e,t=!1){e instanceof i.a?e.fn(e=>{this.dispatch(e,t)}):t?super.dispatch(e):setTimeout(super.dispatch.bind(this,e),0)}fire(e,t=!1){this.dispatch({action:e},t)}}const r=new o,a=e;a.mxDispatcher||(a.mxDispatcher=r),t.a=r}).call(this,s(6))},function(e,t,s){"use strict";var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(43),c=s.n(a),l=s(79),d=s.n(l),u=s(51),h=s.n(u),m=s(72),p=s(48),g=s(87),f=s(379);class _{constructor(){r()(this,"counter",0),r()(this,"priorityModal",null),r()(this,"staticModal",null),r()(this,"modals",[]),r()(this,"onBackgroundClick",()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=null)})}static getOrCreateContainer(){let e=document.getElementById("mx_Dialog_Container");return e||(e=document.createElement("div"),e.id="mx_Dialog_Container",document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById("mx_Dialog_StaticContainer");return e||(e=document.createElement("div"),e.id="mx_Dialog_StaticContainer",document.body.appendChild(e)),e}hasDialogs(){return this.priorityModal||this.staticModal||this.modals.length>0}createTrackedDialog(e,t,...s){return m.a.trackEvent("Modal",e,t),this.createDialog(...s)}appendTrackedDialog(e,t,...s){return m.a.trackEvent("Modal",e,t),this.appendDialog(...s)}createDialog(e,...t){return this.createDialogAsync(Promise.resolve(e),...t)}appendDialog(e,...t){return this.appendDialogAsync(Promise.resolve(e),...t)}createTrackedDialogAsync(e,t,...s){return m.a.trackEvent("Modal",e,t),this.createDialogAsync(...s)}appendTrackedDialogAsync(e,t,...s){return m.a.trackEvent("Modal",e,t),this.appendDialogAsync(...s)}buildModal(e,t,s,n){const o={onFinished:t?t.onFinished:null,onBeforeClose:n.onBeforeClose,beforeClosePromise:null,closeReason:null,className:s,elem:null,close:null},[r,a]=this.getCloseFn(o,t),l=this.counter++;return o.elem=c.a.createElement(f.a,i()({key:l,prom:e},t,{onFinished:r})),o.close=r,{modal:o,closeDialog:r,onFinishedProm:a}}getCloseFn(e,t){const s=Object(g.b)();return[async(...n)=>{if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=null,!t)return}s.resolve(n),t&&t.onFinished&&t.onFinished.apply(null,n);const i=this.modals.indexOf(e);i>=0&&this.modals.splice(i,1),this.priorityModal===e&&(this.priorityModal=null,this.modals=[]),this.staticModal===e&&(this.staticModal=null,this.modals=[]),this.reRender()},s.promise]}createDialogAsync(e,t,s,n=!1,i=!1,o={}){const{modal:r,closeDialog:a,onFinishedProm:c}=this.buildModal(e,t,s,o);return n?this.priorityModal=r:i?this.staticModal=r:this.modals.unshift(r),this.reRender(),{close:a,finished:c}}appendDialogAsync(e,t,s){const{modal:n,closeDialog:i,onFinishedProm:o}=this.buildModal(e,t,s,{});return this.modals.push(n),this.reRender(),{close:i,finished:o}}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}reRender(){if(0===this.modals.length&&!this.priorityModal&&!this.staticModal)return p.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(_.getOrCreateContainer()),void d.a.unmountComponentAtNode(_.getOrCreateStaticContainer());if(p.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=h()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=c.a.createElement("div",{className:e},c.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),c.a.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,_.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(_.getOrCreateStaticContainer());const e=this.getCurrentModal();if(e!==this.staticModal){const t=h()("mx_Dialog_wrapper",e.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),s=c.a.createElement("div",{className:t},c.a.createElement("div",{className:"mx_Dialog"},e.elem),c.a.createElement("div",{className:"mx_Dialog_background",onClick:this.onBackgroundClick}));d.a.render(s,_.getOrCreateContainer())}else d.a.unmountComponentAtNode(_.getOrCreateContainer())}}window.singletonModalManager||(window.singletonModalManager=new _),t.a=window.singletonModalManager},function(e,t,s){"use strict";s.d(t,"a",(function(){return ee}));var n=s(2),i=s.n(n),o=s(155),r=s(47),a=s(57);class c extends o.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e){const e=localStorage.getItem("notifications_enabled");return"string"==typeof e?"true"===e:null}if("notificationBodyEnabled"===e){const e=localStorage.getItem("notifications_body_enabled");return"string"==typeof e?"true"===e:null}if("audioNotificationsEnabled"===e){const e=localStorage.getItem("audio_notifications_enabled");return"string"==typeof e?"true"===e:null}if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e)){return JSON.parse(localStorage.getItem("mx_"+e)||"{}").value}return(this.getSettings()||{})[e]}setValue(e,t,s){if(this.featureNames.includes(e))return this.writeFeature(e,s),Promise.resolve();if("notificationsEnabled"===e)return localStorage.setItem("notifications_enabled",s),this.watchers.notifyUpdate(e,null,a.a.DEVICE,s),Promise.resolve();if("notificationBodyEnabled"===e)return localStorage.setItem("notifications_body_enabled",s),this.watchers.notifyUpdate(e,null,a.a.DEVICE,s),Promise.resolve();if("audioNotificationsEnabled"===e)return localStorage.setItem("audio_notifications_enabled",s),this.watchers.notifyUpdate(e,null,a.a.DEVICE,s),Promise.resolve();if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e))return localStorage.setItem("mx_"+e,JSON.stringify({value:s})),this.watchers.notifyUpdate(e,null,a.a.DEVICE,s),Promise.resolve();const n=this.getSettings()||{};return n[e]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,null,a.a.DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}watchSetting(e,t,s){this.watchers.watchSetting(e,t,s)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){const e=localStorage.getItem("mx_local_settings");return e?JSON.parse(e):null}readFeature(e){if(r.a.get()&&r.a.get().isGuest())return!1;const t=localStorage.getItem("mx_labs_feature_"+e);return"true"===t||"false"!==t&&null}writeFeature(e,t){localStorage.setItem("mx_labs_feature_"+e,""+t),this.watchers.notifyUpdate(e,null,a.a.DEVICE,t)}}class l extends o.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const s=this.read(this.getKey(e,t));return s?s.value:null}setValue(e,t,s){if("blacklistUnverifiedDevices"===e){let n=this.read("mx_local_settings");return n||(n={}),n.blacklistUnverifiedDevicesPerRoom||(n.blacklistUnverifiedDevicesPerRoom={}),n.blacklistUnverifiedDevicesPerRoom[t]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,s),Promise.resolve()}return null===s?localStorage.removeItem(this.getKey(e,t)):(s=JSON.stringify({value:s}),localStorage.setItem(this.getKey(e,t),s)),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}read(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}getKey(e,t){return"mx_setting_"+e+"_"+t}}class d extends o.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let s=this.defaults[e];return void 0===s&&(s=this.invertedDefaults[e]),s}async setValue(e,t,s){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var u=s(231),h=s(11);class m extends u.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t,s)=>{const n=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,a.a.ROOM_ACCOUNT,t)}else if("org.matrix.room.color_scheme"===e.getType())this.watchers.notifyUpdate("roomColor",n,a.a.ROOM_ACCOUNT,e.getContent());else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(h.d)(t,e.getContent());for(const t of i){const s=e.getContent()[t];this.watchers.notifyUpdate(t,n,a.a.ROOM_ACCOUNT,s)}}else"im.vector.setting.allowed_widgets"===e.getType()&&this.watchers.notifyUpdate("allowedWidgets",n,a.a.ROOM_ACCOUNT,e.getContent())})}initMatrixClient(e,t){e&&e.removeListener("Room.accountData",this.onAccountData),t.on("Room.accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("roomColor"===e)return this.getSettings(t,"org.matrix.room.color_scheme");if("allowedWidgets"===e)return this.getSettings(t,"im.vector.setting.allowed_widgets");return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,r.a.get().setRoomAccountData(t,"org.matrix.room.preview_urls",e)}if("roomColor"===e)return r.a.get().setRoomAccountData(t,"org.matrix.room.color_scheme",s);if("allowedWidgets"===e)return r.a.get().setRoomAccountData(t,"im.vector.setting.allowed_widgets",s);const n=this.getSettings(t)||{};return n[e]=s,r.a.get().setRoomAccountData(t,"im.vector.web.settings",n)}canSetValue(e,t){const s=r.a.get().getRoom(t);return null!=s}isSupported(){const e=r.a.get();return null!=e}getSettings(e,t="im.vector.web.settings"){const s=r.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(t);return n&&n.getContent()?Object(h.a)(n.getContent()):null}}const p=["im.vector.riot.breadcrumb_rooms","im.vector.setting.breadcrumbs"];class g extends u.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,a.a.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const s=t?t.getContent():{},n=Object(h.d)(s,e.getContent());for(const t of n){const s=e.getContent()[t];this.watchers.notifyUpdate(t,null,a.a.ACCOUNT,s)}}else if(p.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if("im.vector.setting.integration_provisioning"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,a.a.ACCOUNT,t)}else if("io.element.recent_emoji"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,a.a.ACCOUNT,t)}})}initMatrixClient(e,t){e&&e.removeListener("accountData",this.onAccountData),t.on("accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms"),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji");return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning");return e?e.enabled:null}const s=this.getSettings()||{};let n=s[e];return null==n&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(n=s.hideAvatarDisplaynameChanges)),n}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return e.disable=!s,r.a.get().setAccountData("org.matrix.preview_urls",e)}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms")),e||(e={}),e.recent_rooms=s,r.a.get().setAccountData("im.vector.setting.breadcrumbs",e)}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji")||{};return e.recent_emoji=s,r.a.get().setAccountData("io.element.recent_emoji",e)}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning")||{};return e.enabled=s,r.a.get().setAccountData("im.vector.setting.integration_provisioning",e)}const n=this.getSettings()||{};return n[e]=s,r.a.get().setAccountData("im.vector.web.settings",n)}canSetValue(e,t){return!0}isSupported(){const e=r.a.get();return null!=e}getSettings(e="im.vector.web.settings"){const t=r.a.get();if(!t)return null;const s=t.getAccountData(e);return s&&s.getContent()?Object(h.a)(s.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if("im.vector.riot.breadcrumb_rooms"===e.getType()){const s=this.getSettings("im.vector.setting.breadcrumbs");t=s?s.recent_rooms:e.getContent().rooms}else{if("im.vector.setting.breadcrumbs"!==e.getType())return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,a.a.ACCOUNT,t||[])}}class f extends u.a{constructor(e){super(),this.watchers=e,i()(this,"onEvent",(e,t,s)=>{const n=e.getRoomId(),i=this.client.getRoom(n);if(i&&(!i||t===i.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,a.a.ROOM,t)}else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(h.d)(t,e.getContent());for(const t of i)this.watchers.notifyUpdate(t,n,a.a.ROOM,e.getContent()[t])}})}initMatrixClient(e,t){e&&e.removeListener("RoomState.events",this.onEvent),t.on("RoomState.events",this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,r.a.get().sendStateEvent(t,"org.matrix.room.preview_urls",e)}const n=this.getSettings(t)||{};return n[e]=s,r.a.get().sendStateEvent(t,"im.vector.web.settings",n,"")}canSetValue(e,t){const s=r.a.get(),n=s.getRoom(t);let i="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(i="org.matrix.room.preview_urls"),!!n&&n.currentState.maySendStateEvent(i,s.getUserId())}isSupported(){const e=r.a.get();return null!=e}getSettings(e,t="im.vector.web.settings"){const s=r.a.get().getRoom(e);if(!s)return null;const n=s.currentState.getStateEvents(t,"");return n&&n.getContent()?Object(h.a)(n.getContent()):null}}var _=s(53),v=s(1);class y extends o.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const s=_.a.get()||{};if(this.featureNames.includes(e)){const t=(s.features||{})[e];return Object(v.r)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}if("theme"===e)return s.default_theme;const n=s.settingDefaults;return!n||Object(v.r)(n[e])?null:n[e]}async setValue(e,t,s){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var b=s(44),E=s(48),S=s(191),w=s(128),C=s(157);function R(){const e=new C.a(r.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes("notify"):(console.warn("No master push rule! Notifications are disabled for this user."),!0)}function k(){let e=s(214);return e.default&&(e=e.default),e}class I extends w.a{getValueOverride(e,t,s,n){return!!k().isPossible()&&(null===s||"default"===n?!R():s)}onChange(e,t,s){k().supportsDesktopNotifications()&&k().setEnabled(s)}}class O extends w.a{getValueOverride(e,t,s){return!!k().isPossible()&&(null===s?!R():s)}}class T extends w.a{onChange(e,t,s){E.a.dispatch({action:"feature_custom_status_changed"})}}var x=s(333);class N extends w.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,s){this.setter.call(r.a.get(),this.inverse?!s:s)}}var j=s(62);class P extends w.a{onChange(e,t,s){j.a.get().reload()}}var D=s(54);class A extends w.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:D.a.UpdateFontSize,size:s})}}class U extends w.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:D.a.UpdateSystemFont,useSystemFont:ee.getValue("useSystemFont"),font:s})}}class M extends w.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:D.a.UpdateSystemFont,useSystemFont:s,font:ee.getValue("systemFont")})}}var L=s(70);const F=[a.a.DEVICE,a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT,a.a.ACCOUNT,a.a.CONFIG],B=[a.a.ROOM_ACCOUNT,a.a.ACCOUNT],V=[a.a.DEVICE,a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT,a.a.ACCOUNT,a.a.CONFIG,a.a.ROOM],K=[a.a.DEVICE,a.a.ACCOUNT,a.a.CONFIG],q=[a.a.DEVICE,a.a.CONFIG],G=[a.a.DEVICE],W=[a.a.DEVICE,a.a.CONFIG],H={feature_communities_v2_prototypes:{isFeature:!0,displayName:Object(b.b)("Communities v2 prototypes. Requires compatible homeserver. Highly experimental - use with caution."),supportedLevels:q,default:!1},feature_new_spinner:{isFeature:!0,displayName:Object(b.b)("New spinner design"),supportedLevels:q,default:!1},feature_pinning:{isFeature:!0,displayName:Object(b.b)("Message Pinning"),supportedLevels:q,default:!1},feature_custom_status:{isFeature:!0,displayName:Object(b.b)("Custom user status messages"),supportedLevels:q,default:!1,controller:new T},feature_custom_tags:{isFeature:!0,displayName:Object(b.b)("Group & filter rooms by custom tags (refresh to apply changes)"),supportedLevels:q,default:!1},feature_state_counters:{isFeature:!0,displayName:Object(b.b)("Render simple counters in room header"),supportedLevels:q,default:!1},feature_many_integration_managers:{isFeature:!0,displayName:Object(b.b)("Multiple integration managers"),supportedLevels:q,default:!1},feature_mjolnir:{isFeature:!0,displayName:Object(b.b)("Try out new ways to ignore people (experimental)"),supportedLevels:q,default:!1},feature_custom_themes:{isFeature:!0,displayName:Object(b.b)("Support adding custom themes"),supportedLevels:q,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,displayName:Object(b.b)("Show message previews for reactions in DMs"),supportedLevels:q,default:!1},feature_roomlist_preview_reactions_all:{isFeature:!0,displayName:Object(b.b)("Show message previews for reactions in all rooms"),supportedLevels:q,default:!1},advancedRoomListLogging:{displayName:Object(b.b)("Enable advanced debugging for the room list"),supportedLevels:G,default:!1},mjolnirRooms:{supportedLevels:[a.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[a.a.ACCOUNT],default:null},feature_bridge_state:{isFeature:!0,supportedLevels:q,displayName:Object(b.b)("Show info about bridges in room settings"),default:!1},"RoomList.backgroundImage":{supportedLevels:K,default:null},baseFontSize:{displayName:Object(b.b)("Font size"),supportedLevels:K,default:10,controller:new A},useCustomFontSize:{displayName:Object(b.b)("Use custom size"),supportedLevels:K,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:K,displayName:Object(b.b)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"Notifications.alwaysShowBadgeCounts":{supportedLevels:B,default:!1},useCompactLayout:{supportedLevels:G,displayName:Object(b.b)("Use a more compact ‘Modern’ layout"),default:!1},showRedactions:{supportedLevels:V,displayName:Object(b.b)("Show a placeholder for removed messages"),default:!0,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:V,displayName:Object(b.b)("Show join/leave messages (invites/kicks/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:V,displayName:Object(b.b)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:V,displayName:Object(b.b)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:F,displayName:Object(b.b)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:K,displayName:Object(b.b)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:K,displayName:Object(b.b)("Always show message timestamps"),default:!1},autoplayGifsAndVideos:{supportedLevels:K,displayName:Object(b.b)("Autoplay GIFs and videos"),default:!1},alwaysShowEncryptionIcons:{supportedLevels:K,displayName:Object(b.b)("Always show encryption icons"),default:!0},showRoomRecoveryReminder:{supportedLevels:K,displayName:Object(b.b)("Show a reminder to enable Secure Message Recovery in encrypted rooms"),default:!0},enableSyntaxHighlightLanguageDetection:{supportedLevels:K,displayName:Object(b.b)("Enable automatic language detection for syntax highlighting"),default:!1},"Pill.shouldShowPillAvatar":{supportedLevels:K,displayName:Object(b.b)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:K,displayName:Object(b.b)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:K,default:!1},"MessageComposer.showFormatting":{supportedLevels:K,default:!1},sendTypingNotifications:{supportedLevels:K,displayName:Object(b.b)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:K,displayName:Object(b.b)("Show typing notifications"),default:!0},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:K,displayName:Object(b.b)("Automatically replace plain text Emoji"),default:!1},"VideoView.flipVideoHorizontally":{supportedLevels:K,displayName:Object(b.b)("Mirror local video feed"),default:!1},"TagPanel.enableTagPanel":{supportedLevels:K,displayName:Object(b.b)("Enable Community Filter Panel"),default:!0,invertedSettingName:"TagPanel.disableTagPanel"},theme:{supportedLevels:K,default:"light",controller:new x.a},custom_themes:{supportedLevels:K,default:[]},use_system_theme:{supportedLevels:G,default:!0,displayName:Object(b.b)("Match system theme")},useSystemFont:{supportedLevels:G,default:!1,displayName:Object(b.b)("Use a system font"),controller:new M},systemFont:{supportedLevels:G,default:"",displayName:Object(b.b)("System font name"),controller:new U},webRtcAllowPeerToPeer:{supportedLevels:W,displayName:Object(b.b)("Allow Peer-to-Peer for 1:1 calls"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:G,default:null},webrtc_audioinput:{supportedLevels:G,default:null},webrtc_videoinput:{supportedLevels:G,default:null},language:{supportedLevels:W,default:"en"},breadcrumb_rooms:{supportedLevels:[a.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[a.a.ACCOUNT],default:[]},room_directory_servers:{supportedLevels:[a.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[a.a.ACCOUNT],default:!0},allowedWidgets:{supportedLevels:[a.a.ROOM_ACCOUNT],default:{}},analyticsOptIn:{supportedLevels:W,displayName:Object(b.b)("Send analytics data"),default:!1},showCookieBar:{supportedLevels:W,default:!0},autocompleteDelay:{supportedLevels:W,default:200},readMarkerInViewThresholdMs:{supportedLevels:W,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:W,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[a.a.ROOM_DEVICE,a.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(b.b)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(b.b)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1},urlPreviewsEnabled:{supportedLevels:V,displayName:{default:Object(b.b)("Enable inline URL previews by default"),"room-account":Object(b.b)("Enable URL previews for this room (only affects you)"),room:Object(b.b)("Enable URL previews by default for participants in this room")},default:!0},urlPreviewsEnabled_e2ee:{supportedLevels:[a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT],displayName:{"room-account":Object(b.b)("Enable URL previews for this room (only affects you)")},default:!1},roomColor:{supportedLevels:V,displayName:Object(b.b)("Room Colour"),default:{primary_color:null,secondary_color:null}},notificationsEnabled:{supportedLevels:G,default:!1,controller:new I},notificationSound:{supportedLevels:B,default:!1},notificationBodyEnabled:{supportedLevels:G,default:!0,controller:new O},audioNotificationsEnabled:{supportedLevels:G,default:!0},enableWidgetScreenshots:{supportedLevels:K,displayName:Object(b.b)("Enable widget screenshots on supported widgets"),default:!1},"PinnedEvents.isOpen":{supportedLevels:[a.a.ROOM_DEVICE],default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:K,displayName:Object(b.b)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},showDeveloperTools:{supportedLevels:K,displayName:Object(b.b)("Show developer tools"),default:!1},widgetOpenIDPermissions:{supportedLevels:G,default:{allow:[],deny:[]}},"RoomList.orderAlphabetically":{supportedLevels:K,displayName:Object(b.b)("Order rooms by name"),default:!1},"RoomList.orderByImportance":{supportedLevels:K,displayName:Object(b.b)("Show rooms with unread notifications first"),default:!0},breadcrumbs:{supportedLevels:K,displayName:Object(b.b)("Show shortcuts to recently viewed rooms above the room list"),default:!0},showHiddenEventsInTimeline:{displayName:Object(b.b)("Show hidden events in timeline"),supportedLevels:G,default:!1},lowBandwidth:{supportedLevels:W,displayName:Object(b.b)("Low bandwidth mode"),default:!1,controller:new P},fallbackICEServerAllowed:{supportedLevels:G,displayName:Object(b.b)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},sendReadReceipts:{supportedLevels:F,displayName:Object(b.b)("Send read receipts for messages (requires compatible homeserver to disable)"),default:!0},showImages:{supportedLevels:K,displayName:Object(b.b)("Show previews/thumbnails for images"),default:!0},showRightPanelInRoom:{supportedLevels:G,default:!1},showRightPanelInGroup:{supportedLevels:G,default:!1},lastRightPanelPhaseForRoom:{supportedLevels:G,default:L.b.RoomSummary},lastRightPanelPhaseForGroup:{supportedLevels:G,default:L.b.GroupMemberList},enableEventIndexing:{supportedLevels:G,displayName:Object(b.b)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:G,displayName:Object(b.b)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:W,default:!0},"e2ee.manuallyVerifyAllSessions":{supportedLevels:G,displayName:Object(b.b)("Manually verify all remote sessions"),default:!1,controller:new N(S.b.prototype.setCryptoTrustCrossSignedDevices,!0)},ircDisplayNameWidth:{supportedLevels:[a.a.ROOM_DEVICE,a.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(b.b)("IRC display name width"),default:80},useIRCLayout:{supportedLevels:K,displayName:Object(b.b)("Enable experimental, compact IRC style layout"),default:!1},"Widgets.pinned":{supportedLevels:B,default:{}}};class $ extends o.a{constructor(e){super(),this.handler=e,i()(this,"cache",{})}getValue(e,t){const s=t||"UNDEFINED",n=this.cache[e];return n&&n.hasOwnProperty(s)?n[s]:this.handler.getValue(e,t)}setValue(e,t,s){this.cache[e]||(this.cache[e]={});const n=this.cache[e],i=t||"UNDEFINED";n[i]=s;const o=this.handler.setValue(e,t,s);return Promise.resolve(o).finally(()=>{delete n[i]})}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}const z=new class{constructor(){i()(this,"watchers",{})}watchSetting(e,t,s){this.watchers[e]||(this.watchers[e]={}),this.watchers[e][t]||(this.watchers[e][t]=[]),this.watchers[e][t].push(s)}unwatchSetting(e){for(const t of Object.keys(this.watchers))for(const s of Object.keys(this.watchers[t])){let n;for(;-1!==(n=this.watchers[t][s].indexOf(e));)this.watchers[t][s].splice(n,1)}}notifyUpdate(e,t,s,n){if(!this.watchers[e])return;const i=this.watchers[e],o=[];null!==t&&i[t]&&o.push(...i[t]),t?i.null&&o.push(...i.null):o.push(...Object.values(i).flat(1));for(const e of o)e(t,s,n)}},Y={},J={},Q=[];for(const e of Object.keys(H))Y[e]=H[e].default,H[e].isFeature&&Q.push(e),H[e].invertedSettingName&&(J[e]=!H[e].default);const X={[a.a.DEVICE]:new c(Q,z),[a.a.ROOM_DEVICE]:new l(z),[a.a.ROOM_ACCOUNT]:new m(z),[a.a.ACCOUNT]:new g(z),[a.a.ROOM]:new f(z),[a.a.CONFIG]:new y(Q),[a.a.DEFAULT]:new d(Y,J)};for(const e of Object.keys(X))X[e]=new $(X[e]);const Z=[a.a.DEVICE,a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT,a.a.ACCOUNT,a.a.ROOM,a.a.CONFIG,a.a.DEFAULT];class ee{static getFeatureSettingNames(){return Object.keys(H).filter(e=>ee.isFeature(e))}static watchSetting(e,t,s){const n=H[e],i=e;if(!n)throw new Error(e+" is not a setting");n.invertedSettingName&&(e=n.invertedSettingName);const o=`${(new Date).getTime()}_${ee.watcherCount++}_${e}_${t}`,r=(e,t,n)=>{const o=ee.getValue(i);s(i,e,t,n,o)};return ee.watchers[o]=r,z.watchSetting(e,t,r),o}static unwatchSetting(e){ee.watchers[e]?(z.unwatchSetting(ee.watchers[e]),delete ee.watchers[e]):console.warn("Ending non-existent watcher ID "+e)}static monitorSetting(e,t){t=t||null,this.monitors[e]||(this.monitors[e]={});const s=()=>{this.monitors[e][t]=ee.watchSetting(e,t,(e,t,s,n,i)=>{E.a.dispatch({action:"setting_updated",settingName:e,roomId:t,level:s,newValueAtLevel:n,newValue:i})})};if(Object.keys(this.monitors[e]).find(e=>e===t||null===e)){if(null===t){for(const t of Object.keys(this.monitors[e]))ee.unwatchSetting(this.monitors[e][t]);this.monitors[e]={},s()}}else s()}static getDisplayName(e,t=a.a.DEFAULT){if(!H[e]||!H[e].displayName)return null;let s=H[e].displayName;return s instanceof Object&&(s=s[t]?s[t]:s.default),Object(b.a)(s)}static isFeature(e){return!!H[e]&&H[e].isFeature}static getValue(e,t=null,s=!1){if(!H[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=H[e],i=n.supportedLevelsAreOrdered?n.supportedLevels:Z;return ee.getValueAt(i[0],e,t,!1,s)}static getValueAt(e,t,s=null,n=!1,i=!1){const o=H[t];if(!o)throw new Error("Setting '"+t+"' does not appear to be a setting.");const r=o.supportedLevelsAreOrdered?o.supportedLevels:Z;r.includes(a.a.DEFAULT)||r.push(a.a.DEFAULT);const c=r.indexOf(e);if(-1===c)throw new Error("Level "+e+" is not prioritized");const l=ee.getHandlers(t);if(o.invertedSettingName&&(t=o.invertedSettingName),n){const n=l[e];if(!n)return ee.getFinalValue(o,e,s,null,null);const i=n.getValue(t,s);return ee.getFinalValue(o,e,s,i,e)}for(let n=c;n<r.length;n++){const a=l[r[n]];if(!a)continue;if(i&&"default"===r[n])continue;const c=a.getValue(t,s);if(null!=c)return ee.getFinalValue(o,e,s,c,r[n])}return ee.getFinalValue(o,e,s,null,null)}static getDefaultValue(e){if(!H[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return H[e].default}static getFinalValue(e,t,s,n,i){let o=n;if(e.controller){const r=e.controller.getValueOverride(t,s,n,i);null!=r&&(o=r)}return e.invertedSettingName&&(o=!o),o}static async setValue(e,t,s,n){const i=H[e];if(!i)throw new Error("Setting '"+e+"' does not appear to be a setting.");const o=ee.getHandler(e,s);if(!o)throw new Error("Setting "+e+" does not have a handler for "+s);if(i.invertedSettingName&&(e=i.invertedSettingName,n=!n),!o.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+s+" in "+t);await o.setValue(e,t,n);const r=i.controller;r&&r.onChange(s,t,n)}static canSetValue(e,t,s){if(!H[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(ee.isFeature(e)){const s=ee.getValueAt(a.a.CONFIG,e,t,!0,!0);if(!0===s||!1===s)return!1}const n=ee.getHandler(e,s);return!!n&&n.canSetValue(e,t)}static isLevelSupported(e){return!!X[e]&&X[e].isSupported()}static debugSetting(e,t){console.log("--- DEBUG "+e);const s=H[e];console.log("--- definition: "+(s?JSON.stringify(s):"<NOT_FOUND>")),console.log("--- default level order: "+JSON.stringify(Z)),console.log("--- registered handlers: "+JSON.stringify(Object.keys(X)));const n=e=>{for(const s of Object.keys(X)){const n=X[s];try{const i=n.getValue(e,t);console.log(`---     ${s}@${t||"<no_room>"} = ${JSON.stringify(i)}`)}catch(e){console.log(`---     ${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=n.getValue(e,null);console.log(`---     ${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     ${n}@<no_room> THREW ERROR: ${e.message}`),console.error(e)}}console.log("--- calculating as returned by SettingsStore"),console.log("--- these might not match if the setting uses a controller - be warned!");try{const s=ee.getValue(e,t);console.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(s)}`)}catch(e){console.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=ee.getValue(e,null);console.log("---     SettingsStore#generic@<no_room>  = "+JSON.stringify(t))}catch(e){console.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+e.message),console.error(e)}for(const s of Z){try{const n=ee.getValueAt(s,e,t);console.log(`---     SettingsStore#${s}@${t||"<no_room>"} = ${JSON.stringify(n)}`)}catch(e){console.log(`---     SettingsStore#${s}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=ee.getValueAt(s,e,null);console.log(`---     SettingsStore#${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     SettingsStore#${s}@$<no_room> THREW ERROR: ${e.message}`),console.error(e)}}};n(e),s.invertedSettingName&&(console.log("--- TESTING INVERTED SETTING NAME"),console.log("--- inverted: "+s.invertedSettingName),n(s.invertedSettingName)),console.log("--- END DEBUG")}static getHandler(e,t){const s=ee.getHandlers(e);return s[t]?s[t]:null}static getHandlers(e){if(!H[e])return{};const t={};for(const s of H[e].supportedLevels){if(!X[s])throw new Error("Unexpected level "+s);ee.isLevelSupported(s)&&(t[s]=X[s])}return t.default||(t.default=X.default),t}}i()(ee,"watchers",{}),i()(ee,"monitors",{}),i()(ee,"watcherCount",1),window.mxSettingsStore=ee},,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(60),i=s.n(n),o=s(43),r=s.n(o),a=s(58),c=s(51),l=s.n(c);function d(e){let{element:t,onClick:s,children:n,kind:o,disabled:c,inputRef:d,className:u}=e,h=i()(e,["element","onClick","children","kind","disabled","inputRef","className"]);const m=h;return c||(m.onClick=s,m.onKeyDown=e=>{if(e.key===a.a.ENTER)return e.stopPropagation(),e.preventDefault(),s(e);e.key===a.a.SPACE&&(e.stopPropagation(),e.preventDefault())},m.onKeyUp=e=>{if(e.key===a.a.SPACE)return e.stopPropagation(),e.preventDefault(),s(e);e.key===a.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),m.ref=d,m.className=l()("mx_AccessibleButton",u,{mx_AccessibleButton_hasKind:o,["mx_AccessibleButton_kind_"+o]:o,mx_AccessibleButton_disabled:c}),r.a.createElement(t,h,n)}d.defaultProps={element:"div",role:"button",tabIndex:0},d.displayName="AccessibleButton"},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(2),i=s.n(n);const o={brand:"Element",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null,jitsi:{preferredDomain:"jitsi.riot.im"}};class r{static setInstance(e){r.instance=e,window.mxReactSdkConfig=e}static get(){return r.instance||{}}static put(e){const t=Object.keys(o);for(let s=0;s<t.length;++s)void 0===e[t[s]]&&(e[t[s]]=o[t[s]]);r.setInstance(e)}static unset(){r.setInstance({})}static add(e){const t=r.get(),s=Object.assign({},t,e);r.put(s)}}i()(r,"instance",void 0)},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewRoomDirectory="view_room_directory",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusComposer="focus_composer",e.ToggleUserMenu="toggle_user_menu",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoomDelta="view_room_delta",e.SetRightPanelPhase="set_right_panel_phase",e.ToggleRightPanel="toggle_right_panel",e.AfterRightPanelPhaseChange="after_right_panel_phase_change",e.AppTileDelete="appTile_delete",e.AppTileRevoke="appTile_revoke"}(n||(n={}))},function(e,t,s){"use strict";(function(e){var n=s(134),i=s(591),o=s.n(i),r=s(592),a=s.n(r);let c;s.d(t,"a",(function(){return n.AutoDiscovery})),s.d(t,"b",(function(){return n.EventStatus})),s.d(t,"c",(function(){return n.EventTimeline})),s.d(t,"d",(function(){return n.Filter})),s.d(t,"e",(function(){return n.Group})),s.d(t,"f",(function(){return n.IndexedDBStore})),s.d(t,"g",(function(){return n.InteractiveAuth})),s.d(t,"h",(function(){return n.MatrixClient})),s.d(t,"i",(function(){return n.MatrixEvent})),s.d(t,"j",(function(){return n.Room})),s.d(t,"k",(function(){return n.RoomMember})),s.d(t,"l",(function(){return n.SERVICE_TYPES})),s.d(t,"m",(function(){return n.TimelineWindow})),s.d(t,"n",(function(){return n.User})),s.d(t,"o",(function(){return n.WebStorageSessionStore})),s.d(t,"p",(function(){return n.createClient})),s.d(t,"q",(function(){return n.createNewMatrixCall})),s.d(t,"s",(function(){return n.setMatrixCallAudioInput})),s.d(t,"t",(function(){return n.setMatrixCallAudioOutput})),s.d(t,"u",(function(){return n.setMatrixCallVideoInput})),n.request((function(e,t){return e.qs=a.a.stringify(e.qs||{},e.qsStringifyOptions),o()(e,t)}));try{c=e.indexedDB}catch(e){}c&&n.setCryptoStoreFactory((function(){return new n.IndexedDBCryptoStore(c,"matrix-js-sdk:crypto")})),t.r=n,e.matrixcs=n}).call(this,s(6))},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.CONFIG="config",e.DEFAULT="default"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return r}));const n={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},i=navigator.platform.toUpperCase().indexOf("MAC")>=0;function o(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}function r(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey:e.ctrlKey&&!e.altKey&&!e.metaKey}},function(e,t,s){"use strict";var n=s(43);const i=Object(n.createContext)(void 0);i.displayName="MatrixClientContext",t.a=i},,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return I})),s.d(t,"n",(function(){return O})),s.d(t,"k",(function(){return T})),s.d(t,"o",(function(){return x})),s.d(t,"m",(function(){return N})),s.d(t,"l",(function(){return j}));var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(43),c=s.n(a),l=s(79),d=s.n(l),u=s(51),h=s.n(u),m=s(58),p=s(380);s.d(t,"c",(function(){return p.a}));var g=s(381);s.d(t,"d",(function(){return g.a}));var f=s(382);s.d(t,"e",(function(){return f.a}));var _=s(383);s.d(t,"f",(function(){return _.a}));var v=s(384);s.d(t,"g",(function(){return v.a}));var y=s(385);s.d(t,"h",(function(){return y.a}));var b=s(386);s.d(t,"i",(function(){return b.a}));var E=s(387);function S(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function w(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?S(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}s.d(t,"j",(function(){return E.a}));function C(){let e=document.getElementById("mx_ContextualMenu_Container");return e||(e=document.createElement("div"),e.id="mx_ContextualMenu_Container",document.body.appendChild(e)),e}const R=new Set(["menuitem","menuitemcheckbox","menuitemradio"]);let k;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(k||(k={}));class I extends c.a.PureComponent{constructor(t,s){super(t,s),r()(this,"initialFocus",void 0),r()(this,"collectContextMenuRect",e=>{if(!e)return;let t=e.querySelector('[role^="menuitem"]');t||(t=e.querySelector("[tab-index]")),t&&t.focus(),this.setState({contextMenuElem:e})}),r()(this,"onContextMenu",t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const s=t.clientX,n=t.clientY;e(()=>{const e=document.createEvent("MouseEvents");e.initMouseEvent("contextmenu",!0,!0,window,0,0,0,s,n,!1,!1,!1,!1,0,null),document.elementFromPoint(s,n).dispatchEvent(e)})}}),r()(this,"onContextMenuPreventBubbling",e=>{e.stopPropagation()}),r()(this,"onFinished",e=>{e.stopPropagation(),e.preventDefault(),this.props.onFinished&&this.props.onFinished()}),r()(this,"onMoveFocus",(e,t)=>{let s=!1;do{const n=t?e.lastElementChild:e.firstElementChild,i=t?e.previousElementSibling:e.nextElementSibling;s?n?e=n:i?e=i:(s=!1,e=e.parentElement):i?(e=i,s=!0):e=e.parentElement,e&&e.classList.contains("mx_ContextualMenu")&&(e=t?e.lastElementChild:e.firstElementChild,s=!0)}while(e&&!R.has(e.getAttribute("role")));e&&e.focus()}),r()(this,"onMoveFocusHomeEnd",(e,t)=>{let s=e.querySelectorAll('[role^="menuitem"]');s||(s=e.querySelectorAll("[tab-index]")),s&&s.length&&(t?s[0].focus():s[s.length-1].focus())}),r()(this,"onKeyDown",e=>{if(!this.props.managed)return void(e.key===m.a.ESCAPE&&(this.props.onFinished(),e.stopPropagation(),e.preventDefault()));let t=!0;switch(e.key){case m.a.TAB:case m.a.ESCAPE:case m.a.ARROW_LEFT:case m.a.ARROW_RIGHT:this.props.onFinished();break;case m.a.ARROW_UP:this.onMoveFocus(e.target,!0);break;case m.a.ARROW_DOWN:this.onMoveFocus(e.target,!1);break;case m.a.HOME:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!0);break;case m.a.END:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!1);break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())}),this.state={contextMenuElem:null},this.initialFocus=document.activeElement}componentWillUnmount(){this.initialFocus.focus()}renderMenu(e=this.props.hasBackground){const t={},s=this.props;let n;s.top?t.top=s.top:t.bottom=s.bottom,s.left?(t.left=s.left,n=k.Left):(t.right=s.right,n=k.Right);const i=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,o={};s.chevronFace&&(n=s.chevronFace);const r=n&&n!==k.None;if(n===k.Top||n===k.Bottom)o.left=s.chevronOffset;else if(void 0!==t.top){const e=t.top;let n=e;if(i){const e=10;n=Math.min(t.top,document.body.clientHeight-i.height+e)}t.top=n,o.top=Math.max(s.chevronOffset,s.chevronOffset+e-n)}let a;r&&(a=c.a.createElement("div",{style:o,className:"mx_ContextualMenu_chevron_"+n}));const l=h()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!r&&t.left,mx_ContextualMenu_right:!r&&t.right,mx_ContextualMenu_top:!r&&t.top,mx_ContextualMenu_bottom:!r&&t.bottom,mx_ContextualMenu_withChevron_left:n===k.Left,mx_ContextualMenu_withChevron_right:n===k.Right,mx_ContextualMenu_withChevron_top:n===k.Top,mx_ContextualMenu_withChevron_bottom:n===k.Bottom}),d={};s.menuWidth&&(d.width=s.menuWidth),s.menuHeight&&(d.height=s.menuHeight),isNaN(Number(s.menuPaddingTop))||(d.paddingTop=s.menuPaddingTop),isNaN(Number(s.menuPaddingLeft))||(d.paddingLeft=s.menuPaddingLeft),isNaN(Number(s.menuPaddingBottom))||(d.paddingBottom=s.menuPaddingBottom),isNaN(Number(s.menuPaddingRight))||(d.paddingRight=s.menuPaddingRight);const u={};let m;return isNaN(Number(s.zIndex))||(d.zIndex=s.zIndex+1,u.zIndex=s.zIndex),e&&(m=c.a.createElement("div",{className:"mx_ContextualMenu_background",style:u,onClick:this.onFinished,onContextMenu:this.onContextMenu})),c.a.createElement("div",{className:"mx_ContextualMenu_wrapper",style:w(w({},t),u),onKeyDown:this.onKeyDown,onContextMenu:this.onContextMenuPreventBubbling},c.a.createElement("div",{className:l,style:d,ref:this.collectContextMenuRect,role:this.props.managed?"menu":void 0},a,s.children),m)}render(){return d.a.createPortal(this.renderMenu(),C())}}r()(I,"defaultProps",{hasBackground:!0,managed:!0});const O=(e,t=12)=>{const s=e.right+window.pageXOffset+3;let n=e.top+e.height/2+window.pageYOffset;return n-=t+8,{left:s,top:n,chevronOffset:t}},T=(e,t=k.None)=>{const s={chevronFace:t},n=e.right+window.pageXOffset,i=e.bottom+window.pageYOffset,o=e.top+window.pageYOffset;return s.right=window.innerWidth-n,i<window.innerHeight/2?s.top=i:s.bottom=window.innerHeight-o,s},x=()=>{const e=Object(a.useRef)(null),[t,s]=Object(a.useState)(!1);return[t,e,()=>{s(!0)},()=>{s(!1)},s]};class N extends I{render(){return this.renderMenu(!1)}}function j(e,t){const s=function(...e){d.a.unmountComponentAtNode(C()),t&&t.onFinished&&t.onFinished.apply(null,e)},n=c.a.createElement(N,i()({},t,{onFinished:s,windowResize:s}),c.a.createElement(e,i()({},t,{onFinished:s})));return d.a.render(n,C()),{close:s}}}).call(this,s(136).setImmediate)},function(e,t,s){"use strict";var n=s(2),i=s.n(n);class o{constructor(){i()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e}}window.mxPlatformPeg||(window.mxPlatformPeg=new o),t.a=window.mxPlatformPeg},,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(60),i=s.n(n),o=s(2),r=s.n(o),a=s(43),c=s.n(a),l=s(51),d=s.n(l),u=s(46),h=s(63);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let g=1;class f extends c.a.PureComponent{constructor(e){super(e),r()(this,"id",void 0),r()(this,"input",void 0),r()(this,"validateOnChange",Object(h.debounce)(()=>{this.validate({focused:!0})},200)),r()(this,"onFocus",e=>{this.setState({focused:!0}),this.validate({focused:!0}),this.props.onFocus&&this.props.onFocus(e)}),r()(this,"onChange",e=>{this.validateOnChange(),this.props.onChange&&this.props.onChange(e)}),r()(this,"onBlur",e=>{this.setState({focused:!1}),this.validate({focused:!1}),this.props.onBlur&&this.props.onBlur(e)}),this.state={valid:void 0,feedback:void 0,feedbackVisible:!1,focused:!1},this.id=this.props.id||"mx_Field_"+g++}focus(){this.input.focus()}async validate({focused:e,allowEmpty:t=!0}){if(!this.props.onValidate)return;const s=this.input?this.input.value:null,{valid:n,feedback:i}=await this.props.onValidate({value:s,focused:e,allowEmpty:t});this.state.focused&&i?this.setState({valid:n,feedback:i,feedbackVisible:!0}):this.setState({valid:n,feedbackVisible:!1})}render(){const e=this.props,{element:t,prefixComponent:s,postfixComponent:n,className:o,onValidate:r,children:a,tooltipContent:l,forceValidity:h,tooltipClassName:m,list:g}=e,f=i()(e,["element","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list"]);f.placeholder=f.placeholder||f.label,f.id=this.id,f.onFocus=this.onFocus,f.onChange=this.onChange,f.onBlur=this.onBlur;const _=p(p({},f),{},{ref:e=>this.input=e,list:g}),v=c.a.createElement(this.props.element,_,a);let y=null;s&&(y=c.a.createElement("span",{className:"mx_Field_prefix"},s));let b=null;n&&(b=c.a.createElement("span",{className:"mx_Field_postfix"},n));const E=null!=h,S=d()("mx_Field","mx_Field_"+this.props.element,o,{mx_Field_labelAlwaysTopLeft:s,mx_Field_valid:E?h:r&&!0===this.state.valid,mx_Field_invalid:E?!h:r&&!1===this.state.valid}),w=u.getComponent("elements.Tooltip");let C;return(l||this.state.feedback)&&(C=c.a.createElement(w,{tooltipClassName:d()("mx_Field_tooltip",m),visible:this.state.focused&&this.props.forceTooltipVisible||this.state.feedbackVisible,label:l||this.state.feedback,forceOnRight:!0})),c.a.createElement("div",{className:S},y,v,c.a.createElement("label",{htmlFor:this.id},this.props.label),b,C)}}r()(f,"defaultProps",{element:"input",type:"text"})},function(e,t,s){"use strict";s.d(t,"a",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"g",(function(){return f})),s.d(t,"f",(function(){return _})),s.d(t,"e",(function(){return v})),s.d(t,"c",(function(){return y})),s.d(t,"i",(function(){return b})),s.d(t,"j",(function(){return E})),s.d(t,"b",(function(){return S})),s.d(t,"h",(function(){return C}));var n=s(47),i=s(746),o=s.n(i),r=s(1),a=s(435),c=s(314),l=s(2),d=s.n(l);class u extends c.b{constructor(e){if(super(),d()(this,"_riotUrl",void 0),this._riotUrl=e,!this._riotUrl.startsWith("http:")&&!this._riotUrl.startsWith("https:"))throw new Error("Riot prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,s){return`${this._riotUrl}/#/room/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${this._riotUrl}/#/room/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${this._riotUrl}/#/user/${e}`}forGroup(e){return`${this._riotUrl}/#/group/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);if("+"===e[0])return this.forGroup(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this._riotUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(this._riotUrl))throw new Error("Does not appear to be a permalink");const t=e.substring((this._riotUrl+"/#/").length).split("/");if(t.length<2)throw new Error("URL is missing parts");const s=t[0],n=t[1];if("user"===s)return c.a.forUser(n);if("group"===s)return c.a.forGroup(n);if("room"===s){if(2===t.length)return c.a.forRoom(n,[]);const e=(t.length>2?t.slice(2).join("/"):"").split("?"),s=e[0],i=(e.length>1?e[1]:"").split("via=").filter(e=>!!e);return c.a.forEvent(n,s,i)}throw new Error("Unknown entity type in permalink")}}var h=s(315),m=s(53);class p{constructor(e,t=null){if(this._room=e,this._roomId=e?e.roomId:t,this._highestPlUserId=null,this._populationMap=null,this._bannedHostsRegexps=null,this._allowedHostsRegexps=null,this._serverCandidates=null,this._started=!1,!this._roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use");this.onMembership=this.onMembership.bind(this),this.onRoomState=this.onRoomState.bind(this)}load(){this._room&&this._room.currentState?(this._updateAllowedServers(),this._updateHighestPlUser(),this._updatePopulationMap(),this._updateServerCandidates()):console.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this._room.on("RoomMember.membership",this.onMembership),this._room.on("RoomState.events",this.onRoomState),this._started=!0}stop(){this._room.removeListener("RoomMember.membership",this.onMembership),this._room.removeListener("RoomState.events",this.onRoomState),this._started=!1}isStarted(){return this._started}forEvent(e){return w().forEvent(this._roomId,e,this._serverCandidates)}forRoom(){return w().forRoom(this._roomId,this._serverCandidates)}onRoomState(e){switch(e.getType()){case"m.room.server_acl":return this._updateAllowedServers(),this._updateHighestPlUser(),this._updatePopulationMap(),void this._updateServerCandidates();case"m.room.power_levels":return this._updateHighestPlUser(),void this._updateServerCandidates()}}onMembership(e,t,s){const n=t.userId,i=t.membership,o=R(n),r="join"!==s&&"join"===i;"join"===s&&"join"!==i?this._populationMap[o]--:r&&this._populationMap[o]++,this._updateHighestPlUser(),this._updateServerCandidates()}_updateHighestPlUser(){const e=this._room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter(([e])=>{const t=this._room.getMember(e);if(!t||"join"!==t.membership)return!1;const s=R(e);return!O(s)&&!I(s,this._bannedHostsRegexps)&&I(s,this._allowedHostsRegexps)}).reduce((e,t)=>t[1]>e[1]?t:e,[null,0]),[s,n]=t;if(null!==s&&n>=50)return void(this._highestPlUserId=s)}}}this._highestPlUserId=null}_updateAllowedServers(){const e=[];let t=[new RegExp(".*")];if(this._room.currentState){const s=this._room.currentState.getStateEvents("m.room.server_acl","");if(s&&s.getContent()){const n=e=>new RegExp("^"+r.n(e,!1)+"$");(s.getContent().deny||[]).forEach(t=>e.push(n(t)));const i=s.getContent().allow||[];t=[],i.forEach(e=>t.push(n(e)))}}this._bannedHostsRegexps=e,this._allowedHostsRegexps=t}_updatePopulationMap(){const e={};for(const t of this._room.getJoinedMembers()){const s=R(t.userId);e[s]||(e[s]=0),e[s]++}this._populationMap=e}_updateServerCandidates(){let e=[];this._highestPlUserId&&e.push(R(this._highestPlUserId));const t=Object.keys(this._populationMap).sort((e,t)=>this._populationMap[t]-this._populationMap[e]).filter(t=>!e.includes(t)&&!O(t)&&!I(t,this._bannedHostsRegexps)&&I(t,this._allowedHostsRegexps)).slice(0,3-e.length);e=e.concat(t),this._serverCandidates=e}}function g(e){return w().forEntity(e)}function f(e){return w().forUser(e)}function _(e){if(!e)throw new Error("can't permalink a falsey roomId");if("!"!==e[0])return w().forRoom(e,[]);const t=n.a.get().getRoom(e);if(!t)return w().forRoom(e,[]);const s=new p(t);return s.load(),s.forRoom()}function v(e){return w().forGroup(e)}function y(e){return!!(new a.b).isPermalinkHost(e)||w().isPermalinkHost(e)}function b(e){return e?"#"===e[0]||"!"===e[0]?_(e):"@"===e[0]?f(e):"+"===e[0]?v(e):E(e):null}function E(e){if(!e.startsWith("http:")&&!e.startsWith("https:"))return e;const t=e.match(h.a.VECTOR_URL_PATTERN);if(t)return t[1];try{const t=C(e);if(t)if(t.roomIdOrAlias){const s=t.eventId?"/"+t.eventId:"";e=`#/room/${t.roomIdOrAlias}${s}`,t.viaServers.length>0&&(e+=(new a.b).encodeServerCandidates(t.viaServers))}else t.groupId?e="#/group/"+t.groupId:t.userId&&(e="#/user/"+t.userId)}catch(e){}return e}function S(e){try{let t=C(e);if(!t){const s=e.match(h.a.VECTOR_URL_PATTERN);if(s){const e=new u("http://localhost"),n=s[1].split("#").slice(1).join("#");t=e.parsePermalink("http://localhost/#"+n)}}if(!t)return null;if(t.userId)return t.userId;if(t.groupId)return t.groupId;if(t.roomIdOrAlias)return t.roomIdOrAlias}catch(e){}return null}function w(){const e=m.a.get().permalinkPrefix;return e&&e!==a.a?new u(e):new a.b}function C(e){const t=m.a.get().permalinkPrefix;return e.startsWith(a.a)?(new a.b).parsePermalink(e):t&&e.startsWith(t)?new u(t).parsePermalink(e):null}function R(e){return e.split(":").splice(1).join(":")}function k(e){return e?new URL("https://"+e).hostname:null}function I(e,t){if(!(e=k(e)))return!0;if(t.length>0&&!t[0].test)throw new Error(t[0]);return t.filter(t=>t.test(e)).length>0}function O(e){return!!(e=k(e))&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),o()(e))}},,function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(10),r=s.n(o),a=s(233),c=s(88),l=s(47),d=s(48);function u(e){return e.chunk.map(e=>Object(a.c)(e))}function h(e){return e.chunk.map(e=>Object(a.d)(e))}let m=0;const p=[];async function g(e){m>=3&&await new Promise((e,t)=>{p.push(e)}),m++;try{return await e()}catch(e){throw e}finally{m--,function(){const e=p.shift();"function"==typeof e&&e()}()}}class f extends r.a{constructor(){super(),i()(this,"STATE_KEY",{GroupMembers:"GroupMembers",GroupInvitedMembers:"GroupInvitedMembers",Summary:"Summary",GroupRooms:"GroupRooms"}),this._state={},this._state[this.STATE_KEY.Summary]={},this._state[this.STATE_KEY.GroupRooms]={},this._state[this.STATE_KEY.GroupMembers]={},this._state[this.STATE_KEY.GroupInvitedMembers]={},this._ready={},this._ready[this.STATE_KEY.Summary]={},this._ready[this.STATE_KEY.GroupRooms]={},this._ready[this.STATE_KEY.GroupMembers]={},this._ready[this.STATE_KEY.GroupInvitedMembers]={},this._fetchResourcePromise={[this.STATE_KEY.Summary]:{},[this.STATE_KEY.GroupRooms]:{},[this.STATE_KEY.GroupMembers]:{},[this.STATE_KEY.GroupInvitedMembers]:{}},this._resourceFetcher={[this.STATE_KEY.Summary]:e=>g(()=>l.a.get().getGroupSummary(e)),[this.STATE_KEY.GroupRooms]:e=>g(()=>l.a.get().getGroupRooms(e).then(h)),[this.STATE_KEY.GroupMembers]:e=>g(()=>l.a.get().getGroupUsers(e).then(u)),[this.STATE_KEY.GroupInvitedMembers]:e=>g(()=>l.a.get().getGroupInvitedUsers(e).then(u))}}_fetchResource(e,t){if(this._fetchResourcePromise[e][t])return;const s=this._resourceFetcher[e](t);return this._fetchResourcePromise[e][t]=s,s.then(s=>{this._state[e][t]=s,this._ready[e][t]=!0,this._notifyListeners()}).catch(s=>{e===this.STATE_KEY.GroupInvitedMembers&&403===s.httpStatus||(console.error(`Failed to get resource ${e} for ${t}`,s),this.emit("error",s,t,e))}).finally(()=>{delete this._fetchResourcePromise[e][t]}),s}_notifyListeners(){this.emit("update")}registerListener(e,t){return this.on("update",t),this.emit("update"),e&&(this._fetchResource(this.STATE_KEY.Summary,e),this._fetchResource(this.STATE_KEY.GroupRooms,e),this._fetchResource(this.STATE_KEY.GroupMembers,e),this._fetchResource(this.STATE_KEY.GroupInvitedMembers,e)),{unregister:()=>{this.unregisterListener(t)}}}unregisterListener(e){this.removeListener("update",e)}isStateReady(e,t){return this._ready[t][e]}getGroupIdsForRoomId(e){return Object.keys(this._state[this.STATE_KEY.GroupRooms]).filter(t=>(this._state[this.STATE_KEY.GroupRooms][t]||[]).some(t=>t.roomId===e))}getSummary(e){return this._state[this.STATE_KEY.Summary][e]||{}}getGroupRooms(e){return this._state[this.STATE_KEY.GroupRooms][e]||[]}getGroupMembers(e){return this._state[this.STATE_KEY.GroupMembers][e]||[]}getGroupInvitedMembers(e){return this._state[this.STATE_KEY.GroupInvitedMembers][e]||[]}getGroupPublicity(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_publicised:null}isUserPrivileged(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_privileged:null}refreshGroupRooms(e){return this._fetchResource(this.STATE_KEY.GroupRooms,e)}refreshGroupMembers(e){return this._fetchResource(this.STATE_KEY.GroupMembers,e)}addRoomToGroup(e,t,s){return l.a.get().addRoomToGroup(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}updateGroupRoomVisibility(e,t,s){return l.a.get().updateGroupRoomVisibility(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}removeRoomFromGroup(e,t){return l.a.get().removeRoomFromGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}inviteUserToGroup(e,t){return l.a.get().inviteUserToGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}acceptGroupInvite(e){return l.a.get().acceptGroupInvite(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}joinGroup(e){return l.a.get().joinGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}leaveGroup(e){return d.a.dispatch({action:"deselect_tags",tag:e}),l.a.get().leaveGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e))}addRoomToGroupSummary(e,t,s){return l.a.get().addRoomToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}addUserToGroupSummary(e,t,s){return l.a.get().addUserToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeRoomFromGroupSummary(e,t){return l.a.get().removeRoomFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeUserFromGroupSummary(e,t){return l.a.get().removeUserFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}setGroupPublicity(e,t){return l.a.get().setGroupPublicity(e,t).then(()=>{c.a.invalidatePublicisedGroups(l.a.get().credentials.userId)}).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}}let _=null;_||(_=new f),t.a=_},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(51),h=s.n(u),m=s(52),p=s(232);class g extends d.a.PureComponent{constructor(e){super(e),c()(this,"onMouseOver",()=>{this.props.forceHide||this.setState({hover:!0})}),c()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:s,children:n,tooltipClassName:o}=e,a=r()(e,["title","tooltip","children","tooltipClassName"]),c=this.state.hover?d.a.createElement(p.a,{className:"mx_AccessibleTooltipButton_container",tooltipClassName:h()("mx_AccessibleTooltipButton_tooltip",o),label:s||t}):d.a.createElement("div",null);return d.a.createElement(m.a,i()({},a,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,"aria-label":t}),n,c)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(43),i=s.n(n);class o extends i.a.Component{constructor(e){super(e),this._collectContainerRef=this._collectContainerRef.bind(this)}_collectContainerRef(e){e&&!this.containerRef&&(this.containerRef=e),this.props.wrappedRef&&this.props.wrappedRef(e)}getScrollTop(){return this.containerRef.scrollTop}render(){return i.a.createElement("div",{ref:this._collectContainerRef,style:this.props.style,className:["mx_AutoHideScrollbar",this.props.className].join(" "),onScroll:this.props.onScroll,onWheel:this.props.onWheel,tabIndex:this.props.tabIndex},this.props.children)}}},function(e,t,s){"use strict";let n;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.Room3pidMemberInfo="Room3pidMemberInfo",e.GroupMemberList="GroupMemberList",e.GroupRoomList="GroupRoomList",e.GroupRoomInfo="GroupRoomInfo",e.GroupMemberInfo="GroupMemberInfo"}(n||(n={}));const i=[n.RoomSummary,n.NotificationPanel,n.FilePanel,n.RoomMemberList,n.GroupMemberList,n.GroupRoomList]},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"c",(function(){return a}));var n=s(431);let i;!function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.ServerNotice="m.server_notice"}(i||(i={}));const o=[i.Invite,i.Favourite,i.DM,i.Untagged,i.LowPriority,i.ServerNotice,i.Archived];function r(e){return!Object(n.b)(i,e)}let a;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(a||(a={}))},function(e,t,s){"use strict";(function(e){var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(44),c=s(62),l=s(53),d=s(49),u=s(46);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function m(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const p=/#\/(groups?|room|user|settings|register|login|forgot_password|home|directory)/,g=/#\/(group|room|user)\/.*$/;function f(){const{origin:e,hash:t}=window.location;let{pathname:s}=window.location;return e.startsWith("file://")&&(s="/<redacted>/"),e+s+function(e){return p.exec(e)?g.test(e)?e.replace(g,"#/$1/<redacted>"):e.replace(p,"#/$1"):(console.warn(`Unexpected hash location "${e}"`),"#/<unexpected hash location>")}(t)}const _={"App Platform":{id:1,expl:Object(a.b)("The platform you're on"),example:"Electron Platform"},"App Version":{id:2,expl:Object(a.b)("The version of %(brand)s"),getTextVariables:()=>({brand:l.a.get().brand}),example:"15.0.0"},"User Type":{id:3,expl:Object(a.b)("Whether or not you're logged in (we don't record your username)"),example:"Logged In"},"Chosen Language":{id:4,expl:Object(a.b)("Your language of choice"),example:"en"},Instance:{id:5,expl:Object(a.b)("Which officially provided instance you are using, if any"),example:"app"},"RTE: Uses Richtext Mode":{id:6,expl:Object(a.b)("Whether or not you're using the Richtext mode of the Rich Text Editor"),example:"off"},"Homeserver URL":{id:7,expl:Object(a.b)("Your homeserver's URL"),example:"https://matrix.org"},"Touch Input":{id:8,expl:Object(a.b)("Whether you're using %(brand)s on a device where touch is the primary input mechanism"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"},Breadcrumbs:{id:9,expl:Object(a.b)("Whether or not you're using the 'breadcrumbs' feature (avatars above the room list)"),example:"disabled"},"Installed PWA":{id:10,expl:Object(a.b)("Whether you're using %(brand)s as an installed Progressive Web App"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"}};const v="mx_Riot_Analytics_uid";class y{constructor(){i()(this,"showDetailsModal",()=>{let e=[];e=this.disabled?Object.keys(_).map(e=>[e,Object(a.a)("e.g. %(exampleValue)s",{exampleValue:_[e].example})]):Object.values(this.visitVariables);const t=`${window.screen.width}x${window.screen.height}`,s=[{expl:Object(a.b)("Every page you use in the app"),value:Object(a.a)("e.g. <CurrentPageURL>",{},{CurrentPageURL:f()})},{expl:Object(a.b)("Your user agent"),value:navigator.userAgent},{expl:Object(a.b)("Your device resolution"),value:t}],n=u.getComponent("dialogs.ErrorDialog");d.a.createTrackedDialog("Analytics Details","",n,{title:Object(a.a)("Analytics"),description:r.a.createElement("div",{className:"mx_AnalyticsModal"},r.a.createElement("div",null,Object(a.a)("The information being sent to us to help make %(brand)s better includes:",{brand:l.a.get().brand})),r.a.createElement("table",null,e.map(e=>r.a.createElement("tr",{key:e[0]},r.a.createElement("td",null,Object(a.a)(_[e[0]].expl,_[e[0]].getTextVariables?_[e[0]].getTextVariables():null)),void 0!==e[1]&&r.a.createElement("td",null,r.a.createElement("code",null,e[1])))),s.map((e,t)=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,Object(a.a)(e.expl)),r.a.createElement("td",null,r.a.createElement("code",null,e.value))))),r.a.createElement("div",null,Object(a.a)("Where this page includes identifiable information, such as a room, user or group ID, that data is removed before being sent to the server.")))})}),this.baseUrl=null,this.siteId=null,this.visitVariables={},this.firstPage=!0,this._heartbeatIntervalID=null,this.creationTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_cts"),!this.creationTs&&localStorage&&localStorage.setItem("mx_Riot_Analytics_cts",this.creationTs=(new Date).getTime()),this.lastVisitTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_lvts"),this.visitCount=localStorage&&localStorage.getItem("mx_Riot_Analytics_vc")||0,localStorage&&localStorage.setItem("mx_Riot_Analytics_vc",parseInt(this.visitCount,10)+1)}get disabled(){return!this.baseUrl}async enable(){if(!this.disabled)return;const e=l.a.get();if(!(e&&e.piwik&&e.piwik.url&&e.piwik.siteId))return;this.baseUrl=new URL("piwik.php",e.piwik.url),this.baseUrl.searchParams.set("rec",1),this.baseUrl.searchParams.set("idsite",e.piwik.siteId),this.baseUrl.searchParams.set("apiv",1),this.baseUrl.searchParams.set("send_image",0),this.baseUrl.searchParams.set("_id",function(){try{let e=localStorage&&localStorage.getItem(v);return!e&&localStorage&&localStorage.setItem(v,e=[...Array(16)].map(()=>Math.random().toString(16)[2]).join("")),e}catch(e){return console.error("Analytics error: ",e),""}}()),this.baseUrl.searchParams.set("_idts",this.creationTs),this.baseUrl.searchParams.set("_idvc",parseInt(this.visitCount,10)+1),this.lastVisitTs&&this.baseUrl.searchParams.set("_viewts",this.lastVisitTs);const t=c.a.get();this._setVisitVariable("App Platform",t.getHumanReadableName());try{this._setVisitVariable("App Version",await t.getAppVersion())}catch(e){this._setVisitVariable("App Version","unknown")}this._setVisitVariable("Chosen Language",Object(a.d)());const s=window.location.hostname;"riot.im"===s?this._setVisitVariable("Instance",window.location.pathname):s.endsWith(".element.io")&&this._setVisitVariable("Instance",s.replace(".element.io",""));let n="unknown";try{n=window.matchMedia("(display-mode: standalone)").matches}catch(e){}this._setVisitVariable("Installed PWA",n);let i="unknown";try{i=window.matchMedia("(pointer: coarse)").matches}catch(e){}this._setVisitVariable("Touch Input",i),this._heartbeatIntervalID=window.setInterval(this.ping.bind(this),3e4)}disable(){this.disabled||(this.trackEvent("Analytics","opt-out"),window.clearInterval(this._heartbeatIntervalID),this.baseUrl=null,this.visitVariables={},localStorage.removeItem(v),localStorage.removeItem("mx_Riot_Analytics_cts"),localStorage.removeItem("mx_Riot_Analytics_vc"),localStorage.removeItem("mx_Riot_Analytics_lvts"))}async _track(e){if(this.disabled)return;const t=new Date,s=m(m({},e),{},{url:f(),_cvar:JSON.stringify(this.visitVariables),res:`${window.screen.width}x${window.screen.height}`,rand:String(Math.random()).slice(2,8),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()}),n=new URL(this.baseUrl);for(const e in s)n.searchParams.set(e,s[e]);try{await window.fetch(n,{method:"GET",mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch(e){console.error("Analytics error: ",e)}}ping(){this._track({ping:1}),localStorage.setItem("mx_Riot_Analytics_lvts",(new Date).getTime())}trackPageChange(e){this.disabled||(this.firstPage?this.firstPage=!1:("number"!=typeof e&&console.warn("Analytics.trackPageChange: expected generationTimeMs to be a number"),this._track({gt_ms:e})))}trackEvent(e,t,s,n){this.disabled||this._track({e_c:e,e_a:t,e_n:s,e_v:n})}_setVisitVariable(e,t){this.disabled||(this.visitVariables[_[e].id]=[e,t])}setLoggedIn(e,t,s){if(this.disabled)return;const n=l.a.get();if(!n.piwik)return;const i=n.piwik.whitelistedHSUrls||[];var o;this._setVisitVariable("User Type",e?"Guest":"Logged In"),this._setVisitVariable("Homeserver URL",(o=t,i.includes(o)?o:"<redacted>"))}setBreadcrumbs(e){this.disabled||this._setVisitVariable("Breadcrumbs",e?"enabled":"disabled")}}e.mxAnalytics||(e.mxAnalytics=new y),t.a=e.mxAnalytics}).call(this,s(6))},,function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(196),c=s(48),l=s(47),d=s(46),u=s(49),h=s(44),m=s(433);const p={joining:!1,joinError:null,roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,roomAlias:null,roomLoading:!1,roomLoadError:null,forwardingEvent:null,quotingEvent:null,replyingToEvent:null,shouldPeek:!1};class g extends a.Store{constructor(){super(c.a),i()(this,"state",p)}setState(e){let t=!1;for(const s of Object.keys(e))if(this.state[s]!==e[s]){t=!0;break}t&&(this.state=Object.assign(this.state,e),this.__emitChange())}__onDispatch(e){switch(e.action){case"view_room":this.viewRoom(e);break;case"view_create_group":case"view_welcome_page":case"view_home_page":case"view_my_groups":case"view_group":this.setState({roomId:null,roomAlias:null});break;case"view_room_error":this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case"join_room":this.joinRoom(e);break;case"join_room_error":this.joinRoomError(e);break;case"join_room_ready":this.setState({shouldPeek:!1});break;case"on_client_not_viable":case"on_logged_out":this.reset();break;case"forward_event":this.setState({forwardingEvent:e.event});break;case"reply_to_event":e.event&&e.event.getRoomId()!==this.state.roomId?c.a.dispatch({action:"view_room",room_id:e.event.getRoomId(),replyingToEvent:e.event}):this.setState({replyingToEvent:e.event});break;case"open_room_settings":{const t=d.getComponent("dialogs.RoomSettingsDialog");u.a.createTrackedDialog("Room settings","",t,{roomId:e.room_id||this.state.roomId},null,!1,!0);break}}}async viewRoom(e){if(e.room_id){const t={roomId:e.room_id,roomAlias:e.room_alias,initialEventId:e.event_id,isInitialEventHighlighted:e.highlighted,forwardingEvent:null,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,isEditingSettings:!1};e.replyingToEvent&&e.replyingToEvent.getRoomId()===e.room_id&&(t.replyingToEvent=e.replyingToEvent),this.state.forwardingEvent&&c.a.dispatch({action:"send_event",room_id:t.roomId,event:this.state.forwardingEvent}),this.setState(t),e.auto_join&&this.joinRoom(e)}else if(e.room_alias){let t=Object(m.a)(e.room_alias);if(!t){this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null});try{const s=await l.a.get().getRoomIdForAlias(e.room_alias);Object(m.b)(e.room_alias,s.room_id),t=s.room_id}catch(t){return console.error("RVS failed to get room id for alias: ",t),void c.a.dispatch({action:"view_room_error",room_id:null,room_alias:e.room_alias,err:t})}}c.a.dispatch({action:"view_room",room_id:t,event_id:e.event_id,highlighted:e.highlighted,room_alias:e.room_alias,auto_join:e.auto_join,oob_data:e.oob_data})}}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}joinRoom(e){this.setState({joining:!0}),l.a.get().joinRoom(this.state.roomAlias||this.state.roomId,e.opts).then(()=>{c.a.dispatch({action:"join_room_ready"})},e=>{c.a.dispatch({action:"join_room_error",err:e});let t=e.message?e.message:JSON.stringify(e);if(console.log("Failed to join room:",t),"ConnectionError"===e.name)t=Object(h.a)("There was an error joining the room");else if("M_INCOMPATIBLE_ROOM_VERSION"===e.errcode)t=r.a.createElement("div",null,Object(h.a)("Sorry, your homeserver is too old to participate in this room."),r.a.createElement("br",null),Object(h.a)("Please contact your homeserver administrator."));else if(404===e.httpStatus){const e=this.getInvitingUserId(this.state.roomId);e&&(t=e.endsWith(":"+l.a.get().getDomain())?Object(h.a)("The person who invited you already left the room."):Object(h.a)("The person who invited you already left the room, or their server is offline."))}const s=d.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Failed to join room","",s,{title:Object(h.a)("Failed to join room"),description:t})})}getInvitingUserId(e){const t=l.a.get(),s=t.getRoom(e);if(s&&"invite"===s.getMyMembership()){const e=s.getMember(t.getUserId()),n=e?e.events.member:null;return n&&n.getSender()}}joinRoomError(e){this.setState({joining:!1,joinError:e.err})}reset(){this.state=Object.assign({},p)}getRoomId(){return this.state.roomId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getForwardingEvent(){return this.state.forwardingEvent}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}}let f=null;f||(f=new g),t.a=f},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"e",(function(){return m}));var n=s(44);function i(){return[Object(n.a)("Sun"),Object(n.a)("Mon"),Object(n.a)("Tue"),Object(n.a)("Wed"),Object(n.a)("Thu"),Object(n.a)("Fri"),Object(n.a)("Sat")]}function o(){return[Object(n.a)("Jan"),Object(n.a)("Feb"),Object(n.a)("Mar"),Object(n.a)("Apr"),Object(n.a)("May"),Object(n.a)("Jun"),Object(n.a)("Jul"),Object(n.a)("Aug"),Object(n.a)("Sep"),Object(n.a)("Oct"),Object(n.a)("Nov"),Object(n.a)("Dec")]}function r(e){return(e<10?"0":"")+e}function a(e,t=!1){let s=e.getHours()%12;const i=r(e.getMinutes()),o=e.getHours()>=12?Object(n.a)("PM"):Object(n.a)("AM");if(s=s||12,t){return`${s}:${i}:${r(e.getSeconds())}${o}`}return`${s}:${i}${o}`}function c(e,t=!1){const s=new Date,r=i(),a=o();return e.toDateString()===s.toDateString()?h(e,t):s.getTime()-e.getTime()<5184e5?Object(n.a)("%(weekDayName)s %(time)s",{weekDayName:r[e.getDay()],time:h(e,t)}):s.getFullYear()===e.getFullYear()?Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:r[e.getDay()],monthName:a[e.getMonth()],day:e.getDate(),time:h(e,t)}):d(e,t)}function l(e){const t=i(),s=o();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:s[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e,t=!1){const s=i(),r=o();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:s[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:u(e,t)})}function u(e,t=!1){return t?a(e,!0):r(e.getHours())+":"+r(e.getMinutes())+":"+r(e.getSeconds())}function h(e,t=!1){return t?a(e):r(e.getHours())+":"+r(e.getMinutes())}function m(e,t){return!(!t||!e)&&(Math.abs(e.getTime()-t.getTime())>864e5||e.getDay()!==t.getDay())}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(47),i=s(53),o=s(48),r=s(66),a=s(171),c=s(50),l=s(142),d=s(93),u=s(7),h=(s(187),s(102)),m=s(11),p=s(44);class g{static canUserModifyWidgets(e){if(!e)return console.warn("No room ID specified"),!1;const t=n.a.get();if(!t)return console.warn("User must be be logged in"),!1;const s=t.getRoom(e);if(!s)return console.warn(`Room ID ${e} is not recognised`),!1;const i=t.credentials.userId;return i?"join"!==s.getMyMembership()?(console.warn(`User ${i} is not in room ${e}`),!1):s.currentState.maySendStateEvent("im.vector.modular.widgets",i):(console.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return console.error("Scalar URL check failed. No URL specified"),!1;const t=r.parse(e);let s=i.a.get().integrations_widgets_urls;if(!s||0===s.length){const e=d.a.sharedInstance().getPrimaryManager();s=e?[e.apiUrl]:[]}for(let e=0;e<s.length;e++){const n=r.parse(s[e]);if(t&&n&&t.protocol===n.protocol&&t.host===n.host&&t.pathname.startsWith(n.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise((s,i)=>{function o(s){return!(!s||!s.getContent())&&(t?void 0!==s.getContent()[e]:void 0===s.getContent()[e])}if(o(n.a.get().getAccountData("m.widgets")))return void s();function r(e){o(n.a.get().getAccountData("m.widgets"))&&(n.a.get().removeListener("accountData",r),clearTimeout(a),s())}const a=setTimeout(()=>{n.a.get().removeListener("accountData",r),i(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);n.a.get().on("accountData",r)})}static waitForRoomWidget(e,t,s){return new Promise((i,o)=>{function r(t){const n=t.some(t=>t.getContent()&&t.getContent().id===e);return s?n:!n}const a=n.a.get().getRoom(t);if(r(a.currentState.getStateEvents("im.vector.modular.widgets")))return void i();function c(e){if(e.getRoomId()!==t)return;r(a.currentState.getStateEvents("im.vector.modular.widgets"))&&(n.a.get().removeListener("RoomState.events",c),clearTimeout(l),i())}const l=setTimeout(()=>{n.a.get().removeListener("RoomState.events",c),o(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);n.a.get().on("RoomState.events",c)})}static setUserWidget(e,t,s,i,r){const a={type:t.preferred,url:s,name:i,data:r},c=n.a.get(),l=Object(m.a)(g.getUserWidgets());try{delete l[e]}catch(e){console.error("$widgetId is non-configurable")}const d=Boolean(s);return d&&(l[e]={content:a,sender:c.getUserId(),state_key:e,type:"m.widget",id:e}),c.setAccountData("m.widgets",l).then(()=>g.waitForUserWidget(e,d)).then(()=>{o.a.dispatch({action:"user_widget_updated"})})}static setRoomWidget(e,t,s,i,o,r){let c;const l=Boolean(i);c=l?{type:s.legacy,url:i,name:o,data:r}:{},a.a.setRoomWidgetEcho(e,t,c);return n.a.get().sendStateEvent(e,"im.vector.modular.widgets",c,t).then(()=>g.waitForRoomWidget(t,e,l)).finally(()=>{a.a.removeRoomWidgetEcho(e,t)})}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter(e=>e.getContent().type&&e.getContent().url):[]}static getUserWidgets(){const e=n.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(g.getUserWidgets())}static getStickerpickerWidgets(){return g.getUserWidgetsArray().filter(e=>e.content&&"m.stickerpicker"===e.content.type)}static getIntegrationManagerWidgets(){return g.getUserWidgetsArray().filter(e=>e.content&&"m.integration_manager"===e.content.type)}static getRoomWidgetsOfType(e,t){return(g.getRoomWidgets(e)||[]).filter(e=>{const s=e.getContent();return s.url&&t.matches(s.type)})}static removeIntegrationManagerWidgets(){const e=n.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.integration_manager"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static addIntegrationManagerWidget(e,t,s){return g.setUserWidget("integration_manager_"+(new Date).getTime(),h.a.INTEGRATION_MANAGER,t,"Integration Manager: "+e,{api_url:s})}static removeStickerpickerWidgets(){const e=n.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.stickerpicker"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static makeAppConfig(e,t,s,n,i){if(!s)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=s,t.id=e,t.roomId=n,t.eventId=i,t.name=t.name||t.type,t}static getCapWhitelistForAppTypeInRoomId(e,t){const s=c.a.getValue("enableWidgetScreenshots",t)?[u.a.Screenshot]:[];return h.a.JITSI.matches(e)&&s.push(u.a.AlwaysOnScreen),s.push(u.a.ReceiveTerminate),s}static getWidgetSecurityKey(e,t,s){let n=l.a.getRoomId(e);if(s){const s=g.getUserWidgetsArray().find(s=>s.id===e&&s.content&&s.content.url===t);if(!s)throw new Error("No matching user widget to form security key");n=s.sender}if(!n)throw new Error("Failed to locate where the widget resides");return encodeURIComponent(`${n}::${t}`)}static getLocalJitsiWrapperUrl(e={}){const t=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id"];e.auth&&t.push("auth="+e.auth);const s=t.join("&");let n=window.location;"https:"===window.location.protocol||e.forLocalRender||(n="https://app.element.io/");return new URL("jitsi.html#"+s,n).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(p.a)("Unknown App")}static getWidgetDataTitle(e){var t,s;return(null==e||null===(t=e.data)||void 0===t||null===(s=t.title)||void 0===s?void 0:s.trim())||""}static editWidget(e,t){c.a.getValue("feature_many_integration_managers")?d.a.sharedInstance().openAll(e,"type_"+t.type,t.id):d.a.sharedInstance().getPrimaryManager().open(e,"type_"+t.type,t.id)}static snapshotWidget(e){console.log("Requesting widget snapshot"),l.a.getWidgetMessaging(e.id).getScreenshot().catch(e=>{console.error("Failed to get screenshot",e)}).then(e=>{o.a.dispatch({action:"picture_snapshot",file:e},!0)})}}},function(e,t,s){"use strict";s.d(t,"i",(function(){return D})),s.d(t,"h",(function(){return A})),s.d(t,"f",(function(){return U})),s.d(t,"g",(function(){return M})),s.d(t,"c",(function(){return L})),s.d(t,"a",(function(){return q})),s.d(t,"e",(function(){return G})),s.d(t,"d",(function(){return W})),s.d(t,"b",(function(){return H}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(245),c=s.n(a),l=s(802),d=s(315),u=s(807),h=s.n(u),m=s(809),p=s.n(m),g=s(51),f=s.n(g),_=s(812),v=s.n(_),y=s(66),b=s.n(y),E=s(47),S=s(65),w=s(210),C=s(170);function R(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function k(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?R(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):R(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(d.a)(l);const I=/([\ud800-\udbff])([\udc00-\udfff])/,O=/([\u2100-\u2bff])/,T=new RegExp("‍| ","g"),x=new RegExp("\\s","g"),N=new RegExp(`^(${v.a.source})+$`,"i"),j=/^#[0-9a-fA-F]{6}$/,P=["http","https","ftp","mailto","magnet"];function D(e){const t=Object(w.e)(e);return t&&t.shortcodes?`:${t.shortcodes[0]}:`:""}function A(e){e=e.slice(1,e.length-1);const t=w.d.get(e);return t?t.unicode:null}function U(e){const t=c()(e,B);return r.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function M(e){const t=c()(e,B),s=document.createElement("div");return s.innerHTML=t,s.innerText}function L(e){try{const t=b.a.parse(e);return!!t.protocol&&P.includes(t.protocol.slice(0,-1))}catch(e){return!1}}const F={a:function(e,t){if(t.href){t.target="_blank";const e=Object(S.j)(t.href);(e!==t.href||t.href.match(d.a.VECTOR_URL_PATTERN))&&(t.href=e,delete t.target)}return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){return t.src&&t.src.startsWith("mxc://")?(t.src=E.a.get().mxcUrlToHttp(t.src,t.width||800,t.height||600),{tagName:e,attribs:t}):{tagName:e,attribs:{}}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){delete t.style;const s={"data-mx-color":"color","data-mx-bg-color":"background-color"};let n="";return Object.keys(s).forEach(e=>{const i=s[e],o=t[e];o&&"string"==typeof o&&j.test(o)&&(n+=i+":"+o+";",delete t[e])}),n&&(t.style=n),{tagName:e,attribs:t}}},B={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],a:["href","name","target","rel"],img:["src","width","height","alt","title"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:P,allowProtocolRelative:!1,transformTags:F},V=k(k({},B),{},{transformTags:{code:F.code,"*":F["*"]}});class K extends class{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let s,n=0,i=[];const o=t[0];for(;(s=e.toLowerCase().indexOf(o.toLowerCase(),n))>=0;){if(s>n){const o=e.substring(n,s);i=i.concat(this.applySubHighlights(o,t))}const r=s+o.length;i.push(this.processSnippet(e.substring(s,r),!0)),n=r}if(n!==e.length){const s=e.substring(n,void 0);i=i.concat(this.applySubHighlights(s,t))}return i}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}{processSnippet(e,t){if(!t)return e;let s=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(s=`<a href="${encodeURI(this.highlightLink)}">${s}</a>`),s}}function q(e,t,s={}){const n="org.matrix.custom.html"===e.format&&e.formatted_body;let i,o,a,l=!1,d=B;s.forComposerQuote&&(d=V);try{if(t&&t.length>0){const e=new K("mx_EventTile_searchHighlight",s.highlightLink),n=t.map((function(e){return c()(e,d)}));d.textFilter=function(t){return e.applyHighlights(t,n).join("")}}let r="string"==typeof e.formatted_body?e.formatted_body:null;const h="string"==typeof e.body?e.body:"";s.stripReplyFallback&&r&&(r=C.a.stripHTMLReply(r)),i=s.stripReplyFallback?C.a.stripPlainReply(h):h,u=n?r:h,l=I.test(u)||O.test(u),n&&(a=!0,o=c()(r,d))}finally{delete d.textFilter}var u;if(s.returnString)return a?o:i;let h=!1;if(!s.disableBigEmoji&&l){let t=void 0!==i?i.trim():"";t=t.replace(x,""),t=t.replace(T,"");const s=N.exec(t);h=s&&s[0]&&s[0].length===t.length&&(i===o||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const m=f()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:h,"markdown-body":n&&!h});return a?r.a.createElement("span",{key:"body",ref:s.ref,className:m,dangerouslySetInnerHTML:{__html:o},dir:"auto"}):r.a.createElement("span",{key:"body",ref:s.ref,className:m,dir:"auto"},i)}function G(e,t=d.a.options){return h()(e,t)}function W(e,t=d.a.options){return c()(function(e,t=d.a.options){return p()(e,t)}(e,t),B)}function H(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"DIV":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;default:return!1}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(2),i=s.n(n),o=s(10),r=s.n(o);class a extends r.a{constructor(...e){super(...e),i()(this,"toasts",[]),i()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new a),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex(t=>t.key===e.key);if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter(t=>t.key!==e),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(1);function i(e,t,s,i,o,r){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return r?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const l={};s&&(l.width=Math.round(s)),i&&(l.height=Math.round(i)),o&&(l.method=o),n.t(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=a.indexOf("#");let u="";return d>=0&&(u=a.substr(d),a=a.substr(0,d)),e+c+a+(0===n.t(l).length?"":"?"+n.e(l))+u}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l}));var n=s(10),i=s(1),o=s(0);const r={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"},a={};function c(e){return a[e]||(a[e]=e),a[e]}const l=function(e){["state_key","type","sender","room_id","membership"].forEach(t=>{e[t]&&(e[t]=c(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{e.content&&e.content[t]&&(e.content[t]=c(e.content[t]))}),["rel_type"].forEach(t=>{e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=c(e.content["m.relates_to"][t]))}),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._untrusted=null,this._decryptionPromise=null,this._retryDecryption=!1,this.verificationRequest=null,this._txnId=null};i.o(l,n.EventEmitter),i.i(l.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getLocalAge:function(){return Date.now()-this.getTs()},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,s,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=s,this._claimedEd25519Key=n},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},attemptDecryption:async function(e,t){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"!==this._clearEvent.content.msgtype)throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(o.a.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this._retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this._decryptionLoop(e,t),this._decryptionPromise)},cancelAndResendKeyRequest:function(e,t){const s=this.getWireContent();return e.requestRoomKey({algorithm:s.algorithm,room_id:this.getRoomId(),session_id:s.session_id,sender_key:s.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){const t=this.getWireContent(),s=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&s.push({userId:n,deviceId:t.device_id}),s},_decryptionLoop:async function(e,t){for(await Promise.resolve();;){let s,n;this._retryDecryption=!1;try{e?(s=await e.decryptEvent(this),t&&o.a.info(`Decrypted event on retry (id=${this.getId()})`)):s=this._badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const s=t?"re":"";return o.a.error(`Error ${s}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this._retryDecryption=!1)}if(n=e,this._retryDecryption){o.a.log(`Got error decrypting event (id=${this.getId()}: `+e+"), but retrying");continue}o.a.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),s=this._badEncryptedMessage(e.message)}return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(s),this.setPushActions(null),void this.emit("Event.decrypted",this,n)}},_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this._untrusted=e.untrusted||!1},getClearContent:function(){const e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return!this.isState()&&"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},isKeySourceUntrusted:function(){return this._untrusted},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");let t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(d[t]||delete this.event[t]);const s=u[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(s[t]||delete n[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){const t=this.getUnsigned(),s=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==s&&this.emit("Event.localEventIdReplaced",this)},isSending(){return!!this.status},setStatus(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation(e){const t=this.getWireContent(),s=t&&t["m.relates_to"];return s&&s.rel_type&&s.event_id&&(e&&s.rel_type===e||!e)},getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation(e){const t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId(){const e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent(){return this._replacingEvent},replacingEventDate(){const e=this.getServerAggregatedRelation("m.replace");if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent(){return this._localRedactionEvent},getAssociatedId(){const e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation(){return!!this.getAssociatedId()},updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled(e=!0){this._isCancelled=e},isCancelled(){return this._isCancelled},toJSON(){const e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e},setVerificationRequest:function(e){this.verificationRequest=e},setTxnId(e){this._txnId=e},getTxnId(){return this._txnId}});const d=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),u={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(55),c=s(44),l=s(481),d=s(53);const u=[a.a.ERROR_INVALID_HOMESERVER,a.a.ERROR_INVALID_IDENTITY_SERVER];class h{constructor(){i()(this,"hsUrl",void 0),i()(this,"hsName",void 0),i()(this,"hsNameIsDifferent",void 0),i()(this,"isUrl",void 0),i()(this,"isDefault",void 0),i()(this,"warning",void 0)}}class m{static isLivelinessError(e){return!!e&&!!u.find(t=>t===e||t===e.message)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let s=Object(c.a)("Cannot reach homeserver"),n=Object(c.a)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!m.isLivelinessError(e)){const e=d.a.get().brand;s=Object(c.a)("Your %(brand)s is misconfigured",{brand:e}),n=Object(c.a)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>r.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let i=!0;return(e.message?e.message:e)===a.a.ERROR_INVALID_IDENTITY_SERVER&&(i=!1,s=Object(c.a)("Cannot reach identity server"),n="register"===t?Object(c.a)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(c.a)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(c.a)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:i,serverDeadError:r.a.createElement("div",null,r.a.createElement("strong",null,s),r.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t,s=!1){if(!e)throw Object(c.h)(Object(c.b)("No homeserver URL provided"));const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const i=await a.a.fromDiscoveryConfig(n),o=new URL(e).hostname;return m.buildValidatedConfigFromDiscovery(o,i,s)}static async validateServerName(e){const t=await a.a.findClientConfig(e);return m.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t,s=!1){if(!t||!t["m.homeserver"])throw console.error("Ended up in a state of not knowing which homeserver to connect to."),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));const n=t["m.homeserver"],i=t["m.identity_server"],o=d.a.get().validated_server_config;let r=o&&o.isUrl;if(i&&i.state===a.a.SUCCESS)r=i.base_url;else if(i&&i.state!==a.a.PROMPT){if(console.error("Error determining preferred identity server URL:",i),i.state===a.a.FAIL_ERROR){if(-1!==a.a.ALL_ERRORS.indexOf(i.error))throw Object(c.h)(i.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving identity server configuration"))}n.error=a.a.ERROR_INVALID_IDENTITY_SERVER,i.base_url&&(r=i.base_url)}if(n.state!==a.a.SUCCESS&&(console.error("Error processing homeserver config:",n),!s||!m.isLivelinessError(n.error))){if(-1!==a.a.ALL_ERRORS.indexOf(n.error))throw Object(c.h)(n.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"))}const u=n.base_url;let p=e||n.server_name;const g=new URL(u);if(p||(p=g.hostname),!p)throw console.error("Failed to parse homeserver name from homeserver URL"),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));return Object(l.a)(h,{hsUrl:u,hsName:p,hsNameIsDifferent:g.hostname!==p,isUrl:r,isDefault:!1,warning:n.error})}}},function(e,t,s){"use strict";s.r(t),function(e,n){s.d(t,"OLM_ALGORITHM",(function(){return c})),s.d(t,"MEGOLM_ALGORITHM",(function(){return l})),s.d(t,"MEGOLM_BACKUP_ALGORITHM",(function(){return d})),s.d(t,"encryptMessageForDevice",(function(){return u})),s.d(t,"getExistingOlmSessions",(function(){return h})),s.d(t,"ensureOlmSessionsForDevices",(function(){return m})),s.d(t,"verifySignature",(function(){return g})),s.d(t,"pkSign",(function(){return f})),s.d(t,"pkVerify",(function(){return _})),s.d(t,"encodeBase64",(function(){return v})),s.d(t,"encodeUnpaddedBase64",(function(){return y})),s.d(t,"decodeBase64",(function(){return b}));var i=s(0),o=s(1),r=s(274),a=s.n(r);const c="m.olm.v1.curve25519-aes-sha2",l="m.megolm.v1.aes-sha2",d="m.megolm_backup.v1.curve25519-aes-sha2";async function u(e,t,s,n,r,a,c){const l=a.getIdentityKey(),d=await n.getSessionIdForDevice(l);if(null===d)return;i.a.log("Using sessionid "+d+" for device "+r+":"+a.deviceId);const u={sender:t,sender_device:s,keys:{ed25519:n.deviceEd25519Key},recipient:r,recipient_keys:{ed25519:a.getFingerprint()}};o.i(u,c),e[l]=await n.encryptMessage(l,d,JSON.stringify(u))}async function h(e,t,s){const n={},i={},o=[];for(const[t,r]of Object.entries(s))for(const s of r){const r=s.deviceId,a=s.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(a,!0);null===o?(n[t]=n[t]||[],n[t].push(s)):(i[t]=i[t]||{},i[t][r]={device:s,sessionId:o})})())}return await Promise.all(o),[n,i]}async function m(e,t,s,n,o,r){"number"==typeof n&&(r=o,o=n,n=!1);const a=[],c={},l={};for(const[t,o]of Object.entries(s)){c[t]={};for(const s of o){const o=s.deviceId,r=s.getIdentityKey();if(r===e.deviceCurve25519Key){i.a.info("Attempted to start session with ourself! Ignoring"),c[t][o]={device:s,sessionId:null};continue}e._sessionsInProgress[r]||(e._sessionsInProgress[r]=new Promise((t,s)=>{l[r]={resolve:(...s)=>{delete e._sessionsInProgress[r],t(...s)},reject:(...t)=>{delete e._sessionsInProgress[r],s(...t)}}}));const d=await e.getSessionIdForDevice(r,l[r]);null!==d&&l[r]&&(delete e._sessionsInProgress[r],l[r].resolve(),delete l[r]),(null===d||n)&&(n?i.a.info("Forcing new Olm session for "+t+":"+o):i.a.info("Making new Olm session for "+t+":"+o),a.push([t,o])),c[t][o]={device:s,sessionId:d}}}if(0===a.length)return c;let d;try{d=await t.claimOneTimeKeys(a,"signed_curve25519",o)}catch(e){for(const e of Object.values(l))e.resolve();throw i.a.log("failed to claim one-time keys",e,a),e}r&&"failures"in d&&r.push(...Object.keys(d.failures));const u=d.one_time_keys||{},h=[];for(const[t,o]of Object.entries(s)){const s=u[t]||{};for(let r=0;r<o.length;r++){const a=o[r],d=a.deviceId,u=a.getIdentityKey();if(u===e.deviceCurve25519Key)continue;if(c[t][d].sessionId&&!n)continue;const m=s[d]||{};let g=null;for(const e in m)0===e.indexOf("signed_curve25519:")&&(g=m[e]);if(g)h.push(p(e,g,t,a).then(e=>{l[u]&&l[u].resolve(e),c[t][d].sessionId=e},e=>{throw l[u]&&l[u].resolve(),e}));else{const e="No one-time keys (alg=signed_curve25519) for device "+t+":"+d;i.a.warn(e),l[u]&&l[u].resolve()}}}return await Promise.all(h),c}async function p(e,t,s,n){const o=n.deviceId;try{await g(e,t,s,o,n.getFingerprint())}catch(e){return i.a.error("Unable to verify signature on one-time key for device "+s+":"+o+":",e),null}let r;try{r=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return i.a.error("Error starting olm session with device "+s+":"+o+": "+e),null}return i.a.log("Started new olm sessionid "+r+" for device "+s+":"+o),r}async function g(e,t,s,n,i){const o="ed25519:"+n,r=((t.signatures||{})[s]||{})[o];if(!r)throw Error("No signature");const c=Object.assign({},t);delete c.unsigned,delete c.signatures;const l=a.a.stringify(c);e.verifySignature(i,l,r)}function f(t,s,n,i){let o=!1;if(s instanceof Uint8Array){const t=new e.Olm.PkSigning;i=t.init_with_seed(s),s=t,o=!0}const r=t.signatures||{};delete t.signatures;const c=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=r[n]||{};return r[n]=e,e["ed25519:"+i]=s.sign(a.a.stringify(t))}finally{t.signatures=r,c&&(t.unsigned=c),o&&s.free()}}function _(t,s,n){const i="ed25519:"+s;if(!(t.signatures&&t.signatures[n]&&t.signatures[n][i]))throw new Error("No signature");const o=t.signatures[n][i],r=new e.Olm.Utility,c=t.signatures;delete t.signatures;const l=t.unsigned;t.unsigned&&delete t.unsigned;try{r.ed25519_verify(s,a.a.stringify(t),o)}finally{t.signatures=c,l&&(t.unsigned=l),r.free()}}function v(e){return n.from(e).toString("base64")}function y(e){return v(e).replace(/=+$/g,"")}function b(e){return n.from(e,"base64")}}.call(this,s(6),s(22).Buffer)},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(2),i=s.n(n),o=s(10),r=s(441),a=s.n(r);const c="update";class l extends o.EventEmitter{constructor(e,t={}){super(),this.dispatcher=e,i()(this,"storeState",void 0),i()(this,"lock",new a.a),i()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(c,this)}finally{await this.lock.release()}}async reset(e=null,t=!1){await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(c,this)}finally{await this.lock.release()}}}},function(e,t,s){"use strict";function n(e,t){return new Promise(s=>{setTimeout(s,e,t)})}async function i(e,t,s){const n=new Promise(n=>{const i=setTimeout(n,s,t);e.then(()=>{clearTimeout(i)})});return Promise.race([e,n])}function o(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}}function r(e){return Promise.allSettled?Promise.allSettled(e):Promise.all(e.map(e=>e.then(e=>({status:"fulfilled",value:e})).catch(e=>({status:"rejected",reason:e}))))}s.d(t,"c",(function(){return n})),s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}))},function(e,t,s){"use strict";(function(e){var n=s(10),i=s.n(n);let o=!0;class r extends i.a{constructor(e){super(),this._matrixClient=e,this._userGroups={},this._groupProfiles={},this._groupProfilesPromise={},this._usersPending={},this._usersInFlight={},this._debounceTimeoutID=null}groupSupport(){return o}invalidatePublicisedGroups(e){delete this._userGroups[e]}getPublicisedGroupsCached(e,t){return this._userGroups[t]?Promise.resolve(this._userGroups[t]):this._usersPending[t]?this._usersPending[t].prom:this._usersInFlight[t]?this._usersInFlight[t].prom:(this._usersPending[t]={},this._usersPending[t].prom=new Promise((e,s)=>{this._usersPending[t].resolve=e,this._usersPending[t].reject=s}).then(e=>(this._userGroups[t]=e,setTimeout(()=>{delete this._userGroups[t]},18e5),this._userGroups[t])).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return console.warn("Cannot display flair, server does not support groups"),void(o=!1);throw console.error("Could not get groups for user",t,e),e}).finally(()=>{delete this._usersInFlight[t]}),this._debounceTimeoutID&&clearTimeout(this._debounceTimeoutID),this._debounceTimeoutID=setTimeout(()=>{this._batchedGetPublicGroups(e)},200),this._usersPending[t].prom)}async _batchedGetPublicGroups(e){this._usersInFlight=this._usersPending,this._usersPending={};let t={users:[]};try{t=await e.getPublicisedGroups(Object.keys(this._usersInFlight))}catch(e){return void Object.keys(this._usersInFlight).forEach(t=>{this._usersInFlight[t]&&this._usersInFlight[t].reject(e)})}const s=t.users;Object.keys(this._usersInFlight).forEach(e=>{this._usersInFlight[e]&&this._usersInFlight[e].resolve(s[e]||[])})}getGroupProfileCachedFast(e,t){return e&&t?this._groupProfiles[t]?this._groupProfiles[t]:(this.getGroupProfileCached(e,t),null):null}async getGroupProfileCached(e,t){if(this._groupProfiles[t])return this._groupProfiles[t];if(this._groupProfilesPromise[t]){try{await this._groupProfilesPromise[t]}catch(e){return null}return this._groupProfiles[t]}let s;console.log("FlairStore: Request group profile of "+t),this._groupProfilesPromise[t]=e.getGroupProfile(t);try{s=await this._groupProfilesPromise[t]}catch(e){return console.log("FlairStore: Failed to get group profile for "+t,e),delete this._groupProfilesPromise[t],null}return this._groupProfiles[t]={groupId:t,avatarUrl:s.avatar_url,name:s.name,shortDescription:s.short_description},delete this._groupProfilesPromise[t],console.log("FlairStore: Emit updateGroupProfile for "+t),this.emit("updateGroupProfile"),setTimeout(()=>{this.refreshGroupProfile(e,t)},18e5),this._groupProfiles[t]}refreshGroupProfile(e,t){return delete this._groupProfiles[t],this.getGroupProfileCached(e,t)}}void 0===e.singletonFlairStore&&(e.singletonFlairStore=new r),t.a=e.singletonFlairStore}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return E})),s.d(t,"b",(function(){return w}));var n=s(2),i=s.n(n),o=s(50),r=s(71),a=s(169),c=s(48),l=s(432),d=s(244),u=s(1158),h=s(74),m=s(1155),p=s(139),g=s(1),f=s(552),_=s(800),v=s(103),y=s(453),b=s(131);const E="lists_update";class S extends v.a{constructor(){super(c.a),i()(this,"initialListsGenerated",!1),i()(this,"algorithm",new m.a),i()(this,"filterConditions",[]),i()(this,"tagWatcher",new u.a(this)),i()(this,"updateFn",new _.a(()=>{for(const e of Object.keys(this.unfilteredLists))b.a.instance.getListState(e).setRooms(this.unfilteredLists[e]);this.emit(E)})),i()(this,"watchedSettings",["feature_custom_tags","advancedRoomListLogging"]),i()(this,"onAlgorithmListUpdated",()=>{o.a.getValue("advancedRoomListLogging")&&console.log("Underlying algorithm has triggered a list update - marking"),this.updateFn.mark()}),i()(this,"onAlgorithmFilterUpdated",()=>{this.updateFn.trigger()}),this.checkLoggingEnabled();for(const e of this.watchedSettings)o.a.monitorSetting(e,null);h.a.addListener(()=>this.handleRVSUpdate({})),this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmFilterUpdated)}get unfilteredLists(){return this.algorithm?this.algorithm.getUnfilteredRooms():{}}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}get matrixClient(){return super.matrixClient}async resetStore(){await this.reset(),this.tagWatcher=new u.a(this),this.filterConditions=[],this.initialListsGenerated=!1,this.algorithm.off(m.b,this.onAlgorithmListUpdated),this.algorithm.off(d.a,this.onAlgorithmListUpdated),this.algorithm=new m.a,this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&(super.matrixClient=e),this.checkLoggingEnabled(),console.log("Regenerating room lists: Startup"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),await this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}checkLoggingEnabled(){o.a.getValue("advancedRoomListLogging")&&console.warn("Advanced room list logging is enabled")}async readAndCacheSettingsFromStore(){const e=o.a.getValue("feature_custom_tags");await this.updateState({tagsEnabled:e}),await this.updateAlgorithmInstances()}async handleRVSUpdate({trigger:e=!0}){if(!this.matrixClient)return;const t=h.a.getRoomId();if(!t&&this.algorithm.stickyRoom)await this.algorithm.setStickyRoom(null);else if(t){const e=this.matrixClient.getRoom(t);e?e!==this.algorithm.stickyRoom&&(o.a.getValue("advancedRoomListLogging")&&console.log("Changing sticky room to "+t),await this.algorithm.setStickyRoom(e)):(console.warn(t+" is current in RVS but missing from client - clearing sticky room"),await this.algorithm.setStickyRoom(null))}e&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(S.TEST_MODE?await this.onDispatchAsync(t):e(()=>this.onDispatchAsync(t)))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if("setting_updated"===e.action&&this.watchedSettings.includes(e.settingName)){if("advancedRoomListLogging"===e.settingName){const e=o.a.getValue("advancedRoomListLogging");return void console.warn("Advanced room list logging is enabled? "+e)}console.log("Regenerating room lists: Settings changed"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),this.updateFn.trigger()}if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(l.a)(e.event,this.matrixClient)){const t=e.room;return t?(o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got own read receipt in "+t.roomId),await this.handleRoomUpdate(t,r.c.ReadReceipt),void this.updateFn.trigger()):void console.warn("Own read receipt was in unknown room "+t.roomId)}}else if("MatrixActions.Room.tags"===e.action){const t=e;o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tag change in "+t.room.roomId),await this.handleRoomUpdate(t.room,r.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!e.isLiveUnfilteredRoomTimelineEvent)return;const s=t.event.getRoomId(),n=this.matrixClient.getRoom(s),i=async e=>{if(o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Live timeline event "+t.event.getId()+" in "+e.roomId),"m.room.tombstone"===t.event.getType()&&""===t.event.getStateKey()){o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tombstone event - trying to remove now-dead room");if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,r.c.Timeline),this.updateFn.trigger()};if(!n)return console.warn(`Live timeline event ${t.event.getId()} received without associated room`),console.warn("Queuing failed room update for retry as a result."),void setTimeout(async()=>{const e=this.matrixClient.getRoom(s);await i(e)},100);await i(n)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,s=t.event.getRoomId(),n=this.matrixClient.getRoom(s);if(!n)return void console.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${s}`);o.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Decrypted timeline event ${t.event.getId()} in ${s}`),await this.handleRoomUpdate(n,r.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&"m.direct"===e.event_type){const t=e;o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Received updated DM map");const s=t.event.getContent();for(const e of Object.keys(s)){const t=s[e];for(const e of t){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,r.c.PossibleTagChange):console.warn(e+" was found in DMs but the room is not in the store")}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action){const t=e,s=Object(p.b)(t.oldMembership),n=Object(p.b)(t.membership);if(s!==p.a.Join&&n===p.a.Join){o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling new room "+t.room.roomId);const e=t.room.currentState.getStateEvents("m.room.create","");if(e&&e.getContent().predecessor){o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Room has a predecessor");const t=this.matrixClient.getRoom(e.getContent().predecessor.room_id);if(t){this.algorithm.stickyRoom===t&&(o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Clearing sticky room due to room upgrade"),await this.algorithm.setStickyRoom(null)),o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Removing previous room from room list"),await this.algorithm.handleRoomUpdate(t,r.c.RoomRemoved)}}return o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Adding new room to room list"),await this.handleRoomUpdate(t.room,r.c.NewRoom),void this.updateFn.trigger()}if(s!==p.a.Invite&&n===p.a.Invite)return o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling invite to "+t.room.roomId),await this.handleRoomUpdate(t.room,r.c.NewRoom),void this.updateFn.trigger();if(s!==n)return o.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling membership change in "+t.room.roomId),await this.handleRoomUpdate(t.room,r.c.PossibleTagChange),void this.updateFn.trigger()}}}async handleRoomUpdate(e,t){await this.algorithm.handleRoomUpdate(e,t)&&(o.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] Room "${e.name}" (${e.roomId}) triggered by ${t} requires list update`),this.updateFn.mark())}async setTagSorting(e,t){await this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}async setAndPersistTagSorting(e,t){await this.algorithm.setTagSorting(e,t),localStorage.setItem("mx_tagSort_"+e,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem("mx_tagSort_"+e)}calculateTagSorting(e){const t=e===r.a.Invite||e===r.a.DM?a.b.Recent:a.b.Alphabetic,s=o.a.getValue("RoomList.orderAlphabetically",null,!0),n=this.getTagSorting(e),i=this.getStoredTagSorting(e);let c=t;return i?c=i:Object(g.r)(s)?n&&(c=n):c=s?a.b.Alphabetic:a.b.Recent,c}async setListOrder(e,t){await this.setAndPersistListOrder(e,t),this.updateFn.trigger()}async setAndPersistListOrder(e,t){await this.algorithm.setListOrdering(e,t),localStorage.setItem("mx_listOrder_"+e,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem("mx_listOrder_"+e)}calculateListOrder(e){const t=a.a.Natural,s=o.a.getValue("RoomList.orderByImportance",null,!0),n=this.getListOrder(e),i=this.getStoredListOrder(e);let r=t;return i?r=i:Object(g.r)(s)?n&&(r=n):r=s?a.a.Importance:a.a.Natural,r}async updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),s=this.getListOrder(e),n=this.calculateTagSorting(e),i=this.calculateListOrder(e);n!==t&&await this.setAndPersistTagSorting(e,n),i!==s&&await this.setAndPersistListOrder(e,i)}}async regenerateAllLists({trigger:e=!0}){console.warn("Regenerating all room lists");const t=this.matrixClient.getVisibleRooms(),s=new Set;if(this.state.tagsEnabled)for(const e of t){if(!e.tags)continue;Object.keys(e.tags).filter(e=>Object(r.d)(e)).forEach(e=>s.add(e))}const n={},i={},o=[...r.b,...Array.from(s)];for(const e of o)n[e]=this.calculateTagSorting(e),i[e]=this.calculateListOrder(e),f.a.instance.ensureLayoutExists(e);await this.algorithm.populateTags(n,i),await this.algorithm.setKnownRooms(t),this.initialListsGenerated=!0,e&&this.updateFn.trigger()}addFilter(e){o.a.getValue("advancedRoomListLogging")&&console.log("Adding filter condition:",e),this.filterConditions.push(e),this.algorithm&&this.algorithm.addFilterCondition(e),this.updateFn.trigger()}removeFilter(e){o.a.getValue("advancedRoomListLogging")&&console.log("Removing filter condition:",e);const t=this.filterConditions.indexOf(e);t>=0&&(this.filterConditions.splice(t,1),this.algorithm&&this.algorithm.removeFilterCondition(e)),this.updateFn.trigger()}getFirstNameFilterCondition(){for(const e of this.filterConditions)if(e instanceof y.a)return e;return null}getTagsForRoom(e){const t=this.algorithm.getTagsForRoom(e);return t||[r.a.Untagged]}}i()(S,"TEST_MODE",!1);class w{static get instance(){return w.internalInstance||(w.internalInstance=new S),w.internalInstance}}i()(w,"internalInstance",void 0),window.mxRoomListStore=w.instance}).call(this,s(136).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(47),i=s(63);s(134);class o{constructor(e){this.matrixClient=e,this.roomToUser=null,this._hasSentOutPatchDirectAccountDataPatch=!1,this._onAccountData=this._onAccountData.bind(this);const t=e.getAccountData("m.direct");this.mDirectEvent=t?t.getContent():{},this.userToRooms=null}static makeShared(){return o._sharedInstance=new o(n.a.get()),o._sharedInstance}static shared(){return o._sharedInstance}start(){this._populateRoomToUser(),this.matrixClient.on("accountData",this._onAccountData)}stop(){this.matrixClient.removeListener("accountData",this._onAccountData)}_onAccountData(e){"m.direct"==e.getType()&&(this.mDirectEvent=this.matrixClient.getAccountData("m.direct").getContent()||{},this.userToRooms=null,this.roomToUser=null)}_patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),s=e[t];if(s){const n=s.map(e=>{const s=this.matrixClient.getRoom(e);if(s){const n=s.guessDMUserId();if(n&&n!==t)return{userId:n,roomId:e}}}).filter(e=>!!e);return!!n.length&&(e[t]=s.filter(e=>!n.some(t=>t.roomId===e)),n.forEach(({userId:t,roomId:s})=>{const n=e[t];n?(n.push(s),e[t]=Object(i.uniq)(n)):e[t]=[s]}),!0)}}getDMRoomsForUserId(e){return this._getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let s=1;s<e.length;s++){const n=this.getDMRoomsForUserId(e[s]);t=t.filter(e=>n.includes(e))}return t.map(e=>n.a.get().getRoom(e)).filter(e=>e&&"join"===e.getMyMembership())[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this._populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map(e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)})).filter(e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount()).reduce((e,t)=>(e[t.userId]=t.room)&&e,{}):{}}_getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(t&&t.length){const t=this._patchUpSelfDMs(e);console.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this._hasSentOutPatchDirectAccountDataPatch&&(this._hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData("m.direct",e))}this.userToRooms=e}return this.userToRooms}_populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this._getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"e",(function(){return a})),s.d(t,"f",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(44);function i(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function o(e){return(new Intl.NumberFormat).format(e)}function r(e,t=2){if(0===e)return"0 Bytes";const s=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function a(e){return e.match(/.{1,4}/g).join(" ")}function c(e){return"mx_Username_color"+(function(e){let t,s,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)s=e.charCodeAt(t),n=(n<<5)-n+s,n|=0;return Math.abs(n)}(e)%8+1)}function l(e,t){const s=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];if(s>0)return e=e.slice(0,t),Object(n.a)("%(items)s and %(count)s others",{items:e.join(", "),count:s});{const t=e.pop();return Object(n.a)("%(items)s and %(lastItem)s",{items:e.join(", "),lastItem:t})}}},function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(329);t.a=({description:e,acceptLabel:t,rejectLabel:s,onAccept:n,onReject:r})=>i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Toast_description"},e),i.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},r&&s&&i.a.createElement(o.a,{label:s,kind:"danger",onClick:r}),i.a.createElement(o.a,{label:t,onClick:n})))},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n=s(2),i=s.n(n),o=s(53),r=s(49),a=s(66),c=s.n(a),l=s(50),d=s(203),u=s(47),h=s(188),m=s.n(h),p=s(55);s(102);class g{constructor(e,t){this.apiUrl=e,this.uiUrl=t,this.scalarToken=null,this.termsInteractionCallback=void 0;const s=o.a.get().integrations_rest_url,n=o.a.get().integrations_ui_url;this.isDefaultManager=e===s&&n===t}_writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}_readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}_readToken(){return this.scalarToken?this.scalarToken:this._readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then(e=>{this.scalarToken=e})}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this._readToken();return e?this._checkToken(e).catch(e=>{if(e instanceof d.b)throw e;return this.registerForToken()}):this.registerForToken()}_getAccountName(e){const t=this.apiUrl+"/account";return new Promise((function(s,n){m()({method:"GET",uri:t,qs:{scalar_token:e,v:"1.1"},json:!0},(e,t,i)=>{e?n(e):i&&"M_TERMS_NOT_SIGNED"===i.errcode?n(new d.b):t.statusCode/100!=2?n(i):i&&i.user_id?s(i.user_id):n(new Error("Missing user_id in response"))})}))}_checkToken(e){return this._getAccountName(e).then(t=>{const s=u.a.get().getUserId();if(t!==s)throw new Error("Scalar token is owned by someone else: "+s);return e}).catch(t=>{if(t instanceof d.b){console.log("Integration manager requires new terms to be agreed to");const t=c.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(d.d)([new d.a(p.l.IM,t.format(),e)],this.termsInteractionCallback).then(()=>e)}throw t})}registerForToken(){return u.a.get().getOpenIdToken().then(e=>this.exchangeForScalarToken(e)).then(e=>this._checkToken(e)).then(e=>(this.scalarToken=e,this._writeTokenToStore(),e))}exchangeForScalarToken(e){const t=this.apiUrl;return new Promise((function(s,n){m()({method:"POST",uri:t+"/register",qs:{v:"1.1"},body:e,json:!0},(e,t,i)=>{e?n(e):t.statusCode/100!=2?n({statusCode:t.statusCode}):i&&i.scalar_token?s(i.scalar_token):n(new Error("Missing scalar_token in response"))})}))}getScalarPageTitle(e){let t=this.apiUrl+"/widgets/title_lookup";return t=this.getStarterLink(t),t+="&curl="+encodeURIComponent(e),new Promise((function(e,s){m()({method:"GET",uri:t,json:!0},(t,n,i)=>{if(t)s(t);else if(n.statusCode/100!=2)s({statusCode:n.statusCode});else if(i){let t="";i.page_title_cache_item&&i.page_title_cache_item.cached_title&&(t=i.page_title_cache_item.cached_title),e(t)}else s(new Error("Missing page title in response"))})}))}disableWidgetAssets(e,t){let s=this.apiUrl+"/widgets/set_assets_state";return s=this.getStarterLink(s),new Promise((n,i)=>{m()({method:"GET",uri:s,json:!0,qs:{widget_type:e.preferred,widget_id:t,state:"disable"}},(e,t,s)=>{e?i(e):t.statusCode/100!=2?i({statusCode:t.statusCode}):s?n():i(new Error("Failed to set widget assets state"))})})}getScalarInterfaceUrlForRoom(e,t,s){const n=e.roomId,i=e.name;let o=this.uiUrl;return o+="?scalar_token="+encodeURIComponent(this.scalarToken),o+="&room_id="+encodeURIComponent(n),o+="&room_name="+encodeURIComponent(i),o+="&theme="+encodeURIComponent(l.a.getValue("theme")),s&&(o+="&integ_id="+encodeURIComponent(s)),t&&(o+="&screen="+encodeURIComponent(t)),o}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var f=s(436);let _;!function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(_||(_={}));class v{constructor(e,t,s=t,n){i()(this,"apiUrl",void 0),i()(this,"uiUrl",void 0),i()(this,"kind",void 0),i()(this,"id",void 0),this.kind=e,this.apiUrl=t,this.uiUrl=s,this.id=n}get name(){return c.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=c.a.parse(this.apiUrl);return e.pathname="",e.path="",c.a.format(e)}getScalarClient(){return new g(this.apiUrl,this.uiUrl)}async open(e=null,t=null,s=null){if(!l.a.getValue("integrationProvisioning"))return C.sharedInstance().showDisabledDialog();const n=r.a.createTrackedDialog("Integration Manager","",f.a,{loading:!0},"mx_IntegrationManager"),i=this.getScalarClient();i.setTermsInteractionCallback((e,t)=>Object(d.c)(e,t,"mx_TermsDialog_forIntegrationManager"));const o={};try{await i.connect(),i.hasCredentials()?o.url=i.getScalarInterfaceUrlForRoom(e,t,s):o.connected=!1}catch(e){if(e instanceof d.b)return void n.close();console.error(e),o.connected=!1}n.close(),r.a.createTrackedDialog("Integration Manager","",f.a,o,"mx_IntegrationManager")}}var y=s(437),b=s(438),E=s(440),S=s(76);const w=[_.Account,_.Homeserver,_.Config];class C{static sharedInstance(){return C.instance||(C.instance=new C),C.instance}constructor(){i()(this,"managers",[]),i()(this,"client",void 0),i()(this,"primaryManager",void 0),i()(this,"setupHomeserverManagers",async e=>{if(console.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),console.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter(e=>e.kind!==_.Homeserver);for(const e of t)e.api_url&&this.managers.push(new v(_.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else console.log("Homeserver has no integration managers")}),i()(this,"onAccountData",e=>{"m.widgets"===e.getType()&&this.compileManagers()}),this.compileManagers()}startWatching(){this.stopWatching(),this.client=u.a.get(),this.client.on("accountData",this.onAccountData),this.client.on("WellKnown.client",this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener("accountData",this.onAccountData),this.client.removeListener("WellKnown.client",this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=o.a.get().integrations_rest_url,t=o.a.get().integrations_ui_url;e&&t&&(this.managers.push(new v(_.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;S.a.getIntegrationManagerWidgets().forEach(e=>{const t=e.content.data;if(!t)return;const s=e.content.url,n=t.api_url;if(!n||!s)return;const i=new v(_.Account,n,s,e.id||e.state_key||"");this.managers.push(i)}),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of w){const s=this.managers.filter(e=>e.kind===t);s&&s.length&&(t===_.Account&&s.sort((e,t)=>e.id.localeCompare(t.id)),e.push(...s))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){r.a.createTrackedDialog("Integrations impossible","",y.a)}openAll(e=null,t=null,s=null){return l.a.getValue("integrationProvisioning")?0===this.managers.length?this.openNoManagerDialog():void r.a.createTrackedDialog("Tabbed Integration Manager","",b.a,{room:e,screen:t,integrationId:s},"mx_TabbedIntegrationManagerDialog"):this.showDisabledDialog()}showDisabledDialog(){r.a.createTrackedDialog("Integrations disabled","",E.a)}async overwriteManagerOnAccount(e){await S.a.removeIntegrationManagerWidgets(),await S.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;console.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=c.a.parse(e).host);try{const s=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await s.json()}catch(e){return console.error(e),console.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return console.warn("Missing integrations widget on .well-known response"),null;const s=t["m.integrations_widget"];if(!s.url||!s.data||!s.data.api_url)return console.warn("Malformed .well-known response for integrations widget"),null;const n=new v(_.Account,s.data.api_url,s.url);return console.log("Got an integration manager (untested)"),n}}i()(C,"instance",void 0),window.mxIntegrationManagers=C},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(12);class h extends d.a.PureComponent{constructor(e){super(e),c()(this,"id",void 0),this.id="checkbox_"+Object(u.a)(10)}render(){const e=this.props,{children:t,className:n}=e,o=r()(e,["children","className"]);return d.a.createElement("span",{className:"mx_Checkbox "+n},d.a.createElement("input",i()({id:this.id},o,{type:"checkbox"})),d.a.createElement("label",{htmlFor:this.id},d.a.createElement("div",{className:"mx_Checkbox_background"},d.a.createElement("img",{src:s(600)})),d.a.createElement("div",null,this.props.children)))}}c()(h,"defaultProps",{className:""})},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"h",(function(){return p})),s.d(t,"g",(function(){return g})),s.d(t,"f",(function(){return f})),s.d(t,"e",(function(){return _})),s.d(t,"c",(function(){return v})),s.d(t,"b",(function(){return y})),s.d(t,"d",(function(){return b}));var n=s(43),i=s.n(n),o=s(47),r=s(247),a=s(49),c=s(46),l=s(44),d=s(366),u=s(443),h=s(124);function m(e,t){const s=new r.a(e);return s.invite(t).then(e=>Promise.resolve({states:e,inviter:s}))}function p(){const e=c.getComponent("dialogs.InviteDialog");a.a.createTrackedDialog("Start DM","",e,{kind:d.a},null,!1,!0)}function g(e){const t=c.getComponent("dialogs.InviteDialog");a.a.createTrackedDialog("Invite Users","",t,{kind:d.b,roomId:e},null,!1,!0)}function f(e,t){a.a.createTrackedDialog("Invite Users to Community","",u.a,{communityName:t,roomId:e},null,!1,!0)}function _(e){const t=h.a.instance.getGeneralChat(e);if(!t)throw new Error("Failed to locate appropriate room to start an invite in");{const s=h.a.instance.getCommunityName(e);f(t.roomId,s)}}function v(e){if(!e||"m.room.third_party_invite"!==e.getType())return!1;const t=["key_validity_url","public_key","display_name"];for(let s=0;s<t.length;++s)if(!e.getContent()[t[s]])return!1;return!0}function y(e,t){return m(e,t).then(t=>{const s=o.a.get().getRoom(e);b(t.states,s,t.inviter)}).catch(e=>{console.error(e.stack);const t=c.getComponent("dialogs.ErrorDialog");a.a.createTrackedDialog("Failed to invite","",t,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}function b(e,t,s){const n=Object.keys(e).filter(t=>"error"===e[t]);if(1===n.length&&s.fatal){const e=c.getComponent("dialogs.ErrorDialog");return a.a.createTrackedDialog("Failed to invite users to the room","",e,{title:Object(l.a)("Failed to invite users to the room:",{roomName:t.name}),description:s.getErrorText(n[0])}),!1}{const o=[];for(const t of n)if("error"===e[t]){const e=s.getErrorText(t);o.push(t+": "+e)}if(o.length>0){const e=i.a.createElement("div",null,o.map(e=>i.a.createElement("div",{key:e},e))),s=c.getComponent("dialogs.ErrorDialog");return a.a.createTrackedDialog("Failed to invite the following users to the room","",s,{title:Object(l.a)("Failed to invite the following users to the %(roomName)s room:",{roomName:t.name}),description:e}),!1}}return!0}},function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"d",(function(){return f})),s.d(t,"a",(function(){return _})),s.d(t,"c",(function(){return v})),s.d(t,"e",(function(){return y}));var n,i,o=s(47),r=s(49),a=s(46),c=s(44),l=s(48),d=s(248),u=s(90),h=s(172),m=s(206),p=s(67);function g(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=a.getComponent("dialogs.ErrorDialog"),s=a.getComponent("elements.Spinner"),u=o.a.get();if(u.isGuest())return l.a.dispatch({action:"require_registration"}),Promise.resolve(null);const m=e.dmUserId?i.TrustedPrivateChat:i.PrivateChat,g=e.createOpts||{};if(g.preset=g.preset||m,g.visibility=g.visibility||n.Private,e.dmUserId&&void 0===g.invite)switch(Object(h.c)(e.dmUserId)){case"mx-user-id":g.invite=[e.dmUserId];break;case"email":g.invite_3pid=[{id_server:o.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}let f,_;return e.dmUserId&&void 0===g.is_direct&&(g.is_direct=!0),void 0===e.andView&&(e.andView=!0),g.initial_state=g.initial_state||[],e.guestAccess&&g.initial_state.push({type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}}),e.encryption&&g.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.spinner&&(f=r.a.createDialog(s,null,"mx_Dialog_spinner")),u.createRoom(g).finally((function(){f&&f.close()})).then((function(t){return _=t.room_id,e.dmUserId?d.c(_,e.dmUserId):Promise.resolve()})).then(()=>{if(e.associatedWithCommunity)return p.a.addRoomToGroup(e.associatedWithCommunity,_,!1)}).then((function(){return e.andView&&l.a.dispatch({action:"view_room",room_id:_,should_peek:!1,joining:!0}),_}),(function(s){if(e.inlineErrors)throw s;l.a.dispatch({action:"join_room_error"}),console.error("Failed to create room "+_+" "+s);let n=Object(c.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===s.errcode&&(n=Object(c.a)("The server does not support the room version specified.")),r.a.createTrackedDialog("Failure to create room","",t,{title:Object(c.a)("Failure to create room"),description:n}),null}))}function f(e,t){const s=u.a.shared().getDMRoomsForUserId(t).map(t=>e.getRoom(t)).filter(e=>{if(e&&"join"===e.getMyMembership()){const s=e.getMember(t);return s&&("invite"===s.membership||"join"===s.membership)}return!1}).sort((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp());if(s.length)return s[0]}async function _(e,t){const s=await e.downloadKeys(t);return Object.values(s).every(e=>Object.keys(e).length>0)}async function v(e,t){const s=f(e,t);let n;if(s)n=s.roomId;else{let s;y()&&(s=_(e,[t])),n=await g({encryption:s,dmUserId:t,spinner:!1,andView:!1}),await async function(e,t,s,n={timeout:1500}){const{timeout:i}=n;let o;return new Promise(n=>{o=function(e,i,o){o.userId===s&&o.roomId===t&&n(!0)},e.on("RoomState.newMember",o),setTimeout(n,i,!1)}).finally(()=>{e.removeListener("RoomState.newMember",o)})}(e,n,t)}return n}function y(){const e=Object(m.a)();if(e){return!(!1===e.default)}return!0}!function(e){e.Public="public",e.Private="private"}(n||(n={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(i||(i={}))},function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(45),r=s.n(o),a=s(44),c=s(50);const l=({w:e=32,h:t=32,imgClassName:n,message:o})=>{let r;return r=c.a.getValue("feature_new_spinner")?s(468):s(469),i.a.createElement("div",{className:"mx_Spinner"},o&&i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_Spinner_Msg"},o)," "),i.a.createElement("img",{src:r,width:e,height:t,className:n,"aria-label":Object(a.a)("Loading...")}))};l.propTypes={w:r.a.number,h:r.a.number,imgClassName:r.a.string,message:r.a.node},t.a=l},,function(e,t,s){"use strict";(function(e,n){var i=s(47),o=s(62),r=s(49),a=s(46),c=s(44),l=s(55),d=s(48),u=s(76),h=s(171),m=s(50),p=s(749),g=s(316),f=s(102),_=s(57),v=s(753);e.mxCalls={};const y=e.mxCalls;let b=null;const E={};function S(e){const t=document.getElementById(e);if(t){const s=async()=>{try{await t.play()}catch(e){console.log("Unable to play audio clip",e)}};E[e]?E[e]=E[e].then(()=>(t.load(),s())):E[e]=s()}}function w(e){const t=document.getElementById(e);t&&(E[e]?E[e]=E[e].then(()=>t.pause()):E[e]=t.pause())}function C(e){e.on("error",(function(e){if(console.error("Call error:",e),0===i.a.get().getTurnServers().length&&null===m.a.getValue("fallbackICEServerAllowed"))return void function(){const e=i.a.get(),t=a.getComponent("dialogs.QuestionDialog"),s=e=>React.createElement("code",null,e);r.a.createTrackedDialog("No TURN servers","",t,{title:Object(c.a)("Call failed due to misconfigured server"),description:React.createElement("div",null,React.createElement("p",null,Object(c.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:s})),React.createElement("p",null,Object(c.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",null,{code:s}))),button:Object(c.a)("Try using turn.matrix.org"),cancelButton:Object(c.a)("OK"),onFinished:t=>{m.a.setValue("fallbackICEServerAllowed",null,_.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},null,!0)}();const t=a.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Call Failed","",t,{title:Object(c.a)("Call Failed"),description:e.message})})),e.on("hangup",(function(){R(void 0,e.roomId,"ended")})),e.on("state",(function(t,s){if("ringing"===t)R(e,e.roomId,"ringing"),w("ringbackAudio");else if("invite_sent"===t)R(e,e.roomId,"ringback"),S("ringbackAudio");else if("ended"===t&&"connected"===s)R(void 0,e.roomId,"ended"),w("ringbackAudio"),S("callendAudio");else if("ended"===t&&"invite_sent"===s&&("remote"===e.hangupParty||"local"===e.hangupParty&&"invite_timeout"===e.hangupReason)){R(e,e.roomId,"busy"),w("ringbackAudio"),S("busyAudio");const t=a.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Call Handler","Call Timeout",t,{title:Object(c.a)("Call Timeout"),description:Object(c.a)("The remote side failed to pick up")+"."})}else"invite_sent"===s?(R(e,e.roomId,"stop_ringback"),w("ringbackAudio")):"ringing"===s?(R(e,e.roomId,"stop_ringing"),w("ringbackAudio")):"connected"===t&&(R(e,e.roomId,"connected"),w("ringbackAudio"))}))}function R(e,t,s){console.log(`Call state in ${t} changed to ${s} (${e?e.call_state:"-"})`),y[t]=e,"ringing"===s?S("ringAudio"):e&&"ringing"===e.call_state&&w("ringAudio"),e&&(e.call_state=s),d.a.dispatch({action:"call_state",room_id:t,state:s})}e.mxCallHandler||(d.a.register((function(e){switch(e.action){case"place_call":{if(k.getAnyActiveCall()){const e=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Call Handler","Existing Call",e,{title:Object(c.a)("Existing Call"),description:Object(c.a)("You are already in a call.")})}if(!i.a.get().supportsVoip()){const e=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Call Handler","VoIP is unsupported",e,{title:Object(c.a)("VoIP is unsupported"),description:Object(c.a)("You cannot place VoIP calls in this browser.")})}const t=i.a.get().getRoom(e.room_id);if(!t)return void console.error("Room %s does not exist.",e.room_id);const s=t.getJoinedMembers();if(s.length<=1){const e=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Call Handler","Cannot place call with self",e,{description:Object(c.a)("You cannot place a call with yourself.")})}if(2===s.length){console.info("Place %s call in %s",e.type,e.room_id);!function(t){if(C(t),"voice"===e.type)t.placeVoiceCall();else if("video"===e.type)t.placeVideoCall(e.remote_element,e.local_element);else if("screensharing"===e.type){const s=o.a.get().screenCaptureErrorString();if(s){R(void 0,t.roomId,"ended"),console.log("Can't capture screen: "+s);const e=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Call Handler","Unable to capture screen",e,{title:Object(c.a)("Unable to capture screen"),description:s})}t.placeScreenSharingCall(e.remote_element,e.local_element)}else console.error("Unknown conf call type: %s",e.type)}(l.r.createNewMatrixCall(i.a.get(),e.room_id))}else d.a.dispatch({action:"place_conference_call",room_id:e.room_id,type:e.type,remote_element:e.remote_element,local_element:e.local_element})}break;case"place_conference_call":console.info("Place conference call in %s",e.room_id),async function(e,t){d.a.dispatch({action:"appsDrawer",show:!0});const s=i.a.get().getRoom(e),o=u.a.getRoomWidgetsOfType(s,f.a.JITSI);if(h.a.roomHasPendingWidgetsOfType(e,o,f.a.JITSI)){const e=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Call already in progress","",e,{title:Object(c.a)("Call in Progress"),description:Object(c.a)("A call is currently being placed!")})}if(o.length>0){console.warn("Refusing to start conference call widget in "+e+" a conference call widget is already present");const t=a.getComponent("dialogs.ErrorDialog");return void r.a.createTrackedDialog("Already have Jitsi Widget","",t,{title:Object(c.a)("Call in Progress"),description:Object(c.a)("A call is already in progress!")})}const l=g.a.getInstance().preferredDomain,m=await g.a.getInstance().getJitsiAuth();let _;_="openidtoken-jwt"===m?v.base32.stringify(n.from(e),{pad:!1}):"JitsiConference"+Object(p.a)();let y=u.a.getLocalJitsiWrapperUrl({auth:m});const b=new URL(y);b.search="",b.searchParams.set("confId",_),y=b.toString();const E={conferenceId:_,isAudioOnly:"voice"===t,domain:l,auth:m},S="jitsi_"+i.a.get().credentials.userId+"_"+Date.now();u.a.setRoomWidget(e,S,f.a.JITSI,y,"Jitsi",E).then(()=>{console.log("Jitsi widget added")}).catch(e=>{if("M_FORBIDDEN"===e.errcode){const e=a.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Call Failed","",e,{title:Object(c.a)("Permission Required"),description:Object(c.a)("You do not have permission to start a conference call in this room")})}console.error(e)})}(e.room_id,e.type);break;case"incoming_call":{if(k.getAnyActiveCall())return;if(!i.a.get().supportsVoip())return;const t=e.call;C(t),R(t,t.roomId,"ringing")}break;case"hangup":if(!y[e.room_id])return;y[e.room_id].hangup(),R(null,e.room_id,"ended");break;case"answer":if(!y[e.room_id])return;y[e.room_id].answer(),R(y[e.room_id],e.room_id,"connected"),d.a.dispatch({action:"view_room",room_id:e.room_id})}})),navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))));const k={getCallForRoom:function(e){let t=k.getCall(e);return t||(b&&(t=b.getConferenceCallForRoom(e)),t||null)},getCall:function(e){return y[e]||null},getAnyActiveCall:function(){const e=Object.keys(y);for(let t=0;t<e.length;t++)if(y[e[t]]&&"ended"!==y[e[t]].call_state)return y[e[t]];return null},setConferenceHandler:function(e){b=e},getConferenceHandler:function(){return b}};void 0===e.mxCallHandler&&(e.mxCallHandler=k),t.a=e.mxCallHandler}).call(this,s(6),s(22).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(2),i=s.n(n);class o{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(o).filter(e=>e instanceof o).find(t=>t.matches(e));return t||new o(e,e)}}i()(o,"JITSI",new o("m.jitsi","jitsi")),i()(o,"STICKERPICKER",new o("m.stickerpicker","m.stickerpicker")),i()(o,"INTEGRATION_MANAGER",new o("m.integration_manager","m.integration_manager")),i()(o,"CUSTOM",new o("m.custom","m.custom"))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(2),i=s.n(n),o=s(86),r=s(47);class a extends o.a{constructor(e,t={}){super(e,t),i()(this,"matrixClient",void 0),r.a.get()&&(this.matrixClient=r.a.get(),this.onReady())}async onReady(){}async onNotReady(){}async onDispatch(e){if(await this.onAction(e),"MatrixActions.sync"===e.action){if("PREPARED"!==e.prevState||"PREPARED"===e.state)return;this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady())}else"on_client_not_viable"!==e.action&&"on_logged_out"!==e.action||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}}},,function(e,t,s){"use strict";s.d(t,"d",(function(){return p})),s.d(t,"a",(function(){return g})),s.d(t,"c",(function(){return _})),s.d(t,"e",(function(){return v})),s.d(t,"b",(function(){return y}));var n=s(49),i=s(46),o=s(47),r=s(277),a=s(278),c=s(44),l=s(85),d=s(206);let u={},h=!1;function m(){return h}function p(){return h}class g extends Error{constructor(){super("Secret storage access canceled")}}function f(e,t){m()&&(u[e]=t)}const _={getSecretStorageKey:async function({keys:e},t){const s=Object.entries(e);if(s.length>1)throw new Error("Multiple storage key requests not implemented");const[l,d]=s[0];if(m()&&u[l])return[l,u[l]];const h=async({passphrase:e,recoveryKey:t})=>e?Object(r.a)(e,d.passphrase.salt,d.passphrase.iterations):Object(a.a)(t),p=i.getComponent("dialogs.secretstorage.AccessSecretStorageDialog"),{finished:_}=n.a.createTrackedDialog("Access Secret Storage dialog","",p,{keyInfo:d,checkPrivateKey:async e=>{const t=await h(e);return await o.a.get().checkSecretStorageKey(t,d)}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||async function(){const e=i.getComponent("dialogs.QuestionDialog"),[t]=await n.a.createDialog(e,{title:Object(c.a)("Cancel entering passphrase?"),description:Object(c.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(c.a)("Go Back"),cancelButton:Object(c.a)("Cancel")}).finished;return!t}()}),[v]=await _;if(!v)throw new g;const y=await h(v);return f(l,y),[l,y]},cacheSecretStorageKey:f,onSecretRequested:async function({user_id:e,device_id:t,request_id:s,name:n,device_trust:i}){console.log("onSecretRequested",e,t,s,n,i);const r=o.a.get();if(e===r.getUserId())if(i&&i.isVerified()){if("m.cross_signing.master"===n||"m.cross_signing.self_signing"===n||"m.cross_signing.user_signing"===n){const e=r.getCrossSigningCacheCallbacks();if(!e.getCrossSigningKeyCache)return;const s=n.replace("m.cross_signing.",""),i=await e.getCrossSigningKeyCache(s);return i||console.log(`${s} requested by ${t}, but not found in cache`),i&&Object(l.encodeBase64)(i)}if("m.megolm_backup.v1"===n){const e=await r._crypto.getSessionBackupPrivateKey();return e||console.log(`session backup key requested by ${t}, but not found in cache`),e&&Object(l.encodeBase64)(e)}console.warn("onSecretRequested didn't recognise the secret named ",n)}else console.log("Ignoring secret request from untrusted device "+t)}};async function v(){let e;const t=i.getComponent("dialogs.keybackup.RestoreKeyBackupDialog"),{finished:s}=n.a.createTrackedDialog("Restore Backup","",t,{showSummary:!1,keyCallback:t=>e=t},null,!1,!0);if(!await s)throw new Error("Key backup prompt cancelled");return e}async function y(e=(async()=>{}),t=!1){const r=o.a.get();h=!0;try{if(!await r.hasSecretStorageKey()||t){const{finished:e}=n.a.createTrackedDialogAsync("Create Secret Storage dialog","",s.e(2).then(s.bind(null,1145)),{forceReset:t},null,!1,!0,{onBeforeClose:e=>"backgroundClick"!==e||!Object(d.b)()}),[i]=await e;if(!i)throw new Error("Secret storage creation canceled")}else{const e=i.getComponent("dialogs.InteractiveAuthDialog");await r.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:s}=n.a.createTrackedDialog("Cross-signing keys dialog","",e,{title:Object(c.a)("Setting up keys"),matrixClient:o.a.get(),makeRequest:t}),[i]=await s;if(!i)throw new Error("Cross-signing key upload auth canceled")}}),await r.bootstrapSecretStorage({getKeyBackupPassphrase:v})}return await e()}finally{h=!1,m()||(u={})}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(268);function i(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new n.a(this._roomId),this._startState.paginationToken=null,this._endState=new n.a(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}i.BACKWARDS="b",i.FORWARDS="f",i.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this._startState.setStateEvents(e),this._endState.setStateEvents(e)},i.prototype.forkLive=function(e){const t=this.getState(e),s=new i(this._eventTimelineSet);return s._startState=t.clone(),s._endState=t,this._endState=t.clone(),s},i.prototype.fork=function(e){const t=this.getState(e),s=new i(this._eventTimelineSet);return s._startState=t.clone(),s._endState=t.clone(),s},i.prototype.getRoomId=function(){return this._roomId},i.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},i.prototype.getTimelineSet=function(){return this._eventTimelineSet},i.prototype.getBaseIndex=function(){return this._baseIndex},i.prototype.getEvents=function(){return this._events},i.prototype.getState=function(e){if(e==i.BACKWARDS)return this._startState;if(e==i.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},i.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},i.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},i.prototype.getNeighbouringTimeline=function(e){if(e==i.BACKWARDS)return this._prevTimeline;if(e==i.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},i.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==i.BACKWARDS)this._prevTimeline=e;else{if(t!=i.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},i.prototype.addEvent=function(e,t){const s=t?this._startState:this._endState,n=this.getTimelineSet();let o;n.room&&n.room.getUnfilteredTimelineSet()===n&&(i.setEventMetadata(e,s,t),e.isState()&&(s.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||i.setEventMetadata(e,s,t))),o=t?0:this._events.length,this._events.splice(o,0,e),t&&this._baseIndex++},i.setEventMetadata=function(e,t,s){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&s&&(e.forwardLooking=!1)},i.prototype.removeEvent=function(e){for(let t=this._events.length-1;t>=0;t--){const s=this._events[t];if(s.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,s}return null},i.prototype.toString=function(){return this._name}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(0),i=s(372),o=s(190),r=s(578),a=s(158),c=s(14);class l{constructor(e,t){this._indexedDB=e,this._dbName=t,this._backendPromise=null,this._backend=null}static exists(e,t){return c.a(e,t)}startup(){return this._backendPromise||(this._backendPromise=new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));n.a.log("connecting to indexeddb "+this._dbName);const s=this._indexedDB.open(this._dbName,r.b);s.onupgradeneeded=e=>{const t=e.target.result,s=e.oldVersion;r.c(t,s)},s.onblocked=()=>{n.a.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.a.log("Error connecting to indexeddb",e),t(e.target.error)},s.onsuccess=t=>{const s=t.target.result;n.a.log("connected to indexeddb "+this._dbName),e(new r.a(s))}}).then(e=>e.doTxn("readonly",[l.STORE_INBOUND_GROUP_SESSIONS,l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw n.a.warn("Crypto DB is too new for us to use!",t),new a.a(a.a.TOO_NEW);n.a.warn("unable to connect to indexeddb "+this._dbName+": falling back to localStorage store: "+t);try{return new i.a(e.localStorage)}catch(t){return n.a.warn("unable to open localStorage: falling back to in-memory store: "+t),new o.a}}).then(e=>{this._backend=e})),this._backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));n.a.log("Removing indexeddb instance: "+this._dbName);const s=this._indexedDB.deleteDatabase(this._dbName);s.onblocked=()=>{n.a.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.a.log("Error deleting data from indexeddb",e),t(e.target.error)},s.onsuccess=()=>{n.a.log("Removed indexeddb instance: "+this._dbName),e()}}).catch(e=>{n.a.warn("unable to delete IndexedDBCryptoStore: "+e)})}getOrAddOutgoingRoomKeyRequest(e){return this._backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this._backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this._backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this._backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,s){return this._backend.getOutgoingRoomKeyRequestsByTarget(e,t,s)}updateOutgoingRoomKeyRequest(e,t,s){return this._backend.updateOutgoingRoomKeyRequest(e,t,s)}deleteOutgoingRoomKeyRequest(e,t){return this._backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this._backend.getAccount(e,t)}storeAccount(e,t){this._backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this._backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,s){this._backend.getSecretStorePrivateKey(e,t,s)}storeCrossSigningKeys(e,t){this._backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,s){this._backend.storeSecretStorePrivateKey(e,t,s)}countEndToEndSessions(e,t){this._backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,s,n){this._backend.getEndToEndSession(e,t,s,n)}getEndToEndSessions(e,t,s){this._backend.getEndToEndSessions(e,t,s)}getAllEndToEndSessions(e,t){this._backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,s,n){this._backend.storeEndToEndSession(e,t,s,n)}storeEndToEndSessionProblem(e,t,s){return this._backend.storeEndToEndSessionProblem(e,t,s)}getEndToEndSessionProblem(e,t){return this._backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this._backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,s,n){this._backend.getEndToEndInboundGroupSession(e,t,s,n)}getAllEndToEndInboundGroupSessions(e,t){this._backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,s,n){this._backend.addEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){this._backend.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){this._backend.storeEndToEndInboundGroupSessionWithheld(e,t,s,n)}storeEndToEndDeviceData(e,t){this._backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this._backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,s){this._backend.storeEndToEndRoom(e,t,s)}getEndToEndRooms(e,t){this._backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this._backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this._backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this._backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this._backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,s){return this._backend.doTxn(e,t,s)}}l.STORE_ACCOUNT="account",l.STORE_SESSIONS="sessions",l.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",l.STORE_DEVICE_DATA="device_data",l.STORE_ROOMS="rooms",l.STORE_BACKUP="sessions_needing_backup"}).call(this,s(6))},,function(e,t,s){"use strict";(function(e){var n=s(196),i=s(48),o=s(67),r=s(72),a=s(234),c=s(47),l=s(50);const d={orderedTags:null,orderedTagsAccountData:null,hasSynced:!1,joinedGroupIds:null,selectedTags:[],anchorTag:null};class u extends n.Store{constructor(){super(i.a),this._state=Object.assign({},d),l.a.monitorSetting("TagPanel.enableTagPanel",null)}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":{const t=o.a.getGroupIdsForRoomId(e.room_id);this._updateBadges(t);break}case"MatrixActions.sync":{if("SYNCING"!==e.state&&"PREPARED"!==e.state||this._updateBadges(),"PREPARED"===e.prevState||"PREPARED"!==e.state)break;const t=e.matrixClient.getAccountData("im.vector.web.tag_ordering"),s=t?t.getContent():{};this._setState({orderedTagsAccountData:s.tags||null,removedTagsAccountData:s.removedTags||null,hasSynced:!0}),this._updateOrderedTags();break}case"MatrixActions.accountData":if("im.vector.web.tag_ordering"!==e.event_type)break;if(e.event_content._storeId===this.getStoreId())break;this._setState({orderedTagsAccountData:e.event_content?e.event_content.tags:null,removedTagsAccountData:e.event_content?e.event_content.removedTags:null}),this._updateOrderedTags();break;case"GroupActions.fetchJoinedGroups.success":this._setState({joinedGroupIds:e.result.groups.sort(),hasFetchedJoinedGroups:!0}),this._updateOrderedTags();break;case"TagOrderActions.moveTag.pending":this._setState({orderedTags:e.request.tags,removedTagsAccountData:e.request.removedTags});break;case"TagOrderActions.removeTag.pending":this._setState({removedTagsAccountData:e.request.removedTags}),this._updateOrderedTags();break;case"select_tag":{const t=!l.a.getValue("feature_communities_v2_prototypes");let s=[];if(e.shiftKey&&t){let t=this._state.orderedTags.indexOf(this._state.anchorTag),n=this._state.orderedTags.indexOf(e.tag);if(-1===t&&(t=n),t>n){const e=t;t=n,n=e}s=e.ctrlOrCmdKey?this._state.selectedTags:[],s=[...new Set(this._state.orderedTags.slice(t,n+1).concat(s))]}else s=e.ctrlOrCmdKey&&t?this._state.selectedTags.includes(e.tag)?this._state.selectedTags.filter(t=>t!==e.tag):[...this._state.selectedTags,e.tag]:1===this._state.selectedTags.length&&this._state.selectedTags.includes(e.tag)?[]:[e.tag],this._state.selectedTags.includes(e.tag)||this._setState({anchorTag:e.tag});this._setState({selectedTags:s}),r.a.trackEvent("FilterStore","select_tag")}break;case"deselect_tags":e.tag?this._setState({selectedTags:this._state.selectedTags.filter(t=>t!==e.tag)}):this._setState({selectedTags:[]}),r.a.trackEvent("FilterStore","deselect_tags");break;case"on_client_not_viable":case"on_logged_out":this._state=Object.assign({},d);break;case"setting_updated":"TagPanel.enableTagPanel"!==e.settingName||e.newValue||(this._setState({selectedTags:[]}),r.a.trackEvent("FilterStore","disable_tags"))}}_updateBadges(e=this._state.joinedGroupIds){if(e&&e.length){const t=c.a.get(),s={};e.forEach(e=>{const n=o.a.getGroupRooms(e).map(e=>t.getRoom(e.roomId)).filter(e=>null!=e),i=n&&a.e(n);s[e]=i&&0!==i.count?i:void 0});const n=Object.assign({},this._state.badges,s);this._setState({badges:n})}}_updateOrderedTags(){this._setState({orderedTags:this._state.hasSynced&&this._state.hasFetchedJoinedGroups?this._mergeGroupsAndTags():null})}_mergeGroupsAndTags(){const e=this._state.joinedGroupIds||[],t=this._state.orderedTagsAccountData||[],s=new Set(this._state.removedTagsAccountData||[]),n=t.filter(t=>("+"!==t[0]||e.includes(t))&&!s.has(t)),i=e.filter(e=>!t.includes(e)&&!s.has(e));return n.concat(i)}getGroupBadge(e){const t=this._state.badges;return t&&t[e]}getOrderedTags(){return this._state.orderedTags}getRemovedTagsAccountData(){return this._state.removedTagsAccountData}getStoreId(){return this._id||(this._id=Math.random().toString(16).slice(2,10)),this._id}getSelectedTags(){return this._state.selectedTags}}void 0===e.singletonTagOrderStore&&(e.singletonTagOrderStore=new u),t.a=e.singletonTagOrderStore}).call(this,s(6))},,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(55),i=s(47),o=s(49),r=s(46),a=s(44),c=s(203),l=s(205),d=s(173);class u extends Error{}class h{constructor(e=null){this.accessToken=null,this.authEnabled=!0,this.tempClient=e?Object(n.p)({baseUrl:"",idBaseUrl:e}):null}get _matrixClient(){return this.tempClient?this.tempClient:i.a.get()}_writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}_readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return null!=this.accessToken}async getAccessToken({check:e=!0}={}){if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this._readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this._writeToken()),t;if(e)try{await this._checkToken(t)}catch(e){if(e instanceof c.b||e instanceof u)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this._writeToken())}return t}async _checkToken(e){const t=this._matrixClient.getIdentityServerUrl();try{await this._matrixClient.getIdentityAccount(e)}catch(s){if("M_TERMS_NOT_SIGNED"===s.errcode)return console.log("Identity Server requires new terms to be agreed to"),void await Object(c.d)([new c.a(n.l.IS,t,e)]);throw s}if(!this.tempClient&&!Object(l.a)()&&!await Object(l.b)(t)){const e=r.getComponent("dialogs.QuestionDialog"),{finished:s}=o.a.createTrackedDialog("Default identity server terms warning","",e,{title:Object(a.a)("Identity server has no terms of service"),description:React.createElement("div",null,React.createElement("p",null,Object(a.a)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:()=>React.createElement("b",null,Object(d.a)(t))})),React.createElement("p",null,Object(a.a)("Only continue if you trust the owner of the server."))),button:Object(a.a)("Trust")}),[n]=await s;if(!n)throw new u("User aborted identity server action without terms");Object(l.d)()}}async registerForToken(e=!0){const t=await i.a.get().getOpenIdToken(),{access_token:s,token:n}=await this._matrixClient.registerWithIdentityServer(t),o=n||s;return e&&await this._checkToken(o),o}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(103),r=s(48),a=s(139),c=s(50),l=s(1),d=s(86),u=s(88),h=s(110),m=s(47),p=s(67);class g extends o.a{constructor(){super(r.a,{})}static get instance(){return g.internalInstance}getSelectedCommunityId(){return c.a.getValue("feature_communities_v2_prototypes")?h.a.getSelectedTags()[0]:null}getSelectedCommunityName(){return g.instance.getCommunityName(this.getSelectedCommunityId())}getSelectedCommunityGeneralChat(){const e=this.getSelectedCommunityId();if(e)return this.getGeneralChat(e)}getCommunityName(e){const t=u.a.getGroupProfileCachedFast(this.matrixClient,e);return(null==t?void 0:t.name)||e}getCommunityProfile(e){return u.a.getGroupProfileCachedFast(this.matrixClient,e)}getGeneralChat(e){const t=p.a.getGroupRooms(e).map(e=>m.a.get().getRoom(e.roomId)).filter(e=>!!e);let s=t.find(t=>{const s=t.currentState.getStateEvents("im.vector.general_chat","");return!(!s||s.getContent().groupId!==e)});return s||(s=t[0]),s}async onAction(e){if(this.matrixClient&&c.a.getValue("feature_communities_v2_prototypes"))if("MatrixActions.Room.myMembership"===e.action){const t=e.room,s=Object(a.b)(e.membership);if(s===Object(a.b)(e.oldMembership))return;if(s===a.a.Invite)try{const e=l.f("/rooms/$roomId/group_info",{$roomId:t.roomId}),s=await this.matrixClient._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:"/_matrix/client/unstable/im.vector.custom"});await this.matrixClient.setAccountData("im.vector.group_info."+t.roomId,s)}catch(e){console.warn("Non-fatal error getting group information for invite:",e)}}else if("MatrixActions.accountData"===e.action)e.event_type.startsWith("im.vector.group_info.")&&this.emit(d.b,e.event_type.substring("im.vector.group_info.".length));else if("select_tag"===e.action){const t=this.getGeneralChat(e.tag);t&&r.a.dispatch({action:"view_room",room_id:t.roomId})}}getInviteProfile(e){if(!this.matrixClient)return{displayName:null,avatarMxc:null};const t=this.matrixClient.getRoom(e);if(c.a.getValue("feature_communities_v2_prototypes")){const t=this.matrixClient.getAccountData("im.vector.group_info."+e);if(t&&t.getContent())return{displayName:t.getContent().name,avatarMxc:t.getContent().avatar_url}}return{displayName:t.name,avatarMxc:t.avatar_url}}async onReady(){for(const e of this.matrixClient.getRooms()){const t=e.currentState.getMembers().find(e=>e.userId===this.matrixClient.getUserId());t&&(Object(a.b)(t.membership)===a.a.Invite&&this.emit(d.b,e.roomId))}}}i()(g,"internalInstance",new g)},,,function(e,t,s){"use strict";var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(51),d=s.n(l),u=s(209),h=s(50),m=s(52),p=s(59),g=s(145),f=s(251);const _=(e,t)=>{let s=[];return h.a.getValue("lowBandwidth")||(s=t||[],e&&s.unshift(e)),Array.from(new Set(s))};t.a=e=>{const{name:t,idName:s,title:n,url:o,urls:l,width:h=40,height:v=40,resizeMethod:y="crop",defaultToInitialLetter:b=!0,onClick:E,inputRef:S,className:w}=e,C=r()(e,["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"]),[R,k]=(({url:e,urls:t})=>{const[s,n]=Object(a.useState)(_(e,t)),[i,o]=Object(a.useState)(0),r=Object(a.useCallback)(()=>{o(e=>e+1)},[]);Object(a.useEffect)(()=>{n(_(e,t)),o(0)},[e,JSON.stringify(t)]);const c=Object(a.useContext)(p.a),l=Object(a.useCallback)((e,t)=>{"ERROR"!==e&&t!==e&&o(0)},[]);Object(g.a)(c,"sync",l);return[s[i],r]})({url:o,urls:l});if(!R&&b){const e=u.e(t),o=c.a.createElement("span",{className:"mx_BaseAvatar_initial","aria-hidden":"true",style:{fontSize:Object(f.a)(.65*h),width:Object(f.a)(h),lineHeight:Object(f.a)(v)}},e),r=c.a.createElement("img",{className:"mx_BaseAvatar_image",src:u.d(s||t),alt:"",title:n,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(v)},"aria-hidden":"true"});return E?c.a.createElement(m.a,i()({},C,{element:"span",className:d()("mx_BaseAvatar",w),onClick:E,inputRef:S}),o,r):c.a.createElement("span",i()({className:d()("mx_BaseAvatar",w),ref:S},C,{role:"presentation"}),o,r)}return E?c.a.createElement(m.a,i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",w),element:"img",src:R,onClick:E,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(v)},title:n,alt:"",inputRef:S},C)):c.a.createElement("img",i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",w),src:R,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(v)},title:n,alt:"",ref:S},C))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{getValueOverride(e,t,s,n){return null}onChange(e,t,s){}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(258);class d extends r.a.Component{render(){let e=r.a.createElement("span",{className:"mx_SettingsFlag_label"},this.props.label),t=r.a.createElement(l.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,"aria-label":this.props.label});if(this.props.toggleInFront){const s=e;e=t,t=s}const s="mx_SettingsFlag "+(this.props.className||"");return r.a.createElement("div",{className:s},e,t)}}i()(d,"propTypes",{value:c.a.bool.isRequired,onChange:c.a.func.isRequired,label:c.a.string.isRequired,disabled:c.a.bool,toggleInFront:c.a.bool,className:c.a.string})},,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(2),i=s.n(n),o=s(103),r=s(48),a=s(71),c=s(174),l=s(3),d=s(175);class u extends d.b{constructor(e=!1,t,s){super(),this.byTileCount=e,this.tagId=t,this.getRoomFn=s,i()(this,"rooms",[]),i()(this,"states",{}),i()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,s=Object(l.b)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(d.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(d.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(d.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=c.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=c.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var h=s(47),m=s(139),p=s(432),g=s(234),f=s(434);class _ extends d.b{constructor(e){super(),this.room=e,i()(this,"handleReadReceipt",(e,t)=>{Object(p.a)(e,h.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleMembershipUpdate",()=>{this.updateNotificationState()}),i()(this,"handleRoomEventUpdate",e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleAccountDataUpdate",e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()}),this.room.on("Room.receipt",this.handleReadReceipt),this.room.on("Room.timeline",this.handleRoomEventUpdate),this.room.on("Room.redaction",this.handleRoomEventUpdate),this.room.on("Room.myMembership",this.handleMembershipUpdate),h.a.get().on("Event.decrypted",this.handleRoomEventUpdate),h.a.get().on("accountData",this.handleAccountDataUpdate),this.updateNotificationState()}get roomIsInvite(){return Object(m.b)(this.room.getMyMembership())===m.a.Invite}destroy(){super.destroy(),this.room.removeListener("Room.receipt",this.handleReadReceipt),this.room.removeListener("Room.timeline",this.handleRoomEventUpdate),this.room.removeListener("Room.redaction",this.handleRoomEventUpdate),this.room.removeListener("Room.myMembership",this.handleMembershipUpdate),h.a.get()&&(h.a.get().removeListener("Event.decrypted",this.handleRoomEventUpdate),h.a.get().removeListener("accountData",this.handleAccountDataUpdate))}updateNotificationState(){const e=this.snapshot();if(g.f(this.room.roomId)===g.d)this._color=c.a.None,this._symbol=null,this._count=0;else if(this.roomIsInvite)this._color=c.a.Red,this._symbol="!",this._count=1;else{const e=g.g(this.room,"highlight"),t=g.g(this.room,"total"),s=t||(e||0);if(e>0)this._color=c.a.Red,this._count=s,this._symbol=null;else if(t>0)this._color=c.a.Grey,this._count=s,this._symbol=null;else{const e=f.a(this.room);this._color=e?c.a.Bold:c.a.None,this._count=0,this._symbol=null}}this.emitIfUpdated(e)}}class v extends d.b{constructor(){super(),i()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=c.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e,t=!1){e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}class y extends o.a{constructor(){super(r.a,{}),i()(this,"roomMap",new Map),i()(this,"listMap",new Map)}get globalState(){if(!this.matrixClient)return new v;const e=new v;for(const t of this.matrixClient.getVisibleRooms())e.add(this.getRoomState(t));return e}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===a.a.Invite,s=new u(t,e,e=>this.getRoomState(e));return this.listMap.set(e,s),s}getRoomState(e){return this.roomMap.has(e)||this.roomMap.set(e,new _(e)),this.roomMap.get(e)}static get instance(){return y.internalInstance}async onNotReady(){for(const e of this.roomMap.values())e.destroy()}async onAction(e){return Promise.resolve()}}i()(y,"internalInstance",new y)},function(e,t,s){"use strict";s.d(t,"c",(function(){return S})),s.d(t,"e",(function(){return w})),s.d(t,"d",(function(){return c})),s.d(t,"a",(function(){return p})),s.d(t,"b",(function(){return f}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(58);const c=({children:e,inputRef:t})=>{const[s,n,i]=w(t);return e({onFocus:s,isActive:n,ref:i})};var l=s(56),d=s.n(l),u=s(60),h=s.n(u),m=s(52);const p=e=>{let{inputRef:t}=e,s=h()(e,["inputRef"]);const[n,i,o]=w(t);return r.a.createElement(m.a,d()({},s,{onFocus:n,inputRef:o,tabIndex:i?0:-1}))};var g=s(68);const f=e=>{let{inputRef:t}=e,s=h()(e,["inputRef"]);const[n,i,o]=w(t);return r.a.createElement(g.a,d()({},s,{onFocus:n,inputRef:o,tabIndex:i?0:-1}))};function _(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?_(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):_(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const y=Object(o.createContext)({state:{activeRef:null,refs:[]},dispatch:()=>{}});var b;y.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(b||(b={}));const E=(e,t)=>{switch(t.type){case b.Register:{if(0===e.refs.length)return v(v({},e),{},{activeRef:t.payload.ref,refs:[t.payload.ref]});if(e.refs.includes(t.payload.ref))return e;let s=e.refs.findIndex(e=>2&e.current.compareDocumentPosition(t.payload.ref.current));return s<0&&(s=e.refs.length),v(v({},e),{},{refs:[...e.refs.slice(0,s),t.payload.ref,...e.refs.slice(s)]})}case b.Unregister:{const s=e.refs.filter(e=>e!==t.payload.ref);if(s.length===e.refs.length)return e;if(e.activeRef===t.payload.ref){const n=e.refs.findIndex(e=>e===t.payload.ref);return v(v({},e),{},{activeRef:n>=s.length?s[s.length-1]:s[n],refs:s})}return v(v({},e),{},{refs:s})}case b.SetFocus:return v(v({},e),{},{activeRef:t.payload.ref});default:return e}},S=({children:e,handleHomeEnd:t,onKeyDown:s})=>{const[n,i]=Object(o.useReducer)(E,{activeRef:null,refs:[]}),c=Object(o.useMemo)(()=>({state:n,dispatch:i}),[n]),l=Object(o.useCallback)(e=>{let n=!1;if(t)switch(e.key){case a.a.HOME:n=!0,c.state.refs.length>0&&c.state.refs[0].current.focus();break;case a.a.END:n=!0,c.state.refs.length>0&&c.state.refs[c.state.refs.length-1].current.focus()}if(n)e.preventDefault(),e.stopPropagation();else if(s)return s(e,c.state)},[c.state,s,t]);return r.a.createElement(y.Provider,{value:c},e({onKeyDownHandler:l}))},w=e=>{const t=Object(o.useContext)(y);let s=Object(o.useRef)(null);e&&(s=e),Object(o.useLayoutEffect)(()=>(t.dispatch({type:b.Register,payload:{ref:s}}),()=>{t.dispatch({type:b.Unregister,payload:{ref:s}})}),[]);return[Object(o.useCallback)(()=>{t.dispatch({type:b.SetFocus,payload:{ref:s}})},[s,t]),t.state.activeRef===s,s]}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1),i=s(10);function o(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}n.o(o,i.EventEmitter),o.prototype.setPresenceEvent=function(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const s=[];(e.getContent().presence!==this.presence||t)&&s.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&s.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&s.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&s.push("User.currentlyActive"),this.presence=e.getContent().presence,s.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(let t=0;t<s.length;t++)this.emit(s[t],e,this)},o.prototype.setDisplayName=function(e){const t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this._updateModifiedTime()},o.prototype.setRawDisplayName=function(e){this.rawDisplayName="string"==typeof e?e:void 0},o.prototype.setAvatarUrl=function(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},o.prototype._updateModifiedTime=function(){this._modified=Date.now()},o.prototype.getLastModifiedTime=function(){return this._modified},o.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},o.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"ContentHelpers",(function(){return O})),s.d(t,"request",(function(){return x})),s.d(t,"getRequest",(function(){return N})),s.d(t,"wrapRequest",(function(){return j})),s.d(t,"setCryptoStoreFactory",(function(){return D})),s.d(t,"createClient",(function(){return A}));var n=s(190),i=s(189),o=s(270),r=s(191);s.d(t,"CRYPTO_ENABLED",(function(){return r.a})),s.d(t,"MatrixClient",(function(){return r.b}));var a=s(192);s.d(t,"PREFIX_R0",(function(){return a.h})),s.d(t,"PREFIX_UNSTABLE",(function(){return a.i})),s.d(t,"PREFIX_IDENTITY_V1",(function(){return a.e})),s.d(t,"PREFIX_IDENTITY_V2",(function(){return a.f})),s.d(t,"PREFIX_MEDIA_R0",(function(){return a.g})),s.d(t,"MatrixHttpApi",(function(){return a.d})),s.d(t,"MatrixError",(function(){return a.c})),s.d(t,"ConnectionError",(function(){return a.b})),s.d(t,"AbortError",(function(){return a.a})),s.d(t,"retryNetworkOperation",(function(){return a.j}));var c=s(230);s.d(t,"AutoDiscovery",(function(){return c.a}));var l=s(13);s.d(t,"SyncAccumulator",(function(){return l.a}));var d=s(158);s.d(t,"InvalidStoreError",(function(){return d.b})),s.d(t,"InvalidCryptoStoreError",(function(){return d.a})),s.d(t,"KeySignatureUploadError",(function(){return d.c}));var u=s(81);s.d(t,"EventStatus",(function(){return u.a})),s.d(t,"MatrixEvent",(function(){return u.b}));var h=s(187);s.d(t,"Room",(function(){return h.a}));var m=s(226);s.d(t,"Group",(function(){return m.a}));var p=s(107);s.d(t,"EventTimeline",(function(){return p.a}));var g=s(265);s.d(t,"EventTimelineSet",(function(){return g.a}));var f=s(156);s.d(t,"RoomMember",(function(){return f.a}));var _=s(268);s.d(t,"RoomState",(function(){return _.a}));var v=s(133);s.d(t,"User",(function(){return v.a})),s.d(t,"MatrixScheduler",(function(){return o.a}));var y=s(266);s.d(t,"Filter",(function(){return y.a}));var b=s(374);s.d(t,"TimelineWindow",(function(){return b.b})),s.d(t,"TimelineIndex",(function(){return b.a}));var E=s(375);s.d(t,"InteractiveAuth",(function(){return E.a}));var S=s(272);s.d(t,"SERVICE_TYPES",(function(){return S.a})),s.d(t,"MemoryStore",(function(){return i.a}));var w=s(376);s.d(t,"IndexedDBStore",(function(){return w.a}));var C=s(377);s.d(t,"WebStorageSessionStore",(function(){return C.a})),s.d(t,"MemoryCryptoStore",(function(){return n.a}));var R=s(108);s.d(t,"IndexedDBCryptoStore",(function(){return R.a}));var k=s(80);s.d(t,"getHttpUriForMxc",(function(){return k.a}));var I=s(159);s.d(t,"createNewMatrixCall",(function(){return I.a})),s.d(t,"setMatrixCallAudioOutput",(function(){return I.c})),s.d(t,"setMatrixCallAudioInput",(function(){return I.b})),s.d(t,"setMatrixCallVideoInput",(function(){return I.d}));const O=Promise.resolve().then(s.bind(null,371));let T;function x(e){T=e}function N(){return T}function j(e){const t=T;T=function(s,n){return e(t,s,n)}}let P=()=>new n.a;function D(e){P=e}function A(t){return"string"==typeof t&&(t={baseUrl:t}),t.request=t.request||T,t.store=t.store||new i.a({localStorage:e.localStorage}),t.scheduler=t.scheduler||new o.a,t.cryptoStore=t.cryptoStore||P(),new r.b(t)}}.call(this,s(6))},function(e,t,s){"use strict";s.d(t,"i",(function(){return d})),s.d(t,"j",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"h",(function(){return m})),s.d(t,"g",(function(){return p})),s.d(t,"e",(function(){return g})),s.d(t,"d",(function(){return f})),s.d(t,"f",(function(){return _})),s.d(t,"b",(function(){return v})),s.d(t,"c",(function(){return y})),s.d(t,"k",(function(){return b}));var n=s(269),i=s.n(n),o=s(0),r=s(10),a=s(194),c=s(193);const l="m.key.verification.",d=l+"request",u=l+"start",h=l+"cancel",m=l+"ready",p=1,g=2,f=3,_=4,v=5,y=6;class b extends r.EventEmitter{constructor(e,t,s){super(),i()(this,"_cancelOnTimeout",()=>{try{this.initiatedByMe?this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.a.error("Error while cancelling verification request",e)}}),this.channel=e,this.channel._request=this,this._verificationMethods=t,this._client=s,this._commonMethods=[],this._setPhase(p,!1),this._eventsByUs=new Map,this._eventsByThem=new Map,this._observeOnly=!1,this._timeoutTimer=null,this._accepting=!1,this._declining=!1,this._verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this._requestReceivedAt=null}static validateEvent(e,t,s){const n=t.getContent();return!(!e||!e.startsWith(l))&&(n?e!==d&&e!==m||Array.isArray(n.methods)?e!==d&&e!==m&&e!==u||"string"==typeof n.from_device&&0!==n.from_device.length||(o.a.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.a.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.a.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===p}get requested(){return this.phase===g}get cancelled(){return this.phase===v}get ready(){return this.phase===f}get started(){return this.phase===_}get done(){return this.phase===y}get methods(){return this._commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this._requestReceivedAt&&!this.initiatedByMe&&this.phase<=g){const e=this._requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this._getEventByEither(d);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this._getEventByEither(d)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<f&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==y&&this._phase!==v}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const s=this._eventsByThem.get(d)||this._eventsByThem.get(m);if(!s){if(this.started&&this.initiatedByMe){const t=this._eventsByUs.get(u),s=t&&t.getContent();return e==(s&&s.method)}return!1}const n=s.getContent();if(!n)return!1;const{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this._eventsByUs.size+this._eventsByThem.size===0;if(this._phase===p&&e)return!0;const t=this._eventsByUs.has(d),s=this._eventsByThem.has(d);if(t&&!s)return!0;if(!t&&s)return!1;const n=this._eventsByUs.has(u),i=this._eventsByThem.has(u);return!(!n||i)}get requestingUserId(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this._client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this._eventsByUs.get(h),t=this._eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this._getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this._eventsByThem.get(d)||this._eventsByThem.get(m)||this._eventsByThem.get(u)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(this.phase===g||this.phase===f||this.phase===p&&this.channel.constructor.canCreateRequest(u)){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw Object(a.g)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw Object(a.g)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===p){const e=[...this._verificationMethods.keys()];await this.channel.send(d,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==v){if(this._declining=!0,this.emit("change"),this._verifier)return this._verifier.cancel(Object(a.a)(t,e)());this._cancellingUserId=this._client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===g&&!this.initiatedByMe){const e=[...this._verificationMethods.keys()];this._accepting=!0,this.emit("change"),await this.channel.send(m,{methods:e})}}waitFor(e){return new Promise((t,s)=>{const n=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(s(new Error("cancelled")),i=!0),i&&this.off("change",n),i};n()||this.on("change",n)})}_setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}_getEventByEither(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}_getEventBy(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}_calculatePhaseTransitions(){const e=[{phase:p}],t=()=>e[e.length-1].phase,s=this._eventsByThem.has(d),n=this._getEventBy(d,s);n&&e.push({phase:g,event:n});const i=n&&this._getEventBy(m,!s);let o;if(i&&t()===g&&e.push({phase:f,event:i}),i||!n){const e=this._eventsByThem.get(u),t=this._eventsByUs.get(u);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this._getEventBy(u,!s);if(o){const s=t()===g&&n.getSender()!==o.getSender(),i=t()===p&&this.channel.constructor.canCreateRequest(u);(s||t()===f||i)&&e.push({phase:_,event:o})}const r=this._eventsByUs.get("m.key.verification.done");(this._verifierHasFinished||r&&t()===_)&&e.push({phase:y});const a=this._getEventByEither(h);return(this._cancelled||a)&&t()!==y?(e.push({phase:v,event:a}),e):e}_transitionToPhase(e){const{phase:t,event:s}=e;if((t===g||t===f)&&!this._wasSentByOwnDevice(s)){const e=s.getContent();this._commonMethods=e.methods.filter(e=>this._verificationMethods.has(e))}if(this.observeOnly||t!==g&&t!==_&&t!==f||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(s)&&!this._wasSentByOwnDevice(s)&&(this._observeOnly=!0),t===_){const{method:e}=s.getContent();this._verifier||this.observeOnly||(this._verifier=this._createVerifier(e,s),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: "+e}))}}_applyPhaseTransitions(){const e=this._calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),s=e.slice(t+1);for(const e of s)this._transitionToPhase(e);return s}_isWinningStartRace(e){if(e.getType()!==u)return!1;const t=this._verifier.startEvent;let s,n;if(this.isSelfVerification)if(t){const e=t.getContent();s=e&&e.from_device}else s=this._client.getDeviceId();else s=t?t.getSender():this._client.getUserId();if(this.isSelfVerification){const t=e.getContent();n=t&&t.from_device}else n=e.getSender();return n<s}hasEventId(e){for(const t of this._eventsByUs.values())if(t.getId()===e)return!0;for(const t of this._eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,s,n,i){if(this.done||this.cancelled)return;const r=this._observeOnly;if(this._adjustObserveOnly(t,s),!this.observeOnly&&!n&&await this._cancelOnError(e,t))return;if(i?this._eventsByUs.has(e):this._eventsByThem.has(e))return;const a=this.phase;this._addEvent(e,t,i);const l=this._applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const s=this._isWinningStartRace(t);this._verifier.canSwitchStartEvent(t)&&s?this._verifier.switchStartEvent(t):n||(e===h||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t)}if(l.length){if(s&&l.some(e=>e.phase===f)){this.otherPartySupportsMethod(c.c,!0)&&(this._qrCodeData=await c.a.create(this,this._client))}const e=l[l.length-1],{phase:t}=e;this._setupTimeout(t),this._setPhase(t)}else this._observeOnly!==r&&this.emit("change")}finally{o.a.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${i}, isLiveEvent:${s}, isRemoteEcho:${n}, phase:${a}=>${this.phase}, observeOnly:${r}=>${this._observeOnly}`)}}_setupTimeout(e){if(!this._timeoutTimer&&!this.observeOnly&&e===g&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer){(e===_||e===f||e===y||e===v)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null)}}async _cancelOnError(e,t){if(e===u){const e=t.getContent().method;if(!this._verificationMethods.has(e))return await this.cancel(Object(a.b)(Object(a.g)())),!0}const s=e===d&&this.phase!==p,n=e===m&&this.phase!==g;if(this.phase!==p&&(s||n)){o.a.warn(`Cancelling, unexpected ${e} verification event from `+t.getSender());const s=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Object(a.b)(Object(a.f)({reason:s}))),!0}return!1}_adjustObserveOnly(e,t){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}_addEvent(e,t,s){if(s?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===d){for(const[e,t]of this._eventsByThem.entries())t.getSender()!==this.otherUserId&&this._eventsByThem.delete(e);this._requestReceivedAt=Date.now()}}_createVerifier(e,t=null,s=null){s||(s=this.targetDevice);const{userId:n,deviceId:i}=s,r=this._verificationMethods.get(e);if(r)return new r(this.channel,this._client,n,i,t,this);o.a.warn("could not find verifier constructor for method",e)}_wasSentByOwnUser(e){return e.getSender()===this._client.getUserId()}_wasSentByOwnDevice(e){if(!this._wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this._verifierHasFinished=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this._eventsByThem.get(e)}}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"d",(function(){return h})),s.d(t,"b",(function(){return m})),s.d(t,"c",(function(){return p}));var n=s(47),i=s(44),o=s(49),r=s(140),a=s(43),c=s.n(a),l=s(48),d=s(74);let u;function h(e){const t={[u.Invite]:[],[u.Join]:[],[u.Leave]:[]};for(const s of e)t[m(s.getMyMembership())].push(s);return t}function m(e){return"invite"===e?u.Invite:"join"===e?u.Join:u.Leave}async function p(e){let t=!0;const s=await n.a.get().getRoomUpgradeHistory(e);if(s&&s.length>0){s[s.length-1].roomId!==e&&(t=!1)}let a={};if(t)a=await n.a.get().leaveRoomChain(e);else try{await n.a.get().leave(e)}catch(t){if(t&&t.data&&t.data.errcode){const s=t.data.error||Object(i.a)("Unexpected server error trying to leave the room");a[e]=Object.assign(new Error(s),{errcode:t.data.errcode})}else a[e]=t||new Error("Failed to leave room for unknown causes")}const u=Object.entries(a).filter(e=>!!e[1]);if(u.length>0){const t=[];for(const s of u){const n=s[1];let l=Object(i.a)("Unexpected server error trying to leave the room");if(n.errcode&&n.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===n.errcode)return void o.a.createTrackedDialog("Error Leaving Room","",r.a,{title:Object(i.a)("Can't leave Server Notices room"),description:Object(i.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});l=a[e].message}t.push(l,c.a.createElement("BR"))}o.a.createTrackedDialog("Error Leaving Room","",r.a,{title:Object(i.a)("Error leaving room"),description:t})}else d.a.getRoomId()===e&&l.a.dispatch({action:"view_next_room"})}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(u||(u={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(44);class u extends r.a.Component{render(){const e=l.getComponent("views.dialogs.BaseDialog");return r.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(d.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(d.a)("An error has occurred.")),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.props.onFinished,autoFocus:this.props.focus},this.props.button||Object(d.a)("OK"))))}}i()(u,"propTypes",{title:c.a.string,description:c.a.oneOfType([c.a.element,c.a.string]),button:c.a.string,focus:c.a.bool,onFinished:c.a.func.isRequired,headerImage:c.a.string}),i()(u,"defaultProps",{focus:!0,title:null,description:null,button:null})},function(e,t,s){"use strict";s.d(t,"a",(function(){return x})),s.d(t,"b",(function(){return P}));var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(170),c=s(43),l=s.n(c),d=s(45),u=s.n(d),h=s(51),m=s.n(h),p=s(44),g=s(246),f=s(46),_=s(48),v=s(50),y=s(55),b=s(75),E=s(47),S=s(252),w=s(253),C=s(59),R=s(146),k=s(251);const I={"m.room.message":"messages.MessageEvent","m.sticker":"messages.MessageEvent","m.key.verification.cancel":"messages.MKeyVerificationConclusion","m.key.verification.done":"messages.MKeyVerificationConclusion","m.room.encryption":"messages.EncryptionEvent","m.call.invite":"messages.TextualEvent","m.call.answer":"messages.TextualEvent","m.call.hangup":"messages.TextualEvent"},O={"m.room.encryption":"messages.EncryptionEvent","m.room.canonical_alias":"messages.TextualEvent","m.room.create":"messages.RoomCreate","m.room.member":"messages.TextualEvent","m.room.name":"messages.TextualEvent","m.room.avatar":"messages.RoomAvatarEvent","m.room.third_party_invite":"messages.TextualEvent","m.room.history_visibility":"messages.TextualEvent","m.room.topic":"messages.TextualEvent","m.room.power_levels":"messages.TextualEvent","m.room.pinned_events":"messages.TextualEvent","m.room.server_acl":"messages.TextualEvent","im.vector.modular.widgets":"messages.TextualEvent","m.room.tombstone":"messages.TextualEvent","m.room.join_rules":"messages.TextualEvent","m.room.guest_access":"messages.TextualEvent","m.room.related_groups":"messages.TextualEvent"};for(const e of S.a)O[e]="messages.TextualEvent";function T(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t&&"m.key.verification.request"===t.msgtype){const s=E.a.get(),n=s&&s.getUserId();return e.getSender()!==n&&t.to!==n?void 0:"messages.MKeyVerificationRequest"}}if("m.key.verification.done"===t){const t=E.a.get(),s=t&&t.getUserId();if(e.getSender()!==s)return}if("m.key.verification.cancel"===t||"m.key.verification.done"===t){if(!f.getComponent("messages.MKeyVerificationConclusion").prototype._shouldRender.call(null,e,e.request))return}return e.isState()?O[t]:I[t]}class x extends l.a.Component{constructor(e,t){super(e,t),r()(this,"_onDecrypted",()=>{this._verifyEvent(this.props.mxEvent),this.forceUpdate()}),r()(this,"onDeviceVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this._verifyEvent(this.props.mxEvent)}),r()(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this._verifyEvent(this.props.mxEvent)}),r()(this,"toggleAllReadAvatars",()=>{this.setState({allReadAvatars:!this.state.allReadAvatars})}),r()(this,"onSenderProfileClick",e=>{const t=this.props.mxEvent;_.a.dispatch({action:"insert_mention",user_id:t.getSender()})}),r()(this,"onRequestKeysClick",()=>{this.setState({previouslyRequestedKeys:!0}),this.context.cancelAndResendEventRoomKeyRequest(this.props.mxEvent)}),r()(this,"onPermalinkClicked",e=>{e.preventDefault(),_.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),r()(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),r()(this,"getTile",()=>this._tile.current),r()(this,"getReplyThread",()=>this._replyThread.current),r()(this,"getReactions",()=>{if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const e=this.props.mxEvent.getId();return e||(console.error("EventTile attempted to get relations for an event without an ID"),console.log(JSON.stringify(this.props.mxEvent,null,4)),console.trace("Stacktrace for https://github.com/vector-im/element-web/issues/11120")),this.props.getRelationsForEvent(e,"m.annotation","m.reaction")}),r()(this,"_onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&(this.props.mxEvent.removeListener("Event.relationsCreated",this._onReactionsCreated),this.setState({reactions:this.getReactions()}))}),this.state={actionBarFocused:!1,allReadAvatars:!1,verified:null,previouslyRequestedKeys:!1,reactions:this.getReactions()},this._suppressReadReceiptAnimation=!0,this._tile=Object(c.createRef)(),this._replyThread=Object(c.createRef)()}UNSAFE_componentWillMount(){this._verifyEvent(this.props.mxEvent)}componentDidMount(){this._suppressReadReceiptAnimation=!1;const e=this.context;e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),e.on("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.on("Event.decrypted",this._onDecrypted),this.props.showReactions&&this.props.mxEvent.on("Event.relationsCreated",this._onReactionsCreated)}UNSAFE_componentWillReceiveProps(e){e.eventSendStatus!==this.props.eventSendStatus&&this._verifyEvent(e.mxEvent)}shouldComponentUpdate(e,t){return!w.a(this.state,t)||!this._propsEqual(this.props,e)}componentWillUnmount(){const e=this.context;e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),e.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.removeListener("Event.decrypted",this._onDecrypted),this.props.showReactions&&this.props.mxEvent.removeListener("Event.relationsCreated",this._onReactionsCreated)}async _verifyEvent(e){if(!e.isEncrypted())return;const t=this.context.getEventEncryptionInfo(e),s=e.getSender(),n=this.context.checkUserTrust(s);if(t.mismatchedSender)return void this.setState({verified:R.a.WARNING},this.props.onHeightChanged);if(!n.isCrossSigningVerified())return void this.setState({verified:R.a.NORMAL},this.props.onHeightChanged);const i=t.sender&&this.context.checkDeviceTrust(s,t.sender.deviceId);i?i.isVerified()?t.authenticated?this.setState({verified:R.a.VERIFIED},this.props.onHeightChanged):this.setState({verified:R.a.UNAUTHENTICATED},this.props.onHeightChanged):this.setState({verified:R.a.WARNING},this.props.onHeightChanged):this.setState({verified:R.a.UNKNOWN},this.props.onHeightChanged)}_propsEqual(e,t){const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const i=s[n];if(!t.hasOwnProperty(i))return!1;if("readReceipts"===i){const s=e[i],n=t[i];if(s===n)continue;if(!s||!n)return!1;if(s.length!==n.length)return!1;for(let e=0;e<s.length;e++){if(s[e].userId!==n[e].userId)return!1;if(s[e].roomMember!==n[e].roomMember)return!1}}else if(e[i]!==t[i])return!1}return!0}shouldHighlight(){const e=this.context.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent);return!(!e||!e.tweaks)&&(this.props.mxEvent.getSender()!==this.context.credentials.userId&&e.tweaks.highlight)}getReadAvatars(){if(!this.props.readReceipts||0===this.props.readReceipts.length)return l.a.createElement("span",{className:"mx_EventTile_readAvatars"});const e=f.getComponent("rooms.ReadReceiptMarker"),t=[];let s=0;const n=this.props.readReceipts||[];for(let i=0;i<n.length;++i){const o=n[i];let r=!0;(i<5||this.state.allReadAvatars)&&(r=!1),s=-15*(r?4:i);const a=o.userId;let c;this.props.readReceiptMap&&(c=this.props.readReceiptMap[a],c||(c={},this.props.readReceiptMap[a]=c)),t.unshift(l.a.createElement(e,{key:a,member:o.roomMember,fallbackUserId:a,leftOffset:s,hidden:r,readReceiptInfo:c,checkUnmounting:this.props.checkUnmounting,suppressAnimation:this._suppressReadReceiptAnimation,onClick:this.toggleAllReadAvatars,timestamp:o.ts,showTwelveHour:this.props.isTwelveHour}))}let i;if(!this.state.allReadAvatars){const e=n.length-5;e>0&&(i=l.a.createElement("span",{className:"mx_EventTile_readAvatarRemainder",onClick:this.toggleAllReadAvatars,style:{right:"calc("+Object(k.b)(-s)+" + 15px)"}},e,"+"))}return l.a.createElement("span",{className:"mx_EventTile_readAvatars"},i,t)}_renderE2EPadlock(){const e=this.props.mxEvent;if("m.bad.encrypted"===e.getContent().msgtype)return l.a.createElement(D,null);if(e.isEncrypted())return this.state.verified===R.a.NORMAL||this.state.verified===R.a.VERIFIED?void 0:this.state.verified===R.a.UNAUTHENTICATED?l.a.createElement(L,null):this.state.verified===R.a.UNKNOWN?l.a.createElement(M,null):l.a.createElement(A,null);if(this.context.isRoomEncrypted(e.getRoomId())){if(e.status===y.b.ENCRYPTING)return;if(e.status===y.b.NOT_SENT)return;if(e.isState())return;return l.a.createElement(U,null)}return null}render(){const e=f.getComponent("messages.MessageTimestamp"),t=f.getComponent("messages.SenderProfile"),s=f.getComponent("avatars.MemberAvatar"),n=this.props.mxEvent.getContent().msgtype,i=this.props.mxEvent.getType(),o=i.startsWith("m.key.verification")||"m.room.message"===i&&n&&n.startsWith("m.key.verification")||"m.room.encryption"===i;let r=!o&&"m.room.message"!==i&&"m.sticker"!==i&&"m.room.create"!==i,c=T(this.props.mxEvent);if((!c||this.props.mxEvent.isRelation("m.replace"))&&v.a.getValue("showHiddenEventsInTimeline")&&(c="messages.ViewSourceEvent",r=!0),!c){const{mxEvent:e}=this.props;return console.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),l.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},l.a.createElement("div",{className:"mx_EventTile_line"},Object(p.a)("This event could not be displayed")))}const d=f.getComponent(c),u=-1!==["sending","queued","encrypting"].indexOf(this.props.eventSendStatus),h=j(this.props.mxEvent)&&this.props.isRedacted,g=this.props.mxEvent.isDecryptionFailure(),_=!!this.props.editState,y=m()({mx_EventTile_bubbleContainer:o,mx_EventTile:!0,mx_EventTile_isEditing:_,mx_EventTile_info:r,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_encrypting:"encrypting"===this.props.eventSendStatus,mx_EventTile_sending:!_&&u,mx_EventTile_notSent:"not_sent"===this.props.eventSendStatus,mx_EventTile_highlight:"notif"!==this.props.tileShape&&this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent,mx_EventTile_continuation:this.props.tileShape?"":this.props.continuation,mx_EventTile_last:this.props.last,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!o&&this.state.verified===R.a.VERIFIED,mx_EventTile_unverified:!o&&this.state.verified===R.a.WARNING,mx_EventTile_unknown:!o&&this.state.verified===R.a.UNKNOWN,mx_EventTile_bad:g,mx_EventTile_emote:"m.emote"===n}),E=null!==this.props.eventSendStatus?"off":void 0;let S="#";this.props.permalinkCreator&&(S=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const w=this.getReadAvatars();let C,k,I,O;if("notif"===this.props.tileShape?(I=24,O=!0):"messages.RoomCreate"===c||o?(I=0,O=!1):r?(I=14,O=!1):this.props.useIRCLayout?(I=14,O=!0):this.props.continuation&&"file_grid"!==this.props.tileShape?(I=0,O=!1):(I=30,O=!0),this.props.mxEvent.sender&&I&&(C=l.a.createElement("div",{className:"mx_EventTile_avatar"},l.a.createElement(s,{member:this.props.mxEvent.sender,width:I,height:I,viewUserOnClick:!0}))),O){let e=null;this.props.tileShape&&"reply"!==this.props.tileShape&&"reply_preview"!==this.props.tileShape?k=l.a.createElement(t,{mxEvent:this.props.mxEvent,enableFlair:!0}):("m.image"===n?e=Object(p.b)("%(senderName)s sent an image"):"m.video"===n?e=Object(p.b)("%(senderName)s sent a video"):"m.file"===n&&(e=Object(p.b)("%(senderName)s uploaded a file")),k=l.a.createElement(t,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent,enableFlair:!e,text:e}))}const x=f.getComponent("messages.MessageActionBar"),N=_?void 0:l.a.createElement(x,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyThread:this.getReplyThread,onFocusChange:this.onActionBarFocusChange}),P=this.props.mxEvent.getTs()?l.a.createElement(e,{showTwelveHour:this.props.isTwelveHour,ts:this.props.mxEvent.getTs()}):null,D=l.a.createElement("div",{className:"mx_EventTile_keyRequestInfo_tooltip_contents"},l.a.createElement("p",null,this.state.previouslyRequestedKeys?Object(p.a)("Your key share request has been sent - please check your other sessions for key share requests."):Object(p.a)("Key share requests are sent to your other sessions automatically. If you rejected or dismissed the key share request on your other sessions, click here to request the keys for this session again.")),l.a.createElement("p",null,Object(p.a)("If your other sessions do not have the key for this message you will not be able to decrypt them."))),A=this.state.previouslyRequestedKeys?Object(p.a)("Key request sent."):Object(p.a)("<requestLink>Re-request encryption keys</requestLink> from your other sessions.",{},{requestLink:e=>l.a.createElement("a",{onClick:this.onRequestKeysClick},e)}),U=f.getComponent("elements.TooltipButton"),M=g?l.a.createElement("div",{className:"mx_EventTile_keyRequestInfo"},l.a.createElement("span",{className:"mx_EventTile_keyRequestInfo_text"},A),l.a.createElement(U,{helpText:D})):null;let L;if(!h){const e=f.getComponent("messages.ReactionsRow");L=l.a.createElement(e,{mxEvent:this.props.mxEvent,reactions:this.state.reactions})}const F=l.a.createElement("a",{href:S,onClick:this.onPermalinkClicked,"aria-label":Object(b.d)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour)},P),B=this.props.useIRCLayout?null:F,V=this.props.useIRCLayout?F:null,K=!this.props.useIRCLayout&&!o&&this._renderE2EPadlock(),q=this.props.useIRCLayout&&!o&&this._renderE2EPadlock();switch(this.props.tileShape){case"notif":{const e=this.context.getRoom(this.props.mxEvent.getRoomId());return l.a.createElement("div",{className:y,"aria-live":E,"aria-atomic":"true"},l.a.createElement("div",{className:"mx_EventTile_roomName"},l.a.createElement("a",{href:S,onClick:this.onPermalinkClicked},e?e.name:"")),l.a.createElement("div",{className:"mx_EventTile_senderDetails"},C,l.a.createElement("a",{href:S,onClick:this.onPermalinkClicked},k,P)),l.a.createElement("div",{className:"mx_EventTile_line"},l.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged})))}case"file_grid":return l.a.createElement("div",{className:y,"aria-live":E,"aria-atomic":"true"},l.a.createElement("div",{className:"mx_EventTile_line"},l.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,onHeightChanged:this.props.onHeightChanged})),l.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",href:S,onClick:this.onPermalinkClicked},l.a.createElement("div",{className:"mx_EventTile_senderDetails"},k,P)));case"reply":case"reply_preview":{let e;return"reply_preview"===this.props.tileShape&&(e=a.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this._replyThread)),l.a.createElement("div",{className:y,"aria-live":E,"aria-atomic":"true"},V,C,k,q,l.a.createElement("div",{className:"mx_EventTile_reply"},B,K,e,l.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,showUrlPreview:!1})))}default:{const e=a.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this._replyThread,this.props.useIRCLayout);return l.a.createElement("div",{className:y,tabIndex:-1,"aria-live":E,"aria-atomic":"true"},V,l.a.createElement("div",{className:"mx_EventTile_msgOption"},w),k,q,l.a.createElement("div",{className:"mx_EventTile_line"},B,K,e,l.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged}),M,L,N),C)}}}}r()(x,"propTypes",{mxEvent:u.a.object.isRequired,isRedacted:u.a.bool,continuation:u.a.bool,last:u.a.bool,contextual:u.a.bool,highlights:u.a.array,highlightLink:u.a.string,showUrlPreview:u.a.bool,isSelectedEvent:u.a.bool,onHeightChanged:u.a.func,readReceipts:u.a.arrayOf(u.a.object),readReceiptMap:u.a.object,checkUnmounting:u.a.func,eventSendStatus:u.a.string,tileShape:u.a.string,isTwelveHour:u.a.bool,getRelationsForEvent:u.a.func,showReactions:u.a.bool,useIRCLayout:u.a.bool}),r()(x,"defaultProps",{onHeightChanged:function(){}}),r()(x,"contextType",C.a);const N=["m.room.message","m.sticker"];function j(e){return N.includes(e.getType())}function P(e){if(e.isRedacted()&&!j(e))return!1;if(e.isRelation("m.replace"))return!1;const t=T(e);return void 0!==t&&("messages.TextualEvent"===t?""!==g.a(e):"messages.RoomCreate"!==t||Boolean(e.getContent().predecessor))}function D(e){return l.a.createElement(F,i()({title:Object(p.a)("This message cannot be decrypted"),icon:"undecryptable"},e))}function A(e){return l.a.createElement(F,i()({title:Object(p.a)("Encrypted by an unverified session"),icon:"unverified"},e))}function U(e){return l.a.createElement(F,i()({title:Object(p.a)("Unencrypted"),icon:"unencrypted"},e))}function M(e){return l.a.createElement(F,i()({title:Object(p.a)("Encrypted by a deleted session"),icon:"unknown"},e))}function L(e){return l.a.createElement(F,i()({title:Object(p.a)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:"unauthenticated"},e))}class F extends l.a.Component{constructor(){super(),r()(this,"onHoverStart",()=>{this.setState({hover:!0})}),r()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){let e=null;if(this.state.hover){const t=f.getComponent("elements.Tooltip");e=l.a.createElement(t,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title,dir:"auto"})}let t="mx_EventTile_e2eIcon mx_EventTile_e2eIcon_"+this.props.icon;return v.a.getValue("alwaysShowEncryptionIcons")||(t+=" mx_EventTile_e2eIcon_hidden"),l.a.createElement("div",{className:t,onClick:this.onClick,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}r()(F,"propTypes",{icon:u.a.string.isRequired,title:u.a.string.isRequired})},function(e,t,s){"use strict";(function(e){var n=s(10),i=s.n(n),o=s(47);class r extends i.a{constructor(){super(),this._persistentWidgetId=null,this._capsByWidgetId={},this._widgetMessagingByWidgetId={},this._roomIdByWidgetId={},this.onRoomStateEvents=this.onRoomStateEvents.bind(this),this.dispatcherRef=null}start(){o.a.get().on("RoomState.events",this.onRoomStateEvents)}stop(){o.a.get()&&o.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this._capsByWidgetId={},this._widgetMessagingByWidgetId={},this._roomIdByWidgetId={}}onRoomStateEvents(e,t){"im.vector.modular.widgets"===e.getType()&&e.getStateKey()===this._persistentWidgetId&&this.destroyPersistentWidget(this._persistentWidgetId)}destroyPersistentWidget(e){if(e!==this._persistentWidgetId)return;const t=this._persistentWidgetId;this.setWidgetPersistence(t,!1),this.delWidgetMessaging(t),this.delWidgetCapabilities(t),this.delRoomId(t)}setWidgetPersistence(e,t){this._persistentWidgetId!==e||t?this._persistentWidgetId!==e&&t&&(this._persistentWidgetId=e):this._persistentWidgetId=null,this.emit("update")}getWidgetPersistence(e){return this._persistentWidgetId===e}getPersistentWidgetId(){return this._persistentWidgetId}setWidgetCapabilities(e,t){this._capsByWidgetId[e]=t,this.emit("update")}widgetHasCapability(e,t){return this._capsByWidgetId[e]&&this._capsByWidgetId[e].includes(t)}delWidgetCapabilities(e){delete this._capsByWidgetId[e],this.emit("update")}setWidgetMessaging(e,t){this.delWidgetMessaging(e),this._widgetMessagingByWidgetId[e]=t,this.emit("update")}getWidgetMessaging(e){return this._widgetMessagingByWidgetId[e]}delWidgetMessaging(e){if(this._widgetMessagingByWidgetId[e]){try{this._widgetMessagingByWidgetId[e].stop()}catch(e){console.error("Failed to stop listening for widgetMessaging events",e.message)}delete this._widgetMessagingByWidgetId[e],this.emit("update")}}getRoomId(e){return this._roomIdByWidgetId[e]}setRoomId(e,t){this._roomIdByWidgetId[e]=t,this.emit("update")}delRoomId(e){delete this._roomIdByWidgetId[e],this.emit("update")}}void 0===e.singletonActiveWidgetStore&&(e.singletonActiveWidgetStore=new r),t.a=e.singletonActiveWidgetStore}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(444),c=s.n(a),l=s(45),d=s.n(l),u=s(51),h=s.n(u),m=s(58),p=s(52),g=s(47),f=s(44),_=s(59);class v extends r.a.Component{constructor(e){super(e),i()(this,"_onKeyDown",e=>{this.props.onKeyDown&&this.props.onKeyDown(e),this.props.hasCancel&&e.key===m.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1))}),i()(this,"_onCancelClick",e=>{this.props.onFinished(!1)}),this._matrixClient=g.a.get()}render(){let e,t;return this.props.hasCancel&&(e=r.a.createElement(p.a,{onClick:this._onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(f.a)("Close dialog")})),this.props.headerImage&&(t=r.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""})),r.a.createElement(_.a.Provider,{value:this._matrixClient},r.a.createElement(c.a,{returnFocus:!0,lockProps:{onKeyDown:this._onKeyDown,role:"dialog","aria-labelledby":"mx_BaseDialog_title","aria-describedby":this.props.contentId},className:h()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},r.a.createElement("div",{className:h()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},r.a.createElement("div",{className:h()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}}i()(v,"propTypes",{onFinished:d.a.func.isRequired,hasCancel:d.a.bool,onKeyDown:d.a.func,className:d.a.string,fixedWidth:d.a.bool,title:d.a.node.isRequired,headerImage:d.a.string,children:d.a.node,contentId:d.a.string,titleClass:d.a.oneOfType([d.a.string,d.a.object,d.a.arrayOf(d.a.string)])}),i()(v,"defaultProps",{hasCancel:!0,fixedWidth:!0})},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(43);const i=(e,t,s)=>{const i=Object(n.useRef)(s);Object(n.useEffect)(()=>{i.current=s},[s]),Object(n.useEffect)(()=>{if(!e)return;const s=(...e)=>i.current(...e);return e.on(t,s),()=>{e.removeListener(t,s)}},[t,e])}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(43),i=s.n(n),o=s(45),r=s.n(o),a=s(51),c=s.n(a),l=s(44),d=s(52),u=s(232);const h={VERIFIED:"verified",WARNING:"warning",UNKNOWN:"unknown",NORMAL:"normal",UNAUTHENTICATED:"unauthenticated"},m={[h.WARNING]:Object(l.b)("This user has not verified all of their sessions."),[h.NORMAL]:Object(l.b)("You have not verified this user."),[h.VERIFIED]:Object(l.b)("You have verified this user. This user has verified all of their sessions.")},p={[h.WARNING]:Object(l.b)("Someone is using an unknown session"),[h.NORMAL]:Object(l.b)("This room is end-to-end encrypted"),[h.VERIFIED]:Object(l.b)("Everyone in this room is verified")},g=({isUser:e,status:t,className:s,size:o,onClick:r,hideTooltip:a,bordered:g})=>{const[f,_]=Object(n.useState)(!1),v=c()({mx_E2EIcon:!0,mx_E2EIcon_bordered:g,mx_E2EIcon_warning:t===h.WARNING,mx_E2EIcon_normal:t===h.NORMAL,mx_E2EIcon_verified:t===h.VERIFIED},s);let y,b;y=e?m[t]:p[t],o&&(b={width:o+"px",height:o+"px"});const E=()=>_(!0),S=()=>_(!1);let w;return f&&!a&&(w=i.a.createElement(u.a,{label:y?Object(l.a)(y):""})),r?i.a.createElement(d.a,{onClick:r,onMouseOver:E,onMouseLeave:S,className:v,style:b},w):i.a.createElement("div",{onMouseOver:E,onMouseLeave:S,className:v,style:b},w)};g.propTypes={isUser:r.a.bool,status:r.a.oneOf(Object.values(h)),className:r.a.string,size:r.a.number,onClick:r.a.func},t.b=g},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(44);class u extends r.a.Component{constructor(...e){super(...e),i()(this,"onOk",()=>{this.props.onFinished(!0)}),i()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("views.elements.DialogButtons");let s="";return this.props.danger&&(s="danger"),r.a.createElement(e,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),r.a.createElement(t,{primaryButton:this.props.button||Object(d.a)("OK"),primaryButtonClass:s,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}i()(u,"propTypes",{title:c.a.string,description:c.a.node,extraButtons:c.a.node,button:c.a.string,danger:c.a.bool,focus:c.a.bool,onFinished:c.a.func.isRequired,headerImage:c.a.string,quitOnly:c.a.bool,fixedWidth:c.a.bool}),i()(u,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return _})),s.d(t,"b",(function(){return v})),s.d(t,"c",(function(){return w})),s.d(t,"d",(function(){return k}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(66),d=s.n(l),u=s(51),h=s.n(u),m=s(46),p=s(44),g=s(50),f=s(52);const _=0;class v extends r.a.Component{constructor(...e){super(...e),i()(this,"state",{password:""}),i()(this,"_onSubmit",e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:v.LOGIN_TYPE,user:this.props.matrixClient.credentials.userId,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})}),i()(this,"_onPasswordFieldChange",e=>{this.setState({password:e.target.value})})}componentDidMount(){this.props.onPhaseChange(_)}render(){const e=h()({error:this.props.errorText});let t,s;if(this.props.busy){const e=m.getComponent("elements.Spinner");t=r.a.createElement(e,null)}else t=r.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(p.a)("Continue")});this.props.errorText&&(s=r.a.createElement("div",{className:"error",role:"alert"},this.props.errorText));const n=m.getComponent("elements.Field");return r.a.createElement("div",null,r.a.createElement("p",null,Object(p.a)("Confirm your identity by entering your account password below.")),r.a.createElement("form",{onSubmit:this._onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},r.a.createElement(n,{className:e,type:"password",name:"passwordField",label:Object(p.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this._onPasswordFieldChange}),r.a.createElement("div",{className:"mx_button_row"},t)),s)}}i()(v,"LOGIN_TYPE","m.login.password"),i()(v,"propTypes",{matrixClient:c.a.object.isRequired,submitAuthDict:c.a.func.isRequired,errorText:c.a.string,busy:c.a.bool,onPhaseChange:c.a.func.isRequired});class y extends r.a.Component{constructor(...e){super(...e),i()(this,"_onCaptchaResponse",e=>{this.props.submitAuthDict({type:y.LOGIN_TYPE,response:e})})}componentDidMount(){this.props.onPhaseChange(_)}render(){if(this.props.busy){const e=m.getComponent("elements.Spinner");return r.a.createElement(e,null)}let e=this.props.errorText;const t=m.getComponent("views.auth.CaptchaForm");let s,n;return this.props.stageParams&&this.props.stageParams.public_key?s=this.props.stageParams.public_key:e=Object(p.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),e&&(n=r.a.createElement("div",{className:"error",role:"alert"},e)),r.a.createElement("div",null,r.a.createElement(t,{sitePublicKey:s,onCaptchaResponse:this._onCaptchaResponse}),n)}}i()(y,"LOGIN_TYPE","m.login.recaptcha"),i()(y,"propTypes",{submitAuthDict:c.a.func.isRequired,stageParams:c.a.object.isRequired,errorText:c.a.string,busy:c.a.bool,onPhaseChange:c.a.func.isRequired});class b extends r.a.Component{constructor(e){super(e),i()(this,"tryContinue",()=>{this._trySubmit()}),i()(this,"_trySubmit",()=>{let e=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];e=e&&s}e?this.props.submitAuthDict({type:b.LOGIN_TYPE}):this.setState({errorText:Object(p.a)("Please review and accept all of the homeserver's policies")})});const t=this.props.stageParams.policies||{},s=g.a.getValue("language"),n={},o=[];for(const e of Object.keys(t)){const i=t[e];let r=i[s];if(r||(r=i.en),!r){r=i[Object.keys(i).find(e=>"version"!==e)]}if(!r)throw new Error("Failed to find a policy to show the user");n[e]=!1,r.id=e,o.push(r)}this.state={toggledPolicies:n,policies:o}}componentDidMount(){this.props.onPhaseChange(_)}_togglePolicy(e){const t={};for(const s of this.state.policies){let n=this.state.toggledPolicies[s.id];s.id===e&&(n=!n),t[s.id]=n}this.setState({toggledPolicies:t})}render(){if(this.props.busy){const e=m.getComponent("elements.Spinner");return r.a.createElement(e,null)}const e=[];let t,s,n=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];n=n&&s,e.push(r.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},r.a.createElement("input",{type:"checkbox",onChange:()=>this._togglePolicy(t.id),checked:s}),r.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=r.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(s=r.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this._trySubmit,disabled:!n},Object(p.a)("Accept"))),r.a.createElement("div",null,r.a.createElement("p",null,Object(p.a)("Please review and accept the policies of this homeserver:")),e,t,s)}}i()(b,"LOGIN_TYPE","m.login.terms"),i()(b,"propTypes",{submitAuthDict:c.a.func.isRequired,stageParams:c.a.object.isRequired,errorText:c.a.string,busy:c.a.bool,showContinue:c.a.bool,onPhaseChange:c.a.func.isRequired});class E extends r.a.Component{componentDidMount(){this.props.onPhaseChange(_)}render(){if(void 0===this.props.inputs.emailAddress){const e=m.getComponent("elements.Spinner");return r.a.createElement(e,null)}return r.a.createElement("div",null,r.a.createElement("p",null,Object(p.a)("An email has been sent to %(emailAddress)s",{emailAddress:e=>r.a.createElement("i",null,this.props.inputs.emailAddress)})),r.a.createElement("p",null,Object(p.a)("Please check your email to continue registration.")))}}i()(E,"LOGIN_TYPE","m.login.email.identity"),i()(E,"propTypes",{matrixClient:c.a.object.isRequired,submitAuthDict:c.a.func.isRequired,authSessionId:c.a.string.isRequired,clientSecret:c.a.string.isRequired,inputs:c.a.object.isRequired,stageState:c.a.object.isRequired,fail:c.a.func.isRequired,setEmailSid:c.a.func.isRequired,onPhaseChange:c.a.func.isRequired});class S extends r.a.Component{constructor(...e){super(...e),i()(this,"state",{token:"",requestingToken:!1}),i()(this,"_onTokenChange",e=>{this.setState({token:e.target.value})}),i()(this,"_onFormSubmit",async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{const e=await this.props.matrixClient.doesServerRequireIdServerParam();let t;if(this._submitUrl)t=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this._submitUrl,this._sid,this.props.clientSecret,this.state.token);else{if(!e)throw new Error("The registration with MSISDN flow is misconfigured");t=await this.props.matrixClient.submitMsisdnToken(this._sid,this.props.clientSecret,this.state.token)}if(t.success){const t={sid:this._sid,client_secret:this.props.clientSecret};if(e){const e=d.a.parse(this.props.matrixClient.getIdentityServerUrl());t.id_server=e.host}this.props.submitAuthDict({type:S.LOGIN_TYPE,threepid_creds:t,threepidCreds:t})}else this.setState({errorText:Object(p.a)("Token incorrect")})}catch(e){this.props.fail(e),console.log("Failed to submit msisdn token")}}})}componentDidMount(){this.props.onPhaseChange(_),this._submitUrl=null,this._sid=null,this._msisdn=null,this._tokenBox=null,this.setState({requestingToken:!0}),this._requestMsisdnToken().catch(e=>{this.props.fail(e)}).finally(()=>{this.setState({requestingToken:!1})})}_requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then(e=>{this._submitUrl=e.submit_url,this._sid=e.sid,this._msisdn=e.msisdn})}render(){if(this.state.requestingToken){const e=m.getComponent("elements.Spinner");return r.a.createElement(e,null)}{const e=Boolean(this.state.token),t=h()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let s;return this.state.errorText&&(s=r.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),r.a.createElement("div",null,r.a.createElement("p",null,Object(p.a)("A text message has been sent to %(msisdn)s",{msisdn:r.a.createElement("i",null,this._msisdn)})),r.a.createElement("p",null,Object(p.a)("Please enter the code it contains:")),r.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},r.a.createElement("form",{onSubmit:this._onFormSubmit},r.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this._onTokenChange,"aria-label":Object(p.a)("Code")}),r.a.createElement("br",null),r.a.createElement("input",{type:"submit",value:Object(p.a)("Submit"),className:t,disabled:!e})),s))}}}i()(S,"LOGIN_TYPE","m.login.msisdn"),i()(S,"propTypes",{inputs:c.a.shape({phoneCountry:c.a.string,phoneNumber:c.a.string}),fail:c.a.func,clientSecret:c.a.func,submitAuthDict:c.a.func.isRequired,matrixClient:c.a.object,onPhaseChange:c.a.func.isRequired});class w extends r.a.Component{constructor(e){super(e),i()(this,"_ssoUrl",void 0),i()(this,"onStartAuthClick",()=>{window.open(this._ssoUrl,"_blank"),this.setState({phase:w.PHASE_POSTAUTH}),this.props.onPhaseChange(w.PHASE_POSTAUTH)}),i()(this,"onConfirmClick",()=>{this.props.submitAuthDict({})}),this._ssoUrl=e.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this.state={phase:w.PHASE_PREAUTH}}componentDidMount(){this.props.onPhaseChange(w.PHASE_PREAUTH)}render(){let e=null;const t=r.a.createElement(f.a,{onClick:this.props.onCancel,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(p.a)("Cancel"));return e=this.state.phase===w.PHASE_PREAUTH?r.a.createElement(f.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(p.a)("Single Sign On")):r.a.createElement(f.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(p.a)("Confirm")),r.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},t,e)}}i()(w,"propTypes",{matrixClient:c.a.object.isRequired,authSessionId:c.a.string.isRequired,loginType:c.a.string.isRequired,submitAuthDict:c.a.func.isRequired,errorText:c.a.string,onPhaseChange:c.a.func.isRequired,continueText:c.a.string,continueKind:c.a.string,onCancel:c.a.func}),i()(w,"LOGIN_TYPE","m.login.sso"),i()(w,"UNSTABLE_LOGIN_TYPE","org.matrix.login.sso"),i()(w,"PHASE_PREAUTH",1),i()(w,"PHASE_POSTAUTH",2);class C extends r.a.Component{constructor(e){super(e),i()(this,"focus",()=>{this._fallbackButton.current&&this._fallbackButton.current.focus()}),i()(this,"_onShowFallbackClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this._popupWindow=window.open(t),this._popupWindow.opener=null}),i()(this,"_onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})}),this._popupWindow=null,window.addEventListener("message",this._onReceiveMessage),this._fallbackButton=Object(o.createRef)()}componentDidMount(){this.props.onPhaseChange(_)}componentWillUnmount(){window.removeEventListener("message",this._onReceiveMessage),this._popupWindow&&this._popupWindow.close()}render(){let e;return this.props.errorText&&(e=r.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),r.a.createElement("div",null,r.a.createElement("a",{href:"",ref:this._fallbackButton,onClick:this._onShowFallbackClick},Object(p.a)("Start authentication")),e)}}i()(C,"propTypes",{matrixClient:c.a.object.isRequired,authSessionId:c.a.string.isRequired,loginType:c.a.string.isRequired,submitAuthDict:c.a.func.isRequired,errorText:c.a.string,onPhaseChange:c.a.func.isRequired});const R=[v,y,E,S,b,w];function k(e){for(const t of R)if(t.LOGIN_TYPE===e||t.UNSTABLE_LOGIN_TYPE===e)return t;return C}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(43),i=s.n(n),o=s(51),r=s.n(o),a=s(69),c=s(44),l=s(52),d=s(48),u=s(54);const h=({className:e,title:t,children:s})=>i.a.createElement("div",{className:r()("mx_BaseCard_Group",e)},i.a.createElement("h1",null,t),s);t.b=({onClose:e,className:t,header:s,footer:n,withoutScrollContainer:o,previousPhase:h,children:m})=>{let p,g;if(h){const e=()=>{d.a.dispatch({action:u.a.SetRightPanelPhase,phase:h})};p=i.a.createElement(l.a,{className:"mx_BaseCard_back",onClick:e,title:Object(c.a)("Back")})}return e&&(g=i.a.createElement(l.a,{className:"mx_BaseCard_close",onClick:e,title:Object(c.a)("Close")})),o||(m=i.a.createElement(a.a,null,m)),i.a.createElement("div",{className:r()("mx_BaseCard",t)},i.a.createElement("div",{className:"mx_BaseCard_header"},p,g,s),m,n&&i.a.createElement("div",{className:"mx_BaseCard_footer"},n))}},,,function(e,t){e.exports="img/cancel.a090627.svg"},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(10),i=s(80),o=s(1);function r(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime()}o.o(r,n.EventEmitter),r.prototype.markOutOfBand=function(){this._isOutOfBand=!0},r.prototype.isOutOfBand=function(){return this._isOutOfBand},r.prototype.setMembershipEvent=function(e,t){if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;const s=this.membership;this.membership=e.getDirectionalContent().membership;const n=this.name;this.name=function(e,t,s){if(!t||t===e)return e;if(!o.z(t))return e;if(!s)return t;let n=/@.+:.+/.test(t);n||(n=/[\u200E\u200F\u202A-\u202F]/.test(t));if(!n){const i=s.getUserIdsWithDisplayName(t);n=i.some(t=>t!==e)}if(n)return t+" ("+e+")";return t}(this.userId,e.getDirectionalContent().displayname,t),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,s!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,s)),n!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,n))},r.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let s=t.users_default||0;o.l(o.B(t.users),(function(e){s=Math.max(s,e)}));const n=this.powerLevel,i=this.powerLevelNorm;t.users&&void 0!==t.users[this.userId]?this.powerLevel=t.users[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,s>0&&(this.powerLevelNorm=100*this.powerLevel/s),n===this.powerLevel&&i===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))},r.prototype.setTypingEvent=function(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const s=e.getContent().user_ids;o.p(s)&&(-1!==s.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))},r.prototype._updateModifiedTime=function(){this._modified=Date.now()},r.prototype.getLastModifiedTime=function(){return this._modified},r.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},r.prototype.getDMInviter=function(){if(this.events.member){const e=this.events.member;let t=e.getContent(),s=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),s=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return s}},r.prototype.getAvatarUrl=function(e,t,s,n,o,r){void 0===o&&(o=!0);const a=this.getMxcAvatarUrl();if(!a&&!o)return null;const c=Object(i.a)(e,a,t,s,n,r);return c||null},r.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(1);const i=["override","content","room","sender","underride"],o=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function r(e){const t={},s=(e,t)=>{for(let s=0;s<i.length;++s){const n=i[s],r=t[n];if(r)for(let t=0;t<r.length;++t){const s=r[t];if(!s.enabled)continue;const i=o(n,s);if(i&&this.ruleMatchesEvent(i,e))return s.kind=n,s}}return null},o=function(e,t){const s={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":s.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;s.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;s.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;s.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return s},a=function(e,t){const s={event_match:u,contains_display_name:d,room_member_count:l,sender_notification_permission:c};return!!s[e.kind]&&s[e.kind](e,t)},c=function(t,s){const n=t.key;if(!n)return!1;const i=e.getRoom(s.getRoomId());return!(!i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,s.getSender())},l=function(t,s){if(!t.is)return!1;const n=e.getRoom(s.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const i=n.currentState.getJoinedMemberCount(),o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;const r=o[1],a=parseInt(o[2]);if(isNaN(a))return!1;switch(r){case"":case"==":return i==a;case"<":return i<a;case">":return i>a;case"<=":return i<=a;case">=":return i>=a;default:return!1}},d=function(t,s){let i=s.getContent();if(s.isEncrypted()&&s.getClearContent()&&(i=s.getClearContent()),!i||!i.body||"string"!=typeof i.body)return!1;const o=e.getRoom(s.getRoomId());if(!(o&&o.currentState&&o.currentState.members&&o.currentState.getMember(e.credentials.userId)))return!1;const r=o.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+Object(n.h)(r)+"(\\W|$)","i");return i.body.search(a)>-1},u=function(e,t){if(!e.key)return!1;const s=m(e.key,t);if("string"!=typeof s)return!1;if(e.value)return e.value===s;let n;return n="content.body"==e.key?h("(^|\\W)",e.pattern,"(\\W|$)"):h("^",e.pattern,"$"),!!s.match(n)},h=function(e,s,i){return t[s]||(t[s]=new RegExp(e+Object(n.n)(s)+i,"i")),t[s]},m=function(e,t){const s=e.split(".");let i;const o=s[0];for("content"===o?(i=t.getContent(),s.shift()):"type"===o?(i=t.getType(),s.shift()):i=t.event;s.length>0;){const e=s.shift();if(Object(n.r)(i[e]))return null;i=i[e]}return i},p=function(t,n){const i=function(t,n){return n?t.getSender()===e.credentials.userId?null:s(t,n.global):null}(t,n);if(!i)return{};const o=r.actionListToActionsObject(i.actions);return void 0===o.tweaks.highlight&&(o.tweaks.highlight="content"==i.kind),o};this.ruleMatchesEvent=function(e,t){let s=!0;for(let n=0;n<e.conditions.length;++n){const i=e.conditions[n];s&=a(i,t)}return s},this.actionsForEvent=function(t){return p(t,e.pushRules)},this.getPushRuleById=function(t){for(const s of["global"])if(void 0!==e.pushRules[s])for(const n of i)if(void 0!==e.pushRules[s][n])for(const i of e.pushRules[s][n])if(i.rule_id===t)return i;return null}}r.actionListToActionsObject=function(e){const t={notify:!1,tweaks:{}};for(let s=0;s<e.length;++s){const n=e[s];"notify"===n?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t},r.rewriteDefaultRules=function(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const s=t.global.override;for(const e of o){const t=s.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;console.warn("Adding default global override for "+t),s.push(e)}}return t}},function(e,t,s){"use strict";function n(e,t){const s=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[s]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function i(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,s=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(s,Reflect.getPrototypeOf(this)),s.reason=e,s.name="InvalidCryptoStoreError",s}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o})),n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),i.TOO_NEW="TOO_NEW",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error);class o extends Error{constructor(e,t){super(e),this.value=t}}},function(e,t,s){"use strict";(function(e){s.d(t,"c",(function(){return O})),s.d(t,"b",(function(){return T})),s.d(t,"d",(function(){return x})),s.d(t,"a",(function(){return N}));var n=s(0),i=s(10),o=s(1);function r(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[r.FALLBACK_ICE_SERVER]}),o.l(this.turnServers,(function(e){o.a(e,["urls"])})),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=Object.create(null),this.screenSharingStream=null,this._answerContent=null}r.CALL_TIMEOUT_MS=6e4,r.FALLBACK_ICE_SERVER="stun:turn.matrix.org",r.ERR_LOCAL_OFFER_FAILED="local_offer_failed",r.ERR_NO_USER_MEDIA="no_user_media",r.ERR_UNKNOWN_DEVICES="unknown_devices",r.ERR_SEND_INVITE="send_invite",r.ERR_SEND_ANSWER="send_answer",o.o(r,i.EventEmitter),r.prototype.placeVoiceCall=function(){v("placeVoiceCall"),f(this),b(this,S("voice")),this.type="voice"},r.prototype.placeVideoCall=function(e,t){v("placeVideoCall"),f(this),this.localVideoElement=t,this.remoteVideoElement=e,b(this,S("video")),this.type="video",p(this)},r.prototype.placeScreenSharingCall=async function(e,t){v("placeScreenSharingCall"),f(this),this.localVideoElement=t,this.remoteVideoElement=e;const s=this;try{s.screenSharingStream=await this.webRtc.getDisplayMedia({audio:!1}),v("Got screen stream, requesting audio stream...");const e=S("voice");b(s,e)}catch(e){s.emit("error",_(r.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))}this.type="video",p(this)},r.prototype.playElement=function(e,t){n.a.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return n.a.log("previous promise completed for "+t),e.play()}),(function(){return n.a.log("previous promise failed for "+t),e.play()})):this.mediaPromises[t]=e.play()},r.prototype.pauseElement=function(e,t){n.a.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return n.a.log("previous promise completed for "+t),e.pause()}),(function(){return n.a.log("previous promise failed for "+t),e.pause()})):this.mediaPromises[t]=e.pause()},r.prototype.assignElement=function(e,t,s){n.a.log("queuing assign on "+s+" element "+e+" for "+t),this.mediaPromises[s]?this.mediaPromises[s]=this.mediaPromises[s].then((function(){n.a.log("previous promise completed for "+s),e.srcObject=t}),(function(){n.a.log("previous promise failed for "+s),e.srcObject=t})):e.srcObject=t},r.prototype.getLocalVideoElement=function(){return this.localVideoElement},r.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},r.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},r.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;const t=this;setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)}},r.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,p(this)},r.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,g(this)},r.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=E(this);const t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),w(t,t._onSetRemoteDescriptionSuccess),w(t,t._onSetRemoteDescriptionError)),l(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout((function(){"ringing"==t.state&&(v("Call invite has expired. Hanging up."),t.hangupParty="remote",l(t,"ended"),m(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))}),this.msg.lifetime-e.getAge())},r.prototype._initWithHangup=function(e){this.msg=e.getContent(),l(this,"ended")},r.prototype.answer=function(){v(`Answering call ${this.callId} of type ${this.type}`);const e=this;if(e._answerContent)e._sendAnswer();else if(this.localAVStream||this.waitForLocalAVStream)this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&l(this,"wait_local_media");else{const t=S(this.type);n.a.log("Getting user media with constraints",t),this.webRtc.getUserMedia(t,w(e,e._maybeGotUserMediaForAnswer),w(e,e._maybeGotUserMediaForAnswer)),l(this,"wait_local_media")}},r.prototype._replacedBy=function(e){v(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(v("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):("create_offer"==this.state||"invite_sent"==this.state)&&(v("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},r.prototype.hangup=function(e,t){if("ended"==this.state)return;v("Ending call "+this.callId),h(this,"local",e,!t);const s={version:0,call_id:this.callId,reason:e};d(this,"m.call.hangup",s)},r.prototype.setLocalVideoMuted=function(e){this.localAVStream&&a(this.localAVStream.getVideoTracks(),!e)},r.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!c(this.localAVStream.getVideoTracks())},r.prototype.setMicrophoneMuted=function(e){this.localAVStream&&a(this.localAVStream.getAudioTracks(),!e)},r.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!c(this.localAVStream.getAudioTracks())},r.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)return void this.successor._maybeGotUserMediaForAnswer(e);if("ended"==this.state)return;v("_maybeGotUserMediaForInvite -> "+this.type);const t=this,s=e,n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){const s=this.getLocalVideoElement();s&&"video"==this.type&&(s.autoplay=!0,this.screenSharingStream?(v("Setting screen sharing stream to the local video element"),this.assignElement(s,this.screenSharingStream,"localVideo")):this.assignElement(s,e,"localVideo"),s.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,a(e.getAudioTracks(),!0),this.peerConn=E(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==s.name)return v("Failed to getUserMedia: "+s.name),void this._getUserMediaFailed(s);v("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=E(this)}this.peerConn.createOffer(w(t,t._gotLocalOffer),w(t,t._getLocalOfferFailed),n),l(t,"create_offer")},r.prototype._sendAnswer=function(e){d(this,"m.call.answer",this._answerContent).then(()=>{l(this,"connecting"),y(this)}).catch(e=>{l(this,"ringing"),this.client.cancelPendingEvent(e.event);let t=r.ERR_SEND_ANSWER,s="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=r.ERR_UNKNOWN_DEVICES,s="Unknown devices present in the room"),this.emit("error",_(t,s)),e})},r.prototype._maybeGotUserMediaForAnswer=function(e){const t=this;if("ended"==t.state)return;const s=e;if(e instanceof MediaStream){const s=t.getLocalVideoElement();s&&"video"==t.type&&(s.autoplay=!0,this.assignElement(s,e,"localVideo"),s.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),t.localAVStream=e,a(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==s.name)return v("Failed to getUserMedia: "+s.name),void this._getUserMediaFailed(s);v("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}const n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer((function(e){v("Created answer: ",e),t.peerConn.setLocalDescription(e,(function(){t._answerContent={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}},t._sendAnswer()}),(function(){v("Error setting local description!")}),n)}),(function(e){v("Failed to create answer: "+e)})),l(t,"create_answer")},r.prototype._gotLocalIceCandidate=function(e){if(e.candidate){if(v("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),"ended"==this.state)return;const t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};u(this,t)}},r.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(v("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),(function(){}),(function(e){})))},r.prototype._receivedAnswer=function(e){if("ended"==this.state)return;this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),w(this,this._onSetRemoteDescriptionSuccess),w(this,this._onSetRemoteDescriptionError)),l(this,"connecting")},r.prototype._gotLocalOffer=function(e){const t=this;v("Created offer: ",e),"ended"!=t.state?t.peerConn.setLocalDescription(e,(function(){const e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:r.CALL_TIMEOUT_MS};d(t,"m.call.invite",e).then(()=>{l(t,"invite_sent"),setTimeout((function(){"invite_sent"==t.state&&t.hangup("invite_timeout")}),r.CALL_TIMEOUT_MS)}).catch(e=>{let s=r.ERR_SEND_INVITE,n="Failed to send invite";throw"UnknownDeviceError"==e.name&&(s=r.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.client.cancelPendingEvent(e.event),h(t,"local",s,!1),t.emit("error",_(s,n)),e})}),(function(){v("Error setting local description!")})):v("Ignoring newly created offer on call ID "+t.callId+" because the call has ended")},r.prototype._getLocalOfferFailed=function(e){this.emit("error",_(r.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},r.prototype._getUserMediaFailed=function(e){h(this,"local","user_media_failed",!1),this.emit("error",_(r.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?"))},r.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(v("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(l(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},r.prototype._onSignallingStateChanged=function(){v("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},r.prototype._onSetRemoteDescriptionSuccess=function(){v("Set remote description")},r.prototype._onSetRemoteDescriptionError=function(e){v("Failed to set remote description"+e)},r.prototype._onAddStream=function(e){v("Stream id "+e.stream.id+" added");const t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);const s=this;C(t,(function(e){v("Track id "+e.id+" added"),e.onstarted=w(s,s._onRemoteStreamTrackStarted)})),void 0!==e.stream.oninactive?e.stream.oninactive=w(s,s._onRemoteStreamEnded):e.stream.onended=w(s,s._onRemoteStreamEnded),e.stream.onstarted=w(s,s._onRemoteStreamStarted),"video"===this.type?(p(this),g(this)):g(this)},r.prototype._onRemoteStreamStarted=function(e){l(this,"connected")},r.prototype._onRemoteStreamEnded=function(e){v("Remote stream ended"),this.hangupParty="remote",l(this,"ended"),m(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},r.prototype._onRemoteStreamTrackStarted=function(e){l(this,"connected")},r.prototype._onHangupReceived=function(e){v("Hangup received"),h(this,"remote",e.reason,!0)},r.prototype._onAnsweredElsewhere=function(e){v("Answered elsewhere"),h(this,"remote","answered_elsewhere",!0)};const a=function(e,t){for(let s=0;s<e.length;s++)e[s].enabled=t},c=function(e){for(let t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},l=function(e,t){const s=e.state;e.state=t,e.emit("state",t,s)},d=function(e,t,s){return e.client.sendEvent(e.roomId,t,s)},u=function(e,t){e.candidateSendQueue.push(t),"ringing"!=e.state&&0===e.candidateSendTries&&setTimeout((function(){y(e)}),100)},h=function(e,t,s,n){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=s,l(e,"ended"),m(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),n&&e.emit("hangup",e)},m=function(e){v(`stopAllMedia (stream=${e.localAVStream})`),e.localAVStream&&(C(e.localAVStream,(function(e){e.stop&&e.stop()})),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(C(e.screenSharingStream,(function(e){e.stop&&e.stop()})),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&C(e.remoteAVStream,(function(e){e.stop&&e.stop()})),e.remoteAStream&&C(e.remoteAStream,(function(e){e.stop&&e.stop()}))},p=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){const t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout((function(){const t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},g=async function(e){if(e.getRemoteAudioElement()&&e.remoteAStream){const t=e.getRemoteAudioElement();try{R&&await t.setSinkId(R)}catch(e){n.a.warn("Couldn't set requested audio output device: using default",e)}t.autoplay=!0,e.assignElement(t,e.remoteAStream,"remoteAudio"),setTimeout((function(){const t=e.getRemoteAudioElement();t.play&&e.playElement(t,"remoteAudio"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},f=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},_=function(e,t){const s=new Error(t);return s.code=e,s},v=function(){n.a.log(...arguments)},y=function(e){if(0===e.candidateSendQueue.length)return;const t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;const s={version:0,call_id:e.callId,candidates:t};v("Attempting to send "+t.length+" candidates"),d(e,"m.call.candidates",s).then((function(){e.candidateSendTries=0,y(e)}),(function(s){for(let s=0;s<t.length;s++)e.candidateSendQueue.push(t[s]);if(e.candidateSendTries>5)return v("Failed to send candidates on attempt "+e.candidateSendTries+". Giving up for now."),void(e.candidateSendTries=0);const n=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,v("Failed to send candidates. Retrying in "+n+"ms"),setTimeout((function(){y(e)}),n)}))},b=function(e,t){n.a.log("Getting user media with constraints",t),e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,w(e,e._maybeGotUserMediaForInvite),w(e,e._maybeGotUserMediaForInvite)),l(e,"wait_local_media"),e.direction="outbound",e.config=t},E=function(e){const t=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:e.turnServers});return t.oniceconnectionstatechange=w(e,e._onIceConnectionStateChanged),t.onsignalingstatechange=w(e,e._onSignallingStateChanged),t.onicecandidate=w(e,e._gotLocalIceCandidate),t.onaddstream=w(e,e._onAddStream),t},S=function(t){const s=!!e.window.navigator.webkitGetUserMedia;switch(t){case"voice":return{audio:{deviceId:k?{ideal:k}:void 0},video:!1};case"video":return{audio:{deviceId:k?{ideal:k}:void 0},video:{deviceId:I?{ideal:I}:void 0,width:s?{exact:640}:{ideal:640},height:s?{exact:360}:{ideal:360}}}}},w=function(e,t){return function(){return t.apply(e,arguments)}},C=function(e,t){!function(e,t){const s=e.getVideoTracks();for(let e=0;e<s.length;e++)t(s[e])}(e,t),function(e,t){const s=e.getAudioTracks();for(let e=0;e<s.length;e++)t(s[e])}(e,t)};let R,k,I;function O(e){R=e}function T(e){k=e}function x(e){I=e}function N(t,s,i){const o=e.window,a=e.document;if(!o||!a)return null;const c={isOpenWebRTC:function(){const e=a.getElementById("script");if(!e||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1}},l=o.navigator.getUserMedia||o.navigator.webkitGetUserMedia||o.navigator.mozGetUserMedia;l&&(c.getUserMedia=function(){return l.apply(o.navigator,arguments)});const d=o.navigator.mediaDevices&&o.navigator.mediaDevices.getDisplayMedia||o.navigator.getDisplayMedia;d&&(c.getDisplayMedia=d.bind(o.navigator.mediaDevices));try{c.RtcPeerConnection=o.RTCPeerConnection||o.webkitRTCPeerConnection||o.mozRTCPeerConnection,c.RtcSessionDescription=o.RTCSessionDescription||o.webkitRTCSessionDescription||o.mozRTCSessionDescription,c.RtcIceCandidate=o.RTCIceCandidate||o.webkitRTCIceCandidate||o.mozRTCIceCandidate,c.vendor=null,o.mozRTCPeerConnection?c.vendor="mozilla":o.webkitRTCPeerConnection?c.vendor="webkit":o.RTCPeerConnection&&(c.vendor="generic")}catch(e){return n.a.error("Failed to set up WebRTC object: possible browser interference?"),n.a.error(e),null}if(!(c.RtcIceCandidate&&c.RtcSessionDescription&&c.RtcPeerConnection&&c.getUserMedia))return null;const u=!!i&&i.forceTURN;return new r({webRtc:c,client:t,URL:o.URL,roomId:s,turnServers:t.getTurnServers(),forceTURN:t._forceTURN||u})}}).call(this,s(6))},,,,,,,,,,function(e,t,s){"use strict";let n,i;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(n||(n={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(46),c=s(44),l=s(45),d=s.n(l),u=s(48),h=s(75),m=s(55),p=s(65),g=s(50),f=s(748),_=s.n(f),v=s(59),y=s(54),b=s(245),E=s.n(b);class S extends r.a.Component{constructor(e,t){super(e,t),i()(this,"onRoomRedaction",(e,t)=>{this.unmounted||this.state.events.some(t=>t.getId()===e.getId())&&this.forceUpdate()}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.onQuoteClick=this.onQuoteClick.bind(this),this.canCollapse=this.canCollapse.bind(this),this.collapse=this.collapse.bind(this)}static getParentEventId(e){if(!e||e.isRedacted())return;const t=e.getWireContent()["m.relates_to"];if(t&&t["m.in_reply_to"]){const e=t["m.in_reply_to"];if(e&&e.event_id)return e.event_id}}static stripPlainReply(e){const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}static stripHTMLReply(e){return E()(e,{allowedTags:!1,allowedAttributes:!1,exclusiveFilter:e=>"mx-reply"===e.tag})}static getNestedReplyText(e,t){if(!e)return null;let{body:s,formatted_body:n}=e.getContent();this.getParentEventId(e)&&s&&(s=this.stripPlainReply(s)),s||(s=""),n=n?this.stripHTMLReply(n):_()(s).replace(/\n/g,"<br/>");const i=t.forEvent(e.getId()),o=Object(p.g)(e.getSender()),r=e.getSender();switch(e.getContent().msgtype){case"m.text":case"m.notice":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${r}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`<${r}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}case"m.image":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${r}</a><br>sent an image.</blockquote></mx-reply>`,s=`> <${r}> sent an image.\n\n`;break;case"m.video":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${r}</a><br>sent a video.</blockquote></mx-reply>`,s=`> <${r}> sent a video.\n\n`;break;case"m.audio":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${r}</a><br>sent an audio file.</blockquote></mx-reply>`,s=`> <${r}> sent an audio file.\n\n`;break;case"m.file":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${r}</a><br>sent a file.</blockquote></mx-reply>`,s=`> <${r}> sent a file.\n\n`;break;case"m.emote":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> * <a href="${o}">${r}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`* <${r}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}default:return null}return{body:s,html:n}}static makeReplyMixIn(e){return e?{"m.relates_to":{"m.in_reply_to":{event_id:e.getId()}}}:{}}static makeThread(e,t,s,n,i){return S.getParentEventId(e)?r.a.createElement(S,{parentEv:e,onHeightChanged:t,ref:n,permalinkCreator:s,useIRCLayout:i}):r.a.createElement("div",{className:"mx_ReplyThread_wrapper_empty"})}componentDidMount(){this.unmounted=!1,this.room=this.context.getRoom(this.props.parentEv.getRoomId()),this.room.on("Room.redaction",this.onRoomRedaction),this.room.on("Room.redactionCancelled",this.onRoomRedaction),this.initialize()}componentDidUpdate(){this.props.onHeightChanged()}componentWillUnmount(){this.unmounted=!0,this.room&&(this.room.removeListener("Room.redaction",this.onRoomRedaction),this.room.removeListener("Room.redactionCancelled",this.onRoomRedaction))}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent(S.getParentEventId(e));this.unmounted||(t?this.setState({events:[t]},this.loadNextEvent):this.setState({err:!0}))}async loadNextEvent(){if(this.unmounted)return;const e=this.state.events[0],t=S.getParentEventId(e);if(!t)return void this.setState({loading:!1});const s=await this.getEvent(t);this.unmounted||(s?this.setState({loadedEv:s}):this.setState({err:!0}))}async getEvent(e){const t=this.room.findEventById(e);if(t)return t;try{await this.context.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return this.room.findEventById(e)}canCollapse(){return this.state.events.length>1}collapse(){this.initialize()}onQuoteClick(){const e=[this.state.loadedEv,...this.state.events];this.setState({loadedEv:null,events:e},this.loadNextEvent),u.a.fire(y.a.FocusComposer)}render(){let e=null;if(this.state.err)e=r.a.createElement("blockquote",{className:"mx_ReplyThread mx_ReplyThread_error"},Object(c.a)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv){const t=this.state.loadedEv,s=a.getComponent("elements.Pill"),n=this.context.getRoom(t.getRoomId());e=r.a.createElement("blockquote",{className:"mx_ReplyThread"},Object(c.a)("<a>In reply to</a> <pill>",{},{a:e=>r.a.createElement("a",{onClick:this.onQuoteClick,className:"mx_ReplyThread_show"},e),pill:r.a.createElement(s,{type:s.TYPE_USER_MENTION,room:n,url:Object(p.g)(t.getSender()),shouldShowPillAvatar:g.a.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.state.loading){const t=a.getComponent("elements.Spinner");e=r.a.createElement(t,{w:16,h:16})}const t=a.getComponent("views.rooms.EventTile"),s=a.getComponent("messages.DateSeparator"),n=this.state.events.map(e=>{let n=null;return Object(h.e)(this.props.parentEv.getDate(),e.getDate())&&(n=r.a.createElement("a",{href:this.props.url},r.a.createElement(s,{ts:e.getTs()}))),r.a.createElement("blockquote",{className:"mx_ReplyThread",key:e.getId()},n,r.a.createElement(t,{mxEvent:e,tileShape:"reply",onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,isRedacted:e.isRedacted(),isTwelveHour:g.a.getValue("showTwelveHourTimestamps"),useIRCLayout:this.props.useIRCLayout}))});return r.a.createElement("div",{className:"mx_ReplyThread_wrapper"},r.a.createElement("div",null,e),r.a.createElement("div",null,n))}}i()(S,"propTypes",{parentEv:d.a.instanceOf(m.i),onHeightChanged:d.a.func.isRequired,permalinkCreator:d.a.instanceOf(p.a).isRequired,useIRCLayout:d.a.bool}),i()(S,"contextType",v.a)},function(e,t,s){"use strict";var n=s(10),i=s.n(n);s(102);class o extends i.a{constructor(){super(),this._roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const s=[],n=Object.assign({},this._roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();n[t]&&0===Object.keys(n[t]).length||s.push(e),delete n[t]}return s}roomHasPendingWidgetsOfType(e,t,s){const n=Object.assign({},this._roomWidgetEcho[e]);for(const e of t){delete n[e.getStateKey()]}return void 0===s?Object.keys(n).length>0:Object.values(n).some(e=>s.matches(e.type))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,s){void 0===this._roomWidgetEcho[e]&&(this._roomWidgetEcho[e]={}),this._roomWidgetEcho[e][t]=s,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this._roomWidgetEcho[e][t],0===Object.keys(this._roomWidgetEcho[e]).length&&delete this._roomWidgetEcho[e],this.emit("update",e,t)}}let r=null;r||(r=new o),t.a=r},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"c",(function(){return d}));var n=s(45),i=s.n(n);const o=/^\S+@\S+\.\S+$/,r=/^@\S+:\S+$/,a=/^!\S+:\S+$/,c=["mx-user-id","mx-room-id","email"],l=i.a.shape({addressType:i.a.oneOf(c).isRequired,address:i.a.string.isRequired,displayName:i.a.string,avatarMxc:i.a.string,isKnown:i.a.bool});function d(e){const t=o.test(e),s=r.test(e),n=a.test(e);return t?"email":s?"mx-user-id":n?"mx-room-id":null}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));var n=s(66),i=s.n(n);function o(e){if(!e)return"";const t=i.a.parse(e);return t&&"/"===t.path?t.host:e}function r(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===i.a.parse(t).hostname?e:t}},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return c}));var n=s(2),i=s.n(n),o=s(10),r=s(174);const a="update";class c extends o.EventEmitter{constructor(...e){super(...e),i()(this,"_symbol",void 0),i()(this,"_count",void 0),i()(this,"_color",void 0)}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=r.a.None}get isUnread(){return this.color>=r.a.Bold}get hasUnreadCount(){return this.color>=r.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=r.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(a)}snapshot(){return new l(this)}destroy(){this.removeAllListeners(a)}}class l{constructor(e){i()(this,"symbol",void 0),i()(this,"count",void 0),i()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},s={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(80),h=s(127),m=s(457),p=s(47),g=s(49),f=s(209);class _ extends d.a.Component{constructor(e){super(e),c()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&this.setState({urls:_.getImageUrls(this.props)})}),c()(this,"onRoomAvatarClick",()=>{const e={src:f.b(this.props.room,null,null,null),name:this.props.room.name};g.a.createDialog(m.a,e,"mx_Dialog_lightbox")}),this.state={urls:_.getImageUrls(this.props)}}componentDidMount(){p.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=p.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}static getDerivedStateFromProps(e){return{urls:_.getImageUrls(e)}}static getImageUrls(e){return[Object(u.a)(p.a.get().getHomeserverUrl(),e.oobData.avatarUrl,Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod),_.getRoomAvatarUrl(e)].filter((function(e){return null!==e&&""!==e}))}static getRoomAvatarUrl(e){return e.room?f.b(e.room,Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod):null}render(){const e=this.props,{room:t,oobData:s,viewAvatarOnClick:n}=e,o=r()(e,["room","oobData","viewAvatarOnClick"]),a=t?t.name:s.name;return d.a.createElement(h.a,i()({},o,{name:a,idName:t?t.roomId:null,urls:this.state.urls,onClick:n&&this.state.urls[0]?this.onRoomAvatarClick:null}))}}c()(_,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}})},function(e,t,s){"use strict";(function(e){var n=s(62),i=s(821),o=s(50),r=s(57);class a{constructor(){this.index=null,this._supportIsInstalled=!1}async init(){const e=n.a.get().getEventIndexingManager();return e?(this._supportIsInstalled=await e.supportsEventIndexing(),this.supportIsInstalled()?o.a.getValueAt(r.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(console.log("EventIndex: Event indexing is disabled, not initializing"),!1):(console.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(console.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){const e=new i.a,t=n.a.get().getEventIndexingManager();try{await t.initEventIndex();const s=await t.getUserVersion(),n=await t.isEventIndexEmpty();n?await t.setUserVersion(1):0!==s||n||(await t.closeEventIndex(),await this.deleteEventIndex(),await t.initEventIndex(),await t.setUserVersion(1)),console.log("EventIndex: Successfully initialized the event index"),await e.init()}catch(e){return console.log("EventIndex: Error initializing the event index",e),!1}return this.index=e,!0}platformHasSupport(){return null!==n.a.get().getEventIndexingManager()}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){const e=n.a.get().getEventIndexingManager();null!==e&&(await this.unset(),console.log("EventIndex: Deleting event index."),await e.deleteEventIndex())}}e.mxEventIndexPeg||(e.mxEventIndexPeg=new a),t.a=e.mxEventIndexPeg}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this._timeout=e,this._onTimeout=this._onTimeout.bind(this),this._setNotStarted()}_setNotStarted(){this._timerHandle=null,this._startTs=null,this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}).finally(()=>{this._timerHandle=null})}_onTimeout(){const e=Date.now()-this._startTs;if(e>=this._timeout)this._resolve(),this._setNotStarted();else{const t=this._timeout-e;this._timerHandle=setTimeout(this._onTimeout,t)}}changeTimeout(e){if(e===this._timeout)return;const t=e<this._timeout;this._timeout=e,this.isRunning()&&t&&(clearTimeout(this._timerHandle),this._onTimeout())}start(){return this.isRunning()||(this._startTs=Date.now(),this._timerHandle=setTimeout(this._onTimeout,this._timeout)),this}restart(){return this.isRunning()?(this._startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this._timerHandle),this._reject(new Error("Timer was aborted.")),this._setNotStarted()),this}finished(){return this._promise}isRunning(){return null!==this._timerHandle}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(46);function i(e,t){return()=>n.getComponent(e)||t}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"d",(function(){return u}));var n=s(2),i=s.n(n),o=s(48),r=s(54),a=s(336);const c="mx_sso_hs_url",l="mx_sso_is_url";let d;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(d||(d={}));class u{constructor(){i()(this,"notificationCount",0),i()(this,"errorDidOccur",!1),i()(this,"onAction",e=>{switch(e.action){case"on_client_not_viable":case"on_logged_out":this.setNotificationCount(0)}}),o.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(a.a)(),localStorage.removeItem("mx_defer_update"),o.a.dispatch({action:r.a.CheckUpdates,status:d.Checking})}installUpdate(){}shouldShowUpdate(e){try{const[t,s]=JSON.parse(localStorage.getItem("mx_defer_update"));return e!==t||Date.now()>s}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem("mx_defer_update",JSON.stringify([e,t.getTime()])),Object(a.a)()}supportsNotifications(){return!1}maySendNotifications(){return!1}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}screenCaptureErrorString(){return"Not implemented"}supportsAutoLaunch(){return!1}async getAutoLaunchEnabled(){return!1}async setAutoLaunchEnabled(e){throw new Error("Unimplemented")}supportsAutoHideMenuBar(){return!1}async getAutoHideMenuBarEnabled(){return!1}async setAutoHideMenuBarEnabled(e){throw new Error("Unimplemented")}supportsMinimizeToTray(){return!1}async getMinimizeToTrayEnabled(){return!1}async setMinimizeToTrayEnabled(e){throw new Error("Unimplemented")}getEventIndexingManager(){return null}setLanguage(e){}getSSOCallbackUrl(e){const t=new URL(window.location.href);return t.hash=e||"",t}startSingleSignOn(e,t,s){localStorage.setItem(c,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(l,e.getIdentityServerUrl());const n=this.getSSOCallbackUrl(s);window.location.href=e.getSsoLoginUrl(n.toString(),t)}onKeyDown(e){return!1}async getPickleKey(e,t){return null}async createPickleKey(e,t){return null}async destroyPickleKey(e,t){}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(43),i=s.n(n),o=s(44),r=s(50);class a extends i.a.Component{render(){const e=this.props.w||16,t=this.props.h||16,n=this.props.imgClassName||"";let a;return a=r.a.getValue("feature_new_spinner")?s(468):s(469),i.a.createElement("div",{className:"mx_InlineSpinner"},i.a.createElement("img",{src:a,width:e,height:t,className:n,"aria-label":Object(o.a)("Loading...")}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(63);function i(e,t){const s=Object(n.throttle)(e,t,{leading:!0,trailing:!0}),i=s.bind;return s.bind=function(){const e=i.apply(s,arguments);return e.cancelPendingCall=s.cancelPendingCall,e},s.cancelPendingCall=function(){s.cancel()},s}},,function(e,t){e.exports="img/warning.05cc423.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(43),i=s.n(n),o=s(51),r=s.n(o);function a({description:e,rules:t}){return async function({value:s,focused:n,allowEmpty:o=!0}){if(!s&&o)return{valid:null,feedback:null};const a=[];let c,l,d,u=!0;if(t&&t.length)for(const e of t){if(!e.key||!e.test)continue;if(!u&&e.final)continue;const t={value:s,allowEmpty:o};if(e.skip&&e.skip.call(this,t))continue;const n=await e.test.call(this,t);if(u=u&&n,n&&e.valid){const t=e.valid.call(this);if(!t)continue;a.push({key:e.key,valid:!0,text:t})}else if(!n&&e.invalid){const t=e.invalid.call(this);if(!t)continue;a.push({key:e.key,valid:!1,text:t})}}if(!n)return{valid:u,feedback:null};if(a&&a.length&&(c=i.a.createElement("ul",{className:"mx_Validation_details"},a.map(e=>{const t=r()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return i.a.createElement("li",{key:e.key,className:t},e.text)}))),e){const t=e.call(this);l=i.a.createElement("div",{className:"mx_Validation_description"},t)}return(l||c)&&(d=i.a.createElement("div",{className:"mx_Validation"},l,c)),{valid:u,feedback:d}}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(10),i=s(265),o=s(107),r=s(80),a=s(1),c=s(81),l=s(156);function d(e,t){this.roomId=e,this.info=t}var u=s(0),h=s(273);const m=["1","2","3","4","5"];function p(e,t,s){const n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][s]={},n.content[t.getId()][s][e]={ts:t.getTs()},new c.b(n)}function g(e,t,s,n){if((n=n||{}).pendingEventOrdering=n.pendingEventOrdering||"chronological",this.setMaxListeners(100),this.reEmitter=new h.a(this),-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");this.myUserId=s,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=n.storageToken,this._opts=n,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new i.a(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._client=t,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=Promise.resolve()}a.o(g,n.EventEmitter),g.prototype.getVersion=function(){const e=this.currentState.getStateEvents("m.room.create","");if(!e)return u.a.warn("Room "+this.roomId+" does not have an m.room.create event"),"1";const t=e.getContent().room_version;return void 0===t?"1":t},g.prototype.shouldUpgradeToVersion=function(){return m.includes(this.getVersion())?null:"5"},g.prototype.getRecommendedVersion=async function(){let e=(await this._client.getCapabilities())["m.room_versions"];if(!e){e={default:"5",available:{}};for(const t of m)e.available[t]="stable"}let t=this._checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){u.a.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this._client.getCapabilities(!0))["m.room_versions"],!e)return u.a.warn("No room version capability - assuming upgrade required."),t;t=this._checkVersionAgainstCapability(e)}return t},g.prototype._checkVersionAgainstCapability=function(e){const t=this.getVersion();u.a.log(`[${this.roomId}] Current version: ${t}`),u.a.log(`[${this.roomId}] Version capability: `,e);const s={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return s;return Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(s.version=e.default,s.needsUpgrade=!0,s.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),s.urgent?u.a.warn("URGENT upgrade required on "+this.roomId):u.a.warn("Non-urgent upgrade required on "+this.roomId)),s},g.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},g.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},g.prototype.hasPendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call hasPendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList.some(t=>t.getId()===e)},g.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},g.prototype.getLastActiveTimestamp=function(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER},g.prototype.getMyMembership=function(){return this._selfMembership},g.prototype.getDMInviter=function(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length)return this._summaryHeroes[0]}},g.prototype.guessDMUserId=function(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId},g.prototype.getAvatarFallbackMember=function(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(e){const e=this._summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this._summaryHeroes.map(e=>this._client.getUser(e)).find(e=>!!e);if(e){const t=new l.a(this.roomId,e.userId);return t.user=e,t}}},g.prototype.updateMyMembership=function(e){const t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},g.prototype._loadMembersFromServer=async function(){const e=this._client.store.getSyncToken(),t=a.e({not_membership:"leave",at:e}),s=a.f("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),n=this._client._http;return(await n.authedRequest(void 0,"GET",s)).chunk},g.prototype._loadMembers=async function(){let e=!1,t=await this._client.store.getOutOfBandMembers(this.roomId);null===t&&(e=!0,t=await this._loadMembersFromServer(),u.a.log(`LL: got ${t.length} members from server for room `+this.roomId));return{memberEvents:t.map(this._client.getEventMapper()),fromServer:e}},g.prototype.loadMembersIfNeeded=function(){if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this._loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this._client.isCryptoEnabled()&&this._client.isRoomEncrypted(this.roomId)&&this._client._crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this._membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);u.a.log("LL: telling store to write "+e.length+" members for room "+this.roomId);return this._client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{u.a.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{u.a.error(e)}),this._membersPromise=e,this._membersPromise},g.prototype.clearLoadedMembersIfNeeded=async function(){this._opts.lazyLoadMembers&&this._membersPromise&&(await this.loadMembersIfNeeded(),await this._client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this._membersPromise=null)},g.prototype._cleanupAfterLeaving=function(){this.clearLoadedMembersIfNeeded().catch(e=>{u.a.error(`error after clearing loaded members from room ${this.roomId} after leaving`),u.a.log(e)})},g.prototype.resetLiveTimeline=function(e,t){for(let s=0;s<this._timelineSets.length;s++)this._timelineSets[s].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},g.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(o.a.BACKWARDS),this.currentState=this.getLiveTimeline().getState(o.a.FORWARDS)},g.prototype.hasUnverifiedDevices=async function(){if(!this._client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this._client.getStoredDevicesForUser(t.userId).some(e=>e.isUnverified()))return!0}return!1},g.prototype.getTimelineSets=function(){return this._timelineSets},g.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},g.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},g.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},g.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},g.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},g.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},g.prototype.setSummary=function(e){const t=e["m.heroes"],s=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(s)&&this.currentState.setJoinedMemberCount(s),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this._summaryHeroes=t.filter(e=>e!==this.myUserId))},g.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},g.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},g.prototype.getAvatarUrl=function(e,t,s,n,i){const o=this.currentState.getStateEvents("m.room.avatar","");if(void 0===i&&(i=!0),!o&&!i)return null;const a=o?o.getContent().url:null;return a?Object(r.a)(e,a,t,s,n):null},g.prototype.getAliases=function(){const e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(let s=0;s<t.length;++s){const n=t[s];if(a.p(n.getContent().aliases)){const t=n.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":"+n.getStateKey())));Array.prototype.push.apply(e,t)}}return e},g.prototype.getCanonicalAlias=function(){const e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alias||null},g.prototype.getAltAliases=function(){const e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alt_aliases||[]},g.prototype.addEventsToTimeline=function(e,t,s,n){s.getTimelineSet().addEventsToTimeline(e,t,s,n)},g.prototype.getMember=function(e){return this.currentState.getMember(e)},g.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},g.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},g.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},g.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},g.prototype.getMembersWithMembership=function(e){return a.j(this.currentState.getMembers(),(function(t){return t.membership===e}))},g.prototype.getEncryptionTargetMembers=async function(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e},g.prototype.shouldEncryptForInvitedMembers=function(){const e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},g.prototype.getDefaultRoomName=function(e){return _(this,e,!0)},g.prototype.hasMembershipState=function(e,t){const s=this.getMember(e);return!!s&&s.membership===t},g.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];const t=Object.assign({filter:e},this._opts),s=new i.a(this,t);this.reEmitter.reEmit(s,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=s,this._timelineSets.push(s);const n=this.getLiveTimeline();n.getEvents().forEach((function(e){s.addLiveEvent(e)}));let r=n;for(;r.getNeighbouringTimeline(o.a.BACKWARDS);)r=r.getNeighbouringTimeline(o.a.BACKWARDS);return s.getLiveTimeline().setPaginationToken(r.getPaginationToken(o.a.BACKWARDS),o.a.BACKWARDS),s},g.prototype.removeFilteredTimelineSet=function(e){const t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];const s=this._timelineSets.indexOf(t);s>-1&&this._timelineSets.splice(s,1)},g.prototype._addLiveEvent=function(e,t,s){if(e.isRedaction()){const t=e.event.redacts,s=this.getUnfilteredTimelineSet().findEventById(t);if(s){if(s.makeRedacted(e),s.getStateKey()){this.currentState.getStateEvents(s.getType(),s.getStateKey()).getId()===s.getId()&&this.currentState.setStateEvents([s])}this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){const t=this._txnToEvent[e.getUnsigned().transaction_id];if(t)return void this._handleRemoteEcho(e,t)}for(let n=0;n<this._timelineSets.length;n++)this._timelineSets[n].addLiveEvent(e,t,s);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(p(e.sender.userId,e,"m.read"),!0)},g.prototype.addPendingEvent=function(e,t){if(e.status!==c.a.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(o.a.setEventMetadata(e,this.getLiveTimeline().getState(o.a.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some(e=>e.status===c.a.NOT_SENT)&&(u.a.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(c.a.NOT_SENT)),this._pendingEventList.push(e),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let s=this._pendingEventList&&this._pendingEventList.find(e=>e.getId()===t);s||(s=this.getUnfilteredTimelineSet().findEventById(t)),s&&(s.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(let t=0;t<this._timelineSets.length;t++){const s=this._timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.addEventToTimeline(e,s.getLiveTimeline(),!1):s.addEventToTimeline(e,s.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},g.prototype._aggregateNonLiveRelation=function(e){for(let t=0;t<this._timelineSets.length;t++){const s=this._timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.aggregateRelations(e):s.aggregateRelations(e)}},g.prototype._handleRemoteEcho=function(e,t){const s=t.getId(),n=e.getId(),i=t.status;u.a.debug(`Got remote echo for event ${s} -> ${n} old status `+i),delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&a.y(this._pendingEventList,(function(e){return e.getId()==s}),!1),t.handleRemoteEcho(e.event);for(let e=0;e<this._timelineSets.length;e++){this._timelineSets[e].handleRemoteEcho(t,s,n)}this.emit("Room.localEchoUpdated",t,this,s,i)};const f={};function _(e,t,s){if(!s){const t=e.currentState.getStateEvents("m.room.name","");if(t&&t.getContent()&&t.getContent().name)return t.getContent().name}let n=e.getCanonicalAlias();if(!n){const t=e.getAltAliases();t.length&&(n=t[0])}if(n)return n;const i=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1;let o=null;if(e._summaryHeroes)o=e._summaryHeroes.map(t=>{const s=e.getMember(t);return s?s.name:t});else{let s=e.currentState.getMembers().filter(e=>e.userId!==t&&("invite"===e.membership||"join"===e.membership));s.sort((e,t)=>e.userId.localeCompare(t.userId)),s=s.slice(0,5),o=s.map(e=>e.name)}if(i)return v(o,i);if("join"==e.getMyMembership()){const t=e.currentState.getStateEvents("m.room.third_party_invite");if(t&&t.length){return"Inviting "+v(t.map(e=>e.getContent().display_name))}}let r=o;return r.length||(r=e.currentState.getMembers().filter(e=>e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership).map(e=>e.name)),r.length?`Empty room (was ${v(r)})`:"Empty room"}function v(e,t=e.length+1){const s=t-1;if(e.length){if(1===e.length&&s<=1)return e[0];if(2===e.length&&s<=2)return`${e[0]} and ${e[1]}`;return s>1?`${e[0]} and ${s} others`:e[0]+" and 1 other"}return"Empty room"}f[c.a.ENCRYPTING]=[c.a.SENDING,c.a.NOT_SENT],f[c.a.SENDING]=[c.a.ENCRYPTING,c.a.QUEUED,c.a.NOT_SENT,c.a.SENT],f[c.a.QUEUED]=[c.a.SENDING,c.a.CANCELLED],f[c.a.SENT]=[],f[c.a.NOT_SENT]=[c.a.SENDING,c.a.QUEUED,c.a.CANCELLED],f[c.a.CANCELLED]=[],g.prototype.updatePendingEvent=function(e,t,s){if(u.a.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${s}`),t==c.a.SENT&&!s)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==c.a.SENT){if(this.getUnfilteredTimelineSet().eventIdToTimeline(s))return}const n=e.status,i=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=f[n];if(!o||o.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==c.a.SENT){e.replaceLocalEventId(s);for(let e=0;e<this._timelineSets.length;e++)this._timelineSets[e].replaceEventId(i,s)}else if(t==c.a.CANCELLED){if(this._pendingEventList){const e=this._pendingEventList.findIndex(e=>e.getId()===i);if(-1!==e){const[t]=this._pendingEventList.splice(e,1);t.isRedaction()&&this._revertRedactionLocalEcho(t)}}this.removeEvent(i)}this.emit("Room.localEchoUpdated",e,this,i,n)},g.prototype._revertRedactionLocalEcho=function(e){const t=e.event.redacts;if(!t)return;const s=this.getUnfilteredTimelineSet().findEventById(t);s&&(s.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),s.isRelation()&&this._aggregateNonLiveRelation(s))},g.prototype.addLiveEvents=function(e,t,s){let n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){const e=this._timelineSets[n].getLiveTimeline();if(e.getPaginationToken(o.a.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+e.getPaginationToken(o.a.FORWARDS)+")");if(e.getNeighbouringTimeline(o.a.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this._addLiveEvent(e[n],t,s)},g.prototype.addEphemeralEvents=function(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)},g.prototype.removeEvents=function(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])},g.prototype.removeEvent=function(e){let t=!1;for(let s=0;s<this._timelineSets.length;s++){const n=this._timelineSets[s].removeEvent(e);n&&(n.isRedaction()&&this._revertRedactionLocalEcho(n),t=!0)}return t},g.prototype.recalculate=function(){const e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);if(t&&"invite"===t.getContent().membership){const s=t.event.invite_room_state||[];a.l(s,(function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new c.b({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}))}const s=this.name;this.name=_(this,this.myUserId),this.summary=new d(this.roomId,{title:this.name}),s!==this.name&&this.emit("Room.name",this)},g.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},g.prototype.getEventReadUpTo=function(e,t){let s=this._receipts;return t&&(s=this._realReceipts),void 0===s["m.read"]||void 0===s["m.read"][e]?null:s["m.read"][e].eventId},g.prototype.hasUserReadEvent=function(e,t){const s=this.getEventReadUpTo(e,!1);if(s===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const n=this.timeline[e];if(n.getId()===t)return!1;if(n.getId()===s)return!0}return!1},g.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},g.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},g.prototype._addReceiptsToStructure=function(e,t){const s=this;a.t(e.getContent()).forEach((function(n){a.t(e.getContent()[n]).forEach((function(i){a.t(e.getContent()[n][i]).forEach((function(o){const r=e.getContent()[n][i][o];t[i]||(t[i]={});const a=t[i][o];if(a){const e=s.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,n);if(null!==e&&e>=0)return}else t[i][o]={};t[i][o]={eventId:n,data:r}}))}))}))},g.prototype._buildReceiptCache=function(e){const t={};return a.t(e).forEach((function(s){a.t(e[s]).forEach((function(n){const i=e[s][n];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:n,type:s,data:i.data})}))})),t},g.prototype._addLocalEchoReceipt=function(e,t,s){this.addReceipt(p(e,t,s),!0)},g.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},g.prototype.addAccountData=function(e){for(let t=0;t<e.length;t++){const s=e[t];"m.tag"===s.getType()&&this.addTags(s);const n=this.accountData[s.getType()];this.accountData[s.getType()]=s,this.emit("Room.accountData",s,this,n)}},g.prototype.getAccountData=function(e){return this.accountData[e]},g.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(133),i=s(1);function o(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}function r(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}r.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return i.B(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));const t=this;e.currentState.getMembers().forEach((function(s){t._onRoomMember(null,e.currentState,s)}))},_onRoomMember:function(e,t,s){if("invite"===s.membership)return;const i=this.users[s.userId]||new n.a(s.userId);s.name&&(i.setDisplayName(s.name),s.events.member&&i.setRawDisplayName(s.events.member.getDirectionalContent().displayname)),s.events.member&&s.events.member.getContent().avatar_url&&i.setAvatarUrl(s.events.member.getContent().avatar_url),this.users[i.userId]=i},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return i.B(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return i.u(i.B(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return i.B(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,s,n){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(o(e))return e}catch(e){}return null},setFilterIdByName:function(e,t){if(!this.localStorage)return;const s="mxjssdk_memory_filter_"+e;try{o(t)?this.localStorage.setItem(s,t):this.localStorage.removeItem(s)}catch(e){}},storeAccountDataEvents:function(e){const t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(269),i=s.n(n),o=s(0),r=s(1);function a(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?a(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class l{constructor(){this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._privateKeys={},this._backupKeys={},this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={}}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return r.x(()=>{const s=this._getOutgoingRoomKeyRequest(t);return s?(o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),s):(o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this._outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this._outgoingRoomKeyRequests)if(r.b(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this._outgoingRoomKeyRequests)for(const s of e)if(t.state===s)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this._outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,s){const n=[];for(const i of this._outgoingRoomKeyRequests)for(const o of s)i.state===o&&i.recipients.includes({userId:e,deviceId:t})&&n.push(i);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,s){for(const n of this._outgoingRoomKeyRequests)if(n.requestId===e)return n.state!=t?(o.a.warn(`Cannot update room key request from ${t} as it was already updated to `+n.state),Promise.resolve(null)):(Object.assign(n,s),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let s=0;s<this._outgoingRoomKeyRequests.length;s++){const n=this._outgoingRoomKeyRequests[s];if(n.requestId===e)return n.state!=t?(o.a.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(s,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this._account)}storeAccount(e,t){this._account=t}getCrossSigningKeys(e,t){t(this._crossSigningKeys)}getSecretStorePrivateKey(e,t,s){return t(this._privateKeys[s]||null)}storeCrossSigningKeys(e,t){this._crossSigningKeys=t}storeSecretStorePrivateKey(e,t,s){this._privateKeys[t]=s}countEndToEndSessions(e,t){return Object.keys(this._sessions).length}getEndToEndSession(e,t,s,n){n((this._sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,s){s(this._sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this._sessions).forEach(([e,s])=>{Object.entries(s).forEach(([s,n])=>{t(c(c({},n),{},{deviceKey:e,sessionId:s}))})})}storeEndToEndSession(e,t,s,n){let i=this._sessions[e];void 0===i&&(i={},this._sessions[e]=i),i[t]=s}async storeEndToEndSessionProblem(e,t,s){const n=this._sessionProblems[e]=this._sessionProblems[e]||[];n.push({type:t,fixed:s,time:Date.now()}),n.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const s=this._sessionProblems[e]||[];if(!s.length)return null;const n=s[s.length-1];for(const e of s)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this._notifiedErrorDevices,s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return s}getEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;n(this._inboundGroupSessions[i]||null,this._inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this._inboundGroupSessions))t({senderKey:e.substr(0,43),sessionId:e.substr(44),sessionData:this._inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;void 0===this._inboundGroupSessions[i]&&(this._inboundGroupSessions[i]=s)}storeEndToEndInboundGroupSession(e,t,s,n){this._inboundGroupSessions[e+"/"+t]=s}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){const i=e+"/"+t;this._inboundGroupSessionsWithheld[i]=s}getEndToEndDeviceData(e,t){t(this._deviceData)}storeEndToEndDeviceData(e,t){this._deviceData=e}storeEndToEndRoom(e,t,s){this._rooms[e]=t}getEndToEndRooms(e,t){t(this._rooms)}getSessionsNeedingBackup(e){const t=[];for(const s in this._sessionsNeedingBackup)if(this._inboundGroupSessions[s]&&(t.push({senderKey:s.substr(0,43),sessionId:s.substr(44),sessionData:this._inboundGroupSessions[s]}),e&&s.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this._sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this._sessionsNeedingBackup[e]=!0}return Promise.resolve()}doTxn(e,t,s){return Promise.resolve(s(null))}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return T})),s.d(t,"b",(function(){return j}));var n=s(66),i=s.n(n),o=s(10),r=s(572),a=s(266),c=s(575),l=s(81),d=s(107),u=s(1157),h=s(576),m=s(159),p=s(1),g=s(192),f=s(80),_=s(371),v=s(85),y=s(273),b=s(577),E=s(0),S=s(227),w=s(278),C=s(277),R=s(12),k=s(157),I=s(133),O=s(230);const T=Object(S.c)();function x(e,t,s){const n=[];for(const[i,o]of Object.entries(e))try{const e=N(o,t);e.session_id=i,e.room_id=s,n.push(e)}catch(e){E.a.log("Failed to decrypt megolm session from backup",e)}return n}function N(e,t){return JSON.parse(t.decrypt(e.session_data.ephemeral,e.session_data.mac,e.session_data.ciphertext))}function j(e){e.baseUrl=p.g(e.baseUrl),e.idBaseUrl=p.g(e.idBaseUrl),r.a.call(this,e),this.olmVersion=null,this.reEmitter=new y.a(this),this.store=e.store||new h.a,this.deviceId=e.deviceId||null;const t=e.userId||null;if(this.credentials={userId:t},e.deviceToImport?this.deviceId?E.a.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?E.a.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this._exportedOlmDeviceToImport=e.deviceToImport.olmDevice):E.a.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler){const e=this;this.scheduler.setProcessFunction((async function(t){const s=e.getRoom(t.getRoomId());t.status!==l.a.SENDING&&U(s,t,l.a.SENDING);const n=await M(e,t);return s&&s.updatePendingEvent(t,l.a.SENT,n.event_id),n}))}this.clientRunning=!1,this.callList={};const s=Object(m.a)(this);this._supportsVoip=!1,s&&(!function(e){const t={};let s=[];function n(){if("SYNCING"===e.getSyncState()){if(s.some(e=>e.isBeingDecrypted()))return;const e={};for(let t=s.length-1;t>=0;t--){const n=s[t];"m.call.answer"!==n.getType()&&"m.call.hangup"!==n.getType()||(e[n.getContent().call_id]="yep")}s.forEach((function(t){"m.call.invite"===t.getType()&&e[t.getContent().call_id]||i(t)})),s=[]}}function i(s){const n=s.getContent();let i,o=n.call_id?e.callList[n.call_id]:void 0;if("m.call.invite"===s.getType()){if(s.getSender()===e.credentials.userId)return;if(s.getAge()>n.lifetime)return;if(o&&"ended"===o.state)return;if(o&&E.a.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",n.call_id),o=Object(m.a)(e,s.getRoomId(),{forceTURN:e._forceTURN}),!o)return void E.a.log("Incoming call ID "+n.call_id+" but this client doesn't support WebRTC");if(o.callId=n.call_id,o._initWithInvite(s),e.callList[o.callId]=o,t[o.callId])for(i=0;i<t[o.callId].length;i++)o._gotRemoteIceCandidate(t[o.callId][i]);let r;const a=p.B(e.callList);for(i=0;i<a.length;++i){const e=a[i];if(o.roomId===e.roomId&&"outbound"===e.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(e.state)){r=e;break}}r?"wait_local_media"===r.state||"create_offer"===r.state||r.callId>o.callId?(E.a.log("Glare detected: answering incoming call "+o.callId+" and canceling outgoing call "+r.callId),r._replacedBy(o),o.answer()):(E.a.log("Glare detected: rejecting incoming call "+o.callId+" and keeping outgoing call "+r.callId),o.hangup()):e.emit("Call.incoming",o)}else if("m.call.answer"===s.getType()){if(!o)return;s.getSender()===e.credentials.userId?"ringing"===o.state&&o._onAnsweredElsewhere(n):o._receivedAnswer(n)}else if("m.call.candidates"===s.getType()){if(s.getSender()===e.credentials.userId)return;if(o)for(i=0;i<n.candidates.length;i++)o._gotRemoteIceCandidate(n.candidates[i]);else t[n.call_id]||(t[n.call_id]=[]),t[n.call_id]=t[n.call_id].concat(n.candidates)}else"m.call.hangup"===s.getType()&&(o?"ended"!==o.state&&(o._onHangupReceived(n),delete e.callList[n.call_id]):(o=Object(m.a)(e,s.getRoomId()),o&&(o.callId=n.call_id,o._initWithHangup(s),e.callList[n.call_id]=o)))}e.on("sync",n),e.on("event",(function(e){(0===e.getType().indexOf("m.call.")||e.isBeingDecrypted())&&s.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",()=>{-1!==e.getType().indexOf("m.call.")&&(s.includes(e)?n():i(e))})}))}(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this._crypto=null,this._cryptoStore=e.cryptoStore,this._sessionStore=e.sessionStore,this._verificationMethods=e.verificationMethods,this._cryptoCallbacks=e.cryptoCallbacks||{},this._forceTURN=e.forceTURN||!1,this._fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this._roomList=new b.a(this._cryptoStore),this._pushProcessor=new k.a(this),this._serverVersionsCache=null,this._cachedCapabilities=null,this._clientWellKnown=void 0,this._clientWellKnownPromise=void 0,this.on("Event.decrypted",e=>{const t=e.getPushActions(),s=this._pushProcessor.actionsForEvent(e);e.setPushActions(s);const n=this.getRoom(e.getRoomId());if(!n)return;const i=n.getUnreadNotificationCount("highlight"),o=!(!t||!t.tweaks)&&!!t.tweaks.highlight,r=!(!s||!s.tweaks)&&!!s.tweaks.highlight;if((o!==r||i>0)&&!n.hasUserReadEvent(this.getUserId(),e.getId())){let e=i;r&&!o&&e++,!r&&o&&e--,n.setUnreadNotificationCount("highlight",e);n.getUnreadNotificationCount("total")<e&&n.setUnreadNotificationCount("total",e)}}),this.on("Room.receipt",(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const s=e.getContent();if(!(Object.keys(s).filter(e=>Object.keys(s[e]["m.read"]).includes(this.getUserId())).length>0))return;const n=20,i=t.getLiveTimeline().getEvents();let o=0;for(let e=i.length-1;e>=0;e--){if(e===i.length-n)return;const s=i[e];if(t.hasUserReadEvent(this.getUserId(),s.getId()))break;const r=this.getPushActionsForEvent(s);o+=r.tweaks&&r.tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",o)}})}async function P(e,t,s,n,i,o){if(!e._crypto)throw new Error("End-to-End encryption disabled");await e._crypto.setDeviceVerification(t,s,n,i,o)}function D(e,t){for(const s of t)e.prototype[s]=function(...e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto[s](...e)}}function A(e,t,s,n){return Promise.resolve().then((function(){const n=function(e,t,s){if(t.isEncrypted())return null;if(!e.isRoomEncrypted(t.getRoomId()))return null;if("m.reaction"===t.getType())return null;if(!e._crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return e._crypto.encryptEvent(t,s)}(e,s,t);return n?(U(t,s,l.a.ENCRYPTING),n.then(()=>{U(t,s,l.a.SENDING)})):null})).then((function(){let n;return e.scheduler&&(n=e.scheduler.queueEvent(s),n&&e.scheduler.getQueueForEvent(s).length>1&&U(t,s,l.a.QUEUED)),n||(n=M(e,s),t&&(n=n.then(e=>(t.updatePendingEvent(s,l.a.SENT,e.event_id),e)))),n})).then((function(e){return n&&n(null,e),e}),(function(e){E.a.error("Error sending event",e.stack||e);try{s.error=e,U(t,s,l.a.NOT_SENT),e.event=s,n&&n(e)}catch(t){E.a.error("Exception in error handler!",t.stack||e)}throw e}))}function U(e,t,s){e?e.updatePendingEvent(t,s):t.setStatus(s)}function M(e,t){let s=t.getTxnId();s||(s=e.makeTxnId(),t.setTxnId(s));const n={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:s};let i;if(t.isState()){let e="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(e="/rooms/$roomId/state/$eventType/$stateKey"),i=p.f(e,n)}else if(t.isRedaction()){const e="/rooms/$roomId/redact/$redactsEventId/$txnId";i=p.f(e,Object.assign({$redactsEventId:t.event.redacts},n))}else i=p.f("/rooms/$roomId/send/$eventType/$txnId",n);return e._http.authedRequest(void 0,"PUT",i,void 0,t.getWireContent()).then(e=>(E.a.log(`Event sent to ${t.getRoomId()} with event id ${e.event_id}`),e))}function L(e,t,s,n,i,o){p.q(i)&&(o=i,i=void 0);const r=p.f("/rooms/$room_id/$membership",{$room_id:t,$membership:n});return e._http.authedRequest(o,"POST",r,void 0,{user_id:s,reason:i})}function F(e,t,s){e&&e(s),t(s)}function B(e,t,s){e&&e(null,s),t(s)}function V(e,t){const s=Boolean(t&&t.preventReEmit);return function(t){const n=new l.b(t);n.isEncrypted()&&(s||e.reEmitter.reEmit(n,["Event.decrypted"]),n.attemptDecryption(e._crypto));const i=e.getRoom(n.getRoomId());return i&&!s&&i.reEmitter.reEmit(n,["Event.replaced"]),n}}p.o(j,o.EventEmitter),p.i(j.prototype,r.a.prototype),j.prototype.exportDevice=async function(){if(this._crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this._crypto._olmDevice.export()};E.a.warn("not exporting device if crypto is not enabled")},j.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),Promise.all(e)},j.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},j.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},j.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},j.prototype.getDeviceId=function(){return this.deviceId},j.prototype.supportsVoip=function(){return this._supportsVoip},j.prototype.setForceTURN=function(e){this._forceTURN=e},j.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},j.prototype.getSyncStateData=function(){return this._syncApi?this._syncApi.getSyncStateData():null},j.prototype.isInitialSyncComplete=function(){const e=this.getSyncState();return!!e&&("PREPARED"===e||"SYNCING"===e)},j.prototype.isGuest=function(){return this._isGuest},j.prototype.getScheduler=function(){return this.scheduler},j.prototype.setGuest=function(e){this._isGuest=e},j.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},j.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},j.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},j.prototype.getCapabilities=function(e=!1){const t=(new Date).getTime();return this._cachedCapabilities&&!e&&t<this._cachedCapabilities.expiration?(E.a.log("Returning cached capabilities"),Promise.resolve(this._cachedCapabilities.capabilities)):this._http.authedRequest(void 0,"GET","/capabilities").catch(e=>(E.a.error(e),null)).then(e=>{e||(e={});const s=e.capabilities||{},n=Object.keys(s).length?216e5:6e4+5e3*Math.random();return this._cachedCapabilities={capabilities:s,expiration:t+n},E.a.log("Caching capabilities: ",s),s})},j.prototype.initCrypto=async function(){if(!Object(S.c)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this._crypto)return void E.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this._sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this._cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");E.a.log("Crypto: Starting up crypto store..."),await this._cryptoStore.startup(),E.a.log("Crypto: initialising roomlist..."),await this._roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new S.a(this,this._sessionStore,e,this.deviceId,this.store,this._cryptoStore,this._roomList,this._verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","crypto.willUpdateDevices","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),E.a.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this._exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this._exportedOlmDeviceToImport,this.olmVersion=S.a.getOlmVersion(),t.registerEventHandlers(this),this._crypto=t},j.prototype.isCryptoEnabled=function(){return null!==this._crypto},j.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},j.prototype.getDeviceCurve25519Key=function(){return this._crypto?this._crypto.getDeviceCurve25519Key():null},j.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},j.prototype.downloadKeys=function(e,t){return null===this._crypto?Promise.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},j.prototype.getStoredDevicesForUser=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevicesForUser(e)||[]},j.prototype.getStoredDevice=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevice(e,t)||null},j.prototype.setDeviceVerified=function(e,t,s){void 0===s&&(s=!0);const n=P(this,e,t,s,null);return e==this.credentials.userId&&this._crypto.checkKeyBackup(),n},j.prototype.setDeviceBlocked=function(e,t,s){return void 0===s&&(s=!0),P(this,e,t,null,s)},j.prototype.setDeviceKnown=function(e,t,s){return void 0===s&&(s=!0),P(this,e,t,null,null,s)},j.prototype.requestVerificationDM=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerificationDM(e,t)},j.prototype.findVerificationRequestDMInProgress=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.findVerificationRequestDMInProgress(e)},j.prototype.getVerificationRequestsToDeviceInProgress=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getVerificationRequestsToDeviceInProgress(e)},j.prototype.requestVerification=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerification(e,t)},j.prototype.beginKeyVerification=function(e,t,s){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.beginKeyVerification(e,t,s)},j.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},j.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},j.prototype.setGlobalErrorOnUnknownDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalErrorOnUnknownDevices(e)},j.prototype.getGlobalErrorOnUnknownDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalErrorOnUnknownDevices()},D(j,["getCrossSigningId","getStoredCrossSigningForUser","checkUserTrust","checkDeviceTrust","checkOwnCrossSigningTrust","checkCrossSigningPrivateKey","legacyDeviceVerification","prepareToEncrypt","isCrossSigningReady","bootstrapCrossSigning","getCryptoTrustCrossSignedDevices","setCryptoTrustCrossSignedDevices","countSessionsNeedingBackup"]),D(j,["getEventEncryptionInfo","createRecoveryKeyFromPassphrase","isSecretStorageReady","bootstrapSecretStorage","addSecretStorageKey","hasSecretStorageKey","storeSecret","getSecret","isSecretStored","requestSecret","getDefaultSecretStorageKeyId","setDefaultSecretStorageKeyId","checkSecretStorageKey","checkSecretStoragePrivateKey"]),j.prototype.getEventSenderDeviceInfo=async function(e){return this._crypto?this._crypto.getEventSenderDeviceInfo(e):null},j.prototype.isEventSenderVerified=async function(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()},j.prototype.cancelAndResendEventRoomKeyRequest=function(e){return e.cancelAndResendKeyRequest(this._crypto,this.getUserId())},j.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t)},j.prototype.isRoomEncrypted=function(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents("m.room.encryption","")||this._roomList.isRoomEncrypted(e)},j.prototype.forceDiscardSession=function(e){if(!this._crypto)throw new Error("End-to-End encryption disabled");this._crypto.forceDiscardSession(e)},j.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))},j.prototype.importRoomKeys=function(e,t){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.importRoomKeys(e,t)},j.prototype.checkKeyBackup=function(){return this._crypto.checkKeyBackup()},j.prototype.getKeyBackupVersion=function(){return this._http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:g.i}).then(e=>{if(e.algorithm!==v.MEGOLM_BACKUP_ALGORITHM){const t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"==typeof e.auth_data&&e.auth_data.public_key)return e;{const e="Invalid backup data returned";return Promise.reject(e)}}).catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e})},j.prototype.isKeyBackupTrusted=function(e){return this._crypto.isKeyBackupTrusted(e)},j.prototype.getKeyBackupEnabled=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto._checkedForBackup?Boolean(this._crypto.backupKey):null},j.prototype.enableKeyBackup=function(t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=t,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=new e.Olm.PkEncryption,this._crypto.backupKey.set_recipient_key(t.auth_data.public_key),this.emit("crypto.keyBackupStatus",!0),this._crypto.scheduleKeyBackupSend()},j.prototype.disableKeyBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=null,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=null,this.emit("crypto.keyBackupStatus",!1)},j.prototype.prepareKeyBackupVersion=async function(e,{secureSecretStorage:t=!1}={}){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const{keyInfo:s,encodedPrivateKey:n,privateKey:i}=await this.createRecoveryKeyFromPassphrase(e);t&&(await this.storeSecret("m.megolm_backup.v1",Object(v.encodeBase64)(i)),E.a.info("Key backup private key stored in secret storage"));const o={public_key:s.pubkey};return s.passphrase&&(o.private_key_salt=s.passphrase.salt,o.private_key_iterations=s.passphrase.iterations),{algorithm:v.MEGOLM_BACKUP_ALGORITHM,auth_data:o,recovery_key:n}},j.prototype.isKeyBackupKeyStored=async function(){return this.isSecretStored("m.megolm_backup.v1",!1)},j.prototype.createKeyBackupVersion=async function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const t={algorithm:e.algorithm,auth_data:e.auth_data};await this._crypto._signObject(t.auth_data),this._cryptoCallbacks.getCrossSigningKey&&this._crypto._crossSigningInfo.getId()&&await this._crypto._crossSigningInfo.signObject(t.auth_data,"master");const s=await this._http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:g.i});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||E.a.error("Key backup not usable even though we just created it"),s},j.prototype.deleteKeyBackupVersion=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo&&this._crypto.backupInfo.version===e&&this.disableKeyBackup();const t=p.f("/room_keys/version/$version",{$version:e});return this._http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:g.i})},j.prototype._makeKeyBackupPath=function(e,t,s){let n;n=void 0!==t?p.f("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?p.f("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===s?void 0:{version:s}}},j.prototype.sendKeyBackup=function(e,t,s,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const i=this._makeKeyBackupPath(e,t,s);return this._http.authedRequest(void 0,"PUT",i.path,i.queryData,n,{prefix:g.i})},j.prototype.scheduleAllGroupSessionsForBackup=async function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");await this._crypto.scheduleAllGroupSessionsForBackup()},j.prototype.flagAllGroupSessionsForBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.flagAllGroupSessionsForBackup()},j.prototype.isValidRecoveryKey=function(e){try{return Object(w.a)(e),!0}catch(e){return!1}},j.prototype.keyBackupKeyFromPassword=function(e,t){return Object(C.b)(t.auth_data,e)},j.prototype.keyBackupKeyFromRecoveryKey=function(e){return Object(w.a)(e)},j.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY",j.prototype.restoreKeyBackupWithPassword=async function(e,t,s,n,i){const o=await Object(C.b)(n.auth_data,e);return this._restoreKeyBackup(o,t,s,n,i)},j.prototype.restoreKeyBackupWithSecretStorage=async function(e,t,s,n){const i=await this.getSecret("m.megolm_backup.v1"),o=Object(S.b)(i);if(o){const[e]=await this._crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",o,[e])}const r=Object(v.decodeBase64)(o||i);return this._restoreKeyBackup(r,t,s,e,n)},j.prototype.restoreKeyBackupWithRecoveryKey=function(e,t,s,n,i){const o=Object(w.a)(e);return this._restoreKeyBackup(o,t,s,n,i)},j.prototype.restoreKeyBackupWithCache=async function(e,t,s,n){const i=await this._crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this._restoreKeyBackup(i,e,t,s,n)},j.prototype._restoreKeyBackup=function(t,s,n,i,{cacheCompleteCallback:o,progressCallback:r}={}){if(null===this._crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const l=this._makeKeyBackupPath(s,n,i.version),d=new e.Olm.PkDecryption;let u;try{u=d.init_with_private_key(t)}catch(e){throw d.free(),e}return u!==i.auth_data.public_key?Promise.reject({errcode:j.RESTORE_BACKUP_ERROR_BAD_KEY}):(this._crypto.storeSessionBackupPrivateKey(t).catch(e=>{console.warn("Error caching session backup key:",e)}).then(o),r&&r({stage:"fetch"}),this._http.authedRequest(void 0,"GET",l.path,l.queryData,void 0,{prefix:g.i}).then(e=>{if(e.rooms)for(const[t,s]of Object.entries(e.rooms)){if(!s.sessions)continue;a+=Object.keys(s.sessions).length;const e=x(s.sessions,d,t);for(const s of e)s.room_id=t,c.push(s)}else if(e.sessions)a=Object.keys(e.sessions).length,c=x(e.sessions,d,s);else{a=1;try{const t=N(e,d);t.room_id=s,t.session_id=n,c.push(t)}catch(e){E.a.log("Failed to decrypt megolm session from backup",e)}}return this.importRoomKeys(c,{progressCallback:r,untrusted:!0,source:"backup"})}).then(()=>this._crypto.setTrustedBackupPubKey(u)).then(()=>({total:a,imported:c.length})).finally(()=>{d.free()}))},j.prototype.deleteKeysFromBackup=function(e,t,s){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const n=this._makeKeyBackupPath(e,t,s);return this._http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:g.i})},j.prototype.getGroup=function(e){return this.store.getGroup(e)},j.prototype.getGroups=function(){return this.store.getGroups()},j.prototype.getMediaConfig=function(e){return this._http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:g.g})},j.prototype.getRoom=function(e){return this.store.getRoom(e)},j.prototype.getRooms=function(){return this.store.getRooms()},j.prototype.getVisibleRooms=function(){const e=this.store.getRooms(),t=new Set;for(const s of e){const e=s.currentState.getStateEvents("m.room.create","");if(e){const s=e.getContent().predecessor;s&&s.room_id&&t.add(s.room_id)}}return e.filter(e=>!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId))},j.prototype.getUser=function(e){return this.store.getUser(e)},j.prototype.getUsers=function(){return this.store.getUsers()},j.prototype.setAccountData=function(e,t,s){const n=p.f("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=Object(g.j)(5,()=>this._http.authedRequest(void 0,"PUT",n,void 0,t));return s&&i.then(e=>s(null,e),s),i},j.prototype.getAccountData=function(e){return this.store.getAccountData(e)},j.prototype.getAccountDataFromServer=async function(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=p.f("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this._http.authedRequest(void 0,"GET",t,void 0)}catch(e){if(e.data&&"M_NOT_FOUND"===e.data.errcode)return null;throw e}},j.prototype.getIgnoredUsers=function(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]},j.prototype.setIgnoredUsers=function(e,t){const s={ignored_users:{}};return e.map(e=>s.ignored_users[e]={}),this.setAccountData("m.ignored_user_list",s,t)},j.prototype.isUserIgnored=function(e){return-1!==this.getIgnoredUsers().indexOf(e)},j.prototype.joinRoom=function(e,t,s){if(p.q(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let i=Promise.resolve();t.inviteSignUrl&&(i=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const o={};t.viaServers&&(o.server_name=t.viaServers);const r={qsStringifyOptions:{arrayFormat:"repeat"}},a=this;return new Promise((n,l)=>{i.then((function(t){const s={};t&&(s.third_party_signed=t);const n=p.f("/join/$roomid",{$roomid:e});return a._http.authedRequest(void 0,"POST",n,o,s,r)})).then((function(e){const s=e.room_id,n=new c.a(a,a._clientOpts).createRoom(s);return t.syncRoom,Promise.resolve(n)})).then((function(e){B(s,n,e)}),(function(e){F(s,l,e)}))})},j.prototype.resendEvent=function(e,t){return U(t,e,l.a.SENDING),A(this,t,e)},j.prototype.cancelPendingEvent=function(e){if([l.a.QUEUED,l.a.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e);U(this.getRoom(e.getRoomId()),e,l.a.CANCELLED)},j.prototype.setRoomName=function(e,t,s){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,s)},j.prototype.setRoomTopic=function(e,t,s){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,s)},j.prototype.getRoomTags=function(e,t){const s=p.f("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",s,void 0)},j.prototype.setRoomTag=function(e,t,s,n){const i=p.f("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"PUT",i,void 0,s)},j.prototype.deleteRoomTag=function(e,t,s){const n=p.f("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(s,"DELETE",n,void 0,void 0)},j.prototype.setRoomAccountData=function(e,t,s,n){const i=p.f("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(n,"PUT",i,void 0,s)},j.prototype.setPowerLevel=function(e,t,s,n,i){let o={users:{}};n&&"m.room.power_levels"===n.getType()&&(o=p.c(n.getContent())),o.users[t]=s;const r=p.f("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(i,"PUT",r,void 0,o)},j.prototype.sendEvent=function(e,t,s,n,i){return this._sendCompleteEvent(e,{type:t,content:s},n,i)},j.prototype._sendCompleteEvent=function(e,t,s,n){p.q(s)&&(n=s,s=void 0),s||(s=this.makeTxnId());const i=new l.b(Object.assign(t,{event_id:"~"+e+":"+s,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),r=i.getAssociatedId();if(r&&r.startsWith("~")){const e=o.getPendingEvents().find(e=>e.getId()===r);e.once("Event.localEventIdReplaced",()=>{i.updateAssociatedId(e.getId())})}const a=i.getType();return E.a.log(`sendEvent of type ${a} in ${e} with txnId ${s}`),i.setTxnId(s),i.setStatus(l.a.SENDING),o&&o.addPendingEvent(i,s),i.status===l.a.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):A(this,o,i,n)},j.prototype.redactEvent=function(e,t,s,n){return this._sendCompleteEvent(e,{type:"m.room.redaction",content:{},redacts:t},s,n)},j.prototype.sendMessage=function(e,t,s,n){return p.q(s)&&(n=s,s=void 0),this.sendEvent(e,"m.room.message",t,s,n)},j.prototype.sendTextMessage=function(e,t,s,n){const i=_.makeTextMessage(t);return this.sendMessage(e,i,s,n)},j.prototype.sendNotice=function(e,t,s,n){const i=_.makeNotice(t);return this.sendMessage(e,i,s,n)},j.prototype.sendEmoteMessage=function(e,t,s,n){const i=_.makeEmoteMessage(t);return this.sendMessage(e,i,s,n)},j.prototype.sendImageMessage=function(e,t,s,n,i){p.q(n)&&(i=n,n=void 0),n||(n="Image");const o={msgtype:"m.image",url:t,info:s,body:n};return this.sendMessage(e,o,i)},j.prototype.sendStickerMessage=function(e,t,s,n,i){p.q(n)&&(i=n,n=void 0),n||(n="Sticker");const o={url:t,info:s,body:n};return this.sendEvent(e,"m.sticker",o,i,void 0)},j.prototype.sendHtmlMessage=function(e,t,s,n){const i=_.makeHtmlMessage(t,s);return this.sendMessage(e,i,n)},j.prototype.sendHtmlNotice=function(e,t,s,n){const i=_.makeHtmlNotice(t,s);return this.sendMessage(e,i,n)},j.prototype.sendHtmlEmote=function(e,t,s,n){const i=_.makeHtmlEmote(t,s);return this.sendMessage(e,i,n)},j.prototype.sendReceipt=function(e,t,s,n){if("function"==typeof s&&(n=s,s={}),this.isGuest())return Promise.resolve({});const i=p.f("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this._http.authedRequest(n,"POST",i,void 0,s||{}),r=this.getRoom(e.getRoomId());return r&&r._addLocalEchoReceipt(this.credentials.userId,e,t),o},j.prototype.sendReadReceipt=async function(e,t,s){"function"==typeof t&&(s=t,t={}),t||(t={});const n=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);const o={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",o,s)},j.prototype.setRoomReadMarkers=async function(e,t,s,n){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o;if(s){if(o=s.getId(),i&&i.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);i&&i._addLocalEchoReceipt(this.credentials.userId,s,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,o,n)},j.prototype.getUrlPreview=function(e,t,s){const n=(t=6e4*Math.floor(t/6e4))+"_"+e,i=this.urlPreviewCache[n];if(i)return s&&i.then(s).catch(s),i;const o=this._http.authedRequest(s,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:g.g});return this.urlPreviewCache[n]=o,o},j.prototype.sendTyping=function(e,t,s,n){if(this.isGuest())return Promise.resolve({});const i=p.f("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=s||2e4),this._http.authedRequest(n,"PUT",i,void 0,o)},j.prototype.getRoomUpgradeHistory=function(e,t=!1){let s=this.getRoom(e);if(!s)return[];const n=[s];let i=s.currentState.getStateEvents("m.room.create","");for(;i;){E.a.log("Looking at "+i.getId());const e=i.getContent().predecessor;if(!e||!e.room_id)break;{E.a.log("Looking at predecessor "+e.room_id);const s=this.getRoom(e.room_id);if(!s)break;if(t){const e=s.currentState.getStateEvents("m.room.tombstone","");if(!e||e.getContent().replacement_room!==s.roomId)break}n.splice(0,0,s),i=s.currentState.getStateEvents("m.room.create","")}}let o=s.currentState.getStateEvents("m.room.tombstone","");for(;o;){const e=this.getRoom(o.getContent().replacement_room);if(!e)break;if(e.roomId===s.roomId)break;if(t){if(i=e.currentState.getStateEvents("m.room.create",""),!i||!i.getContent().predecessor)break;if(i.getContent().predecessor.room_id!==s.roomId)break}n.push(e);if(new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);s=e,o=s.currentState.getStateEvents("m.room.tombstone","")}return n},j.prototype.invite=function(e,t,s){return L(this,e,t,"invite",void 0,s)},j.prototype.inviteByEmail=function(e,t,s){return this.inviteByThreePid(e,"email",t,s)},j.prototype.inviteByThreePid=async function(e,t,s,n){const i=p.f("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new g.c({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const r={id_server:o,medium:t,address:s};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(r.id_access_token=e)}return this._http.authedRequest(n,"POST",i,void 0,r)},j.prototype.leave=function(e,t){return L(this,e,void 0,"leave",void 0,t)},j.prototype.leaveRoomChain=function(e,t=!0){const s=this.getRoomUpgradeHistory(e);let n=s;if(!t){n=[];for(const t of s)if(n.push(t),t.roomId===e)break}const i={},o=[],r=e=>this.leave(e).then(()=>{i[e]=null}).catch(t=>(i[e]=t,null));for(const e of n)o.push(r(e.roomId));return Promise.all(o).then(()=>i)},j.prototype.ban=function(e,t,s,n){return L(this,e,t,"ban",s,n)},j.prototype.forget=function(e,t,s){void 0===t&&(t=!0);const n=L(this,e,void 0,"forget",void 0,s);if(!t)return n;const i=this;return n.then((function(t){return i.store.removeRoom(e),i.emit("deleteRoom",e),t}))},j.prototype.unban=function(e,t,s){const n=p.f("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this._http.authedRequest(s,"POST",n,void 0,i)},j.prototype.kick=function(e,t,s,n){return function(e,t,s,n,i,o){p.q(i)&&(o=i,i=void 0);const r=p.f("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:s});return e._http.authedRequest(o,"PUT",r,void 0,{membership:n,reason:i})}(this,e,t,"leave",s,n)},j.prototype.getPushActionsForEvent=function(e){return e.getPushActions()||e.setPushActions(this._pushProcessor.actionsForEvent(e)),e.getPushActions()},j.prototype.setProfileInfo=function(e,t,s){const n=p.f("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(s,"PUT",n,void 0,t)},j.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},j.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},j.prototype.mxcUrlToHttp=function(e,t,s,n,i){return Object(f.a)(this.baseUrl,e,t,s,n,i)},j.prototype._unstable_setStatusMessage=function(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map(s=>{const n="join"===s.getMyMembership(),i=2===s.getInvitedAndJoinedMemberCount();if(!n||!i)return Promise.resolve();return s.currentState.mayClientSendStateEvent(t,this)?this.sendStateEvent(s.roomId,t,{status:e},this.getUserId()):Promise.resolve()}))},j.prototype.setPresence=function(e,t){const s=p.f("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",s,void 0,e)},j.prototype.scrollback=function(e,t,s){p.q(t)&&(s=t,t=void 0),t=t||30;let n=0,i=this._ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;const r=this,a=new Promise((i,o)=>{Object(p.A)(n).then((function(){return r._createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")})).then((function(t){const n=p.u(t.chunk,V(r));if(t.state){const s=p.u(t.state,V(r));e.currentState.setUnknownStateEvents(s)}e.addEventsToTimeline(n,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),r.store.storeEvents(e,n,t.end,!0),r._ongoingScrollbacks[e.roomId]=null,B(s,i,e)}),(function(t){r._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},F(s,o,t)}))});return i={promise:a,errorTs:null},this._ongoingScrollbacks[e.roomId]=i,a},j.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const s=p.f("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n=void 0;this._clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(a.a.LAZY_LOADING_MESSAGES_FILTER)});const i=this;return i._http.authedRequest(void 0,"GET",s,n).then((function(s){if(!s.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);s.events_after.reverse();const n=s.events_after.concat([s.event]).concat(s.events_before),o=p.u(n,i.getEventMapper());let r=e.getTimelineForEvent(o[0].getId());if(r){const e=p.u(s.state,i.getEventMapper());r.getState(d.a.BACKWARDS).setUnknownStateEvents(e)}else r=e.addTimeline(),r.initialiseState(p.u(s.state,i.getEventMapper())),r.getState(d.a.FORWARDS).paginationToken=s.end;e.addEventsToTimeline(o,!0,r,s.start);return e.getTimelineForEvent(t)||r}))},j.prototype._createMessagesRequest=function(e,t,s,n,i){const o=p.f("/rooms/$roomId/messages",{$roomId:e});void 0===s&&(s=30);const r={from:t,limit:s,dir:n};let c=null;return this._clientOpts.lazyLoadMembers&&(c=Object.assign({},a.a.LAZY_LOADING_MESSAGES_FILTER)),i&&(c=c||{},Object.assign(c,i.getRoomTimelineFilterComponent())),c&&(r.filter=JSON.stringify(c)),this._http.authedRequest(void 0,"GET",o,r)},j.prototype.paginateEventTimeline=function(e,t){const s=e.getTimelineSet()===this._notifTimelineSet,n=(t=t||{}).backwards||!1;if(s&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");const i=n?d.a.BACKWARDS:d.a.FORWARDS,o=e.getPaginationToken(i);if(!o)return Promise.resolve(!1);const r=e._paginationRequests[i];if(r)return r;let a,c,l;const u=this;if(s)a="/notifications",c={limit:"limit"in t?t.limit:30,only:"highlight"},o&&"end"!==o&&(c.from=o),l=this._http.authedRequest(void 0,"GET","/notifications",c,void 0).then((function(t){const s=t.next_token,o=[];for(let e=0;e<t.notifications.length;e++){const s=t.notifications[e],n=u.getEventMapper()(s.event);n.setPushActions(k.a.actionListToActionsObject(s.actions)),n.event.room_id=s.room_id,o[e]=n}return e.getTimelineSet().addEventsToTimeline(o,n,e,s),n&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token})).finally((function(){e._paginationRequests[i]=null})),e._paginationRequests[i]=l;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());l=this._createMessagesRequest(e.getRoomId(),o,t.limit,i,e.getFilter()),l.then((function(t){if(t.state){const s=e.getState(i),n=p.u(t.state,u.getEventMapper());s.setUnknownStateEvents(n)}const s=t.end,o=p.u(t.chunk,u.getEventMapper());return e.getTimelineSet().addEventsToTimeline(o,n,e,s),n&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start})).finally((function(){e._paginationRequests[i]=null})),e._paginationRequests[i]=l}return l},j.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",null)},j.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new c.a(this,this._clientOpts),this._peekSync.peek(e)},j.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},j.prototype.setGuestAccess=function(e,t){const s=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"});let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),Promise.all([n,s])},j.prototype.requestRegisterEmailToken=function(e,t,s,n){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})},j.prototype.requestRegisterMsisdnToken=function(e,t,s,n,i){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})},j.prototype.requestAdd3pidEmailToken=function(e,t,s,n){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})},j.prototype.requestAdd3pidMsisdnToken=function(e,t,s,n,i){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})},j.prototype.requestPasswordEmailToken=function(e,t,s,n){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})},j.prototype.requestPasswordMsisdnToken=function(e,t,s,n,i){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})},j.prototype._requestTokenFromEndpoint=async function(e,t){const s=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){const e=i.a.parse(this.idBaseUrl);if(!e.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);if(s.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}}return this._http.request(void 0,"POST",e,void 0,s)},j.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let s=0;s<this.pushRules[e].room.length;s++){const n=this.pushRules[e].room[s];if(n.rule_id===t)return n}},j.prototype.setRoomMutePushRule=function(e,t,s){const n=this;let i,o;const r=this.getRoomPushRule(e,t);if(r&&0<=r.actions.indexOf("dont_notify")&&(o=!0),s?r?o||(i=p.d(),this.deletePushRule(e,"room",r.rule_id).then((function(){n.addPushRule(e,"room",t,{actions:["dont_notify"]}).then((function(){i.resolve()}),(function(e){i.reject(e)}))}),(function(e){i.reject(e)})),i=i.promise):i=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):o&&(i=this.deletePushRule(e,"room",r.rule_id)),i)return new Promise((e,t)=>{i.then((function(){n.getPushRules().then((function(t){n.pushRules=t,e()}),(function(e){t(e)}))}),(function(e){n.getPushRules().then((function(s){n.pushRules=s,t(e)}),(function(s){t(e)}))}))})},j.prototype.searchMessageText=function(e,t){const s={search_term:e.query};return"keys"in e&&(s.keys=e.keys),this.search({body:{search_categories:{room_events:s}}},t)},j.prototype.searchRoomEvents=function(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},s={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,s))},j.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},s=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally((function(){e.pendingRequest=null}));return e.pendingRequest=s,s},j.prototype._processRoomEventsSearch=function(e,t){const s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;const n={};s.highlights.forEach((function(e){n[e]=1})),e.highlights.forEach((function(e){n[e]=1})),e.highlights=Object.keys(n);for(let t=0;t<s.results.length;t++){const n=u.a.fromJson(s.results[t],this.getEventMapper());e.results.push(n)}return e},j.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return Promise.resolve([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;const e=this,t=new c.a(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then((function(t){E.a.log("Marking success of sync left room request"),e._syncedLeftRooms=!0})).finally((function(){e._syncLeftRoomsPromise=null})),this._syncLeftRoomsPromise},j.prototype.createFilter=function(e){const t=this,s=p.f("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",s,void 0,e).then((function(s){const n=a.a.fromJson(t.credentials.userId,s.filter_id,e);return t.store.storeFilter(n),n}))},j.prototype.getFilter=function(e,t,s){if(s){const s=this.store.getFilter(e,t);if(s)return Promise.resolve(s)}const n=this,i=p.f("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",i,void 0,void 0).then((function(s){const i=a.a.fromJson(e,t,s);return n.store.storeFilter(i),i}))},j.prototype.getOrCreateFilter=async function(e,t){const s=this.store.getFilterIdByName(e);let n=void 0;if(s){try{const e=await this.getFilter(this.credentials.userId,s,!0);if(e){const i=e.getDefinition(),o=t.getDefinition();p.b(i,o)&&(n=s)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const i=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId},j.prototype.getOpenIdToken=function(){const e=p.f("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},j.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},j.prototype.getTurnServers=function(){return this._turnServers||[]},j.prototype.setFallbackICEServerAllowed=function(e){this._fallbackICEServerAllowed=e},j.prototype.isFallbackICEServerAllowed=function(){return this._fallbackICEServerAllowed},j.prototype.isSynapseAdministrator=function(){const e=p.f("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then(e=>e.admin)},j.prototype.whoisSynapseUser=function(e){const t=p.f("/_synapse/admin/v1/whois/$userId",{$userId:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})},j.prototype.deactivateSynapseUser=function(e){const t=p.f("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this._http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})},j.prototype.startClient=async function(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new I.a(t)),this._crypto&&(this._crypto.uploadDeviceKeys(),this._crypto.start()),function e(t){if(!t._supportsVoip)return;t.turnServer().then((function(s){if(s.uris){E.a.log("Got TURN URIs: "+s.uris+" refresh in "+s.ttl+" secs");const n={urls:s.uris,username:s.username,credential:s.password};t._turnServers=[n],t._checkTurnServersTimeoutID=setTimeout(()=>{e(t)},1e3*(s.ttl||3600)*.9)}}),(function(s){E.a.error("Failed to get TURN URIs"),t._checkTurnServersTimeoutID=setTimeout((function(){e(t)}),6e4)}))}(this),this._syncApi&&(E.a.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),(e=Object.assign({},e)).crypto=this._crypto,e.canResetEntireTimeline=e=>!!this._canResetTimelineCallback&&this._canResetTimelineCallback(e),this._clientOpts=e,this._syncApi=new c.a(this,e),this._syncApi.sync(),void 0!==e.clientWellKnownPollPeriod&&(this._clientWellKnownIntervalID=setInterval(()=>{this._fetchClientWellKnown()},1e3*e.clientWellKnownPollPeriod),this._fetchClientWellKnown())},j.prototype._fetchClientWellKnown=async function(){this._clientWellKnownPromise=O.a.getRawClientConfig(this.getDomain()),this._clientWellKnown=await this._clientWellKnownPromise,this.emit("WellKnown.client",this._clientWellKnown)},j.prototype.getClientWellKnown=function(){return this._clientWellKnown},j.prototype.waitForClientWellKnown=function(){return this._clientWellKnownPromise},j.prototype._storeClientOptions=function(){const e=["boolean","string","number"],t=Object.entries(this._clientOpts).filter(([t,s])=>e.includes(typeof s)).reduce((e,[t,s])=>(e[t]=s,e),{});return this.store.storeClientOptions(t)},j.prototype.stopClient=function(){E.a.log("stopping MatrixClient"),this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._crypto&&this._crypto.stop(),this._peekSync&&this._peekSync.stopPeeking(),e.clearTimeout(this._checkTurnServersTimeoutID),void 0!==this._clientWellKnownIntervalID&&e.clearInterval(this._clientWellKnownIntervalID)},j.prototype.getVersions=async function(){return null===this._serverVersionsCache&&(this._serverVersionsCache=await this._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""})),this._serverVersionsCache},j.prototype.isVersionSupported=async function(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)},j.prototype.doesServerSupportLazyLoading=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.5.0")||s&&s["m.lazy_load_members"]},j.prototype.doesServerRequireIdServerParam=async function(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const s=e.unstable_features;return!s||(void 0===s["m.require_identity_server"]||s["m.require_identity_server"])},j.prototype.doesServerAcceptIdentityAccessToken=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.id_access_token"]},j.prototype.doesServerSupportSeparateAddAndBind=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.separate_add_and_bind"]},j.prototype.doesServerSupportUnstableFeature=async function(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features;return s&&!!s[e]},j.prototype.hasLazyLoadMembersEnabled=function(){return!!this._clientOpts.lazyLoadMembers},j.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},j.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},j.prototype.relations=async function(e,t,s,n,i={}){const o=function(e,t,s){return"m.reaction"===s?s:e.isRoomEncrypted(t)?"m.room.encrypted":s}(this,e,n),r=await this.fetchRelations(e,t,s,o,i),a=this.getEventMapper();let c;r.original_event&&(c=a(r.original_event));let l=r.chunk.map(a);if("m.room.encrypted"===o){const e=c?l.concat(c):l;await Promise.all(e.map(e=>new Promise(t=>e.once("Event.decrypted",t)))),l=l.filter(e=>e.getType()===n)}return{originalEvent:c,events:l,nextBatch:r.next_batch}},j.prototype.getEventMapper=function(e){return V(this,e)},j.prototype.getCrossSigningCacheCallbacks=function(){return this._crypto&&this._crypto._crossSigningInfo.getCacheCallbacks()},j.prototype.generateClientSecret=function(){return Object(R.a)(32)}}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"h",(function(){return a})),s.d(t,"i",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"f",(function(){return d})),s.d(t,"g",(function(){return u})),s.d(t,"d",(function(){return h})),s.d(t,"c",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f})),s.d(t,"j",(function(){return _}));var n=s(573),i=s(1),o=s(0),r=s(574);const a="/_matrix/client/r0",c="/_matrix/client/unstable",l="/_matrix/identity/api/v1",d="/_matrix/identity/v2",u="/_matrix/media/r0";function h(e,t){i.a(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}h.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,s){i.q(s)?s={callback:s}:void 0===s&&(s={});const n=!1!==s.includeFilename,a=s.type||t.type||"application/octet-stream",c=s.name||t.name;let l=t;l.stream&&"function"!=typeof l.stream&&(o.a.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=l.stream);let d=s.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(o.a.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let u=s.onlyContentUri;d||void 0!==u||(e.XMLHttpRequest?(o.a.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),u=!0):u=!1);const h={loaded:0,total:0};let p,g=null;if(d||(g=function(e){let t=JSON.parse(e);if(u&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=i.d(),o=new e.XMLHttpRequest;h.xhr=o;const d=m(t,s.callback,this.opts.onlyData),u=function(){o.abort(),d(new Error("Timeout"))};o.timeout_timer=r.b(u,3e4),o.onreadystatechange=function(){switch(o.readyState){case e.XMLHttpRequest.DONE:var t;r.a(o.timeout_timer);try{if(0===o.status)throw new f;if(!o.responseText)throw new Error("No response body.");t=o.responseText,g&&(t=g(t))}catch(e){return e.http_status=o.status,void d(e)}d(void 0,o,t)}},o.upload.addEventListener("progress",(function(e){r.a(o.timeout_timer),h.loaded=e.loaded,h.total=e.total,o.timeout_timer=r.b(u,3e4),s.progressHandler&&s.progressHandler({loaded:e.loaded,total:e.total})}));let _=this.opts.baseUrl+"/_matrix/media/r0/upload";const v=[];n&&c&&v.push("filename="+encodeURIComponent(c)),this.useAuthorizationHeader||v.push("access_token="+encodeURIComponent(this.opts.accessToken)),v.length>0&&(_+="?"+v.join("&")),o.open("POST",_),this.useAuthorizationHeader&&o.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),o.setRequestHeader("Content-Type",a),o.send(l),p=t.promise,p.abort=o.abort.bind(o)}else{const e={};n&&c&&(e.filename=c),p=this.authedRequest(s.callback,"POST","/upload",e,l,{prefix:"/_matrix/media/r0",headers:{"Content-Type":a},json:!1,bodyParser:g})}const _=this,v=p.finally((function(){for(let e=0;e<_.uploads.length;++e)if(_.uploads[e]===h)return void _.uploads.splice(e,1)}));return v.abort=p.abort,h.promise=v,this.uploads.push(h),v},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,s,n,o,r){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");const a=this.opts.idBaseUrl+o+s;if(void 0!==e&&!i.q(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:a,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"==typeof n&&(c.json=n),r&&(c.headers.Authorization="Bearer "+r);const l=i.d();return this.opts.request(c,m(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,s,n,i,o){n||(n={}),this.useAuthorizationHeader?(isFinite(o)&&(o={localTimeoutMs:o}),o||(o={}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);const r=this.request(e,t,s,n,i,o),a=this;return r.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),r},request:function(e,t,s,n,i,o){const r=void 0!==(o=o||{}).prefix?o.prefix:this.opts.prefix,a=this.opts.baseUrl+r+s;return this.requestOtherUrl(e,t,a,n,i,o)},requestOtherUrl:function(e,t,s,n,i,o){return null==o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,s,n,i,o)},getUrl:function(e,t,s){let n="";return t&&(n="?"+i.e(t)),this.opts.baseUrl+s+e+n},_request:function(e,t,s,n,o,a){if(void 0!==e&&!i.q(e))throw Error("Expected callback to be a function but got "+typeof e);a=a||{};const c=this;if(this.opts.extraParams)for(const e in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(e)&&(n[e]=this.opts.extraParams[e]);const l=i.i({},a.headers||{}),d=void 0===a.json||a.json;let u=a.bodyParser;d&&(o&&(o=JSON.stringify(o),l["content-type"]="application/json"),l.accept||(l.accept="application/json"),void 0===u&&(u=function(e){return JSON.parse(e)}));const h=i.d();let g,f,_=!1;const v=a.localTimeoutMs||this.opts.localTimeoutMs,y=()=>{v&&(g&&r.a(g),g=r.b((function(){_=!0,f&&f.abort&&f.abort(),h.reject(new p({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:v}))}),v))};y();const b=h.promise;try{f=this.opts.request({uri:s,method:t,withCredentials:!1,qs:n,qsStringifyOptions:a.qsStringifyOptions,useQuerystring:!0,body:o,json:!1,timeout:v,headers:l||{},_matrix_opts:this.opts},(function(t,s,n){if(v&&(r.a(g),_))return;m(h,e,c.opts.onlyData,u)(t,s,n)})),f&&("onprogress"in f&&(f.onprogress=e=>{y()}),f.abort&&(b.abort=f.abort.bind(f)))}catch(t){h.reject(t),e&&e(t)}return b}};const m=function(e,t,s,i){return t=t||function(){},function(o,r,a){if(o){"AbortError"===o.name||"aborted"===o||o instanceof p||(o=new g("request failed",o))}if(!o)try{r.statusCode>=400?o=function(e,t){const s=e.statusCode,i=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return Object(n.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let o;if(i)if("application/json"===i.type){const e="object"==typeof t?t:JSON.parse(t);o=new p(e)}else"text/plain"===i.type&&(o=new Error(`Server returned ${s} error: ${t}`));o||(o=new Error(`Server returned ${s} error`));return o.httpStatus=s,o}(r,a):i&&(a=i(a))}catch(e){o=new Error("Error parsing server response: "+e)}if(o)e.reject(o),t(o);else{const n={code:r.statusCode,headers:r.headers,data:a};e.resolve(s?a:n),t(null,s?a:n)}}};class p extends Error{constructor(e){super("MatrixError: "+(e=e||{}).errcode),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}class g extends Error{constructor(e,t){super(e+(t?": "+t.message:"")),this._cause=t}get name(){return"ConnectionError"}get cause(){return this._cause}}class f extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}async function _(e,t){let s=0,n=null;for(;s<e;)try{if(s>0){const e=1e3*Math.pow(2,s);console.log(`network operation failed ${s} times, retrying in ${e}ms...`),await new Promise(t=>setTimeout(t,e))}return await t()}catch(e){if(!(e instanceof g))throw e;s+=1,n=e}throw n}}).call(this,s(6))},function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return m}));var i=s(276),o=s(194),r=s(85);const a="m.qr_code.show.v1",c="m.qr_code.scan.v1";class l extends i.b{static factory(...e){return new l(...e)}static get NAME(){return"m.reciprocate.v1"}async _doVerification(){if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw Object(o.d)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(Object(o.h)())},this.emit("show_reciprocate_qr",this.reciprocateQREvent)});const t={};switch(e.mode){case d:{const s=e.otherUserMasterKey;t["ed25519:"+s]=s;break}case u:{const s=this.request.targetDevice.deviceId;t["ed25519:"+s]=e.otherDeviceKey;break}case h:{const s=e.myMasterKey;t["ed25519:"+s]=s;break}}await this._verifyKeys(this.userId,t,(e,s,n)=>{const i=t[e];if(!i)throw Object(o.d)();if(n!==i)throw console.error("key ID from key info does not match"),Object(o.d)();for(const e in s.keys){if(!e.startsWith("ed25519"))continue;const n=t[e];if(!n)throw Object(o.d)();if(s.keys[e]!==n)throw console.error("master key does not match"),Object(o.d)()}})}}const d=0,u=1,h=2;class m{constructor(e,t,s,n,i,o){this._sharedSecret=t,this._mode=e,this._otherUserMasterKey=s,this._otherDeviceKey=n,this._myMasterKey=i,this._buffer=o}static async create(e,t){const s=m._generateSharedSecret(),n=m._determineMode(e,t);let i=null,o=null,r=null;if(n===d){i=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(n===u)o=await m._getOtherDeviceKey(e,t);else if(n===h){const e=t.getUserId();r=t.getStoredCrossSigningForUser(e).getId("master")}const a=m._generateQrData(e,t,n,s,i,o,r),c=m._generateBuffer(a);return new m(n,s,i,o,r,c)}get buffer(){return this._buffer}get mode(){return this._mode}get otherDeviceKey(){return this._otherDeviceKey}get otherUserMasterKey(){return this._otherUserMasterKey}get myMasterKey(){return this._myMasterKey}get encodedSharedSecret(){return this._sharedSecret}static _generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),Object(r.encodeUnpaddedBase64)(t)}static async _getOtherDeviceKey(e,t){const s=t.getUserId(),n=e.targetDevice,i=n?n.deviceId:null,o=t.getStoredDevice(s,i);if(!o)throw new Error("could not find device "+i);return o.getFingerprint()}static _determineMode(e,t){const s=t.getUserId(),n=e.otherUserId;let i=d;if(s===n){i=t.checkUserTrust(s).isCrossSigningVerified()?u:h}return i}static _generateQrData(e,t,s,n,i,o,r){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:s,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},l=t.getStoredCrossSigningForUser(a);return s===d?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=i):s===u?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=o):s===h&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=r),c}static _generateBuffer(e){let t=n.alloc(0);const s=e=>{const s=n.from([e]);t=n.concat([t,s])},i=(e,s,i=!0)=>{const o=n.from(e,s);i&&(e=>{const s=n.alloc(2);s.writeInt16BE(e,0),t=n.concat([t,s])})(o.byteLength),t=n.concat([t,o])},o=e=>{const s=Object(r.decodeBase64)(e),i=n.from(s);t=n.concat([t,i])};return i(e.prefix,"ascii",!1),s(e.version),s(e.mode),i(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}}).call(this,s(6),s(22).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"h",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"g",(function(){return a})),s.d(t,"f",(function(){return c})),s.d(t,"d",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(81);function i(e,t){return function(s){return function(e,t,s){const i=Object.assign({},{code:e,reason:t},s);return new n.b({type:"m.key.verification.cancel",content:i})}(e,t,s)}}const o=i("m.user","Cancelled by user"),r=i("m.timeout","Timed out"),a=(i("m.unknown_transaction","Unknown transaction"),i("m.unknown_method","Unknown method")),c=i("m.unexpected_message","Unexpected message"),l=i("m.key_mismatch","Key mismatch"),d=(i("m.user_error","User mismatch"),i("m.invalid_message","Invalid message"));function u(e){const t=e.getContent();if(t){const{code:e,reason:s}=t;return{code:e,reason:s}}return{code:"Unknown error",reason:"m.unknown"}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(51),h=s.n(u);class m extends d.a.PureComponent{render(){const e=this.props,{children:t,className:s,disabled:n,outlined:o}=e,a=r()(e,["children","className","disabled","outlined"]),c=h()("mx_RadioButton",s,{mx_RadioButton_disabled:n,mx_RadioButton_enabled:!n,mx_RadioButton_checked:this.props.checked,mx_RadioButton_outlined:o});return d.a.createElement("label",{className:c},d.a.createElement("input",i()({type:"radio",disabled:n},a)),d.a.createElement("div",null,d.a.createElement("div",null)),d.a.createElement("div",{className:"mx_RadioButton_content"},t),d.a.createElement("div",{className:"mx_RadioButton_spacer"}))}}c()(m,"defaultProps",{className:""})},,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(50);function i(e){const t=t=>n.a.getValue(t,e.getRoomId());if(e.isRedacted()&&!t("showRedactions"))return!0;if(e.isRelation("m.replace"))return!0;const s=function(e){const t={isMemberEvent:"m.room.member"===e.getType()};if(!t.isMemberEvent)return t;const s=e.getContent(),n=e.getPrevContent(),i=s.membership!==n.membership;t.isJoin=i&&"join"===s.membership,t.isPart=i&&"leave"===s.membership&&e.getStateKey()===e.getSender();const o=!i&&"join"===s.membership;return t.isDisplaynameChange=o&&s.displayname!==n.displayname,t.isAvatarChange=o&&s.avatar_url!==n.avatar_url,t}(e);if(s.isMemberEvent){if((s.isJoin||s.isPart)&&!t("showJoinLeaves"))return!0;if(s.isAvatarChange&&!t("showAvatarChanges"))return!0;if(s.isDisplaynameChange&&!t("showDisplaynameChanges"))return!0}return!1}},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"d",(function(){return d})),s.d(t,"c",(function(){return u}));var n=s(51),i=s.n(n),o=s(47),r=s(46),a=s(49);class c extends Error{}class l{constructor(e,t,s){this.serviceType=e,this.baseUrl=t,this.accessToken=s}}async function d(e,t=u){const s=e.map(e=>o.a.get().getTerms(e.serviceType,e.baseUrl)),n=(await Promise.all(s)).map((t,s)=>({service:e[s],policies:t.policies})),i=await o.a.get().getAccountData("m.accepted_terms");let r;r=i&&i.getContent()&&i.getContent().accepted?new Set(i.getContent().accepted):new Set;const a=[];for(const{service:e,policies:t}of n){const s={};for(const[e,n]of Object.entries(t)){let t=!1;for(const e of Object.keys(n))if("version"!==e&&r.has(n[e].url)){t=!0;break}t||(s[e]=n)}Object.keys(s).length>0&&a.push({service:e,policies:s})}const c=r.size;if(a.length>0){const e=await t(a,[...r]);console.log("User has agreed to URLs",e),e.forEach(e=>r.add(e))}else console.log("User has already agreed to all required policies");if(r.size!==c){const e={accepted:Array.from(r)};await o.a.get().setAccountData("m.accepted_terms",e)}const l=n.map(e=>{const t=Array.from(r).filter(t=>{for(const s of Object.values(e.policies))for(const e of Object.keys(s))if("version"!==e&&s[e].url===t)return!0;return!1});return 0===t.length?Promise.resolve():o.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)});return Promise.all(l)}function u(e,t,s){return new Promise((n,o)=>{console.log("Terms that need agreement",e);const l=r.getComponent("views.dialogs.TermsDialog");a.a.createTrackedDialog("Terms of Service","",l,{policiesAndServicePairs:e,agreedUrls:t,onFinished:(e,t)=>{e?n(t):o(new c)}},i()("mx_TermsDialog",s))})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const n=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i;function i(e){return n.test(e)}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return a})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(55),i=s(53),o=s(47);function r(){return i.a.get().validated_server_config.isUrl}function a(){const e=r();o.a.get().setAccountData("m.identity_server",{base_url:e})}async function c(e){let t;try{t=await o.a.get().getTerms(n.l.IS,e)}catch(e){if(console.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;t=null}return t&&t.policies&&Object.keys(t.policies).length>0}function l(){const e=o.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(47);function i(){const e=n.a.get().getClientWellKnown();return e&&e["io.element.e2ee"]?e["io.element.e2ee"]:e&&e["im.vector.riot.e2ee"]?e["im.vector.riot.e2ee"]:null}function o(){const e=i();return e&&!0===e.secure_backup_required}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return a})),s.d(t,"d",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(47),i=s(90),o=s(80);function r(e,t,s,i){let o;return e&&e.getAvatarUrl&&(o=e.getAvatarUrl(n.a.get().getHomeserverUrl(),Math.floor(t*window.devicePixelRatio),Math.floor(s*window.devicePixelRatio),i,!1,!1)),o||(o=l(e?e.userId:"")),o}function a(e,t,s,i){const r=Object(o.a)(n.a.get().getHomeserverUrl(),e.avatarUrl,Math.floor(t*window.devicePixelRatio),Math.floor(s*window.devicePixelRatio),i);return r&&0!==r.length?r:null}const c=new Map;function l(e){const t=["#0DBD8B","#368bd6","#ac3ba8"];let s=0;for(let t=0;t<e.length;++t)s+=e.charCodeAt(t);const n=s%t.length,i="--avatar-background-colors_"+n,o=document.body.style.getPropertyValue(i)||t[n];let r=c.get(o);return r||(!function(e){return"string"==typeof e&&(7===e.length||9===e.lengh)&&"#"===e.charAt(0)&&!e.substr(1).split("").some(e=>isNaN(parseInt(e,16)))}(o)?r="":(r=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const s=t.getContext("2d");return s?(s.fillStyle=e,s.fillRect(0,0,40,40),t.toDataURL()):""}(o),c.set(o,r))),r}function d(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;let t=0;const s=e[0];"@"!==s&&"#"!==s&&"+"!==s||!e[1]||t++;let n=1;const i=e.charCodeAt(t);if(i>=55296&&i<=56319&&e[t+1]){const s=e.charCodeAt(t+1);s>=56320&&s<=57343&&n++}return e.substring(t,t+n).toUpperCase()}function u(e,t,s,o){if(!e)return null;const r=e.getAvatarUrl(n.a.get().getHomeserverUrl(),t,s,o,!1);if(r)return r;let a=null;const c=i.a.shared().getUserIdForRoomId(e.roomId);return a=c?e.getMember(c):e.getAvatarFallbackMember(),a?a.getAvatarUrl(n.a.get().getHomeserverUrl(),t,s,o,!1):null}},function(e,t,s){"use strict";s.d(t,"c",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"e",(function(){return a})),s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return u}));var n=s(811);const i=new Map,o=new Map,r=new Map,a=e=>i.get(d(e)),c=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],l={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]};function d(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}n.forEach(e=>{const t=c[e.group];l.hasOwnProperty(t)&&l[t].push(e),e.filterString=(`${e.annotation}\n${e.shortcodes.join("\n")}}\n${e.emoticon||""}\n`+e.unicode.split("‍").join("\n")).toLowerCase(),i.set(d(e.unicode),e),e.emoticon&&o.set(e.emoticon,e),e.shortcodes&&e.shortcodes.forEach(t=>{r.set(t,e)})});const u=n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(51),h=s.n(u),m=s(91),p=s(50),g=s(52),f=s(175);class _ extends d.a.PureComponent{constructor(e){super(e),c()(this,"countWatcherRef",void 0),c()(this,"countPreferenceChanged",()=>{this.setState({showCounts:p.a.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})}),c()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),this.props.notification.on(f.a,this.onNotificationUpdate),this.state={showCounts:p.a.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)},this.countWatcherRef=p.a.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){p.a.unwatchSetting(this.countWatcherRef),this.props.notification.off(f.a,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(f.a,this.onNotificationUpdate),this.props.notification.on(f.a,this.onNotificationUpdate)}render(){const e=this.props,{notification:t,forceCount:s,roomId:n,onClick:o}=e,a=r()(e,["notification","forceCount","roomId","onClick"]);if(t.isIdle)return null;let c=!(t.symbol||t.count>0)||!t.hasUnreadCount;if(s&&(c=!1,!t.hasUnreadCount))return null;let l=t.symbol||Object(m.c)(t.count);c&&(l="");const u=h()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!c||t.hasUnreadCount,mx_NotificationBadge_highlighted:t.hasMentions,mx_NotificationBadge_dot:c,mx_NotificationBadge_2char:l.length>0&&l.length<3,mx_NotificationBadge_3char:l.length>2});return o?d.a.createElement(g.a,i()({},a,{className:u,onClick:o}),d.a.createElement("span",{className:"mx_NotificationBadge_count"},l)):d.a.createElement("div",{className:u},d.a.createElement("span",{className:"mx_NotificationBadge_count"},l))}}},function(e,t,s){"use strict";s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"c",(function(){return g}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(51),d=s.n(l),u=s(61);const h=e=>{let{label:t,iconClassName:s,active:n,className:o}=e,a=r()(e,["label","iconClassName","active","className"]);return c.a.createElement(u.h,i()({},a,{className:d()(o,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},m=e=>{let{label:t,iconClassName:s,active:n,className:o}=e,a=r()(e,["label","iconClassName","active","className"]);return c.a.createElement(u.g,i()({},a,{className:d()(o,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},p=e=>{let{label:t,iconClassName:s}=e,n=r()(e,["label","iconClassName"]);return c.a.createElement(u.f,i()({},n,{label:t}),s&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t))},g=({first:e,red:t,className:s,children:n})=>{const i=d()("mx_IconizedContextMenu_optionList",s,{mx_IconizedContextMenu_optionList_notFirst:!e,mx_IconizedContextMenu_optionList_red:t});return c.a.createElement("div",{className:i},n)};t.e=e=>{let{className:t,children:s,compact:n}=e,o=r()(e,["className","children","compact"]);const a=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:n});return c.a.createElement(u.b,i()({chevronFace:u.a.None},o),c.a.createElement("div",{className:a},s))}},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"Notifier",(function(){return _}));var n=s(47),i=s(53),o=s(62),r=s(246),a=s(72),c=s(209),l=s(48),d=s(46),u=s(44),h=s(49),m=s(50),p=s(473),g=s(57);const f={"m.key.verification.request":e=>{const t=(e.sender||{}).name;return Object(u.a)("%(name)s is requesting verification",{name:t})}},_={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return f.hasOwnProperty(e.getContent().msgtype)?f[e.getContent().msgtype](e):r.a(e)},_displayPopupNotification:function(t,s){const n=o.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;if(e.document.hasFocus())return;let i,r=this.notificationMessageForEvent(t);if(!r)return;t.sender&&s.name!==t.sender.name?"m.room.member"===t.getType()?i=s.name:t.sender&&(i=t.sender.name+" ("+s.name+")",t.getContent().body&&!f.hasOwnProperty(t.getContent().msgtype)&&(r=t.getContent().body)):(i=s.name,t.getContent().body&&!f.hasOwnProperty(t.getContent().msgtype)&&(r=t.getContent().body)),this.isBodyEnabled()||(r="");let a=null;t.sender&&!m.a.getValue("lowBandwidth")&&(a=c.a(t.sender,40,40,"crop"));const l=n.displayNotification(i,r,a,s);l&&(void 0===this.notifsByRoom[t.getRoomId()]&&(this.notifsByRoom[t.getRoomId()]=[]),this.notifsByRoom[t.getRoomId()].push(l))},getSoundForRoom:function(e){const t=m.a.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:n.a.get().mxcUrlToHttp(t.url),name:t.name,type:t.type,size:t.size}:(console.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(console.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){const s=this.getSoundForRoom(t.roomId);console.log(`Got sound ${s&&s.name||"default"} for ${t.roomId}`);try{const e=document.querySelector(s?`audio[src='${s.url}']`:"#messageAudio");let t=e;if(!e){if(!s)return void console.error("No audio element or sound to play for notification");t=new Audio(s.url),s.type&&(t.type=s.type),document.body.appendChild(t)}await t.play()}catch(e){console.warn("Caught error when trying to fetch room notification sound:",e)}},start:function(){this.boundOnEvent=this.boundOnEvent||this.onEvent.bind(this),this.boundOnSyncStateChange=this.boundOnSyncStateChange||this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.boundOnRoomReceipt||this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.boundOnEventDecrypted||this.onEventDecrypted.bind(this),n.a.get().on("event",this.boundOnEvent),n.a.get().on("Room.receipt",this.boundOnRoomReceipt),n.a.get().on("Event.decrypted",this.boundOnEventDecrypted),n.a.get().on("sync",this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){n.a.get()&&(n.a.get().removeListener("Event",this.boundOnEvent),n.a.get().removeListener("Room.receipt",this.boundOnRoomReceipt),n.a.get().removeListener("Event.decrypted",this.boundOnEventDecrypted),n.a.get().removeListener("sync",this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){const e=o.a.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){const s=o.a.get();s&&(a.a.trackEvent("Notifier","Set Enabled",e),m.a.isLevelSupported(g.a.DEVICE)&&m.a.setValue("audioNotificationsEnabled",null,g.a.DEVICE,this.isEnabled()),e?s.requestNotificationPermission().then(e=>{if("granted"===e)t&&t(),l.a.dispatch({action:"notifier_enabled",value:!0});else{const t=i.a.get().brand,s="denied"===e?Object(u.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(u.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t}),n=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Unable to enable Notifications",e,n,{title:Object(u.a)("Unable to enable Notifications"),description:s})}}):l.a.dispatch({action:"notifier_enabled",value:!1}),this.setToolbarHidden(!0))},isEnabled:function(){return this.isPossible()&&m.a.getValue("notificationsEnabled")},isPossible:function(){const e=o.a.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&m.a.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return m.a.getValue("audioNotificationsEnabled")},setToolbarHidden:function(t,s=!0){this.toolbarHidden=t,a.a.trackEvent("Notifier","Set Toolbar Hidden",t),Object(p.a)(),s&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))},shouldShowToolbar:function(){const e=n.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!this.isEnabled()&&!this._isToolbarHidden()},_isToolbarHidden:function(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&(!e.sender||e.sender.userId!==n.a.get().credentials.userId))if(e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){const e=o.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const s of this.notifsByRoom[t.roomId])e.clearNotification(s);delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){const t=n.a.get().getRoom(e.getRoomId()),s=n.a.get().getPushActionsForEvent(e);s&&s.notify&&(this.isEnabled()&&this._displayPopupNotification(e,t),s.tweaks.sound&&this.isAudioEnabled()&&(o.a.get().loudNotification(e,t),this._playAudioNotification(e,t)))}};window.mxNotifier||(window.mxNotifier=_),t.default=window.mxNotifier}.call(this,s(6))},function(e,t,s){"use strict";(function(e){class s{constructor(){this.keyRgb=["rgb(118, 207, 166)","rgb(234, 245, 240)","rgb(211, 239, 225)"],this.keyHex=["#76CFA6","#EAF5F0","#D3EFE1","#FFFFFF","#000000"],this.colors=[this.keyHex[0],this.keyHex[1],this.keyHex[2],this.keyHex[3],this.keyHex[4]],this.currentTint=[void 0,void 0,void 0,void 0,void 0],this.cssFixups=[],this.cssAttrs=["color","backgroundColor","borderColor","borderTopColor","borderBottomColor","borderLeftColor"],this.svgAttrs=["fill","stroke"],this.tintables=[],this.theme=void 0,this.forceTint=!1}registerTintable(e){this.tintables.push(e),e()}getKeyRgb(){return this.keyRgb}tint(e,t,s){}tintSvgWhite(e){this.currentTint[3]=e,e||(e=this.colors[3]),this.colors[3]!==e&&(this.colors[3]=e,this.tintables.forEach((function(e){e()})))}tintSvgBlack(e){this.currentTint[4]=e,e||(e=this.colors[4]),this.colors[4]!==e&&(this.colors[4]=e,this.tintables.forEach((function(e){e()})))}setTheme(e){this.theme=e,document.getElementById("mx_theme_accentColor")&&(this.keyRgb[0]=window.getComputedStyle(document.getElementById("mx_theme_accentColor")).color),document.getElementById("mx_theme_secondaryAccentColor")&&(this.keyRgb[1]=window.getComputedStyle(document.getElementById("mx_theme_secondaryAccentColor")).color),document.getElementById("mx_theme_tertiaryAccentColor")&&(this.keyRgb[2]=window.getComputedStyle(document.getElementById("mx_theme_tertiaryAccentColor")).color),this.calcCssFixups(),this.forceTint=!0,this.tint(this.currentTint[0],this.currentTint[1],this.currentTint[2]),"dark"===e?(this.tintSvgWhite("#2d2d2d"),this.tintSvgBlack("#dddddd")):(this.tintSvgWhite("#ffffff"),this.tintSvgBlack("#000000"))}calcCssFixups(){if(!this.cssFixups[this.theme]){0,this.cssFixups[this.theme]=[];for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];try{if(!t)continue;if(!t.href||!t.href.match(new RegExp("/theme-"+this.theme+".css$")))continue;if(t.disabled)continue;if(!t.cssRules)continue;0;for(let e=0;e<t.cssRules.length;e++){const s=t.cssRules[e];if(s.style&&(!s.selectorText||!s.selectorText.match(/#mx_theme/)))for(let e=0;e<this.cssAttrs.length;e++){const t=this.cssAttrs[e];for(let e=0;e<this.keyRgb.length;e++)s.style[t]===this.keyRgb[e]&&this.cssFixups[this.theme].push({style:s.style,attr:t,index:e})}}}catch(e){console.log("Failed to calculate CSS fixups for a stylesheet: "+t.href,e)}}0}}applyCssFixups(){for(let e=0;e<this.cssFixups[this.theme].length;e++){const t=this.cssFixups[this.theme][e];try{t.style[t.attr]=this.colors[t.index]}catch(e){console.error("Failed to apply cssFixup in Tinter! ",e.name)}}}calcSvgFixups(e){const t=[];for(let s=0;s<e.length;s++){let n;try{n=e[s].contentDocument}catch(t){let n="Failed to get svg.contentDocument of "+e[s].toString();t.message&&(n+=t.message),t.stack&&(n+=" | stack: "+t.stack),console.error(n)}if(!n)continue;const i=n.getElementsByTagName("*");for(let e=0;e<i.length;e++){const s=i[e];for(let e=0;e<this.svgAttrs.length;e++){const n=this.svgAttrs[e];for(let e=0;e<this.keyHex.length;e++)s.getAttribute(n)&&s.getAttribute(n).toUpperCase()===this.keyHex[e]&&t.push({node:s,attr:n,index:e})}}}return t}applySvgFixups(e){for(let t=0;t<e.length;t++){const s=e[t];s.node.setAttribute(s.attr,this.colors[s.index])}}}void 0===e.singletonTinter&&(e.singletonTinter=new s),t.a=e.singletonTinter}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return u})),s.d(t,"d",(function(){return h}));var n=s(44),i=s(215),o=s(50),r=s(334);const a="light";function c(){const e={light:Object(n.a)("Light"),dark:Object(n.a)("Dark")},t=o.a.getValue("custom_themes"),s={};for(const{name:e}of t)s["custom-"+e]=e;return Object.assign({},s,e)}const l=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function d(e){const{style:t}=document.body;function s(e,s,n=!0){t.setProperty("--"+e,s),n&&(t.setProperty(`--${e}-0pct`,s+"00"),t.setProperty(`--${e}-15pct`,s+"26"),t.setProperty(`--${e}-50pct`,s+"7F"))}if(e.colors)for(const[t,n]of Object.entries(e.colors))if(Array.isArray(n))for(let e=0;e<n.length;e+=1)s(`${t}_${e}`,n[e],!1);else s(t,n);if(e.fonts){const{fonts:s}=e;if(s.faces){const e=s.faces.map(e=>{const t=e.src&&e.src.map(e=>{let t;return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""}).join(", ");return`@font-face {${Object.keys(e).filter(e=>l.includes(e)).map(s=>{let n;return n="src"===s?t:"font-family"===s?`"${e[s]}"`:e[s],`${s}: ${n}`}).join(";")}}`}).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}s.general&&t.setProperty("--font-family",s.general),s.monospace&&t.setProperty("--font-family-monospace",s.monospace)}}function u(e){const t=o.a.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const s=t.find(t=>t.name===e);if(!s){const s=t.map(e=>e.name).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${s}`)}return s}async function h(t){if(!t){const e=new r.a;t=e.getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let s=t;if(t.startsWith("custom-")){const e=u(t.substr(7));s=e.is_dark?"dark-custom":"light-custom",d(e)}const n=Object.create(null);let o;for(let e=0;o=document.getElementsByTagName("link")[e];e++){const e=o.getAttribute("href").match(/^bundles\/.*\/theme-(.*)\.css$/);e&&(n[e[1]]=o)}if(!(s in n))throw new Error("Unknown theme "+s);return n[s].disabled=!1,new Promise(o=>{const r=function(){n[s].disabled=!1,Object.values(n).forEach(e=>{e!=n[s]&&(e.disabled=!0)});const r=e.getComputedStyle(document.body);r.backgroundColor&&(document.querySelector('meta[name="theme-color"]').content=r.backgroundColor),i.a.setTheme(t),o()};let a=!1;n[s].onload=()=>{r()};for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];if(t&&t.href===n[s].href){a=!0;break}}a&&(n[s].onload=void 0,r())})}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"c",(function(){return r}));var n=s(44);function i(e,t,s,i){let o=s[e];void 0===o&&(o=s[""]);const r=e=>t?React.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return o.includes("<a>")?Object(n.a)(o,{},Object.assign({a:r},i)):Object(n.a)(o,{},i)}function o(e){if("M_TOO_LARGE"===e.errcode)return Object(n.a)("The message you are trying to send is too large.")}function r(e){if("M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=i(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(n.b)("This homeserver has hit its Monthly Active User limit."),"":Object(n.b)("This homeserver has exceeded one of its resource limits.")}),s=i(e.data.limit_type,e.data.admin_contact,{"":Object(n.b)("Please <a>contact your service administrator</a> to continue using the service.")});return React.createElement("div",null,React.createElement("div",null,t),React.createElement("div",null,s))}return React.createElement("div",null,Object(n.a)("Unable to connect to Homeserver. Retrying..."))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(2),i=s.n(n),o=s(48),r=s(493),a=s(196),c=s(50),l=s(70),d=s(54),u=s(57);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const m={showRoomPanel:c.a.getValue("showRightPanelInRoom"),showGroupPanel:c.a.getValue("showRightPanelInGroup"),lastRoomPhase:c.a.getValue("lastRightPanelPhaseForRoom"),lastGroupPhase:c.a.getValue("lastRightPanelPhaseForGroup"),lastRoomPhaseParams:{}},p=[l.b.GroupMemberList,l.b.GroupRoomList,l.b.GroupRoomInfo,l.b.GroupMemberInfo],g=[l.b.RoomMemberInfo,l.b.Room3pidMemberInfo,l.b.EncryptionPanel];class f extends a.Store{constructor(){super(o.a),i()(this,"state",void 0),this.state=m}get isOpenForRoom(){return this.state.showRoomPanel}get isOpenForGroup(){return this.state.showGroupPanel}get roomPanelPhase(){return this.state.lastRoomPhase}get groupPanelPhase(){return this.state.lastGroupPhase}get previousPhase(){return l.a.includes(this.state.previousPhase)?this.state.previousPhase:null}get visibleRoomPanelPhase(){return this.isOpenForRoom?this.roomPanelPhase:null}get visibleGroupPanelPhase(){return this.isOpenForGroup?this.groupPanelPhase:null}get roomPanelPhaseParams(){return this.state.lastRoomPhaseParams||{}}setState(e){this.state=Object.assign(this.state,e),c.a.setValue("showRightPanelInRoom",null,u.a.DEVICE,this.state.showRoomPanel),c.a.setValue("showRightPanelInGroup",null,u.a.DEVICE,this.state.showGroupPanel),l.a.includes(this.state.lastRoomPhase)&&c.a.setValue("lastRightPanelPhaseForRoom",null,u.a.DEVICE,this.state.lastRoomPhase),l.a.includes(this.state.lastGroupPhase)&&c.a.setValue("lastRightPanelPhaseForGroup",null,u.a.DEVICE,this.state.lastGroupPhase),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":case"view_group":g.includes(this.state.lastRoomPhase)&&this.setState({lastRoomPhase:l.b.RoomMemberList,lastRoomPhaseParams:{}}),this.state.lastGroupPhase===l.b.GroupMemberInfo&&this.setState({lastGroupPhase:l.b.GroupMemberList});break;case d.a.SetRightPanelPhase:{let t=e.phase,s=e.refireParams;if(t===l.b.RoomMemberInfo&&e.refireParams){const{member:n}=e.refireParams,i=Object(r.b)(n);i&&(t=l.b.EncryptionPanel,s={verificationRequest:i,member:n})}if(!l.b[t])return void console.warn("Tried to switch right panel to unknown phase: "+t);p.includes(t)?t===this.state.lastGroupPhase?this.setState({showGroupPanel:!this.state.showGroupPanel,previousPhase:null}):this.setState({lastGroupPhase:t,showGroupPanel:!0,previousPhase:this.state.lastGroupPhase}):t!==this.state.lastRoomPhase||s?this.setState({lastRoomPhase:t,showRoomPanel:!0,lastRoomPhaseParams:s||{},previousPhase:this.state.lastRoomPhase}):this.setState({showRoomPanel:!this.state.showRoomPanel,previousPhase:null}),o.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:d.a.AfterRightPanelPhaseChange,phase:t},s||{}));break}case d.a.ToggleRightPanel:"room"===e.type?this.setState({showRoomPanel:!this.state.showRoomPanel}):this.setState({showGroupPanel:!this.state.showGroupPanel})}}static getSharedInstance(){return f.instance||(f.instance=new f),f.instance}}i()(f,"instance",void 0),window.mxRightPanelStore=f.getSharedInstance()},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(2),c=s.n(a),l=s(43),d=s.n(l),u=s(48),h=s(54),m=s(47),p=s(127);class g extends d.a.Component{constructor(e){super(e),this.state=g.getState(e)}static getDerivedStateFromProps(e){return g.getState(e)}static getState(e){return e.member&&e.member.name?{name:e.member.name,title:e.title||e.member.userId,imageUrl:e.member.getAvatarUrl(m.a.get().getHomeserverUrl(),Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod,!1,!1)}:e.fallbackUserId?{name:e.fallbackUserId,title:e.fallbackUserId}:void console.error("MemberAvatar called somehow with null member or fallbackUserId")}render(){let e=this.props,{member:t,fallbackUserId:s,onClick:n,viewUserOnClick:o}=e,a=r()(e,["member","fallbackUserId","onClick","viewUserOnClick"]);const c=t?t.userId:s;return o&&(n=()=>{u.a.dispatch({action:h.a.ViewUser,member:this.props.member})}),d.a.createElement(p.a,i()({},a,{name:this.state.name,title:this.state.title,idName:c,url:this.state.imageUrl,onClick:n}))}}c()(g,"defaultProps",{width:40,height:40,resizeMethod:"crop",viewUserOnClick:!1})},,,,function(e,t,s){"use strict";s.d(t,"i",(function(){return Y})),s.d(t,"d",(function(){return J})),s.d(t,"c",(function(){return Q})),s.d(t,"a",(function(){return X})),s.d(t,"e",(function(){return Z})),s.d(t,"b",(function(){return ee})),s.d(t,"l",(function(){return te})),s.d(t,"f",(function(){return se})),s.d(t,"j",(function(){return ae})),s.d(t,"m",(function(){return ce})),s.d(t,"h",(function(){return le})),s.d(t,"g",(function(){return de})),s.d(t,"k",(function(){return ue})),s.d(t,"n",(function(){return me}));var n=s(55),i=s(47),o=s(177),r=s(370),a=s(72),c=s(214),l=s(474),d=s(48),u=s(178);const h=["online","offline","unavailable"];var m=new class{constructor(){this._activitySignal=null,this._unavailableTimer=null,this._onAction=this._onAction.bind(this),this._dispatcherRef=null}async start(){for(this._unavailableTimer=new u.a(18e4),this._dispatcherRef=d.a.register(this._onAction);this._unavailableTimer;)try{await this._unavailableTimer.finished(),this.setState("unavailable")}catch(e){}}stop(){this._dispatcherRef&&(d.a.unregister(this._dispatcherRef),this._dispatcherRef=null),this._unavailableTimer&&(this._unavailableTimer.abort(),this._unavailableTimer=null)}getState(){return this.state}_onAction(e){"user_activity"===e.action&&(this.setState("online"),this._unavailableTimer.restart())}async setState(e){if(e===this.state)return;if(-1===h.indexOf(e))throw new Error("Bad presence state: "+e);const t=this.state;if(this.state=e,!i.a.get().isGuest())try{await i.a.get().setPresence(this.state),console.info("Presence: %s",e)}catch(e){console.error("Failed to set presence: %s",e),this.state=t}}},p=s(90),g=s(49),f=s(46),_=s(142),v=s(62),y=s(255),b=s(281),E=s(50),S=s(475),w=s(78),C=s(93),R=s(330),k=s(2),I=s.n(k),O=s(44),T=s(92);var x=s(476),N=s(105);const j=e=>{switch(e){case A.SET_UP_ENCRYPTION:return Object(O.a)("Set up encryption");case A.UPGRADE_ENCRYPTION:return Object(O.a)("Encryption upgrade available");case A.VERIFY_THIS_SESSION:return Object(O.a)("Verify this session")}},P=e=>{switch(e){case A.SET_UP_ENCRYPTION:return Object(O.a)("Set up");case A.UPGRADE_ENCRYPTION:return Object(O.a)("Upgrade");case A.VERIFY_THIS_SESSION:return Object(O.a)("Verify")}},D=e=>{switch(e){case A.SET_UP_ENCRYPTION:case A.UPGRADE_ENCRYPTION:return Object(O.a)("Verify yourself & others to keep your chats safe");case A.VERIFY_THIS_SESSION:return Object(O.a)("Other users may not trust it")}};let A;!function(e){e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session"}(A||(A={}));const U=()=>{H.sharedInstance().dismissEncryptionSetup()},M=e=>{w.a.sharedInstance().addOrReplaceToast({key:"setupencryption",title:j(e),icon:"verification_warning",props:{description:D(e),acceptLabel:P(e),onAccept:async()=>{if(e===A.VERIFY_THIS_SESSION)g.a.createTrackedDialog("Verify session","Verify session",x.a,{},null,!1,!0);else{const e=f.getComponent("elements.Spinner"),t=g.a.createDialog(e,null,"mx_Dialog_spinner",!1,!0);try{await Object(N.b)()}finally{t.close()}}},rejectLabel:Object(O.a)("Later"),onReject:U},component:T.a,priority:e===A.VERIFY_THIS_SESSION?95:40})},L=()=>{w.a.sharedInstance().dismissToast("setupencryption")};var F=s(477);function B(e){return"unverified_session_"+e}const V=e=>{const t=i.a.get(),s=t.getStoredDevice(t.getUserId(),e);w.a.sharedInstance().addOrReplaceToast({key:B(e),title:Object(O.a)("New login. Was this you?"),icon:"verification_warning",props:{description:Object(O.a)("Verify the new login accessing your account: %(name)s",{name:s.getDisplayName()}),acceptLabel:Object(O.a)("Verify"),onAccept:()=>{g.a.createTrackedDialog("New Session Review","Starting dialog",F.a,{userId:t.getUserId(),device:t.getStoredDevice(t.getUserId(),e),onFinished:t=>{t||H.sharedInstance().dismissUnverifiedSessions([e])}},null,!1,!0)},rejectLabel:Object(O.a)("Later"),onReject:()=>{H.sharedInstance().dismissUnverifiedSessions([e])}},component:T.a,priority:80})},K=e=>{w.a.sharedInstance().dismissToast(B(e))};var q=s(98),G=s(206),W=s(546);class H{constructor(){I()(this,"dispatcherRef",void 0),I()(this,"dismissed",new Set),I()(this,"dismissedThisDeviceToast",!1),I()(this,"keyBackupInfo",null),I()(this,"keyBackupFetchedAt",null),I()(this,"ourDeviceIdsAtStart",null),I()(this,"displayingToastsForDeviceIds",new Set),I()(this,"_onWillUpdateDevices",async(e,t)=>{if(t)return;const s=i.a.get().getUserId();e.includes(s)&&this._ensureDeviceIdsAtStartPopulated()}),I()(this,"_onDevicesUpdated",e=>{e.includes(i.a.get().getUserId())&&this._recheck()}),I()(this,"_onDeviceVerificationChanged",e=>{e===i.a.get().getUserId()&&this._recheck()}),I()(this,"_onUserTrustStatusChanged",e=>{e===i.a.get().getUserId()&&this._recheck()}),I()(this,"_onCrossSingingKeysChanged",()=>{this._recheck()}),I()(this,"_onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing."))&&this._recheck()}),I()(this,"_onSync",(e,t)=>{"PREPARED"===e&&null===t&&this._recheck()}),I()(this,"_onAction",({action:e})=>{"on_logged_in"===e&&this._recheck()})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new H),window.mxDeviceListener}start(){i.a.get().on("crypto.willUpdateDevices",this._onWillUpdateDevices),i.a.get().on("crypto.devicesUpdated",this._onDevicesUpdated),i.a.get().on("deviceVerificationChanged",this._onDeviceVerificationChanged),i.a.get().on("userTrustStatusChanged",this._onUserTrustStatusChanged),i.a.get().on("crossSigning.keysChanged",this._onCrossSingingKeysChanged),i.a.get().on("accountData",this._onAccountData),i.a.get().on("sync",this._onSync),this.dispatcherRef=d.a.register(this._onAction),this._recheck()}stop(){i.a.get()&&(i.a.get().removeListener("crypto.willUpdateDevices",this._onWillUpdateDevices),i.a.get().removeListener("crypto.devicesUpdated",this._onDevicesUpdated),i.a.get().removeListener("deviceVerificationChanged",this._onDeviceVerificationChanged),i.a.get().removeListener("userTrustStatusChanged",this._onUserTrustStatusChanged),i.a.get().removeListener("crossSigning.keysChanged",this._onCrossSingingKeysChanged),i.a.get().removeListener("accountData",this._onAccountData),i.a.get().removeListener("sync",this._onSync)),this.dispatcherRef&&(d.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){for(const t of e)this.dismissed.add(t);this._recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this._recheck()}_ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=i.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map(e=>e.deviceId))}}async _getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await i.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(N.d)())return!1;if(Object(q.e)())return!0;const e=i.a.get();return e&&e.getRooms().some(t=>e.isRoomEncrypted(t.roomId))}async _recheck(){const e=i.a.get();if(!await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))return;if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;const t=await e.isCrossSigningReady(),s=await e.isSecretStorageReady(),n=t&&s;if(this.dismissedThisDeviceToast||n)L();else if(this.shouldShowSetupEncryptionToast())if(await e.downloadKeys([e.getUserId()]),!e.getCrossSigningId()&&e.getStoredCrossSigningForUser(e.getUserId()))M(A.VERIFY_THIS_SESSION);else{await this._getKeyBackupInfo()?M(A.UPGRADE_ENCRYPTION):(await e.waitForClientWellKnown(),Object(G.b)()&&Object(W.b)()?(L(),Object(N.b)()):M(A.SET_UP_ENCRYPTION))}this._ensureDeviceIdsAtStartPopulated();const o=new Set,r=new Set;if(t){const t=e.getStoredDevicesForUser(e.getUserId());for(const s of t){if(s.deviceId===e.deviceId)continue;(await e.checkDeviceTrust(e.getUserId(),s.deviceId)).isCrossSigningVerified()||this.dismissed.has(s.deviceId)||(this.ourDeviceIdsAtStart.has(s.deviceId)?o.add(s.deviceId):r.add(s.deviceId))}}var a;o.size>0?(a=o,w.a.sharedInstance().addOrReplaceToast({key:"reviewsessions",title:Object(O.a)("Review where you’re logged in"),icon:"verification_warning",props:{description:Object(O.a)("Verify all your sessions to ensure your account & messages are safe"),acceptLabel:Object(O.a)("Review"),onAccept:()=>{H.sharedInstance().dismissUnverifiedSessions(a),d.a.dispatch({action:"view_user_info",userId:i.a.get().getUserId()})},rejectLabel:Object(O.a)("Later"),onReject:()=>{H.sharedInstance().dismissUnverifiedSessions(a)}},component:T.a,priority:50})):w.a.sharedInstance().dismissToast("reviewsessions");for(const e of r)V(e);for(const e of this.displayingToastsForDeviceIds)r.has(e)||K(e);this.displayingToastsForDeviceIds=r}}var $=s(316),z=s(180);async function Y(e){try{let t=e.enableGuest||!1;const s=e.guestHsUrl,i=e.guestIsUrl,o=e.fragmentQueryParams||{},r=e.defaultDeviceDisplayName;if(t&&!s&&(console.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&o.guest_user_id&&o.guest_access_token)return console.log("Using guest access credentials"),ne({userId:o.guest_user_id,accessToken:o.guest_access_token,homeserverUrl:s,identityServerUrl:i,guest:!0},!0).then(()=>!0);return!!await async function(e){const t=e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:s,isUrl:n,accessToken:i,userId:o,deviceId:r,isGuest:a}=ee();if(i&&o&&s){if(t&&a)return console.log("Ignoring stored guest account: "+o),!1;const e=await v.a.get().getPickleKey(o,r);return e?console.log("Got pickle key"):console.log("No pickle key available"),console.log("Restoring session for "+o),await ne({userId:o,deviceId:r,accessToken:i,homeserverUrl:s,identityServerUrl:n,guest:a,pickleKey:e},!1),!0}return console.log("No previous session found."),!1}({ignoreGuest:Boolean(e.ignoreGuest)})||!!t&&function(e,t,s){console.log("Doing guest login on "+e);return n.r.createClient({baseUrl:e}).registerGuest({body:{initial_device_display_name:s}}).then(s=>(console.log("Registered as guest: "+s.user_id),ne({userId:s.user_id,deviceId:s.device_id,accessToken:s.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then(()=>!0)),e=>(console.error("Failed to register as guest",e),!1))}(s,i,r)}catch(e){return!(e instanceof ie)&&async function(e){console.error("Unable to load session",e);const t=f.getComponent("views.dialogs.SessionRestoreErrorDialog"),s=g.a.createTrackedDialog("Session Restore Error","",t,{error:e.message}),[n]=await s.finished;if(n)return await he(),!1;return Y()}(e)}}function J(){const{hsUrl:e,userId:t,accessToken:s}=ee();return e&&t&&s?t:null}function Q(){const e=ee();return e.hsUrl&&e.userId&&e.accessToken?e.isGuest:null}function X(e,t){if(!e.loginToken)return Promise.resolve(!1);const s=localStorage.getItem(z.a),n=localStorage.getItem(z.b);return s?Object(y.b)(s,n,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return console.log("Logged in with token"),he().then(()=>(oe(e),!0))})).catch(e=>(console.error("Failed to log in with login token: "+e+" "+e.data),!1)):(console.warn("Cannot log in with token: can't determine HS URL to use"),Promise.resolve(!1))}function Z(e){if(e.reason===n.r.InvalidStoreError.TOGGLED_LAZY_LOADING)return Promise.resolve().then(()=>{if(e.value){const e=f.getComponent("views.dialogs.LazyLoadingResyncDialog");return new Promise(t=>{g.a.createDialog(e,{onFinished:t})})}{const e=f.getComponent("views.dialogs.LazyLoadingDisabledDialog");return new Promise(t=>{g.a.createDialog(e,{onFinished:t,host:window.location.host})})}}).then(()=>i.a.get().store.deleteAllData()).then(()=>{v.a.get().reload()})}function ee(){const e=localStorage.getItem("mx_hs_url"),t=localStorage.getItem("mx_is_url"),s=localStorage.getItem("mx_access_token"),n=localStorage.getItem("mx_user_id"),i=localStorage.getItem("mx_device_id");let o;return o=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,accessToken:s,userId:n,deviceId:i,isGuest:o}}async function te(e){me();const t=e.userId&&e.deviceId?await v.a.get().createPickleKey(e.userId,e.deviceId):null;return t?console.log("Created pickle key"):console.log("Pickle key not created"),ne(Object.assign({},e,{pickleKey:t}),!0)}function se(e){const t=i.a.get().getUserId(),s=i.a.get().getDeviceId();me(),localStorage.removeItem("mx_soft_logout"),re=!1;const n=e.userId!==t||e.deviceId!==s;return n&&console.warn("Clearing all data: Old session belongs to a different user/session"),ne(e,n)}async function ne(e,t){e.guest=Boolean(e.guest);const s=le();console.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+s),d.a.dispatch({action:"on_logging_in"},!0),t&&await he();const n=await b.a();if(n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore){if(await function(){const e=f.getComponent("views.dialogs.StorageEvictedDialog");return new Promise(t=>{g.a.createTrackedDialog("Storage evicted","",e,{onFinished:t})})}())throw await he(),new ie("Aborting login in progress because of storage inconsistency")}if(a.a.setLoggedIn(e.guest,e.homeserverUrl),localStorage)try{oe(e),e.password&&d.a.dispatch({action:"cached_password",cachedPassword:e.password})}catch(e){console.warn("Error using local storage: can't persist session!",e)}else console.warn("No local storage available: can't persist session!");return i.a.replaceUsingCreds(e),d.a.dispatch({action:"on_logged_in"}),await async function(e=!0){console.log("Lifecycle: Starting MatrixClient"),d.a.dispatch({action:"will_start_client"},!0),S.a.sharedInstance().reset(),w.a.sharedInstance().reset(),c.default.start(),l.a.sharedInstance().start(),p.a.makeShared().start(),C.a.sharedInstance().startWatching(),_.a.start(),R.a.sharedInstance().start(),e?(await o.a.init(),await i.a.start()):(console.warn("Caller requested only auxiliary services be started"),await i.a.assign());H.sharedInstance().start(),E.a.getValue("lowBandwidth")||m.start();await $.a.getInstance().start(),d.a.dispatch({action:"client_started"}),le()&&ce()}(!s),i.a.get()}class ie extends Error{}function oe(e){localStorage.setItem("mx_hs_url",e.homeserverUrl),e.identityServerUrl&&localStorage.setItem("mx_is_url",e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_access_token",e.accessToken),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.pickleKey?localStorage.setItem("mx_has_pickle_key",!0):localStorage.getItem("mx_has_pickle_key")&&console.error("Expected a pickle key, but none provided.  Encryption may not work."),e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),console.log("Session persisted for "+e.userId)}let re=!1;function ae(){if(!i.a.get())return;if(i.a.get().isGuest())return void ue();re=!0;const e=i.a.get();v.a.get().destroyPickleKey(e.getUserId(),e.getDeviceId()),e.logout().then(ue,e=>{console.log("Failed to call logout API: token will not be invalidated"),ue()})}function ce(){i.a.get()&&(localStorage.setItem("mx_soft_logout","true"),console.log("Soft logout initiated"),re=!0,d.a.dispatch({action:"on_client_not_viable"}),me(!1))}function le(){return"true"===localStorage.getItem("mx_soft_logout")}function de(){return re}async function ue(){re=!1,d.a.dispatch({action:"on_logged_out"},!0),me(),await he()}async function he(){a.a.disable(),window.localStorage&&window.localStorage.clear(),window.sessionStorage&&window.sessionStorage.clear();const e=Object(r.a)({baseUrl:""});await o.a.deleteEventIndex(),await e.clearStores()}function me(e=!0){c.default.stop(),l.a.sharedInstance().stop(),S.a.sharedInstance().reset(),m.stop(),_.a.stop(),C.a.sharedInstance().stopWatching(),R.a.sharedInstance().stop(),H.sharedInstance().stop(),p.a.shared()&&p.a.shared().stop(),o.a.stop();const t=i.a.get();t&&(t.stopClient(),t.removeAllListeners(),e&&(i.a.unset(),o.a.unset()))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=function(e,t){for(const s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e},c=s(48),l=s(47),d=s(46),u=s(44),h=s(49),m=s(74),p=s(492),g=s.n(p),f=s(838),_=s.n(f),v=s(99),y=(s(840),s(54));const b=[0,0,22,37,0,0,22,37,1];class E extends Error{}function S(e,t,s,n){return new Promise(i=>{let o=t,r=s;r>600&&(o=Math.floor(o*(600/r)),r=600),o>800&&(r=Math.floor(r*(800/o)),o=800);const a=document.createElement("canvas");a.width=o,a.height=r,a.getContext("2d").drawImage(e,0,0,o,r),a.toBlob((function(e){i({info:{thumbnail_info:{w:o,h:r,mimetype:e.type,size:e.size},w:t,h:s},thumbnail:e})}),n)})}function w(e,t,s){let n,i="image/png";return"image/jpeg"===s.type&&(i="image/jpeg"),async function(e){const t=document.createElement("img"),s=URL.createObjectURL(e),n=new Promise((e,n)=>{t.onload=function(){URL.revokeObjectURL(s),e(t)},t.onerror=function(e){n(e)}});let i;if(t.src=s,"image/png"===e.type){i=R(e).then(e=>{const t=new Uint8Array(e),s=_()(t);for(const e of s)if("pHYs"===e.name){if(e.data.byteLength!==b.length)return;return e.data.every((e,t)=>e===b[t])}return!1})}const[o]=await Promise.all([i,n]);return{width:o?t.width>>1:t.width,height:o?t.height>>1:t.height,img:t}}(s).then((function(e){return S(e.img,e.width,e.height,i)})).then((function(s){return n=s.info,k(e,t,s.thumbnail)})).then((function(e){return n.thumbnail_url=e.url,n.thumbnail_file=e.file,n}))}function C(e,t,s){let n;return function(e){return new Promise((t,s)=>{const n=document.createElement("video"),i=new FileReader;i.onload=function(e){n.src=e.target.result,n.onloadeddata=function(){t(n)},n.onerror=function(e){s(e)}},i.onerror=function(e){s(e)},i.readAsDataURL(e)})}(s).then((function(e){return S(e,e.videoWidth,e.videoHeight,"image/jpeg")})).then((function(s){return n=s.info,k(e,t,s.thumbnail)})).then((function(e){return n.thumbnail_url=e.url,n.thumbnail_file=e.file,n}))}function R(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){s(e)},n.readAsArrayBuffer(e)})}function k(e,t,s,n){let i=!1;if(e.isRoomEncrypted(t)){let t,o;const r=R(s).then((function(e){if(i)throw new E;return g.a.encryptAttachment(e)})).then((function(s){if(i)throw new E;o=s.info;const r=new Blob([s.data]);return t=e.uploadContent(r,{progressHandler:n,includeFilename:!1}),t})).then((function(e){if(i)throw new E;return o.url=e,s.type&&(o.mimetype=s.type),{file:o}}));return r.abort=()=>{i=!0,t&&l.a.get().cancelUpload(t)},r}{const t=e.uploadContent(s,{progressHandler:n}),o=t.then((function(e){if(i)throw new E;return{url:e}}));return o.abort=()=>{i=!0,l.a.get().cancelUpload(t)},o}}class I{constructor(){i()(this,"inprogress",[]),i()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,s,n,i){return l.a.get().sendStickerMessage(t,e,s,n).catch(s=>{throw console.warn(`Failed to send content with URL ${e} to room ${t}`,s),s})}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,s){if(s.isGuest())return void c.a.dispatch({action:"require_registration"});if(Boolean(m.a.getQuotingEvent())){const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=h.a.createTrackedDialog("Upload Reply Warning","",e,{title:Object(u.a)("Replying With Files"),description:r.a.createElement("div",null,Object(u.a)("At this time it is not possible to reply with a file. Would you like to upload this file without replying?")),hasCancelButton:!0,button:Object(u.a)("Continue")}),[s]=await t;if(!s)return}if(!this.mediaConfig){const e=h.a.createDialog(v.a,null,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(),e.close()}const n=[],i=[];for(let t=0;t<e.length;++t)this.isFileSizeAcceptable(e[t])?i.push(e[t]):n.push(e[t]);if(n.length>0){const t=d.getComponent("dialogs.UploadFailureDialog"),{finished:s}=h.a.createTrackedDialog("Upload Failure","",t,{badFiles:n,totalFiles:e.length,contentMessages:this}),[i]=await s;if(!i)return}const o=d.getComponent("dialogs.UploadConfirmDialog");let a=!1,l=Promise.resolve();for(let e=0;e<i.length;++e){const n=i[e];if(!a){const{finished:t}=h.a.createTrackedDialog("Upload Files confirmation","",o,{file:n,currentIndex:e,totalFiles:i.length}),[s,r]=await t;if(!s)break;r&&(a=!0)}l=this.sendContentToRoom(n,t,s,l)}}getCurrentUploads(){return this.inprogress.filter(e=>!e.canceled)}cancelUpload(e){let t;for(let s=0;s<this.inprogress.length;++s)if(this.inprogress[s].promise===e){t=this.inprogress[s];break}t&&(t.canceled=!0,l.a.get().cancelUpload(t.promise),c.a.dispatch({action:"upload_canceled",upload:t}))}sendContentToRoom(e,t,s,n){const i={body:e.name||"Attachment",info:{size:e.size},msgtype:""};e.type&&(i.info.mimetype=e.type);const o=new Promise(n=>{0===e.type.indexOf("image/")?(i.msgtype="m.image",w(s,t,e).then(e=>{a(i.info,e),n()},e=>{console.error(e),i.msgtype="m.file",n()})):0===e.type.indexOf("audio/")?(i.msgtype="m.audio",n()):0===e.type.indexOf("video/")?(i.msgtype="m.video",C(s,t,e).then(e=>{a(i.info,e),n()},e=>{i.msgtype="m.file",n()})):(i.msgtype="m.file",n())});o.abort=()=>{r.canceled=!0};const r={fileName:e.name||"Attachment",roomId:t,total:e.size,loaded:0,promise:o};function l(e){r.total=e.total,r.loaded=e.loaded,c.a.dispatch({action:"upload_progress",upload:r})}let m;return this.inprogress.push(r),c.a.dispatch({action:"upload_started"}),c.a.fire(y.a.FocusComposer),o.then((function(){if(r.canceled)throw new E;return r.promise=k(s,t,e,l),r.promise.then((function(e){i.file=e.file,i.url=e.url}))})).then(()=>n).then((function(){if(r.canceled)throw new E;return s.sendMessage(t,i)}),(function(e){if(m=e,!r.canceled){let t=Object(u.a)("The file '%(fileName)s' failed to upload.",{fileName:r.fileName});413===e.http_status&&(t=Object(u.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:r.fileName}));const s=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Upload failed","",s,{title:Object(u.a)("Upload Failed"),description:t})}})).finally(()=>{for(let e=0;e<this.inprogress.length;++e)if(this.inprogress[e].promise===r.promise){this.inprogress.splice(e,1);break}m?(m&&413===m.http_status&&(this.mediaConfig=null),c.a.dispatch({action:"upload_failed",upload:r,error:m})):(c.a.dispatch({action:"upload_finished",upload:r}),c.a.dispatch({action:"message_sent"}))})}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(){if(null===this.mediaConfig)return console.log("[Media Config] Fetching"),l.a.get().getMediaConfig().then(e=>(console.log("[Media Config] Fetched config:",e),e)).catch(()=>(console.log("[Media Config] Could not fetch config, so not limiting uploads."),{})).then(e=>{this.mediaConfig=e})}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new I),window.mxContentMessages}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1),i=s(10);function o(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}n.o(o,i.EventEmitter),o.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},o.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},o.prototype.setInviter=function(e){this.inviter=e}},function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return j})),s.d(t,"c",(function(){return P})),s.d(t,"a",(function(){return D})),s.d(t,"b",(function(){return A}));var i=s(274),o=s.n(i),r=s(10),a=s(273),c=s(0),l=s(1),d=s(373),u=s(85),h=s(579),m=s(228),p=s(547),g=s(229),f=s(580),_=s(581),v=s(582),y=s(108),b=s(193),E=s(583),S=s(277),w=s(278),C=s(135),R=s(587),k=s(588),I=s(589),O=s(158),T=s(275);const x=m.a.DeviceVerification,N={[b.b.NAME]:b.b,[E.a.NAME]:E.a,[b.d]:I.a,[b.c]:I.a},j={RECIPROCATE_QR_CODE:b.b.NAME,SAS:E.a.NAME};function P(){return Boolean(e.Olm)}function D(e,t,s,n,i,o,r,c){if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._trustCrossSignedDevices=!0,this._reEmitter=new a.a(this),this._baseApis=e,this._sessionStore=t,this._userId=s,this._deviceId=n,this._clientStore=i,this._cryptoStore=o,this._roomList=r,c){this._verificationMethods=new Map;for(const e of c)"string"==typeof e?N[e]&&this._verificationMethods.set(e,N[e]):e.NAME?this._verificationMethods.set(e.NAME,e):console.warn("Excluding unknown verification method "+e)}else this._verificationMethods=N;this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new d.a(o),this._deviceList=new h.a(e,o,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=l.t(p.a),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new v.a(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new k.b,this._inRoomVerificationRequests=new R.b,this._sendKeyRequestsImmediately=!1;const u=this._baseApis._cryptoCallbacks||{},m=Object(g.d)(o,this._olmDevice);this._crossSigningInfo=new g.a(s,u,m),this._secretStorage=new _.b(e,u),!u.getCrossSigningKey&&u.getSecretStorageKey&&(u.getCrossSigningKey=async e=>g.a.getFromSecretStorage(e,this._secretStorage))}function A(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),e=>parseInt(e));return u.encodeBase64(t)}function U(e){if(e._oneTimeKeyCheckInProgress)return;const t=Date.now();if(null!==e._lastOneTimeKeyCheck&&t-e._lastOneTimeKeyCheck<6e4)return;e._lastOneTimeKeyCheck=t;const s=e._olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(s/2);function i(t){if(n<=t)return Promise.resolve();const s=Math.min(n-t,5);return e._olmDevice.generateOneTimeKeys(s).then(()=>async function(e){const t=await e._olmDevice.getOneTimeKeys(),s={},n=[];for(const i in t.curve25519)if(t.curve25519.hasOwnProperty(i)){const o={key:t.curve25519[i]};s["signed_curve25519:"+i]=o,n.push(e._signObject(o))}await Promise.all(n);const i=await e._baseApis.uploadKeysRequest({one_time_keys:s});return await e._olmDevice.markKeysAsPublished(),i}(e)).then(e=>{if(e.one_time_key_counts&&e.one_time_key_counts.signed_curve25519)return i(e.one_time_key_counts.signed_curve25519);throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")})}e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>i(e)).catch(e=>{c.a.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1})}l.o(D,r.EventEmitter),D.prototype.init=async function(t){const{exportedOlmDevice:s,pickleKey:n}=t||{};c.a.log("Crypto: initialising Olm..."),await e.Olm.init(),c.a.log(s?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this._olmDevice.init({fromExportedDevice:s,pickleKey:n}),c.a.log("Crypto: loading device list..."),await this._deviceList.load(),this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,c.a.log("Crypto: fetching own devices...");let i=this._deviceList.getRawStoredDevicesForUser(this._userId);if(i||(i={}),!i[this._deviceId]){c.a.log("Crypto: adding this device to the store...");const e={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:x.VERIFIED,known:!0};i[this._deviceId]=e,this._deviceList.storeDevicesForUser(this._userId,i),this._deviceList.saveIfDirty()}await this._cryptoStore.doTxn("readonly",[y.a.STORE_ACCOUNT],e=>{this._cryptoStore.getCrossSigningKeys(e,e=>{e&&0!==Object.keys(e).length&&(c.a.log("Loaded cross-signing public keys from crypto store"),this._crossSigningInfo.setKeys(e))})}),this._deviceList.startTrackingDeviceList(this._userId),c.a.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup()},D.prototype.getCryptoTrustCrossSignedDevices=function(){return this._trustCrossSignedDevices},D.prototype.setCryptoTrustCrossSignedDevices=function(e){this._trustCrossSignedDevices=e;for(const e of this._deviceList.getKnownUserIds()){const t=this._deviceList.getRawStoredDevicesForUser(e);for(const s of Object.keys(t)){const t=this.checkDeviceTrust(e,s);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this._deviceList.getStoredDevice(e,s);this.emit("deviceVerificationChanged",e,s,t)}}}},D.prototype.createRecoveryKeyFromPassphrase=async function(t){const s=new e.Olm.PkDecryption;try{const e={};if(t){const n=await Object(S.c)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:n.iterations,salt:n.salt},e.pubkey=s.init_with_private_key(n.key)}else e.pubkey=s.generate_key();const n=s.get_private_key();return{keyInfo:e,encodedPrivateKey:Object(w.b)(n),privateKey:n}}finally{s&&s.free()}},D.prototype.isCrossSigningReady=async function(){const e=this._crossSigningInfo.getId(),t=await this._crossSigningInfo.isStoredInKeyCache()||await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);return!(!e||!t)},D.prototype.isSecretStorageReady=async function(){const e=await this._secretStorage.hasKey(),t=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage),s=!this._baseApis.getKeyBackupEnabled()||this._baseApis.isKeyBackupKeyStored();return!!(e&&t&&s)},D.prototype.bootstrapCrossSigning=async function({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){c.a.log("Bootstrapping cross-signing");const s=this._baseApis._cryptoCallbacks,n=new f.a(this._baseApis.store.accountData,s),i=new g.a(this._userId,n.crossSigningCallbacks,n.crossSigningCallbacks),o=async()=>{i.resetKeys(),await this._signObject(i.keys.master),n.addCrossSigningKeys(e,i.keys);const t=this._deviceList.getStoredDevice(this._userId,this._deviceId),s=await i.signDevice(this._userId,t);n.addKeySignature(this._userId,this._deviceId,s),this.backupInfo&&(await i.signObject(this.backupInfo.auth_data,"master"),n.addSessionBackup(this.backupInfo))},r=this._crossSigningInfo.getId(),a=await this._crossSigningInfo.isStoredInKeyCache(),l=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);!(a||l)||t?(c.a.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):r&&a?c.a.log("Cross-signing public keys trusted and private keys found locally"):l&&(c.a.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust());const d=n.crossSigningCallbacks.privateKeys;if(d.size&&!this._baseApis._cryptoCallbacks.saveCrossSigningKeys){const e=new _.b(n.accountDataClientAdapter,n.ssssCryptoCallbacks);await e.hasKey()&&(c.a.log("Storing new cross-signing private keys in secret storage"),await g.a.storeInSecretStorage(d,e))}const u=n.buildOperation();await u.apply(this),await n.persist(this),c.a.log("Cross-signing ready")},D.prototype.bootstrapSecretStorage=async function({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:n,getKeyBackupPassphrase:i}={}){c.a.log("Bootstrapping Secure Secret Storage");const o=this._baseApis._cryptoCallbacks,r=new f.a(this._baseApis.store.accountData,o),a=new _.b(r.accountDataClientAdapter,r.ssssCryptoCallbacks);let l=null;const d=async(e,t)=>{e=e||{},t&&(e.key=t);const s=await a.addKey(_.a,e);return t&&r.ssssCryptoCallbacks.addPrivateKey(s,t),await a.setDefaultKeyId(s),s},h=async(e,t)=>{if(!t.mac){const s=await this._baseApis._cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(s){const n=s[1];r.ssssCryptoCallbacks.addPrivateKey(e,n);const{iv:i,mac:o}=await _.b._calculateKeyCheck(n);t.iv=i,t.mac=o,await r.setAccountData("m.secret_storage.key."+e,t)}}},m=await this.getSecretStorageKey(),[p,v]=m||[null,null],y=!n&&v&&v.algorithm===_.a;if(y||t)if(!y&&t){c.a.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i(),s={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(s.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),l=await d(s,e),await a.store("m.megolm_backup.v1",u.encodeBase64(e),[l]),c.a.log("Adding cross signing signature to key backup"),await this._crossSigningInfo.signObject(t.auth_data,"master"),r.addSessionBackup(t)}else c.a.log("Secret storage exists"),v&&v.algorithm===_.a&&await h(p,v);else{c.a.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:s}=await e();l=await d(t,s)}if(!this._baseApis._cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(l||!await this._crossSigningInfo.isStoredInSecretStorage(a))){c.a.log("Copying cross-signing private keys from cache to secret storage");const e=await this._crossSigningInfo.getCrossSigningKeysFromCache();await g.a.storeInSecretStorage(e,a)}if(s&&!t){c.a.log("Creating new message key backup version");const e=await this._baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=Object(w.a)(e.recovery_key);await a.store("m.megolm_backup.v1",u.encodeBase64(t));const s={algorithm:e.algorithm,auth_data:e.auth_data};await this._crossSigningInfo.signObject(s.auth_data,"master"),await this._signObject(s.auth_data),r.addSessionBackup(s)}const b=await a.get("m.megolm_backup.v1");if(b){c.a.info("Got session backup key from secret storage: caching");const e=A(b);e&&await a.store("m.megolm_backup.v1",e,[l||p]);const t=new Uint8Array(u.decodeBase64(e||b));await r.addSessionBackupPrivateKeyToCache(t)}const E=r.buildOperation();await E.apply(this),await r.persist(this),c.a.log("Secure Secret Storage ready")},D.prototype.addSecretStorageKey=function(e,t,s){return this._secretStorage.addKey(e,t,s)},D.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},D.prototype.getSecretStorageKey=function(e){return this._secretStorage.getKey(e)},D.prototype.storeSecret=function(e,t,s){return this._secretStorage.store(e,t,s)},D.prototype.getSecret=function(e){return this._secretStorage.get(e)},D.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},D.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},D.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},D.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},D.prototype.checkSecretStorageKey=function(e,t){return this._secretStorage.checkKey(e,t)},D.prototype.checkSecretStoragePrivateKey=function(t,s){let n=null;try{n=new e.Olm.PkDecryption;return n.init_with_private_key(t)===s}finally{n&&n.free()}},D.prototype.getSessionBackupPrivateKey=async function(){let e=await new Promise(e=>{this._cryptoStore.doTxn("readonly",[y.a.STORE_ACCOUNT],t=>{this._cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")})});if(e&&"string"==typeof e&&(e=new Uint8Array(u.decodeBase64(A(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=n.from(this._olmDevice._pickleKey),s=await Object(T.a)(e,t,"m.megolm_backup.v1");e=u.decodeBase64(s)}return e},D.prototype.storeSessionBackupPrivateKey=async function(e){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got "+e);const t=n.from(this._olmDevice._pickleKey);return e=await Object(T.b)(u.encodeBase64(e),t,"m.megolm_backup.v1"),this._cryptoStore.doTxn("readwrite",[y.a.STORE_ACCOUNT],t=>{this._cryptoStore.storeSecretStorePrivateKey(t,"m.megolm_backup.v1",e)})},D.prototype.checkCrossSigningPrivateKey=function(t,s){let n=null;try{n=new e.Olm.PkSigning;return n.init_with_seed(t)===s}finally{n&&n.free()}},D.prototype._afterCrossSigningLocalKeyChange=async function(){c.a.info("Starting cross-signing key change post-processing");const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),t=await this._crossSigningInfo.signDevice(this._userId,e);c.a.info("Starting background key sig upload for "+this._deviceId);const s=({shouldEmit:e})=>this._baseApis.uploadKeySignatures({[this._userId]:{[this._deviceId]:t}}).then(t=>{const{failures:n}=t||{};if(Object.keys(n||[]).length>0)throw e&&this._baseApis.emit("crypto.keySignatureUploadFailure",n,"_afterCrossSigningLocalKeyChange",s),new O.c("Key upload failed",{failures:n});c.a.info("Finished background key sig upload for "+this._deviceId)}).catch(e=>{c.a.error("Error during background key sig upload for "+this._deviceId,e)});s({shouldEmit:!0});const n=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){c.a.info("Starting device verification upgrade");const e={};for(const[t,s]of Object.entries(this._deviceList._crossSigningInfo)){const n=await this._checkForDeviceVerificationUpgrade(t,g.a.fromStorage(s,t));n&&(e[t]=n)}if(Object.keys(e).length>0){c.a.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await n({users:e});if(t)for(const s of t)s in e&&await this._baseApis.setDeviceVerified(s,e[s].crossSigningInfo.getId())}catch(e){c.a.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}c.a.info("Finished device verification upgrade")}c.a.info("Finished cross-signing key change post-processing")},D.prototype._checkForDeviceVerificationUpgrade=async function(e,t){const s=this._crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!s.verified){const s=this._deviceList.getRawStoredDevicesForUser(e),n=await this._checkForValidDeviceSignature(e,t.keys.master,s);if(n.length)return{devices:n.map(e=>m.a.fromStorage(s[e],e)),crossSigningInfo:t}}},D.prototype._checkForValidDeviceSignature=async function(e,t,s){const n=[];if(s&&t.signatures&&t.signatures[e])for(const i of Object.keys(t.signatures[e])){const[,o]=i.split(":",2);if(o in s&&s[o].verified===x.VERIFIED)try{await u.verifySignature(this._olmDevice,t,e,o,s[o].keys[i]),n.push(o)}catch(e){}}return n},D.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},D.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},D.prototype.checkUserTrust=function(e){const t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new g.c(!1,!1,!1)},D.prototype.checkDeviceTrust=function(e,t){const s=this._deviceList.getStoredDevice(e,t);return this._checkDeviceInfoTrust(e,s)},D.prototype._checkDeviceInfoTrust=function(e,t){const s=!(!t||!t.isVerified()),n=this._deviceList.getStoredCrossSigningForUser(e);if(t&&n){const i=this._trustCrossSignedDevices||e===this._userId;return this._crossSigningInfo.checkDeviceTrust(n,t,s,i)}return new g.b(!1,!1,s,!1)},D.prototype._onDeviceListUserCrossSigningUpdated=async function(e){if(e===this._userId){const t=this._deviceList.getStoredCrossSigningForUser(e),s=t?t.getId():null,n=this._crossSigningInfo.getId(),i=n!==s;n&&s&&!i?await this.checkOwnCrossSigningTrust():(this._storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e)))}else{await this._checkDeviceVerifications(e);const t=this._deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))}},D.prototype.checkOwnCrossSigningTrust=async function(){const e=this._userId;await this.downloadKeys([this._userId]);const t=this._deviceList.getStoredCrossSigningForUser(e);if(!t)return void c.a.error("Got cross-signing update event for user "+e+" but no new cross-signing information found!");const s=t.getId(),n=this._crossSigningInfo.getId()!==s;if(n){c.a.info("Got new master public key",s);let e=null;try{if(e=(await this._crossSigningInfo.getCrossSigningKey("master",s))[1],!e)throw new Error("Cross-signing master private key not available")}finally{e&&e.free()}c.a.info("Got matching private key from callback for new public master key")}const i=this._crossSigningInfo.getId("self_signing"),o=this._crossSigningInfo.getId("user_signing");this._storeTrustedSelfKeys(t.keys);const r={};if(i!==t.getId("self_signing")){c.a.info("Got new self-signing key",t.getId("self_signing"));let e=null;try{e=(await this._crossSigningInfo.getCrossSigningKey("self_signing",t.getId("self_signing")))[1],c.a.info("Got matching private key from callback for new public self-signing key")}finally{e&&e.free()}const s=this._deviceList.getStoredDevice(this._userId,this._deviceId),n=await this._crossSigningInfo.signDevice(this._userId,s);r[this._deviceId]=n}if(o!==t.getId("user_signing")){c.a.info("Got new user-signing key",t.getId("user_signing"));let e=null;try{e=(await this._crossSigningInfo.getCrossSigningKey("user_signing",t.getId("user_signing")))[1],c.a.info("Got matching private key from callback for new public user-signing key")}finally{e&&e.free()}}if(n){const e=this._crossSigningInfo.keys.master;await this._signObject(e);const t=e.signatures[this._userId]["ed25519:"+this._deviceId];r[this._crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this._userId]:{["ed25519:"+this._deviceId]:t}}})}const a=Object.keys(r);if(a.length){const e=({shouldEmit:t})=>(c.a.info("Starting background key sig upload for "+a),this._baseApis.uploadKeySignatures({[this._userId]:r}).then(s=>{const{failures:n}=s||{};if(c.a.info("Finished background key sig upload for "+a),Object.keys(n||[]).length>0)throw t&&this._baseApis.emit("crypto.keySignatureUploadFailure",n,"checkOwnCrossSigningTrust",e),new O.c("Key upload failed",{failures:n})}).catch(e=>{c.a.error("Error during background key sig upload for "+a,e)}));e({shouldEmit:!0})}this.emit("userTrustStatusChanged",e,this.checkUserTrust(e)),n&&(this._baseApis.emit("crossSigning.keysChanged",{}),await this._afterCrossSigningLocalKeyChange()),await this.checkKeyBackup()},D.prototype._storeTrustedSelfKeys=async function(e){e?this._crossSigningInfo.setKeys(e):this._crossSigningInfo.clearKeys(),await this._cryptoStore.doTxn("readwrite",[y.a.STORE_ACCOUNT],e=>{this._cryptoStore.storeCrossSigningKeys(e,this._crossSigningInfo.keys)})},D.prototype._checkDeviceVerifications=async function(e){const t=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(c.a.info("Starting device verification upgrade for "+e),this._crossSigningInfo.keys.user_signing){const s=this._deviceList.getStoredCrossSigningForUser(e);if(s){const n=await this._checkForDeviceVerificationUpgrade(e,s);if(n){(await t({users:{[e]:n}})).includes(e)&&await this._baseApis.setDeviceVerified(e,s.getId())}}}c.a.info("Finished device verification upgrade for "+e)}},D.prototype._checkAndStartKeyBackup=async function(){if(c.a.log("Checking key backup status..."),this._baseApis.isGuest())return c.a.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,null;let e;try{e=await this._baseApis.getKeyBackupVersion()}catch(e){return c.a.log("Error checking for active key backup",e),404===e.httpStatus&&(this._checkedForBackup=!0),null}this._checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(c.a.log("Found usable key backup v"+e.version+": enabling key backups"),this._baseApis.enableKeyBackup(e)):!t.usable&&this.backupInfo?(c.a.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(c.a.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):c.a.log("Backup version "+e.version+" still current")):c.a.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}},D.prototype.setTrustedBackupPubKey=async function(e){this._sessionStore.setLocalTrustedBackupPubKey(e),await this.checkKeyBackup()},D.prototype.checkKeyBackup=async function(){return this._checkedForBackup=!1,this._checkAndStartKeyBackup()},D.prototype.isKeyBackupTrusted=async function(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures))return c.a.info("Key backup is absent or missing required data"),t;const s=this._sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===s&&(c.a.info("Backup public key "+s+" is trusted locally"),t.trusted_locally=!0);const n=e.auth_data.signatures[this._userId]||[];for(const s of Object.keys(n)){const n=s.split(":");if("ed25519"!==n[0]){c.a.log("Ignoring unknown signature type: "+n[0]);continue}const i={deviceId:n[1]},o=this._crossSigningInfo.getId();if(o===i.deviceId){i.crossSigningId=!0;try{await u.verifySignature(this._olmDevice,e.auth_data,this._userId,i.deviceId,o),i.valid=!0}catch(e){c.a.warning("Bad signature from cross signing key "+o,e),i.valid=!1}t.sigs.push(i);continue}const r=this._deviceList.getStoredDevice(this._userId,i.deviceId);if(r){i.device=r,i.deviceTrust=await this.checkDeviceTrust(this._userId,i.deviceId);try{await u.verifySignature(this._olmDevice,e.auth_data,this._userId,r.deviceId,r.getFingerprint()),i.valid=!0}catch(t){c.a.info("Bad signature from key ID "+s+" userID "+this._userId+" device ID "+r.deviceId+" fingerprint: "+r.getFingerprint(),e.auth_data,t),i.valid=!1}}else i.valid=null,c.a.info("Ignoring signature from unknown key "+s);t.sigs.push(i)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable|=t.trusted_locally,t},D.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},D.prototype.registerEventHandlers=function(e){const t=this;e.on("RoomMember.membership",(function(e,s,n){try{t._onRoomMembership(e,s,n)}catch(e){c.a.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",t._onToDeviceEvent.bind(t));const s=t._onTimelineEvent.bind(t);e.on("Room.timeline",s),e.on("Event.decrypted",s)},D.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},D.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop()},D.getOlmVersion=function(){return d.a.getOlmVersion()},D.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},D.prototype.getDeviceCurve25519Key=function(){return this._olmDevice.deviceCurve25519Key},D.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},D.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},D.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},D.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},D.prototype.uploadDeviceKeys=function(){const e=this,t=e._userId,s=e._deviceId,n={algorithms:e._supportedAlgorithms,device_id:s,keys:e._deviceKeys,user_id:t};return e._signObject(n).then(()=>e._baseApis.uploadKeysRequest({device_keys:n}))},D.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},D.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},D.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},D.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},D.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},D.prototype.setDeviceVerification=async function(e,t,s,n,i){void 0===s&&(s=null),void 0===n&&(n=null),void 0===i&&(i=null);const o=this._deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==n||null!==i)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");if(this._crossSigningInfo.getId()||e!==this._crossSigningInfo.userId||(this._storeTrustedSelfKeys(o.keys),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e))),e!==this._userId){c.a.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const s=await this._crossSigningInfo.signUser(o);if(s){const n=async({shouldEmit:i})=>{c.a.info("Uploading signature for "+e+"...");const o=await this._baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:r}=o||{};if(Object.keys(r||[]).length>0)throw i&&this._baseApis.emit("crypto.keySignatureUploadFailure",r,"setDeviceVerification",n),new O.c("Key upload failed",{failures:r})};await n({shouldEmit:!0})}return s}return o}const r=this._deviceList.getRawStoredDevicesForUser(e);if(!r||!r[t])throw new Error("Unknown device "+e+":"+t);const a=r[t];let l=a.verified;s?l=x.VERIFIED:null!==s&&l==x.VERIFIED&&(l=x.UNVERIFIED),n?l=x.BLOCKED:null!==n&&l==x.BLOCKED&&(l=x.UNVERIFIED);let d=a.known;if(null!==i&&(d=i),a.verified===l&&a.known===d||(a.verified=l,a.known=d,this._deviceList.storeDevicesForUser(e,r),this._deviceList.saveIfDirty()),s&&e===this._userId){let s;c.a.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?c.a.log(`Own device ${t} already cross-signing verified`):s=await this._crossSigningInfo.signDevice(e,m.a.fromStorage(a,t)),s){const n=async({shouldEmit:i})=>{c.a.info("Uploading signature for "+t);const o=await this._baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:r}=o||{};if(Object.keys(r||[]).length>0)throw i&&this._baseApis.emit("crypto.keySignatureUploadFailure",r,"setDeviceVerification",n),new O.c("Key upload failed",{failures:r})};await n({shouldEmit:!0})}}const u=m.a.fromStorage(a,t);return this.emit("deviceVerificationChanged",e,t,u),u},D.prototype.findVerificationRequestDMInProgress=function(e){return this._inRoomVerificationRequests.findRequestInProgress(e)},D.prototype.getVerificationRequestsToDeviceInProgress=function(e){return this._toDeviceVerificationRequests.getRequestsInProgress(e)},D.prototype.requestVerificationDM=function(e,t){const s=this._inRoomVerificationRequests.findRequestInProgress(t);if(s)return Promise.resolve(s);const n=new R.a(this._baseApis,t,e);return this._requestVerificationWithChannel(e,n,this._inRoomVerificationRequests)},D.prototype.requestVerification=function(e,t){t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));const s=this._toDeviceVerificationRequests.findRequestInProgress(e,t);if(s)return Promise.resolve(s);const n=new k.a(this._baseApis,e,t,k.a.makeTransactionId());return this._requestVerificationWithChannel(e,n,this._toDeviceVerificationRequests)},D.prototype._requestVerificationWithChannel=async function(e,t,s){let n=new C.k(t,this._verificationMethods,this._baseApis);t.transactionId&&s.setRequestByChannel(t,n),await n.sendRequest();const i=s.getRequestByChannel(t);return i?n=i:(c.a.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),s.setRequestByChannel(t,n)),n},D.prototype.beginKeyVerification=function(e,t,s,n=null){let i;if(n){if(i=this._toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!i)throw new Error(`No request found for user ${t} with transactionId `+n)}else{n=k.a.makeTransactionId();const e=new k.a(this._baseApis,t,[s],n,s);i=new C.k(e,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,i)}return i.beginKeyVerification(e,{userId:t,deviceId:s})},D.prototype.legacyDeviceVerification=async function(e,t,s){const n=k.a.makeTransactionId(),i=new k.a(this._baseApis,e,[t],n,t),o=new C.k(i,this._verificationMethods,this._baseApis);this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,o);const r=o.beginKeyVerification(s,{userId:e,deviceId:t});return await Promise.race([r.verify(),o.waitFor(e=>e.started)]),o},D.prototype.getOlmSessionsForUser=async function(e){const t=this.getStoredDevicesForUser(e)||[],s={};for(let e=0;e<t.length;++e){const n=t[e],i=n.getIdentityKey(),o=await this._olmDevice.getSessionInfoForDevice(i);s[n.deviceId]={deviceIdKey:i,sessions:o}}return s},D.prototype.getEventSenderDeviceInfo=function(e){const t=e.getSenderKey(),s=e.getWireContent().algorithm;if(!t||!s)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const n=this._deviceList.getDeviceByIdentityKey(s,t);if(null===n)return null;const i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(c.a.warn("Event "+e.getId()+" claims ed25519 key "+i+"but sender device has key "+n.getFingerprint()),null):n:(c.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},D.prototype.getEventEncryptionInfo=function(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this._deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const s=e.getClaimedEd25519Key();return s||(c.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&s!==t.sender.getFingerprint()&&(c.a.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t},D.prototype.forceDiscardSession=function(e){const t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},D.prototype.setRoomEncryption=async function(e,t,s){if(!t.algorithm)return void c.a.log("Ignoring setRoomEncryption with no algorithm");const n=this._roomList.getRoomEncryption(e);if(n&&JSON.stringify(n)!=JSON.stringify(t))return void c.a.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this._roomEncryptors[e])return;let i=null;n||(i=this._roomList.setRoomEncryption(e,t));const o=p.c[t.algorithm];if(!o)throw new Error("Unable to encrypt with "+t.algorithm);const r=new o({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t});this._roomEncryptors[e]=r,i&&await i,this._lazyLoadMembers?c.a.log("Enabling encryption in "+e):(c.a.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists())},D.prototype.trackRoomDevices=function(e){const t=async()=>{if(!this._roomEncryptors[e])return;const t=this._clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room "+e);c.a.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach(e=>{this._deviceList.startTrackingDeviceList(e.userId)})};let s=this._roomDeviceTrackingState[e];return s||(s=t(),this._roomDeviceTrackingState[e]=s),s},D.prototype.ensureOlmSessionsForUsers=function(e){const t={};for(let s=0;s<e.length;++s){const n=e[s];t[n]=[];const i=this.getStoredDevicesForUser(n)||[];for(let e=0;e<i.length;++e){const s=i[e];s.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(s.verified!=x.BLOCKED&&t[n].push(s))}}return u.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},D.prototype.exportRoomKeys=async function(){const e=[];return await this._cryptoStore.doTxn("readonly",[y.a.STORE_INBOUND_GROUP_SESSIONS],t=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const s=this._olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete s.first_known_index,s.algorithm=u.MEGOLM_ALGORITHM,e.push(s)})}),e},D.prototype.importRoomKeys=function(e,t={}){let s=0,n=0;const i=e.length;function o(){t.progressCallback({stage:"load_keys",successes:s,failures:n,total:i})}return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return c.a.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&o(),null;return this._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally(e=>{s++,t.progressCallback&&o()})}))},D.prototype.scheduleKeyBackupSend=async function(e=1e4){if(!this._sendingBackups){this._sendingBackups=!0;try{const t=Math.random()*e;await Object(l.A)(t);let s=0;for(;;){if(!this.backupKey)return;try{if(0===await this._backupPendingKeys(200))return;s=0}catch(e){if(s++,c.a.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.emit("crypto.keyBackupFailed",e.data.errcode),e}s&&await Object(l.A)(1e3*Math.pow(2,Math.min(s-1,4)))}}finally{this._sendingBackups=!1}}},D.prototype._backupPendingKeys=async function(e){const t=await this._cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let s=await this._cryptoStore.countSessionsNeedingBackup();this.emit("crypto.keyBackupSessionsRemaining",s);const n={};for(const e of t){const t=e.sessionData.room_id;void 0===n[t]&&(n[t]={sessions:{}});const s=await this._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);s.algorithm=u.MEGOLM_ALGORITHM,delete s.session_id,delete s.room_id;const i=s.first_known_index;delete s.first_known_index;const o=this.backupKey.encrypt(JSON.stringify(s)),r=(s.forwarding_curve25519_key_chain||[]).length,a=this._deviceList.getUserByIdentityKey(u.MEGOLM_ALGORITHM,e.senderKey),c=this._deviceList.getDeviceByIdentityKey(u.MEGOLM_ALGORITHM,e.senderKey),l=this._checkDeviceInfoTrust(a,c).isVerified();n[t].sessions[e.sessionId]={first_message_index:i,forwarded_count:r,is_verified:l,session_data:o}}return await this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this._cryptoStore.unmarkSessionsNeedingBackup(t),s=await this._cryptoStore.countSessionsNeedingBackup(),this.emit("crypto.keyBackupSessionsRemaining",s),t.length},D.prototype.backupGroupSession=async function(e,t,s,n,i,o,r){if(!this.backupInfo)throw new Error("Key backups are not enabled");await this._cryptoStore.markSessionsNeedingBackup([{senderKey:t,sessionId:n}]),this.scheduleKeyBackupSend()},D.prototype.scheduleAllGroupSessionsForBackup=async function(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)},D.prototype.flagAllGroupSessionsForBackup=async function(){await this._cryptoStore.doTxn("readwrite",[y.a.STORE_INBOUND_GROUP_SESSIONS,y.a.STORE_BACKUP],e=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this._cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this._cryptoStore.countSessionsNeedingBackup();return this.emit("crypto.keyBackupSessionsRemaining",e),e},D.prototype.countSessionsNeedingBackup=function(){return this._cryptoStore.countSessionsNeedingBackup()},D.prototype.prepareToEncrypt=function(e){const t=e.roomId,s=this._roomEncryptors[t];s&&s.prepareToEncrypt(e)},D.prototype.encryptEvent=async function(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const s=e.getRoomId(),n=this._roomEncryptors[s];if(!n)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this._roomDeviceTrackingState[s]||this.trackRoomDevices(s),await this._roomDeviceTrackingState[s];let i=e.getContent();const o=i["m.relates_to"];o&&(i=Object.assign({},i),delete i["m.relates_to"]);const r=await n.encryptMessage(t,e.getType(),i);o&&(r["m.relates_to"]=o),e.makeEncrypted("m.room.encrypted",r,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key)},D.prototype.decryptEvent=function(e){if(e.isRedacted())return Promise.resolve({clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{}}});const t=e.getWireContent();return this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},D.prototype.handleDeviceListChanges=async function(e,t){e.oldSyncToken&&await this._evalDeviceListChanges(t)},D.prototype.requestRoomKey=function(e,t,s=!1){return this._outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,s).then(()=>{this._sendKeyRequestsImmediately&&this._outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(e=>{c.a.error("Error requesting key for event",e)})},D.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{c.a.warn("Error clearing pending room key requests",e)})},D.prototype.cancelAndResendAllOutgoingKeyRequests=function(){return this._outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()},D.prototype.onCryptoEvent=async function(e){const t=e.getRoomId(),s=e.getContent();try{await this.setRoomEncryption(t,s,!0)}catch(e){c.a.error("Error configuring encryption in room "+t+":",e)}},D.prototype.onSyncWillProcess=async function(e){e.oldSyncToken||(c.a.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={}),this._sendKeyRequestsImmediately=!1},D.prototype.onSyncCompleted=async function(e){const t=e.nextSyncToken;this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(U(this),this._processReceivedRoomKeyRequests(),this._outgoingRoomKeyRequestManager.sendQueuedRequests(),this._sendKeyRequestsImmediately=!0)},D.prototype._evalDeviceListChanges=async function(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this._deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this._getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this._deviceList.stopTrackingDeviceList(e)})}},D.prototype._getTrackedE2eUsers=async function(){const e=[];for(const t of this._getTrackedE2eRooms()){const s=await t.getEncryptionTargetMembers();for(const t of s)e.push(t.userId)}return e},D.prototype._getTrackedE2eRooms=function(){return this._clientStore.getRooms().filter(e=>{if(!this._roomEncryptors[e.roomId])return!1;if(!this._roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})},D.prototype._onToDeviceEvent=function(e){try{c.a.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",e=>{this._onToDeviceEvent(e)})}catch(e){c.a.error("Error handling toDeviceEvent:",e)}},D.prototype._onRoomKeyEvent=function(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void c.a.error("key event is missing fields");this._checkedForBackup||this._checkAndStartKeyBackup();this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)},D.prototype._onRoomKeyWithheldEvent=function(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void c.a.error("key withheld event is missing fields");c.a.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const s=this._getRoomDecryptor(t.room_id,t.algorithm);if(s.onRoomKeyWithheldEvent&&s.onRoomKeyWithheldEvent(e),!t.room_id){const e=this._getRoomDecryptors(t.algorithm);for(const s of e)s.retryDecryptionFromSender(t.sender_key)}},D.prototype._onKeyVerificationMessage=function(e){if(!k.a.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._toDeviceVerificationRequests,e=>{if(!k.a.canCreateRequest(k.a.getEventType(e)))return;const t=e.getContent(),s=t&&t.from_device;if(!s)return;const n=e.getSender(),i=new k.a(this._baseApis,n,[s]);return new C.k(i,this._verificationMethods,this._baseApis)})},D.prototype._onTimelineEvent=function(e,t,s,n,{liveEvent:i}={}){if(!R.a.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._inRoomVerificationRequests,e=>{const t=new R.a(this._baseApis,e.getRoomId());return new C.k(t,this._verificationMethods,this._baseApis)},i)},D.prototype._handleVerificationEvent=async function(e,t,s,n=!0){let i=t.getRequest(e),o=!1;if(!i){if(i=s(e),!i)return void c.a.log("Crypto: could not find VerificationRequest for "+e.getType()+", and could not create one, so ignoring.");o=!0,t.setRequest(e,i)}e.setVerificationRequest(i);try{await i.channel.handleEvent(e,i,n)}catch(e){c.a.error("error while handling verification event: "+e.message)}o&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly&&this._baseApis.emit("crypto.verification.request",i)},D.prototype._onToDeviceBadEncrypted=async function(e){const t=e.getWireContent(),s=e.getSender(),n=t.algorithm,i=t.sender_key,o=()=>{const e=this._getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(i)};if(void 0===s||void 0===i||void 0===i)return;this._lastNewSessionForced[s]=this._lastNewSessionForced[s]||{};const r=this._lastNewSessionForced[s][i]||0;if(r+36e5>Date.now())return c.a.debug("New session already forced with device "+s+":"+i+" at "+r+": not forcing another"),await this._olmDevice.recordSessionProblem(i,"wedged",!0),void o();let a=this._deviceList.getDeviceByIdentityKey(n,i);if(!a&&(await this.downloadKeys([s],!1),a=this._deviceList.getDeviceByIdentityKey(n,i),!a))return c.a.info("Couldn't find device for identity key "+i+": not re-establishing session"),await this._olmDevice.recordSessionProblem(i,"wedged",!1),void o();const l={};l[s]=[a],await u.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,l,!0),this._lastNewSessionForced[s][i]=Date.now();const d={algorithm:u.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await u.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,s,a,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(i,"wedged",!0),o(),await this._baseApis.sendToDevice("m.room.encrypted",{[s]:{[a.deviceId]:d}});const h=await this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(s,a.deviceId);for(const e of h)this.requestRoomKey(e.requestBody,e.recipients,!0)},D.prototype._onRoomMembership=function(e,t,s){const n=t.roomId,i=this._roomEncryptors[n];i&&(this._roomDeviceTrackingState[n]&&("join"==t.membership?(c.a.log("Join event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(c.a.log("Invite event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,s))},D.prototype._onRoomKeyRequestEvent=function(e){const t=e.getContent();if("request"===t.action){const t=new M(e);this._receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new L(e);this._receivedRoomKeyRequestCancellations.push(t)}},D.prototype._processReceivedRoomKeyRequests=async function(){if(!this._processingRoomKeyRequests){this._processingRoomKeyRequests=!0;try{const e=this._receivedRoomKeyRequests;this._receivedRoomKeyRequests=[];const t=this._receivedRoomKeyRequestCancellations;this._receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this._processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this._processReceivedRoomKeyRequestCancellation(e)))}catch(e){c.a.error("Error processing room key requsts: "+e)}finally{this._processingRoomKeyRequests=!1}}},D.prototype._processReceivedRoomKeyRequest=async function(e){const t=e.userId,s=e.deviceId,n=e.requestBody,i=n.room_id,o=n.algorithm;if(c.a.log(`m.room_key_request from ${t}:${s} for ${i} / ${n.session_id} (id ${e.requestId})`),t!==this._userId){if(!this._roomEncryptors[i])return void c.a.debug("room key request for unencrypted room "+i);const e=this._roomEncryptors[i],o=this._deviceList.getStoredDevice(t,s);if(!o)return void c.a.debug(`Ignoring keyshare for unknown device ${t}:${s}`);try{await e.reshareKeyWithDevice(n.sender_key,n.session_id,t,o)}catch(e){c.a.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+o.deviceId,e)}return}if(s===this._deviceId)return void c.a.log("Ignoring room key request from ourselves");if(!this._roomDecryptors[i])return void c.a.log("room key request for unencrypted room "+i);const r=this._roomDecryptors[i][o];if(r)if(await r.hasKeysForKeyRequest(e)){if(e.share=()=>{r.shareKeysWithDevice(e)},this.checkDeviceTrust(t,s).isVerified())return c.a.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)}else c.a.log(`room key request for unknown session ${i} / `+n.session_id);else c.a.log(`room key request for unknown alg ${o} in room ${i}`)},D.prototype._processReceivedRoomKeyRequestCancellation=async function(e){c.a.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)},D.prototype._getRoomDecryptor=function(e,t){let s,n;if((e=e||null)&&(s=this._roomDecryptors[e],s||(this._roomDecryptors[e]=s={}),n=s[t],n))return n;const i=p.a[t];if(!i)throw new p.b("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),s&&(s[t]=n),n},D.prototype._getRoomDecryptors=function(e){const t=[];for(const s of Object.values(this._roomDecryptors))e in s&&t.push(s[e]);return t},D.prototype._signObject=async function(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=await this._olmDevice.sign(o.a.stringify(e)),e.signatures=t,void 0!==s&&(e.unsigned=s)};class M{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class L{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,s(6),s(22).Buffer)},function(e,t,s){"use strict";function n(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=i.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}s.d(t,"a",(function(){return n})),n.fromStorage=function(e,t){const s=new n(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s},n.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},n.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},n.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},n.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},n.prototype.isBlocked=function(){return this.verified==i.BLOCKED},n.prototype.isVerified=function(){return this.verified==i.VERIFIED},n.prototype.isUnverified=function(){return this.verified==i.UNVERIFIED},n.prototype.isKnown=function(){return 1==this.known},n.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};const i=n.DeviceVerification},function(e,t,s){"use strict";(function(e,n){s.d(t,"a",(function(){return d})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return m})),s.d(t,"d",(function(){return p})),s.d(t,"e",(function(){return g}));var i=s(85),o=s(10),r=s(0),a=s(108),c=s(275);function l(e){return Object.values(e.keys)[0]}class d extends o.EventEmitter{constructor(e,t,s){super(),Object.defineProperty(this,"userId",{enumerable:!0,value:e}),this._callbacks=t||{},this._cacheCallbacks=s||{},this.keys={},this.firstUse=!0,this.crossSigningVerifiedBefore=!1}static fromStorage(e,t){const s=new d(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,s){const n=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this._callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(t){if(!t)return;const n=new e.Olm.PkSigning,i=n.init_with_seed(t);if(i===s)return[i,n];n.free()}let o;void 0===s&&(s=this.getId(t)),this._cacheCallbacks.getCrossSigningKeyCache&&n&&(o=await this._cacheCallbacks.getCrossSigningKeyCache(t,s));const r=i(o);if(r)return r;o=await this._callbacks.getCrossSigningKey(t,s);const a=i(o);if(a)return this._cacheCallbacks.storeCrossSigningKeyCache&&n&&await this._cacheCallbacks.storeCrossSigningKeyCache(t,o),a;if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master",!1)||{};function s(e){for(const s of Object.keys(t))e[s]||delete t[s]}for(const t of["self_signing","user_signing"])s(await e.isStored("m.cross_signing."+t,!1)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[s,n]of e){const e=Object(i.encodeBase64)(n);await t.store("m.cross_signing."+s,e)}}static async getFromSecretStorage(e,t){const s=await t.get("m.cross_signing."+e);return s?Object(i.decodeBase64)(s):null}async isStoredInKeyCache(){const e=this._cacheCallbacks;if(!e)return!1;for(const t of["master","self_signing","user_signing"])if(!await e.getCrossSigningKeyCache(t))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this._cacheCallbacks;if(!t)return e;for(const s of["master","self_signing","user_signing"]){const n=await t.getCrossSigningKeyCache(s);e.set(s,n)}return e}getId(e){if(e=e||"master",!this.keys[e])return null;return l(this.keys[e])}async resetKeys(t){if(!this._callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&u.MASTER||!this.keys.master)t=u.MASTER|u.USER_SIGNING|u.SELF_SIGNING;else if(0===t)return;const s={},n={};let o,r;try{if(t&u.MASTER?(o=new e.Olm.PkSigning,s.master=o.generate_seed(),r=o.init_with_seed(s.master),n.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+r]:r}}):[r,o]=await this.getCrossSigningKey("master"),t&u.SELF_SIGNING){const t=new e.Olm.PkSigning;try{s.self_signing=t.generate_seed();const e=t.init_with_seed(s.self_signing);n.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},Object(i.pkSign)(n.self_signing,o,this.userId,r)}finally{t.free()}}if(t&u.USER_SIGNING){const t=new e.Olm.PkSigning;try{s.user_signing=t.generate_seed();const e=t.init_with_seed(s.user_signing);n.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},Object(i.pkSign)(n.user_signing,o,this.userId,r)}finally{t.free()}}Object.assign(this.keys,n),this._callbacks.saveCrossSigningKeys(s)}finally{o&&o.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw r.a.error(t),new Error(t)}this.keys.master?l(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const s=l(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw r.a.error(t),new Error(t)}try{Object(i.pkVerify)(e.user_signing,s,this.userId)}catch(e){throw r.a.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw r.a.error(t),new Error(t)}try{Object(i.pkVerify)(e.self_signing,s,this.userId)}catch(e){throw r.a.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[s,n]=await this.getCrossSigningKey(t);try{return Object(i.pkSign)(e,n,this.userId,s),e}finally{n.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");r.a.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");r.a.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new h(!0,!0,this.firstUse);if(!this.keys.user_signing)return new h(!1,!1,e.firstUse);let t;const s=e.keys.master,n=this.getId("user_signing");try{Object(i.pkVerify)(s,n,this.userId),t=!0}catch(e){t=!1}return new h(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,s,n){const o=this.checkUserTrust(e),r=e.keys.self_signing;if(!r)return new m(!1,!1,s,n);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return Object(i.pkVerify)(r,e.getId(),e.userId),Object(i.pkVerify)(a,l(r),e.userId),m.fromUserTrustLevel(o,s,n)}catch(e){return new m(!1,!1,s,n)}}getCacheCallbacks(){return this._cacheCallbacks}}const u={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};class h{constructor(e,t,s){this._crossSigningVerified=e,this._crossSigningVerifiedBefore=t,this._tofu=s}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this._crossSigningVerified}wasCrossSigningVerified(){return this._crossSigningVerifiedBefore}isTofu(){return this._tofu}}class m{constructor(e,t,s,n){this._crossSigningVerified=e,this._tofu=t,this._localVerified=s,this._trustCrossSignedDevices=n}static fromUserTrustLevel(e,t,s){return new m(e._crossSigningVerified,e._tofu,t,s)}isVerified(){return Boolean(this.isLocallyVerified()||this._trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this._crossSigningVerified}isLocallyVerified(){return this._localVerified}isTofu(){return this._tofu}}function p(e,t){return{getCrossSigningKeyCache:async function(s,o){const r=await new Promise(t=>e.doTxn("readonly",[a.a.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,s)}));if(r&&r.ciphertext){const e=n.from(t._pickleKey),o=await Object(c.a)(r,e,s);return Object(i.decodeBase64)(o)}return r},storeCrossSigningKeyCache:async function(s,o){if(!(o instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got "+o);const r=n.from(t._pickleKey);return o=await Object(c.b)(Object(i.encodeBase64)(o),r,s),e.doTxn("readwrite",[a.a.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,s,o)})}}}async function g(e,t,s){if(e.getUserId()===t)return console.log("Cross-signing: Self-verification done; requesting keys"),new Promise((t,n)=>{const o=e,a=o._crypto._crossSigningInfo,c=new d(a.userId,{getCrossSigningKey:async e=>{console.debug("Cross-signing: requesting secret",e,s);const{promise:t}=o.requestSecret("m.cross_signing."+e,[s]),n=await t,r=Object(i.decodeBase64)(n);return Uint8Array.from(r)}},a._cacheCallbacks);c.keys=a.keys;const l=new Promise((e,t)=>{setTimeout(e,6e4,new Error("Timeout"))}),u=new Promise(async e=>{if(!await o._crypto.getSessionBackupPrivateKey()){r.a.info("No cached backup key found. Requesting...");const e=o.requestSecret("m.megolm_backup.v1",[s]),t=await e.promise;r.a.info("Got key backup key, decoding...");const n=Object(i.decodeBase64)(t);r.a.info("Decoded backup key, storing..."),o._crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),r.a.info("Backup key stored. Starting backup restore...");const a=await o.getKeyBackupVersion();o.restoreKeyBackupWithCache(void 0,void 0,a).then(()=>{r.a.info("Backup restored.")})}e()});return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),u]),l]).then(t,n)}).catch(e=>{console.warn("Cross-signing: failure while requesting keys:",e)})}}).call(this,s(6),s(22).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(66);class o{static get ERROR_INVALID(){return"Invalid homeserver discovery response"}static get ERROR_GENERIC_FAILURE(){return"Failed to get autodiscovery configuration from server"}static get ERROR_INVALID_HS_BASE_URL(){return"Invalid base_url for m.homeserver"}static get ERROR_INVALID_HOMESERVER(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}static get ERROR_INVALID_IS_BASE_URL(){return"Invalid base_url for m.identity_server"}static get ERROR_INVALID_IDENTITY_SERVER(){return"Identity server URL does not appear to be a valid identity server"}static get ERROR_INVALID_IS(){return"Invalid identity server discovery response"}static get ERROR_MISSING_WELLKNOWN(){return"No .well-known JSON file found"}static get ERROR_INVALID_JSON(){return"Invalid JSON"}static get ALL_ERRORS(){return[o.ERROR_INVALID,o.ERROR_GENERIC_FAILURE,o.ERROR_INVALID_HS_BASE_URL,o.ERROR_INVALID_HOMESERVER,o.ERROR_INVALID_IS_BASE_URL,o.ERROR_INVALID_IDENTITY_SERVER,o.ERROR_INVALID_IS,o.ERROR_MISSING_WELLKNOWN,o.ERROR_INVALID_JSON]}static get FAIL_ERROR(){return"FAIL_ERROR"}static get FAIL_PROMPT(){return"FAIL_PROMPT"}static get PROMPT(){return"PROMPT"}static get SUCCESS(){return"SUCCESS"}static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return n.a.error("No m.homeserver key in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return n.a.error("No m.homeserver base_url in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const s=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!s)return n.a.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const i=await this._fetchWellKnownObject(s+"/_matrix/client/versions");if(!i||!i.raw.versions)return n.a.error("Invalid /versions response"),t["m.homeserver"].error=o.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=s,Promise.resolve(t);t["m.homeserver"]={state:o.SUCCESS,error:null,base_url:s};let r="";if(e["m.identity_server"]){const s={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:o.FAIL_PROMPT,error:o.ERROR_INVALID_IS,base_url:null}};if(r=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url),!r)return n.a.error("Invalid base_url for m.identity_server"),s["m.identity_server"].error=o.ERROR_INVALID_IS_BASE_URL,Promise.resolve(s);const i=await this._fetchWellKnownObject(r+"/_matrix/identity/api/v1");if(!i||!i.raw||"SUCCESS"!==i.action)return n.a.error("Invalid /api/v1 response"),s["m.identity_server"].error=o.ERROR_INVALID_IDENTITY_SERVER,s["m.identity_server"].base_url=r,Promise.resolve(s)}return r&&r.length>0&&(t["m.identity_server"]={state:o.SUCCESS,error:null,base_url:r}),Object.keys(e).map(s=>{if("m.homeserver"===s||"m.identity_server"===s){const n=["error","state","base_url"];for(const i of Object.keys(e[s]))n.includes(i)||(t[s][i]=e[s][i])}else t[s]=e[s]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}},s=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return s&&"SUCCESS"===s.action?o.fromDiscoveryConfig(s.raw):(n.a.error("No response or error when parsing .well-known"),s.reason&&n.a.error(s.reason),"IGNORE"===s.action?t["m.homeserver"]={state:o.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static _sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=i.URL?new i.URL(e):new URL(e)}catch(s){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const s=t.port?":"+t.port:"",n=t.pathname?t.pathname:"";let o=`${t.protocol}//${t.hostname}${s}${n}`;return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return n.a.error(e),!1}}static async _fetchWellKnownObject(e){return new Promise((function(t,n){const i=s(134).getRequest();if(!i)throw new Error("No request library available");i({method:"GET",uri:e,timeout:5e3},(e,s,n)=>{if(e||s&&(s.statusCode<200||s.statusCode>=300)){let n="FAIL_PROMPT",i=(e?e.message:null)||"General failure";return s&&404===s.statusCode&&(n="IGNORE",i=o.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:n,reason:i,error:e})}try{t({raw:JSON.parse(n),action:"SUCCESS"})}catch(e){let s=o.ERROR_INVALID;"SyntaxError"===e.name&&(s=o.ERROR_INVALID_JSON),t({raw:{},action:"FAIL_PROMPT",reason:s,error:e})}})}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(2),i=s.n(n),o=s(155);class r extends o.a{static set matrixClient(e){const t=r._matrixClient;r._matrixClient=e;for(const s of r.instances)s.initMatrixClient(t,e)}constructor(){super(),r.instances.push(this)}get client(){return r._matrixClient}initMatrixClient(e,t){console.warn("initMatrixClient not overridden")}}i()(r,"_matrixClient",void 0),i()(r,"instances",[])},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(79),c=s.n(a),l=s(51),d=s.n(l);class u extends r.a.Component{constructor(...e){super(...e),i()(this,"tooltipContainer",void 0),i()(this,"tooltip",void 0),i()(this,"parent",void 0),i()(this,"renderTooltip",()=>{const e=this.updatePosition({});e.display=this.props.visible?"block":"none";const t=d()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),s=r.a.createElement("div",{className:t,style:e},r.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);this.tooltip=c.a.render(s,this.tooltipContainer)})}componentDidMount(){this.tooltipContainer=document.createElement("div"),this.tooltipContainer.className="mx_Tooltip_wrapper",document.body.appendChild(this.tooltipContainer),window.addEventListener("scroll",this.renderTooltip,!0),this.parent=c.a.findDOMNode(this).parentNode,this.renderTooltip()}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){c.a.unmountComponentAtNode(this.tooltipContainer),document.body.removeChild(this.tooltipContainer),window.removeEventListener("scroll",this.renderTooltip,!0)}updatePosition(e){const t=this.parent.getBoundingClientRect();let s=0;return s=t.height>25?Math.floor((t.height-25)/2):Math.floor(t.height-25),e.top=t.top-2+window.pageYOffset+s,!this.props.forceOnRight&&t.right>window.innerWidth/2?e.right=window.innerWidth-t.right-window.pageXOffset-8:e.left=t.right+window.pageXOffset+6,e}render(){return r.a.createElement("div",{className:this.props.className})}}i()(u,"defaultProps",{visible:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return c})),s.d(t,"d",(function(){return l}));var n=s(45),i=s.n(n),o=s(44);const r=i.a.shape({userId:i.a.string.isRequired,displayname:i.a.string,avatarUrl:i.a.string}),a=i.a.shape({displayname:i.a.string,name:i.a.string,roomId:i.a.string.isRequired,canonicalAlias:i.a.string,avatarUrl:i.a.string});function c(e){return{userId:e.user_id,displayname:e.displayname,avatarUrl:e.avatar_url,isPrivileged:e.is_privileged}}function l(e){return{displayname:e.name||e.canonical_alias||Object(o.a)("Unnamed Room"),name:e.name,roomId:e.room_id,canonicalAlias:e.canonical_alias,avatarUrl:e.avatar_url,topic:e.topic,numJoinedMembers:e.num_joined_members,worldReadable:e.world_readable,guestCanJoin:e.guest_can_join,isPublic:!1!==e.is_public}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return a})),s.d(t,"d",(function(){return c})),s.d(t,"e",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"h",(function(){return g})),s.d(t,"g",(function(){return f}));var n=s(47),i=s(157);const o="all_messages_loud",r="all_messages",a="mentions_only",c="mute",l=[r,o],d=[...l,a];function u(e){return l.includes(e)}function h(e){return d.includes(e)}function m(e){return e.reduce((e,t)=>{const s=p(t.roomId),n=t.getUnreadNotificationCount("highlight")>0,i=f(t),o=i>0&&u(s),r=n&&h(s);return(o||r)&&(e.count+=i,n&&(e.highlight=!0)),e},{count:0,highlight:!1})}function p(e){if(n.a.get().isGuest())return r;if(_(e))return c;let t=null;try{t=n.a.get().getRoomPushRule("global",e)}catch(e){return null}if(!t||!t.enabled)return r;if(y(t))return a;return i.a.actionListToActionsObject(t.actions).tweaks.sound?o:null}function g(e,t){return t===c?function(e){const t=n.a.get(),s=[],i=t.getRoomPushRule("global",e);i&&s.push(t.deletePushRule("global","room",i.rule_id));return s.push(t.addPushRule("global","override",e,{conditions:[{kind:"event_match",key:"room_id",pattern:e}],actions:["dont_notify"]})),Promise.all(s)}(e):function(e,t){const s=n.a.get(),i=[],o=_(e);o&&i.push(s.deletePushRule("global","override",o.rule_id));if("all_messages"===t){const t=s.getRoomPushRule("global",e);t&&i.push(s.deletePushRule("global","room",t.rule_id))}else"mentions_only"===t?(i.push(s.addPushRule("global","room",e,{actions:["dont_notify"]})),i.push(s.setPushRuleEnabled("global","room",e,!0))):(i.push(s.addPushRule("global","room",e,{actions:["notify",{set_tweak:"sound",value:"default"}]})),i.push(s.setPushRuleEnabled("global","room",e,!0)));return Promise.all(i)}(e,t)}function f(e,t=null){let s=e.getUnreadNotificationCount(t);const i=e.currentState.getStateEvents("m.room.create","");if(i&&i.getContent().predecessor){const e=i.getContent().predecessor.room_id,t=n.a.get().getRoom(e);t&&(s+=t.getUnreadNotificationCount("highlight"))}return s}function _(e){if(!n.a.get().pushRules||!n.a.get().pushRules.global||!n.a.get().pushRules.global.override)return null;for(const t of n.a.get().pushRules.global.override)if(v(e,t)&&y(t)&&t.enabled)return t;return null}function v(e,t){if(1!==t.conditions.length)return!1;const s=t.conditions[0];return"event_match"===s.kind&&"room_id"===s.key&&s.pattern===e}function y(e){return 1===e.actions.length&&"dont_notify"===e.actions[0]}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}));const n="filter_changed";let i;!function(e){e[e.Lowest=0]="Lowest",e[e.Highest=1]="Highest"}(i||(i={}))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(47),i=s(101),o=s(44),r=s(317),a=s(97),c=s(50),l=s(252);function d(e){const t=e.getSender(),{entity:s}=e.getPrevContent(),{entity:n,recommendation:i,reason:r}=e.getContent();return n?i&&r?n===s?l.g.includes(e.getType())?Object(o.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):l.c.includes(e.getType())?Object(o.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):l.f.includes(e.getType())?Object(o.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):Object(o.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):s?l.g.includes(e.getType())?Object(o.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:r}):l.c.includes(e.getType())?Object(o.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:r}):l.f.includes(e.getType())?Object(o.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:r}):Object(o.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:r}):l.g.includes(e.getType())?Object(o.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):l.c.includes(e.getType())?Object(o.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):l.f.includes(e.getType())?Object(o.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):Object(o.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:r}):Object(o.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):l.g.includes(e.getType())?Object(o.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:s}):l.c.includes(e.getType())?Object(o.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:s}):l.f.includes(e.getType())?Object(o.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:s}):Object(o.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:s})}const u={"m.room.message":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let s=t+": "+e.getContent().body;return"m.emote"===e.getContent().msgtype?s="* "+t+" "+s:"m.image"===e.getContent().msgtype&&(s=Object(o.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t})),s},"m.call.invite":function(e){const t=e.sender?e.sender.name:Object(o.a)("Someone");let s=!0;e.getContent().offer&&e.getContent().offer.sdp&&-1!==e.getContent().offer.sdp.indexOf("m=video")&&(s=!1);const i=n.a.get().supportsVoip();return s&&i?Object(o.a)("%(senderName)s placed a voice call.",{senderName:t}):s&&!i?Object(o.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:t}):!s&&i?Object(o.a)("%(senderName)s placed a video call.",{senderName:t}):s||i?void 0:Object(o.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:t})},"m.call.answer":function(e){const t=e.sender?e.sender.name:Object(o.a)("Someone"),s=n.a.get().supportsVoip()?"":Object(o.a)("(not supported by this browser)");return Object(o.a)("%(senderName)s answered the call.",{senderName:t})+" "+s},"m.call.hangup":function(e){const t=e.sender?e.sender.name:Object(o.a)("Someone"),s=e.getContent();let i="";return n.a.get().supportsVoip()?s.reason&&(i="ice_failed"===s.reason?Object(o.a)("(could not connect media)"):"invite_timeout"===s.reason?Object(o.a)("(no answer)"):"user hangup"===s.reason?"":Object(o.a)("(unknown failure: %(reason)s)",{reason:s.reason})):i=Object(o.a)("(not supported by this browser)"),Object(o.a)("%(senderName)s ended the call.",{senderName:t})+" "+i}},h={"m.room.canonical_alias":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent().alias,n=e.getPrevContent().alt_aliases||[],i=e.getContent().alias,r=e.getContent().alt_aliases||[],a=n.filter(e=>!r.includes(e)),c=r.filter(e=>!n.includes(e));if(a.length||c.length){if(i!==s)return Object(o.a)("%(senderName)s changed the main and alternative addresses for this room.",{senderName:t});if(c.length&&!a.length)return Object(o.a)("%(senderName)s added the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:c.join(", "),count:c.length});if(a.length&&!c.length)return Object(o.a)("%(senderName)s removed the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:a.join(", "),count:a.length});if(a.length&&c.length)return Object(o.a)("%(senderName)s changed the alternative addresses for this room.",{senderName:t})}else{if(i)return Object(o.a)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias});if(s)return Object(o.a)("%(senderName)s removed the main address for this room.",{senderName:t})}return Object(o.a)("%(senderName)s changed the addresses for this room.",{senderName:t})},"m.room.name":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?Object(o.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):Object(o.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):Object(o.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},"m.room.topic":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return Object(o.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},"m.room.member":function(e){const t=e.sender?e.sender.name:e.getSender(),s=e.target?e.target.name:e.getStateKey(),n=e.getPrevContent(),r=e.getContent(),a=i.a.getConferenceHandler(),l=r.reason?Object(o.a)("Reason")+": "+r.reason:"";switch(r.membership){case"invite":{const n=r.third_party_invite;return n?n.display_name?Object(o.a)("%(targetName)s accepted the invitation for %(displayName)s.",{targetName:s,displayName:n.display_name}):Object(o.a)("%(targetName)s accepted an invitation.",{targetName:s}):a&&a.isConferenceUser(e.getStateKey())?Object(o.a)("%(senderName)s requested a VoIP conference.",{senderName:t}):Object(o.a)("%(senderName)s invited %(targetName)s.",{senderName:t,targetName:s})}case"ban":return Object(o.a)("%(senderName)s banned %(targetName)s.",{senderName:t,targetName:s})+" "+l;case"join":return n&&"join"===n.membership?n.displayname&&r.displayname&&n.displayname!==r.displayname?Object(o.a)("%(oldDisplayName)s changed their display name to %(displayName)s.",{oldDisplayName:n.displayname,displayName:r.displayname}):!n.displayname&&r.displayname?Object(o.a)("%(senderName)s set their display name to %(displayName)s.",{senderName:e.getSender(),displayName:r.displayname}):n.displayname&&!r.displayname?Object(o.a)("%(senderName)s removed their display name (%(oldDisplayName)s).",{senderName:t,oldDisplayName:n.displayname}):n.avatar_url&&!r.avatar_url?Object(o.a)("%(senderName)s removed their profile picture.",{senderName:t}):n.avatar_url&&r.avatar_url&&n.avatar_url!==r.avatar_url?Object(o.a)("%(senderName)s changed their profile picture.",{senderName:t}):!n.avatar_url&&r.avatar_url?Object(o.a)("%(senderName)s set a profile picture.",{senderName:t}):c.a.getValue("showHiddenEventsInTimeline")?Object(o.a)("%(senderName)s made no change.",{senderName:t}):"":(e.target||console.warn("Join message has no target! -- "+e.getContent().state_key),a&&a.isConferenceUser(e.getStateKey())?Object(o.a)("VoIP conference started."):Object(o.a)("%(targetName)s joined the room.",{targetName:s}));case"leave":return e.getSender()===e.getStateKey()?a&&a.isConferenceUser(e.getStateKey())?Object(o.a)("VoIP conference finished."):"invite"===n.membership?Object(o.a)("%(targetName)s rejected the invitation.",{targetName:s}):Object(o.a)("%(targetName)s left the room.",{targetName:s}):"ban"===n.membership?Object(o.a)("%(senderName)s unbanned %(targetName)s.",{senderName:t,targetName:s}):"invite"===n.membership?Object(o.a)("%(senderName)s withdrew %(targetName)s's invitation.",{senderName:t,targetName:s})+" "+l:Object(o.a)("%(senderName)s kicked %(targetName)s.",{senderName:t,targetName:s})+" "+l}},"m.room.third_party_invite":function(e){const t=e.sender?e.sender.name:e.getSender();if(!Object(a.c)(e)){const s=e.getPrevContent().display_name||Object(o.a)("Someone");return Object(o.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:s})}return Object(o.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name})},"m.room.history_visibility":function(e){const t=e.sender?e.sender.name:e.getSender();switch(e.getContent().history_visibility){case"invited":return Object(o.a)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case"joined":return Object(o.a)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case"shared":return Object(o.a)("%(senderName)s made future room history visible to all room members.",{senderName:t});case"world_readable":return Object(o.a)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return Object(o.a)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},"m.room.power_levels":function(e){const t=e.sender?e.sender.name:e.getSender();if(!(e.getPrevContent()&&e.getPrevContent().users&&e.getContent()&&e.getContent().users))return"";const s=e.getContent().users_default||0,n=[];Object.keys(e.getContent().users).forEach(e=>{-1===n.indexOf(e)&&n.push(e)}),Object.keys(e.getPrevContent().users).forEach(e=>{-1===n.indexOf(e)&&n.push(e)});const i=[];return n.forEach(t=>{const n=e.getPrevContent().users[t],a=e.getContent().users[t];a!==n&&i.push(Object(o.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:t,fromPowerLevel:r.b(n,s),toPowerLevel:r.b(a,s)}))}),i.length?Object(o.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:i.join(", ")}):""},"m.room.pinned_events":function(e){const t=e.sender?e.sender.name:e.getSender();return Object(o.a)("%(senderName)s changed the pinned messages for the room.",{senderName:t})},"m.room.server_acl":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent(),n=[],i=e.getContent(),o={deny:Array.isArray(s.deny)?s.deny:[],allow:Array.isArray(s.allow)?s.allow:[],allow_ip_literals:!(!1===s.allow_ip_literals)};let r="";if(r=0===o.deny.length&&0===o.allow.length?t+" set server ACLs for this room: ":t+" changed the server ACLs for this room: ",Array.isArray(i.allow)||(i.allow=[]),0===i.allow.length)return r+"🎉 All servers are banned from participating! This room can no longer be used.";Array.isArray(i.deny)||(i.deny=[]);const a=i.deny.filter(e=>"string"==typeof e&&!o.deny.includes(e)),c=o.deny.filter(e=>"string"==typeof e&&!i.deny.includes(e)),l=i.allow.filter(e=>"string"==typeof e&&!o.allow.includes(e)),d=o.allow.filter(e=>"string"==typeof e&&!i.allow.includes(e));if(a.length>0&&n.push(`Servers matching ${a.join(", ")} are now banned.`),c.length>0&&n.push(`Servers matching ${c.join(", ")} were removed from the ban list.`),l.length>0&&n.push(`Servers matching ${l.join(", ")} are now allowed.`),d.length>0&&n.push(`Servers matching ${d.join(", ")} were removed from the allowed list.`),o.allow_ip_literals!==i.allow_ip_literals){const e=i.allow_ip_literals?"allowed":"banned";n.push(`Participating from a server using an IP literal hostname is now ${e}.`)}return r+n.join(" ")},"m.room.tombstone":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return Object(o.a)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},"m.room.join_rules":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case"public":return Object(o.a)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:t});case"invite":return Object(o.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:t});default:return Object(o.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:t,rule:e.getContent().join_rule})}},"m.room.guest_access":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case"can_join":return Object(o.a)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case"forbidden":return Object(o.a)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return Object(o.a)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"m.room.related_groups":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getContent().groups||[],n=e.getPrevContent().groups||[],i=s.filter(e=>!n.includes(e)),r=n.filter(e=>!s.includes(e));return i.length&&!r.length?Object(o.a)("%(senderDisplayName)s enabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:i.join(", ")}):!i.length&&r.length?Object(o.a)("%(senderDisplayName)s disabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:r.join(", ")}):i.length&&r.length?Object(o.a)("%(senderDisplayName)s enabled flair for %(newGroups)s and disabled flair for %(oldGroups)s in this room.",{senderDisplayName:t,newGroups:i.join(", "),oldGroups:r.join(", ")}):""},"im.vector.modular.widgets":function(e){const t=e.getSender(),{name:s,type:n,url:i}=e.getPrevContent(),{name:r,type:a,url:c}=e.getContent()||{};let l=r||s||a||n||"";return l&&l.length>0&&(l=l[0].toUpperCase()+l.slice(1)+" "),c?i?Object(o.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:l,senderName:t}):Object(o.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:l,senderName:t}):Object(o.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:l,senderName:t})}};for(const e of l.a)h[e]=d;function m(e){const t=(e.isState()?h:u)[e.getType()];return t?t(e):""}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(47),i=s(172),o=s(67),r=s(44),a=s(46),c=s(49),l=s(50),d=s(87);class u{constructor(e){"+"===e[0]?(this.roomId=null,this.groupId=e):(this.roomId=e,this.groupId=null),this.canceled=!1,this.addrs=[],this.busy=!1,this.completionStates={},this.errors={},this.deferred=null}invite(e){if(this.addrs.length>0)throw new Error("Already inviting/invited");this.addrs.push(...e);for(const e of this.addrs)null===Object(i.c)(e)&&(this.completionStates[e]="error",this.errors[e]={errcode:"M_INVALID",errorText:Object(r.a)("Unrecognised address")});return this.deferred=Object(d.b)(),this._inviteMore(0),this.deferred.promise}cancel(){this.busy&&(this._canceled=!0,this.deferred.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async _inviteToRoom(e,t,s){const o=Object(i.c)(t);if("email"===o)return n.a.get().inviteByEmail(e,t);if("mx-user-id"===o){const i=n.a.get().getRoom(e);if(!i)throw new Error("Room not found");const o=i.getMember(t);if(o&&["join","invite"].includes(o.membership))throw{errcode:"RIOT.ALREADY_IN_ROOM",error:"Member already invited"};if(!s&&l.a.getValue("promptBeforeInviteUnknownUsers",this.roomId))try{if(!await n.a.get().getProfileInfo(t))throw new Error("User has no profile")}catch(e){throw{errcode:"RIOT.USER_NOT_FOUND",error:"User does not have a profile or does not exist."}}return n.a.get().invite(e,t)}throw new Error("Unsupported address")}_doInvite(e,t){return new Promise((s,n)=>{let i;console.log("Inviting "+e),i=null!==this.groupId?o.a.inviteUserToGroup(this.groupId,e):this._inviteToRoom(this.roomId,e,t),i.then(()=>{this._canceled||(this.completionStates[e]="invited",delete this.errors[e],s())}).catch(i=>{if(this._canceled)return;let o;console.error(i);let a=!1;if("M_FORBIDDEN"===i.errcode)a=!0,o=Object(r.a)("You do not have permission to invite people to this room.");else if("RIOT.ALREADY_IN_ROOM"===i.errcode)o=Object(r.a)("User %(userId)s is already in the room",{userId:e});else{if("M_LIMIT_EXCEEDED"===i.errcode)return void setTimeout(()=>{this._doInvite(e,t).then(s,n)},5e3);["M_NOT_FOUND","M_USER_NOT_FOUND","RIOT.USER_NOT_FOUND"].includes(i.errcode)?o=Object(r.a)("User %(user_id)s does not exist",{user_id:e}):"M_PROFILE_UNDISCLOSED"===i.errcode?o=Object(r.a)("User %(user_id)s may or may not exist",{user_id:e}):"M_PROFILE_NOT_FOUND"!==i.errcode||t?o="M_BAD_STATE"===i.errcode?Object(r.a)("The user must be unbanned before they can be invited."):"M_UNSUPPORTED_ROOM_VERSION"===i.errcode?Object(r.a)("The user's homeserver does not support the version of the room."):Object(r.a)("Unknown server error"):(console.warn(`User ${e} does not have a profile - inviting anyways automatically`),this._doInvite(e,!0).then(s,n))}this.completionStates[e]="error",this.errors[e]={errorText:o,errcode:i.errcode},this.busy=!a,this.fatal=a,a?n():s()})})}_inviteMore(e,t){if(this._canceled)return;if(e===this.addrs.length){if(this.busy=!1,Object.keys(this.errors).length>0&&!this.groupId){const e=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND","RIOT.USER_NOT_FOUND"],t=Object.keys(this.errors).filter(t=>e.includes(this.errors[t].errcode));if(t.length>0){const e=()=>{const e=t.map(e=>this._doInvite(e,!0));Promise.all(e).then(()=>this.deferred.resolve(this.completionStates))};if(!l.a.getValue("promptBeforeInviteUnknownUsers",this.roomId))return void e();const s=a.getComponent("dialogs.AskInviteAnywayDialog");return console.log("Showing failed to invite dialog..."),void c.a.createTrackedDialog("Failed to invite the following users to the room","",s,{unknownProfileUsers:t.map(e=>({userId:e,errorText:this.errors[e].errorText})),onInviteAnyways:()=>e(),onGiveUp:()=>{for(const e of t)this.completionStates[e]="invited";this.deferred.resolve(this.completionStates)}})}}return void this.deferred.resolve(this.completionStates)}const s=this.addrs[e];null!==Object(i.c)(s)&&"invited"!==this.completionStates[s]?this._doInvite(s,t).then(()=>{this._inviteMore(e+1,t)}).catch(()=>this.deferred.resolve(this.completionStates)):this._inviteMore(e+1)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"c",(function(){return r}));var n=s(47);function i(e){return e.getCanonicalAlias()||e.getAltAliases()[0]}function o(e,t){let s;if(t){s=function(e,t){let s,n;for(const i of e.getJoinedMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());if(n)return n.userId;for(const i of e.currentState.getMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());return void 0===n?t:n.userId}(e,n.a.get().getUserId())}else s=null;return r(e.roomId,s)}function r(e,t){if(n.a.get().isGuest())return Promise.resolve();const s=n.a.get().getAccountData("m.direct");let i={};void 0!==s&&(i=s.getContent());for(const s of Object.keys(i)){const n=i[s];if(s!=t){const t=n.indexOf(e);t>-1&&n.splice(t,1)}}if(t){const s=i[t]||[];-1==s.indexOf(e)&&s.push(e),i[t]=s}return n.a.get().setAccountData("m.direct",i)}},,,function(e,t,s){"use strict";function n(e){return e/10+"rem"}function i(e){return e+"px"}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"e",(function(){return a})),s.d(t,"d",(function(){return c})),s.d(t,"g",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"f",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return p}));var n=s(2),i=s.n(n),o=s(551),r=s(47);const a="m.room.rule.user",c="m.room.rule.server",l=[a,"org.matrix.mjolnir.rule.user"],d=["m.room.rule.room","org.matrix.mjolnir.rule.room"],u=[c,"org.matrix.mjolnir.rule.server"],h=[...l,...d,...u];function m(e,t=!0){return l.includes(e)?t?l[l.length-1]:a:d.includes(e)?t?d[d.length-1]:"m.room.rule.room":u.includes(e)?t?u[u.length-1]:c:null}class p{constructor(e){i()(this,"_rules",[]),i()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter(e=>e.kind===c)}get userRules(){return this._rules.filter(e=>e.kind===a)}get roomRules(){return this._rules.filter(e=>"m.room.rule.room"===e.kind)}async banEntity(e,t,s){await r.a.get().sendStateEvent(this._roomId,m(e,!0),{entity:t,reason:s,recommendation:Object(o.c)(o.b,!0)},"rule:"+t),this._rules.push(new o.a(t,o.b,s,m(e,!1)))}async unbanEntity(e,t){await r.a.get().sendStateEvent(this._roomId,m(e,!0),{},"rule:"+t),this._rules=this._rules.filter(s=>s.kind!==m(e,!1)||s.entity!==t)}updateList(){this._rules=[];const e=r.a.get().getRoom(this._roomId);if(e)for(const t of h){const s=e.currentState.getStateEvents(t,void 0);for(const e of s){if(!e.getStateKey())continue;const s=m(t,!1),n=e.getContent().entity,i=e.getContent().recommendation,r=e.getContent().reason;n&&i&&r&&this._rules.push(new o.a(n,i,r,s))}}}}},function(e,t,s){"use strict";function n(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const i=s[n];if(!t.hasOwnProperty(i)||e[i]!==t[i])return!1}return!0}s.d(t,"a",(function(){return n}))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(55);class i{constructor(e,t,s,n){this._hsUrl=e,this._isUrl=t,this._fallbackHsUrl=s,this._currentFlowIndex=0,this._flows=[],this._defaultDeviceDisplayName=n.defaultDeviceDisplayName,this._tempClient=null}getHomeserverUrl(){return this._hsUrl}getIdentityServerUrl(){return this._isUrl}setHomeserverUrl(e){this._tempClient=null,this._hsUrl=e}setIdentityServerUrl(e){this._tempClient=null,this._isUrl=e}createTemporaryClient(){return this._tempClient?this._tempClient:this._tempClient=n.r.createClient({baseUrl:this._hsUrl,idBaseUrl:this._isUrl})}getFlows(){const e=this;return this.createTemporaryClient().loginFlows().then((function(t){return e._flows=t.flows,e._currentFlowIndex=0,e._flows}))}chooseFlow(e){this._currentFlowIndex=e}getCurrentFlowStep(){const e=this._flows[this._currentFlowIndex];return e?e.type:null}loginViaPassword(e,t,s,n){const i=this,r=e.indexOf("@")>0;let a;a=t&&s?{type:"m.id.phone",country:t,phone:s,number:s}:r?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const c={password:n,identifier:a,initial_device_display_name:this._defaultDeviceDisplayName},l=e=>o(i._fallbackHsUrl,this._isUrl,"m.login.password",c).catch(t=>{throw console.log("fallback HS login failed",t),e});let d=null;return o(i._hsUrl,i._isUrl,"m.login.password",c).catch(e=>{if(d=e,403===e.httpStatus&&i._fallbackHsUrl)return l(d);throw d}).catch(e=>{throw console.log("Login failed",e),e})}}async function o(e,t,s,i){const o=n.r.createClient({baseUrl:e,idBaseUrl:t}),r=await o.login(s,i),a=r.well_known;return a&&(a["m.homeserver"]&&a["m.homeserver"].base_url&&(e=a["m.homeserver"].base_url,console.log(`Overrode homeserver setting with ${e} from login response`)),a["m.identity_server"]&&a["m.identity_server"].base_url&&(t=a["m.identity_server"].base_url,console.log(`Overrode IS setting with ${t} from login response`))),{homeserverUrl:e,identityServerUrl:t,userId:r.user_id,deviceId:r.device_id,accessToken:r.access_token}}},function(e,t){e.exports="img/e2e/warning.53a9e82.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44);class d extends r.a.Component{constructor(...e){super(...e),i()(this,"_onCancelClick",()=>{this.props.onCancel()})}render(){let e,t="mx_Dialog_primary";return this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=r.a.createElement("button",{type:"button",onClick:this._onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(l.a)("Cancel"))),r.a.createElement("div",{className:"mx_Dialog_buttons"},e,this.props.children,r.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton))}}i()(d,"propTypes",{primaryButton:c.a.node.isRequired,cancelButton:c.a.node,primaryIsSubmit:c.a.bool,onPrimaryButtonClick:c.a.func,hasCancel:c.a.bool,cancelButtonClass:c.a.node,onCancel:c.a.func,focus:c.a.bool,disabled:c.a.bool,primaryDisabled:c.a.bool}),i()(d,"defaultProps",{hasCancel:!0,disabled:!1})},function(e,t,s){"use strict";var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(51),d=s.n(l),u=s(46);t.a=e=>{let{checked:t,disabled:s=!1,onChange:n}=e,o=r()(e,["checked","disabled","onChange"]);const a=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!s}),l=u.getComponent("elements.AccessibleButton");return c.a.createElement(l,i()({},o,{className:a,onClick:()=>{s||n(!t)},role:"switch","aria-checked":t,"aria-disabled":s}),c.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},function(e,t,s){"use strict";s.d(t,"b",(function(){return m})),s.d(t,"a",(function(){return p}));var n=s(43),i=s.n(n),o=s(49),r=s(46),a=s(247),c=s(44),l=s(47),d=s(67),u=s(87),h=s(94);function m(e){return new Promise((t,s)=>{const n=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Who would you like to add to this community?")),i.a.createElement("div",{className:"warning"},Object(c.a)("Warning: any person you add to a community will be publicly visible to anyone who knows the community ID"))),l=r.getComponent("dialogs.AddressPickerDialog");o.a.createTrackedDialog("Group Invite","",l,{title:Object(c.a)("Invite new community members"),description:n,placeholder:Object(c.a)("Name or Matrix ID"),button:Object(c.a)("Invite to Community"),validAddressTypes:["mx-user-id"],onFinished:(n,i)=>{n&&function(e,t){const s=new a.a(e),n=t.map(e=>e.address);return s.invite(n).then(s=>{const n=[];for(const e of Object.keys(s))"error"===t[e]&&n.push(e);if(n.length>0){const t=r.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to invite the following users to the group","",t,{title:Object(c.a)("Failed to invite the following users to %(groupId)s:",{groupId:e}),description:n.join(", ")})}}).catch(t=>{const s=r.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to invite users to group","",s,{title:Object(c.a)("Failed to invite users to community"),description:Object(c.a)("Failed to invite users to %(groupId)s",{groupId:e})})})}(e,i).then(t,s)}},null,!1,!0)})}function p(e){return new Promise((t,s)=>{let n=!1;const a=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Which rooms would you like to add to this community?"))),m=i.a.createElement(h.a,{className:"mx_GroupAddressPicker_checkboxContainer",onChange:e=>{n=e.target.checked}},Object(c.a)("Show these rooms to non-members on the community page and room list?")),p=r.getComponent("dialogs.AddressPickerDialog");o.a.createTrackedDialog("Add Rooms to Group","",p,{title:Object(c.a)("Add rooms to the community"),description:a,extraNode:m,placeholder:Object(c.a)("Room name or address"),button:Object(c.a)("Add to community"),pickerType:"room",validAddressTypes:["mx-room-id"],onFinished:(i,a)=>{i&&function(e,t,s){const n=l.a.get(),i=[];return Object(u.a)(t.map(t=>d.a.addRoomToGroup(e,t.address,s).catch(()=>{i.push(t.address)}).then(()=>{const s=t.address,i=n.getRoom(s);if(!i||!i.currentState.mayClientSendStateEvent("m.room.related_groups",n))return;const o=i.currentState.getStateEvents("m.room.related_groups",""),r=o&&o.getContent().groups||[];return r.includes(e)?void 0:(r.push(e),l.a.get().sendStateEvent(s,"m.room.related_groups",{groups:r},""))}))).then(()=>{if(0===i.length)return;const t=r.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to add the following room to the group","",t,{title:Object(c.a)("Failed to add the following rooms to %(groupId)s:",{groupId:e}),description:i.join(", ")})})}(e,a,n).then(t,s)}},null,!1,!0)})}},function(e,t,s){"use strict";async function n(e){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const s=document.getSelection(),n=document.createRange();n.selectNode(t),s.removeAllRanges(),s.addRange(n);const i=document.execCommand("copy");return s.removeAllRanges(),document.body.removeChild(t),i}}catch(e){console.error("copyPlaintext failed",e)}return!1}function i(e){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}function o(e){return i(e),document.execCommand("copy")}s.d(t,"b",(function(){return n})),s.d(t,"c",(function(){return i})),s.d(t,"a",(function(){return o}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(103),r=s(48),a=s(50),c=s(171),l=s(76),d=s(57),u=s(102),h=s(86);class m extends o.a{constructor(){super(r.a,{}),i()(this,"widgetMap",new Map),i()(this,"roomMap",new Map),i()(this,"onWidgetEchoStoreUpdate",(e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(h.b)}),i()(this,"onRoomStateEvents",e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(h.b)}),i()(this,"getRoomId",e=>{const t=this.widgetMap.get(e);return t?t.roomId:null}),i()(this,"getRoom",e=>this.roomMap.get(e)),i()(this,"onPinnedWidgetsChange",(e,t)=>{this.initRoom(t),this.getRoom(t).pinned=a.a.getValue(e,t),this.emit(t),this.emit(h.b)}),a.a.watchSetting("Widgets.pinned",null,this.onPinnedWidgetsChange),c.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return m.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{pinned:{},widgets:[]})}async onReady(){this.matrixClient.on("RoomState.events",this.onRoomStateEvents),this.matrixClient.getRooms().forEach(e=>{const t=a.a.getValue("Widgets.pinned",e.roomId);(t||l.a.getRoomWidgets(e).length)&&this.initRoom(e.roomId),t&&(this.getRoom(e.roomId).pinned=t),this.loadRoomWidgets(e)}),this.emit(h.b)}async onNotReady(){this.matrixClient.off("RoomState.events",this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return c.a.getEchoedRoomWidgets(e.roomId,l.a.getRoomWidgets(e)).map(e=>l.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId()))}loadRoomWidgets(e){const t=this.roomMap.get(e.roomId);t.widgets=[],this.generateApps(e).forEach(e=>{this.widgetMap.set(e.id,e),t.widgets.push(e)}),this.emit(e.roomId)}isPinned(e){const t=this.getRoomId(e),s=this.getRoom(t);let n=s&&s.pinned[e];return void 0===n&&u.a.JITSI.matches(this.widgetMap.get(e).type)&&(n=!0),n}canPin(e){const t=this.getRoomId(e),s=this.getRoom(t);return s&&Object.keys(s.pinned).length<2}pinWidget(e){this.setPinned(e,!0)}unpinWidget(e){this.setPinned(e,!1)}setPinned(e,t){const s=this.getRoomId(e),n=this.getRoom(s);n&&(n.pinned[e]=t,Object.keys(n).forEach(e=>{n.widgets.some(t=>t.id===e)||delete n.pinned[e]}),a.a.setValue("Widgets.pinned",s,d.a.ROOM_ACCOUNT,n.pinned),this.emit(s),this.emit(h.b))}getApps(e,t){const s=this.getRoom(e.roomId);return s?t?s.widgets.filter(e=>this.isPinned(e.id)):s.widgets:[]}}i()(m,"internalInstance",new m),window.mxWidgetStore=m.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return B}));var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(66),c=s.n(a),l=s(470),d=s.n(l),u=s(43),h=s.n(u),m=s(45),p=s.n(m),g=s(47),f=s(872),_=s(52),v=s(49),y=s(44),b=s(46),E=s(502),S=s(503),w=s(99),C=s(76),R=s(48),k=s(142),I=s(51),O=s.n(I),T=s(93),x=s(50),N=s(61),j=s(349),P=s(102),D=s(7),A=s(87),U=s(57),M=s(261),L=s(54);const F=["https:","http:"];class B extends h.a.Component{constructor(e){super(e),r()(this,"_onUnpinClicked",()=>{M.a.instance.unpinWidget(this.props.app.id)}),r()(this,"_onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),r()(this,"_closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this._persistKey="widget_"+this.props.app.id,this.state=this._getNewState(e),this._onAction=this._onAction.bind(this),this._onLoaded=this._onLoaded.bind(this),this._onEditClick=this._onEditClick.bind(this),this._onDeleteClick=this._onDeleteClick.bind(this),this._onRevokeClicked=this._onRevokeClicked.bind(this),this._onSnapshotClick=this._onSnapshotClick.bind(this),this.onClickMenuBar=this.onClickMenuBar.bind(this),this._onMinimiseClick=this._onMinimiseClick.bind(this),this._grantWidgetPermission=this._grantWidgetPermission.bind(this),this._revokeWidgetPermission=this._revokeWidgetPermission.bind(this),this._onPopoutWidgetClick=this._onPopoutWidgetClick.bind(this),this._onReloadWidgetClick=this._onReloadWidgetClick.bind(this),this._contextMenuButton=Object(u.createRef)(),this._appFrame=Object(u.createRef)(),this._menu_bar=Object(u.createRef)()}_getNewState(e){const t=b.getComponent("elements.PersistedElement");return{initialising:!0,loading:this.props.waitForIframeLoad&&!t.isMounted(this._persistKey),widgetUrl:this._addWurlParams(e.app.url),hasPermissionToLoad:e.userId===e.creatorUserId||(()=>{if(this._usingLocalWidget())return!0;return!!x.a.getValue("allowedWidgets",e.room.roomId)[e.app.eventId]})(),error:null,deleting:!1,widgetPageTitle:e.widgetPageTitle,menuDisplayed:!1}}_hasCapability(e){return k.a.widgetHasCapability(this.props.app.id,e)}_addWurlParams(e){try{const t=new URL(e);return t.searchParams.set("widgetId",this.props.app.id),t.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),t.toString().replace(/%24/g,"$")}catch(t){return console.error("Failed to add widget URL params:",t),e}}isMixedContent(){const e=window.location.protocol,t=c.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(console.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.props.show&&this.state.hasPermissionToLoad&&this.setScalarToken(),this.dispatcherRef=R.a.register(this._onAction)}componentWillUnmount(){if(this.dispatcherRef&&R.a.unregister(this.dispatcherRef),!k.a.getWidgetPersistence(this.props.app.id)){k.a.destroyPersistentWidget(this.props.app.id);b.getComponent("elements.PersistedElement").destroyElement(this._persistKey)}}setScalarToken(){if(!C.a.isScalarUrl(this.props.app.url))return console.warn("Widget does not match integration manager, refusing to set auth token",c.a),void this.setState({error:null,widgetUrl:this._addWurlParams(this.props.app.url),initialising:!1});const e=T.a.sharedInstance();if(!e.hasManager())return console.warn("No integration manager - not setting scalar token",c.a),void this.setState({error:null,widgetUrl:this._addWurlParams(this.props.app.url),initialising:!1});const t=e.getPrimaryManager();if(!C.a.isScalarUrl(t.apiUrl))return console.warn("Unknown integration manager, refusing to set auth token",c.a),void this.setState({error:null,widgetUrl:this._addWurlParams(this.props.app.url),initialising:!1});this._scalarClient||(this._scalarClient=t.getScalarClient()),this._scalarClient.getScalarToken().then(e=>{this._scalarClient.scalarToken=e;const t=c.a.parse(this._addWurlParams(this.props.app.url)),s=d.a.parse(t.query);s.scalar_token||(s.scalar_token=encodeURIComponent(e),t.search=void 0,t.query=s),this.setState({error:null,widgetUrl:t.format(),initialising:!1}),!this.state.widgetPageTitle&&s.url&&this._fetchWidgetTitle(s.url)},e=>{console.error("Failed to get scalar_token",e),this.setState({error:e.message,initialising:!1})})}UNSAFE_componentWillReceiveProps(e){e.app.url!==this.props.app.url&&(this._getNewState(e),this.props.show&&this.state.hasPermissionToLoad&&this.setScalarToken()),e.show&&!this.props.show&&(this.props.waitForIframeLoad&&!j.a.isMounted(this._persistKey)&&this.setState({loading:!0}),this.state.hasPermissionToLoad&&this.setScalarToken()),e.widgetPageTitle!==this.props.widgetPageTitle&&this.setState({widgetPageTitle:e.widgetPageTitle})}_canUserModify(){return!(!this.props.userWidget||g.a.get().credentials.userId!==this.props.creatorUserId)||C.a.canUserModifyWidgets(this.props.room.roomId)}_onEditClick(){console.log("Edit widget ID ",this.props.app.id),this.props.onEditClick?this.props.onEditClick():C.a.editWidget(this.props.room,this.props.app)}_onSnapshotClick(){C.a.snapshotWidget(this.props.app)}_endWidgetActions(){let e;if(this._hasCapability(D.a.ReceiveTerminate)){const t=2e3,s=k.a.getWidgetMessaging(this.props.app.id);e=Promise.race([s.terminate(),Object(A.c)(t)])}else e=Promise.resolve();return e.finally(()=>{this._appFrame.current&&(this._appFrame.current.src="about:blank"),j.a.destroyElement(this._persistKey)})}_onDeleteClick(){if(this.props.onDeleteClick)this.props.onDeleteClick();else if(this._canUserModify()){const e=b.getComponent("dialogs.QuestionDialog");v.a.createTrackedDialog("Delete Widget","",e,{title:Object(y.a)("Delete Widget"),description:Object(y.a)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(y.a)("Delete widget"),onFinished:e=>{e&&(this.setState({deleting:!0}),this._endWidgetActions().then(()=>C.a.setRoomWidget(this.props.room.roomId,this.props.app.id)).catch(e=>{console.error("Failed to delete widget",e);const t=b.getComponent("dialogs.ErrorDialog");v.a.createTrackedDialog("Failed to remove widget","",t,{title:Object(y.a)("Failed to remove widget"),description:Object(y.a)("An error ocurred whilst trying to remove the widget from the room")})}).finally(()=>{this.setState({deleting:!1})}))}})}}_onRevokeClicked(){console.info("Revoke widget permissions - %s",this.props.app.id),this._revokeWidgetPermission()}_onLoaded(){k.a.delWidgetMessaging(this.props.app.id),this._setupWidgetMessaging(),k.a.setRoomId(this.props.app.id,this.props.room.roomId),this.setState({loading:!1})}_setupWidgetMessaging(){const e=new f.a(this.props.app.id,this.props.app.url,this._getRenderedUrl(),this.props.userWidget,this._appFrame.current.contentWindow);k.a.setWidgetMessaging(this.props.app.id,e),e.getCapabilities().then(t=>{console.log(`Widget ${this.props.app.id} requested capabilities: `+t),t=t||[];let s=[];this.props.whitelistCapabilities&&this.props.whitelistCapabilities.length>0&&(s=t.filter((function(e){return this.indexOf(e)>=0}),this.props.whitelistCapabilities),s.length>0&&console.log(`Widget ${this.props.app.id} allowing requested, whitelisted properties: `+s)),k.a.setWidgetCapabilities(this.props.app.id,s),this.props.onCapabilityRequest&&this.props.onCapabilityRequest(t),P.a.JITSI.matches(this.props.app.type)&&e.flagReadyToContinue()}).catch(e=>{console.log("Failed to get capabilities for widget type "+this.props.app.type,this.props.app.id,e)})}_onAction(e){if(e.widgetId===this.props.app.id)switch(e.action){case"m.sticker":this._hasCapability("m.sticker")?R.a.dispatch({action:"post_sticker_message",data:e.data}):console.warn("Ignoring sticker message. Invalid capability");break;case L.a.AppTileDelete:this._onDeleteClick();break;case L.a.AppTileRevoke:this._onRevokeClicked()}}_fetchWidgetTitle(e){this._scalarClient.getScalarPageTitle(e).then(e=>{e&&this.setState({widgetPageTitle:e})},e=>{console.error("Failed to get page title",e)})}_grantWidgetPermission(){const e=this.props.room.roomId;console.info("Granting permission for widget to load: "+this.props.app.eventId);const t=x.a.getValue("allowedWidgets",e);t[this.props.app.eventId]=!0,x.a.setValue("allowedWidgets",e,U.a.ROOM_ACCOUNT,t).then(()=>{this.setState({hasPermissionToLoad:!0}),this.setScalarToken()}).catch(e=>{console.error(e)})}_revokeWidgetPermission(){const e=this.props.room.roomId;console.info("Revoking permission for widget to load: "+this.props.app.eventId);const t=x.a.getValue("allowedWidgets",e);t[this.props.app.eventId]=!1,x.a.setValue("allowedWidgets",e,U.a.ROOM_ACCOUNT,t).then(()=>{this.setState({hasPermissionToLoad:!1}),k.a.destroyPersistentWidget(this.props.app.id);b.getComponent("elements.PersistedElement").destroyElement(this._persistKey)}).catch(e=>{console.error(e)})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}onClickMenuBar(e){e.preventDefault(),e.target===this._menu_bar.current&&(this.props.userWidget?this._onMinimiseClick():(this.props.show&&this._endWidgetActions(),R.a.dispatch({action:"appsDrawer",show:!this.props.show})))}_templatedUrl(e,t){const s={};P.a.JITSI.matches(t)&&(s.domain="jitsi.riot.im");const n=g.a.get().credentials.userId,i=g.a.get().getUser(n),o=Object.assign(s,this.props.app.data,{matrix_user_id:n,matrix_room_id:this.props.room.roomId,matrix_display_name:i?i.displayName:n,matrix_avatar_url:i?g.a.get().mxcUrlToHttp(i.avatarUrl):"",theme:x.a.getValue("theme")});if(void 0===o.conferenceId){const e=new URL(this.props.app.url);o.conferenceId=e.searchParams.get("confId")}return function(e,t){let s=e;for(const[e,n]of Object.entries(t))s=s.replace("$"+e,encodeURIComponent(n));return s}(e,o)}_usingLocalWidget(){return P.a.JITSI.matches(this.props.app.type)}_getRenderedUrl(){let e;return P.a.JITSI.matches(this.props.app.type)?(console.log("Replacing Jitsi widget URL with local wrapper"),e=C.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:this.props.app.data?this.props.app.data.auth:null}),e=this._addWurlParams(e)):e=this._getSafeUrl(this.state.widgetUrl),this._templatedUrl(e,this.props.app.type)}_getPopoutUrl(){return P.a.JITSI.matches(this.props.app.type)?this._templatedUrl(C.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:this.props.app.data?this.props.app.data.auth:null}),this.props.app.type):this._templatedUrl(this._getSafeUrl(this.props.app.url),this.props.app.type)}_getSafeUrl(e){const t=c.a.parse(e,!0);let s="";return F.includes(t.protocol)&&(s=c.a.format(t)),s.replace(/%24/g,"$")}_getTileTitle(){const e=this.formatAppTileName(),t=h.a.createElement("span",null," - ");let s="";return this.state.widgetPageTitle&&this.state.widgetPageTitle!=this.formatAppTileName()&&(s=this.state.widgetPageTitle),h.a.createElement("span",null,h.a.createElement("b",null,e),h.a.createElement("span",null,s?t:"",s))}_onMinimiseClick(e){this.props.onMinimiseClick&&this.props.onMinimiseClick()}_onPopoutWidgetClick(){P.a.JITSI.matches(this.props.app.type)&&this.props.show&&this._endWidgetActions().then(()=>{this._appFrame.current&&(this._appFrame.current.src=this._getRenderedUrl(),this.setState({}))}),Object.assign(document.createElement("a"),{target:"_blank",href:this._getPopoutUrl(),rel:"noreferrer noopener"}).click()}_onReloadWidgetClick(){this._appFrame.current.src=this._appFrame.current.src}render(){let e;if(this.state.deleting)return h.a.createElement("div",null);const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" ");if(this.props.show){const s=h.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},h.a.createElement(w.a,{message:Object(y.a)("Loading...")}));if(this.state.hasPermissionToLoad){if(this.state.initialising)e=h.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":"")},s);else if(this.isMixedContent())e=h.a.createElement("div",{className:t},h.a.createElement(S.a,{errorMsg:"Error - Mixed content"}));else if(e=h.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":"")},this.state.loading&&s,h.a.createElement("iframe",{allow:"microphone; camera; encrypted-media; autoplay; display-capture;",ref:this._appFrame,src:this._getRenderedUrl(),allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation",onLoad:this._onLoaded})),this.props.whitelistCapabilities.includes("m.always_on_screen")){const t=b.getComponent("elements.PersistedElement");e=h.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},h.a.createElement(t,{persistKey:this._persistKey},e))}}else{const s=g.a.get().isRoomEncrypted(this.props.room.roomId);e=h.a.createElement("div",{className:t},h.a.createElement(E.a,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.state.widgetUrl,isRoomEncrypted:s,onPermissionGranted:this._grantWidgetPermission}))}}const s=this.props.showMinimise&&this.props.show,n=this.props.showMinimise&&!this.props.show;let o;o=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},o.mx_AppTile_minimised=!this.props.show,o=O()(o);const r=O()({mx_AppTileMenuBar:!0,mx_AppTileMenuBar_expanded:this.props.show});let a;if(this.state.menuDisplayed){const e=this._contextMenuButton.current.getBoundingClientRect(),t=this._canUserModify(),s=Boolean(this._scalarClient&&t),n=(void 0===this.props.showDelete||this.props.showDelete)&&t,o=this._hasCapability("m.capability.screenshot")&&this.props.show,r=b.getComponent("views.context_menus.WidgetContextMenu");a=h.a.createElement(N.b,i()({},Object(N.k)(e,null),{onFinished:this._closeContextMenu}),h.a.createElement(r,{onUnpinClicked:this._onUnpinClicked,onRevokeClicked:this._onRevokeClicked,onEditClicked:s?this._onEditClick:void 0,onDeleteClicked:n?this._onDeleteClick:void 0,onSnapshotClicked:o?this._onSnapshotClick:void 0,onReloadClicked:this.props.showReload?this._onReloadWidgetClick:void 0,onFinished:this._closeContextMenu}))}return h.a.createElement(h.a.Fragment,null,h.a.createElement("div",{className:o,id:this.props.app.id},this.props.showMenubar&&h.a.createElement("div",{ref:this._menu_bar,className:r,onClick:this.onClickMenuBar},h.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:!!this.props.handleMinimisePointerEvents&&"all"}},s&&h.a.createElement(_.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_minimise",title:Object(y.a)("Minimize apps"),onClick:this._onMinimiseClick}),n&&h.a.createElement(_.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_maximise",title:Object(y.a)("Maximize apps"),onClick:this._onMinimiseClick}),this.props.showTitle&&this._getTileTitle()),h.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},this.props.showPopout&&h.a.createElement(_.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(y.a)("Popout widget"),onClick:this._onPopoutWidgetClick}),h.a.createElement(N.c,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(y.a)("More options"),isExpanded:this.state.menuDisplayed,inputRef:this._contextMenuButton,onClick:this._onContextMenuClick}))),e),a)}}B.displayName="AppTile",B.propTypes={app:p.a.object.isRequired,room:p.a.object.isRequired,fullWidth:p.a.bool,miniMode:p.a.bool,userId:p.a.string.isRequired,creatorUserId:p.a.string,waitForIframeLoad:p.a.bool,showMenubar:p.a.bool,show:p.a.bool,onEditClick:p.a.func,onDeleteClick:p.a.func,onMinimiseClick:p.a.func,showTitle:p.a.bool,showMinimise:p.a.bool,handleMinimisePointerEvents:p.a.bool,showDelete:p.a.bool,showPopout:p.a.bool,showReload:p.a.bool,whitelistCapabilities:p.a.array,onCapabilityRequest:p.a.func,userWidget:p.a.bool},B.defaultProps={waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showMinimise:!0,showDelete:!0,showPopout:!0,showReload:!1,handleMinimisePointerEvents:!1,whitelistCapabilities:[],userWidget:!1,miniMode:!1}},function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(51),c=s.n(a),l=s(53),d=s(185),u=s(44),h=s(64);class m extends o.PureComponent{constructor(...e){super(...e),i()(this,"state",{complexity:null}),i()(this,"validate",Object(d.a)({description:function(){const e=this.state.complexity,t=e?e.score:0;return r.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(u.a)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e}){if(!e)return!1;const{scorePassword:t}=await Promise.all([s.e(20),s.e(27)]).then(s.bind(null,1147)),n=t(e);this.setState({complexity:n});const i=n.score>=this.props.minScore;return l.a.get().dangerously_allow_unsafe_and_insecure_passwords||i},valid:function(){return this.state.complexity.score>=this.props.minScore?Object(u.a)(this.props.labelStrongPassword):Object(u.a)(this.props.labelAllowedButUnsafe)},invalid:function(){const e=this.state.complexity;if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||Object(u.a)("Keep going...")}}]})),i()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate(t),t})}render(){return r.a.createElement(h.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:c()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(u.a)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(m,"defaultProps",{label:Object(u.b)("Password"),labelEnterPassword:Object(u.b)("Enter password"),labelStrongPassword:Object(u.b)("Nice, strong password!"),labelAllowedButUnsafe:Object(u.b)("Password is allowed, but unsafe")}),t.a=m},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(10),i=s(107),o=s(81),r=s(1),a=s(0),c=s(269),l=s.n(c);class d extends n.EventEmitter{constructor(e,t,s){super(),l()(this,"_onEventStatus",(e,t)=>{e.isSending()?t===o.a.CANCELLED&&(e.removeListener("Event.status",this._onEventStatus),this._removeEvent(e)):e.removeListener("Event.status",this._onEventStatus)}),l()(this,"_onBeforeRedaction",e=>{this._relations.has(e)&&(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.removeListener("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.redaction",e))}),this.relationType=e,this.eventType=t,this._relations=new Set,this._annotationsByKey={},this._annotationsBySender={},this._sortedAnnotationsByKey=[],this._targetEvent=null}addEvent(e){if(this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const s=t.rel_type,n=e.getType();this.relationType===s&&this.eventType===n?(e.isSending()&&e.on("Event.status",this._onEventStatus),this._relations.add(e),"m.annotation"===this.relationType?this._addAnnotationToAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",e)):console.error("Event relation info doesn't match this container")}_removeEvent(e){if(!this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const s=t.rel_type,n=e.getType();this.relationType===s&&this.eventType===n?(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),this.emit("Relations.remove",e)):console.error("Event relation info doesn't match this container")}getRelations(){return[...this._relations]}_addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let s=this._annotationsByKey[t];s||(s=this._annotationsByKey[t]=new Set,this._sortedAnnotationsByKey.push([t,s])),s.add(e),this._sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size});const n=e.getSender();let i=this._annotationsBySender[n];i||(i=this._annotationsBySender[n]=new Set),i.add(e)}_removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const s=this._annotationsByKey[t];s&&(s.delete(e),this._sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size}));const n=e.getSender(),i=this._annotationsBySender[n];i&&i.delete(e)}getSortedAnnotationsByKey(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}getAnnotationsBySender(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}getLastReplacement(){if("m.replace"!==this.relationType)return null;if(!this._targetEvent)return null;const e=this._targetEvent.getServerAggregatedRelation("m.replace"),t=e&&e.origin_server_ts;return this.getRelations().reduce((e,s)=>s.getSender()!==this._targetEvent.getSender()||t&&t>s.getTs()||e&&e.getTs()>s.getTs()?e:s,null)}setTargetEvent(e){if(!this._targetEvent&&(this._targetEvent=e,"m.replace"===this.relationType)){const e=this.getLastReplacement();e&&this._targetEvent.makeReplaced(e)}}}let u;function h(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new i.a(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}u=a.a.log.bind(a.a),r.o(h,n.EventEmitter),h.prototype.getTimelines=function(){return this._timelines},h.prototype.getFilter=function(){return this._filter},h.prototype.setFilter=function(e){this._filter=e},h.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},h.prototype.getLiveTimeline=function(){return this._liveTimeline},h.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},h.prototype.replaceEventId=function(e,t){const s=this._eventIdToTimeline[e];s&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=s)},h.prototype.resetLiveTimeline=function(e,t){const s=!this._timelineSupport||!t,n=this._liveTimeline,o=s?n.forkLive(i.a.FORWARDS):n.fork(i.a.FORWARDS);s?(this._timelines=[o],this._eventIdToTimeline={}):this._timelines.push(o),t&&n.setPaginationToken(t,i.a.FORWARDS),o.setPaginationToken(e,i.a.BACKWARDS),this._liveTimeline=o,this.emit("Room.timelineReset",this.room,this,s)},h.prototype.getTimelineForEvent=function(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t},h.prototype.findEventById=function(e){const t=this.getTimelineForEvent(e);if(t)return r.k(t.getEvents(),(function(t){return t.getId()==e}))},h.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new i.a(this);return this._timelines.push(e),e},h.prototype.addEventsToTimeline=function(e,t,s,n){if(!s)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&s==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this._filter&&!(e=this._filter.filterRoomTimeline(e)).length)return;const o=t?i.a.BACKWARDS:i.a.FORWARDS,r=t?i.a.FORWARDS:i.a.BACKWARDS;let c=!1,l=!1;for(let n=0;n<e.length;n++){const d=e[n],h=d.getId(),m=this._eventIdToTimeline[h];if(!m){this.addEventToTimeline(d,s,t),l=!0,c=!0;continue}if(l=!1,m==s){u("Event "+h+" already in timeline "+s);continue}const p=s.getNeighbouringTimeline(o);if(p){u(m==p?"Event "+h+" in neighbouring timeline - switching to "+m:"Event "+h+" already in a different timeline "+m),s=m;continue}a.a.info("Already have timeline for "+h+" - joining timeline "+s+" to "+m);const g=m===this._liveTimeline,f=s===this._liveTimeline,_=o===i.a.BACKWARDS&&g,v=o===i.a.FORWARDS&&f;_||v?(_&&a.a.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+m+")"),v&&a.a.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+s+")")):(s.setNeighbouringTimeline(m,o),m.setNeighbouringTimeline(s,r),s=m,c=!0)}if(l||!c){if(o===i.a.FORWARDS&&s===this._liveTimeline)return a.a.warn({lastEventWasNew:l,didUpdate:c}),void a.a.warn(`Refusing to set forwards pagination token of live timeline ${s} to ${n}`);s.setPaginationToken(n,o)}},h.prototype.addLiveEvent=function(e,t,s){if(this._filter){if(!this._filter.filterRoomTimeline([e]).length)return}const n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){u("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=n.getEvents();for(let s=0;s<t.length;s++)if(t[s].getId()===e.getId()){i.a.setEventMetadata(e,n.getState(i.a.FORWARDS),!1),t[s].encryptedType||(t[s]=e);break}}else u("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1,s)},h.prototype.addEventToTimeline=function(e,t,s,n){const i=e.getId();t.addEvent(e,s),this._eventIdToTimeline[i]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const o={timeline:t,liveEvent:!s&&t==this._liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(s),!1,o)},h.prototype.handleRemoteEcho=function(e,t,s){const n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[s]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},h.prototype.removeEvent=function(e){const t=this._eventIdToTimeline[e];if(!t)return null;const s=t.removeEvent(e);if(s){delete this._eventIdToTimeline[e];const n={timeline:t};this.emit("Room.timeline",s,this.room,void 0,!0,n)}return s},h.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;const s=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===s)return null;if(void 0===n)return null;if(s===n){let n,i;const o=s.getEvents();for(let s=0;s<o.length&&(void 0===n||void 0===i);s++){const r=o[s].getId();r==e&&(n=s),r==t&&(i=s)}return n-i}let o=s;for(;o;){if(o===n)return-1;o=o.getNeighbouringTimeline(i.a.FORWARDS)}for(o=s;o;){if(o===n)return 1;o=o.getNeighbouringTimeline(i.a.BACKWARDS)}return null},h.prototype.getRelationsForEvent=function(e,t,s){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!s)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[s]},h.prototype.setRelationsTarget=function(e){if(!this._unstableClientRelationAggregation)return;const t=this._relations[e.getId()];if(!t)return;const s=t["m.replace"];if(!s)return;const n=s["m.room.message"];n&&n.setTargetEvent(e)},h.prototype.aggregateRelations=function(e){if(!this._unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===o.a.CANCELLED)return;if(e.isBeingDecrypted())return void e.once("Event.decrypted",()=>{this.aggregateRelations(e)});const t=e.getRelation();if(!t)return;const s=t.event_id,n=t.rel_type,i=e.getType();let r=this._relations[s];r||(r=this._relations[s]={});let a=r[n];a||(a=r[n]={});let c,l=a[i],u=!1;l||(l=a[i]=new d(n,i,this.room),u=!0,c=this.findEventById(s),c&&l.setTargetEvent(c)),l.addEvent(e),u&&c&&c.emit("Event.relationsCreated",n,i)}},function(e,t,s){"use strict";function n(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}function i(e,t,s){const n=t.split(".");let i=e;for(let e=0;e<n.length-1;e++)i[n[e]]||(i[n[e]]={}),i=i[n[e]];i[n[n.length-1]]=s}function o(e,t){this.userId=e,this.filterId=t,this.definition={}}s.d(t,"a",(function(){return o})),n.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},n.prototype._checkFields=function(e,t,s,n){const i={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const s=t.slice(0,-1);return e.substr(0,s.length)===s}return e===t}(s,e)}},o=this;for(let e=0;e<Object.keys(i).length;e++){const t=Object.keys(i)[e],s=i[t];if(o["not_"+t].filter(s).length>0)return!1;const n=o[t];if(n&&n.length>0){if(!n.some(s))return!1}}const r=this.filter_json.contains_url;return void 0===r||r===n},n.prototype.filter=function(e){return e.filter(this.check,this)},n.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10},o.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},o.prototype.getFilterId=function(){return this.filterId},o.prototype.getDefinition=function(){return this.definition},o.prototype.setDefinition=function(e){this.definition=e;const t=e.room,s={};t&&(t.rooms&&(s.rooms=t.rooms),t.rooms&&(s.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new n(s),this._room_timeline_filter=new n(t&&t.timeline||{})},o.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},o.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},o.prototype.setTimelineLimit=function(e){i(this.definition,"room.timeline.limit",e)},o.prototype.setLazyLoadMembers=function(e){i(this.definition,"room.state.lazy_load_members",!!e)},o.prototype.setIncludeLeaveRooms=function(e){i(this.definition,"room.include_leave",e)},o.fromJson=function(e,t,s){const n=new o(e,t);return n.setDefinition(s),n}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(51),c=s.n(a),l=s(176),d=s(212),u=s(131),h=s(47),m=s(53);var p,g=s(44),f=s(325),_=s(90);function v(e){switch(e){case p.Globe:return Object(g.a)("This room is public");case p.PresenceOnline:return Object(g.a)("Online");case p.PresenceAway:return Object(g.a)("Away");case p.PresenceOffline:return Object(g.a)("Offline")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE"}(p||(p={}));class y extends r.a.PureComponent{constructor(e){super(e),i()(this,"_dmUser",void 0),i()(this,"isUnmounted",!1),i()(this,"isWatchingTimeline",!1),i()(this,"onRoomTimeline",(e,t)=>{this.isUnmounted||t&&this.props.room.roomId===t.roomId&&("m.room.join_rules"!==e.getType()&&"m.room.member"!==e.getType()||this.setState({icon:this.calculateIcon()}))}),i()(this,"onPresenceUpdate",()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})}),this.state={notificationState:u.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off("Room.timeline",this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents("m.room.join_rules","");return"public"===(e&&e.getContent().join_rule)}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off("User.currentlyActive",this.onPresenceUpdate),t.off("User.presence",this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on("User.currentlyActive",this.onPresenceUpdate),this._dmUser.on("User.presence",this.onPresenceUpdate))}getPresenceIcon(){if(!this.dmUser)return p.None;let e=p.None;return this.dmUser.currentlyActive||"online"===this.dmUser.presence?e=p.PresenceOnline:"offline"===this.dmUser.presence?e=p.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=p.PresenceAway),e}calculateIcon(){let e=p.None;const t=_.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=h.a.get().baseUrl,t=m.a.get().enable_presence_by_hs_url;return!t||!(!t[e]&&void 0!==t[e])}()&&t&&(this.dmUser=h.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?p.Globe:p.None,this.isWatchingTimeline||(this.props.room.on("Room.timeline",this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&(e=r.a.createElement(d.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==p.None&&(t=r.a.createElement(f.a,{tooltip:v(this.state.icon),class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()}));const s=c()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t});return r.a.createElement("div",{className:s},r.a.createElement(l.a,{room:this.props.room,width:this.props.avatarSize,height:this.props.avatarSize,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),t,e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(10),i=s(156),o=s(0),r=s(1);function a(e,t){this.roomId=e,this.members={},this.events=new Map,this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:1}),this._oobMemberFlags=t}function c(e,t,s){const n=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],n){const s=r.z(n),i=e._displayNameToUserIds[s];if(i){const n=i.filter(e=>e!==t);e._displayNameToUserIds[s]=n}}e._userIdsToDisplayNames[t]=s;const i=s&&r.z(s);i&&(e._displayNameToUserIds[i]||(e._displayNameToUserIds[i]=[]),e._displayNameToUserIds[i].push(t))}r.o(a,n.EventEmitter),a.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this._joinedMemberCount)},a.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},a.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this._invitedMemberCount)},a.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},a.prototype.getMembers=function(){return r.B(this.members)},a.prototype.getMembersExcept=function(e){return r.B(this.members).filter(t=>!e.includes(t.userId))},a.prototype.getMember=function(e){return this.members[e]||null},a.prototype.getSentinelMember=function(e){if(!e)return null;let t=this._sentinels[e];if(void 0===t){t=new i.a(this.roomId,e);const s=this.members[e];s&&t.setMembershipEvent(s.events.member,this),this._sentinels[e]=t}return t},a.prototype.getStateEvents=function(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const s=this.events.get(e).get(t);return s||null},a.prototype.clone=function(){const e=new a(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=1,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e},a.prototype.setUnknownStateEvents=function(e){const t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)},a.prototype.setStateEvents=function(e){const t=this;this._updateModifiedTime(),r.l(e,(function(e){if(e.getRoomId()!==t.roomId)return;if(!e.isState())return;const s=t._getStateEventMatching(e);t._setStateEvent(e),"m.room.member"===e.getType()&&(c(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;const s=(t.getContent().third_party_invite.signed||{}).token;if(!s)return;if(!e.getStateEvents("m.room.third_party_invite",s))return;e._tokenToInvite[s]=t}(t,e)),t.emit("RoomState.events",e,t,s)})),r.l(e,(function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){const s=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=t._getOrCreateMember(s,e);n.setMembershipEvent(e,t),t._updateMember(n),t.emit("RoomState.members",e,t,n)}else if("m.room.power_levels"===e.getType()){const s=r.B(t.members);r.l(s,(function(s){s.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,s)})),t._sentinels={}}}))},a.prototype._getOrCreateMember=function(e,t){let s=this.members[e];return s||(s=new i.a(this.roomId,e),this.members[e]=s,this.emit("RoomState.newMember",t,this,s)),s},a.prototype._setStateEvent=function(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)},a.prototype._getStateEventMatching=function(e){return this.events.has(e.getType())?this.events.get(e.getType()).get(e.getStateKey()):null},a.prototype._updateMember=function(e){const t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},a.prototype.needsOutOfBandMembers=function(){return 1===this._oobMemberFlags.status},a.prototype.markOutOfBandMembersStarted=function(){1===this._oobMemberFlags.status&&(this._oobMemberFlags.status=2)},a.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=1)},a.prototype.clearOutOfBandMembers=function(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),o.a.log(`LL: RoomState removed ${e} members...`),this._oobMemberFlags.status=1},a.prototype.setOutOfBandMembers=function(e){o.a.log(`LL: RoomState about to set ${e.length} OOB members ...`),2===this._oobMemberFlags.status&&(o.a.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach(e=>this._setOutOfBandMember(e)))},a.prototype._setOutOfBandMember=function(e){if("m.room.member"!==e.getType())return;const t=e.getStateKey(),s=this.getMember(t);if(s&&!s.isOutOfBand())return;const n=this._getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),c(this,n.userId,n.name),this._setStateEvent(e),this._updateMember(n),this.emit("RoomState.members",e,this,n)},a.prototype.setTypingEvent=function(e){r.l(r.B(this.members),(function(t){t.setTypingEvent(e)}))},a.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},a.prototype._updateModifiedTime=function(){this._modified=Date.now()},a.prototype.getLastModifiedTime=function(){return this._modified},a.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[r.z(e)]||[]},a.prototype.maySendRedactionForEvent=function(e,t){const s=this.getMember(t);if(!s||"leave"===s.membership)return!1;if(e.status||e.isRedacted())return!1;const n=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?n:this._hasSufficientPowerLevelFor("redact",s.powerLevel)},a.prototype._hasSufficientPowerLevelFor=function(e,t){const s=this.getStateEvents("m.room.power_levels","");let n={};s&&(n=s.getContent());let i=50;return r.s(n[e])&&(i=n[e]),t>=i},a.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},a.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},a.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},a.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},a.prototype._maySendEventOfType=function(e,t,s){const n=this.getStateEvents("m.room.power_levels","");let i,o={},r=0,a=0,c=0;if(n){i=n.getContent(),o=i.events||{},r=Number.isFinite(i.state_default)?i.state_default:50;const e=i.users&&i.users[t];Number.isFinite(e)?c=e:Number.isFinite(i.users_default)&&(c=i.users_default),Number.isFinite(i.events_default)&&(a=i.events_default)}let l=s?r:a;return Number.isFinite(o[e])&&(l=o[e]),c>=l},a.prototype.mayTriggerNotifOfType=function(e,t){const s=this.getMember(t);if(!s)return!1;const n=this.getStateEvents("m.room.power_levels","");let i=50;return n&&n.getContent()&&n.getContent().notifications&&r.s(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),s.powerLevel>=i}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(1);s(0);function i(e,t){this.retryAlgorithm=e||i.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||i.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function o(e){e._procFn&&n.l(n.j(n.t(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),a("Spinning up queue: '%s'",t),function e(t,s){const i=function(e,t){const s=e._queues[t];if(!n.p(s))return null;return s[0]}(t,s);if(!i){const e=t._activeQueues.indexOf(s);return e>=0&&t._activeQueues.splice(e,1),void a("Stopping queue '%s' as it is now empty",s)}a("Queue '%s' has %s pending events",s,t._queues[s].length),Promise.resolve().then(()=>t._procFn(i.event)).then((function(n){r(t,s),a("Queue '%s' sent event %s",s,i.event.getId()),i.defer.resolve(n),e(t,s)}),(function(n){i.attempts+=1;const o=t.retryAlgorithm(i.event,i.attempts,n);a("retry(%s) err=%s event_id=%s waitTime=%s",i.attempts,n,i.event.getId(),o),-1===o?(a("Queue '%s' giving up on event %s",s,i.event.getId()),r(t,s),i.defer.reject(n),e(t,s)):setTimeout((function(){e(t,s)}),o)}))}(e,t)}))}function r(e,t){const s=e._queues[t];return n.p(s)?s.shift():null}function a(){0}i.prototype.getQueueForEvent=function(e){const t=this.queueAlgorithm(e);return t&&this._queues[t]?n.u(this._queues[t],(function(e){return e.event})):null},i.prototype.removeEventFromQueue=function(e){const t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;let s=!1;return n.y(this._queues[t],(function(t){if(t.event.getId()===e.getId())return s=!0,!0})),s},i.prototype.setProcessFunction=function(e){this._procFn=e,o(this)},i.prototype.queueEvent=function(e){const t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);const s=n.d();return this._queues[t].push({event:e,defer:s,attempts:0}),a("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),o(this),s.promise},i.RETRY_BACKOFF_RATELIMIT=function(e,t,s){if(400===s.httpStatus||403===s.httpStatus||401===s.httpStatus)return-1;if("rejected"===s.cors)return-1;if("M_TOO_LARGE"===s.name)return-1;if("M_LIMIT_EXCEEDED"===s.name){const e=s.data.retry_after_ms;if(e)return e}return t>4?-1:1e3*Math.pow(2,t)},i.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const n=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"})},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this.target=e,this.boundHandlers={}}_handleEvent(e,...t){this.target.emit(e,...t)}reEmit(e,t){const s=(t,...s)=>{t(...s,e)};for(const n of t){void 0===this.boundHandlers[n]&&(this.boundHandlers[n]=this._handleEvent.bind(this,n));const t=s.bind(this,this.boundHandlers[n]);e.on(n,t)}}}},,function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(1),i=s(85);const o="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,r=new Uint8Array(8);function a(t,s){const i=Object(n.m)(),o=i.createHmac("sha256",r).update(t).digest(),a=e.alloc(1,1),c=i.createHmac("sha256",o).update(s,"utf-8").update(a).digest();a[0]=2;return[c,i.createHmac("sha256",o).update(c).update(s,"utf-8").update(a).digest()]}async function c(e,t){const s=await o.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await o.deriveBits({name:"HKDF",salt:r,info:(new TextEncoder).encode(t),hash:"SHA-256"},s,512),i=n.slice(0,32),a=n.slice(32),c=o.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=o.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return await Promise.all([c,l])}function l(...e){return o?async function(e,t,s,n){let r;n?r=Object(i.decodeBase64)(n):(r=new Uint8Array(16),window.crypto.getRandomValues(r)),r[8]&=127;const[a,l]=await c(t,s),d=(new TextEncoder).encode(e),u=await o.encrypt({name:"AES-CTR",counter:r,length:64},a,d),h=await o.sign({name:"HMAC"},l,u);return{iv:Object(i.encodeBase64)(r),ciphertext:Object(i.encodeBase64)(u),mac:Object(i.encodeBase64)(h)}}(...e):async function(e,t,s,o){const r=Object(n.m)();if(!r)throw new Error("No usable crypto implementation");let c;c=o?Object(i.decodeBase64)(o):r.randomBytes(16),c[8]&=127;const[l,d]=a(t,s),u=r.createCipheriv("aes-256-ctr",l,c),h=u.update(e,"utf-8","base64")+u.final("base64"),m=r.createHmac("sha256",d).update(h,"base64").digest("base64");return{iv:Object(i.encodeBase64)(c),ciphertext:h,mac:m}}(...e)}function d(...e){return o?async function(e,t,s){const[n,r]=await c(t,s),a=Object(i.decodeBase64)(e.ciphertext);if(!await o.verify({name:"HMAC"},r,Object(i.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${s}: bad MAC`);const l=await o.decrypt({name:"AES-CTR",counter:Object(i.decodeBase64)(e.iv),length:64},n,a);return(new TextDecoder).decode(new Uint8Array(l))}(...e):async function(e,t,s){const o=Object(n.m)();if(!o)throw new Error("No usable crypto implementation");const[r,c]=a(t,s);if(o.createHmac("sha256",c).update(e.ciphertext,"base64").digest("base64").replace(/=+$/g,"")!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${s}: bad MAC`);const l=o.createDecipheriv("aes-256-ctr",r,Object(i.decodeBase64)(e.iv));return l.update(e.ciphertext,"base64","utf-8")+l.final("utf-8")}(...e)}}).call(this,s(22).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(81),i=s(10),o=s(0),r=s(228),a=s(194),c=s(229);const l=new Error("Verification timed out");class d extends Error{constructor(e){super(),this.startEvent=e}}class u extends i.EventEmitter{constructor(e,t,s,n,i,o){super(),this._channel=e,this._baseApis=t,this.userId=s,this.deviceId=n,this.startEvent=i,this.request=o,this.cancelled=!1,this._done=!1,this._promise=null,this._transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}_resetTimer(){o.a.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(o.a.info("Triggering verification timeout"),this.cancel(l))},6e5)}_endTimer(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}_send(e,t){return this._channel.send(e,t)}_waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this._expectedEvent=e,new Promise((e,t)=>{this._resolveEvent=e,this._rejectEvent=t}))}canSwitchStartEvent(){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(o.a.log("Verification Base: switching verification start event",{restartingFlow:!!this._rejectEvent}),this._rejectEvent){const t=this._rejectEvent;this._rejectEvent=void 0,t(new d(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this._reject;if(this._reject=void 0,t){const s=e.getContent(),{reason:n,code:i}=s;t(new Error(`Other side cancelled verification because ${n} (${i})`))}}else if(this._expectedEvent){const t=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){const e=this._rejectEvent;this._rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this._endTimer(),!this._done)return this.request.onVerifierFinished(),this._resolve(),Object(c.e)(this._baseApis,this.userId,this.deviceId)}cancel(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===l){const e=Object(a.e)();this._send(e.getType(),e.getContent())}else if(e instanceof n.b){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this._send("m.key.verification.cancel",t)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this._promise||(this._promise=new Promise((e,t)=>{this._resolve=(...t)=>{this._done=!0,this._endTimer(),e(...t)},this._reject=(...e)=>{this._done=!0,this._endTimer(),t(...e)}}),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this._promise}async _verifyKeys(e,t,s){const n=[];for(const[i,a]of Object.entries(t)){const t=i.split(":",2)[1],c=this._baseApis.getStoredDevice(e,t);if(c)await s(i,c,a),n.push(t);else{const c=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(await s(i,r.a.fromStorage({keys:{[i]:t}},t),a),n.push(t)):o.a.warn(`verification: Could not find device ${t} to verify`)}}if(!n.length)throw new Error("No devices could be verified");o.a.info("Verification completed! Marking devices verified: ",n);for(const t of n)await this._baseApis.setDeviceVerified(e,t)}}},function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return i})),s.d(t,"c",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(12);async function i(t,s){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await r(s,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)}async function o(t){if(!e.Olm)throw new Error("Olm is not available");const s=Object(n.a)(32);return{key:await r(t,s,5e5,256),salt:s,iterations:5e5}}async function r(t,s,n,i=256){const o=e.crypto.subtle,r=e.TextEncoder;if(!o||!r)throw new Error("Password-based backup is not avaiable on this platform");const a=await o.importKey("raw",(new r).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await o.deriveBits({name:"PBKDF2",salt:(new r).encode(s),iterations:n,hash:"SHA-512"},a,i);return new Uint8Array(c)}}).call(this,s(6))},function(e,t,s){"use strict";(function(e,n){s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return c}));var i=s(584),o=s.n(i);const r=[139,1];function a(t){const s=new e(r.length+t.length+1);s.set(r,0),s.set(t,r.length);let n=0;for(let e=0;e<s.length-1;++e)n^=s[e];s[s.length-1]=n;return o.a.encode(s).match(/.{1,4}/g).join(" ")}function c(e){const t=o.a.decode(e.replace(/ /g,""));let s=0;for(const e of t)s^=e;if(0!==s)throw new Error("Incorrect parity");for(let e=0;e<r.length;++e)if(t[e]!==r[e])throw new Error("Incorrect prefix");if(t.length!==r.length+n.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(r.length,r.length+n.Olm.PRIVATE_KEY_LENGTH))}}).call(this,s(22).Buffer,s(6))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(2),i=s.n(n);class o{get action(){return"NOT_USED"}constructor(e){i()(this,"fn",void 0),this.fn=e}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var n=s(55),i=s(372),o=s(72);const r=window.localStorage;let a;try{a=window.indexedDB}catch(e){}function c(e){console.log("StorageManager: "+e)}function l(e){console.error("StorageManager: "+e)}function d(e){o.a.trackEvent("StorageManager",e)}function u(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then(e=>{console.log("StorageManager: Persistent?",e)}):document.requestStorageAccess?document.requestStorageAccess().then(()=>console.log("StorageManager: Persistent?",!0),()=>console.log("StorageManager: Persistent?",!1)):console.log("StorageManager: Persistence unsupported")}async function h(){c("Checking storage consistency"),c("Local storage supported? "+!!r),c("IndexedDB supported? "+!!a);let e=!1,t=!1,s=!1,o=!0;if(r?(e=r.length>0,c("Local storage contains data? "+e),s=r.getItem("mx_crypto_initialised"),c("Crypto initialised? "+s)):(o=!1,l("Local storage cannot be used on this browser"),d("Local storage disabled")),a&&r){(await async function(){let e=!1;try{return e=await n.r.IndexedDBStore.exists(a,"riot-web-sync"),c("Sync store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){l("Sync store using IndexedDB inaccessible"),d("Sync store using IndexedDB inaccessible")}return c("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(o=!1)}else o=!1,l("Sync store cannot be used on this browser"),d("Sync store disabled");if(a){const e=await async function(){let e=!1;try{return e=await n.r.IndexedDBCryptoStore.exists(a,"matrix-js-sdk:crypto"),c("Crypto store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){l("Crypto store using IndexedDB inaccessible"),d("Crypto store using IndexedDB inaccessible")}try{return e=await i.a.exists(r),c("Crypto store using local storage contains data? "+e),{exists:e,healthy:!0}}catch(e){l("Crypto store using local storage inaccessible"),d("Crypto store using local storage inaccessible")}return c("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(o=!1)}else o=!1,l("Crypto store cannot be used on this browser"),d("Crypto store disabled");return e&&s&&!t&&(o=!1,l("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!"),d("Crypto store evicted")),o?(c("Storage consistency checks passed"),d("Consistency checks passed")):(l("Storage consistency checks failed"),d("Consistency checks failed")),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:s,healthy:o}}function m(e){e.store&&e.store.on&&e.store.on("degraded",()=>{d("Sync store using IndexedDB degraded to memory")})}},function(e,t,s){"use strict";function n(e){const t=e.embeddedPages;let s=null;return t&&(s=t.homeUrl),s||(s=e.welcomePageUrl),s}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(280);function i(e,t,s){return new n.a(n=>{n({action:e+".pending",request:"function"==typeof s?s():void 0}),t().then(t=>{n({action:e+".success",result:t})}).catch(t=>{n({action:e+".failure",err:t})})})}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(2),i=s.n(n);class o{forEvent(e,t,s){throw new Error("Not implemented")}forRoom(e,t){throw new Error("Not implemented")}forGroup(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class r{constructor(e,t,s,n,o){i()(this,"roomIdOrAlias",void 0),i()(this,"eventId",void 0),i()(this,"userId",void 0),i()(this,"groupId",void 0),i()(this,"viaServers",void 0),this.roomIdOrAlias=e,this.eventId=t,this.groupId=n,this.userId=s,this.viaServers=o}static forUser(e){return new r(null,null,e,null,null)}static forGroup(e){return new r(null,null,null,e,null)}static forRoom(e,t){return new r(e,null,null,null,t||[])}static forEvent(e,t,s){return new r(e,t,null,null,s||[])}}},function(e,t,s){"use strict";var n=s(435),i=s(65);function o(e){const t=e.scanner.TOKENS,s=e.parser.TOKENS.Base,n=e.parser.start;if(void 0===t.UNDERSCORE)throw new Error("linkify-matrix requires linkifyjs 2.1.1: this version is too old.");const i=function(e){s.call(this,e),this.type="roomalias",this.isLink=!0};i.prototype=new s;const o=n.jump(t.POUND),r=new e.parser.State,a=new e.parser.State,c=new e.parser.State(i),l=new e.parser.State,d=new e.parser.State(i),u=new e.parser.State,h=new e.parser.State(i),m=[t.DOT,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.UNDERSCORE,t.POUND,t.LOCALHOST];o.on(m,r),r.on(m,r),r.on(t.DOMAIN,r),r.on(t.COLON,a),a.on(t.DOMAIN,c),a.on(t.LOCALHOST,d),a.on(t.TLD,d),c.on(t.DOT,l),l.on(t.DOMAIN,c),l.on(t.TLD,d),d.on(t.DOT,l),d.on(t.COLON,u),u.on(t.NUM,h);const p=function(e){s.call(this,e),this.type="userid",this.isLink=!0};p.prototype=new s;const g=n.jump(t.AT),f=new e.parser.State,_=new e.parser.State,v=new e.parser.State(p),y=new e.parser.State,b=new e.parser.State(p),E=new e.parser.State,S=new e.parser.State(p),w=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];g.on(w,f),f.on(w,f),f.on(t.DOMAIN,f),f.on(t.COLON,_),_.on(t.DOMAIN,v),_.on(t.LOCALHOST,b),_.on(t.TLD,b),v.on(t.DOT,y),y.on(t.DOMAIN,v),y.on(t.TLD,b),b.on(t.DOT,y),b.on(t.COLON,E),E.on(t.NUM,S);const C=function(e){s.call(this,e),this.type="groupid",this.isLink=!0};C.prototype=new s;const R=n.jump(t.PLUS),k=new e.parser.State,I=new e.parser.State,O=new e.parser.State(C),T=new e.parser.State,x=new e.parser.State(C),N=new e.parser.State,j=new e.parser.State(C),P=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];R.on(P,k),k.on(P,k),k.on(t.DOMAIN,k),k.on(t.COLON,I),I.on(t.DOMAIN,O),I.on(t.LOCALHOST,x),I.on(t.TLD,x),O.on(t.DOT,T),T.on(t.DOMAIN,O),T.on(t.TLD,x),x.on(t.DOT,T),x.on(t.COLON,N),N.on(t.NUM,j)}o.onUserClick=function(e,t){e.preventDefault()},o.onAliasClick=function(e,t){e.preventDefault()},o.onGroupClick=function(e,t){e.preventDefault()};o.VECTOR_URL_PATTERN="^(?:https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?(?:riot|vector)\\.im/(?:app|beta|staging|develop)/)(#.*)"),o.MATRIXTO_URL_PATTERN="^(?:https?://)?(?:www\\.)?matrix\\.to/#/(([#@!+]).*)",o.MATRIXTO_MD_LINK_PATTERN="\\[([^\\]]*)\\]\\((?:https?://)?(?:www\\.)?matrix\\.to/#/([#@!+][^\\)]*)\\)",o.MATRIXTO_BASE_URL=n.a,o.options={events:function(e,t){switch(t){case"url":try{const t=Object(i.h)(e);if(t&&t.userId)return{click:function(e){o.onUserClick(e,t.userId)}}}catch(e){}break;case"userid":return{click:function(t){o.onUserClick(t,e)}};case"roomalias":return{click:function(t){o.onAliasClick(t,e)}};case"groupid":return{click:function(t){o.onGroupClick(t,e)}}}},formatHref:function(e,t){switch(t){case"roomalias":case"userid":case"groupid":default:return Object(i.i)(e)}},linkAttributes:{rel:"noreferrer noopener"},target:function(e,t){if("url"===t){return Object(i.j)(e)!==e||e.match(o.VECTOR_URL_PATTERN)?null:"_blank"}return null}},t.a=o},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(2),i=s.n(n),o=s(53),r=s(47);class a{constructor(){i()(this,"domain",void 0),i()(this,"update",async e=>{let t=(o.a.get().jitsi||{}).preferredDomain||"jitsi.riot.im";if(console.log("Attempting to get Jitsi conference information from homeserver"),e&&e["im.vector.riot.jitsi"]){const s=e["im.vector.riot.jitsi"].preferredDomain;s&&(t=s)}this.domain=t,console.log("Jitsi conference domain:",this.preferredDomain)})}get preferredDomain(){return this.domain||"jitsi.riot.im"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=r.a.get();e.on("WellKnown.client",this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname,domain:t.hostname,isAudioOnly:!1}}static getInstance(){return a.instance||(a.instance=new a),a.instance}}i()(a,"instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(44);function i(e){return{undefined:Object(n.a)("Default"),0:Object(n.a)("Restricted"),[e]:Object(n.a)("Default"),50:Object(n.a)("Moderator"),100:Object(n.a)("Admin")}}function o(e,t){const s=i(t);return s[e]?s[e]:Object(n.a)("Custom (%(level)s)",{level:e})}},,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return I})),s.d(t,"b",(function(){return O}));var n=s(2),i=s.n(n),o=s(43),r=s(51),a=s.n(r),c=s(132),l=s(44),d=s(52),u=s(454),h=s(61),m=s(89),p=s(169),g=s(71),f=s(48),_=s(212),v=s(68),y=s(58),b=s(327),E=s(818),S=s(131),w=s(552),C=s(3),R=s(11),k=s(213);const I=32;Object(E.a)();class O extends o.Component{constructor(t){super(t),i()(this,"headerButton",Object(o.createRef)()),i()(this,"sublistRef",Object(o.createRef)()),i()(this,"dispatcherRef",void 0),i()(this,"layout",void 0),i()(this,"heightAtStart",void 0),i()(this,"isBeingFiltered",void 0),i()(this,"notificationState",void 0),i()(this,"onListsUpdated",()=>{const e={};if(this.props.extraBadTilesThatShouldntExist){const t=m.b.instance.getFirstNameFilterCondition();t?e.filteredExtraTiles=this.props.extraBadTilesThatShouldntExist.filter(e=>t.matches(e.props.displayName||"")):this.state.filteredExtraTiles&&(e.filteredExtraTiles=null)}const t=this.state.rooms,s=Object(C.c)(m.b.instance.orderedLists[this.props.tagId]||[]);Object(C.e)(t,s)&&(e.rooms=s);const n=!!m.b.instance.getFirstNameFilterCondition();n!==this.isBeingFiltered&&(this.isBeingFiltered=n,e.isExpanded=!!n||!this.layout.isCollapsed),Object.keys(e).length>0&&this.setState(e)}),i()(this,"onAction",t=>{"view_room"===t.action&&t.show_room_tile&&this.state.rooms&&e(()=>{const e=this.state.rooms.findIndex(e=>e.roomId===t.room_id);!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())})}),i()(this,"onAddRoom",e=>{e.stopPropagation(),this.props.onAddRoom&&this.props.onAddRoom()}),i()(this,"onResize",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({height:i})}),i()(this,"onResizeStart",()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})}),i()(this,"onResizeStop",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({isResizing:!1,height:i})}),i()(this,"onShowAllClick",()=>{const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},()=>{this.focusRoomTile(e)})}),i()(this,"onShowLessClick",()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})}),i()(this,"focusRoomTile",e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),s=t&&t[e];s&&s.focus()}),i()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),i()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})}),i()(this,"onAddRoomContextMenu",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({addRoomContextMenuPosition:t.getBoundingClientRect()})}),i()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),i()(this,"onCloseAddRoomMenu",()=>{this.setState({addRoomContextMenuPosition:null})}),i()(this,"onUnreadFirstChanged",async()=>{const e=m.b.instance.getListOrder(this.props.tagId)===p.a.Importance?p.a.Natural:p.a.Importance;await m.b.instance.setListOrder(this.props.tagId,e)}),i()(this,"onTagSortChanged",async e=>{await m.b.instance.setTagSorting(this.props.tagId,e)}),i()(this,"onMessagePreviewChanged",()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()}),i()(this,"onBadgeClick",e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===g.a.Invite?this.state.rooms&&this.state.rooms[0]:this.state.rooms.find(e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color}),t&&f.a.dispatch({action:"view_room",room_id:t.roomId,show_room_tile:!0})}),i()(this,"onHeaderClick",()=>{const t=this.headerButton.current.parentElement,s=t.parentElement.parentElement,n=s.parentElement.parentElement,i=n.scrollTop<=I,o=n.scrollTop>=n.scrollHeight-n.offsetHeight,r=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),a=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(a&&!o||r&&!i)s.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&a&&e(()=>{s.scrollIntoView({behavior:"smooth"})})}}),i()(this,"toggleCollapsed",()=>{this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),e(()=>this.props.onResize())}),i()(this,"onHeaderKeyDown",e=>{switch(e.key){case y.a.ARROW_LEFT:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case y.a.ARROW_RIGHT:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}}),i()(this,"onKeyDown",e=>{switch(e.key){case y.a.ARROW_LEFT:e.stopPropagation(),this.headerButton.current.focus();break;case y.a.ARROW_RIGHT:e.stopPropagation()}}),this.layout=w.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.isBeingFiltered=!!m.b.instance.getFirstNameFilterCondition(),this.notificationState=S.a.instance.getListState(this.props.tagId),this.state={contextMenuPosition:null,addRoomContextMenuPosition:null,isResizing:!1,isExpanded:this.isBeingFiltered?this.isBeingFiltered:!this.layout.isCollapsed,height:0,rooms:Object(C.c)(m.b.instance.orderedLists[this.props.tagId]||[])},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()}),this.dispatcherRef=f.a.register(this.onAction),m.b.instance.on(m.a,this.onListsUpdated)}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,s=this.numTiles>this.layout.defaultVisibleTiles;return(t||s)&&(e+=28),e}get extraTiles(){return this.state.filteredExtraTiles?this.state.filteredExtraTiles:this.props.extraBadTilesThatShouldntExist?this.props.extraBadTilesThatShouldntExist:null}get numTiles(){return O.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,t){const s=t.filteredExtraTiles||e.extraBadTilesThatShouldntExist;O.calcNumTiles(t.rooms,s)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,t){if(Object(R.c)(this.props,e))return!0;const s=Object(R.b)(this.state,["rooms"]),n=Object(R.b)(t,["rooms"]);if(Object(R.c)(s,n))return!0;const i=this.props.extraBadTilesThatShouldntExist||[],o=t.filteredExtraTiles||e.extraBadTilesThatShouldntExist||[];if(i.length>0||o.length>0)return!0;if(O.calcNumTiles(t.rooms,o)!==this.numTiles)return!0;if(!t.isExpanded)return!1;if(this.state.rooms.length!==t.rooms.length)return!0;const r=this.state.rooms.slice(0,this.numVisibleTiles),a=t.rooms.slice(0,this.numVisibleTiles);return!!Object(C.e)(r,a)}componentWillUnmount(){f.a.unregister(this.dispatcherRef),m.b.instance.off(m.a,this.onListsUpdated)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded)return[];const e=[];if(this.state.rooms){const t=this.state.rooms.slice(0,this.numVisibleTiles);for(const s of t)e.push(o.createElement(u.a,{room:s,key:"room-"+s.roomId,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles?e.slice(0,this.numVisibleTiles):e}renderMenu(){let e=null;if(this.state.contextMenuPosition){const t=m.b.instance.getTagSorting(this.props.tagId)===p.b.Alphabetic,s=m.b.instance.getListOrder(this.props.tagId)===p.a.Importance;let n=null;this.props.tagId!==g.a.Invite&&(n=o.createElement(o.Fragment,null,o.createElement("hr",null),o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(l.a)("Appearance")),o.createElement(h.i,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:s},Object(l.a)("Show rooms with unread messages first")),o.createElement(h.i,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(l.a)("Show previews of messages"))))),e=o.createElement(h.b,{chevronFace:h.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},o.createElement("div",{className:"mx_RoomSublist_contextMenu"},o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(l.a)("Sort by")),o.createElement(h.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(p.b.Recent),checked:!t,name:`mx_${this.props.tagId}_sortBy`},Object(l.a)("Activity")),o.createElement(h.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(p.b.Alphabetic),checked:t,name:`mx_${this.props.tagId}_sortBy`},Object(l.a)("A-Z"))),n))}else this.state.addRoomContextMenuPosition&&(e=o.createElement(k.e,{chevronFace:h.a.None,left:this.state.addRoomContextMenuPosition.left-7,top:this.state.addRoomContextMenuPosition.top+this.state.addRoomContextMenuPosition.height,onFinished:this.onCloseAddRoomMenu,compact:!0},this.props.addRoomContextMenu(this.onCloseAddRoomMenu)));return o.createElement(o.Fragment,null,o.createElement(h.d,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(l.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return o.createElement(c.d,{inputRef:this.headerButton},({onFocus:e,isActive:t,ref:s})=>{const n=t?0:-1;let i=Object(l.a)("Jump to first unread room.");this.props.tagId===g.a.Invite&&(i=Object(l.a)("Jump to first invite."));const r=o.createElement(_.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:n,"aria-label":i});let c=null;this.props.onAddRoom?c=o.createElement(v.a,{tabIndex:n,onClick:this.onAddRoom,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(l.a)("Add room"),title:this.props.addRoomLabel}):this.props.addRoomContextMenu&&(c=o.createElement(h.d,{tabIndex:n,onClick:this.onAddRoomContextMenu,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(l.a)("Add room"),title:this.props.addRoomLabel,isExpanded:!!this.state.addRoomContextMenuPosition}));const u=a()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded}),m=a()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!c}),p=o.createElement("div",{className:"mx_RoomSublist_badgeContainer"},r);let f=d.a;return this.props.isMinimized&&(f=v.a),o.createElement("div",{className:m,onKeyDown:this.onHeaderKeyDown,onFocus:e,"aria-label":this.props.label},o.createElement("div",{className:"mx_RoomSublist_stickable"},o.createElement(f,{onFocus:e,inputRef:s,tabIndex:n,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},o.createElement("span",{className:u}),o.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:p,this.props.isMinimized?null:c),this.props.isMinimized?p:null,this.props.isMinimized?c:null)})}onScrollPrevent(e){e.target.scrollTop=0}render(){const e=this.renderVisibleTiles(),t=a()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized});let s=null;if(e.length>0){const t=this.layout,n=Math.min(t.minVisibleTiles,this.numTiles),i=4+(n<this.numTiles?28:0),r=t.tilesToPixelsWithPadding(n,i),d=t.tilesToPixelsWithPadding(this.numTiles,this.padding),u=a()({mx_RoomSublist_showNButton:!0});let h=null;if(d>this.state.height){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight),s=this.numTiles-t,n=Object(l.a)("Show %(count)s more",{count:s});let i=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},n);this.props.isMinimized&&(i=null),h=o.createElement(c.a,{role:"treeitem",onClick:this.onShowAllClick,className:u,"aria-label":n},o.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),i)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(l.a)("Show less");let t=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),h=o.createElement(c.a,{role:"treeitem",onClick:this.onShowLessClick,className:u,"aria-label":e},o.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const m={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};t.visibleTiles>=this.numTiles&&this.numTiles<=t.minVisibleTiles&&(m.bottom=!1);const p=a()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!h});s=o.createElement(o.Fragment,null,o.createElement(b.Resizable,{size:{height:this.state.height},minHeight:r,maxHeight:d,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:p,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:m},o.createElement("div",{className:"mx_RoomSublist_tiles",onScroll:this.onScrollPrevent},e),h))}return o.createElement("div",{ref:this.sublistRef,className:t,role:"group","aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),s)}}}).call(this,s(136).setImmediate)},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46);class d extends r.a.Component{constructor(){super(),i()(this,"onMouseOver",()=>{this.setState({hover:!0})}),i()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=l.getComponent("elements.Tooltip");return r.a.createElement("span",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:this.props.class},this.props.children,this.state.hover&&r.a.createElement(e,{label:this.props.tooltip,tooltipClassName:this.props.tooltipClass,className:"mx_TextWithTooltip_tooltip"}))}}i()(d,"propTypes",{class:c.a.string,tooltipClass:c.a.string,tooltip:c.a.node.isRequired})},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return a}));var n=s(2),i=s.n(n),o=s(462);let r;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(r||(r={}));class a extends o.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,i()(this,"_status",r.Pending),i()(this,"didFail",!1),i()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===r.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(r.Pending),this.runFn().then(()=>this.setStatus(r.Success)).catch(()=>this.setStatus(r.Error))}cancel(){this.setStatus(r.Success)}setStatus(e){this._status=e,e===r.Error?this.didFail=!0:e===r.Success&&(this.didFail=!1),this.notifyCondition(e)}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(60),i=s.n(n),o=s(43),r=s.n(o),a=s(52);function c(e){const{className:t,label:s,kind:n}=e,o=i()(e,["className","label","kind"]),c=(t||"")+" mx_FormButton",l=Object.assign({},o,{className:c,kind:n||"primary",children:[s]});return r.a.createElement(a.a,l)}c.propTypes=a.a.propTypes},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(47),r=s(252),a=s(50),c=s(44),l=s(48),d=s(57);class u{constructor(){i()(this,"_lists",[]),i()(this,"_roomIds",[]),i()(this,"_mjolnirWatchRef",null),i()(this,"_dispatcherRef",null),i()(this,"_onAction",e=>{"setup_mjolnir"===e.action&&(console.log("Setting up Mjolnir: after sync"),this.setup())}),i()(this,"_onEvent",e=>{o.a.get()&&this._roomIds.includes(e.getRoomId())&&r.a.includes(e.getType())&&this._updateLists(this._roomIds)})}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this._mjolnirWatchRef=a.a.watchSetting("mjolnirRooms",null,this._onListsChanged.bind(this)),this._dispatcherRef=l.a.register(this._onAction),l.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"setup_mjolnir"}})}setup(){o.a.get()&&(this._updateLists(a.a.getValue("mjolnirRooms")),o.a.get().on("RoomState.events",this._onEvent))}stop(){this._mjolnirWatchRef&&(a.a.unwatchSetting(this._mjolnirWatchRef),this._mjolnirWatchRef=null),this._dispatcherRef&&(l.a.unregister(this._dispatcherRef),this._dispatcherRef=null),o.a.get()&&o.a.get().removeListener("RoomState.events",this._onEvent)}async getOrCreatePersonalList(){let e=a.a.getValue("mjolnirPersonalRoom");if(!e){const t=await o.a.get().createRoom({name:Object(c.a)("My Ban List"),topic:Object(c.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:"private_chat"});e=t.room_id,await a.a.setValue("mjolnirPersonalRoom",null,d.a.ACCOUNT,e),await a.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find(t=>t.roomId===e);return t||(t=new r.b(e)),t}getPersonalList(){const e=a.a.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find(t=>t.roomId===e);return t||(t=new r.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await a.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists.push(new r.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter(t=>t!==e);await a.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists=this._lists.filter(t=>t.roomId!==e)}_onListsChanged(e,t,s,n){this._updateLists(n)}_updateLists(e){if(o.a.get()&&(console.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new r.b(t))}isServerBanned(e){for(const t of this._lists)for(const s of t.serverRules)if(s.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const s of t.userRules)if(s.isMatch(e))return!0;return!1}static sharedInstance(){return u._instance||(u._instance=new u),u._instance}}i()(u,"_instance",null)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(53),u=s(47),h=s(46),m=s(332);class p extends r.a.Component{constructor(){super(),i()(this,"_onStoreUpdate",()=>{const e=m.f.sharedInstance();e.phase!==m.d?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}):this.props.onFinished()}),i()(this,"_onUsePassphraseClick",async()=>{m.f.sharedInstance().usePassPhrase()}),i()(this,"onSkipClick",()=>{m.f.sharedInstance().skip()}),i()(this,"onSkipConfirmClick",()=>{m.f.sharedInstance().skipConfirm()}),i()(this,"onSkipBackClick",()=>{m.f.sharedInstance().returnAfterSkip()}),i()(this,"onDoneClick",()=>{m.f.sharedInstance().done()});const e=m.f.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}}componentWillUnmount(){const e=m.f.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=h.getComponent("elements.AccessibleButton"),{phase:t}=this.state;if(this.state.verificationRequest){const e=h.getComponent("views.right_panel.EncryptionPanel");return r.a.createElement(e,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.props.onFinished,member:u.a.get().getUser(this.state.verificationRequest.otherUserId)})}if(t===m.e){const t=m.f.sharedInstance();let n,i;t.keyInfo&&((s=t.keyInfo).passphrase&&s.passphrase.salt&&s.passphrase.iterations)?n=Object(l.a)("Use Recovery Key or Passphrase"):t.keyInfo&&(n=Object(l.a)("Use Recovery Key")),n&&(i=r.a.createElement(e,{kind:"link",onClick:this._onUsePassphraseClick},n));const o=d.a.get().brand;return r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("Confirm your identity by verifying this login from one of your other sessions, granting it access to encrypted messages.")),r.a.createElement("p",null,Object(l.a)("This requires the latest %(brand)s on your other devices:",{brand:o})),r.a.createElement("div",{className:"mx_CompleteSecurity_clients"},r.a.createElement("div",{className:"mx_CompleteSecurity_clients_desktop"},r.a.createElement("div",null,Object(l.a)("%(brand)s Web",{brand:o})),r.a.createElement("div",null,Object(l.a)("%(brand)s Desktop",{brand:o}))),r.a.createElement("div",{className:"mx_CompleteSecurity_clients_mobile"},r.a.createElement("div",null,Object(l.a)("%(brand)s iOS",{brand:o})),r.a.createElement("div",null,Object(l.a)("%(brand)s Android",{brand:o}))),r.a.createElement("p",null,Object(l.a)("or another cross-signing capable Matrix client"))),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i,r.a.createElement(e,{kind:"danger",onClick:this.onSkipClick},Object(l.a)("Skip"))))}if(t===m.c){let t;return t=this.state.backupInfo?r.a.createElement("p",null,Object(l.a)("Your new session is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):r.a.createElement("p",null,Object(l.a)("Your new session is now verified. Other users will see it as trusted.")),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),t,r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(e,{kind:"primary",onClick:this.onDoneClick},Object(l.a)("Done"))))}if(t===m.b)return r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("Without completing security on this session, it won’t have access to encrypted messages.")),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(e,{className:"warning",kind:"secondary",onClick:this.onSkipConfirmClick},Object(l.a)("Skip")),r.a.createElement(e,{kind:"danger",onClick:this.onSkipBackClick},Object(l.a)("Go Back"))));if(t===m.a){const e=h.getComponent("views.elements.Spinner");return r.a.createElement(e,null)}var s;console.log("SetupEncryptionBody: Unknown phase "+t)}}i()(p,"propTypes",{onFinished:c.a.func.isRequired})},function(e,t,s){"use strict";(function(e){s.d(t,"e",(function(){return d})),s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return m})),s.d(t,"d",(function(){return p})),s.d(t,"f",(function(){return g}));var n=s(2),i=s.n(n),o=s(10),r=s.n(o),a=s(47),c=s(105),l=s(135);const d=0,u=1,h=2,m=3,p=4;class g extends r.a{constructor(...e){super(...e),i()(this,"_onUserTrustStatusChanged",e=>{if(e!==a.a.get().getUserId())return;a.a.get().getCrossSigningId()&&(this.phase=h,this.emit("update"))}),i()(this,"onVerificationRequest",e=>{this._setActiveVerificationRequest(e)}),i()(this,"onVerificationRequestChange",()=>{if(this.verificationRequest.cancelled)this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if(this.verificationRequest.phase===l.c){this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null;const e=a.a.get().getCrossSigningId();this.phase=e?h:u,this.emit("update")}})}static sharedInstance(){return e.mx_SetupEncryptionStore||(e.mx_SetupEncryptionStore=new g),e.mx_SetupEncryptionStore}start(){if(this._started)return;this._started=!0,this.phase=u,this.verificationRequest=null,this.backupInfo=null,this.keyId=null,this.keyInfo=null;const e=a.a.get();e.on("crypto.verification.request",this.onVerificationRequest),e.on("userTrustStatusChanged",this._onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this._setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){this._started&&(this._started=!1,this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),a.a.get()&&(a.a.get().removeListener("crypto.verification.request",this.onVerificationRequest),a.a.get().removeListener("userTrustStatusChanged",this._onUserTrustStatusChanged)))}async fetchKeyInfo(){const e=await a.a.get().isSecretStored("m.cross_signing.master",!1);null===e||0===Object.keys(e).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(e)[0],this.keyInfo=e[this.keyId]),this.phase=d,this.emit("update")}async usePassPhrase(){this.phase=u,this.emit("update");const e=a.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise((s,n)=>{try{Object(c.b)(async()=>{await e.checkOwnCrossSigningTrust(),s(),t&&await e.restoreKeyBackupWithSecretStorage(t)}).catch(n)}catch(e){console.error(e),n(e)}}),e.getCrossSigningId()&&(this.phase=h,this.emit("update"))}catch(e){e instanceof c.a||console.log(e),this.phase=d,this.emit("update")}}skip(){this.phase=m,this.emit("update")}skipConfirm(){this.phase=p,this.emit("update")}returnAfterSkip(){this.phase=d,this.emit("update")}done(){this.phase=p,this.emit("update"),a.a.get()._crypto.cancelAndResendAllOutgoingKeyRequests()}async _setActiveVerificationRequest(e){e.otherUserId===a.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on("change",this.onVerificationRequestChange),this.emit("update"))}}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(2),i=s.n(n),o=s(128),r=s(216);class a extends o.a{getValueOverride(e,t,s,n){if(!s)return null;if(a.isLogin)return"light";return Object(r.b)()[s]?null:r.a}}i()(a,"isLogin",!1)},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(50),r=s(48),a=s(54),c=s(333),l=s(216),d=s(57);class u{constructor(){i()(this,"themeWatchRef",void 0),i()(this,"systemThemeWatchRef",void 0),i()(this,"dispatcherRef",void 0),i()(this,"preferDark",void 0),i()(this,"preferLight",void 0),i()(this,"currentTheme",void 0),i()(this,"onChange",()=>{this.recheck()}),i()(this,"onAction",e=>{e.action===a.a.RecheckTheme&&this.recheck(e.forceTheme)}),this.themeWatchRef=null,this.systemThemeWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.currentTheme=this.getEffectiveTheme()}start(){this.themeWatchRef=o.a.watchSetting("theme",null,this.onChange),this.systemThemeWatchRef=o.a.watchSetting("use_system_theme",null,this.onChange),this.preferDark.addEventListener&&(this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange)),this.dispatcherRef=r.a.register(this.onAction)}stop(){this.preferDark.addEventListener&&(this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange)),o.a.unwatchSetting(this.systemThemeWatchRef),o.a.unwatchSetting(this.themeWatchRef),r.a.unregister(this.dispatcherRef)}recheck(e){const t=this.currentTheme;this.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==this.currentTheme&&Object(l.d)(this.currentTheme)}getEffectiveTheme(){if(c.a.isLogin)return"light";if(o.a.getValueAt(d.a.DEVICE,"use_system_theme",null,!1,!0)){if(console.log("returning explicit system theme"),this.preferDark.matches)return"dark";if(this.preferLight.matches)return"light"}const e=o.a.getValueAt(d.a.DEVICE,"theme",null,!1,!0);if(e)return console.log("returning explicit theme: "+e),e;if(o.a.getValue("use_system_theme")){if(this.preferDark.matches)return"dark";if(this.preferLight.matches)return"light"}return console.log("returning theme value"),o.a.getValue("theme")}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return c}));var n=s(48),i=s(46),o=s(49),r=s(44);const a=/^[a-z0-9=_\-./]+$/;async function c(e){void 0===e&&(e={});const t=i.getComponent("dialogs.QuestionDialog"),s=o.a.createTrackedDialog("Registration required","",t,{hasCancelButton:!0,quitOnly:!0,title:Object(r.a)("Sign In or Create Account"),description:Object(r.a)("Use your account or create a new one to continue."),button:Object(r.a)("Create Account"),extraButtons:[React.createElement("button",{key:"start_login",onClick:()=>{s.close(),n.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after})}},Object(r.a)("Sign In"))],onFinished:t=>{t?n.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?n.a.dispatch({action:"view_home_page"}):e.go_welcome_on_cancel&&n.a.dispatch({action:"view_welcome_page"})}})}},function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f}));var n=s(43),i=s.n(n),o=s(44),r=s(53),a=s(92),c=s(78),l=s(147),d=s(485),u=s(62),h=s(49);function m(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function p(){u.a.get().installUpdate()}const g=(e,t,s)=>{let n,g=Object(o.a)("What's new?");s?n=()=>{h.a.createTrackedDialog("Display release notes","",l.a,{title:Object(o.a)("What's New"),description:i.a.createElement("pre",null,s),button:Object(o.a)("Update"),onFinished:e=>{e&&u.a.get()&&u.a.get().installUpdate()}})}:m(e)&&m(t)?n=()=>{h.a.createTrackedDialog("Display Changelog","",d.a,{version:e,newVersion:t,onFinished:e=>{e&&u.a.get()&&u.a.get().installUpdate()}})}:(n=p,g=Object(o.a)("Restart"));const f=r.a.get().brand;c.a.sharedInstance().addOrReplaceToast({key:"update",title:Object(o.a)("Upgrade your %(brand)s",{brand:f}),props:{description:Object(o.a)("A new version of %(brand)s is available!",{brand:f}),acceptLabel:g,onAccept:n,rejectLabel:Object(o.a)("Later"),onReject:function(){u.a.get().deferUpdate(t)}},component:a.a,priority:20})},f=()=>{c.a.sharedInstance().dismissToast("update")}},function(e,t){e.exports="img/feather-customised/warning-triangle.d95b363.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u})),s.d(t,"d",(function(){return b})),s.d(t,"c",(function(){return E}));var n=s(43),i=s(51),o=s.n(i),r=s(46),a=s(49),c=s(44),l=s(58);let d,u;Object(c.b)("Navigation"),Object(c.b)("Calls"),Object(c.b)("Composer"),Object(c.b)("Room List"),Object(c.b)("Autocomplete"),function(e){e.NAVIGATION="Navigation",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete"}(d||(d={})),Object(c.b)("Alt"),Object(c.b)("Alt Gr"),Object(c.b)("Shift"),Object(c.b)("Super"),Object(c.b)("Ctrl"),function(e){e.ALT="Alt",e.ALT_GR="Alt Gr",e.SHIFT="Shift",e.SUPER="Super",e.COMMAND="Command",e.CONTROL="Ctrl"}(u||(u={}));const h=l.b?u.COMMAND:u.CONTROL,m={[d.COMPOSER]:[{keybinds:[{modifiers:[h],key:l.a.B}],description:Object(c.b)("Toggle Bold")},{keybinds:[{modifiers:[h],key:l.a.I}],description:Object(c.b)("Toggle Italics")},{keybinds:[{modifiers:[h],key:l.a.GREATER_THAN}],description:Object(c.b)("Toggle Quote")},{keybinds:[{modifiers:[u.SHIFT],key:l.a.ENTER}],description:Object(c.b)("New line")},{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate recent messages to edit")},{keybinds:[{modifiers:[h],key:l.a.HOME},{modifiers:[h],key:l.a.END}],description:Object(c.b)("Jump to start/end of the composer")},{keybinds:[{modifiers:[u.CONTROL,u.ALT],key:l.a.ARROW_UP},{modifiers:[u.CONTROL,u.ALT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate composer history")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Cancel replying to a message")}],[d.CALLS]:[{keybinds:[{modifiers:[h],key:l.a.D}],description:Object(c.b)("Toggle microphone mute")},{keybinds:[{modifiers:[h],key:l.a.E}],description:Object(c.b)("Toggle video on/off")}],[d.ROOM]:[{keybinds:[{key:l.a.PAGE_UP},{key:l.a.PAGE_DOWN}],description:Object(c.b)("Scroll up/down in the timeline")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Dismiss read marker and jump to bottom")},{keybinds:[{modifiers:[u.SHIFT],key:l.a.PAGE_UP}],description:Object(c.b)("Jump to oldest unread message")},{keybinds:[{modifiers:[h,u.SHIFT],key:l.a.U}],description:Object(c.b)("Upload a file")}],[d.ROOM_LIST]:[{keybinds:[{modifiers:[h],key:l.a.K}],description:Object(c.b)("Jump to room search")},{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate up/down in the room list")},{keybinds:[{key:l.a.ENTER}],description:Object(c.b)("Select room from the room list")},{keybinds:[{key:l.a.ARROW_LEFT}],description:Object(c.b)("Collapse room list section")},{keybinds:[{key:l.a.ARROW_RIGHT}],description:Object(c.b)("Expand room list section")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Clear room list filter field")}],[d.NAVIGATION]:[{keybinds:[{modifiers:[u.ALT,u.SHIFT],key:l.a.ARROW_UP},{modifiers:[u.ALT,u.SHIFT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Previous/next unread room or DM")},{keybinds:[{modifiers:[u.ALT],key:l.a.ARROW_UP},{modifiers:[u.ALT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Previous/next room or DM")},{keybinds:[{modifiers:[h],key:l.a.BACKTICK}],description:Object(c.b)("Toggle the top left menu")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Close dialog or context menu")},{keybinds:[{key:l.a.ENTER},{key:l.a.SPACE}],description:Object(c.b)("Activate selected button")},{keybinds:[{modifiers:[h],key:l.a.PERIOD}],description:Object(c.b)("Toggle right panel")},{keybinds:[{modifiers:[h],key:l.a.SLASH}],description:Object(c.b)("Toggle this dialog")}],[d.AUTOCOMPLETE]:[{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Move autocomplete selection up/down")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Cancel autocomplete")}]},p=[d.COMPOSER,d.AUTOCOMPLETE,d.ROOM,d.ROOM_LIST,d.NAVIGATION,d.CALLS],g={[u.COMMAND]:"⌘"};l.b&&(g[u.ALT]="⌥");const f={[l.a.PAGE_UP]:Object(c.b)("Page Up"),[l.a.PAGE_DOWN]:Object(c.b)("Page Down"),[l.a.ESCAPE]:Object(c.b)("Esc"),[l.a.ENTER]:Object(c.b)("Enter"),[l.a.SPACE]:Object(c.b)("Space"),[l.a.HOME]:Object(c.b)("Home"),[l.a.END]:Object(c.b)("End")},_={[l.a.ARROW_UP]:"↑",[l.a.ARROW_DOWN]:"↓",[l.a.ARROW_LEFT]:"←",[l.a.ARROW_RIGHT]:"→"},v=({shortcut:e})=>{const t=o()({mx_KeyboardShortcutsDialog_inline:e.keybinds.every(e=>!e.modifiers||0===e.modifiers.length)});return n.createElement("div",{className:t},n.createElement("h5",null,Object(c.a)(e.description)),e.keybinds.map(e=>{let t=e.key;return f[e.key]?t=Object(c.a)(f[e.key]):_[e.key]&&(t=_[e.key]),n.createElement("div",{key:e.key},e.modifiers&&e.modifiers.map(e=>n.createElement(n.Fragment,{key:e},n.createElement("kbd",null,g[e]||Object(c.a)(e)),"+")),n.createElement("kbd",null,t))}))};let y=null;const b=()=>{if(y)return y.close(),void(y=null);const e=p.map(e=>{const t=m[e];return n.createElement("div",{className:"mx_KeyboardShortcutsDialog_category",key:e},n.createElement("h3",null,Object(c.a)(e)),n.createElement("div",null,t.map(e=>n.createElement(v,{key:e.description,shortcut:e}))))}),t=r.getComponent("dialogs.InfoDialog");y=a.a.createTrackedDialog("Keyboard Shortcuts","",t,{className:"mx_KeyboardShortcutsDialog",title:Object(c.a)("Keyboard Shortcuts"),description:e,hasCloseButton:!0,onKeyDown:e=>{!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==l.a.SLASH||(e.stopPropagation(),y.close())},onFinished:()=>{y=null}})},E=(e,t)=>{m[e].push(t)}},,,function(e,t,s){"use strict";var n=s(43),i=s.n(n);t.a=e=>i.a.createElement("div",{className:"mx_PulsedAvatar"},e.children)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(48),c=s(101),l=s(47),d=s(44),u=s(52),h=s(490),m=s(176),p=s(341);class g extends r.a.Component{constructor(e){super(e),i()(this,"videoref",void 0),i()(this,"dispatcherRef",void 0),i()(this,"call",void 0),i()(this,"onAction",e=>{"call_state"===e.action&&this.showCall()}),this.state={call:null},this.videoref=Object(o.createRef)()}componentDidMount(){this.dispatcherRef=a.a.register(this.onAction),this.showCall()}componentWillUnmount(){a.a.unregister(this.dispatcherRef)}showCall(){let e;if(this.props.room){const t=this.props.room.roomId;e=c.a.getCallForRoom(t)||(this.props.ConferenceHandler?this.props.ConferenceHandler.getConferenceCallForRoom(t):null),this.call&&this.setState({call:e})}else e=c.a.getAnyActiveCall(),null===l.a.get().getRoom(e.roomId)&&(e=null),this.setState({call:e});e&&(e.setLocalVideoElement(this.getVideoView().getLocalVideoElement()),e.setRemoteVideoElement(this.getVideoView().getRemoteVideoElement()),e.setRemoteAudioElement(this.getVideoView().getRemoteAudioElement())),e&&"video"===e.type&&"ended"!==e.call_state&&"ringing"!==e.call_state?(this.getVideoView().getLocalVideoElement().style.display=e.confUserId?"none":"block",this.getVideoView().getRemoteVideoElement().style.display="block"):(this.getVideoView().getLocalVideoElement().style.display="none",this.getVideoView().getRemoteVideoElement().style.display="none",a.a.dispatch({action:"video_fullscreen",fullscreen:!1})),this.props.onResize&&this.props.onResize()}getVideoView(){return this.videoref.current}render(){let e,t;if(this.state.call&&"voice"===this.state.call.type){const t=l.a.get().getRoom(this.state.call.roomId);e=r.a.createElement(u.a,{className:"mx_CallView_voice",onClick:this.props.onClick},r.a.createElement(p.a,null,r.a.createElement(m.a,{room:t,height:35,width:35})),r.a.createElement("div",null,r.a.createElement("h1",null,t.name),r.a.createElement("p",null,Object(d.a)("Active call"))))}else e=r.a.createElement(h.a,{ref:this.videoref,onClick:this.props.onClick,onResize:this.props.onResize,maxHeight:this.props.maxVideoHeight});return this.props.showHangup&&(t=r.a.createElement("div",{className:"mx_CallView_hangup",onClick:()=>{a.a.dispatch({action:"hangup",room_id:this.state.call.roomId})}})),r.a.createElement("div",{className:this.props.className},e,t)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(327);class c extends r.a.Component{constructor(...e){super(...e),i()(this,"_onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),i()(this,"_onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),i()(this,"_onResizeStop",(e,t,s,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",this._loadSidePanelSize().width+n.width)})}_loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=r.a.Children.only(this.props.children),t=this.props.panel;let s;return!this.props.collapsedRhs&&t&&(s=r.a.createElement(a.Resizable,{defaultSize:this._loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this._onResizeStart,onResize:this._onResize,onResizeStop:this._onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_RightPanel_ResizeHandle"}},t)),r.a.createElement("div",{className:"mx_MainSplit"},e,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(51),d=s.n(l),u=s(187),h=s(46),m=s(48),p=s(182),g=s(259),f=s(67),_=s(70),v=s(218),y=s(59),b=s(54),E=s(345),S=s(500);function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function C(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class R extends r.a.Component{static get propTypes(){return{room:c.a.instanceOf(u.a),groupId:c.a.string,user:c.a.object}}constructor(e,t){super(e,t),i()(this,"onCloseUserInfo",()=>{this.props.user?m.a.dispatch({action:"view_home_page"}):m.a.dispatch({action:b.a.ViewUser,member:this.state.phase===_.b.EncryptionPanel?this.state.member:null})}),i()(this,"onClose",()=>{m.a.dispatch({action:b.a.ToggleRightPanel,type:this.props.groupId?"group":"room"})}),this.state=C(C({},v.a.getSharedInstance().roomPanelPhaseParams),{},{phase:this._getPhaseFromProps(),isUserPrivilegedInGroup:null,member:this._getUserForPanel()}),this.onAction=this.onAction.bind(this),this.onRoomStateMember=this.onRoomStateMember.bind(this),this.onGroupStoreUpdated=this.onGroupStoreUpdated.bind(this),this.onInviteToGroupButtonClick=this.onInviteToGroupButtonClick.bind(this),this.onAddRoomToGroupButtonClick=this.onAddRoomToGroupButtonClick.bind(this),this._delayedUpdate=new p.a(()=>{this.forceUpdate()},500)}_getUserForPanel(){if(this.state&&this.state.member)return this.state.member;const e=v.a.getSharedInstance().roomPanelPhaseParams;return this.props.user||e.member}_getPhaseFromProps(){const e=v.a.getSharedInstance(),t=this._getUserForPanel();return this.props.groupId?_.a.includes(e.groupPanelPhase)?e.groupPanelPhase:(m.a.dispatch({action:b.a.SetRightPanelPhase,phase:_.b.GroupMemberList}),_.b.GroupMemberList):t?e.roomPanelPhaseParams.member&&t.userId===e.roomPanelPhaseParams.member.userId&&e.roomPanelPhaseParams.verificationRequest?e.roomPanelPhase:_.b.RoomMemberInfo:e.roomPanelPhase}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction);this.context.on("RoomState.members",this.onRoomStateMember),this._initGroupStore(this.props.groupId)}componentWillUnmount(){m.a.unregister(this.dispatcherRef),this.context&&this.context.removeListener("RoomState.members",this.onRoomStateMember),this._unregisterGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}_initGroupStore(e){e&&f.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(){f.a.unregisterListener(this.onGroupStoreUpdated)}onGroupStoreUpdated(){this.setState({isUserPrivilegedInGroup:f.a.isUserPrivileged(this.props.groupId)})}onInviteToGroupButtonClick(){Object(g.b)(this.props.groupId).then(()=>{this.setState({phase:_.b.GroupMemberList})})}onAddRoomToGroupButtonClick(){Object(g.a)(this.props.groupId).then(()=>{this.forceUpdate()})}onRoomStateMember(e,t,s){s.roomId===this.props.room.roomId&&(this.state.phase===_.b.RoomMemberList&&s.roomId===this.props.room.roomId||this.state.phase===_.b.RoomMemberInfo&&s.roomId===this.props.room.roomId&&s.userId===this.state.member.userId)&&this._delayedUpdate()}onAction(e){e.action===b.a.AfterRightPanelPhaseChange&&this.setState({phase:e.phase,groupRoomId:e.groupRoomId,groupId:e.groupId,member:e.member,event:e.event,verificationRequest:e.verificationRequest,verificationRequestPromise:e.verificationRequestPromise,widgetId:e.widgetId})}render(){const e=h.getComponent("rooms.MemberList"),t=h.getComponent("right_panel.UserInfo"),s=h.getComponent("rooms.ThirdPartyMemberInfo"),n=h.getComponent("structures.NotificationPanel"),i=h.getComponent("structures.FilePanel"),o=h.getComponent("groups.GroupMemberList"),a=h.getComponent("groups.GroupRoomList"),c=h.getComponent("groups.GroupRoomInfo");let l=r.a.createElement("div",null);const u=this.props.room?this.props.room.roomId:void 0;switch(this.state.phase){case _.b.RoomMemberList:u&&(l=r.a.createElement(e,{roomId:u,key:u,onClose:this.onClose}));break;case _.b.GroupMemberList:this.props.groupId&&(l=r.a.createElement(o,{groupId:this.props.groupId,key:this.props.groupId}));break;case _.b.GroupRoomList:l=r.a.createElement(a,{groupId:this.props.groupId,key:this.props.groupId});break;case _.b.RoomMemberInfo:case _.b.EncryptionPanel:l=r.a.createElement(t,{user:this.state.member,room:this.props.room,key:u||this.state.member.userId,onClose:this.onCloseUserInfo,phase:this.state.phase,verificationRequest:this.state.verificationRequest,verificationRequestPromise:this.state.verificationRequestPromise});break;case _.b.Room3pidMemberInfo:l=r.a.createElement(s,{event:this.state.event,key:u});break;case _.b.GroupMemberInfo:l=r.a.createElement(t,{user:this.state.member,groupId:this.props.groupId,key:this.state.member.userId,onClose:this.onCloseUserInfo});break;case _.b.GroupRoomInfo:l=r.a.createElement(c,{groupRoomId:this.state.groupRoomId,groupId:this.props.groupId,key:this.state.groupRoomId});break;case _.b.NotificationPanel:l=r.a.createElement(n,{onClose:this.onClose});break;case _.b.FilePanel:l=r.a.createElement(i,{roomId:u,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose});break;case _.b.RoomSummary:l=r.a.createElement(E.a,{room:this.props.room,onClose:this.onClose});break;case _.b.Widget:l=r.a.createElement(S.a,{room:this.props.room,widgetId:this.state.widgetId,onClose:this.onClose})}const m=d()("mx_RightPanel","mx_fadable",{collapsed:this.props.collapsed,mx_fadable_faded:this.props.disabled,"dark-panel":!0});return r.a.createElement("aside",{className:m,id:"mx_RightPanel"},l)}}i()(R,"contextType",y.a)},function(e,t,s){"use strict";s.d(t,"b",(function(){return T}));var n=s(43),i=s.n(n),o=s(51),r=s.n(o),a=s(80),c=s(59),l=s(494),d=s(149),u=s(44),h=s(176),m=s(52),p=s(48),g=s(54),f=s(70),_=s(49),v=s(495),y=s(145),b=s(171),E=s(76),S=s(93),w=s(50),C=s(325),R=s(127),k=s(68),I=s(261);const O=({children:e,className:t,onClick:s})=>i.a.createElement(m.a,{className:r()("mx_BaseCard_Button mx_RoomSummaryCard_Button",t),onClick:s},e),T=e=>{const[t,s]=Object(n.useState)(I.a.instance.getApps(e)),i=Object(n.useCallback)(()=>{s([...I.a.instance.getApps(e)])},[e]);return Object(n.useEffect)(i,[e]),Object(y.a)(b.a,"update",i),Object(y.a)(I.a.instance,e.roomId,i),t},x=({room:e})=>{const t=Object(n.useContext)(c.a),o=T(e);return i.a.createElement(d.a,{className:"mx_RoomSummaryCard_appsGroup",title:Object(u.a)("Apps")},o.map(e=>{const n=E.a.getWidgetName(e),o=E.a.getWidgetDataTitle(e),c=o&&" - "+o;let l=[s(868)];e.type.includes("meeting")||e.type.includes("calendar")?l=[s(869)]:e.type.includes("pad")||e.type.includes("doc")||e.type.includes("calc")?l=[s(870)]:e.type.includes("clock")&&(l=[s(871)]),e.avatar_url&&l.unshift(Object(a.a)(t.getHomeserverUrl(),e.avatar_url,20,20,"crop"));const d=I.a.instance.isPinned(e.id),h=r()("mx_RoomSummaryCard_icon_app",{mx_RoomSummaryCard_icon_app_pinned:d});if(d){const t=()=>{I.a.instance.unpinWidget(e.id)};return i.a.createElement(k.a,{key:e.id,className:r()("mx_BaseCard_Button mx_RoomSummaryCard_Button",h),onClick:t,title:Object(u.a)("Unpin app")},i.a.createElement(R.a,{name:e.id,urls:l,width:20,height:20}),i.a.createElement("span",null,n),c)}return i.a.createElement(O,{key:e.id,className:h,onClick:()=>{p.a.dispatch({action:g.a.SetRightPanelPhase,phase:f.b.Widget,refireParams:{widgetId:e.id}})}},i.a.createElement(R.a,{name:e.id,urls:l,width:20,height:20}),i.a.createElement("span",null,n),c)}),i.a.createElement(m.a,{kind:"link",onClick:()=>{const t=S.a.sharedInstance();t.hasManager()?w.a.getValue("feature_many_integration_managers")?t.openAll(e):t.getPrimaryManager().open(e):t.openNoManagerDialog()}},o.length>0?Object(u.a)("Edit apps, bridges & bots"):Object(u.a)("Add apps, bridges & bots")))},N=()=>{p.a.dispatch({action:g.a.SetRightPanelPhase,phase:f.b.RoomMemberList})},j=()=>{p.a.dispatch({action:g.a.SetRightPanelPhase,phase:f.b.FilePanel})},P=()=>{p.a.dispatch({action:"open_room_settings"})};t.a=({room:e,onClose:t})=>{const s=Object(n.useContext)(c.a),o=Object(l.a)(s,e),a=e.getCanonicalAlias()||e.getAltAliases()[0]||"",m=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_RoomSummaryCard_avatar",role:"presentation"},i.a.createElement(h.a,{room:e,height:54,width:54,viewAvatarOnClick:!0}),i.a.createElement(C.a,{tooltip:o?Object(u.a)("Encrypted"):Object(u.a)("Not encrypted"),class:r()("mx_RoomSummaryCard_e2ee",{mx_RoomSummaryCard_e2ee_secure:o})})),i.a.createElement("h2",{title:e.name},e.name),i.a.createElement("div",{className:"mx_RoomSummaryCard_alias",title:a},a)),p=(e=>{const[t,s]=Object(n.useState)(e.getJoinedMembers().length);return Object(y.a)(e.currentState,"RoomState.members",()=>{s(e.getJoinedMembers().length)}),t})(e);return i.a.createElement(d.b,{header:m,className:"mx_RoomSummaryCard",onClose:t},i.a.createElement(d.a,{title:Object(u.a)("About"),className:"mx_RoomSummaryCard_aboutGroup"},i.a.createElement(O,{className:"mx_RoomSummaryCard_icon_people",onClick:N},Object(u.a)("%(count)s people",{count:p})),i.a.createElement(O,{className:"mx_RoomSummaryCard_icon_files",onClick:j},Object(u.a)("Show files")),i.a.createElement(O,{className:"mx_RoomSummaryCard_icon_share",onClick:()=>{_.a.createTrackedDialog("share room dialog","",v.a,{target:e})}},Object(u.a)("Share room")),i.a.createElement(O,{className:"mx_RoomSummaryCard_icon_settings",onClick:P},Object(u.a)("Room settings"))),i.a.createElement(x,{room:e}))}},function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s(842),l=s(51),d=s.n(l),u=s(44),h=s(99);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const g={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:s}=e,n=r()(e,["data","className"]);const[i,o]=a.useState(null);return a.useEffect(()=>{let e=!1;return Object(c.toDataURL)(t,p(p({},g),n)).then(t=>{e||o(t)}),()=>{e=!0}},[JSON.stringify(t),n]),a.createElement("div",{className:d()("mx_QRCode",s)},i?a.createElement("img",{src:i,className:"mx_VerificationQRCode",alt:Object(u.a)("QR Code")}):a.createElement(h.a,null))}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(79),c=s.n(a),l=s(45),d=s.n(l),u=s(63),h=s(874),m=s.n(h),p=s(48);function g(e){return document.getElementById(e)}class f extends r.a.Component{constructor(){super(),i()(this,"updateChildPosition",Object(u.throttle)((e,t)=>{if(!e||!t)return;const s=t.getBoundingClientRect();Object.assign(e.style,{position:"absolute",top:s.top+"px",left:s.left+"px",width:s.width+"px",height:s.height+"px"})},100,{trailing:!0,leading:!0})),this.collectChildContainer=this.collectChildContainer.bind(this),this.collectChild=this.collectChild.bind(this),this._repositionChild=this._repositionChild.bind(this),this._onAction=this._onAction.bind(this),this.resizeObserver=new m.a(this._repositionChild),window.addEventListener("resize",this._repositionChild),this._dispatcherRef=p.a.register(this._onAction)}static destroyElement(e){const t=g("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(g("mx_persistedElement_"+e))}collectChildContainer(e){this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}collectChild(e){this.child=e,this.updateChild()}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this._repositionChild),p.a.unregister(this._dispatcherRef)}_onAction(e){"timeline_resize"===e.action&&this._repositionChild()}_repositionChild(){this.updateChildPosition(this.child,this.childContainer)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=r.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children);c.a.render(e,function(e){let t=g(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}render(){return r.a.createElement("div",{ref:this.collectChildContainer})}}i()(f,"propTypes",{persistKey:d.a.string.isRequired})},function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(44),r=s(59),a=s(75),c=s(50);const l=i.a.forwardRef(({mxEvent:e},t)=>{const s=Object(n.useContext)(r.a);let l=Object(o.a)("Message deleted");const d=e.getUnsigned(),u=d&&d.redacted_because&&d.redacted_because.sender;if(u&&u!==e.getSender()){const t=s.getRoom(e.getRoomId()),n=t&&t.getMember(u);l=Object(o.a)("Message deleted by %(name)s",{name:n?n.name:u})}const h=c.a.getValue("showTwelveHourTimestamps"),m=Object(a.b)(new Date(d.redacted_because.origin_server_ts),h),p=Object(o.a)("Message deleted on %(date)s",{date:m});return i.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:p},l)});t.a=l},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(43),i=s.n(n),o=s(51),r=s.n(o),a=s(72),c=s(68);class l extends i.a.Component{constructor(e){super(e),this.onClick=this.onClick.bind(this)}onClick(){a.a.trackEvent(...this.props.analytics),this.props.onClick()}render(){const e=r()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:this.props.isHighlighted,["mx_RightPanel_"+this.props.name]:!0});return i.a.createElement(c.a,{"aria-selected":this.props.isHighlighted,role:"tab",title:this.props.title,className:e,onClick:this.onClick})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(48),c=s(218),l=s(54);let d;!function(e){e.Room="room",e.Group="group"}(d||(d={}));class u extends r.a.Component{constructor(e,t){super(e),i()(this,"storeToken",void 0),i()(this,"dispatcherRef",void 0);const s=c.a.getSharedInstance();this.state={headerKind:t,phase:t===d.Room?s.visibleRoomPanelPhase:s.visibleGroupPanelPhase}}componentDidMount(){this.storeToken=c.a.getSharedInstance().addListener(this.onRightPanelUpdate.bind(this)),this.dispatcherRef=a.a.register(this.onAction.bind(this))}componentWillUnmount(){this.storeToken&&this.storeToken.remove(),this.dispatcherRef&&a.a.unregister(this.dispatcherRef)}setPhase(e,t){a.a.dispatch({action:l.a.SetRightPanelPhase,phase:e,refireParams:t})}isPhase(e){return Array.isArray(e)?e.includes(this.state.phase):e===this.state.phase}onRightPanelUpdate(){const e=c.a.getSharedInstance();this.state.headerKind===d.Room?this.setState({phase:e.visibleRoomPanelPhase}):this.state.headerKind===d.Group&&this.setState({phase:e.visibleGroupPanelPhase})}render(){return r.a.createElement("div",{className:"mx_HeaderButtons"},this.renderButtons())}}},function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(215);class d extends r.a.Component{constructor(...e){super(...e),i()(this,"tint",()=>{l.a.applySvgFixups(this.fixups)}),i()(this,"onLoad",e=>{this.fixups=l.a.calcSvgFixups([e.target]),l.a.applySvgFixups(this.fixups)})}componentDidMount(){this.fixups=[],this.id=d.idSequence++,d.mounts[this.id]=this}componentWillUnmount(){delete d.mounts[this.id]}render(){return r.a.createElement("object",{className:"mx_TintableSvg "+(this.props.className?this.props.className:""),type:"image/svg+xml",data:this.props.src,width:this.props.width,height:this.props.height,onLoad:this.onLoad,tabIndex:"-1"})}}i()(d,"propTypes",{src:c.a.string.isRequired,width:c.a.string.isRequired,height:c.a.string.isRequired,className:c.a.string}),i()(d,"mounts",{}),i()(d,"idSequence",0),l.a.registerTintable((function(){d.mounts&&Object.keys(d.mounts).forEach(e=>{d.mounts[e].tint()})})),t.a=d},,,,,function(e,t,s){"use strict";(function(e){s.d(t,"d",(function(){return o})),s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return a})),s.d(t,"c",(function(){return c}));class n{constructor(){this.logs=""}monkeyPatch(e){const t={log:"I",info:"I",warn:"W",error:"E"};Object.keys(t).forEach(s=>{const n=t[s],i=e[s].bind(e);e[s]=(...e)=>{this.log(n,...e),i(...e)}})}log(e,...t){let s=`${(new Date).toISOString()} ${e} ${(t=t.map(e=>{if(e instanceof Error)return e.message+(e.stack?"\n"+e.stack:"");if("object"!=typeof e)return e;try{return JSON.stringify(e)}catch(t){return JSON.stringify(e,(e,t)=>e&&"object"==typeof t?"<object>":t)}})).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class i{constructor(e,t){this.indexedDB=e,this.logger=t,this.id="instance-"+Math.random()+Date.now(),this.index=0,this.db=null,this.flushPromise=null,this.flushAgainPromise=null}connect(){const e=this.indexedDB.open("logs");return new Promise((t,s)=>{e.onsuccess=e=>{this.db=e.target.result,setInterval(this.flush.bind(this),3e4),t()},e.onerror=e=>{const t="Failed to open log database: "+e.target.error.name;console.error(t),s(new Error(t))},e.onupgradeneeded=e=>{const t=e.target.result,s=t.createObjectStore("logs",{keyPath:["id","index"]});s.createIndex("id","id",{unique:!1}),s.add(this._generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this._generateLastModifiedTime())}})}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then(()=>this.flush()).then(()=>{this.flushAgainPromise=null})),this.flushAgainPromise):(this.flushPromise=new Promise((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const s=this.logger.flush();if(0===s.length)return void e();const n=this.db.transaction(["logs","logslastmod"],"readwrite"),i=n.objectStore("logs");n.oncomplete=t=>{e()},n.onerror=e=>{console.error("Failed to flush logs : ",e),t(new Error("Failed to write logs: "+e.target.errorCode))},i.add(this._generateLogEntry(s));n.objectStore("logslastmod").put(this._generateLastModifiedTime())}).then(()=>{this.flushPromise=null}),this.flushPromise)}async consume(){const e=this.db;function t(t,s){const n=e.transaction("logs","readonly").objectStore("logs");return new Promise((e,i)=>{const o=n.index("id").openCursor(IDBKeyRange.only(t),"prev");let r="";o.onerror=e=>{i(new Error("Query failed: "+e.target.errorCode))},o.onsuccess=t=>{const n=t.target.result;n?(r=n.value.lines+r,r.length>=s?e(r):n.continue()):e(r)}})}const s=await function(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(i.push(s(n)),n.continue()):e(i)}})}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,e=>({id:e.value.id,ts:e.value.ts})).then(e=>e.sort((e,t)=>t.ts-e.ts).map(e=>e.id));let n=[];const i=[];let o=0;for(let e=0;e<s.length;e++){const r=await t(s[e],5242880-o);if(i.push({lines:r,id:s[e]}),o+=r.length,o>=5242880){n=s.slice(e+1);break}}return n.length>0&&(console.log("Removing logs: ",n),Promise.all(n.map(t=>function(t){return new Promise((s,n)=>{const i=e.transaction(["logs","logslastmod"],"readwrite"),o=i.objectStore("logs");o.index("id").openKeyCursor(IDBKeyRange.only(t)).onsuccess=e=>{const t=e.target.result;t&&(o.delete(t.primaryKey),t.continue())},i.oncomplete=()=>{s()},i.onerror=e=>{n(new Error(`Failed to delete logs for '${t}' : ${e.target.errorCode}`))};i.objectStore("logslastmod").delete(t)})}(t))).then(()=>{console.log(`Removed ${n.length} old logs.`)},e=>{console.error(e)})),i}_generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}_generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function o(){if(e.mx_rage_initPromise)return e.mx_rage_initPromise;let t;e.mx_rage_logger=new n,e.mx_rage_logger.monkeyPatch(window.console);try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new i(t,e.mx_rage_logger),e.mx_rage_initPromise=e.mx_rage_store.connect(),e.mx_rage_initPromise):(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise)}function r(){e.mx_rage_store&&e.mx_rage_store.flush()}async function a(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function c(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),await e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,s(6))},,,,function(e,t){e.exports="img/ellipsis.6f84086.svg"},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return T})),s.d(t,"b",(function(){return x})),s.d(t,"c",(function(){return U}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(46),u=s(47),h=s(65),m=s(90),p=(s(134),s(53)),g=s(80),f=s(204),_=s(205),v=s(173),y=s(48),b=s(123),E=s(49);var S=s(98),w=s(97),C=s(58),R=s(54),k=s(71),I=s(89),O=s(124);const T="dm",x="invite";class N{get name(){throw new Error("Member class not implemented")}get userId(){throw new Error("Member class not implemented")}getMxcAvatarUrl(){throw new Error("Member class not implemented")}}class j extends N{constructor(e){super(),i()(this,"_userId",void 0),i()(this,"_displayName",void 0),i()(this,"_avatarUrl",void 0),this._userId=e.user_id,this._displayName=e.display_name,this._avatarUrl=e.avatar_url}get name(){return this._displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){return this._avatarUrl}}class P extends N{constructor(e){super(),i()(this,"_id",void 0),this._id=e}get isEmail(){return this._id.includes("@")}get name(){return this._id}get userId(){return this._id}getMxcAvatarUrl(){return null}}class D extends r.a.PureComponent{constructor(...e){super(...e),i()(this,"_onRemove",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)})}render(){const e=d.getComponent("views.avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),n=this.props.member.isEmail?r.a.createElement("img",{className:"mx_InviteDialog_userTile_avatar mx_InviteDialog_userTile_threepidAvatar",src:s(442),width:20,height:20}):r.a.createElement(e,{className:"mx_InviteDialog_userTile_avatar",url:Object(g.a)(u.a.get().getHomeserverUrl(),this.props.member.getMxcAvatarUrl(),20,20,"crop"),name:this.props.member.name,idName:this.props.member.userId,width:20,height:20});let i;return this.props.onRemove&&(i=r.a.createElement(t,{className:"mx_InviteDialog_userTile_remove",onClick:this._onRemove},r.a.createElement("img",{src:s(754),alt:Object(l.a)("Remove"),width:8,height:8}))),r.a.createElement("span",{className:"mx_InviteDialog_userTile"},r.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},n,r.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),i)}}i()(D,"propTypes",{member:c.a.object.isRequired,onRemove:c.a.func});class A extends r.a.PureComponent{constructor(...e){super(...e),i()(this,"_onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)})}_highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),s=this.props.highlightWord.toLowerCase(),n=[];let i,o=0;for(;(i=t.indexOf(s,o))>=0;){i>o&&n.push(r.a.createElement("span",{key:o+"begin"},e.substring(o,i))),o=i;const t=e.substring(o,s.length+o);n.push(r.a.createElement("span",{className:"mx_InviteDialog_roomTile_highlight",key:o+"bold"},t)),o+=t.length}return o<e.length&&n.push(r.a.createElement("span",{key:o+"end"},e.substring(o))),n}render(){const e=d.getComponent("views.avatars.BaseAvatar");let t=null;if(this.props.lastActiveTs){const e=function(e){let t=(new Date).getTime()-e;const s=Math.abs(Math.ceil(t/6e4)),n=Math.ceil(s/60),i=Math.ceil(n/24);return t>=0?t<=15e3?Object(l.a)("a few seconds ago"):t<=75e3?Object(l.a)("about a minute ago"):s<=45?Object(l.a)("%(num)s minutes ago",{num:s}):s<=75?Object(l.a)("about an hour ago"):n<=23?Object(l.a)("%(num)s hours ago",{num:n}):n<=26?Object(l.a)("about a day ago"):Object(l.a)("%(num)s days ago",{num:i}):(t=Math.abs(t),t<=15e3?Object(l.a)("a few seconds from now"):t<=75e3?Object(l.a)("about a minute from now"):s<=45?Object(l.a)("%(num)s minutes from now",{num:s}):s<=75?Object(l.a)("about an hour from now"):n<=23?Object(l.a)("%(num)s hours from now",{num:n}):n<=26?Object(l.a)("about a day from now"):Object(l.a)("%(num)s days from now",{num:i}))}(this.props.lastActiveTs);t=r.a.createElement("span",{className:"mx_InviteDialog_roomTile_time"},e)}const n=this.props.member.isEmail?r.a.createElement("img",{src:s(442),width:36,height:36}):r.a.createElement(e,{url:Object(g.a)(u.a.get().getHomeserverUrl(),this.props.member.getMxcAvatarUrl(),36,36,"crop"),name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let i=null;this.props.isSelected&&(i=r.a.createElement("div",{className:"mx_InviteDialog_roomTile_selected"}));const o=r.a.createElement("span",{className:"mx_InviteDialog_roomTile_avatarStack"},n,i);return r.a.createElement("div",{className:"mx_InviteDialog_roomTile",onClick:this._onClick},o,r.a.createElement("span",{className:"mx_InviteDialog_roomTile_name"},this._highlightName(this.props.member.name)),r.a.createElement("span",{className:"mx_InviteDialog_roomTile_userId"},this._highlightName(this.props.member.userId)),t)}}i()(A,"propTypes",{member:c.a.object.isRequired,lastActiveTs:c.a.number,onToggle:c.a.func.isRequired,highlightWord:c.a.string,isSelected:c.a.bool});class U extends r.a.PureComponent{constructor(e){if(super(e),i()(this,"_debounceTimer",null),i()(this,"_editorRef",null),i()(this,"_startDm",async()=>{this.setState({busy:!0});const e=this._convertFilter(),t=e.map(e=>e.userId),s=m.a.shared().getDMRoomForIdentifiers(t);if(s)return y.a.dispatch({action:"view_room",room_id:s.roomId,should_peek:!1,joining:!1}),void this.props.onFinished();const n={inlineErrors:!0};if(Object(S.e)()){if(!e.some(e=>e instanceof P)){const e=u.a.get();await Object(S.a)(e,t)&&(n.encryption=!0)}}let i=Promise.resolve();const o=1===t.length&&t[0]===u.a.get().getUserId();1!==t.length||o?i=o?Object(S.b)(n):Object(S.b)(n).then(e=>Object(w.a)(e,t)).then(e=>{if(this._shouldAbortAfterInviteError(e))return!0}):(n.dmUserId=t[0],i=Object(S.b)(n)),i.then(e=>{!0!==e&&this.props.onFinished()}).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't create your DM. Please check the users you want to invite and try again.")})})}),i()(this,"_inviteUsers",()=>{this.setState({busy:!0}),this._convertFilter();const e=this._convertFilter().map(e=>e.userId);if(!u.a.get().getRoom(this.props.roomId))return console.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(l.a)("Something went wrong trying to invite the users.")});Object(w.a)(this.props.roomId,e).then(e=>{this._shouldAbortAfterInviteError(e)||this.props.onFinished()}).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})})}),i()(this,"_onKeyDown",e=>{e.target.value||this.state.busy||!(this.state.targets.length>0)||e.key!==C.a.BACKSPACE||e.ctrlKey||e.shiftKey||e.metaKey||(e.preventDefault(),this._removeMember(this.state.targets[this.state.targets.length-1]))}),i()(this,"_updateFilter",e=>{const t=e.target.value;this.setState({filterText:t}),this._debounceTimer&&clearTimeout(this._debounceTimer),this._debounceTimer=setTimeout(async()=>{if(u.a.get().searchUserDirectory({term:t}).then(async e=>{if(t===this.state.filterText){if(e.results||(e.results=[]),"@"===t[0]&&t.indexOf(":")>1)try{const s=await u.a.get().getProfileInfo(t);s&&e.results.splice(0,0,{user_id:t,display_name:s.displayname,avatar_url:s.avatar_url})}catch(s){console.warn("Non-fatal error trying to make an invite for a user ID"),console.warn(s),e.results.splice(0,0,{user_id:t,display_name:t,avatar_url:null})}this.setState({serverResultsMixin:e.results.map(e=>({userId:e.user_id,user:new j(e)}))})}}).catch(e=>{console.error("Error searching user directory:"),console.error(e),this.setState({serverResultsMixin:[]})}),this.state.canUseIdentityServer){if(t.indexOf("@")>0&&f.a(t)){this.setState({threepidResultsMixin:[{user:new P(t),userId:t}]});try{const e=new b.a,s=await e.getAccessToken();if(t!==this.state.filterText)return;const n=await u.a.get().lookupThreePid("email",t,void 0,s);if(t!==this.state.filterText)return;if(!n||!n.mxid)return;const i=await u.a.get().getProfileInfo(n.mxid);if(t!==this.state.filterText||!i)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new j({user_id:n.mxid,display_name:i.displayname,avatar_url:i.avatar_url}),userId:n.mxid}]})}catch(e){console.error("Error searching identity server:"),console.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})},150)}),i()(this,"_showMoreRecents",()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})}),i()(this,"_showMoreSuggestions",()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})}),i()(this,"_toggleMember",e=>{let t=this.state.filterText;const s=this.state.targets.map(e=>e),n=s.indexOf(e);n>=0?s.splice(n,1):(s.push(e),t=""),this.setState({targets:s,filterText:t})}),i()(this,"_removeMember",e=>{const t=this.state.targets.map(e=>e),s=t.indexOf(e);s>=0&&(t.splice(s,1),this.setState({targets:t}))}),i()(this,"_onPaste",async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),s=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],n=[],i=[],o=t.split(/[\s,]+/).map(e=>e.trim()).filter(e=>!!e);for(const t of o){const o=s.find(e=>e.userId===t);if(o)n.push(o.user);else if(t.indexOf("@")>0&&f.a(t))n.push(new P(t));else if("@"===t[0])try{const e=await u.a.get().getProfileInfo(t),s=e?e.displayname:null,i=e?e.avatar_url:null;n.push(new j({user_id:t,display_name:s,avatar_url:i}))}catch(e){console.error("Error looking up profile for "+t),console.error(e),i.push(t)}else i.push(t)}if(i.length>0){const e=d.getComponent("dialogs.QuestionDialog");E.a.createTrackedDialog("Invite Paste Fail","",e,{title:Object(l.a)("Failed to find the following users"),description:Object(l.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:i.join(", ")}),button:Object(l.a)("OK")})}this.setState({targets:[...this.state.targets,...n]})}),i()(this,"_onClickInputArea",e=>{e.preventDefault(),e.stopPropagation(),this._editorRef&&this._editorRef.current&&this._editorRef.current.focus()}),i()(this,"_onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(_.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})}),i()(this,"_onManageSettingsClick",e=>{e.preventDefault(),y.a.fire(R.a.ViewUserSettings),this.props.onFinished()}),i()(this,"_onCommunityInviteClick",e=>{this.props.onFinished(),Object(w.e)(O.a.instance.getSelectedCommunityId())}),e.kind===x&&!e.roomId)throw new Error("When using KIND_INVITE a roomId is required for an InviteDialog");const t=new Set([u.a.get().getUserId(),p.a.get().welcomeUserId]);if(e.roomId){const s=u.a.get().getRoom(e.roomId);if(!s)throw new Error("Room ID given to InviteDialog does not look like a room");s.getMembersWithMembership("invite").forEach(e=>t.add(e.userId)),s.getMembersWithMembership("join").forEach(e=>t.add(e.userId)),s.getMembersWithMembership("ban").forEach(e=>t.add(e.userId))}this.state={targets:[],filterText:"",recents:U.buildRecents(t),numRecentsShown:3,suggestions:this._buildSuggestions(t),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!u.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,busy:!1,errorText:null},this._editorRef=Object(o.createRef)()}static buildRecents(e){const t=m.a.shared().getUniqueRoomsWithIndividuals(),s=I.b.instance.orderedLists[k.a.DM]||[],n=u.a.get().getUserId();for(const e of s){const s=e.getJoinedMembers().filter(e=>e.userId!==n);for(const n of s)t[n.userId]||(console.warn(`Adding DM room for ${n.userId} as ${e.roomId} from tag, not DM map`),t[n.userId]=e)}const i=[];for(const s in t){if(e.has(s)){console.warn(`[Invite:Recents] Excluding ${s} from recents`);continue}const n=t[s],o=n.getMember(s);if(!o){console.warn(`[Invite:Recents] ${s} is missing a member object in their own DM (${n.roomId})`);continue}const r=["m.room.message","m.room.encrypted","m.sticker"],a=20;let c=0;if(n.timeline&&n.timeline.length)for(let e=n.timeline.length-1;e>=0;e--){const t=n.timeline[e];if(r.includes(t.getType())){c=t.getTs();break}if(n.timeline.length-e>a)break}c?i.push({userId:s,user:o,lastActive:c}):console.warn(`[Invite:Recents] ${s} (${n.roomId}) has a weird last timestamp: ${c}`)}return i||console.warn("[Invite:Recents] No recents to suggest!"),i.sort((e,t)=>t.lastActive-e.lastActive),i}_buildSuggestions(e){const t=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()&&e.getJoinedMemberCount()<=200).reduce((t,s)=>{if(m.a.shared().getUserIdForRoomId(s.roomId))return t;const n=s.getJoinedMembers().filter(t=>!e.has(t.userId));for(const i of n)e.has(i.userId)||(t[i.userId]||(t[i.userId]={member:i,pickedMemberRoomSize:s.getJoinedMemberCount(),rooms:[]}),t[i.userId].rooms.push(s),s.getJoinedMemberCount()<t[i.userId].pickedMemberRoomSize&&(t[i.userId].member=i,t[i.userId].pickedMemberRoomSize=s.getJoinedMemberCount()));return t},{}),s=Object.values(t).reduce((e,t)=>{const s=t.rooms.reduce((e,t)=>e+t.getJoinedMemberCount(),0),n=200*t.rooms.length;return e[t.member.userId]={member:t.member,numRooms:t.rooms.length,score:Math.max(0,Math.pow(1-s/n,5))},e},{}),n=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()),i=(new Date).getTime(),o=i-36e5,r={},a={};for(const t of n){const s=m.a.shared().getUserIdForRoomId(t.roomId);if(Object.keys(t.tags).includes("m.lowpriority")||s)continue;const n=t.getLiveTimeline().getEvents();for(let s=n.length-1;s>=Math.max(0,n.length-50);s--){const i=n[s];if(!e.has(i.getSender())){if(i.getTs()<=o)break;(!r[i.getSender()]||r[i.getSender()]<i.getTs())&&(r[i.getSender()]=i.getTs(),a[i.getSender()]=t.getMember(i.getSender()))}}}for(const e in r){const t=r[e],n=a[e];if(!n)continue;const c=i-o-Math.abs(i-t),l=Math.max(1,c/9e5);let d=s[e];d||(d=s[e]={score:0}),d.member=n,d.score+=l}const c=Object.values(s);return c.sort((e,t)=>e.score===t.score?e.numRooms===t.numRooms?e.member.userId.localeCompare(t.member.userId):t.numRooms-e.numRooms:t.score-e.score),c.map(e=>({userId:e.member.userId,user:e.member}))}_shouldAbortAfterInviteError(e){const t=Object.keys(e.states).filter(t=>"error"===e.states[t]);return t.length>0&&(console.log("Failed to invite users: ",e),this.setState({busy:!1,errorText:Object(l.a)("Failed to invite the following users to chat: %(csvUsers)s",{csvUsers:t.join(", ")})}),!0)}_convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];let e;e=this.state.filterText.startsWith("@")?new j({user_id:this.state.filterText,display_name:null,avatar_url:null}):new P(this.state.filterText);const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}_renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,s="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const n="recents"===e?this._showMoreRecents.bind(this):this._showMoreSuggestions.bind(this);let i="recents"===e?Object(l.a)("Recent Conversations"):Object(l.a)("Suggestions"),o=null;if("suggestions"===e&&O.a.instance.getSelectedCommunityId()){const e=O.a.instance.getSelectedCommunityName();o=Object(l.a)("May include members not in %(communityName)s",{communityName:e})}this.props.kind===x&&(i="recents"===e?Object(l.a)("Recently Direct Messaged"):Object(l.a)("Suggestions"));let a=[],c=[];const u=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&u&&"suggestions"===e){const e=e=>!t.some(t=>t.userId===e.userId)&&!a.some(t=>t.userId===e.userId)&&!c.some(t=>t.userId===e.userId);c=this.state.serverResultsMixin.filter(e),a=this.state.threepidResultsMixin.filter(e)}const h=a.length>0||c.length>0;if(0===t.length&&!h)return null;if(this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter(t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e)),0===t.length&&!h)return r.a.createElement("div",{className:"mx_InviteDialog_section"},r.a.createElement("h3",null,i),r.a.createElement("p",null,Object(l.a)("No results")))}t=[...a,...t,...c],s===t.length-1&&s++;const m=t.slice(0,s),p=m.length<t.length,g=d.getComponent("elements.AccessibleButton");let f=null;p&&(f=r.a.createElement(g,{onClick:n,kind:"link"},Object(l.a)("Show more")));const _=m.map(t=>{return r.a.createElement(A,{member:t.user,lastActiveTs:(s=t,"recents"===e?s.lastActive:null),key:t.userId,onToggle:this._toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some(e=>e.userId===t.userId)});var s});return r.a.createElement("div",{className:"mx_InviteDialog_section"},r.a.createElement("h3",null,i),o?r.a.createElement("p",{className:"mx_InviteDialog_subname"},o):null,_,f)}_renderEditor(){const e=this.state.targets.map(e=>r.a.createElement(D,{member:e,onRemove:!this.state.busy&&this._removeMember,key:e.userId})),t=r.a.createElement("textarea",{rows:1,onKeyDown:this._onKeyDown,onChange:this._updateFilter,value:this.state.filterText,ref:this._editorRef,onPaste:this._onPaste,autoFocus:!0,disabled:this.state.busy});return r.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this._onClickInputArea},e,t)}_renderIdentityServerWarning(){if(!this.state.tryingIdentityServer||this.state.canUseIdentityServer)return null;const e=Object(_.c)();return e?r.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(v.a)(e)},{default:e=>r.a.createElement("a",{href:"#",onClick:this._onUseDefaultIdentityServerClick},e),settings:e=>r.a.createElement("a",{href:"#",onClick:this._onManageSettingsClick},e)})):r.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>r.a.createElement("a",{href:"#",onClick:this._onManageSettingsClick},e)}))}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.AccessibleButton"),s=d.getComponent("elements.Spinner");let n,i,o,a,c=null;this.state.busy&&(c=r.a.createElement(s,{w:20,h:20}));const m=u.a.get().getUserId();if(this.props.kind===T){if(n=Object(l.a)("Direct Messages"),i=Object(l.a)("Start a conversation with someone using their name, username (like <userId/>) or email address.",{},{userId:()=>r.a.createElement("a",{href:Object(h.g)(m),rel:"noreferrer noopener",target:"_blank"},m)}),O.a.instance.getSelectedCommunityId()){const e=O.a.instance.getSelectedCommunityName();i=Object(l.a)("Start a conversation with someone using their name, username (like <userId/>) or email address. This won't invite them to %(communityName)s. To invite someone to %(communityName)s, click <a>here</a>.",{communityName:e},{userId:()=>r.a.createElement("a",{href:Object(h.g)(m),rel:"noreferrer noopener",target:"_blank"},m),a:e=>r.a.createElement(t,{kind:"link",onClick:this._onCommunityInviteClick},e)})}o=Object(l.a)("Go"),a=this._startDm}else n=Object(l.a)("Invite to this room"),i=Object(l.a)("Invite someone using their name, username (like <userId/>), email address or <a>share this room</a>.",{},{userId:()=>r.a.createElement("a",{href:Object(h.g)(m),rel:"noreferrer noopener",target:"_blank"},m),a:e=>r.a.createElement("a",{href:Object(h.f)(this.props.roomId),rel:"noreferrer noopener",target:"_blank"},e)}),o=Object(l.a)("Invite"),a=this._inviteUsers;const p=this.state.targets.length>0||this.state.filterText&&this.state.filterText.includes("@");return r.a.createElement(e,{className:"mx_InviteDialog",hasCancel:!0,onFinished:this.props.onFinished,title:n},r.a.createElement("div",{className:"mx_InviteDialog_content"},r.a.createElement("p",{className:"mx_InviteDialog_helpText"},i),r.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this._renderEditor(),r.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},r.a.createElement(t,{kind:"primary",onClick:a,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!p},o),c)),this._renderIdentityServerWarning(),r.a.createElement("div",{className:"error"},this.state.errorText),r.a.createElement("div",{className:"mx_InviteDialog_userSections"},this._renderSection("recents"),this._renderSection("suggestions"))))}}i()(U,"propTypes",{onFinished:c.a.func.isRequired,kind:c.a.string,roomId:c.a.string}),i()(U,"defaultProps",{kind:T})},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(55);const i=window.localStorage;let o;try{o=window.indexedDB}catch(e){}function r(e){const t={useAuthorizationHeader:!0};return o&&i&&(t.store=new n.f({indexedDB:o,dbName:"riot-web-sync",localStorage:i,workerScript:r.indexedDbWorkerScript})),i&&(t.sessionStore=new n.o(i)),e=Object.assign(t,e),n.p(e)}r.indexedDbWorkerScript=null},function(e,t,s){"use strict";function n(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}}function i(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}}function o(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}}function r(e){return{msgtype:"m.text",body:e}}function a(e){return{msgtype:"m.notice",body:e}}function c(e){return{msgtype:"m.emote",body:e}}s.r(t),s.d(t,"makeHtmlMessage",(function(){return n})),s.d(t,"makeHtmlNotice",(function(){return i})),s.d(t,"makeHtmlEmote",(function(){return o})),s.d(t,"makeTextMessage",(function(){return r})),s.d(t,"makeNotice",(function(){return a})),s.d(t,"makeEmoteMessage",(function(){return c}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(0),i=s(190);function o(e){return"crypto.sessions/"+e}function r(e){return"crypto.session.problems/"+e}function a(e,t){return"crypto.inboundgroupsessions/"+e+"/"+t}function c(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function l(e){return"crypto.rooms/"+e}class d extends i.a{constructor(e){super(),this.store=e}static exists(e){const t=e.length;for(let s=0;s<t;s++)if(e.key(s).startsWith("crypto."))return!0;return!1}countEndToEndSessions(e,t){let s=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(o(""))&&++s;t(s)}_getEndToEndSessions(e,t,s){const n=u(this.store,o(e)),i={};for(const[e,t]of Object.entries(n||{}))i[e]="string"==typeof t?{session:t}:t;return i}getEndToEndSession(e,t,s,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,s){s(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(o(""))){const s=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(s)))t(e)}}storeEndToEndSession(e,t,s,n){const i=this._getEndToEndSessions(e)||{};i[t]=s,h(this.store,o(e),i)}async storeEndToEndSessionProblem(e,t,s){const n=r(e),i=u(this.store,n)||[];i.push({type:t,fixed:s,time:Date.now()}),i.sort((e,t)=>e.time-t.time),h(this.store,n,i)}async getEndToEndSessionProblem(e,t){const s=r(e),n=u(this.store,s)||[];if(!n.length)return null;const i=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=u(this.store,"crypto.notified_error_devices")||{},s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return h(this.store,"crypto.notified_error_devices",t),s}getEndToEndInboundGroupSession(e,t,s,n){n(u(this.store,a(e,t)),u(this.store,c(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const s=this.store.key(e);s.startsWith("crypto.inboundgroupsessions/")&&t({senderKey:s.substr("crypto.inboundgroupsessions/".length,43),sessionId:s.substr("crypto.inboundgroupsessions/".length+44),sessionData:u(this.store,s)})}t(null)}addEndToEndInboundGroupSession(e,t,s,n){u(this.store,a(e,t))||this.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){h(this.store,a(e,t),s)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){h(this.store,c(e,t),s)}getEndToEndDeviceData(e,t){t(u(this.store,"crypto.device_data"))}storeEndToEndDeviceData(e,t){h(this.store,"crypto.device_data",e)}storeEndToEndRoom(e,t,s){h(this.store,l(e),t)}getEndToEndRooms(e,t){const s={},n=l("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(n)){s[t.substr(n.length)]=u(this.store,t)}}t(s)}getSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{},s=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const t=n.substr(0,43),i=n.substr(44);if(this.getEndToEndInboundGroupSession(t,i,null,e=>{s.push({senderKey:t,sessionId:i,sessionData:e})}),e&&n.length>=e)break}return Promise.resolve(s)}countSessionsNeedingBackup(){const e=u(this.store,"crypto.sessionsneedingbackup")||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)delete t[s.senderKey+"/"+s.sessionId];return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}markSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)t[s.senderKey+"/"+s.sessionId]=!0;return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}deleteAllData(){return this.store.removeItem("crypto.account"),Promise.resolve()}getAccount(e,t){t(u(this.store,"crypto.account"))}storeAccount(e,t){h(this.store,"crypto.account",t)}getCrossSigningKeys(e,t){t(u(this.store,"crypto.cross_signing_keys"))}getSecretStorePrivateKey(e,t,s){t(u(this.store,"crypto.ssss_cache."+s))}storeCrossSigningKeys(e,t){h(this.store,"crypto.cross_signing_keys",t)}storeSecretStorePrivateKey(e,t,s){h(this.store,"crypto.ssss_cache."+t,s)}doTxn(e,t,s){return Promise.resolve(s(null))}}function u(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.a.log("Error: Failed to get key %s: %s",t,e.stack||e),n.a.log(e.stack)}return null}function h(e,t,s){e.setItem(t,JSON.stringify(s))}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return c}));var n=s(0),i=s(108),o=s(547);function r(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}function a(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={},this._olmPrekeyPromise=Promise.resolve()}a.prototype.init=async function(t={}){let s;const n=new e.Olm.Account,{pickleKey:o,fromExportedDevice:r}=t;try{r?(o&&console.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=r.pickleKey,await async function(e,t,s,n){await t.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],s=>{t.storeAccount(s,e.pickledAccount),e.sessions.forEach(e=>{const{deviceKey:n,sessionId:i}=e,o={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};t.storeEndToEndSession(n,i,o,s)})}),n.unpickle(s,e.pickledAccount)}(r,this._cryptoStore,this._pickleKey,n)):(o&&(this._pickleKey=o),await async function(e,t,s){await e.doTxn("readwrite",[i.a.STORE_ACCOUNT],n=>{e.getAccount(n,i=>{null!==i?s.unpickle(t,i):(s.create(),i=s.pickle(t),e.storeAccount(n,i))})})}(this._cryptoStore,this._pickleKey,n)),s=JSON.parse(n.identity_keys()),this._maxOneTimeKeys=n.max_number_of_one_time_keys()}finally{n.free()}this.deviceCurve25519Key=s.curve25519,this.deviceEd25519Key=s.ed25519},a.getOlmVersion=function(){return e.Olm.get_library_version()},a.prototype._getAccount=function(t,s){this._cryptoStore.getAccount(t,t=>{const n=new e.Olm.Account;try{n.unpickle(this._pickleKey,t),s(n)}finally{n.free()}})},a.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},a.prototype.export=async function(){const e={pickleKey:this._pickleKey};return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],t=>{this._cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this._cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e},a.prototype._getSession=function(e,t,s,n){this._cryptoStore.getEndToEndSession(e,t,s,e=>{this._unpickleSession(e,n)})},a.prototype._unpickleSession=function(t,s){const n=new e.Olm.Session;try{n.unpickle(this._pickleKey,t.session);s(Object.assign({},t,{session:n}))}finally{n.free()}},a.prototype._saveSession=function(e,t,s){const n=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,i,s)},a.prototype._getUtility=function(t){const s=new e.Olm.Utility;try{return t(s)}finally{s.free()}},a.prototype.sign=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT],s=>{this._getAccount(s,s=>{t=s.sign(e)})}),t},a.prototype.getOneTimeKeys=async function(){let e;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT],t=>{this._getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e},a.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},a.prototype.markKeysAsPublished=async function(){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT],e=>{this._getAccount(e,t=>{t.mark_keys_as_published(),this._storeAccount(e,t)})})},a.prototype.generateOneTimeKeys=function(e){return this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT],t=>{this._getAccount(t,s=>{s.generate_one_time_keys(e),this._storeAccount(t,s)})})},a.prototype.createOutboundSession=async function(t,s){let n;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],i=>{this._getAccount(i,o=>{const r=new e.Olm.Session;try{r.create_outbound(o,t,s),n=r.session_id(),this._storeAccount(i,o);const e={session:r,lastReceivedMessageTs:Date.now()};this._saveSession(t,e,i)}finally{r.free()}})}),n},a.prototype.createInboundSession=async function(t,s,n){if(0!==s)throw new Error("Need messageType == 0 to create inbound session");let o;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],i=>{this._getAccount(i,r=>{const a=new e.Olm.Session;try{a.create_inbound_from(r,t,n),r.remove_one_time_keys(a),this._storeAccount(i,r);const e=a.decrypt(s,n),c={session:a,lastReceivedMessageTs:Date.now()};this._saveSession(t,c,i),o={payload:e,session_id:a.session_id()}}finally{a.free()}})}),o},a.prototype.getSessionIdsForDevice=async function(e){if(this._sessionsInProgress[e]){n.a.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}let t;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],s=>{this._cryptoStore.getEndToEndSessions(e,s,e=>{t=Object.keys(e)})}),t},a.prototype.getSessionIdForDevice=async function(e,t){const s=await this.getSessionInfoForDevice(e,t);if(0===s.length)return null;let n=0;for(let e=1;e<s.length;e++){const t=s[e],i=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,o=s[n],r=void 0===o.lastReceivedMessageTs?0:o.lastReceivedMessageTs;(i>r||i===r&&t.sessionId<o.sessionId)&&(n=e)}return s[n].sessionId},a.prototype.getSessionInfoForDevice=async function(e,t){if(this._sessionsInProgress[e]&&!t){n.a.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}const s=[];return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],t=>{this._cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const n of t)this._unpickleSession(e[n],e=>{s.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})})})}),s},a.prototype.encryptMessage=async function(e,t,s){let o;return r(s),await this._cryptoStore.doTxn("readwrite",[i.a.STORE_SESSIONS],i=>{this._getSession(e,t,i,r=>{const a=r.session.describe();n.a.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),o=r.session.encrypt(s),this._saveSession(e,r,i)})}),o},a.prototype.decryptMessage=async function(e,t,s,o){let r;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_SESSIONS],i=>{this._getSession(e,t,i,a=>{const c=a.session.describe();n.a.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),r=a.session.decrypt(s,o),a.lastReceivedMessageTs=Date.now(),this._saveSession(e,a,i)})}),r},a.prototype.matchesSession=async function(e,t,s,n){if(0!==s)return!1;let o;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],s=>{this._getSession(e,t,s,e=>{o=e.session.matches_inbound(n)})}),o},a.prototype.recordSessionProblem=async function(e,t,s){await this._cryptoStore.storeEndToEndSessionProblem(e,t,s)},a.prototype.sessionMayHaveProblems=async function(e,t){return await this._cryptoStore.getEndToEndSessionProblem(e,t)},a.prototype.filterOutNotifiedErrorDevices=async function(e){return await this._cryptoStore.filterOutNotifiedErrorDevices(e)},a.prototype._saveOutboundGroupSession=function(e){const t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},a.prototype._getOutboundGroupSession=function(t,s){const n=this._outboundGroupSessionStore[t];if(void 0===n)throw new Error("Unknown outbound group session "+t);const i=new e.Olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,n),s(i)}finally{i.free()}},a.prototype.createOutboundGroupSession=function(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this._saveOutboundGroupSession(t),t.session_id()}finally{t.free()}},a.prototype.encryptGroupMessage=function(e,t){const s=this;return n.a.log("encrypting msg with megolm session "+e),r(t),this._getOutboundGroupSession(e,(function(e){const n=e.encrypt(t);return s._saveOutboundGroupSession(e),n}))},a.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},a.prototype._unpickleInboundGroupSession=function(t,s){const n=new e.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,t.session),s(n)}finally{n.free()}},a.prototype._getInboundGroupSession=function(e,t,s,n,i){this._cryptoStore.getEndToEndInboundGroupSession(t,s,n,(t,s)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this._unpickleInboundGroupSession(t,e=>{i(e,t,s)})}else i(null,null,s)})},a.prototype.addInboundGroupSession=async function(t,s,o,r,a,c,l,d={}){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(t,s,r,i,(u,h)=>{const m=new e.Olm.InboundGroupSession;try{if(l?m.import_session(a):m.create(a),r!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+s);if(u&&(n.a.log("Update for megolm session "+s+"/"+r),u.first_known_index()<=m.first_known_index()))return void n.a.log("Keeping existing megolm session "+r);n.a.info("Storing megolm session "+s+"/"+r+" with first index "+m.first_known_index());const e=Object.assign({},d,{room_id:t,session:m.pickle(this._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:o});this._cryptoStore.storeEndToEndInboundGroupSession(s,r,e,i)}finally{m.free()}})})},a.prototype.addInboundGroupSessionWithheld=async function(e,t,s,n,o){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,s,{room_id:e,code:n,reason:o},i)})};const c={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function l(e){return e.code&&e.code in c?c[e.code]:e.reason?e.reason:"decryption key withheld"}a.prototype.decryptGroupMessage=async function(e,t,s,n,r,a){let c,d;if(await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,s,i,(e,u,h)=>{if(null===e)return h&&(d=new o.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+s})),void(c=null);let m;try{m=e.decrypt(n)}catch(e){return void(d=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new o.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+s}):e)}let p=m.plaintext;if(void 0===p)p=m;else{const e=t+"|"+s+"|"+m.message_index;if(e in this._inboundGroupSessionMessageIndexes){const t=this._inboundGroupSessionMessageIndexes[e];if(t.id!==r||t.timestamp!==a)return void(d=new Error("Duplicate message index, possible replay attack: "+e))}this._inboundGroupSessionMessageIndexes[e]={id:r,timestamp:a}}u.session=e.pickle(this._pickleKey),this._cryptoStore.storeEndToEndInboundGroupSession(t,s,u,i),c={result:p,keysClaimed:u.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:u.forwardingCurve25519KeyChain||[],untrusted:u.untrusted}})}),d)throw d;return c},a.prototype.hasInboundSessionKeys=async function(e,t,s){let o;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.getEndToEndInboundGroupSession(t,s,i,i=>{null!==i?e!==i.room_id?(n.a.warn(`requested keys for inbound group session ${t}|`+s+", with incorrect room_id "+`(expected ${i.room_id}, `+`was ${e})`),o=!1):o=!0:o=!1})}),o},a.prototype.getInboundGroupSessionKey=async function(e,t,s,n){let o;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,s,i,(e,t)=>{if(null===e)return void(o=null);void 0===n&&(n=e.first_known_index());const s=e.export_session(n),i=(t.keysClaimed||{}).ed25519||null;o={chain_index:n,key:s,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:i}})}),o},a.prototype.exportInboundGroupSession=function(e,t,s){return this._unpickleInboundGroupSession(s,n=>{const i=n.first_known_index();return{sender_key:e,sender_claimed_keys:s.keysClaimed,room_id:s.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index()}})},a.prototype.verifySignature=function(e,t,s){this._getUtility((function(n){n.ed25519_verify(e,t,s)}))}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(107);s(0);const i=function(){};function o(e,t,s){s=s||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=s.windowLimit||1e3}function r(e,t){this.timeline=e,this.index=t}o.prototype.load=function(e,t){const s=this;t=t||20;const n=function(n){let i;const o=n.getEvents();if(e){for(let t=0;t<o.length;t++)if(o[t].getId()==e){i=t;break}if(void 0===i)throw new Error("getEventTimeline result didn't include requested event")}else i=o.length;const a=Math.min(o.length,i+Math.ceil(t/2)),c=Math.max(0,a-t);s._start=new r(n,c-n.getBaseIndex()),s._end=new r(n,a-n.getBaseIndex()),s._eventCount=a-c};if(e){const t=this._timelineSet.getTimelineForEvent(e);if(t)return n(t),Promise.resolve(t);return this._client.getEventTimeline(this._timelineSet,e).then(n)}return n(this._timelineSet.getLiveTimeline()),Promise.resolve()},o.prototype.getTimelineIndex=function(e){if(e==n.a.BACKWARDS)return this._start;if(e==n.a.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},o.prototype.extend=function(e,t){const s=this.getTimelineIndex(e);if(!s)return i("TimelineWindow: no timeline yet"),!1;const o=e==n.a.BACKWARDS?s.retreat(t):s.advance(t);if(o){this._eventCount+=o,i("TimelineWindow: increased cap by "+o+" (now "+this._eventCount+")");const t=this._eventCount-this._windowLimit;return t>0&&this.unpaginate(t,e!=n.a.BACKWARDS),!0}return!1},o.prototype.canPaginate=function(e){const t=this.getTimelineIndex(e);if(!t)return i("TimelineWindow: no timeline yet"),!1;if(e==n.a.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},o.prototype.paginate=function(e,t,s,o){void 0===s&&(s=!0),void 0===o&&(o=5);const r=this.getTimelineIndex(e);if(!r)return i("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(r.pendingPaginate)return r.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!s||0===o)return Promise.resolve(!1);if(!r.timeline.getPaginationToken(e))return i("TimelineWindow: no token"),Promise.resolve(!1);i("TimelineWindow: starting request");const a=this,c=this._client.paginateEventTimeline(r.timeline,{backwards:e==n.a.BACKWARDS,limit:t}).finally((function(){r.pendingPaginate=null})).then((function(s){return i("TimelineWindow: request completed with result "+s),!!s&&a.paginate(e,t,!0,o-1)}));return r.pendingPaginate=c,c},o.prototype.unpaginate=function(e,t){const s=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){const n=t?s.advance(e):s.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,i("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},o.prototype.getEvents=function(){if(!this._start)return[];const e=[];let t=this._start.timeline;for(;;){const s=t.getEvents();let i=0,o=s.length;t===this._start.timeline&&(i=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(let t=i;t<o;t++)e.push(s[t]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(n.a.FORWARDS)}return e},r.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},r.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},r.prototype.advance=function(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const s=this.timeline.getNeighbouringTimeline(e<0?n.a.BACKWARDS:n.a.FORWARDS);return s?(this.timeline=s,this.index=e<0?this.maxIndex():this.minIndex(),i("paginate: switched to new neighbour"),this.advance(e)):0},r.prototype.retreat=function(e){return-1*this.advance(-1*e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(66),i=s.n(n),o=s(1),r=s(0);function a(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}a.prototype={attemptAuth:function(){return new Promise((e,t)=>{this._resolveFunc=e,this._rejectFunc=t;if(this._data&&this._data.flows)this._startNextAuthStage();else{this._busyChangedCallback&&this._busyChangedCallback(!0);let e=null;this._data.session&&(e={session:this._data.session}),this._doRequest(e).finally(()=>{this._busyChangedCallback&&this._busyChangedCallback(!1)})}})},poll:async function(){if(!this._data.session)return;if(!this._resolveFunc)return;if(this._submitPromise)return;let e={};if("m.login.email.identity"==this._currentStage&&this._emailSid){const t={sid:this._emailSid,client_secret:this._clientSecret};if(await this._matrixClient.doesServerRequireIdServerParam()){const e=i.a.parse(this._matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){let t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow(){return this._chosenFlow},submitAuthDict:async function(e,t){if(!this._resolveFunc)throw new Error("submitAuthDict() called before attemptAuth()");for(!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);this._submitPromise;)try{await this._submitPromise}catch(e){}let s;this._data.session?(s={session:this._data.session},o.i(s,e)):s=e;try{this._submitPromise=this._doRequest(s,t),await this._submitPromise}finally{this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1)}},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:async function(e,t){try{const s=await this._requestCallback(e,t);this._resolveFunc(s),this._resolveFunc=null,this._rejectFunc=null}catch(e){const s=e.data?e.data.flows:null,n=this._data.flows||Boolean(s);401===e.httpStatus&&e.data&&n||(t?r.a.log("Background poll request failed doing UI auth: ignoring",e):this._rejectFunc(e)),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this._data.flows,e.data.completed=this._data.completed,e.data.session=this._data.session),this._data=e.data;try{this._startNextAuthStage()}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}if(!this._emailSid&&!this._requestingEmailToken&&this._chosenFlow.stages.includes("m.login.email.identity")){this._requestingEmailToken=!0;try{const e=await this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);this._emailSid=e.sid}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}finally{this._requestingEmailToken=!1}}}},_startNextAuthStage:function(){const e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"===e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data&&this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),r.a.log("Active flow => %s",JSON.stringify(this._chosenFlow));const e=this._firstUncompletedStage(this._chosenFlow);return r.a.log("Next stage: %s",e),e},_chooseFlow:function(){const e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),s=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber);for(const n of e){let e=!1,i=!1;for(const t of n.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(i=!0);if(e==t&&i==s)return n}const n=new Error("No appropriate authentication flow found");throw n.name="NoAuthFlowFoundError",n.required_stages=[],t&&n.required_stages.push("m.login.email.identity"),s&&n.required_stages.push("m.login.msisdn"),n.available_flows=e,n},_firstUncompletedStage:function(e){const t=(this._data||{}).completed||[];for(let s=0;s<e.stages.length;++s){const n=e.stages[s];if(-1===t.indexOf(n))return n}}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return u}));var n=s(189),i=s(1),o=s(10),r=s(16),a=s(590),c=s(133),l=s(81),d=s(0);function u(t){if(n.a.call(this,t),!t.indexedDB)throw new Error("Missing required option: indexedDB");if(t.workerScript){let s=t.workerApi;s||(s=e.Worker),this.backend=new a.a(t.workerScript,t.dbName,s)}else this.backend=new r.a(t.indexedDB,t.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function h(e,t){return async function(...s){try{return await e.call(this,...s)}catch(e){d.a.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emit("degraded",e);try{d.a.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),d.a.log("IndexedDBStore delete after degrading succeeeded")}catch(e){d.a.warn("IndexedDBStore delete after degrading failed",e)}if(Object.setPrototypeOf(this,n.a.prototype),t)return await n.a.prototype[t].call(this,...s)}}}i.o(u,n.a),i.i(u.prototype,o.EventEmitter.prototype),u.exists=function(e,t){return r.a.exists(e,t)},u.prototype.startup=function(){return this.startedUp?(d.a.log("IndexedDBStore.startup: already started"),Promise.resolve()):(d.a.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(d.a.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{d.a.log("IndexedDBStore.startup: processing presence events"),e.forEach(([e,t])=>{const s=new c.a(e);t&&s.setPresenceEvent(new l.b(t)),this._userModifiedMap[s.userId]=s.getLastModifiedTime(),this.storeUser(s)})}))},u.prototype.getSavedSync=h((function(){return this.backend.getSavedSync()}),"getSavedSync"),u.prototype.isNewlyCreated=h((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),u.prototype.getSavedSyncToken=h((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),u.prototype.deleteAllData=h((function(){return n.a.prototype.deleteAllData.call(this),this.backend.clearDatabase().then(()=>{d.a.log("Deleted indexeddb data.")},e=>{throw d.a.error("Failed to delete indexeddb data: "+e),e})})),u.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},u.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},u.prototype._reallySave=h((function(){this._syncTs=Date.now();const e=[];for(const t of this.getUsers())this._userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this._userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),u.prototype.setSyncData=h((function(e){return this.backend.setSyncData(e)}),"setSyncData"),u.prototype.getOutOfBandMembers=h((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),u.prototype.setOutOfBandMembers=h((function(e,t){return n.a.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),u.prototype.clearOutOfBandMembers=h((function(e){return n.a.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),u.prototype.getClientOptions=h((function(){return this.backend.getClientOptions()}),"getClientOptions"),u.prototype.storeClientOptions=h((function(e){return n.a.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1);s(0);const i="session.e2e.";function o(e){if(this.store=e,!(n.q(e.getItem)&&n.q(e.setItem)&&n.q(e.removeItem)&&n.q(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}o.prototype={removeEndToEndAccount:function(){this.store.removeItem(r)},getEndToEndAccount:function(){return this.store.getItem(r)},getAllEndToEndDevices:function(){const e=d(""),t={};for(let s=0;s<this.store.length;++s){const n=this.store.key(s),i=n.substr(e.length);n.startsWith(e)&&(t[i]=m(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return m(this.store,c)},getEndToEndDeviceSyncToken:function(){return m(this.store,a)},removeEndToEndDeviceData:function(){g(this.store,d("")),g(this.store,c),g(this.store,a)},getEndToEndSessions:function(e){return m(this.store,u(e))},getAllEndToEndSessions:function(){const e=p(this.store,u("")),t={};for(const s of e){t[s.substr(u("").length)]=m(this.store,s)}return t},removeAllEndToEndSessions:function(){g(this.store,u(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=i+"inboundgroupsessions/",t=[];for(let s=0;s<this.store.length;s++){const n=this.store.key(s);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const s=function(e,t){return i+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(s)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,i+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=p(this.store,h("")),t={};for(const s of e){t[s.substr(h("").length)]=m(this.store,s)}return t},removeAllEndToEndRooms:function(){g(this.store,h(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(l,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(l)}};const r=i+"account",a=i+"device_sync_token",c=i+"device_tracking",l=i+"trusted_backup_pubkey";function d(e){return i+"devices/"+e}function u(e){return i+"sessions/"+e}function h(e){return i+"rooms/"+e}function m(e,t){try{return JSON.parse(e.getItem(t))}catch(e){f("Failed to get key %s: %s",t,e),f(e.stack)}return null}function p(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}return s}function g(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}for(const t of s)e.removeItem(t)}function f(){0}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(46),c=s(45),l=s.n(c),d=s(44);class u extends r.a.Component{constructor(...e){super(...e),i()(this,"state",{component:null,error:null}),i()(this,"_onWrapperCancelClick",()=>{this.props.onFinished(!1)})}componentDidMount(){this._unmounted=!1,console.log("Starting load of AsyncWrapper for modal"),this.props.prom.then(e=>{if(this._unmounted)return;const t=e.default?e.default:e;this.setState({component:t})}).catch(e=>{console.warn("AsyncWrapper promise failed",e),this.setState({error:e})})}componentWillUnmount(){this._unmounted=!0}render(){if(this.state.component){const e=this.state.component;return r.a.createElement(e,this.props)}if(this.state.error){const e=a.getComponent("views.dialogs.BaseDialog"),t=a.getComponent("views.elements.DialogButtons");return r.a.createElement(e,{onFinished:this.props.onFinished,title:Object(d.a)("Error")},Object(d.a)("Unable to load! Check your network connectivity and try again."),r.a.createElement(t,{primaryButton:Object(d.a)("Dismiss"),onPrimaryButtonClick:this._onWrapperCancelClick,hasCancel:!1}))}{const e=a.getComponent("elements.Spinner");return r.a.createElement(e,null)}}}i()(u,"propTypes",{prom:l.a.object.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(52);const d=e=>{let{label:t,isExpanded:s,children:n,onClick:o,onContextMenu:a}=e,d=r()(e,["label","isExpanded","children","onClick","onContextMenu"]);return c.a.createElement(l.a,i()({},d,{onClick:o,onContextMenu:a||o,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":s}),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(68);const d=e=>{let{isExpanded:t,children:s,onClick:n,onContextMenu:o}=e,a=r()(e,["isExpanded","children","onClick","onContextMenu"]);return c.a.createElement(l.a,i()({},a,{onClick:n,onContextMenu:o||n,"aria-haspopup":!0,"aria-expanded":t}),s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a);const l=e=>{let{children:t,label:s}=e,n=r()(e,["children","label"]);return c.a.createElement("div",i()({},n,{role:"group","aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(52);const d=e=>{let{children:t,label:s}=e,n=r()(e,["children","label"]);const o=n["aria-label"]||s;return c.a.createElement(l.a,i()({},n,{role:"menuitem",tabIndex:-1,"aria-label":o}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(52);const d=e=>{let{children:t,label:s,active:n,disabled:o}=e,a=r()(e,["children","label","active","disabled"]);return c.a.createElement(l.a,i()({},a,{role:"menuitemcheckbox","aria-checked":n,"aria-disabled":o,disabled:o,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(52);const d=e=>{let{children:t,label:s,active:n,disabled:o}=e,a=r()(e,["children","label","active","disabled"]);return c.a.createElement(l.a,i()({},a,{role:"menuitemradio","aria-checked":n,"aria-disabled":o,disabled:o,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(58),d=s(94);const u=e=>{let{children:t,label:s,onChange:n,onClose:o}=e,a=r()(e,["children","label","onChange","onClose"]);return c.a.createElement(d.a,i()({},a,{role:"menuitemcheckbox",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&o())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(56),i=s.n(n),o=s(60),r=s.n(o),a=s(43),c=s.n(a),l=s(58),d=s(195);const u=e=>{let{children:t,label:s,onChange:n,onClose:o}=e,a=r()(e,["children","label","onChange","onClose"]);return c.a.createElement(d.a,i()({},a,{role:"menuitemradio",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&o())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){var n=s(2),i=s.n(n),o=s(48),r=s(10),a=s.n(r),c=s(63),l=s(50),d=s(89),u=s(131),h=s(71),m=s(11);function p(e,t){const s=Math.min(e.length,t.length);let n;for(let i=0;i<s;++i)if(e.charAt(i)!==t.charAt(i)){n=e.substr(0,i);break}void 0===n&&(n=e.substr(0,s));const i=n.indexOf(" ");return-1!==i&&(n=n.substr(0,i+1)),n.length>=2?n:""}class g extends a.a{constructor(){super(),i()(this,"_onListsUpdated",()=>{const e=this._getUpdatedTags();this._state.tags&&!Object(m.c)(this._state.tags,e)||this._setState({tags:e})}),this._state={tags:{}},this._getUpdatedTags=Object(c.throttle)(this._getUpdatedTags,500,{leading:!0,trailing:!0}),d.b.instance.on(d.a,this._onListsUpdated),o.a.register(e=>this._onDispatch(e))}getTags(){return this._state.tags}_setState(e){this._state=Object.assign(this._state,e),this.emit("change")}addListener(e){return this.on("change",e),{remove:()=>{this.removeListener("change",e)}}}getSortedTags(){const e=Object.keys(this._state.tags).sort(),t=e.map((t,s)=>{const n=0===s,i=s===e.length-1,o=n?"":p(t,e[s-1]),r=i?"":p(t,e[s+1]);return o.length>r.length?o:r});return e.map((e,s)=>{const n=u.a.instance.getListState(e);let i;n.hasUnreadCount&&(i=n);const o=e.substr(t[s].length,1);return{name:e,avatarLetter:o,badgeNotifState:i,selected:this._state.tags[e]}})}_onDispatch(e){switch(e.action){case"select_custom_room_tag":{const t=this._state.tags;if(t.hasOwnProperty(e.tag)){const s={};s[e.tag]=!t[e.tag];const n=Object.assign({},t,s);this._setState({tags:n})}}break;case"on_client_not_viable":case"on_logged_out":this._state={tags:{}},d.b.instance.off(d.a,this._onListsUpdated)}}_getUpdatedTags(){if(!l.a.getValue("feature_custom_tags"))return{};const e=Object.keys(d.b.instance.orderedLists).filter(e=>Object(h.d)(e)).sort(),t=this._state&&this._state.tags;return e.reduce((e,s)=>(e[s]=t&&t[s]||!1,e),{})}}void 0===e.singletonCustomRoomTagStore&&(e.singletonCustomRoomTagStore=new g),t.a=e.singletonCustomRoomTagStore}).call(this,s(6))},function(e,t,s){"use strict";function n(e){return Object.keys(e).filter(t=>["string","number"].includes(typeof e[t])).map(t=>e[t])}function i(e,t){return n(e).includes(t)}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},function(e,t,s){"use strict";function n(e,t){const s=t.getUserId();for(const t of Object.keys(e.getContent())){if(Object.keys(e.getContent()[t]["m.read"]||{}).includes(s))return!0}}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));const n=new Map;function i(e,t){n.set(e,t)}function o(e){return n.get(e)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return a}));var n=s(47),i=s(202),o=(s(46),s(141));function r(e){return(!e.sender||e.sender.userId!=n.a.get().credentials.userId)&&("m.room.member"!=e.getType()&&("m.room.third_party_invite"!=e.getType()&&("m.call.answer"!=e.getType()&&"m.call.hangup"!=e.getType()&&(("m.room.message"!=e.getType()||"m.notify"!=e.getContent().msgtype)&&("m.room.aliases"!=e.getType()&&"m.room.canonical_alias"!=e.getType()&&("m.room.server_acl"!=e.getType()&&Object(o.b)(e)))))))}function a(e){const t=n.a.get().credentials.userId,s=e.getEventReadUpTo(t);if(e.timeline.length&&e.timeline[e.timeline.length-1].sender&&e.timeline[e.timeline.length-1].sender.userId===t)return!1;for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getId()==s)return!1;if(!Object(i.a)(n)&&r(n))return!0}return!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(314);const i="https://matrix.to";class o extends n.b{constructor(){super()}forEvent(e,t,s){return`${i}/#/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${i}/#/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${i}/#/${e}`}forGroup(e){return`${i}/#/${e}`}forEntity(e){return`${i}/#/${e}`}isPermalinkHost(e){return"matrix.to"===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(i))throw new Error("Does not appear to be a permalink");const t=e.substring((i+"/#/").length).split("/"),s=t[0];if("@"===s[0])return n.a.forUser(s);if("+"===s[0])return n.a.forGroup(s);if("#"===s[0]||"!"===s[0]){if(1===t.length){const[e,t=""]=s.split("?"),i=t.split(/&?via=/g).filter(e=>!!e);return n.a.forRoom(e,i)}const e=t.length>1?t.slice(1).join("/"):"",[i,o=""]=e.split("?"),r=o.split(/&?via=/g).filter(e=>!!e);return n.a.forEvent(s,i,r)}throw new Error("Unknown entity type in permalink")}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(44),u=s(48),h=s(58);class m extends r.a.Component{constructor(...e){super(...e),i()(this,"onKeyDown",e=>{e.key===h.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),i()(this,"onAction",e=>{"close_scalar"===e.action&&this.props.onFinished()})}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){u.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){if(this.props.loading){const e=l.getComponent("elements.Spinner");return r.a.createElement("div",{className:"mx_IntegrationManager_loading"},r.a.createElement("h3",null,Object(d.a)("Connecting to integration manager...")),r.a.createElement(e,null))}return this.props.connected?r.a.createElement("iframe",{src:this.props.url}):r.a.createElement("div",{className:"mx_IntegrationManager_error"},r.a.createElement("h3",null,Object(d.a)("Cannot connect to integration manager")),r.a.createElement("p",null,Object(d.a)("The integration manager is offline or it cannot reach your homeserver.")))}}i()(m,"propTypes",{connected:c.a.bool.isRequired,loading:c.a.bool.isRequired,url:c.a.string,onFinished:c.a.func.isRequired}),i()(m,"defaultProps",{connected:!0,loading:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(53),u=s(46);class h extends r.a.Component{constructor(...e){super(...e),i()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()})}render(){const e=d.a.get().brand,t=u.getComponent("views.dialogs.BaseDialog"),s=u.getComponent("views.elements.DialogButtons");return r.a.createElement(t,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(l.a)("Integrations not allowed")},r.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},r.a.createElement("p",null,Object(l.a)("Your %(brand)s doesn't allow you to use an Integration Manager to do this. Please contact an admin.",{brand:e}))),r.a.createElement(s,{primaryButton:Object(l.a)("OK"),onPrimaryButtonClick:this._onAcknowledgeClick,hasCancel:!1}))}}i()(h,"propTypes",{onFinished:c.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(93),d=s(55),u=s(46),h=s(203),m=s(51),p=s.n(m),g=s(439);class f extends r.a.Component{constructor(e){super(e),i()(this,"openManager",async(e,t=!1)=>{if(e===this.state.currentIndex&&!t)return;const s=this.state.managers[e],n=s.getScalarClient();this.setState({busy:!0,currentIndex:e,currentLoading:!0,currentConnected:!1,currentScalarClient:n}),g.a(s.uiUrl),n.setTermsInteractionCallback((e,t)=>Object(h.c)(e,t,"mx_TermsDialog_forIntegrationManager"));try{await n.connect(),n.hasCredentials()?this.setState({busy:!1,currentLoading:!1,currentConnected:!0}):this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}catch(e){if(e instanceof h.b)return;console.error(e),this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}}),this.state={managers:l.a.sharedInstance().getOrderedManagers(),busy:!0,currentIndex:0,currentConnected:!1,currentLoading:!0,currentScalarClient:null}}componentDidMount(){this.openManager(0,!0)}_renderTabs(){const e=u.getComponent("views.elements.AccessibleButton");return this.state.managers.map((t,s)=>{const n=p()({mx_TabbedIntegrationManagerDialog_tab:!0,mx_TabbedIntegrationManagerDialog_currentTab:this.state.currentIndex===s});return r.a.createElement(e,{className:n,onClick:()=>this.openManager(s),key:"tab_"+s,disabled:this.state.busy},t.name)})}_renderTab(){const e=u.getComponent("views.settings.IntegrationManager");let t=null;return this.state.currentScalarClient&&(t=this.state.currentScalarClient.getScalarInterfaceUrlForRoom(this.props.room,this.props.screen,this.props.integrationId)),r.a.createElement(e,{configured:!0,loading:this.state.currentLoading,connected:this.state.currentConnected,url:t,onFinished:()=>{}})}render(){return r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_container"},r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_tabs"},this._renderTabs()),r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_currentManager"},this._renderTab()))}}i()(f,"propTypes",{onFinished:c.a.func.isRequired,room:c.a.instanceOf(d.j),screen:c.a.string,integrationId:c.a.string})},function(e,t,s){"use strict";s.d(t,"b",(function(){return b})),s.d(t,"c",(function(){return E})),s.d(t,"a",(function(){return S}));var n=s(47),i=s(55),o=s(48),r=s(76),a=s(74),c=s(44),l=s(93),d=s(102),u=s(11);function h(e,t){const s=Object(u.a)(e.data);s.response=t,e.source.postMessage(s,e.origin)}function m(e,t,s){console.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(u.a)(e.data);n.response={error:{message:t}},s&&(n.response.error._error=s),e.source.postMessage(n,e.origin)}function p(e,t){const s=e.data.widget_id;let n=e.data.type;const i=e.data.url,a=e.data.name,l=e.data.data,u=e.data.userWidget;if(s&&void 0!==i){if(null!==i){if(void 0!==a&&"string"!=typeof a)return void m(e,Object(c.a)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==l&&!(l instanceof Object))return void m(e,Object(c.a)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if("string"!=typeof n)return void m(e,Object(c.a)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof i)return void m(e,Object(c.a)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}n=d.a.fromString(n),u?r.a.setUserWidget(s,n,i,a,l).then(()=>{h(e,{success:!0}),o.a.dispatch({action:"user_widget_updated"})}).catch(t=>{m(e,Object(c.a)("Unable to create widget."),t)}):(t||m(e,Object(c.a)("Missing roomId."),null),r.a.setRoomWidget(t,s,n,i,a,l).then(()=>{h(e,{success:!0})},t=>{m(e,Object(c.a)("Failed to send request."),t)}))}else m(e,Object(c.a)("Unable to create widget."),new Error("Missing required widget fields."))}function g(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));let i=[];if(t){const n=s.getRoom(t);if(!n)return void m(e,Object(c.a)("This room is not recognised."));i=r.a.getRoomWidgets(n).map(e=>e.event)}const o=r.a.getUserWidgetsArray();i=i.concat(o),h(e,i)}function f(e,t,s,i){const o=n.a.get();if(!o)return void m(e,Object(c.a)("You need to be logged in."));const r=o.getRoom(t);if(!r)return void m(e,Object(c.a)("This room is not recognised."));const a=r.currentState.getStateEvents(s,i);h(e,a?a.getContent():null)}const _=function(e){let t,s;e.origin||(e.origin=e.originalEvent.origin);try{y||(y=l.a.sharedInstance().getPrimaryManager().uiUrl),t=new URL(y)}catch(e){return}try{s=new URL(e.origin)}catch(e){return}if(t.origin!==s.origin||!e.data.action||e.data.api)return;if("close_scalar"===e.data.action)return o.a.dispatch({action:"close_scalar"}),void h(e,null);const r=e.data.room_id,d=e.data.user_id;if(!r)return"get_widgets"===e.data.action?void g(e,null):"set_widget"===e.data.action?void p(e,null):void m(e,Object(c.a)("Missing room_id in request"));if(r===a.a.getRoomId())if("get_widgets"!==e.data.action)if("set_widget"!==e.data.action)if("join_rules_state"!==e.data.action)if("set_plumbing_state"!==e.data.action)if("get_membership_count"!==e.data.action)if("get_room_enc_state"!==e.data.action)if("can_send_event"!==e.data.action)if(d)switch(e.data.action){case"membership_state":!function(e,t,s){console.log(`membership_state of ${s} in room ${t} requested.`),f(e,t,"m.room.member",s)}(e,r,d);break;case"invite":!function(e,t,s){console.log(`Received request to invite ${s} into room ${t}`);const i=n.a.get();if(!i)return void m(e,Object(c.a)("You need to be logged in."));const o=i.getRoom(t);if(o){const t=o.getMember(s);if(t&&"invite"===t.membership)return void h(e,{success:!0})}i.invite(t,s).then((function(){h(e,{success:!0})}),(function(t){m(e,Object(c.a)("You need to be able to invite users to do that."),t)}))}(e,r,d);break;case"bot_options":!function(e,t,s){console.log(`bot_options of ${s} in room ${t} requested.`),f(e,t,"m.room.bot.options","_"+s)}(e,r,d);break;case"set_bot_options":!function(e,t,s){console.log(`Received request to set options for bot ${s} in room ${t}`);const i=n.a.get();i?i.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+s).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)}):m(e,Object(c.a)("You need to be logged in."))}(e,r,d);break;case"set_bot_power":!function(e,t,s,o){if(!(Number.isInteger(o)&&o>=0))return void m(e,Object(c.a)("Power level must be positive integer."));console.log(`Received request to set power level to ${o} for bot ${s} in room ${t}.`);const r=n.a.get();r?r.getStateEvent(t,"m.room.power_levels","").then(n=>{const a=new i.i({type:"m.room.power_levels",content:n});r.setPowerLevel(t,s,o,a).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)})}):m(e,Object(c.a)("You need to be logged in."))}(e,r,d,e.data.level);break;default:console.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else m(e,Object(c.a)("Missing user_id in request"));else!function(e,t){const s=""+e.data.event_type,i=Boolean(e.data.is_state),o=n.a.get();if(!o)return void m(e,Object(c.a)("You need to be logged in."));const r=o.getRoom(t);if(!r)return void m(e,Object(c.a)("This room is not recognised."));if("join"!==r.getMyMembership())return void m(e,Object(c.a)("You are not in this room."));const a=o.credentials.userId;let l=!1;l=i?r.currentState.maySendStateEvent(s,a):r.currentState.maySendEvent(s,a),l?h(e,!0):m(e,Object(c.a)("You do not have permission to do that in this room."))}(e,r);else!function(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));if(!s.getRoom(t))return void m(e,Object(c.a)("This room is not recognised."));h(e,n.a.get().isRoomEncrypted(t))}(e,r);else!function(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));const i=s.getRoom(t);if(!i)return void m(e,Object(c.a)("This room is not recognised."));h(e,i.getJoinedMemberCount())}(e,r);else!function(e,t,s){if("string"!=typeof s)throw new Error("Plumbing state status should be a string");console.log(`Received request to set plumbing state to status "${s}" in room ${t}`);const i=n.a.get();i?i.sendStateEvent(t,"m.room.plumbing",{status:s}).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)}):m(e,Object(c.a)("You need to be logged in."))}(e,r,e.data.status);else!function(e,t){console.log(`join_rules of ${t} requested.`),f(e,t,"m.room.join_rules","")}(e,r);else p(e,r);else g(e,r);else m(e,Object(c.a)("Room %(roomId)s not visible",{roomId:r}))};let v=0,y=null;function b(){0===v&&window.addEventListener("message",_,!1),v+=1}function E(){if(v-=1,0===v&&window.removeEventListener("message",_),v<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");console.error(e)}}function S(e){y=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(46),u=s(48),h=s(54);class m extends r.a.Component{constructor(...e){super(...e),i()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()}),i()(this,"_onOpenSettingsClick",()=>{this.props.onFinished(),u.a.fire(h.a.ViewUserSettings)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return r.a.createElement(e,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Integrations are disabled")},r.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},r.a.createElement("p",null,Object(l.a)("Enable 'Manage Integrations' in Settings to do this."))),r.a.createElement(t,{primaryButton:Object(l.a)("Settings"),onPrimaryButtonClick:this._onOpenSettingsClick,cancelButton:Object(l.a)("OK"),onCancel:this._onAcknowledgeClick}))}}i()(m,"propTypes",{onFinished:c.a.func.isRequired})},,function(e,t){e.exports="img/icon-email-pill-avatar.575ff20.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(143),c=s(44),l=s(64),d=s(52),u=s(47),h=s(3),m=s(53),p=s(366),g=s(127),f=s(80),_=s(97),v=s(94),y=s(49),b=s(140);class E extends r.a.PureComponent{constructor(e){super(e),i()(this,"onSubmit",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=[...this.state.emailTargets,...this.state.userTargets],t=await Object(_.a)(this.props.roomId,e),s=u.a.get().getRoom(this.props.roomId);Object(_.d)(t.states,s,t.inviter)?this.props.onFinished(!0):this.setState({busy:!1})}catch(e){this.setState({busy:!1}),console.error(e),y.a.createTrackedDialog("Failed to invite","",b.a,{title:Object(c.a)("Failed to invite"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}),i()(this,"onAddressChange",(e,t)=>{const s=Object(h.c)(this.state.emailTargets);t>=s.length?s.push(e.target.value):s[t]=e.target.value,this.setState({emailTargets:s})}),i()(this,"onAddressBlur",e=>{const t=Object(h.c)(this.state.emailTargets);e>=t.length||""===t[e].trim()&&(t.splice(e,1),this.setState({emailTargets:t}))}),i()(this,"onShowPeopleClick",()=>{this.setState({showPeople:!this.state.showPeople})}),i()(this,"setPersonToggle",(e,t)=>{const s=Object(h.c)(this.state.userTargets);t&&!s.includes(e.userId)?s.push(e.userId):!t&&s.includes(e.userId)&&s.splice(s.indexOf(e.userId),1),this.setState({userTargets:s})}),i()(this,"onShowMorePeople",()=>{this.setState({numPeople:this.state.numPeople+5})}),this.state={emailTargets:[],userTargets:[],showPeople:!1,people:this.buildSuggestions(),numPeople:5,busy:!1}}buildSuggestions(){const e=new Set([u.a.get().getUserId(),m.a.get().welcomeUserId]);if(this.props.roomId){const t=u.a.get().getRoom(this.props.roomId);if(!t)throw new Error("Room ID given to InviteDialog does not look like a room");t.getMembersWithMembership("invite").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("join").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("ban").forEach(t=>e.add(t.userId))}return p.c.buildRecents(e)}renderPerson(e,t){return r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_person",key:t},r.a.createElement(g.a,{url:Object(f.a)(u.a.get().getHomeserverUrl(),e.user.getMxcAvatarUrl(),36,36,"crop"),name:e.user.name,idName:e.user.userId,width:36,height:36}),r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_personIdentifiers"},r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personName"},e.user.name),r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personId"},e.userId)),r.a.createElement(v.a,{onChange:t=>this.setPersonToggle(e,t.target.checked)}))}render(){const e=[];this.state.emailTargets.forEach((t,s)=>{e.push(r.a.createElement(l.a,{key:s,value:t,onChange:e=>this.onAddressChange(e,s),label:Object(c.a)("Email address"),placeholder:Object(c.a)("Email address"),onBlur:()=>this.onAddressBlur(s)}))}),e.push(r.a.createElement(l.a,{key:e.length,value:"",onChange:t=>this.onAddressChange(t,e.length),label:e.length>0?Object(c.a)("Add another email"):Object(c.a)("Email address"),placeholder:e.length>0?Object(c.a)("Add another email"):Object(c.a)("Email address")}));let t=null;const s=[];if(this.state.showPeople){const e=this.state.people.slice(0,this.state.numPeople);e.forEach((e,t)=>{s.push(this.renderPerson(e,t))}),e.length<this.state.people.length&&s.push(r.a.createElement(d.a,{onClick:this.onShowMorePeople,kind:"link",key:"more",className:"mx_CommunityPrototypeInviteDialog_morePeople"},Object(c.a)("Show more")))}this.state.people.length>0&&(t=r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_people"},r.a.createElement("span",null,Object(c.a)("People you know on %(brand)s",{brand:m.a.get().brand})),r.a.createElement(d.a,{onClick:this.onShowPeopleClick},this.state.showPeople?Object(c.a)("Hide"):Object(c.a)("Show"))));let n=Object(c.a)("Skip");const i=this.state.userTargets.length+this.state.emailTargets.length;return i>0&&(n=Object(c.a)("Send %(count)s invites",{count:i})),r.a.createElement(a.a,{className:"mx_CommunityPrototypeInviteDialog",onFinished:this.props.onFinished,title:Object(c.a)("Invite people to join %(communityName)s",{communityName:this.props.communityName})},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},e,t,s,r.a.createElement(d.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy,className:"mx_CommunityPrototypeInviteDialog_primaryButton"},n))))}}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(2),i=s.n(n),o=s(244),r=s(10),a=s(1),c=s(63);class l extends r.EventEmitter{constructor(){super(),i()(this,"_search",""),i()(this,"callUpdate",Object(c.throttle)(()=>{this.emit(o.a)},200,{trailing:!0,leading:!0}))}get relativePriority(){return o.b.Highest}get search(){return this._search}set search(e){this._search=e,this.callUpdate()}isVisible(e){const t=this.search.toLowerCase();if("#"===this.search[0]){if(e.getCanonicalAlias()&&e.getCanonicalAlias().toLowerCase().startsWith(t))return!0;if(e.getAltAliases().some(e=>e.toLowerCase().startsWith(t)))return!0}return!!e.name&&this.matches(e.name)}matches(e){const t=Object(a.z)(this.search.toLowerCase()).toLowerCase();return Object(a.z)(e.toLowerCase()).toLowerCase().includes(t)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return M}));var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(43),c=s.n(a),l=s(51),d=s.n(l),u=s(132),h=s(52),m=s(48),p=s(58),g=s(801),f=s(44),_=s(61),v=s(71),y=s(1156),b=s(267),E=s(234),S=s(47),w=s(212),C=s(89),R=s(458),k=s(131),I=s(175),O=s(68),T=s(816),x=s(460),N=s(461),j=s(213),P=s(124),D=s(86);const A=e=>"mx_RoomTile_messagePreview_"+e,U=e=>({left:e.left+window.pageXOffset-9,top:e.bottom+window.pageYOffset+17,chevronFace:_.a.None});class M extends c.a.PureComponent{constructor(t){super(t),r()(this,"dispatcherRef",void 0),r()(this,"roomTileRef",Object(a.createRef)()),r()(this,"notificationState",void 0),r()(this,"roomProps",void 0),r()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),r()(this,"onRoomPropertyUpdate",e=>{e===x.a.NotificationVolume&&this.onNotificationUpdate()}),r()(this,"onAction",t=>{"view_room"===t.action&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e(()=>{this.scrollIntoView()})}),r()(this,"onCommunityUpdate",e=>{e===this.props.room.roomId&&this.forceUpdate()}),r()(this,"onRoomPreviewChanged",e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.setState({messagePreview:this.generatePreview()})}),r()(this,"scrollIntoView",()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})}),r()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_room",show_room_tile:!0,room_id:this.props.room.roomId,clear_search:e&&(e.key===p.a.ENTER||e.key===p.a.SPACE)})}),r()(this,"onActiveRoomUpdate",e=>{this.setState({selected:e})}),r()(this,"onNotificationsMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()})}),r()(this,"onCloseNotificationsMenu",()=>{this.setState({notificationsMenuPosition:null})}),r()(this,"onGeneralMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})}),r()(this,"onContextMenu",e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))}),r()(this,"onCloseGeneralMenu",()=>{this.setState({generalMenuPosition:null})}),r()(this,"onTagRoom",(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===v.a.Favourite||t===v.a.LowPriority){const e=t===v.a.Favourite?v.a.LowPriority:v.a.Favourite,s=C.b.instance.getTagsForRoom(this.props.room).includes(t),n=s?t:e,i=s?null:t;m.a.dispatch(R.a.tagRoom(S.a.get(),this.props.room,n,i,void 0,0))}else console.warn(`Unexpected tag ${t} applied to ${this.props.room.room_id}`);e.key===p.a.ENTER&&this.setState({generalMenuPosition:null})}),r()(this,"onLeaveRoomClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"leave_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onForgetRoomClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"forget_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onOpenRoomSettings",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"open_room_settings",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onClickAllNotifs",e=>this.saveNotifState(e,E.a)),r()(this,"onClickAlertMe",e=>this.saveNotifState(e,E.b)),r()(this,"onClickMentions",e=>this.saveNotifState(e,E.c)),r()(this,"onClickMute",e=>this.saveNotifState(e,E.d)),this.state={selected:g.a.activeRoomId===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,messagePreview:this.generatePreview()},g.a.addListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=m.a.register(this.onAction),y.a.instance.on(y.b,this.onRoomPreviewChanged),this.notificationState=k.a.instance.getRoomState(this.props.room),this.notificationState.on(I.a,this.onNotificationUpdate),this.roomProps=T.a.forRoom(this.props.room),this.roomProps.on(N.b,this.onRoomPropertyUpdate),P.a.instance.on(D.b,this.onCommunityUpdate)}get showContextMenu(){return this.props.tag!==v.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){e.showMessagePreview!==this.props.showMessagePreview&&this.showMessagePreview&&this.setState({messagePreview:this.generatePreview()})}componentDidMount(){this.state.selected&&this.scrollIntoView()}componentWillUnmount(){this.props.room&&g.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),m.a.unregister(this.dispatcherRef),y.a.instance.off(y.b,this.onRoomPreviewChanged),this.notificationState.off(I.a,this.onNotificationUpdate),P.a.instance.off(D.b,this.onCommunityUpdate)}generatePreview(){return this.showMessagePreview?y.a.instance.getPreviewForRoom(this.props.room,this.props.tag):null}async saveNotifState(e,t){if(e.preventDefault(),e.stopPropagation(),S.a.get().isGuest())return;this.roomProps.notificationVolume=t;e.key===p.a.ENTER&&this.setState({notificationsMenuPosition:null})}renderNotificationsMenu(e){if(S.a.get().isGuest()||this.props.tag===v.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume;let s=null;this.state.notificationsMenuPosition&&(s=c.a.createElement(j.e,i()({},U(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(j.c,{first:!0},c.a.createElement(j.d,{label:Object(f.a)("Use default"),active:t===E.a,iconClassName:"mx_RoomTile_iconBell",onClick:this.onClickAllNotifs}),c.a.createElement(j.d,{label:Object(f.a)("All messages"),active:t===E.b,iconClassName:"mx_RoomTile_iconBellDot",onClick:this.onClickAlertMe}),c.a.createElement(j.d,{label:Object(f.a)("Mentions & Keywords"),active:t===E.c,iconClassName:"mx_RoomTile_iconBellMentions",onClick:this.onClickMentions}),c.a.createElement(j.d,{label:Object(f.a)("None"),active:t===E.d,iconClassName:"mx_RoomTile_iconBellCrossed",onClick:this.onClickMute}))));const n=d()("mx_RoomTile_notificationsButton",{mx_RoomTile_iconBell:t===E.a,mx_RoomTile_iconBellDot:t===E.b,mx_RoomTile_iconBellMentions:t===E.c,mx_RoomTile_iconBellCrossed:t===E.d,mx_RoomTile_notificationsButton_show:t===E.d});return c.a.createElement(c.a.Fragment,null,c.a.createElement(_.d,{className:n,onClick:this.onNotificationsMenuOpenClick,title:Object(f.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),s)}renderGeneralMenu(){if(!this.showContextMenu)return null;let e=null;if(this.state.generalMenuPosition&&this.props.tag===v.a.Archived)e=c.a.createElement(j.e,i()({},U(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(j.c,{red:!0},c.a.createElement(j.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(f.a)("Forget Room"),onClick:this.onForgetRoomClick})));else if(this.state.generalMenuPosition){const t=C.b.instance.getTagsForRoom(this.props.room),s=t.includes(v.a.Favourite),n=s?Object(f.a)("Favourited"):Object(f.a)("Favourite"),o=t.includes(v.a.LowPriority),r=Object(f.a)("Low Priority");e=c.a.createElement(j.e,i()({},U(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(j.c,null,c.a.createElement(j.a,{onClick:e=>this.onTagRoom(e,v.a.Favourite),active:s,label:n,iconClassName:"mx_RoomTile_iconStar"}),c.a.createElement(j.a,{onClick:e=>this.onTagRoom(e,v.a.LowPriority),active:o,label:r,iconClassName:"mx_RoomTile_iconArrowDown"}),c.a.createElement(j.b,{onClick:this.onOpenRoomSettings,label:Object(f.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"})),c.a.createElement(j.c,{red:!0},c.a.createElement(j.b,{onClick:this.onLeaveRoomClick,label:Object(f.a)("Leave Room"),iconClassName:"mx_RoomTile_iconSignOut"})))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(_.d,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(f.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),e)}render(){const e=d()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t={displayName:null,avatarMxc:null};this.props.tag===v.a.Invite&&(t=P.a.instance.getInviteProfile(this.props.room.roomId));let s=t.displayName||this.props.room.name;"string"!=typeof s&&(s=""),s=s.replace(":",":​");const n=c.a.createElement(b.a,{room:this.props.room,avatarSize:32,tag:this.props.tag,displayBadge:this.props.isMinimized,oobData:{avatarUrl:t.avatarMxc}});let o;this.props.isMinimized||(o=c.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},c.a.createElement(w.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId})));let r=null;this.showMessagePreview&&this.state.messagePreview&&(r=c.a.createElement("div",{className:"mx_RoomTile_messagePreview",id:A(this.props.room.roomId)},this.state.messagePreview));const a=d()({mx_RoomTile_name:!0,mx_RoomTile_nameWithPreview:!!r,mx_RoomTile_nameHasUnreadEvents:this.notificationState.isUnread});let l=c.a.createElement("div",{className:"mx_RoomTile_nameContainer"},c.a.createElement("div",{title:s,className:a,tabIndex:-1,dir:"auto"},s),r);this.props.isMinimized&&(l=null);let m,p=s;this.props.tag===v.a.Invite||(this.notificationState.hasMentions?p+=" "+Object(f.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?p+=" "+Object(f.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(p+=" "+Object(f.a)("Unread messages."))),this.showMessagePreview&&(m=A(this.props.room.roomId));const g={};let _=h.a;return this.props.isMinimized&&(_=O.a,g.title=s,g.forceHide=!!this.state.generalMenuPosition),c.a.createElement(c.a.Fragment,null,c.a.createElement(u.d,{inputRef:this.roomTileRef},({onFocus:t,isActive:s,ref:r})=>c.a.createElement(_,i()({},g,{onFocus:t,tabIndex:s?0:-1,inputRef:r,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":p,"aria-selected":this.state.selected,"aria-describedby":m}),n,l,o,this.renderGeneralMenu(),this.renderNotificationsMenu(s))))}}}).call(this,s(136).setImmediate)},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(47),d=s(75),u=s(44),h=s(211),m=s.n(h),p=s(52),g=s(49),f=s(46),_=s(58),v=s(444),y=s.n(v);function b(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class E extends r.a.Component{constructor(e){super(e),i()(this,"onKeyDown",e=>{e.key===_.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),i()(this,"onRedactClick",()=>{const e=f.getComponent("dialogs.ConfirmRedactDialog");g.a.createTrackedDialog("Confirm Redact Dialog","Image View",e,{onFinished:e=>{e&&(this.props.onFinished(),l.a.get().redactEvent(this.props.mxEvent.getRoomId(),this.props.mxEvent.getId()).catch((function(e){const t=f.getComponent("dialogs.ErrorDialog"),s=e.errcode||e.statusCode;g.a.createTrackedDialog("You cannot delete this image.","",t,{title:Object(u.a)("Error"),description:Object(u.a)("You cannot delete this image. (%(code)s)",{code:s})})})))}})}),i()(this,"rotateCounterClockwise",()=>{const e=(this.state.rotationDegrees-90)%360;this.setState({rotationDegrees:e})}),i()(this,"rotateClockwise",()=>{const e=(this.state.rotationDegrees+90)%360;this.setState({rotationDegrees:e})}),this.state={rotationDegrees:0}}getName(){let e=this.props.name;return e&&this.props.link&&(e=r.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e)),e}render(){let e,t,n,o={};this.props.width&&this.props.height&&(o={width:this.props.width,height:this.props.height},e=o.width+"x"+o.height+"px"),this.props.fileSize&&(t=m()(this.props.fileSize)),n=t&&e?t+", "+e:t||e;let a=!1;let c,h;if(!!this.props.mxEvent){let e=this.props.mxEvent.getSender();const t=l.a.get(),s=t.getRoom(this.props.mxEvent.getRoomId());if(s){a=s.currentState.maySendRedactionForEvent(this.props.mxEvent,t.credentials.userId);const n=s.getMember(e);n&&(e=n.name)}c=r.a.createElement("div",{className:"mx_ImageView_metadata"},Object(u.a)("Uploaded on %(date)s by %(user)s",{date:Object(d.a)(new Date(this.props.mxEvent.getTs())),user:e}))}a&&(h=r.a.createElement("div",{className:"mx_ImageView_button",onClick:this.onRedactClick},Object(u.a)("Remove")));const g=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?b(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):b(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({transform:`rotate(${this.state.rotationDegrees}deg)`},o);return r.a.createElement(y.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView"},r.a.createElement("div",{className:"mx_ImageView_lhs"}),r.a.createElement("div",{className:"mx_ImageView_content"},r.a.createElement("img",{src:this.props.src,title:this.props.name,style:g,className:"mainImage"}),r.a.createElement("div",{className:"mx_ImageView_labelWrapper"},r.a.createElement("div",{className:"mx_ImageView_label"},r.a.createElement(p.a,{className:"mx_ImageView_rotateCounterClockwise",title:Object(u.a)("Rotate Left"),onClick:this.rotateCounterClockwise},r.a.createElement("img",{src:s(813),alt:Object(u.a)("Rotate counter-clockwise"),width:"18",height:"18"})),r.a.createElement(p.a,{className:"mx_ImageView_rotateClockwise",title:Object(u.a)("Rotate Right"),onClick:this.rotateClockwise},r.a.createElement("img",{src:s(814),alt:Object(u.a)("Rotate clockwise"),width:"18",height:"18"})),r.a.createElement(p.a,{className:"mx_ImageView_cancel",title:Object(u.a)("Close"),onClick:this.props.onFinished},r.a.createElement("img",{src:s(815),width:"18",height:"18",alt:Object(u.a)("Close")})),r.a.createElement("div",{className:"mx_ImageView_shim"}),r.a.createElement("div",{className:"mx_ImageView_name"},this.getName()),c,r.a.createElement("a",{className:"mx_ImageView_link",href:this.props.src,download:this.props.name,target:"_blank",rel:"noopener"},r.a.createElement("div",{className:"mx_ImageView_download"},Object(u.a)("Download this file"),r.a.createElement("br",null),r.a.createElement("span",{className:"mx_ImageView_size"},n))),h,r.a.createElement("div",{className:"mx_ImageView_shim"})))),r.a.createElement("div",{className:"mx_ImageView_rhs"}))}}i()(E,"propTypes",{src:c.a.string.isRequired,name:c.a.string,link:c.a.string,width:c.a.number,height:c.a.number,fileSize:c.a.number,onFinished:c.a.func.isRequired,mxEvent:c.a.object})},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(283),i=s(49),o=s(248),r=s(44),a=s(46),c=s(89),l=s(169),d=s(71);class u{static tagRoom(e,t,s,u,h,m){let p=null;const g=c.b.instance;if(u&&g.getTagSorting(u)===l.b.Manual){const e=[...g.orderedLists[u]];e.sort((e,t)=>e.tags[u].order-t.tags[u].order);const t=u===s&&h<m?1:0,n=t+m-1,i=t+m,o=n<=0?0:e[n].tags[u].order,r=i>=e.length?1:e[i].tags[u].order;p={order:(o+r)/2}}return Object(n.a)("RoomListActions.tagRoom",()=>{const n=[],c=t.roomId;if(void 0===s&&u===d.a.DM||s===d.a.DM&&void 0===u)return o.b(t,u===d.a.DM).catch(e=>{const t=a.getComponent("dialogs.ErrorDialog");console.error("Failed to set direct chat tag "+e),i.a.createTrackedDialog("Failed to set direct chat tag","",t,{title:Object(r.a)("Failed to set direct chat tag"),description:e&&e.message?e.message:Object(r.a)("Operation failed")})});const l=s!==u;if(s&&s!==d.a.DM&&l){const t=e.deleteRoomTag(c,s).catch((function(e){const t=a.getComponent("dialogs.ErrorDialog");console.error("Failed to remove tag "+s+" from room: "+e),i.a.createTrackedDialog("Failed to remove tag from room","",t,{title:Object(r.a)("Failed to remove tag %(tagName)s from room",{tagName:s}),description:e&&e.message?e.message:Object(r.a)("Operation failed")})}));n.push(t)}if(u&&u!==d.a.DM&&(l||p)){p=p||{};const t=e.setRoomTag(c,u,p).catch((function(e){const t=a.getComponent("dialogs.ErrorDialog");throw console.error("Failed to add tag "+u+" to room: "+e),i.a.createTrackedDialog("Failed to add tag to room","",t,{title:Object(r.a)("Failed to add tag %(tagName)s to room",{tagName:u}),description:e&&e.message?e.message:Object(r.a)("Operation failed")}),e}));n.push(t)}return Promise.all(n)},()=>({room:t,oldTag:s,newTag:u,metaData:p}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(460),r=s(463),a=s(103),c=s(48),l=s(464),d=s(465),u=s(466);const h=e=>"room-"+e.roomId;class m extends a.a{constructor(){super(c.a),i()(this,"caches",new Map)}static get instance(){return m._instance||(m._instance=new m),m._instance}get contexts(){return Array.from(this.caches.values()).map(e=>e.context)}getOrCreateChamberForRoom(e){if(this.caches.has(h(e)))return this.caches.get(h(e));const t=new r.a(e);t.whenAnything(()=>this.checkContexts());const s=new o.b(t);return s.setClient(this.matrixClient),this.caches.set(h(e),s),s}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===l.a.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=d.a.instance.addToast(u.a);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(d.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){return Promise.resolve()}}i()(m,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(2),i=s.n(n),o=s(461),r=s(234),a=s(44);let c;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(c||(c={}));class l extends o.a{constructor(e){super(e,e=>this.properties.get(e)),i()(this,"properties",new Map),i()(this,"onAccountData",e=>{if("m.push_rules"===e.getType()){this.properties.get(c.NotificationVolume)!==Object(r.f)(this.context.room.roomId)&&this.updateNotificationVolume()}})}onClientChanged(e,t){this.properties.clear(),e&&e.removeListener("accountData",this.onAccountData),t&&(t.on("accountData",this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){this.properties.set(c.NotificationVolume,Object(r.f)(this.context.room.roomId)),this.markEchoReceived(c.NotificationVolume),this.emit(o.b,c.NotificationVolume)}get notificationVolume(){return this.getValue(c.NotificationVolume)}set notificationVolume(e){this.setValue(Object(a.a)("Change notification settings"),c.NotificationVolume,e,async()=>Object(r.h)(this.context.room.roomId,e),o.c)}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(2),i=s.n(n),o=s(326),r=s(10);async function a(){}const c="property_updated";class l extends r.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,i()(this,"cache",new Map),i()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,s){this.cache.set(e,{txn:s,val:t}),this.emit(c,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(c,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,s,n,i){this.cache.has(t)&&this.cache.get(t).txn.cancel();const r=this.context.beginTransaction(e,n);this.cacheVal(t,s,r),r.when(o.b.Pending,()=>this.cacheVal(t,s,r)).when(o.b.Error,()=>i()),r.run()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(2),i=s.n(n),o=s(3);class r{constructor(){i()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const s of e)this.when(s,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(o.c)(this.listeners);for(const s of t)if(null===s.condition||s.condition===e)try{s.fn(this)}catch(t){console.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(464);class i extends n.b{constructor(e){super(),this.room=e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(2),i=s.n(n),o=s(326),r=s(3),a=s(462);let c;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(c||(c={}));class l extends a.a{constructor(...e){super(...e),i()(this,"_transactions",[]),i()(this,"_state",c.NotStarted),i()(this,"checkTransactions",()=>{let e=c.AllSuccessful;for(const t of this.transactions){if(t.status===o.b.Error||t.didPreviouslyFail){e=c.PendingErrors;break}t.status===o.b.Pending&&(e=c.NotStarted)}this._state=e,this.notifyCondition(e)})}get transactions(){return Object(r.c)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find(e=>e.didPreviouslyFail||e.status===o.b.Error);return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const s=new o.a(e,t);return this._transactions.push(s),s.whenAnything(this.checkTransactions),s.when(o.b.Success,()=>s.destroy()),s}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(2),i=s.n(n),o=s(10),r=s.n(o),a=s(86);class c extends r.a{constructor(...e){super(...e),i()(this,"toasts",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(a.b),t}removeToast(e){this.toasts.delete(e),this.emit(a.b)}}i()(c,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(44),c=s(52),l=s(49),d=s(467);class u extends r.a.PureComponent{constructor(...e){super(...e),i()(this,"openDialog",()=>{l.a.createTrackedDialog("Local Echo Server Error","",d.a,{})})}render(){return r.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},r.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(a.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>r.a.createElement(c.a,{kind:"link",onClick:this.openDialog},e)}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(2),i=s.n(n),o=s(43),r=s(143),a=s(44),c=s(459),l=s(75),d=s(50),u=s(463),h=s(176),m=s(326),p=s(99),g=s(52),f=s(86),_=s(47);class v extends o.PureComponent{constructor(...e){super(...e),i()(this,"onEchosUpdated",()=>{this.forceUpdate()})}componentDidMount(){c.a.instance.on(f.b,this.onEchosUpdated)}componentWillUnmount(){c.a.instance.off(f.b,this.onEchosUpdated)}renderTimeline(){return c.a.instance.contexts.map((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof u.a))throw new Error("Cannot render unknown context: "+e);const s=o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},o.createElement(h.a,{width:24,height:24,room:e.room}),o.createElement("span",null,e.room.name)),n=e.transactions.filter(e=>e.status===m.b.Error||e.didPreviouslyFail).map((e,t)=>{let s=o.createElement(p.a,{w:19,h:19});return e.status===m.b.Error&&(s=o.createElement(g.a,{kind:"link",onClick:()=>e.run()},Object(a.a)("Resend"))),o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:"txn-"+t},o.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),s)});return o.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:"context-"+t},o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(l.d)(e.firstFailedTime,d.a.getValue("showTwelveHourTimestamps"))),o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},s,n))})}render(){let e=this.renderTimeline().filter(e=>!!e);0===e.length&&(e=[o.createElement("div",{key:1},Object(a.a)("You're all caught up."))]);const t=_.a.getHomeserverName();return o.createElement(r.a,{title:Object(a.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},o.createElement("div",{className:"mx_ServerOfflineDialog_content"},o.createElement("p",null,Object(a.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),o.createElement("ul",null,o.createElement("li",null,Object(a.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),o.createElement("li",null,Object(a.a)("Your firewall or anti-virus is blocking the request.")),o.createElement("li",null,Object(a.a)("A browser extension is preventing the request.")),o.createElement("li",null,Object(a.a)("The server is offline.")),o.createElement("li",null,Object(a.a)("The server has denied your request.")),o.createElement("li",null,Object(a.a)("Your area is experiencing difficulties connecting to the internet.")),o.createElement("li",null,Object(a.a)("A connection error occurred while trying to contact the server.")),o.createElement("li",null,Object(a.a)("The server is not configured to indicate what the problem is (CORS)."))),o.createElement("hr",null),o.createElement("h2",null,Object(a.a)("Recent changes that have not yet been received")),e))}}},function(e,t){e.exports="img/spinner.d25f31a.svg"},function(e,t){e.exports="img/spinner.0b29ec9.gif"},,,function(e,t){e.exports="img/external-link.67fb410.svg"},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(44),i=s(214),o=s(92),r=s(78);const a=()=>{i.default.setEnabled(!0)},c=()=>{i.default.setToolbarHidden(!0)},l=()=>{r.a.sharedInstance().addOrReplaceToast({key:"desktopnotifications",title:Object(n.a)("Notifications"),props:{description:Object(n.a)("You are not receiving desktop notifications"),acceptLabel:Object(n.a)("Enable them now"),onAccept:a,rejectLabel:Object(n.a)("Close"),onReject:c},component:o.a,priority:30})},d=()=>{r.a.sharedInstance().dismissToast("desktopnotifications")}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return o}));var n=s(48),i=s(178);class o{constructor(e,t){this._window=e,this._document=t,this._attachedActiveNowTimers=[],this._attachedActiveRecentlyTimers=[],this._activeNowTimeout=new i.a(700),this._activeRecentlyTimeout=new i.a(12e4),this._onUserActivity=this._onUserActivity.bind(this),this._onWindowBlurred=this._onWindowBlurred.bind(this),this._onPageVisibilityChanged=this._onPageVisibilityChanged.bind(this),this.lastScreenX=0,this.lastScreenY=0}static sharedInstance(){return void 0===e.mxUserActivity&&(e.mxUserActivity=new o(window,document)),e.mxUserActivity}timeWhileActiveNow(e){this._timeWhile(e,this._attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this._timeWhile(e,this._attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}_timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally(()=>{const s=t.indexOf(e);-1!==s&&t.splice(s,1)}).catch(e=>{}))}start(){this._document.addEventListener("mousedown",this._onUserActivity),this._document.addEventListener("mousemove",this._onUserActivity),this._document.addEventListener("keydown",this._onUserActivity),this._document.addEventListener("visibilitychange",this._onPageVisibilityChanged),this._window.addEventListener("blur",this._onWindowBlurred),this._window.addEventListener("focus",this._onUserActivity),this._window.addEventListener("wheel",this._onUserActivity,{passive:!0,capture:!0})}stop(){this._document.removeEventListener("mousedown",this._onUserActivity),this._document.removeEventListener("mousemove",this._onUserActivity),this._document.removeEventListener("keydown",this._onUserActivity),this._window.removeEventListener("wheel",this._onUserActivity,{passive:!0,capture:!0}),this._document.removeEventListener("visibilitychange",this._onPageVisibilityChanged),this._window.removeEventListener("blur",this._onWindowBlurred),this._window.removeEventListener("focus",this._onUserActivity)}userActiveNow(){return this._activeNowTimeout.isRunning()}userActiveRecently(){return this._activeRecentlyTimeout.isRunning()}_onPageVisibilityChanged(e){"hidden"===this._document.visibilityState?(this._activeNowTimeout.abort(),this._activeRecentlyTimeout.abort()):this._onUserActivity(e)}_onWindowBlurred(){this._activeNowTimeout.abort(),this._activeRecentlyTimeout.abort()}_onUserActivity(e){if(this._document.hasFocus()){if(e.screenX&&"mousemove"===e.type){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}n.a.dispatch({action:"user_activity"}),this._activeNowTimeout.isRunning()?this._activeNowTimeout.restart():(this._activeNowTimeout.start(),n.a.dispatch({action:"user_activity_start"}),this._runTimersUntilTimeout(this._attachedActiveNowTimers,this._activeNowTimeout)),this._activeRecentlyTimeout.isRunning()?this._activeRecentlyTimeout.restart():(this._activeRecentlyTimeout.start(),this._runTimersUntilTimeout(this._attachedActiveRecentlyTimers,this._activeRecentlyTimeout))}}async _runTimersUntilTimeout(e,t){e.forEach(e=>e.start());try{await t.finished()}catch(e){}e.forEach(e=>e.abort())}}}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return r}));var n=s(47),i=s(50),o=s(178);class r{constructor(){this.reset()}static sharedInstance(){return void 0===e.mxTypingStore&&(e.mxTypingStore=new r),e.mxTypingStore}reset(){this._typingStates={}}setSelfTyping(e,t){if(!i.a.getValue("sendTypingNotifications"))return;if(i.a.getValue("lowBandwidth"))return;let s=this._typingStates[e];!t&&!s||s&&s.isTyping===t||(s||(s=this._typingStates[e]={isTyping:t,serverTimer:new o.a(3e4),userTimer:new o.a(1e4)}),s.isTyping=t,t&&(s.serverTimer.isRunning()?s.serverTimer.restart():s.serverTimer.restart().finished().then(()=>{const t=this._typingStates[e];t&&(t.isTyping=!1)}),s.userTimer.isRunning()?s.userTimer.restart():s.userTimer.restart().finished().then(()=>{this.setSelfTyping(e,!1)})),n.a.get().sendTyping(e,t,3e4))}}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(331),d=s(143),u=s(44),h=s(332);function m(e){return e===h.c?s(822):s(256)}class p extends r.a.Component{constructor(){super(),i()(this,"_onStoreUpdate",()=>{this.setState({icon:m(this.store.phase)})}),this.store=h.f.sharedInstance(),this.state={icon:m(this.store.phase)}}componentDidMount(){this.store.on("update",this._onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this._onStoreUpdate)}render(){return r.a.createElement(d.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(u.a)("Verify this session")},r.a.createElement(l.a,{onFinished:this.props.onFinished}))}}i()(p,"propTypes",{onFinished:c.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,r=s(2),a=s.n(r),c=s(43),l=s.n(c),d=s(45),u=s.n(d),h=s(44),m=s(49),p=s(179),g=s(478),f=s(143),_=s(257),v=s(47),y=s(46);let b=Object(p.a)("views.dialogs.NewSessionReviewDialog")((o=i=class extends l.a.PureComponent{constructor(...e){super(...e),a()(this,"onCancelClick",()=>{const e=y.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(256),title:Object(h.a)("Your account is not secure"),description:l.a.createElement("div",null,Object(h.a)("One of the following may be compromised:"),l.a.createElement("ul",null,l.a.createElement("li",null,Object(h.a)("Your password")),l.a.createElement("li",null,Object(h.a)("Your homeserver")),l.a.createElement("li",null,Object(h.a)("This session, or the other session")),l.a.createElement("li",null,Object(h.a)("The internet connection either session is using"))),l.a.createElement("div",null,Object(h.a)("We recommend you change your password and recovery key in Settings immediately"))),onFinished:()=>this.props.onFinished(!1)})}),a()(this,"onContinueClick",()=>{const{userId:e,device:t}=this.props,s=v.a.get(),n=s.requestVerification(e,[t.deviceId]);this.props.onFinished(!0),m.a.createTrackedDialog("New Session Verification","Starting dialog",g.a,{verificationRequestPromise:n,member:s.getUser(e)})})}render(){const{device:e}=this.props,t=l.a.createElement("span",{className:"mx_NewSessionReviewDialog_headerIcon mx_E2EIcon_warning"}),s=Object(h.a)("New session"),n=l.a.createElement("h2",{className:"mx_NewSessionReviewDialog_header"},t,s);return l.a.createElement(f.a,{title:n,onFinished:this.props.onFinished},l.a.createElement("div",{className:"mx_NewSessionReviewDialog_body"},l.a.createElement("p",null,Object(h.a)("Use this session to verify your new one, granting it access to encrypted messages:")),l.a.createElement("div",{className:"mx_NewSessionReviewDialog_deviceInfo"},l.a.createElement("div",null,l.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceName"},e.getDisplayName())," ",l.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceID"},"(",e.deviceId,")"))),l.a.createElement("p",null,Object(h.a)("If you didn’t sign in to this session, your account may be compromised.")),l.a.createElement(_.a,{cancelButton:Object(h.a)("This wasn't me"),cancelButtonClass:"danger",primaryButton:Object(h.a)("Continue"),onCancel:this.onCancelClick,onPrimaryButtonClick:this.onContinueClick})))}},a()(i,"propTypes",{userId:u.a.string.isRequired,device:u.a.object.isRequired,onFinished:u.a.func.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(47),d=s(46),u=s(44);class h extends r.a.Component{constructor(...e){super(...e),this.onFinished=this.onFinished.bind(this),this.state={},this.props.verificationRequest?this.state.verificationRequest=this.props.verificationRequest:this.props.verificationRequestPromise&&this.props.verificationRequestPromise.then(e=>{this.setState({verificationRequest:e})})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.right_panel.EncryptionPanel"),s=this.state.verificationRequest,n=s&&s.otherUserId,i=this.props.member||n&&l.a.get().getUser(n),o=s&&s.isSelfVerification?Object(u.a)("Verify other session"):Object(u.a)("Verification Request");return r.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.onFinished,contentId:"mx_Dialog_content",title:o,hasCancel:!0},r.a.createElement(t,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:i}))}async onFinished(){this.props.onFinished();let e=this.props.verificationRequest;!e&&this.props.verificationRequestPromise&&(e=await this.props.verificationRequestPromise),e.cancel()}}i()(h,"propTypes",{verificationRequest:c.a.object,verificationRequestPromise:c.a.object,onFinished:c.a.func.isRequired})},function(e,t,s){"use strict";t.a={HomePage:"home_page",RoomView:"room_view",RoomDirectory:"room_directory",UserView:"user_view",GroupView:"group_view",MyGroups:"my_groups"}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(10),i=s(63);class o extends n.EventEmitter{constructor(){super(),this._throttledMiddlePanel=Object(i.throttle)(()=>this.emit("middlePanelResized"),200),this._isResizing=!1}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0}stopResizing(){this._isResizing=!1}_noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}_updateMiddlePanel(){this._throttledMiddlePanel(),this._noisyMiddlePanel()}notifyLeftHandleResized(){this._updateMiddlePanel()}notifyRightHandleResized(){this._updateMiddlePanel()}notifyTimelineHeightChanged(){this._updateMiddlePanel()}notifyWindowResized(){this.emit("leftPanelResized"),this._updateMiddlePanel()}}},function(e,t,s){"use strict";function n(e,t){const s=new e;return Object.assign(s,t),s}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(2),i=s.n(n),o=s(48),r=s(50),a=s(251),c=s(54),l=s(57);class d{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{e.action===c.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===c.a.UpdateSystemFont&&this.setSystemFont(e)}),i()(this,"setRootFontSize",e=>{const t=Math.max(Math.min(d.MAX_SIZE,e),d.MIN_SIZE);t!==e&&r.a.setValue("baseFontSize",null,l.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(a.a)(t)}),i()(this,"setSystemFont",({useSystemFont:e,font:t})=>{document.body.style.fontFamily=e?t:""}),this.dispatcherRef=null}start(){this.setRootFontSize(r.a.getValue("baseFontSize")),this.setSystemFont({useSystemFont:r.a.getValue("useSystemFont"),font:r.a.getValue("systemFont")}),this.dispatcherRef=o.a.register(this.onAction)}stop(){o.a.unregister(this.dispatcherRef)}}i()(d,"MIN_SIZE",8),i()(d,"MAX_SIZE",15),i()(d,"SIZE_DIFF",5)},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(143),c=s(44),l=s(64),d=s(52),u=s(47),h=s(484),m=s(48),p=s(97),g=s(67);class f extends r.a.PureComponent{constructor(e){super(e),i()(this,"avatarUploadRef",r.a.createRef()),i()(this,"onNameChange",e=>{const t=(e.target.value||"").toLowerCase().replace(/[^a-z0-9.\-_]/g,"-");this.setState({name:e.target.value,localpart:t})}),i()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e="";this.state.avatarFile&&(e=await u.a.get().uploadContent(this.state.avatarFile));const t=await u.a.get().createGroup({localpart:this.state.localpart,profile:{name:this.state.name,avatar_url:e}});m.a.dispatch({action:"deselect_tags"},!0),m.a.dispatch({action:"select_tag",tag:t.group_id}),this.props.onFinished(!0),t.room_id?(await g.a.refreshGroupRooms(t.group_id),m.a.dispatch({action:"view_room",room_id:t.room_id}),Object(p.f)(t.room_id,this.state.name)):m.a.dispatch({action:"view_group",group_id:t.group_id,group_is_new:!0})}catch(e){console.error(e),this.setState({busy:!1,error:Object(c.a)("There was an error creating your community. The name may be taken or the server is unable to process your request.")})}}}),i()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),i()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()}),this.state={name:"",localpart:"",error:null,busy:!1,avatarFile:null,avatarPreview:null}}render(){let e=null;this.state.localpart&&(e=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_communityId"},Object(c.a)("Community ID: +<localpart />:%(domain)s",{domain:u.a.getHomeserverName()},{localpart:()=>r.a.createElement("u",null,this.state.localpart)}),r.a.createElement(h.a,{tooltip:Object(c.a)("Use this when referencing your community to others. The community ID cannot be changed.")})));let t=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"},Object(c.a)("You can change this later if needed."));if(this.state.error){const e="mx_CreateCommunityPrototypeDialog_subtext mx_CreateCommunityPrototypeDialog_subtext_error";t=r.a.createElement("span",{className:e},this.state.error)}let s=r.a.createElement("img",{src:this.state.avatarPreview,className:"mx_CreateCommunityPrototypeDialog_avatar"});return this.state.avatarPreview||(s=r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_placeholderAvatar"})),r.a.createElement(a.a,{className:"mx_CreateCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(c.a)("What's the name of your community or team?")},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colName"},r.a.createElement(l.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(c.a)("Enter name"),label:Object(c.a)("Enter name")}),t,r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"}," ",e),r.a.createElement(d.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(c.a)("Create"))),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colAvatar"},r.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),r.a.createElement(d.a,{onClick:this.onChangeAvatar,className:"mx_CreateCommunityPrototypeDialog_avatarContainer"},s),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_tip"},r.a.createElement("b",null,Object(c.a)("Add image (optional)")),r.a.createElement("span",null,Object(c.a)("An image will help people identify your community.")))))))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(51),c=s.n(a),l=s(232),d=s(44);class u extends r.a.PureComponent{constructor(e){super(e),i()(this,"onMouseOver",()=>{this.setState({hover:!0})}),i()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const{tooltip:e,children:t,tooltipClassName:s}=this.props,n=Object(d.a)("Information"),i=this.state.hover?r.a.createElement(l.a,{className:"mx_InfoTooltip_container",tooltipClassName:c()("mx_InfoTooltip_tooltip",s),label:e||n,forceOnRight:!0}):r.a.createElement("div",null);return r.a.createElement("div",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:"mx_InfoTooltip"},r.a.createElement("span",{className:"mx_InfoTooltip_icon","aria-label":n}),t,i)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(43),i=s.n(n),o=s(45),r=s.n(o),a=s(46),c=s(188),l=s.n(c),d=s(44);const u=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class h extends i.a.Component{constructor(e){super(e),this.state={}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let s=0;s<u.length;s++){const n=t[2*s],i=e[2*s],o=`https://riot.im/github/repos/${u[s]}/compare/${n}...${i}`;l()(o,(e,t,n)=>{t.statusCode<200||t.statusCode>=300?this.setState({[u[s]]:t.statusText}):this.setState({[u[s]]:JSON.parse(n).commits})})}}_elementsForCommit(e){return i.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},i.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=a.getComponent("views.elements.Spinner"),t=a.getComponent("dialogs.QuestionDialog"),s=u.map(t=>{let s;return s=null==this.state[t]?i.a.createElement(e,{key:t}):"string"==typeof this.state[t]?Object(d.a)("Unable to load commit detail: %(msg)s",{msg:this.state[t]}):this.state[t].map(this._elementsForCommit),i.a.createElement("div",{key:t},i.a.createElement("h2",null,t),i.a.createElement("ul",null,s))}),n=i.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?i.a.createElement("h2",null,Object(d.a)("Unavailable")):s);return i.a.createElement(t,{title:Object(d.a)("Changelog"),description:n,button:Object(d.a)("Update"),onFinished:this.props.onFinished})}}h.propTypes={version:r.a.string.isRequired,newVersion:r.a.string.isRequired,onFinished:r.a.func.isRequired}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(43),r=s(51),a=s.n(r),c=s(48),l=s(44),d=s(58),u=s(52),h=s(54),m=s(89),p=s(453);class g extends o.PureComponent{constructor(t){super(t),i()(this,"dispatcherRef",void 0),i()(this,"inputRef",Object(o.createRef)()),i()(this,"searchFilter",new p.a),i()(this,"onAction",e=>{"view_room"===e.action&&e.clear_search?this.clearInput():"focus_room_filter"===e.action&&this.inputRef.current&&this.inputRef.current.focus()}),i()(this,"clearInput",()=>{this.inputRef.current&&(this.inputRef.current.value="",this.onChange())}),i()(this,"openSearch",()=>{c.a.dispatch({action:"show_left_panel"}),c.a.dispatch({action:"focus_room_filter"})}),i()(this,"onChange",()=>{this.inputRef.current&&this.setState({query:this.inputRef.current.value})}),i()(this,"onFocus",e=>{this.setState({focused:!0}),e.target.select()}),i()(this,"onBlur",e=>{this.setState({focused:!1})}),i()(this,"onKeyDown",t=>{if(t.key===d.a.ESCAPE)this.clearInput(),c.a.fire(h.a.FocusComposer);else if(t.key===d.a.ARROW_UP||t.key===d.a.ARROW_DOWN)this.props.onVerticalArrow(t);else if(t.key===d.a.ENTER){this.props.onEnter(t)&&e(()=>{this.clearInput()})}}),this.state={query:"",focused:!1},this.dispatcherRef=c.a.register(this.onAction)}componentDidUpdate(e,t){if(t.query!==this.state.query){const e=!!this.searchFilter.search.trim(),t=!!this.state.query.trim();this.searchFilter.search=this.state.query,!e&&t?m.b.instance.addFilter(this.searchFilter):e&&!t&&m.b.instance.removeFilter(this.searchFilter)}}componentWillUnmount(){c.a.unregister(this.dispatcherRef)}render(){const e=a()({mx_RoomSearch:!0,mx_RoomSearch_hasQuery:this.state.query,mx_RoomSearch_focused:this.state.focused,mx_RoomSearch_minimized:this.props.isMinimized}),t=a()({mx_RoomSearch_input:!0,mx_RoomSearch_inputExpanded:this.state.query||this.state.focused});let s=o.createElement("div",{className:"mx_RoomSearch_icon"}),n=o.createElement("input",{type:"text",ref:this.inputRef,className:t,value:this.state.query,onFocus:this.onFocus,onBlur:this.onBlur,onChange:this.onChange,onKeyDown:this.onKeyDown,placeholder:Object(l.a)("Search"),autoComplete:"off"}),i=o.createElement(u.a,{tabIndex:-1,title:Object(l.a)("Clear filter"),className:"mx_RoomSearch_clearButton",onClick:this.clearInput});return this.props.isMinimized&&(s=o.createElement(u.a,{title:Object(l.a)("Search rooms"),className:"mx_RoomSearch_icon",onClick:this.openSearch}),n=null,i=null),o.createElement("div",{className:e},s,n,i)}}}).call(this,s(136).setImmediate)},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(79),c=s.n(a),l=s(45),d=s.n(l),u=s(51),h=s.n(u),m=s(46),p=s(48),g=s(50);function f(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}class _ extends r.a.Component{constructor(e){super(e),i()(this,"getRemoteVideoElement",()=>c.a.findDOMNode(this._remote.current)),i()(this,"getRemoteAudioElement",()=>{const e=document.getElementById("remoteAudio");return e||console.error("Failed to find remoteAudio element - cannot play audio!You need to add an <audio/> to the DOM."),e}),i()(this,"getLocalVideoElement",()=>c.a.findDOMNode(this._local.current)),i()(this,"setContainer",e=>{this.container=e}),i()(this,"onAction",e=>{switch(e.action){case"video_fullscreen":{if(!this.container)return;const t=this.container;if(e.fullscreen){(t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen).call(t)}else if(f()){const e=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}break}}}),this._local=Object(o.createRef)(),this._remote=Object(o.createRef)()}componentDidMount(){this.dispatcherRef=p.a.register(this.onAction)}componentWillUnmount(){p.a.unregister(this.dispatcherRef)}render(){const e=m.getComponent("voip.VideoFeed"),t=f()?null:this.props.maxHeight,s=h()("mx_VideoView_localVideoFeed",{mx_VideoView_localVideoFeed_flipped:g.a.getValue("VideoView.flipVideoHorizontally")});return r.a.createElement("div",{className:"mx_VideoView",ref:this.setContainer,onClick:this.props.onClick},r.a.createElement("div",{className:"mx_VideoView_remoteVideoFeed"},r.a.createElement(e,{ref:this._remote,onResize:this.props.onResize,maxHeight:t})),r.a.createElement("div",{className:s},r.a.createElement(e,{ref:this._local})))}}i()(_,"propTypes",{maxHeight:d.a.number,onClick:d.a.func,onResize:d.a.func})},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"ConferenceCall",(function(){return r})),s.d(t,"isConferenceUser",(function(){return a})),s.d(t,"getConferenceUserIdForRoom",(function(){return c})),s.d(t,"createNewMatrixCall",(function(){return l})),s.d(t,"getConferenceCallForRoom",(function(){return d})),s.d(t,"slot",(function(){return u}));var n=s(55),i=s(101),o=s(47);function r(e,t){this.client=e,this.groupRoomId=t,this.confUserId=c(this.groupRoomId)}function a(t){if(0!==t.indexOf("@fs_"))return!1;const s=t.split(":")[0].substring(1+"fs_".length);if(s){const t=new e(s,"base64").toString();return/^!.+:.+/.test(t)}return!1}function c(t){return"@fs_"+new e(t).toString("base64").replace(/=/g,"")+":matrix.org"}function l(e,t){return new r(e,t).setup()}function d(e){const t=i.a.getAnyActiveCall();if(t&&t.confUserId){if(c(e)===t.confUserId)return t}return null}r.prototype.setup=function(){const e=this;return this._joinConferenceUser().then((function(){return e._getConferenceUserRoom()})).then((function(t){const s=Object(n.q)(e.client,t.roomId);return s.confUserId=e.confUserId,s.groupRoomId=e.groupRoomId,s}))},r.prototype._joinConferenceUser=function(){const e=this.client.getRoom(this.groupRoomId);if(!e)return Promise.reject("Bad group room ID");const t=e.getMember(this.confUserId);return t&&"join"===t.membership?Promise.resolve():this.client.invite(this.groupRoomId,this.confUserId)},r.prototype._getConferenceUserRoom=function(){const e=this.client.getRooms();let t=null;for(let s=0;s<e.length;s++){const n=e[s].getMember(this.confUserId);if(n&&"join"===n.membership&&2===e[s].getJoinedMemberCount()){t=e[s];break}}return t?Promise.resolve(t):this.client.createRoom({preset:"private_chat",invite:[this.confUserId]}).then((function(e){return new n.j(e.room_id,null,o.a.get().getUserId())}))};const u="conference"}.call(this,s(22).Buffer)},,function(e,t,s){"use strict";s.d(t,"c",(function(){return g})),s.d(t,"a",(function(){return f})),s.d(t,"d",(function(){return _})),s.d(t,"b",(function(){return v}));var n=s(47),i=s(48),o=s(49),r=s(46),a=s(44),c=s(70),l=s(98),d=s(105),u=s(227),h=s(54);async function m(){const e=n.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(d.b)(),!1)}function p(e){const{device:t,user:i,onFinished:o}=e,c=r.getComponent("dialogs.BaseDialog"),l=r.getComponent("elements.AccessibleButton");let d,u;return n.a.get().getUserId()===i.userId?(u=Object(a.a)("You signed in to a new session without verifying it:"),d=Object(a.a)("Verify your other session using one of the options below.")):(u=Object(a.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:i.displayName,userId:i.userId}),d=Object(a.a)("Ask this user to verify their session, or manually verify it below.")),React.createElement(c,{onFinished:o,headerImage:s(256),title:Object(a.a)("Not Trusted")},React.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},React.createElement("p",null,u),React.createElement("p",null,t.getDisplayName()," (",t.deviceId,")"),React.createElement("p",null,d)),React.createElement("div",{className:"mx_Dialog_buttons"},React.createElement(l,{element:"button",kind:"secondary",onClick:()=>o("legacy")},Object(a.a)("Manually Verify by Text")),React.createElement(l,{element:"button",kind:"secondary",onClick:()=>o("sas")},Object(a.a)("Interactively verify by Emoji")),React.createElement(l,{kind:"primary",onClick:()=>o()},Object(a.a)("Done"))))}async function g(e,t){const s=n.a.get();s.getCryptoTrustCrossSignedDevices()&&!await m()||o.a.createTrackedDialog("Verification warning","unverified session",p,{user:e,device:t,onFinished:async n=>{if("sas"===n){const n=s.legacyDeviceVerification(e.userId,t.deviceId,u.d.SAS);i.a.dispatch({action:h.a.SetRightPanelPhase,phase:c.b.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:n}})}else if("legacy"===n){const s=r.getComponent("dialogs.ManualDeviceKeyVerificationDialog");o.a.createTrackedDialog("Legacy verify session","legacy verify session",s,{userId:e.userId,device:t})}}})}async function f(e){const t=n.a.get();if(t.getCryptoTrustCrossSignedDevices()&&!await m())return;const s=t.requestVerification(e.userId);i.a.dispatch({action:h.a.SetRightPanelPhase,phase:c.b.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:s}})}async function _(e){if(!await m())return;const t=v(e);i.a.dispatch({action:h.a.SetRightPanelPhase,phase:c.b.EncryptionPanel,refireParams:{member:e,verificationRequest:t}})}function v(e){const t=n.a.get(),s=Object(l.d)(t,e.userId);if(s)return t.findVerificationRequestDMInProgress(s.roomId)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(43),i=s(145);function o(e,t){const[s,o]=Object(n.useState)(t?e.isRoomEncrypted(t.roomId):void 0),r=Object(n.useCallback)(s=>{t&&"m.room.encryption"===s.getType()&&o(e.isRoomEncrypted(t.roomId))},[e,t]);return Object(i.a)(t?t.currentState:void 0,"RoomState.events",r),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n=s(2),i=s.n(n),o=s(43),r=s(45),a=s(187),c=s(133),l=s(226),d=s(156),u=s(81),h=s(46),m=s(44),p=s(346),g=s(65),f=s(61),_=s(260),v=s(94),y=s(68);function b(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?b(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):b(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const S=[{name:"Facebook",img:s(863),url:e=>"https://www.facebook.com/sharer/sharer.php?u="+e},{name:"Twitter",img:s(864),url:e=>"https://twitter.com/home?status="+e},{name:"LinkedIn",img:s(865),url:e=>"https://www.linkedin.com/shareArticle?mini=true&url="+e},{name:"Reddit",img:s(866),url:e=>"http://www.reddit.com/submit?url="+e},{name:"email",img:s(867),url:e=>"mailto:?body="+e}];class w extends o.PureComponent{constructor(e){super(e),i()(this,"closeCopiedTooltip",void 0),this.onCopyClick=this.onCopyClick.bind(this),this.onLinkSpecificEventCheckboxClick=this.onLinkSpecificEventCheckboxClick.bind(this);let t=null;e.target instanceof a.a&&(t=new g.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof u.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(_.c)(e.target)}async onCopyClick(e){e.preventDefault();const t=e.target,s=await Object(_.b)(this.getUrl()),n=t.getBoundingClientRect(),i=h.getComponent("context_menus.GenericTextContextMenu"),{close:o}=f.l(i,E(E({},Object(f.n)(n,2)),{},{message:s?Object(m.a)("Copied!"):Object(m.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=o}onLinkSpecificEventCheckboxClick(){this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getUrl(){let e;if(this.props.target instanceof a.a)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forRoom();else this.props.target instanceof c.a||this.props.target instanceof d.a?e=Object(g.g)(this.props.target.userId):this.props.target instanceof l.a?e=Object(g.e)(this.props.target.groupId):this.props.target instanceof u.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forRoom());return e}render(){let e,t;if(this.props.target instanceof a.a){e=Object(m.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(t=o.createElement("div",null,o.createElement(v.a,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(m.a)("Link to most recent message"))))}else this.props.target instanceof c.a||this.props.target instanceof d.a?e=Object(m.a)("Share User"):this.props.target instanceof l.a?e=Object(m.a)("Share Community"):this.props.target instanceof u.b&&(e=Object(m.a)("Share Room Message"),t=o.createElement("div",null,o.createElement(v.a,{checked:this.state.linkSpecificEvent,onClick:this.onLinkSpecificEventCheckboxClick},Object(m.a)("Link to selected message"))));const s=this.getUrl(),n=encodeURIComponent(s),i=h.getComponent("views.dialogs.BaseDialog");return o.createElement(i,{title:e,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ShareDialog_content"},o.createElement("div",{className:"mx_ShareDialog_matrixto"},o.createElement("a",{href:s,onClick:w.onLinkClick,className:"mx_ShareDialog_matrixto_link"},s),o.createElement(y.a,{title:Object(m.a)("Copy"),onClick:this.onCopyClick,className:"mx_ShareDialog_matrixto_copy"})),t,o.createElement("hr",null),o.createElement("div",{className:"mx_ShareDialog_split"},o.createElement("div",{className:"mx_ShareDialog_qrcode_container"},o.createElement(p.a,{data:s,width:256})),o.createElement("div",{className:"mx_ShareDialog_social_container"},S.map(e=>o.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(n),className:"mx_ShareDialog_social_icon"},o.createElement("img",{src:e.img,alt:e.name,height:64,width:64})))))))}}i()(w,"propTypes",{onFinished:r.func.isRequired,target:r.oneOfType([r.instanceOf(a.a),r.instanceOf(c.a),r.instanceOf(l.a),r.instanceOf(d.a),r.instanceOf(u.b)]).isRequired})},,,,,function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(59),r=s(149),a=s(76),c=s(52),l=s(262),d=s(44),u=s(345),h=s(70),m=s(48),p=s(54),g=s(261),f=s(142),_=s(61),v=s(213),y=s(7),b=s(68),E=s(51),S=s.n(E);t.a=({room:e,widgetId:t,onClose:s})=>{const E=Object(n.useContext)(o.a),w=Object(u.b)(e).find(e=>e.id===t),C=w&&g.a.instance.isPinned(w.id),[R,k,I,O]=Object(_.o)();if(Object(n.useEffect)(()=>{w&&!C||m.a.dispatch({action:p.a.SetRightPanelPhase,phase:h.b.RoomSummary})},[w,C]),!w||C)return null;const T=i.a.createElement(i.a.Fragment,null,i.a.createElement("h2",null,a.a.getWidgetName(w))),x=a.a.canUserModifyWidgets(e.roomId);let N;if(R){let e,t;if(f.a.widgetHasCapability(w.id,y.a.Screenshot)){const t=()=>{a.a.snapshotWidget(w),O()};e=i.a.createElement(v.b,{onClick:t,label:Object(d.a)("Take a picture")})}if(x){const e=()=>{m.a.dispatch({action:p.a.AppTileDelete,widgetId:w.id}),O()};t=i.a.createElement(v.b,{onClick:e,label:Object(d.a)("Remove for everyone")})}const s=()=>{m.a.dispatch({action:p.a.AppTileRevoke,widgetId:w.id}),O()},n=k.current.getBoundingClientRect();N=i.a.createElement(v.e,{chevronFace:_.a.None,right:window.innerWidth-n.right,bottom:window.innerHeight-n.top,onFinished:O},i.a.createElement(v.c,null,e,t,i.a.createElement(v.b,{onClick:s,label:Object(d.a)("Remove for me")})))}const j=()=>{g.a.instance.pinWidget(w.id)},P=()=>{a.a.editWidget(e,w)};let D;x&&(D=i.a.createElement(c.a,{kind:"secondary",onClick:P},Object(d.a)("Edit")));const A=x?"":"mx_WidgetCard_widePinButton";let U;U=g.a.instance.canPin(w.id)?i.a.createElement(c.a,{kind:"secondary",onClick:j,className:A},Object(d.a)("Pin to room")):i.a.createElement(b.a,{title:Object(d.a)("You can only pin 2 apps at a time"),tooltipClassName:"mx_WidgetCard_maxPinnedTooltip",kind:"secondary",className:A,disabled:!0},Object(d.a)("Pin to room"));const M=i.a.createElement(i.a.Fragment,null,D,U,i.a.createElement(_.c,{kind:"secondary",className:"mx_WidgetCard_optionsButton",inputRef:k,onClick:I,isExpanded:R,label:Object(d.a)("Options")}),N);return i.a.createElement(r.b,{header:T,footer:M,className:S()("mx_WidgetCard",{mx_WidgetCard_noEdit:!x}),onClose:s,previousPhase:h.b.RoomSummary,withoutScrollContainer:!0},i.a.createElement(l.a,{app:w,fullWidth:!0,show:!0,showMenubar:!1,room:e,userId:E.getUserId(),creatorUserId:w.creatorUserId,widgetPageTitle:a.a.getWidgetDataTitle(w),waitForIframeLoad:w.waitForIframeLoad,whitelistCapabilities:a.a.getCapWhitelistForAppTypeInRoomId(w.type,e.roomId)}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(50),u=s(46),h=s(129),m=s(76),p=s(57);class g extends r.a.Component{constructor(){super(),i()(this,"_onAllow",()=>{this._onPermissionSelection(!0)}),i()(this,"_onDeny",()=>{this._onPermissionSelection(!1)}),i()(this,"_onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}_onPermissionSelection(e){if(this.state.rememberSelection){console.log(`Remembering ${this.props.widgetId} as allowed=${e} for OpenID`);const t=d.a.getValue("widgetOpenIDPermissions");t.allow||(t.allow=[]),t.deny||(t.deny=[]);const s=m.a.getWidgetSecurityKey(this.props.widgetId,this.props.widgetUrl,this.props.isUserWidget);(e?t.allow:t.deny).push(s),d.a.setValue("widgetOpenIDPermissions",null,p.a.DEVICE,t)}this.props.onFinished(e)}render(){const e=u.getComponent("views.dialogs.BaseDialog"),t=u.getComponent("views.elements.DialogButtons");return r.a.createElement(e,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("A widget would like to verify your identity")},r.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},r.a.createElement("p",null,Object(l.a)("A widget located at %(widgetUrl)s would like to verify your identity. By allowing this, the widget will be able to verify your user ID, but not perform actions as you.",{widgetUrl:this.props.widgetUrl})),r.a.createElement(h.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this._onRememberSelectionChange,label:Object(l.a)("Remember my selection for this widget")})),r.a.createElement(t,{primaryButton:Object(l.a)("Allow"),onPrimaryButtonClick:this._onAllow,cancelButton:Object(l.a)("Deny"),onCancel:this._onDeny}))}}i()(g,"propTypes",{onFinished:c.a.func.isRequired,widgetUrl:c.a.string.isRequired,widgetId:c.a.string.isRequired,isUserWidget:c.a.bool.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(66),d=s.n(l),u=s(46),h=s(44),m=s(53),p=s(76),g=s(47);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function _(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class v extends r.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),s=g.a.get().getRoom(this.props.roomId);let n;s&&(n=s.getMember(this.props.creatorUserId)),this.state=_(_({},t),{},{roomMember:n})}parseWidgetUrl(){const e=d.a.parse(this.props.url),t=new URLSearchParams(e.search);if(p.a.isScalarUrl(e)&&t&&t.get("url")){const e=d.a.parse(t.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=m.a.get().brand,t=u.getComponent("views.elements.AccessibleButton"),s=u.getComponent("views.avatars.MemberAvatar"),n=u.getComponent("views.avatars.BaseAvatar"),i=u.getComponent("views.elements.TextWithTooltip"),o=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,a=o===this.props.creatorUserId?null:this.props.creatorUserId,c=this.state.roomMember?r.a.createElement(s,{member:this.state.roomMember,width:38,height:38}):r.a.createElement(n,{name:this.props.creatorUserId,width:38,height:38}),l=r.a.createElement("div",null,Object(h.a)("Any of the following data may be shared:"),r.a.createElement("ul",null,r.a.createElement("li",null,Object(h.a)("Your display name")),r.a.createElement("li",null,Object(h.a)("Your avatar URL")),r.a.createElement("li",null,Object(h.a)("Your user ID")),r.a.createElement("li",null,Object(h.a)("Your theme")),r.a.createElement("li",null,Object(h.a)("%(brand)s URL",{brand:e})),r.a.createElement("li",null,Object(h.a)("Room ID")),r.a.createElement("li",null,Object(h.a)("Widget ID")))),d=r.a.createElement(i,{tooltip:l,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},r.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),p=this.state.isWrapped?Object(h.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your Integration Manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>d}):Object(h.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>d}),g=this.props.isRoomEncrypted?Object(h.a)("Widgets do not use message encryption."):null;return r.a.createElement("div",{className:"mx_AppPermissionWarning"},r.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(h.a)("Widget added by")),r.a.createElement("div",{className:"mx_AppPermissionWarning_row"},c,r.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},o),r.a.createElement("div",{className:"mx_AppPermissionWarning_smallText"},a)),r.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},p),r.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(h.a)("This widget may use cookies.")," ",g),r.a.createElement("div",{className:"mx_AppPermissionWarning_row"},r.a.createElement(t,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(h.a)("Continue"))))}}i()(v,"propTypes",{url:c.a.string.isRequired,creatorUserId:c.a.string.isRequired,roomId:c.a.string.isRequired,onPermissionGranted:c.a.func.isRequired,isRoomEncrypted:c.a.bool}),i()(v,"defaultProps",{onPermissionGranted:()=>{}})},function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(45);const r=e=>i.a.createElement("div",{className:"mx_AppPermissionWarning"},i.a.createElement("div",{className:"mx_AppPermissionWarningImage"},i.a.createElement("img",{src:s(184),alt:""})),i.a.createElement("div",{className:"mx_AppPermissionWarningText"},i.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg)));r.propTypes={errorMsg:s.n(o).a.string},r.defaultProps={errorMsg:"Error"},t.a=r},function(e,t,s){"use strict";var n=s(43);const i=Object(n.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,draggingFile:!1,searching:!1,guestsCanJoin:!1,canPeek:!1,showApps:!1,isAlone:!1,isPeeking:!1,showingPinned:!1,showReadReceipts:!0,showRightPanel:!0,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,useIRCLayout:!1,matrixClientIsReady:!1});i.displayName="RoomContext",t.a=i},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(58),d=s(178),u=s(69);let h;h=function(){};class m extends r.a.Component{constructor(e){super(e),i()(this,"onScroll",e=>{this.props.resizeNotifier.isResizing||(h("onScroll",this._getScrollNode().scrollTop),this._scrollTimeout.restart(),this._saveScrollState(),this.updatePreventShrinking(),this.props.onScroll(e),this.checkFillState())}),i()(this,"onResize",()=>{h("onResize"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()}),i()(this,"checkScroll",()=>{this.unmounted||(this._restoreSavedScrollState(),this.checkFillState())}),i()(this,"isAtBottom",()=>{const e=this._getScrollNode();return Math.abs(e.scrollHeight-(e.scrollTop+e.clientHeight))<=1}),i()(this,"checkFillState",async(e=0)=>{if(this.unmounted)return;const t=0===e,s=this._getScrollNode();if(t){if(this._isFilling)return h("_isFilling: not entering while request is ongoing, marking for a subsequent request"),void(this._fillRequestWhileRunning=!0);h("_isFilling: setting"),this._isFilling=!0}const n=this._itemlist.current,i=n&&n.firstElementChild,o=i&&i.offsetTop,r=[];if((!i||s.scrollTop-o<s.clientHeight)&&r.push(this._maybeFill(e,!0)),s.scrollHeight-s.scrollTop<2*s.clientHeight&&r.push(this._maybeFill(e,!1)),r.length)try{await Promise.all(r)}catch(e){console.error(e)}t&&(h("_isFilling: clearing"),this._isFilling=!1),this._fillRequestWhileRunning&&(this._fillRequestWhileRunning=!1,this.checkFillState())}),i()(this,"getScrollState",()=>this.scrollState),i()(this,"resetScrollState",()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this._bottomGrowth=0,this._pages=0,this._scrollTimeout=new d.a(100),this._heightUpdateInProgress=!1}),i()(this,"scrollToTop",()=>{this._getScrollNode().scrollTop=0,this._saveScrollState()}),i()(this,"scrollToBottom",()=>{const e=this._getScrollNode();e.scrollTop=e.scrollHeight,this._saveScrollState()}),i()(this,"scrollRelative",e=>{const t=this._getScrollNode(),s=e*t.clientHeight*.5;t.scrollBy(0,s),this._saveScrollState()}),i()(this,"handleScrollKey",e=>{switch(e.key){case l.a.PAGE_UP:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollRelative(-1);break;case l.a.PAGE_DOWN:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollRelative(1);break;case l.a.HOME:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollToTop();break;case l.a.END:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollToBottom()}}),i()(this,"scrollToToken",(e,t,s)=>{t=t||0,s=s||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const n=this._getTrackedNode(),i=this._getScrollNode();n&&(h("scrollToken: setting scrollTop",{offsetBase:s,pixelOffset:t,offsetTop:n.offsetTop}),i.scrollTop=n.offsetTop-i.clientHeight*s+t,this._saveScrollState())}),i()(this,"_collectScroll",e=>{this._divScroll=e}),i()(this,"preventShrinking",()=>{const e=this._itemlist.current,t=e&&e.children;if(!e)return;let s;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n.dataset.scrollTokens){s=n;break}}if(!s)return;this.clearPreventShrinking();const n=e.clientHeight-(s.offsetTop+s.clientHeight);this.preventShrinkingState={offsetFromBottom:n,offsetNode:s},h("prevent shrinking, last tile ",n,"px from bottom")}),i()(this,"clearPreventShrinking",()=>{const e=this._itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,h("prevent shrinking cleared")}),i()(this,"updatePreventShrinking",()=>{if(this.preventShrinkingState){const e=this._getScrollNode(),t=this.scrollState,s=this._itemlist.current,{offsetNode:n,offsetFromBottom:i}=this.preventShrinkingState,o=s.parentElement;let r=!n.parentElement;if(!r&&!t.stuckAtBottom){r=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!r){const e=i-(s.clientHeight-(n.offsetTop+n.clientHeight));e>0?(o.style.paddingBottom=e+"px",h("update prevent shrinking ",e,"px from bottom")):e<0&&(r=!0)}r&&this.clearPreventShrinking()}}),this._pendingFillRequests={b:null,f:null},this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState(),this._itemlist=Object(o.createRef)()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(),this.updatePreventShrinking()}componentWillUnmount(){this.unmounted=!0,this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResizedNoisy",this.onResize)}_getExcessHeight(e){const t=this._getScrollNode(),s=this._getMessagesHeight(),n=s-this._getListHeight(),i=t.scrollTop+n;return e?i-t.clientHeight-6e3:s-(i+2*t.clientHeight)-6e3}_checkUnfillState(e){let t=this._getExcessHeight(e);if(t<=0)return;const s=t,n=this._itemlist.current.children;let i,o=null;for(let s=0;s<n.length&&(i=n[e?s:n.length-1-s],t-=i.clientHeight,!(i.clientHeight>t));s++)i.dataset.scrollTokens&&(o=i.dataset.scrollTokens.split(",")[0]);o&&(this._unfillDebouncer&&clearTimeout(this._unfillDebouncer),this._unfillDebouncer=setTimeout(()=>{this._unfillDebouncer=null,h("unfilling now",e,s),this.props.onUnfillRequest(e,o)},200))}_maybeFill(e,t){const s=t?"b":"f";if(!this._pendingFillRequests[s])return h("starting "+s+" fill"),this._pendingFillRequests[s]=!0,new Promise(e=>setTimeout(e,1)).then(()=>this.props.onFillRequest(t)).finally(()=>{this._pendingFillRequests[s]=!1}).then(n=>{if(!this.unmounted)return this._checkUnfillState(!t),h(s+" fill complete; hasMoreResults:"+n),n?this.checkFillState(e+1):void 0});h("Already a "+s+" fill in progress - not starting another")}_saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void h("saved stuckAtBottom state");const e=this._getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),s=this._itemlist.current.children;let n=null;for(let e=s.length-1;e>=0&&!(s[e].dataset.scrollTokens&&(n=s[e],this._topFromBottom(n)>t));--e);if(!n)return void h("unable to save scroll state: found no children in the viewport");const i=n.dataset.scrollTokens.split(",")[0];h("saving anchored scroll state to message",n&&n.innerText,i);const o=this._topFromBottom(n);this.scrollState={stuckAtBottom:!1,trackedNode:n,trackedScrollToken:i,bottomOffset:o,pixelOffset:o-t}}async _restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this._getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this._itemlist.current,s=this._getTrackedNode();if(s){const n=this._topFromBottom(s),i=n-e.bottomOffset;this._bottomGrowth+=i,e.bottomOffset=n;const o=this._getListHeight()+"px";t.style.height!==o&&(t.style.height=o),h("balancing height because messages below viewport grew by",i)}}if(this._heightUpdateInProgress)h("not updating height because request already in progress");else{this._heightUpdateInProgress=!0;try{await this._updateHeight()}finally{this._heightUpdateInProgress=!1}}}async _updateHeight(){if(this._scrollTimeout.isRunning()?(h("updateHeight waiting for scrolling to end ... "),await this._scrollTimeout.finished()):h("updateHeight getting straight to business, no scrolling going on."),this.unmounted)return;const e=this._getScrollNode(),t=this._itemlist.current,s=this._getMessagesHeight(),n=e.clientHeight,i=Math.max(n,s);this._pages=Math.ceil(i/400),this._bottomGrowth=0;const o=this._getListHeight()+"px",r=this.scrollState;if(r.stuckAtBottom)t.style.height!==o&&(t.style.height=o),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),h("updateHeight to",o);else if(r.trackedScrollToken){const s=this._getTrackedNode();if(s){const n=s.offsetTop;t.style.height!==o&&(t.style.height=o);const i=s.offsetTop-n;e.scrollBy(0,i),h("updateHeight to",{newHeight:o,topDiff:i})}}}_getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(!t||!t.parentElement){let t;const s=this._itemlist.current.children,n=e.trackedScrollToken;for(let e=s.length-1;e>=0;--e){const i=s[e];if(i.dataset.scrollTokens&&-1!==i.dataset.scrollTokens.split(",").indexOf(n)){t=i;break}}t&&h("had to find tracked node again for "+e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;h("No node with ; '"+e.trackedScrollToken+"'")}_getListHeight(){return this._bottomGrowth+400*this._pages}_getMessagesHeight(){const e=this._itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}_topFromBottom(e){return this._itemlist.current.clientHeight-e.offsetTop}_getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel._getScrollNode called when unmounted");if(!this._divScroll)throw new Error("ScrollPanel._getScrollNode called before AutoHideScrollbar ref collected");return this._divScroll}render(){return r.a.createElement(u.a,{wrappedRef:this._collectScroll,onScroll:this.onScroll,className:"mx_ScrollPanel "+this.props.className,style:this.props.style},this.props.fixedChildren,r.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},r.a.createElement("ol",{ref:this._itemlist,className:"mx_RoomView_MessageList","aria-live":"polite",role:"list"},this.props.children)))}}i()(m,"propTypes",{stickyBottom:c.a.bool,startAtBottom:c.a.bool,onFillRequest:c.a.func,onUnfillRequest:c.a.func,onScroll:c.a.func,className:c.a.string,style:c.a.object,resizeNotifier:c.a.object,fixedChildren:c.a.node}),i()(m,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}})},function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(50),r=s(43),a=s.n(r),c=s(79),l=s.n(c),d=s(45),u=s.n(d),h=s(55),m=s(44),p=s(47),g=s(253),f=s(474),_=s(49),v=s(48),y=s(46),b=s(58),E=s(178),S=s(202),w=s(507),C=s(141);let R=function(){};class k extends a.a.Component{constructor(e){super(e),i()(this,"onMessageListUnfillRequest",(e,t)=>{const s=e?h.c.BACKWARDS:h.c.FORWARDS;R("TimelinePanel: unpaginating events in direction",s);const n=t,i=this.state.events.findIndex(e=>e.getId()===n),o=e?i+1:this.state.events.length-i;if(o>0){R("TimelinePanel: Unpaginating",o,"in direction",s),this._timelineWindow.unpaginate(o,e);const t=e?"canBackPaginate":"canForwardPaginate",{events:n,liveEvents:i,firstVisibleEventIndex:r}=this._getEvents();this.setState({[t]:!0,events:n,liveEvents:i,firstVisibleEventIndex:r})}}),i()(this,"onPaginationRequest",(e,t,s)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,s):e.paginate(t,s)),i()(this,"onMessageListFillRequest",e=>{if(!this._shouldPaginate())return Promise.resolve(!1);const t=e?h.c.BACKWARDS:h.c.FORWARDS,s=e?"canBackPaginate":"canForwardPaginate",n=e?"backPaginating":"forwardPaginating";return this.state[s]?this._timelineWindow.canPaginate(t)?e&&0!==this.state.firstVisibleEventIndex?(R("TimelinePanel: won't",t,"paginate past first visible event"),Promise.resolve(!1)):(R("TimelinePanel: Initiating paginate; backwards:"+e),this.setState({[n]:!0}),this.onPaginationRequest(this._timelineWindow,t,20).then(t=>{if(this.unmounted)return;R("TimelinePanel: paginate complete backwards:"+e+"; success:"+t);const{events:i,liveEvents:o,firstVisibleEventIndex:r}=this._getEvents(),a={[n]:!1,[s]:t,events:i,liveEvents:o,firstVisibleEventIndex:r},c=e?h.c.FORWARDS:h.c.BACKWARDS,l=e?"canForwardPaginate":"canBackPaginate";return!this.state[l]&&this._timelineWindow.canPaginate(c)&&(R("TimelinePanel: can now",c,"paginate again"),a[l]=!0),new Promise(s=>{this.setState(a,()=>{s(t&&(!e||0===r))})})})):(R("TimelinePanel: can't",t,"paginate any further"),this.setState({[s]:!1}),Promise.resolve(!1)):(R("TimelinePanel: have given up",t,"paginating this timeline"),Promise.resolve(!1))}),i()(this,"onMessageListScroll",e=>{if(this.props.onScroll&&this.props.onScroll(e),this.props.manageReadMarkers){const e=this.getReadMarkerPosition();e<0&&this.setState({readMarkerVisible:!0});const t=this._readMarkerTimeout(e);this._readMarkerActivityTimer.changeTimeout(t)}}),i()(this,"onAction",e=>{if("ignore_state_changed"===e.action&&this.forceUpdate(),"edit_event"===e.action){const t=e.event?new w.a(e.event):null;this.setState({editState:t},()=>{e.event&&this._messagePanel.current&&this._messagePanel.current.scrollToEventIfNeeded(e.event.getId())})}}),i()(this,"onRoomTimeline",(e,t,s,n,i)=>{i.timeline.getTimelineSet()===this.props.timelineSet&&!s&&i&&i.liveEvent&&this._messagePanel.current&&(this._messagePanel.current.getScrollState().stuckAtBottom?this._timelineWindow.paginate(h.c.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:s,firstVisibleEventIndex:n}=this._getEvents(),i=s[s.length-1],o={events:t,liveEvents:s,firstVisibleEventIndex:n};let r;if(this.props.manageReadMarkers){const t=p.a.get().credentials.userId,s=e.sender?e.sender.userId:null;r=!1,s==t||f.a.sharedInstance().userActiveRecently()?i&&0===this.getReadMarkerPosition()&&(this._setReadMarker(i.getId(),i.getTs(),!0),o.readMarkerVisible=!1,o.readMarkerEventId=i.getId(),r=!0):o.readMarkerVisible=!0}this.setState(o,()=>{this._messagePanel.current.updateTimelineMinHeight(),r&&this.props.onReadMarkerUpdated()})}):this.setState({canForwardPaginate:!0}))}),i()(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._loadTimeline()}),i()(this,"canResetTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()),i()(this,"onRoomRedaction",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),i()(this,"onEventReplaced",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),i()(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),i()(this,"onLocalEchoUpdated",(e,t,s)=>{this.unmounted||t===this.props.timelineSet.room&&this._reloadEvents()}),i()(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&"m.fully_read"===e.getType()&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),i()(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.forceUpdate()}),i()(this,"onSync",(e,t,s)=>{this.setState({clientSyncState:e})}),i()(this,"sendReadReceipt",()=>{if(o.a.getValue("lowBandwidth"))return;if(!this._messagePanel.current)return;if(!this.props.manageReadReceipts)return;const e=p.a.get();if(!e||e.isGuest())return;let t=!0;const s=this._getCurrentReadReceipt(!0),n=this._indexForEventId(s);s&&null===n&&this._timelineWindow.canPaginate(h.c.FORWARDS)&&(t=!1);const i=this._getLastDisplayedEventIndex({ignoreOwn:!0});null===i&&(t=!1);let r=this.state.events[i];t=t&&i>n&&this.lastRRSentEventId!=r.getId();const a=this.lastRMSentEventId!=this.state.readMarkerEventId;if(t||a){t?this.lastRRSentEventId=r.getId():r=null,this.lastRMSentEventId=this.state.readMarkerEventId;const e=this.props.timelineSet.room.roomId,s=!o.a.getValue("sendReadReceipts",e);R("TimelinePanel: Sending Read Markers for ",this.props.timelineSet.room.roomId,"rm",this.state.readMarkerEventId,r?"rr "+r.getId():""," hidden:"+s),p.a.get().setRoomReadMarkers(this.props.timelineSet.room.roomId,this.state.readMarkerEventId,r,{hidden:s}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode&&r)return p.a.get().sendReadReceipt(r,{hidden:s}).catch(e=>{console.error(e),this.lastRRSentEventId=void 0});console.error(e),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0}),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount("total",0),this.props.timelineSet.room.setUnreadNotificationCount("highlight",0),v.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId}))}}),i()(this,"updateReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this._getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this._setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()}),i()(this,"jumpToLiveTimeline",()=>{this._timelineWindow.canPaginate(h.c.FORWARDS)?this._loadTimeline():this._messagePanel.current&&this._messagePanel.current.scrollToBottom()}),i()(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this._messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this._messagePanel.current.getReadMarkerPosition()?this._loadTimeline(this.state.readMarkerEventId,0,1/3):this._messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),i()(this,"forgetReadMarker",()=>{if(!this.props.manageReadMarkers)return;const e=this._getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(e);let s;if(t){const n=t.getEvents().find(t=>t.getId()==e);n&&(s=n.getTs())}this._setReadMarker(e,s)}),i()(this,"isAtEndOfLiveTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._timelineWindow&&!this._timelineWindow.canPaginate(h.c.FORWARDS)),i()(this,"getScrollState",()=>this._messagePanel.current?this._messagePanel.current.getScrollState():null),i()(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this._messagePanel.current)return null;const e=this._messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=k.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null}),i()(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)}),i()(this,"handleScrollKey",e=>{this._messagePanel.current&&(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==b.a.END?this._messagePanel.current.handleScrollKey(e):this.jumpToLiveTimeline())}),i()(this,"getRelationsForEvent",(...e)=>this.props.timelineSet.getRelationsForEvent(...e)),R("TimelinePanel: mounting"),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0,this._messagePanel=Object(r.createRef)();let t=null;if(this.props.manageReadMarkers){const e=this.props.timelineSet.room.getAccountData("m.fully_read");t=e?e.getContent().event_id:this._getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:t,backPaginating:!1,forwardPaginating:!1,clientSyncState:p.a.get().getSyncState(),isTwelveHour:o.a.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:o.a.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:o.a.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:o.a.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=v.a.register(this.onAction),p.a.get().on("Room.timeline",this.onRoomTimeline),p.a.get().on("Room.timelineReset",this.onRoomTimelineReset),p.a.get().on("Room.redaction",this.onRoomRedaction),p.a.get().on("Room.redactionCancelled",this.onRoomRedaction),p.a.get().on("Room.receipt",this.onRoomReceipt),p.a.get().on("Room.localEchoUpdated",this.onLocalEchoUpdated),p.a.get().on("Room.accountData",this.onAccountData),p.a.get().on("Event.decrypted",this.onEventDecrypted),p.a.get().on("Event.replaced",this.onEventReplaced),p.a.get().on("sync",this.onSync)}UNSAFE_componentWillMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this._initTimeline(this.props)}UNSAFE_componentWillReceiveProps(e){if(e.timelineSet!==this.props.timelineSet&&console.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),e.eventId!=this.props.eventId)return console.log("TimelinePanel switching to eventId "+e.eventId+" (was "+this.props.eventId+")"),this._initTimeline(e)}shouldComponentUpdate(e,t){return!g.a(this.props,e)||!g.a(this.state,t)}componentWillUnmount(){this.unmounted=!0,this._readReceiptActivityTimer&&(this._readReceiptActivityTimer.abort(),this._readReceiptActivityTimer=null),this._readMarkerActivityTimer&&(this._readMarkerActivityTimer.abort(),this._readMarkerActivityTimer=null),v.a.unregister(this.dispatcherRef);const e=p.a.get();e&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Room.timelineReset",this.onRoomTimelineReset),e.removeListener("Room.redaction",this.onRoomRedaction),e.removeListener("Room.redactionCancelled",this.onRoomRedaction),e.removeListener("Room.receipt",this.onRoomReceipt),e.removeListener("Room.localEchoUpdated",this.onLocalEchoUpdated),e.removeListener("Room.accountData",this.onAccountData),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Event.replaced",this.onEventReplaced),e.removeListener("sync",this.onSync))}_readMarkerTimeout(e){return 0===e?this.state.readMarkerInViewThresholdMs:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this._readMarkerTimeout(this.getReadMarkerPosition());for(this._readMarkerActivityTimer=new E.a(e);this._readMarkerActivityTimer;){f.a.sharedInstance().timeWhileActiveRecently(this._readMarkerActivityTimer);try{await this._readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this._readReceiptActivityTimer=new E.a(500);this._readReceiptActivityTimer;){f.a.sharedInstance().timeWhileActiveNow(this._readReceiptActivityTimer);try{await this._readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}_advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers)return;const e=this._timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const s=p.a.get().credentials.userId;for(t++;t<e.length;t++){const n=e[t];if(!n.sender||n.sender.userId!=s)break}t--;const n=e[t];this._setReadMarker(n.getId(),n.getTs())}_initTimeline(e){const t=e.eventId,s=e.eventPixelOffset;let n=1;return null==s&&(n=.5),this._loadTimeline(t,s,n)}_loadTimeline(e,t,s){this._timelineWindow=new h.m(p.a.get(),this.props.timelineSet,{windowLimit:this.props.timelineCap});const n=()=>{this._messagePanel.current&&this._messagePanel.current.onTimelineReset(),this._reloadEvents(),this._advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:this._timelineWindow.canPaginate(h.c.BACKWARDS),canForwardPaginate:this._timelineWindow.canPaginate(h.c.FORWARDS),timelineLoading:!1},()=>{this._messagePanel.current?(e?this._messagePanel.current.scrollToEvent(e,t,s):this._messagePanel.current.scrollToBottom(),this.sendReadReceipt()):console.log("can't initialise scroll state because messagePanel didn't load")})},i=t=>{this.setState({timelineLoading:!1}),console.error(`Error loading timeline panel at ${e}: ${t}`);const s=y.getComponent("dialogs.ErrorDialog");let n,i;e&&(n=()=>{v.a.dispatch({action:"view_room",room_id:this.props.timelineSet.room.roomId})}),i="M_FORBIDDEN"==t.errcode?Object(m.a)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(m.a)("Tried to load a specific point in this room's timeline, but was unable to find it."),_.a.createTrackedDialog("Failed to load timeline position","",s,{title:Object(m.a)("Failed to load timeline position"),description:i,onFinished:n})};if(this.props.timelineSet.getTimelineForEvent(e))this._timelineWindow.load(e,20),n();else{const t=this._timelineWindow.load(e,20);this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),t.then(n,i)}}_reloadEvents(){this.unmounted||this.setState(this._getEvents())}_getEvents(){const e=this._timelineWindow.getEvents(),t=this._checkForPreJoinUISI(e),s=[...e];return this._timelineWindow.canPaginate(h.c.FORWARDS)||e.push(...this.props.timelineSet.getPendingEvents()),{events:e,liveEvents:s,firstVisibleEventIndex:t}}_checkForPreJoinUISI(e){const t=this.props.timelineSet.room;if(0===e.length||!t||!p.a.get().isRoomEncrypted(t.roomId))return 0;const s=p.a.get().credentials.userId;let n,i="leave";for(n=e.length-1;n>=0;n--){const o=t.getTimelineForEvent(e[n].getId());if(!o){console.warn(`Event ${e[n].getId()} in room ${t.roomId} is live, but it does not have a timeline`);continue}const r=o.getState(h.c.FORWARDS).getMember(s);i=r?r.membership:"leave";const a=o.getEvents();for(let t=a.length-1;t>=0;t--){const o=a[t];if(o.getId()===e[n].getId())break;if(o.getStateKey()===s&&"m.room.member"===o.getType()){i=o.getPrevContent().membership||"leave"}}break}for(;n>=0;n--){const t=e[n];if(t.getStateKey()===s&&"m.room.member"===t.getType()){i=t.getPrevContent().membership||"leave"}else if("leave"===i&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return n+1}return 0}_indexForEventId(e){for(let t=0;t<this.state.events.length;++t)if(e==this.state.events[t].getId())return t;return null}_getLastDisplayedEventIndex(e){const t=(e=e||{}).ignoreOwn||!1,s=e.allowPartial||!1,n=this._messagePanel.current;if(!n)return null;const i=l.a.findDOMNode(n);if(!i)return null;const o=i.getBoundingClientRect(),r=p.a.get().credentials.userId,a=e=>{if(e){const t=e.getBoundingClientRect();if(s&&t.top<o.bottom||!s&&t.bottom<o.bottom)return!0}return!1};let c=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){const s=this.state.liveEvents[e],i=n.getNodeForEventId(s.getId()),o=a(i);if(o&&0!==c)return e+c;i&&!o&&(c=0);const l=!!s.status||t&&s.sender&&s.sender.userId==r;if(!(!Object(C.b)(s)||Object(S.a)(s))&&i){if(!l&&o)return e}else(!l||l&&0!==c)&&++c}return null}_getCurrentReadReceipt(e){const t=p.a.get();if(null==t)return null;const s=t.credentials.userId;return this.props.timelineSet.room.getEventReadUpTo(s,e)}_setReadMarker(e,t,s){const n=this.props.timelineSet.room.roomId;e!==this.state.readMarkerEventId&&(k.roomReadMarkerTsMap[n]=t,s||this.setState({readMarkerEventId:e},this.props.onReadMarkerUpdated))}_shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}render(){const e=y.getComponent("structures.MessagePanel"),t=y.getComponent("elements.Spinner");if(this.state.timelineLoading)return a.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},a.a.createElement(t,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return a.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},a.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const s=!this._timelineWindow.canPaginate(h.c.FORWARDS),n=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),i=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return a.a.createElement(e,{ref:this._messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:n,events:i,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,suppressFirstDateSeparator:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:p.a.get().credentials.userId,stickyBottom:s,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:this.state.isTwelveHour,alwaysShowTimestamps:this.state.alwaysShowTimestamps,className:this.props.className,tileShape:this.props.tileShape,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.state.editState,showReactions:this.props.showReactions,useIRCLayout:this.props.useIRCLayout})}}i()(k,"propTypes",{timelineSet:u.a.object.isRequired,showReadReceipts:u.a.bool,manageReadReceipts:u.a.bool,manageReadMarkers:u.a.bool,hidden:u.a.bool,highlightedEventId:u.a.string,eventId:u.a.string,eventPixelOffset:u.a.number,showUrlPreview:u.a.bool,onScroll:u.a.func,onReadMarkerUpdated:u.a.func,onPaginationRequest:u.a.func,timelineCap:u.a.number,className:u.a.string,tileShape:u.a.string,empty:u.a.node,showReactions:u.a.bool,useIRCLayout:u.a.bool}),i()(k,"roomReadMarkerTsMap",{}),i()(k,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel"}),t.a=k},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this._event=e,this._serializedParts=null,this.caret=null}setEditorState(e,t){this._caret=e,this._serializedParts=t}hasEditorState(){return!!this._serializedParts}getSerializedParts(){return this._serializedParts}getCaret(){return this._caret}getEvent(){return this._event}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(46),c=s(44),l=s(47),d=s(62),u=s(49);class h extends r.a.PureComponent{constructor(e){super(e),i()(this,"_onClearCacheAndReload",()=>{d.a.get()&&(l.a.get().stopClient(),l.a.get().store.deleteAllData().then(()=>{d.a.get().reload()}))}),i()(this,"_onBugReport",()=>{const e=a.getComponent("dialogs.BugReportDialog");e&&u.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,{componentStack:t}){console.error(e),console.error("The above error occured while React was rendering the following components:",t)}render(){if(this.state.error){const e=a.getComponent("elements.AccessibleButton"),t="https://github.com/vector-im/element-web/issues/new";return r.a.createElement("div",{className:"mx_ErrorBoundary"},r.a.createElement("div",{className:"mx_ErrorBoundary_body"},r.a.createElement("h1",null,Object(c.a)("Something went wrong!")),r.a.createElement("p",null,Object(c.a)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:e=>r.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:t},e)})),r.a.createElement("p",null,Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages.")),r.a.createElement(e,{onClick:this._onBugReport,kind:"primary"},Object(c.a)("Submit debug logs")),r.a.createElement(e,{onClick:this._onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))))}return this.props.children}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(47),u=s(48),h=s(51),m=s.n(h),p=s(44),g=s(53),f=s(123),_=s(124),v=s(86);const y=Object.freeze({NotLoggedIn:"NotLoggedIn",Joining:"Joining",Loading:"Loading",Rejecting:"Rejecting",Kicked:"Kicked",Banned:"Banned",OtherThreePIDError:"OtherThreePIDError",InvitedEmailNotFoundInAccount:"InvitedEmailNotFoundInAccount",InvitedEmailNoIdentityServer:"InvitedEmailNoIdentityServer",InvitedEmailMismatch:"InvitedEmailMismatch",Invite:"Invite",ViewingRoom:"ViewingRoom",RoomNotFound:"RoomNotFound",OtherError:"OtherError"});class b extends r.a.Component{constructor(...e){super(...e),i()(this,"state",{busy:!1}),i()(this,"_onCommunityUpdate",e=>{this.props.room&&this.props.room.roomId!==e||this.forceUpdate()}),i()(this,"onLoginClick",()=>{u.a.dispatch({action:"start_login",screenAfterLogin:this._makeScreenAfterLogin()})}),i()(this,"onRegisterClick",()=>{u.a.dispatch({action:"start_registration",screenAfterLogin:this._makeScreenAfterLogin()})})}componentDidMount(){this._checkInvitedEmail(),_.a.instance.on(v.b,this._onCommunityUpdate)}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this._checkInvitedEmail()}componentWillUnmount(){_.a.instance.off(v.b,this._onCommunityUpdate)}async _checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await d.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!d.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new f.a,s=await t.getAccessToken(),n=await d.a.get().lookupThreePid("email",this.props.invitedEmail,void 0,s);this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}_getMessageCase(){if(d.a.get().isGuest())return y.NotLoggedIn;const e=this._getMyMember();if(e){if(e.isKicked())return y.Kicked;if("ban"===e.membership)return y.Banned}if(this.props.joining)return y.Joining;if(this.props.rejecting)return y.Rejecting;if(this.props.loading||this.state.busy)return y.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return y.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return y.InvitedEmailNotFoundInAccount;if(!d.a.get().getIdentityServerUrl())return y.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=d.a.get().getUserId())return y.InvitedEmailMismatch}return y.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?y.RoomNotFound:y.OtherError:y.ViewingRoom}_getKickOrBanInfo(){const e=this._getMyMember();if(!e)return{};const t=this.props.room.currentState.getMember(e.events.member.getSender());return{memberName:t?t.name:e.events.member.getSender(),reason:e.events.member.getContent().reason}}_joinRule(){const e=this.props.room;if(e){const t=e.currentState.getStateEvents("m.room.join_rules","");if(t)return t.getContent().join_rule}}_communityProfile(){return this.props.room?_.a.instance.getInviteProfile(this.props.room.roomId):{displayName:null,avatarMxc:null}}_roomName(e=!1){let t=this.props.room?this.props.room.name:this.props.roomAlias;const s=this._communityProfile();return s.displayName&&(t=s.displayName),t||(e?Object(p.a)("This room"):Object(p.a)("this room"))}_getMyMember(){return this.props.room&&this.props.room.getMember(d.a.get().getUserId())}_getInviteMember(){const{room:e}=this.props;if(!e)return;const t=d.a.get().getUserId(),s=e.currentState.getMember(t);if(!s)return;const n=s.events.member.getSender();return e.currentState.getMember(n)}_isDMInvite(){const e=this._getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}_makeScreenAfterLogin(){return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:this.props.oobData?this.props.oobData.room_name:null,room_avatar_url:this.props.oobData?this.props.oobData.avatarUrl:null,inviter_name:this.props.oobData?this.props.oobData.inviterName:null}}}render(){const e=g.a.get().brand,t=l.getComponent("elements.Spinner"),s=l.getComponent("elements.AccessibleButton");let n,i,o,a,c,d,u,h=!1;const f=[],_=this._getMessageCase();switch(_){case y.Joining:n=Object(p.a)("Joining room …"),h=!0;break;case y.Loading:n=Object(p.a)("Loading …"),h=!0;break;case y.Rejecting:n=Object(p.a)("Rejecting invite …"),h=!0;break;case y.NotLoggedIn:n=Object(p.a)("Join the conversation with an account"),a=Object(p.a)("Sign Up"),o=this.onRegisterClick,d=Object(p.a)("Sign In"),c=this.onLoginClick,this.props.previewLoading&&(u=r.a.createElement("div",null,r.a.createElement(t,{w:20,h:20}),Object(p.a)("Loading room preview")));break;case y.Kicked:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(p.a)("You were kicked from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),i=t?Object(p.a)("Reason: %(reason)s",{reason:t}):null,"invite"===this._joinRule()?(a=Object(p.a)("Forget this room"),o=this.props.onForgetClick):(a=Object(p.a)("Re-join"),o=this.props.onJoinClick,d=Object(p.a)("Forget this room"),c=this.props.onForgetClick);break}case y.Banned:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(p.a)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),i=t?Object(p.a)("Reason: %(reason)s",{reason:t}):null,a=Object(p.a)("Forget this room"),o=this.props.onForgetClick;break}case y.OtherThreePIDError:{n=Object(p.a)("Something went wrong with your invite to %(roomName)s",{roomName:this._roomName()});const e=this._joinRule(),t=Object(p.a)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to a room admin.",{errcode:this.state.threePidFetchError.errcode||Object(p.a)("unknown error code")});switch(e){case"invite":i=[Object(p.a)("You can only join it with a working invite."),t],a=Object(p.a)("Try to join anyway"),o=this.props.onJoinClick;break;case"public":i=Object(p.a)("You can still join it because this is a public room."),a=Object(p.a)("Join the discussion"),o=this.props.onJoinClick;break;default:i=t,a=Object(p.a)("Try to join anyway"),o=this.props.onJoinClick}break}case y.InvitedEmailNotFoundInAccount:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(p.a)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(p.a)("Join the discussion"),o=this.props.onJoinClick;break;case y.InvitedEmailNoIdentityServer:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(p.a)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(p.a)("Join the discussion"),o=this.props.onJoinClick;break;case y.InvitedEmailMismatch:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(p.a)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(p.a)("Join the discussion"),o=this.props.onJoinClick;break;case y.Invite:{const e=l.getComponent("views.avatars.RoomAvatar"),t=Object.assign({},this.props.oobData,{avatarUrl:this._communityProfile().avatarMxc}),u=r.a.createElement(e,{room:this.props.room,oobData:t}),h=this._getInviteMember();let m;m=h?r.a.createElement("span",null,r.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},h.rawDisplayName)," (",h.userId,")"):r.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);this._isDMInvite()?(n=Object(p.a)("Do you want to chat with %(user)s?",{user:h.name}),i=[u,Object(p.a)("<userName/> wants to chat",{},{userName:()=>m})],a=Object(p.a)("Start chatting")):(n=Object(p.a)("Do you want to join %(roomName)s?",{roomName:this._roomName()}),i=[u,Object(p.a)("<userName/> invited you",{},{userName:()=>m})],a=Object(p.a)("Accept")),o=this.props.onJoinClick,d=Object(p.a)("Reject"),c=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&f.push(r.a.createElement(s,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(p.a)("Reject & Ignore user")));break}case y.ViewingRoom:n=this.props.canPreview?Object(p.a)("You're previewing %(roomName)s. Want to join it?",{roomName:this._roomName()}):Object(p.a)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:this._roomName(!0)}),a=Object(p.a)("Join the discussion"),o=this.props.onJoinClick;break;case y.RoomNotFound:n=Object(p.a)("%(roomName)s does not exist.",{roomName:this._roomName(!0)}),i=Object(p.a)("This room doesn't exist. Are you sure you're at the right place?");break;case y.OtherError:n=Object(p.a)("%(roomName)s is not accessible at this time.",{roomName:this._roomName(!0)}),i=[Object(p.a)("Try again later, or ask a room admin to check if you have access."),Object(p.a)("%(errcode)s was returned while trying to access the room. If you think you're seeing this message in error, please <issueLink>submit a bug report</issueLink>.",{errcode:this.props.error.errcode},{issueLink:e=>r.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/new/choose",target:"_blank",rel:"noreferrer noopener"},e)})]}let v,b,E,S;i&&(Array.isArray(i)||(i=[i]),v=i.map((e,t)=>r.a.createElement("p",{key:"subTitle"+t},e))),b=h?r.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},r.a.createElement(t,null),n):r.a.createElement("h3",null,n),o&&(E=r.a.createElement(s,{kind:"primary",onClick:o},a)),c&&(S=r.a.createElement(s,{kind:"secondary",onClick:c},d));const w=m()("mx_RoomPreviewBar","dark-panel","mx_RoomPreviewBar_"+_,{mx_RoomPreviewBar_panel:this.props.canPreview,mx_RoomPreviewBar_dialog:!this.props.canPreview});return r.a.createElement("div",{className:w},r.a.createElement("div",{className:"mx_RoomPreviewBar_message"},b,v),r.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},S,f,E),r.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},u))}}i()(b,"propTypes",{onJoinClick:c.a.func,onRejectClick:c.a.func,onRejectAndIgnoreClick:c.a.func,onForgetClick:c.a.func,inviterName:c.a.string,invitedEmail:c.a.string,oobData:c.a.object,signUrl:c.a.string,error:c.a.object,canPreview:c.a.bool,previewLoading:c.a.bool,room:c.a.object,spinner:c.a.bool,spinnerState:c.a.oneOf(["joining"]),loading:c.a.bool,joining:c.a.bool,rejecting:c.a.bool,roomAlias:c.a.string}),i()(b,"defaultProps",{onJoinClick(){}})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44),d=s(48),u=s(58);class h extends r.a.Component{constructor(...e){super(...e),i()(this,"_onKeyDown",e=>{switch(e.key){case u.a.ESCAPE:this.props.onCancelClick()}})}componentDidMount(){d.a.dispatch({action:"panel_disable",middleDisabled:!0}),document.addEventListener("keydown",this._onKeyDown)}componentWillUnmount(){d.a.dispatch({action:"panel_disable",middleDisabled:!1}),document.removeEventListener("keydown",this._onKeyDown)}render(){return r.a.createElement("div",{className:"mx_ForwardMessage"},r.a.createElement("h1",null,Object(l.a)("Please select the destination room for this message")))}}i()(h,"propTypes",{onCancelClick:c.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(52),c=s(51),l=s.n(c),d=s(44),u=s(58);class h extends r.a.Component{constructor(e){super(e),i()(this,"onThisRoomClick",()=>{this.setState({scope:"Room"},()=>this._searchIfQuery())}),i()(this,"onAllRoomsClick",()=>{this.setState({scope:"All"},()=>this._searchIfQuery())}),i()(this,"onSearchChange",e=>{switch(e.key){case u.a.ENTER:this.onSearch();break;case u.a.ESCAPE:this.props.onCancelClick()}}),i()(this,"onSearch",()=>{this.props.onSearch(this._search_term.current.value,this.state.scope)}),this._search_term=Object(o.createRef)(),this.state={scope:"Room"}}_searchIfQuery(){this._search_term.current.value&&this.onSearch()}render(){const e=l()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=l()("mx_SearchBar_button",{mx_SearchBar_unselected:"Room"!==this.state.scope}),s=l()("mx_SearchBar_button",{mx_SearchBar_unselected:"All"!==this.state.scope});return r.a.createElement("div",{className:"mx_SearchBar"},r.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},r.a.createElement(a.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":"Room"===this.state.scope,role:"radio"},Object(d.a)("This Room")),r.a.createElement(a.a,{className:s,onClick:this.onAllRoomsClick,"aria-checked":"All"===this.state.scope,role:"radio"},Object(d.a)("All Rooms"))),r.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},r.a.createElement("input",{ref:this._search_term,type:"text",autoFocus:!0,placeholder:Object(d.a)("Search…"),onKeyDown:this.onSearchChange}),r.a.createElement(a.a,{className:e,onClick:this.onSearch})),r.a.createElement(a.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(49),u=s(44),h=s(47);class m extends r.a.Component{constructor(...e){super(...e),i()(this,"_onStateEvents",(e,t)=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const s=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:s&&s.getContent().replacement_room})}),i()(this,"onUpgradeClick",()=>{const e=l.getComponent("dialogs.RoomUpgradeDialog");d.a.createTrackedDialog("Upgrade Room Version","",e,{room:this.props.room})})}componentDidMount(){const e=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:e&&e.getContent().replacement_room}),h.a.get().on("RoomState.events",this._onStateEvents)}render(){const e=l.getComponent("elements.AccessibleButton");let t=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},r.a.createElement("p",null,Object(u.a)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),r.a.createElement("p",null,Object(u.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>r.a.createElement("b",null,e),i:e=>r.a.createElement("i",null,e)}))),r.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},r.a.createElement(e,{onClick:this.onUpgradeClick},Object(u.a)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(t=r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},r.a.createElement("p",null,Object(u.a)("This room has already been upgraded.")))),r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(u.a)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>r.a.createElement("code",null,this.props.room.getVersion()),i:e=>r.a.createElement("i",null,e)})),t,r.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(u.a)("Only room administrators will see this warning"))))}}i()(m,"propTypes",{room:c.a.object.isRequired,recommendation:c.a.object.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(44),u=s(49),h=s(47),m=s(50),p=s(57);class g extends r.a.PureComponent{constructor(e){super(e),i()(this,"showSetupDialog",()=>{if(this.state.backupInfo){const e=l.getComponent("dialogs.keybackup.RestoreKeyBackupDialog");u.a.createTrackedDialog("Restore Backup","",e,null,null,!1,!0)}else u.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(0).then(s.bind(null,544)),null,null,!1,!0)}),i()(this,"onOnNotNowClick",()=>{this.setState({notNowClicked:!0})}),i()(this,"onDontAskAgainClick",()=>{u.a.createTrackedDialogAsync("Ignore Recovery Reminder","Ignore Recovery Reminder",s.e(24).then(s.bind(null,1146)),{onDontAskAgain:async()=>{await m.a.setValue("showRoomRecoveryReminder",null,p.a.ACCOUNT,!1),this.props.onDontAskAgainSet()},onSetup:()=>{this.showSetupDialog()}})}),i()(this,"onSetupClick",()=>{this.showSetupDialog()}),this.state={loading:!0,error:null,backupInfo:null,notNowClicked:!1}}componentDidMount(){this._loadBackupStatus()}async _loadBackupStatus(){try{const e=await h.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){console.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}render(){if(this.state.error||this.state.loading||this.state.notNowClicked)return null;const e=l.getComponent("views.elements.AccessibleButton");let t;return t=this.state.backupInfo?Object(d.a)("Connect this session to Key Backup"):Object(d.a)("Start using Key Backup"),r.a.createElement("div",{className:"mx_RoomRecoveryReminder"},r.a.createElement("div",{className:"mx_RoomRecoveryReminder_header"},Object(d.a)("Never lose encrypted messages")),r.a.createElement("div",{className:"mx_RoomRecoveryReminder_body"},r.a.createElement("p",null,Object(d.a)("Messages in this room are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),r.a.createElement("p",null,Object(d.a)("Securely back up your keys to avoid losing them. <a>Learn more.</a>",{},{a:e=>""}))),r.a.createElement("div",{className:"mx_RoomRecoveryReminder_buttons"},r.a.createElement(e,{kind:"primary",onClick:this.onSetupClick},t),r.a.createElement(e,{className:"mx_RoomRecoveryReminder_secondary mx_linkButton",onClick:this.onOnNotNowClick},Object(d.a)("Not now")),r.a.createElement(e,{className:"mx_RoomRecoveryReminder_secondary mx_linkButton",onClick:this.onDontAskAgainClick},Object(d.a)("Don't ask me again"))))}}i()(g,"propTypes",{onDontAskAgainSet:c.a.func}),i()(g,"defaultProps",{onDontAskAgainSet:function(){}})},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(47),d=s(48),u=s(52),h=s(515),m=s(219),p=s(44),g=s(75);class f extends r.a.Component{constructor(...e){super(...e),i()(this,"onTileClicked",()=>{d.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),i()(this,"onUnpinClicked",()=>{const e=this.props.mxRoom.currentState.getStateEvents("m.room.pinned_events","");if(e&&e.getContent().pinned){const t=e.getContent().pinned,s=t.indexOf(this.props.mxEvent.getId());-1!==s?(t.splice(s,1),l.a.get().sendStateEvent(this.props.mxRoom.roomId,"m.room.pinned_events",{pinned:t},"").then(()=>{this.props.onUnpinned&&this.props.onUnpinned()})):this.props.onUnpinned&&this.props.onUnpinned()}else this.props.onUnpinned&&this.props.onUnpinned()})}_canUnpin(){return this.props.mxRoom.currentState.mayClientSendStateEvent("m.room.pinned_events",l.a.get())}render(){const e=this.props.mxEvent.getSender(),t=this.props.mxRoom.getMember(e);let n=null;return this._canUnpin()&&(n=r.a.createElement(u.a,{onClick:this.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton"},r.a.createElement("img",{src:s(877),width:"8",height:"8",alt:Object(p.a)("Unpin Message"),title:Object(p.a)("Unpin Message")}))),r.a.createElement("div",{className:"mx_PinnedEventTile"},r.a.createElement("div",{className:"mx_PinnedEventTile_actions"},r.a.createElement(u.a,{className:"mx_PinnedEventTile_gotoButton mx_textButton",onClick:this.onTileClicked},Object(p.a)("Jump to message")),n),r.a.createElement("span",{className:"mx_PinnedEventTile_senderAvatar"},r.a.createElement(m.a,{member:t,width:40,height:40,fallbackUserId:e})),r.a.createElement("span",{className:"mx_PinnedEventTile_sender"},t?t.name:e),r.a.createElement("span",{className:"mx_PinnedEventTile_timestamp"},Object(g.b)(new Date(this.props.mxEvent.getTs()))),r.a.createElement("div",{className:"mx_PinnedEventTile_message"},r.a.createElement(h.a,{mxEvent:this.props.mxEvent,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{}})))}}i()(f,"propTypes",{mxRoom:c.a.object.isRequired,mxEvent:c.a.object.isRequired,onUnpinned:c.a.func})},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(50),u=s(330),h=s(350),m=s(516);class p extends r.a.Component{constructor(e){super(e),i()(this,"getEventTileOps",()=>this._body.current&&this._body.current.getEventTileOps?this._body.current.getEventTileOps():null),i()(this,"onTileUpdate",()=>{this.forceUpdate()}),this._body=Object(o.createRef)()}render(){const e={"m.text":l.getComponent("messages.TextualBody"),"m.notice":l.getComponent("messages.TextualBody"),"m.emote":l.getComponent("messages.TextualBody"),"m.image":l.getComponent("messages.MImageBody"),"m.file":l.getComponent("messages.MFileBody"),"m.audio":l.getComponent("messages.MAudioBody"),"m.video":l.getComponent("messages.MVideoBody")},t={"m.sticker":l.getComponent("messages.MStickerBody")},s=this.props.mxEvent.getContent(),n=this.props.mxEvent.getType(),i=s.msgtype;let o=h.a;if(this.props.mxEvent.isRedacted()||(o=n&&t[n]?t[n]:i&&e[i]?e[i]:s.url?e["m.file"]:m.a),d.a.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=u.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),s=u.a.sharedInstance().isServerBanned(e);(t||s)&&(o=l.getComponent("messages.MjolnirBody"))}}return r.a.createElement(o,{ref:this._body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate})}}i()(p,"propTypes",{mxEvent:c.a.object.isRequired,highlights:c.a.array,highlightLink:c.a.string,showUrlPreview:c.a.bool,onHeightChanged:c.a.func,tileShape:c.a.string,maxImageHeight:c.a.number})},function(e,t,s){"use strict";var n=s(43),i=s.n(n);t.a=Object(n.forwardRef)(({mxEvent:e},t)=>{const s=e.getContent().body;return i.a.createElement("span",{className:"mx_UnknownBody",ref:t},s)})},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(47),d=s(46),u=s(48),h=s(253),m=s(550),p=s(44),g=s(51),f=s.n(g),_=s(182),v=s(50),y=s(69),b=s(342);class E extends r.a.Component{constructor(e){super(e),i()(this,"onConferenceNotificationClick",(e,t)=>{u.a.dispatch({action:"place_call",type:t,room_id:this.props.room.roomId}),e.stopPropagation(),e.preventDefault()}),i()(this,"_rateLimitedUpdate",new _.a(()=>{v.a.getValue("feature_state_counters")&&this.setState({counters:this._computeCounters()})},500)),this.state={counters:this._computeCounters()}}componentDidMount(){l.a.get().on("RoomState.events",this._rateLimitedUpdate)}componentWillUnmount(){const e=l.a.get();e&&e.removeListener("RoomState.events",this._rateLimitedUpdate)}shouldComponentUpdate(e,t){return!h.a(this.props,e)||!h.a(this.state,t)}componentDidUpdate(e,t){this.props.onResize&&this.props.onResize()}_computeCounters(){let e=[];if(this.props.room&&v.a.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort((e,t)=>e.getStateKey()<t.getStateKey()),t.forEach((t,s)=>{const n=t.getContent().title,i=t.getContent().value,o=t.getContent().link,r=t.getContent().severity||"normal",a=t.getStateKey();n&&void 0!==i&&e.push({title:n,value:i,link:o,severity:r,stateKey:a})})}return e}render(){const e=d.getComponent("elements.TintableSvg");let t=null;this.props.draggingFile&&(t=r.a.createElement("div",{className:"mx_RoomView_fileDropTarget"},r.a.createElement("div",{className:"mx_RoomView_fileDropTargetLabel",title:Object(p.a)("Drop File Here")},r.a.createElement(e,{src:s(878),width:"45",height:"59"}),r.a.createElement("br",null),Object(p.a)("Drop file here to upload"))));let n=null;if(this.props.displayConfCallNotification){let e,t="";l.a.get().supportsVoip()?e=r.a.createElement("span",null,Object(p.a)("Join as <voiceText>voice</voiceText> or <videoText>video</videoText>.",{},{voiceText:e=>r.a.createElement("a",{onClick:e=>{this.onConferenceNotificationClick(e,"voice")},href:"#"},e),videoText:e=>r.a.createElement("a",{onClick:e=>{this.onConferenceNotificationClick(e,"video")},href:"#"},e)})):t=Object(p.a)(" (unsupported)"),n=r.a.createElement("div",{className:"mx_RoomView_ongoingConfCallNotification"},Object(p.a)("Ongoing conference call%(supportedText)s.",{supportedText:t})," ",e)}const i=r.a.createElement(b.a,{room:this.props.room,ConferenceHandler:this.props.conferenceHandler,onResize:this.props.onResize,maxVideoHeight:this.props.maxHeight}),o=r.a.createElement(m.a,{room:this.props.room,userId:this.props.userId,maxHeight:this.props.maxHeight,showApps:this.props.showApps,hide:this.props.hideAppsDrawer,resizeNotifier:this.props.resizeNotifier});let a=null;if(this.state.counters&&v.a.getValue("feature_state_counters")){let e=[];this.state.counters.forEach((t,s)=>{const n=t.title,i=t.value,o=t.link,a=t.severity,c=t.stateKey;let l=r.a.createElement("span",null,n,": ",i);o&&(l=r.a.createElement("a",{href:o,target:"_blank",rel:"noreferrer noopener"},l)),l=r.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":a,key:"x-"+c},l),e.push(l),e.push(r.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+s}," ─ "))}),e.length>0&&(e.pop(),a=r.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}const c=f()({mx_RoomView_auxPanel:!0,mx_RoomView_auxPanel_fullHeight:this.props.fullHeight}),u={};return this.props.fullHeight||(u.maxHeight=this.props.maxHeight),r.a.createElement(y.a,{className:c,style:u},a,o,t,i,n,this.props.children)}}i()(E,"propTypes",{room:c.a.object.isRequired,userId:c.a.string.isRequired,showApps:c.a.bool,hideAppsDrawer:c.a.bool,conferenceHandler:c.a.object,draggingFile:c.a.bool,displayConfCallNotification:c.a.bool,maxHeight:c.a.number,onResize:c.a.func,fullHeight:c.a.bool}),i()(E,"defaultProps",{showApps:!0,hideAppsDrawer:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(51),d=s.n(l),u=s(44),h=s(47),m=s(182),p=s(77),g=s(519),f=s(50),_=s(520),v=s(146),y=s(267),b=s(71),E=s(68);class S extends r.a.Component{constructor(e){super(e),i()(this,"_onRoomStateEvents",(e,t)=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this._rateLimitedUpdate()}),i()(this,"_onRoomAccountData",(e,t)=>{this.props.room&&t.roomId===this.props.room.roomId&&"im.vector.room.read_pins"===e.getType()&&this._rateLimitedUpdate()}),i()(this,"_rateLimitedUpdate",new m.a((function(){this.forceUpdate()}),500)),i()(this,"_onRoomNameChange",e=>{this.forceUpdate()}),this._topic=Object(o.createRef)()}componentDidMount(){const e=h.a.get();e.on("RoomState.events",this._onRoomStateEvents),e.on("Room.accountData",this._onRoomAccountData),this.props.room&&this.props.room.on("Room.name",this._onRoomNameChange)}componentDidUpdate(){this._topic.current&&Object(p.e)(this._topic.current)}componentWillUnmount(){this.props.room&&this.props.room.removeListener("Room.name",this._onRoomNameChange);const e=h.a.get();e&&(e.removeListener("RoomState.events",this._onRoomStateEvents),e.removeListener("Room.accountData",this._onRoomAccountData))}_hasUnreadPins(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(!e)return!1;if(e.getContent().pinned&&e.getContent().pinned.length<=0)return!1;const t=this.props.room.getAccountData("im.vector.room.read_pins");if(t&&t.getContent()){const s=t.getContent().event_ids||[];if(s)return!s.includes(e.getId())}return!0}_hasPins(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");return!!e&&!(e.getContent().pinned&&e.getContent().pinned.length<=0)}render(){let e=null,t=null,s=null;this.props.onCancelClick&&(t=r.a.createElement(g.a,{onClick:this.props.onCancelClick})),this.props.searchInfo&&void 0!==this.props.searchInfo.searchCount&&null!==this.props.searchInfo.searchCount&&(e=r.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(u.a)("(~%(count)s results)",{count:this.props.searchInfo.searchCount})));let n=!1;const i=this.props.room?this.props.room.getJoinedMembers():void 0;if(i&&1===i.length&&i[0].userId===h.a.get().credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(n=!0)}let o=Object(u.a)("Join Room");this.props.oobData&&this.props.oobData.name?o=this.props.oobData.name:this.props.room&&(o=this.props.room.name);const a=d()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:n}),c=r.a.createElement("div",{className:"mx_RoomHeader_name",onClick:this.props.onSettingsClick},r.a.createElement("div",{dir:"auto",className:a,title:o},o),e);let l;if(this.props.room){const e=this.props.room.currentState.getStateEvents("m.room.topic","");e&&(l=e.getContent().topic)}const m=r.a.createElement("div",{className:"mx_RoomHeader_topic",ref:this._topic,title:l,dir:"auto"},l);let p,S,w;if(this.props.room&&(p=r.a.createElement(y.a,{room:this.props.room,avatarSize:32,tag:b.a.Untagged,oobData:this.props.oobData,viewAvatarOnClick:!0})),this.props.onPinnedClick&&f.a.getValue("feature_pinning")){let e=null;this._hasUnreadPins()?e=r.a.createElement("div",{className:"mx_RoomHeader_pinsIndicator mx_RoomHeader_pinsIndicatorUnread"}):this._hasPins()&&(e=r.a.createElement("div",{className:"mx_RoomHeader_pinsIndicator"})),s=r.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_pinnedButton",onClick:this.props.onPinnedClick,title:Object(u.a)("Pinned Messages")},e)}this.props.onForgetClick&&(S=r.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(u.a)("Forget room")})),this.props.onSearchClick&&this.props.inRoom&&(w=r.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(u.a)("Search")}));const C=r.a.createElement("div",{className:"mx_RoomHeader_buttons"},s,S,w),R=this.props.e2eStatus?r.a.createElement(v.b,{status:this.props.e2eStatus}):void 0;return r.a.createElement("div",{className:"mx_RoomHeader light-panel"},r.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":"mx_RightPanel"},r.a.createElement("div",{className:"mx_RoomHeader_avatar"},p),r.a.createElement("div",{className:"mx_RoomHeader_e2eIcon"},R),c,m,t,C,r.a.createElement(_.a,null)))}}i()(S,"propTypes",{room:c.a.object,oobData:c.a.object,inRoom:c.a.bool,onSettingsClick:c.a.func,onPinnedClick:c.a.func,onSearchClick:c.a.func,onLeaveClick:c.a.func,onCancelClick:c.a.func,e2eStatus:c.a.string}),i()(S,"defaultProps",{editing:!1,inRoom:!1,onCancelClick:null})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(52),d=s(46),u=s(44);function h(e){const{onClick:t}=e;return r.a.createElement(l.a,{className:"mx_RoomHeader_cancelButton",onClick:t},r.a.createElement("img",{src:s(152),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(u.a)("Cancel")}))}class m extends r.a.Component{render(){let e,t;if(this.props.onCancelClick&&(e=r.a.createElement(h,{onClick:this.props.onCancelClick})),this.props.icon){const e=d.getComponent("elements.TintableSvg");t=r.a.createElement(e,{className:"mx_RoomHeader_icon",src:this.props.icon,width:"25",height:"25"})}return r.a.createElement("div",{className:"mx_RoomHeader"},r.a.createElement("div",{className:"mx_RoomHeader_wrapper"},r.a.createElement("div",{className:"mx_RoomHeader_simpleHeader"},t,this.props.title,e)))}}i()(m,"propTypes",{title:c.a.string,onCancelClick:c.a.func,icon:c.a.string})},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(44),c=s(351),l=s(352),d=s(70),u=s(54),h=s(218);const m=[d.b.RoomSummary,d.b.Widget,d.b.FilePanel,d.b.RoomMemberList,d.b.RoomMemberInfo,d.b.EncryptionPanel,d.b.Room3pidMemberInfo];class p extends l.b{constructor(e){super(e,l.a.Room),i()(this,"onRoomSummaryClicked",()=>{const e=h.a.getSharedInstance().roomPanelPhase;m.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,h.a.getSharedInstance().roomPanelPhaseParams):this.setPhase(d.b.RoomSummary)}),i()(this,"onNotificationsClicked",()=>{this.setPhase(d.b.NotificationPanel)})}onAction(e){e.action===u.a.ViewUser?e.member?this.setPhase(d.b.RoomMemberInfo,{member:e.member}):this.setPhase(d.b.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(d.b.Room3pidMemberInfo,{event:e.event}):this.setPhase(d.b.RoomMemberList))}renderButtons(){return[r.a.createElement(c.a,{key:"notifsButton",name:"notifsButton",title:Object(a.a)("Notifications"),isHighlighted:this.isPhase(d.b.NotificationPanel),onClick:this.onNotificationsClicked,analytics:["Right Panel","Notification List Button","click"]}),r.a.createElement(c.a,{key:"roomSummaryButton",name:"roomSummaryButton",title:Object(a.a)("Room Info"),isHighlighted:this.isPhase(m),onClick:this.onRoomSummaryClicked,analytics:["Right Panel","Room Summary Button","click"]})]}}},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return f}));var n=s(897),i=s.n(n),o=s(47),r=s(62),a=s(44),c=s(906),l=s.n(c),d=s(358),u=s(359),h=s(50);let m=window.TextEncoder;async function p(e={},t=!0){const s=e.progressCallback||(()=>{});s(Object(a.a)("Collecting app version information"));let n="UNKNOWN";try{n=await r.a.get().getAppVersion()}catch(e){}let c="UNKNOWN";window.navigator&&window.navigator.userAgent&&(c=window.navigator.userAgent);let l="UNKNOWN";try{l=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let u="UNKNOWN";try{u=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const p=o.a.get();console.log("Sending bug report.");const g=new FormData;if(g.append("text",e.userText||"User did not supply any additional text."),g.append("app","element-web"),g.append("version",n),g.append("user_agent",c),g.append("installed_pwa",l),g.append("touch_input",u),p&&(g.append("user_id",p.credentials.userId),g.append("device_id",p.deviceId),p.isCryptoEnabled())){const e=["ed25519:"+p.getDeviceEd25519Key()];p.getDeviceCurve25519Key&&e.push("curve25519:"+p.getDeviceCurve25519Key()),g.append("device_keys",e.join(", ")),g.append("cross_signing_key",p.getCrossSigningId());const t=p._crypto._crossSigningInfo,s=p._crypto._secretStorage;g.append("cross_signing_ready",String(await p.isCrossSigningReady())),g.append("cross_signing_supported_by_hs",String(await p.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),g.append("cross_signing_key",t.getId()),g.append("cross_signing_pk_in_secret_storage",String(!!await t.isStoredInSecretStorage(s)));const n=p.getCrossSigningCacheCallbacks();g.append("cross_signing_master_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("master")))),g.append("cross_signing_self_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("self_signing")))),g.append("cross_signing_user_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("user_signing")))),g.append("secret_storage_ready",String(await p.isSecretStorageReady())),g.append("secret_storage_key_in_account",String(!!await s.hasKey()));const i=await p._crypto.getSessionBackupPrivateKey();g.append("session_backup_key_cached",String(!!i)),g.append("session_backup_key_well_formed",String(i instanceof Uint8Array))}e.label&&g.append("label",e.label);const f=h.a.getFeatureSettingNames().filter(e=>h.a.getValue(e));if(f.length&&g.append("enabled_labs",f.join(", ")),h.a.getValue("lowBandwidth")&&g.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{g.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{g.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();g.append("storageManager_quota",String(e.quota)),g.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach(t=>{g.append("storageManager_usage_"+t,String(e.usageDetails[t]))})}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&g.append("modernizr_missing_features",e.join(", "))}if(g.append("mx_local_settings",localStorage.getItem("mx_local_settings")),e.sendLogs){s(Object(a.a)("Collecting logs"));const e=await d.c();for(const s of e){let e=(new m).encode(s.lines);t&&(e=i.a.gzip(e)),g.append("compressed-log",new Blob([e]),s.id)}}return g}async function g(e,t={}){if(!e)throw new Error("No bug report endpoint has been set.");const s=t.progressCallback||(()=>{}),n=await p(t);s(Object(a.a)("Uploading logs")),await function(e,t,s){return new Promise((n,i)=>{const o=new XMLHttpRequest;o.open("POST",e),o.timeout=3e5,o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.LOADING)s(Object(a.a)("Waiting for response from server"));else if(o.readyState===XMLHttpRequest.DONE){if(o.status<200||o.status>=400)return void i(new Error("HTTP "+o.status));n()}},o.send(t)})}(e,n,s)}async function f(e={}){const t=e.progressCallback||(()=>{}),s=await p(e,!1);t(Object(a.a)("Downloading logs"));let n="";const i=new l.a;let o=0;for(const[e,t]of s.entries())"compressed-log"===e?await new Promise(e=>{const s=new FileReader;s.addEventListener("loadend",t=>{i.append(`log-${o++}.log`,(new TextDecoder).decode(t.target.result)),e()}),s.readAsArrayBuffer(t)}):n+=`${e} = ${t}\n`;i.append("issue.txt",n);const r=document.createElement("a");r.href="data:application/octet-stream;base64,"+btoa(function(e){let t="";for(let s=0;s<e.length;s+=1)t+=String.fromCharCode(e[s]);return t}(i.out)),r.download="rageshake.tar",document.body.appendChild(r),r.click(),document.body.removeChild(r)}m||(m=u.TextEncoder)},,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(188),d=s.n(l),u=s(44),h=s(245),m=s.n(h),p=s(48),g=s(47),f=s(51),_=s.n(f),v=s(59),y=s(69);class b extends r.a.PureComponent{constructor(e,t){super(e,t),i()(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this._dispatcherRef=null,this.state={page:""}}translate(e){return m()(Object(u.a)(e))}componentDidMount(){this._unmounted=!1,this.props.url&&(d()({method:"GET",url:this.props.url},(e,t,s)=>{if(!this._unmounted){if(e||t.status<200||t.status>=300)return console.warn("Error loading page: "+e),void this.setState({page:Object(u.a)("Couldn't load page")});s=s.replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t)),this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{s=s.split(e).join(this.props.replaceMap[e])}),this.setState({page:s})}}),this._dispatcherRef=p.a.register(this.onAction))}componentWillUnmount(){this._unmounted=!0,null!==this._dispatcherRef&&p.a.unregister(this._dispatcherRef)}render(){const e=this.context||g.a.get(),t=!e||e.isGuest(),s=this.props.className,n=_()({[s]:!0,[s+"_guest"]:t,[s+"_loggedIn"]:!!e}),i=r.a.createElement("div",{className:s+"_body",dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?r.a.createElement(y.a,{className:n},i):r.a.createElement("div",{className:n},i)}}i()(b,"propTypes",{url:c.a.string,className:c.a.string,scrollbar:c.a.bool,replaceMap:c.a.object}),i()(b,"contextType",v.a)},function(e,t){e.exports="img/icons-create-room.7c857e1.svg"},function(e,t){e.exports="img/cancel-small.1b416ae.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(46),d=s(44),u=s(51),h=s.n(u);class m extends r.a.Component{constructor(...e){super(...e),i()(this,"onFinished",()=>{this.props.onFinished()})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("views.elements.DialogButtons");return r.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown},r.a.createElement("div",{className:h()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),r.a.createElement(t,{primaryButton:this.props.button||Object(d.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}i()(m,"propTypes",{className:c.a.string,title:c.a.string,description:c.a.node,button:c.a.string,onFinished:c.a.func,hasCloseButton:c.a.bool,onKeyDown:c.a.func}),i()(m,"defaultProps",{title:"",description:"",hasCloseButton:!1})},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return h}));var n=s(43),i=s.n(n),o=s(79),r=s.n(o),a=s(47),c=s(50),l=s(157),d=s(46);function u(e,t,s){const n=a.a.get().getRoom(t.getRoomId()),o=c.a.getValue("Pill.shouldShowPillAvatar");let h=e[0];for(;h;){let e=!1;if("A"===h.tagName&&h.getAttribute("href")){const t=h.getAttribute("href"),a=d.getComponent("elements.Pill");if(a.isMessagePillUrl(t)){const c=document.createElement("span"),l=i.a.createElement(a,{url:t,inMessage:!0,room:n,shouldShowPillAvatar:o});r.a.render(l,c),h.parentNode.replaceChild(c,h),s.push(c),e=!0,h=c}}else if(h.nodeType===Node.TEXT_NODE&&!h.parentElement.classList.contains("mx_AtRoomPill")){const e=d.getComponent("elements.Pill");let c=h;const u=[];for(;null!==c;){const t=e.roomNotifPos(c.textContent);let s=null;if(t>-1){let n=c;t>0&&(n=n.splitText(t)),n.textContent.length>e.roomNotifLen()&&(s=n.splitText(e.roomNotifLen())),u.push(n)}c=s}if(u.length>0){const c=new l.a(a.a.get()),d=c.getPushRuleById(".m.rule.roomnotif");if(d&&c.ruleMatchesEvent(d,t)){for(const t of u){h=t.nextSibling;const a=document.createElement("span"),c=i.a.createElement(e,{type:e.TYPE_AT_ROOM_MENTION,inMessage:!0,room:n,shouldShowPillAvatar:o});r.a.render(c,a),t.parentNode.replaceChild(a,t),s.push(a)}continue}}}h.childNodes&&h.childNodes.length&&!e&&u(h.childNodes,t,s),h=h.nextSibling}}function h(e){for(const t of e)r.a.unmountComponentAtNode(t)}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return he})),s.d(t,"b",(function(){return me}));var n=s(56),i=s.n(n),o=s(2),r=s.n(o),a=s(43),c=s.n(a),l=s(55),d=s(158),u=s(156),h=(s(823),s(824),s(72));function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class g{constructor(e,t){this.failedEventId=e,this.errorCode=t,this.ts=Date.now()}}class f{constructor(e,t){if(r()(this,"failures",[]),r()(this,"failureCounts",{}),r()(this,"trackedEventHashMap",{}),r()(this,"checkInterval",null),r()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if(t&&"function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function");this._trackDecryptionFailure=e,this._mapErrorCode=t}eventDecrypted(e,t){t?this.addDecryptionFailure(new g(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e)}addDecryptionFailure(e){this.failures.push(e)}removeDecryptionFailuresForEvent(e){this.failures=this.failures.filter(t=>t.failedEventId!==e.getId())}start(){this.checkInterval=setInterval(()=>this.checkFailures(Date.now()),f.CHECK_INTERVAL_MS),this.trackInterval=setInterval(()=>this.trackFailures(),f.TRACK_INTERVAL_MS)}stop(){clearInterval(this.checkInterval),clearInterval(this.trackInterval),this.failures=[],this.failureCounts={}}checkFailures(e){const t=[],s=[];for(;this.failures.length>0;){const n=this.failures.shift();e>n.ts+f.GRACE_PERIOD_MS?t.push(n):s.push(n)}this.failures=s;const n=t.reduce((e,t)=>this.trackedEventHashMap[t.failedEventId]?e:e.set(t.failedEventId,t),new Map),i=[...n.keys()];this.trackedEventHashMap=i.reduce((e,t)=>p(p({},e),{},{[t]:!0}),this.trackedEventHashMap);const o=n.values();this._aggregateFailures(o)}_aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this._mapErrorCode?this._mapErrorCode(e):e;this._trackDecryptionFailure(this.failureCounts[e],t),this.failureCounts[e]=0}}}r()(f,"TRACK_INTERVAL_MS",6e4),r()(f,"CHECK_INTERVAL_MS",5e3),r()(f,"GRACE_PERIOD_MS",6e4);var _=s(47),v=s(62),y=s(53);function b(e){return e.timeline.length?e.timeline[e.timeline.length-1].getTs():Number.MAX_SAFE_INTEGER}var E=s(48),S=s(214),w=s(49),C=s(215),R=s(46),k=s(97),I=s(248),O=s(315),T=s(223),x=s(196);const N={deferred_action:null};class j extends x.Store{constructor(){super(E.a),this._state=N}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"do_after_sync_prepared":this._setState({deferred_action:e.deferred_action});break;case"cancel_after_sync_prepared":this._setState({deferred_action:null});break;case"sync_state":{if("PREPARED"!==e.state)break;if(!this._state.deferred_action)break;const t=Object.assign({},this._state.deferred_action);this._setState({deferred_action:null}),E.a.dispatch(t);break}case"on_client_not_viable":case"on_logged_out":this.reset()}}reset(){this._state=Object.assign({},N)}}let P=null;P||(P=new j);var D=s(479),A=s(282),U=s(98),M=s(44),L=s(50),F=s(333),B=s(335),V=s(217),K=s(480),q=s(84),G=s(90),W=s(334),H=s(482),$=s(433),z=s(87),Y=s(78),J=s(281),Q=s(54),X=s(52),Z=s(92);const ee=()=>{E.a.dispatch({action:"accept_cookies"})},te=()=>{E.a.dispatch({action:"reject_cookies"})},se=()=>{h.a.showDetailsModal()},ne=()=>{Y.a.sharedInstance().dismissToast("analytics")};var ie=s(473),oe=s(140),re=s(131),ae=s(57),ce=s(139),le=s(483);let de;!function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.POST_REGISTRATION=4]="POST_REGISTRATION",e[e.FORGOT_PASSWORD=5]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=6]="COMPLETE_SECURITY",e[e.E2E_SETUP=7]="E2E_SETUP",e[e.LOGGED_IN=8]="LOGGED_IN",e[e.SOFT_LOGOUT=9]="SOFT_LOGOUT"}(de||(de={}));const ue=[Q.a.ViewUserSettings,"view_create_chat","view_create_room","view_create_group"];class he extends c.a.PureComponent{constructor(e,t){super(e,t),r()(this,"firstSyncComplete",void 0),r()(this,"firstSyncPromise",void 0),r()(this,"screenAfterLogin",void 0),r()(this,"windowWidth",void 0),r()(this,"pageChanging",void 0),r()(this,"accountPassword",void 0),r()(this,"accountPasswordTimer",void 0),r()(this,"focusComposer",void 0),r()(this,"subTitleStatus",void 0),r()(this,"loggedInView",void 0),r()(this,"dispatcherRef",void 0),r()(this,"themeWatcher",void 0),r()(this,"fontWatcher",void 0),r()(this,"onAction",e=>{const t=R.getComponent("dialogs.QuestionDialog");if(_.a.get()&&_.a.get().isGuest()&&ue.includes(e.action))return E.a.dispatch({action:"do_after_sync_prepared",deferred_action:e}),void E.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(_.a.get().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(_.a.get().setIdentityServerUrl(null),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),E.a.dispatch({action:"id_server_changed"})}break;case"logout":T.j();break;case"require_registration":Object(B.b)(e);break;case"start_registration":if(T.h()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(T.h()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.setStateForNewView({view:de.LOGIN}),this.notifyNewScreen("login"),F.a.isLogin=!0,this.themeWatcher.recheck();break;case"start_post_registration":this.setState({view:de.POST_REGISTRATION});break;case"start_password_recovery":this.setStateForNewView({view:de.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(U.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"reject_invite":w.a.createTrackedDialog("Reject invitation","",t,{title:Object(M.a)("Reject invitation"),description:Object(M.a)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=R.getComponent("elements.Spinner"),s=w.a.createDialog(t,null,"mx_Dialog_spinner");_.a.get().leave(e.room_id).then(()=>{s.close(),this.state.currentRoomId===e.room_id&&E.a.dispatch({action:"view_next_room"})},e=>{s.close(),w.a.createTrackedDialog("Failed to reject invitation","",oe.a,{title:Object(M.a)("Failed to reject invitation"),description:e.toString()})})}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"view_room":{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{E.a.dispatch(e.deferred_action)});break}case"view_next_room":this.viewNextRoom(1);break;case Q.a.ViewUserSettings:{const t=e,s=R.getComponent("dialogs.UserSettingsDialog");w.a.createTrackedDialog("User settings","",s,{initialTabId:t.initialTabId},null,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public);break;case"view_create_group":{let e=R.getComponent("dialogs.CreateGroupDialog");L.a.getValue("feature_communities_v2_prototypes")&&(e=le.a),w.a.createTrackedDialog("Create Community","",e);break}case Q.a.ViewRoomDirectory:{const e=R.getComponent("structures.RoomDirectory");w.a.createTrackedDialog("Room directory","",e,{},"mx_RoomDirectory_dialogWrapper",!1,!0),this.viewSomethingBehindModal();break}case"view_my_groups":this.setPage(D.a.MyGroups),this.notifyNewScreen("groups");break;case"view_group":this.viewGroup(e);break;case"view_welcome_page":this.viewWelcome();break;case"view_home_page":this.viewHome();break;case"view_set_mxid":this.setMxId(e);break;case"view_start_chat_or_reuse":this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(k.h)();break;case"view_invite":Object(k.g)(e.roomId);break;case"view_last_screen":this.showScreenAfterLogin();break;case"toggle_my_groups":this.state.page_type===D.a.MyGroups?E.a.dispatch({action:"view_last_screen"}):E.a.dispatch({action:"view_my_groups"});break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"focus_room_filter":case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"panel_disable":this.setState({leftDisabled:e.leftDisabled||e.sideDisabled||!1,middleDisabled:e.middleDisabled||!1});break;case"on_logged_in":T.h()||this.state.view===de.LOGIN||this.state.view===de.REGISTER||this.state.view===de.COMPLETE_SECURITY||this.state.view===de.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case"on_logged_out":this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case"accept_cookies":L.a.setValue("analyticsOptIn",null,ae.a.DEVICE,!0),L.a.setValue("showCookieBar",null,ae.a.DEVICE,!1),ne(),h.a.enable();break;case"reject_cookies":L.a.setValue("analyticsOptIn",null,ae.a.DEVICE,!1),L.a.setValue("showCookieBar",null,ae.a.DEVICE,!1),ne()}}),r()(this,"handleResize",()=>{this.windowWidth>1e3&&window.innerWidth<=1e3&&E.a.dispatch({action:"hide_left_panel"}),this.windowWidth<=1e3&&window.innerWidth>1e3&&E.a.dispatch({action:"show_left_panel"}),this.state.resizeNotifier.notifyWindowResized(),this.windowWidth=window.innerWidth}),r()(this,"onRegisterClick",()=>{this.showScreen("register")}),r()(this,"onLoginClick",()=>{this.showScreen("login")}),r()(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),r()(this,"onRegisterFlowComplete",(e,t)=>this.onUserCompletedLoginFlow(e,t)),r()(this,"onFinishPostRegistration",()=>{this.setState({view:de.LOGGED_IN}),this.showScreen("settings")}),r()(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),r()(this,"makeRegistrationUrl",e=>(this.props.startingFragmentQueryParams.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e))),r()(this,"onUserCompletedLoginFlow",async(e,t)=>{this.accountPassword=t,null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer),this.accountPasswordTimer=setTimeout(()=>{this.accountPassword=null,this.accountPasswordTimer=null},3e5),await T.l(e);const s=_.a.get(),n=s.isCryptoEnabled();n||this.onLoggedIn();const i=[this.firstSyncPromise.promise];if(n&&i.push(s.downloadKeys([s.getUserId()])),this.setState({pendingInitialSync:!0}),await Promise.all(i),!n)return void this.setState({pendingInitialSync:!1});s.getStoredCrossSigningForUser(s.getUserId())?this.setStateForNewView({view:de.COMPLETE_SECURITY}):await s.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")?this.setStateForNewView({view:de.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})}),r()(this,"onCompleteSecurityE2eSetupFinished",()=>{this.onLoggedIn()}),this.state={view:de.LOADING,collapseLhs:!1,leftDisabled:!1,middleDisabled:!1,hideToSRUsers:!1,syncError:null,resizeNotifier:new K.a,ready:!1},this.loggedInView=Object(a.createRef)(),y.a.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object(z.b)(),this.props.config.sync_timeline_limit&&(_.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.windowWidth=1e4,this.handleResize(),window.addEventListener("resize",this.handleResize),this.pageChanging=!1,C.a.tint(),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),T.h()&&T.i({}),this.accountPassword=null,this.accountPasswordTimer=null,this.dispatcherRef=E.a.register(this.onAction),this.themeWatcher=new W.a,this.fontWatcher=new H.a,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",this.onAliasClick&&(O.a.onAliasClick=this.onAliasClick),this.onUserClick&&(O.a.onUserClick=this.onUserClick),this.onGroupClick&&(O.a.onGroupClick=this.onGroupClick),T.h()||T.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName).then(e=>{if(e)return void this.props.onTokenLoginCompleted();const t=this.screenAfterLogin?this.screenAfterLogin.screen:null;if("login"!==t&&"register"!==t&&"forgot_password"!==t)return this.loadSession();this.showScreenAfterLogin()}),L.a.getValue("analyticsOptIn")&&h.a.enable()}UNSAFE_componentWillUpdate(e,t){this.shouldTrackPageChange(this.state,t)&&this.startPageChangeTimer()}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();h.a.trackPageChange(e)}this.focusComposer&&(E.a.fire(Q.a.FocusComposer),this.focusComposer=!1)}componentWillUnmount(){T.n(),E.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),window.removeEventListener("resize",this.handleResize),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer)}getFallbackHsUrl(){return this.props.serverConfig&&this.props.serverConfig.isDefault?this.props.config.fallback_hs_url:null}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=y.a.get().validated_server_config),{serverConfig:e}}loadSession(){return Promise.resolve().then(()=>T.i({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName})).then(e=>{e||E.a.dispatch({action:"view_welcome_page"})})}startPageChangeTimer(){if(!performance||!performance.mark)return null;this.pageChanging?console.warn("MatrixChat.startPageChangeTimer: timer already started"):(this.pageChanging=!0,performance.mark("element_MatrixChat_page_change_start"))}stopPageChangeTimer(){if(!performance||!performance.mark)return null;if(!this.pageChanging)return void console.warn("MatrixChat.stopPageChangeTimer: timer not started");this.pageChanging=!1,performance.mark("element_MatrixChat_page_change_stop"),performance.measure("element_MatrixChat_page_change_delta","element_MatrixChat_page_change_start","element_MatrixChat_page_change_stop"),performance.clearMarks("element_MatrixChat_page_change_start"),performance.clearMarks("element_MatrixChat_page_change_stop");const e=performance.getEntriesByName("element_MatrixChat_page_change_delta").pop();return e?e.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");const t={currentUserId:null};Object.assign(t,e),this.setState(t)}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:de.REGISTER};e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid&&(t.serverConfig=await q.b.validateServerConfigWithStaticUrls(e.hs_url,e.is_url),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid),this.setStateForNewView(t),F.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}viewNextRoom(e){const t=_.a.get().getRooms().sort((function(e,t){return b(t)-b(e)}));if(t.length<2)return void E.a.dispatch({action:"view_home_page"});let s=-1;for(let e=0;e<t.length;++e)if(t[e].roomId===this.state.currentRoomId){s=e;break}s=(s+e)%t.length,s<0&&(s=t.length-1),E.a.dispatch({action:"view_room",room_id:t[s].roomId})}viewRoom(e){this.focusComposer=!0,e.room_alias?console.log(`Switching to room alias ${e.room_alias} at event `+e.event_id):console.log(`Switching to room id ${e.room_id} at event `+e.event_id);let t=Promise.resolve(null);if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a room before first sync. room_id:",e.room_id);t=this.firstSyncPromise.promise}return t.then(()=>{let t=e.room_alias||e.room_id;const s=_.a.get().getRoom(e.room_id);if(s){const e=I.a(s);e&&(t=e,Object($.b)(e,s.roomId)),localStorage&&localStorage.setItem("mx_last_room_id",s.roomId)}e.event_id&&e.highlighted&&(t+="/"+e.event_id),this.setState({view:de.LOGGED_IN,currentRoomId:e.room_id||null,page_type:D.a.RoomView,thirdPartyInvite:e.third_party_invite,roomOobData:e.oob_data,viaServers:e.via_servers,ready:!0},()=>{this.notifyNewScreen("room/"+t)})})}async viewGroup(e){const t=e.group_id;if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a group before first sync. group_id:",t);await this.firstSyncPromise.promise}this.setState({view:de.LOGGED_IN,currentGroupId:t,currentGroupIsNew:e.group_is_new}),this.setPage(D.a.GroupView),this.notifyNewScreen("group/"+t)}viewSomethingBehindModal(){this.state.view===de.LOGGED_IN?this.state.currentGroupId||this.state.currentRoomId||this.viewHome():this.viewWelcome()}viewWelcome(){this.setStateForNewView({view:de.WELCOME}),this.notifyNewScreen("welcome"),F.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(){this.setStateForNewView({view:de.LOGGED_IN}),this.setPage(D.a.HomePage),this.notifyNewScreen("home"),F.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(D.a.UserView)):this.chatCreateOrReuse(e)})}setMxId(e){const t=R.getComponent("views.dialogs.SetMxIdDialog"),s=w.a.createTrackedDialog("Set MXID","",t,{homeserverUrl:_.a.get().getHomeserverUrl(),onFinished:(t,s)=>{if(!t)return E.a.dispatch({action:"cancel_after_sync_prepared"}),void(e.go_home_on_cancel&&E.a.dispatch({action:"view_home_page"}));_.a.setJustRegisteredUserId(s.user_id),this.onRegistered(s)},onDifferentServerClicked:e=>{E.a.dispatch({action:"start_registration"}),s()},onLoginClick:e=>{E.a.dispatch({action:"start_login"}),s()}}).close}async createRoom(e=!1){const t=R.getComponent("dialogs.CreateRoomDialog"),s=w.a.createTrackedDialog("Create Room","",t,{defaultPublic:e}),[n,i]=await s.finished;n&&Object(U.b)(i)}chatCreateOrReuse(e){if(_.a.get().isGuest())return e!==this.props.config.welcomeUserId&&E.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_start_chat_or_reuse",user_id:e}}),void E.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:"user/"+this.props.config.welcomeUserId,params:{action:"chat"}}});const t=_.a.get(),s=new G.a(t).getDMRoomsForUserId(e);s.length>0?E.a.dispatch({action:"view_room",room_id:s[0]}):E.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=_.a.get().getRoom(e).currentState.getStateEvents("m.room.join_rules",""),s=[];if(t){"public"!==t.getContent().join_rule&&s.push(c.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",Object(M.a)("This room is not public. You will not be able to rejoin without an invite.")))}return s}leaveRoom(e){const t=R.getComponent("dialogs.QuestionDialog"),s=_.a.get().getRoom(e),n=this.leaveRoomWarnings(e);w.a.createTrackedDialog("Leave room","",t,{title:Object(M.a)("Leave room"),description:c.a.createElement("span",null,Object(M.a)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:s.name}),n),button:Object(M.a)("Leave"),onFinished:t=>{if(t){const t=Object(ce.c)(e),s=R.getComponent("elements.Spinner"),n=w.a.createDialog(s,null,"mx_Dialog_spinner");t.finally(()=>n.close())}}})}forgetRoom(e){_.a.get().forget(e).then(()=>{this.state.currentRoomId===e&&E.a.dispatch({action:"view_next_room"})}).catch(e=>{const t=e.errcode||Object(M.b)("unknown error code");w.a.createTrackedDialog("Failed to forget room","",oe.a,{title:Object(M.a)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(M.a)("Operation failed")})})}async startWelcomeUserChat(){let e;e=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await e;if(0===G.a.shared().getDMRoomsForUserId(this.props.config.welcomeUserId).length){const e=await Object(U.b)({dmUserId:this.props.config.welcomeUserId,andView:!this.state.currentRoomId,spinner:!1}),t=e=>{"m.direct"===e.getType()&&e.getContent()&&e.getContent()[this.props.config.welcomeUserId]&&(_.a.get().store.save(!0),_.a.get().removeListener("accountData",t))};return _.a.get().on("accountData",t),e}return null}async onLoggedIn(){if(F.a.isLogin=!1,this.themeWatcher.recheck(),this.setStateForNewView({view:de.LOGGED_IN}),this.screenAfterLogin&&this.screenAfterLogin.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null;else if(_.a.currentUserIsJustRegistered())if(_.a.setJustRegisteredUserId(null),this.props.config.welcomeUserId&&Object(M.d)().startsWith("en")){null===await this.startWelcomeUserChat()&&E.a.dispatch({action:"view_home_page"})}else E.a.dispatch({action:"view_home_page"});else this.showScreenAfterLogin();J.c(),L.a.getValue("showCookieBar")&&this.props.config.piwik&&"1"!==navigator.doNotTrack&&(e=>{const t=y.a.get().brand;Y.a.sharedInstance().addOrReplaceToast({key:"analytics",title:Object(M.a)("Help us improve %(brand)s",{brand:t}),props:{description:Object(M.a)("Send <UsageDataLink>anonymous usage data</UsageDataLink> which helps us improve %(brand)s. This will use a <PolicyLink>cookie</PolicyLink>.",{brand:t},{UsageDataLink:e=>c.a.createElement(X.a,{kind:"link",onClick:se},e),PolicyLink:t=>e?c.a.createElement("a",{target:"_blank",href:e},t):t}),acceptLabel:Object(M.a)("I want to help"),onAccept:ee,rejectLabel:Object(M.a)("No"),onReject:te},component:Z.a,priority:10})})(this.props.config.piwik&&this.props.config.piwik.policyUrl)}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():_.a.get().isGuest()?E.a.dispatch({action:"view_welcome_page"}):Object(A.a)(this.props.config)?E.a.dispatch({action:"view_home_page"}):this.firstSyncPromise.promise.then(()=>{E.a.dispatch({action:"view_next_room"})})}viewLastRoom(){E.a.dispatch({action:"view_room",room_id:localStorage.getItem("mx_last_room_id")})}onLoggedOut(){this.notifyNewScreen("login"),this.setStateForNewView({view:de.LOGIN,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),F.a.isLogin=!0,this.themeWatcher.recheck()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:de.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object(z.b)();const e=_.a.get();e.setCanResetTimelineCallback(e=>(console.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on("sync",(e,t,s)=>{E.a.dispatch({action:"sync_state",prevState:t,state:e}),"ERROR"===e||"RECONNECTING"===e?(s.error instanceof d.b&&T.e(s.error),this.setState({syncError:s.error||!0})):this.state.syncError&&this.setState({syncError:null}),this.updateStatusIndicator(e,t),"SYNCING"===e&&"SYNCING"===t||(console.info("MatrixClient sync state => %s",e),"PREPARED"===e&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),S.default.shouldShowToolbar()&&Object(ie.b)(),E.a.fire(Q.a.FocusComposer),this.setState({ready:!0})))}),e.on("Call.incoming",(function(e){E.a.dispatch({action:"incoming_call",call:e},!0)})),e.on("Session.logged_out",(function(e){if(!T.g()){if(401===e.httpStatus&&e.data&&e.data.soft_logout)return console.warn("Soft logout issued by server - avoiding data deletion"),void T.m();w.a.createTrackedDialog("Signed out","",oe.a,{title:Object(M.a)("Signed Out"),description:Object(M.a)("For security, this session has been signed out. Please sign in again.")}),E.a.dispatch({action:"logout"})}})),e.on("no_consent",(function(t,s){const n=R.getComponent("dialogs.QuestionDialog");w.a.createTrackedDialog("No Consent Dialog","",n,{title:Object(M.a)("Terms and Conditions"),description:c.a.createElement("div",null,c.a.createElement("p",null," ",Object(M.a)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(M.a)("Review terms and conditions"),cancelButton:Object(M.a)("Dismiss"),onFinished:e=>{if(e){window.open(s,"_blank").opener=null}}},null,!0)}));const t=new f((e,t)=>{h.a.trackEvent("E2E","Decryption failure",t,e)},e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"olm_keys_not_sent_error";case"OLM_UNKNOWN_MESSAGE_INDEX":return"olm_index_error";case void 0:return"unexpected_error";default:return"unspecified_error"}});t.start(),e.on("Session.logged_out",()=>t.stop()),e.on("Event.decrypted",(e,s)=>t.eventDecrypted(e,s)),e.on("Room",e=>{if(_.a.get().isCryptoEnabled()){const t=L.a.getValueAt(ae.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}}),e.on("crypto.warning",e=>{switch(e){case"CRYPTO_WARNING_OLD_VERSION_DETECTED":w.a.createTrackedDialog("Crypto migrated","",oe.a,{title:Object(M.a)("Old cryptography data detected"),description:Object(M.a)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:y.a.get().brand})})}}),e.on("crypto.keyBackupFailed",async e=>{let t,n;if(_.a.get().getKeyBackupEnabled())t=!0;else try{n=await _.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void console.error("Saw key backup error but failed to check backup version!",e)}t?w.a.createTrackedDialogAsync("New Recovery Method","New Recovery Method",s.e(25).then(s.bind(null,1163)),{newVersionInfo:n}):w.a.createTrackedDialogAsync("Recovery Method Removed","Recovery Method Removed",s.e(26).then(s.bind(null,1164)))}),e.on("crypto.keySignatureUploadFailure",(e,t,s)=>{const n=R.getComponent("views.dialogs.KeySignatureUploadFailedDialog");w.a.createTrackedDialog("Failed to upload key signatures","Failed to upload key signatures",n,{failures:e,source:t,continuation:s})}),e.on("crypto.verification.request",e=>{if(e.verifier){const t=R.getComponent("views.dialogs.IncomingSasDialog");w.a.createTrackedDialog("Incoming Verification","",t,{verifier:e.verifier},null,!1,!0)}else e.pending&&Y.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:e.isSelfVerification?Object(M.a)("Self-verification request"):Object(M.a)("Verification Request"),icon:"verification",props:{request:e},component:R.getComponent("toasts.VerificationRequestToast"),priority:90})});const n=L.a.getValue("roomColor");C.a.tint(n.primary_color,n.secondary_color)}onClientStarted(){const e=_.a.get();if(e.isCryptoEnabled()){const t=L.a.getValueAt(ae.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}}showScreen(e,t){if("register"===e)E.a.dispatch({action:"start_registration",params:t});else if("login"===e)E.a.dispatch({action:"start_login",params:t});else if("forgot_password"===e)E.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)_.a.get()&&_.a.get().getUserId()&&!T.h()?this.viewLastRoom():E.a.dispatch({action:"start_login",params:t});else if("new"===e)E.a.dispatch({action:"view_create_room"});else if("settings"===e)E.a.fire(Q.a.ViewUserSettings);else if("welcome"===e)E.a.dispatch({action:"view_welcome_page"});else if("home"===e)E.a.dispatch({action:"view_home_page"});else if("start"===e)this.showScreen("home"),E.a.dispatch({action:"require_registration"});else if("directory"===e)E.a.fire(Q.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){let t=_.a.get();if(!t){const{hsUrl:e,isUrl:s}=this.props.serverConfig;t=l.p({baseUrl:e,idBaseUrl:s})}const s="start_sso"===e?"sso":"cas";v.a.get().startSingleSignOn(t,s,this.getFragmentAfterLogin())}else if("groups"===e)E.a.dispatch({action:"view_my_groups"});else if("complete_security"===e)E.a.dispatch({action:"start_complete_security"});else if("post_registration"===e)E.a.dispatch({action:"start_post_registration"});else if(0===e.indexOf("room/")){const s=e.substring(5),n=s.indexOf(":")+1;let i=s.length;s.substring(n).indexOf("/")>-1&&(i=n+s.substring(n).indexOf("/"));const o=s.substring(0,i);let r=s.substring(i+1);r||(r=void 0);const a={inviteSignUrl:t.signurl,invitedEmail:t.email},c={name:t.room_name,avatarUrl:t.room_avatar_url,inviterName:t.inviter_name};let l=[];t.via&&(l="string"==typeof t.via?[t.via]:t.via);const d={action:"view_room",event_id:r,via_servers:l,highlighted:Boolean(r),third_party_invite:a,oob_data:c,room_alias:void 0,room_id:void 0};"#"===o[0]?d.room_alias=o:d.room_id=o,E.a.dispatch(d)}else if(0===e.indexOf("user/")){const s=e.substring(5);E.a.dispatch({action:"view_user_info",userId:s,subAction:t.action})}else if(0===e.indexOf("group/")){const t=e.substring(6);E.a.dispatch({action:"view_group",group_id:t})}else console.info("Ignoring showScreen for '%s'",e)}notifyNewScreen(e){this.props.onNewScreen&&this.props.onNewScreen(e),this.setPageSubtitle()}onAliasClick(e,t){e.preventDefault(),E.a.dispatch({action:"view_room",room_alias:t})}onUserClick(e,t){e.preventDefault();const s=new u.a(null,t);s&&E.a.dispatch({action:Q.a.ViewUser,member:s})}onGroupClick(e,t){e.preventDefault(),E.a.dispatch({action:"view_group",group_id:t})}onLogoutClick(e){E.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){E.a.dispatch({action:"timeline_resize"})}onRoomCreated(e){E.a.dispatch({action:"view_room",room_id:e})}onRegistered(e){return T.l(e)}onSendEvent(e,t){const s=_.a.get();s?s.sendEvent(e,t.getType(),t.getContent()).then(()=>{E.a.dispatch({action:"message_sent"})},e=>{E.a.dispatch({action:"message_send_failed"})}):E.a.dispatch({action:"message_send_failed"})}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=_.a.get(),s=t&&t.getRoom(this.state.currentRoomId);s&&(e=`${this.subTitleStatus} | ${s.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;document.title=`${y.a.get().brand} ${e}`}updateStatusIndicator(e,t){const s=re.a.instance.globalState.numUnreadStates;v.a.get()&&(v.a.get().setErrorStatus("ERROR"===e),v.a.get().setNotificationCount(s)),this.subTitleStatus="","ERROR"===e&&(this.subTitleStatus+=`[${Object(M.a)("Offline")}] `),s>0&&(this.subTitleStatus+=`[${s}]`),this.setPageSubtitle()}onCloseAllSettings(){E.a.dispatch({action:"close_settings"})}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e="/"+t.screen),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===de.LOADING){const e=R.getComponent("elements.Spinner");t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},c.a.createElement(e,null))}else if(this.state.view===de.COMPLETE_SECURITY){const e=R.getComponent("structures.auth.CompleteSecurity");t=c.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished})}else if(this.state.view===de.E2E_SETUP){const e=R.getComponent("structures.auth.E2eSetup");t=c.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.accountPassword})}else if(this.state.view===de.POST_REGISTRATION){const e=R.getComponent("structures.auth.PostRegistration");t=c.a.createElement(e,{onComplete:this.onFinishPostRegistration})}else if(this.state.view===de.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof d.b;if(this.state.ready&&this.state.page_type&&!e){const e=R.getComponent("structures.LoggedInView");t=c.a.createElement(e,i()({},this.props,this.state,{ref:this.loggedInView,matrixClient:_.a.get(),onRoomCreated:this.onRoomCreated,onCloseAllSettings:this.onCloseAllSettings,onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}))}else{const s=R.getComponent("elements.Spinner");let n;this.state.syncError&&!e&&(n=c.a.createElement("div",{className:"mx_MatrixChat_syncError"},Object(V.c)(this.state.syncError))),t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},n,c.a.createElement(s,null),c.a.createElement("a",{href:"#",className:"mx_MatrixChat_splashButtons",onClick:this.onLogoutClick},Object(M.a)("Logout")))}}else if(this.state.view===de.WELCOME){const e=R.getComponent("auth.Welcome");t=c.a.createElement(e,null)}else if(this.state.view===de.REGISTER){const e=R.getComponent("structures.auth.Registration");t=c.a.createElement(e,i()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:this.props.startingFragmentQueryParams.email,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName},this.getServerProperties()))}else if(this.state.view===de.FORGOT_PASSWORD){const e=R.getComponent("structures.auth.ForgotPassword");t=c.a.createElement(e,i()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange},this.getServerProperties()))}else if(this.state.view===de.LOGIN){const s=R.getComponent("structures.auth.Login");t=c.a.createElement(s,i()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:this.onForgotPasswordClick,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===de.SOFT_LOGOUT){const s=R.getComponent("structures.auth.SoftLogout");t=c.a.createElement(s,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e})}else console.error("Unknown view "+this.state.view);const s=R.getComponent("elements.ErrorBoundary");return c.a.createElement(s,null,t)}}function me(){const e=window.matrixChat;return e&&e.state.view===de.LOGGED_IN}r()(he,"displayName","MatrixChat"),r()(he,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}})},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return u}));var n=s(0),i=s(1),o=s(85),r=s(228);const a={},c={};class l{constructor(e){this._userId=e.userId,this._deviceId=e.deviceId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,s){}}class d{constructor(e){this._userId=e.userId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomKeyEvent(e){}importRoomKey(e){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){}}class u extends Error{constructor(e,t,s){super(t),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let s=e.name+"[msg: "+e.message;t&&(s+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return s+="]",s}(this,s)}}class h extends Error{constructor(e,t){super(e),this.name="UnknownDeviceError",this.devices=t}}function m(e,t,s){a[e]=t,c[e]=s}const p=r.a.DeviceVerification;function g(e){Object(i.v)(this,l,e),this._sessionPrepared=!1,this._prepPromise=null}function f(e){Object(i.v)(this,d,e)}i.o(g,l),g.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();const t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(s){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},g.prototype.encryptMessage=async function(e,t,s){const n=await e.getEncryptionTargetMembers(),r=i.u(n,(function(e){return e.userId})),a=this;await this._ensureSession(r);const c={room_id:e.roomId,type:t,content:s},l={algorithm:o.OLM_ALGORITHM,sender_key:a._olmDevice.deviceCurve25519Key,ciphertext:{}},d=[];for(let e=0;e<r.length;++e){const t=r[e],s=a._crypto.getStoredDevicesForUser(t);for(let e=0;e<s.length;++e){const n=s[e];n.getIdentityKey()!=a._olmDevice.deviceCurve25519Key&&(n.verified!=p.BLOCKED&&d.push(o.encryptMessageForDevice(l.ciphertext,a._userId,a._deviceId,a._olmDevice,t,n,c)))}}return await Promise.all(d).then(()=>l)},i.o(f,d),f.prototype.decryptEvent=async function(e){const t=e.getWireContent(),s=t.sender_key,n=t.ciphertext;if(!n)throw new u("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in n))throw new u("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const i=n[this._olmDevice.deviceCurve25519Key];let o;try{o=await this._decryptMessage(s,i)}catch(e){throw new u("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:s,err:e})}const r=JSON.parse(o);if(r.recipient!=this._userId)throw new u("OLM_BAD_RECIPIENT","Message was intented for "+r.recipient);if(r.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new u("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:r.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(r.sender!=e.getSender())throw new u("OLM_FORWARDED_MESSAGE","Message forwarded from "+r.sender,{reported_sender:e.getSender()});if(r.room_id!==e.getRoomId())throw new u("OLM_BAD_ROOM","Message intended for room "+r.room_id,{reported_room:e.room_id});return{clearEvent:r,senderCurve25519Key:s,claimedEd25519Key:(r.keys||{}).ed25519||null}},f.prototype._decryptMessage=async function(e,t){if(0!==t.type)return this._reallyDecryptMessage(e,t);{const s=this._olmDevice._olmPrekeyPromise.then(()=>this._reallyDecryptMessage(e,t));return this._olmDevice._olmPrekeyPromise=s.catch(()=>{}),await s}},f.prototype._reallyDecryptMessage=async function(e,t){const s=await this._olmDevice.getSessionIdsForDevice(e),i={};for(let o=0;o<s.length;o++){const r=s[o];try{const s=await this._olmDevice.decryptMessage(e,r,t.type,t.body);return n.a.log("Decrypted Olm message from "+e+" with session "+r),s}catch(s){if(await this._olmDevice.matchesSession(e,r,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+r+": "+s.message);i[r]=s.message}}if(0!==t.type){if(0===s.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let o;try{o=await this._olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw i["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return n.a.log("created new inbound Olm session ID "+o.session_id+" with "+e),o.payload},m(o.OLM_ALGORITHM,g,f);var _=s(373);function v(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={}}function y(e){Object(i.v)(this,l,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function b(e){Object(i.v)(this,d,e),this._pendingEvents={},this.olmlib=o}v.prototype.needsRotation=function(e,t){const s=(new Date).getTime()-this.creationTime;return(this.useCount>=e||s>=t)&&(n.a.log("Rotating megolm session after "+this.useCount+" messages, "+s+"ms"),!0)},v.prototype.markSharedWithDevice=function(e,t,s){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=s},v.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},v.prototype.sharedWithTooManyDevices=function(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return n.a.log("Starting new megolm session because we shared with "+t),!0;for(const s in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(s)&&!e[t].hasOwnProperty(s))return n.a.log("Starting new megolm session because we shared with "+t+":"+s),!0}},i.o(y,l),y.prototype._ensureOutboundSession=async function(e,t,s){let i;function r(){return i}const a=this._setupPromise.then(async r=>{i=r,i&&i.needsRotation(this._sessionRotationPeriodMsgs,this._sessionRotationPeriodMs)&&(n.a.log("Starting new megolm session because we need to rotate."),i=null),i&&i.sharedWithTooManyDevices(e)&&(i=null),i||(n.a.log("Starting new megolm session for room "+this._roomId),i=await this._prepareNewSession(),n.a.log(`Started new megolm session ${i.sessionId} for room `+this._roomId),this._outboundSessions[i.sessionId]=i);const a={};for(const[t,s]of Object.entries(e))for(const[e,n]of Object.entries(s)){n.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[t]&&void 0!==i.sharedWithDevices[t][e]||(a[t]=a[t]||[],a[t].push(n)))}const c=this._olmDevice.getOutboundGroupSessionKey(i.sessionId),l={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:i.sessionId,session_key:c.key,chain_index:c.chain_index}},[d,u]=await o.getExistingOlmSessions(this._olmDevice,this._baseApis,a);await Promise.all([(async()=>{await this._shareKeyWithOlmSessions(i,c,l,u)})(),(async()=>{const e=[],t=Date.now(),n=[];await this._shareKeyWithDevices(i,c,l,d,e,s?1e4:2e3,n),!s&&Date.now()-t<1e4?(async()=>{const t={},s=new Set;for(const e of n)s.add(e);const o=[];for(const{userId:n,deviceInfo:i}of e){const e=n.slice(n.indexOf(":")+1);s.has(e)?(t[n]=t[n]||[],t[n].push(i)):o.push({userId:n,deviceInfo:i})}await this._shareKeyWithDevices(i,c,l,t,o,3e4),await this._notifyFailedOlmDevices(i,c,o)})():await this._notifyFailedOlmDevices(i,c,e)})(),(async()=>{const e={};for(const[s,n]of Object.entries(t))for(const[t,o]of Object.entries(n))i.blockedDevicesNotified[s]&&void 0!==i.blockedDevicesNotified[s][t]||(e[s]=e[s]||{},e[s][t]={device:o});await this._notifyBlockedDevices(i,e)})()])});return this._setupPromise=a.then(r,r),a.then(r)},y.prototype._prepareNewSession=async function(){const e=this._olmDevice.createOutboundGroupSession(),t=this._olmDevice.getOutboundGroupSessionKey(e);return await this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key,{ed25519:this._olmDevice.deviceEd25519Key}),this._crypto.backupInfo&&this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key).catch(e=>{n.a.log("Failed to back up megolm session",e)}),new v(e)},y.prototype._getDevicesWithoutSessions=function(e,t,s){s=s||[];for(const[n,i]of Object.entries(t)){const t=e[n];for(const e of i){const i=e.deviceId;t[i].sessionId||(s.push({userId:n,deviceInfo:e}),delete t[i])}}return s},y.prototype._splitDevices=function(e){let t=[];const s=[t];for(const[n,i]of Object.entries(e)){for(const e of Object.values(i))t.push({userId:n,deviceInfo:e.device});t.length>20&&(t=[],s.push(t))}return 0===t.length&&s.pop(),s},y.prototype._encryptAndSendKeysToDevices=function(e,t,s,i){const r={},a=[];for(let e=0;e<s.length;e++){const t={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},n=s[e],c=n.userId,l=n.deviceInfo,d=l.deviceId;r[c]||(r[c]={}),r[c][d]=t,a.push(o.encryptMessageForDevice(t.ciphertext,this._userId,this._deviceId,this._olmDevice,c,l,i))}return Promise.all(a).then(()=>{for(const e of Object.keys(r)){for(const t of Object.keys(r[e]))0===Object.keys(r[e][t].ciphertext).length&&(n.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete r[e][t]);0===Object.keys(r[e]).length&&(n.a.log("Pruned all devices for user "+e),delete r[e])}if(0!==Object.keys(r).length)return this._baseApis.sendToDevice("m.room.encrypted",r).then(()=>{for(const s of Object.keys(r))for(const n of Object.keys(r[s]))e.markSharedWithDevice(s,n,t)});n.a.log("No users left to send to: aborting")})},y.prototype._sendBlockedNotificationsToDevices=async function(e,t,s){const n={};for(const e of t){const t=e.userId,i=e.deviceInfo,o=i.deviceInfo.deviceId,r=Object.assign({},s);r.code=i.code,r.reason=i.reason,"m.no_olm"===r.code&&(delete r.room_id,delete r.session_id),n[t]||(n[t]={}),n[t][o]=r}await this._baseApis.sendToDevice("org.matrix.room_key.withheld",n);for(const t of Object.keys(n))for(const s of Object.keys(n[t]))e.markNotifiedBlockedDevice(t,s)},y.prototype.reshareKeyWithDevice=async function(e,t,s,i){const r=this._outboundSessions[t];if(!r)return void n.a.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===r.sharedWithDevices[s])return void n.a.debug(`megolm session ${t} never shared with user ${s}`);const a=r.sharedWithDevices[s][i.deviceId];if(void 0===a)return void n.a.debug("megolm session ID "+t+" never shared with device "+s+":"+i.deviceId);const c=await this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,a);if(!c)return void n.a.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[s]:[i]});const l={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain}},d={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,s,i,l),await this._baseApis.sendToDevice("m.room.encrypted",{[s]:{[i.deviceId]:d}}),n.a.debug(`Re-shared key for megolm session ${t} with ${s}:${i.deviceId}`)},y.prototype._shareKeyWithDevices=async function(e,t,s,n,i,r,a){const c=await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,n,r,a);this._getDevicesWithoutSessions(c,n,i),await this._shareKeyWithOlmSessions(e,t,s,c)},y.prototype._shareKeyWithOlmSessions=async function(e,t,s,i){const o=this._splitDevices(i);for(let i=0;i<o.length;i++)try{await this._encryptAndSendKeysToDevices(e,t.chain_index,o[i],s),n.a.log(`Completed megolm keyshare for ${e.sessionId} in ${this._roomId} (slice ${i+1}/${o.length})`)}catch(t){throw n.a.log(`megolm keyshare for ${e.sessionId} in ${this._roomId} (slice ${i+1}/${o.length}) failed`),t}},y.prototype._notifyFailedOlmDevices=async function(e,t,s){for(const{userId:n,deviceInfo:i}of s){const s=i.deviceId;e.markSharedWithDevice(n,s,t.chain_index)}const n=await this._olmDevice.filterOutNotifiedErrorDevices(s),i={};for(const{userId:e,deviceInfo:t}of n)i[e]=i[e]||{},i[e][t.deviceId]={device:{code:"m.no_olm",reason:_.b["m.no_olm"],deviceInfo:t}};await this._notifyBlockedDevices(e,i)},y.prototype._notifyBlockedDevices=async function(e,t){const s={room_id:this._roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},i=this._splitDevices(t);for(let t=0;t<i.length;t++)try{await this._sendBlockedNotificationsToDevices(e,i[t],s),n.a.log(`Completed blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${i.length})`)}catch(s){throw n.a.log(`blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${i.length}) failed`),s}},y.prototype.prepareToEncrypt=function(e){this.encryptionPreparation||(n.a.debug("Preparing to encrypt events for "+this._roomId),this.encryptionPreparation=(async()=>{const[t,s]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._removeUnknownDevices(t),await this._ensureOutboundSession(t,s,!0),delete this.encryptionPreparation})())},y.prototype.encryptMessage=async function(e,t,s){if(n.a.log("Starting to encrypt event for "+this._roomId),this.encryptionPreparation)try{await this.encryptionPreparation}catch(e){}const[i,r]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._checkForUnknownDevices(i);const a=await this._ensureOutboundSession(i,r),c={room_id:this._roomId,type:t,content:s},l=this._olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),d={algorithm:o.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:this._deviceId};return a.useCount++,d},y.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then(()=>null)},y.prototype._checkForUnknownDevices=function(e){const t={};if(Object.keys(e).forEach(s=>{Object.keys(e[s]).forEach(n=>{const i=e[s][n];i.isUnverified()&&!i.isKnown()&&(t[s]||(t[s]={}),t[s][n]=i)})}),Object.keys(t).length)throw new h("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},y.prototype._removeUnknownDevices=function(e){for(const[t,s]of Object.entries(e)){for(const[e,t]of Object.entries(s))t.isUnverified()&&!t.isKnown()&&delete s[e];0===Object.keys(s).length&&delete e[t]}},y.prototype._getDevicesInRoom=async function(e){const t=await e.getEncryptionTargetMembers(),s=i.u(t,(function(e){return e.userId}));let n=this._crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(n=e.getBlacklistUnverifiedDevices());const o=await this._crypto.downloadKeys(s,!1),r={};for(const e in o){if(!o.hasOwnProperty(e))continue;const t=o[e];for(const s in t){if(!t.hasOwnProperty(s))continue;const i=this._crypto.checkDeviceTrust(e,s);if(t[s].isBlocked()||!i.isVerified()&&n){r[e]||(r[e]={});const n=t[s].isBlocked()?{code:"m.blacklisted",reason:_.b["m.blacklisted"]}:{code:"m.unverified",reason:_.b["m.unverified"]};n.deviceInfo=t[s],r[e][s]=n,delete t[s]}}}return[o,r]},i.o(b,d);const E={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};b.prototype.decryptEvent=async function(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new u("MEGOLM_MISSING_FIELDS","Missing fields in input");let s;this._addEventToPendingList(e);try{s=await this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(s){if("DecryptionError"===s.name)throw s;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw s&&"OLM.UNKNOWN_MESSAGE_INDEX"===s.message&&(this._requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new u(n,s?s.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===s){this._requestKeysForEvent(e);const s=await this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(s){let e=E[s.type]||E.unknown;throw s.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new u("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new u("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this._removeEventFromPendingList(e);const n=JSON.parse(s.result);if(n.room_id!==e.getRoomId())throw new u("MEGOLM_BAD_ROOM","Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:s.senderKey,claimedEd25519Key:s.keysClaimed.ed25519,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain,untrusted:s.untrusted}},b.prototype._requestKeysForEvent=function(e){const t=e.getWireContent(),s=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},s)},b.prototype._addEventToPendingList=function(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id;this._pendingEvents[s]||(this._pendingEvents[s]=new Map);const i=this._pendingEvents[s];i.has(n)||i.set(n,new Set),i.get(n).add(e)},b.prototype._removeEventFromPendingList=function(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id,i=this._pendingEvents[s],o=i&&i.get(n);o&&(o.delete(e),0===o.size&&i.delete(s),0===i.size&&delete this._pendingEvents[s])},b.prototype.onRoomKeyEvent=function(e){const t=e.getContent(),s=t.session_id;let o,r=e.getSenderKey(),a=[],c=!1;if(t.room_id&&s&&t.session_key){if(r){if("m.forwarded_room_key"==e.getType()){if(c=!0,a=t.forwarding_curve25519_key_chain,i.p(a)||(a=[]),a=a.slice(),a.push(r),r=t.sender_key,!r)return void n.a.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void n.a.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");o={ed25519:e}}else o=e.getKeysClaimed();return this._olmDevice.addInboundGroupSession(t.room_id,r,a,s,t.session_key,o,c).then(()=>{this._retryDecryption(r,s).then(e=>{e&&this._crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:r})})}).then(()=>{this._crypto.backupInfo&&this._crypto.backupGroupSession(t.room_id,r,a,t.session_id,t.session_key,o,c).catch(e=>{n.a.log("Failed to back up megolm session",e)})}).catch(e=>{n.a.error("Error handling m.room_key_event: "+e)})}n.a.error("key event has no sender key (not encrypted?)")}else n.a.error("key event is missing fields")},b.prototype.onRoomKeyWithheldEvent=async function(e){const t=e.getContent(),s=t.sender_key;if("m.no_olm"===t.code){const i=e.getSender();if(n.a.warn(`${i}:${s} was unable to establish an olm session with us`),await this._olmDevice.getSessionIdForDevice(s))return n.a.debug("New session already created.  Not creating a new one."),await this._olmDevice.recordSessionProblem(s,"no_olm",!0),void this.retryDecryptionFromSender(s);let r=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,s);if(!r&&(await this._crypto.downloadKeys([i],!1),r=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,s),!r))return n.a.info("Couldn't find device for identity key "+s+": not establishing session"),await this._olmDevice.recordSessionProblem(s,"no_olm",!1),void this.retryDecryptionFromSender(s);await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[i]:[r]},!1);const a={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(a.ciphertext,this._userId,this._deviceId,this._olmDevice,i,r,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(s,"no_olm",!0),this.retryDecryptionFromSender(s),await this._baseApis.sendToDevice("m.room.encrypted",{[i]:{[r.deviceId]:a}})}else await this._olmDevice.addInboundGroupSessionWithheld(t.room_id,s,t.session_id,t.code,t.reason)},b.prototype.hasKeysForKeyRequest=function(e){const t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},b.prototype.shareKeysWithDevice=function(e){const t=e.userId,s=e.deviceId,i=this._crypto.getStoredDevice(t,s),r=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[t]:[i]}).then(e=>e[t][s].sessionId?(n.a.log("sharing keys for session "+r.sender_key+"|"+r.session_id+" with device "+t+":"+s),this._buildKeyForwardingMessage(r.room_id,r.sender_key,r.session_id)):null).then(e=>{const n={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(n.ciphertext,this._userId,this._deviceId,this._olmDevice,t,i,e).then(()=>{const e={[t]:{[s]:n}};return this._baseApis.sendToDevice("m.room.encrypted",e)})})},b.prototype._buildKeyForwardingMessage=async function(e,t,s){const n=await this._olmDevice.getInboundGroupSessionKey(e,t,s);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:s,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain}}},b.prototype.importRoomKey=function(e,t={}){return this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,t.untrusted?{untrusted:t.untrusted}:{}).then(()=>{this._crypto.backupInfo&&"backup"!==t.source&&this._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch(e=>{n.a.log("Failed to back up megolm session",e)}),this._retryDecryption(e.sender_key,e.session_id)})},b.prototype._retryDecryption=async function(e,t){const s=this._pendingEvents[e];if(!s)return!0;const i=s.get(t);return!i||(n.a.debug("Retrying decryption on events",[...i]),await Promise.all([...i].map(async e=>{try{await e.attemptDecryption(this._crypto,!0)}catch(e){}})),!(this._pendingEvents[e]||{})[t])},b.prototype.retryDecryptionFromSender=async function(e){const t=this._pendingEvents[e];return!t||(delete this._pendingEvents[e],await Promise.all([...t].map(async([e,t])=>{await Promise.all([...t].map(async e=>{try{await e.attemptDecryption(this._crypto)}catch(e){}}))})),!this._pendingEvents[e])},m(o.MEGOLM_ALGORITHM,y,b)},function(e,t,s){"use strict";var n=s(43),i=s.n(n),o=s(78),r=s(92);const a=(e,t,s)=>{const[i,o]=Object(n.useState)(s);return((e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setInterval(()=>{s.current()},t);return()=>clearInterval(e)},[t])})(()=>o(e=>e-1),t),0===i&&e(),i};t.a=({description:e,acceptLabel:t,dismissLabel:s,onAccept:n,onDismiss:c,toastKey:l,numSeconds:d})=>{const u=()=>{c&&c(),o.a.sharedInstance().dismissToast(l)},h=a(u,1e3,d);let m=s;return h>0&&(m+=` (${h})`),i.a.createElement(r.a,{description:e,acceptLabel:t,onAccept:n,rejectLabel:m,onReject:u})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(47),d=s(52),u=s(514),h=s(44);class m extends r.a.Component{constructor(...e){super(...e),i()(this,"state",{loading:!0}),i()(this,"_onStateEvent",e=>{e.getRoomId()===this.props.room.roomId&&"m.room.pinned_events"===e.getType()&&this._updatePinnedMessages()}),i()(this,"_updatePinnedMessages",()=>{const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(e&&e.getContent().pinned){const t=[],s=l.a.get();e.getContent().pinned.map(e=>{t.push(s.getEventTimeline(this.props.room.getUnfilteredTimelineSet(),e,0).then(t=>{const s=t.getEvents().find(t=>t.getId()===e);return{eventId:e,timeline:t,event:s}}).catch(t=>(console.error("Error looking up pinned event "+e+" in room "+this.props.room.roomId),console.error(t),null)))}),Promise.all(t).then(e=>{const t=e.filter(e=>class{static isPinnable(e){return!!e&&("m.room.message"===e.getType()&&!e.isRedacted())}}.isPinnable(e.event));this.setState({loading:!1,pinned:t})})}else this.setState({loading:!1,pinned:[]});this._updateReadState()})}componentDidMount(){this._updatePinnedMessages(),l.a.get().on("RoomState.events",this._onStateEvent)}componentWillUnmount(){l.a.get()&&l.a.get().removeListener("RoomState.events",this._onStateEvent)}_updateReadState(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(!e)return;let t=[];const s=this.props.room.getAccountData("im.vector.room.read_pins");s&&s.getContent()&&(t=s.getContent().event_ids||[]),t.includes(e.getId())||(t.push(e.getId()),t=t.reverse().splice(0,10).reverse(),l.a.get().setRoomAccountData(this.props.room.roomId,"im.vector.room.read_pins",{event_ids:t}))}_getPinnedTiles(){return 0===this.state.pinned.length?r.a.createElement("div",null,Object(h.a)("No pinned messages.")):this.state.pinned.map(e=>r.a.createElement(u.a,{key:e.event.getId(),mxRoom:this.props.room,mxEvent:e.event,onUnpinned:this._updatePinnedMessages}))}render(){let e=r.a.createElement("div",null,Object(h.a)("Loading..."));return this.state&&!this.state.loading&&(e=this._getPinnedTiles()),r.a.createElement("div",{className:"mx_PinnedEventsPanel"},r.a.createElement("div",{className:"mx_PinnedEventsPanel_body"},r.a.createElement(d.a,{className:"mx_PinnedEventsPanel_cancel",onClick:this.props.onCancelClick},r.a.createElement("img",{className:"mx_filterFlipColor",src:s(152),width:"18",height:"18"})),r.a.createElement("h3",{className:"mx_PinnedEventsPanel_header"},Object(h.a)("Pinned Messages")),e))}}i()(m,"propTypes",{room:c.a.object.isRequired,onCancelClick:c.a.func})},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(51),d=s.n(l),u=s(327),h=s(262),m=s(48),p=s(46),g=s(439),f=s(44),_=s(76),v=s(171),y=s(52),b=s(93),E=s(50);const S=(e,t)=>{try{const s=window.localStorage.getItem(e);return s?JSON.parse(s):t}catch(e){return t}};var w=s(480),C=s(261);class R extends r.a.Component{constructor(e){super(e),i()(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";switch(e.action){case"appsDrawer":e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}}),i()(this,"_getApps",()=>C.a.instance.getApps(this.props.room,!0)),i()(this,"_updateApps",()=>{this.setState({apps:this._getApps()})}),i()(this,"onClickAddWidget",e=>{e.preventDefault(),this._launchManageIntegrations()}),this.state={apps:this._getApps()}}componentDidMount(){g.b(),C.a.instance.on(this.props.room.roomId,this._updateApps),this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){g.c(),C.a.instance.off(this.props.room.roomId,this._updateApps),this.dispatcherRef&&m.a.unregister(this.dispatcherRef)}UNSAFE_componentWillReceiveProps(e){this._updateApps()}_canUserModify(){try{return _.a.canUserModifyWidgets(this.props.room.roomId)}catch(e){return console.error(e),!1}}_launchManageIntegrations(){E.a.getValue("feature_many_integration_managers")?b.a.sharedInstance().openAll():b.a.sharedInstance().getPrimaryManager().open(this.props.room,"add_integ")}render(){const e=this.state.apps.map((e,t,s)=>{const n=_.a.getCapWhitelistForAppTypeInRoomId(e.type,this.props.room.roomId);return r.a.createElement(h.a,{key:e.id,app:e,fullWidth:s.length<2,room:this.props.room,userId:this.props.userId,show:this.props.showApps,creatorUserId:e.creatorUserId,widgetPageTitle:_.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,whitelistCapabilities:n})});if(0===e.length)return r.a.createElement("div",null);let t,s;if(this.props.showApps&&this._canUserModify()&&(t=r.a.createElement(y.a,{onClick:this.onClickAddWidget,className:this.state.apps.length<2?"mx_AddWidget_button mx_AddWidget_button_full_width":"mx_AddWidget_button",title:Object(f.a)("Add a widget")},"[+] ",Object(f.a)("Add a widget"))),0===e.length&&v.a.roomHasPendingWidgets(this.props.room.roomId,_.a.getRoomWidgets(this.props.room))){const e=p.getComponent("elements.Spinner");s=r.a.createElement(e,null)}const n=d()({mx_AppsDrawer:!0,mx_AppsDrawer_hidden:this.props.hide,mx_AppsDrawer_fullWidth:e.length<2,mx_AppsDrawer_minimised:!this.props.showApps});return r.a.createElement("div",{className:n},r.a.createElement(k,{id:"apps-drawer_"+this.props.room.roomId,minHeight:100,maxHeight:this.props.maxHeight?this.props.maxHeight-50:void 0,handleClass:"mx_AppsContainer_resizerHandle",className:"mx_AppsContainer",resizeNotifier:this.props.resizeNotifier},e,s),this._canUserModify()&&t)}}i()(R,"propTypes",{userId:c.a.string.isRequired,room:c.a.object.isRequired,resizeNotifier:c.a.instanceOf(w.a).isRequired,showApps:c.a.bool,hide:c.a.bool}),i()(R,"defaultProps",{showApps:!0,hide:!1});const k=({id:e,minHeight:t,maxHeight:s,className:n,handleWrapperClass:i,handleClass:a,resizeNotifier:c,children:l})=>{const[h,m]=((e,t)=>{const s="mx_"+e,[n,i]=Object(o.useState)(S(s,t));Object(o.useEffect)(()=>{i(S(s,t))},[s,t]);return[n,Object(o.useCallback)(e=>{window.localStorage.setItem(s,JSON.stringify(e)),i(e)},[s])]})("pvr_"+e,280),[p,g]=Object(o.useState)(!1);return r.a.createElement(u.Resizable,{size:{height:Math.min(h,s)},minHeight:t,maxHeight:s,onResizeStart:()=>{p||g(!0),c.startResizing()},onResize:()=>{c.notifyTimelineHeightChanged()},onResizeStop:(e,t,s,n)=>{m(h+n.height),p&&g(!1),c.stopResizing()},handleWrapperClass:i,handleClasses:{bottom:a},className:d()(n,{mx_AppsDrawer_resizing:p}),enable:{bottom:!0}},l)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return d})),s.d(t,"a",(function(){return u}));var n=s(2),i=s.n(n),o=s(799),r=s.n(o);class a{constructor(e){i()(this,"_regex",void 0);const t=r()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this._regex=new RegExp(t.substring(1,t.length-1))}test(e){return this._regex.test(e)}}const c="m.ban",l=[c,"org.matrix.mjolnir.ban"];function d(e,t=!0){return l.includes(e)?t?l[l.length-1]:c:null}class u{constructor(e,t,s,n){i()(this,"_glob",void 0),i()(this,"_entity",void 0),i()(this,"_action",void 0),i()(this,"_reason",void 0),i()(this,"_kind",void 0),this._glob=new a(e),this._entity=e,this._action=d(t,!1),this._reason=s,this._kind=n}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(2),i=s.n(n);class o{constructor(e){this.tagId=e,i()(this,"_n",0),i()(this,"_previews",!1),i()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){return 44}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 5}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var r=s(103),a=s(48);class c extends r.a{constructor(){super(a.a),i()(this,"layoutMap",new Map)}static get instance(){return c.internalInstance||(c.internalInstance=new c),c.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new o(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new o(e)),this.layoutMap.get(e)}async resetLayouts(){console.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){return Promise.resolve()}}i()(c,"internalInstance",void 0),window.mxRoomListLayoutStore=c.instance},,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(272),i=s(0),o=s(157),r=s(1),a=s(192);function c(e,t){switch(e){case n.a.IS:return t+a.f+"/terms";case n.a.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function l(e){r.a(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;const t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:a.h,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new a.d(this,t),this._txnCtr=0}l.prototype.getHomeserverUrl=function(){return this.baseUrl},l.prototype.getIdentityServerUrl=function(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},l.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=r.g(e),this._http.setIdBaseUrl(this.idBaseUrl)},l.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},l.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},l.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},l.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then(e=>e.available)},l.prototype.register=function(e,t,s,n,i,o,r,a){!0===i?i={email:!0}:null==i&&(i={}),"function"==typeof r&&(a=r,r=void 0),s&&(n.session=s);const c={auth:n};return null!=e&&(c.username=e),null!=t&&(c.password=t),i.email&&(c.bind_email=!0),i.msisdn&&(c.bind_msisdn=!0),null!=o&&(c.guest_access_token=o),null!=r&&(c.inhibit_login=r),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)},l.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},l.prototype.registerRequest=function(e,t,s){const n={};return t&&(n.kind=t),this._http.request(s,"POST","/register",n,e)},l.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},l.prototype.login=function(e,t,s){const n={type:e};return r.i(n,t),this._http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this._http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),s&&s(e,t)},"POST","/login",void 0,n)},l.prototype.loginWithPassword=function(e,t,s){return this.login("m.login.password",{user:e,password:t},s)},l.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},l.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},l.prototype.getSsoLoginUrl=function(e,t){return void 0===t&&(t="sso"),this._http.getUrl("/login/"+t+"/redirect",{redirectUrl:e},a.h)},l.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},l.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},l.prototype.deactivateAccount=function(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const s={};return e&&(s.auth=e),void 0!==t&&(s.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,s)},l.prototype.getFallbackAuthUrl=function(e,t){const s=r.f("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(s,{session:t},a.h)},l.prototype.createRoom=async function(e,t){const s=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(s.length>0&&this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of s)t.id_access_token=e}return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},l.prototype.fetchRelations=async function(e,t,s,n,i){const o={};i.from&&(o.from=i.from);const c=r.e(o),l=r.f("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+c,{$roomId:e,$eventId:t,$relationType:s,$eventType:n});return await this._http.authedRequest(void 0,"GET",l,null,null,{prefix:a.i})},l.prototype.roomState=function(e,t){const s=r.f("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",s)},l.prototype.fetchRoomEvent=function(e,t,s){const n=r.f("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(s,"GET",n)},l.prototype.members=function(e,t,s,n,i){const o={};t&&(o.membership=t),s&&(o.not_membership=s),n&&(o.at=n);const a=r.e(o),c=r.f("/rooms/$roomId/members?"+a,{$roomId:e});return this._http.authedRequest(i,"GET",c)},l.prototype.upgradeRoom=function(e,t){const s=r.f("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",s,void 0,{new_version:t})},l.prototype.getGroupSummary=function(e){const t=r.f("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupProfile=function(e){const t=r.f("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.setGroupProfile=function(e,t){const s=r.f("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",s,void 0,t)},l.prototype.setGroupJoinPolicy=function(e,t){const s=r.f("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",s,void 0,{"m.join_policy":t})},l.prototype.getGroupUsers=function(e){const t=r.f("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupInvitedUsers=function(e){const t=r.f("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupRooms=function(e){const t=r.f("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.inviteUserToGroup=function(e,t){const s=r.f("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",s,void 0,{})},l.prototype.removeUserFromGroup=function(e,t){const s=r.f("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",s,void 0,{})},l.prototype.addUserToGroupSummary=function(e,t,s){const n=r.f(s?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:s,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.removeUserFromGroupSummary=function(e,t){const s=r.f("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",s,void 0,{})},l.prototype.addRoomToGroupSummary=function(e,t,s){const n=r.f(s?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:s,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.removeRoomFromGroupSummary=function(e,t){const s=r.f("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",s,void 0,{})},l.prototype.addRoomToGroup=function(e,t,s){void 0===s&&(s=!0);const n=r.f("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:s?"public":"private"}})},l.prototype.updateGroupRoomVisibility=function(e,t,s){const n=r.f("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{type:s?"public":"private"})},l.prototype.removeRoomFromGroup=function(e,t){const s=r.f("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",s,void 0,{})},l.prototype.acceptGroupInvite=function(e,t=null){const s=r.f("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",s,void 0,t||{})},l.prototype.joinGroup=function(e){const t=r.f("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.leaveGroup=function(e){const t=r.f("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.getJoinedGroups=function(){const e=r.f("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},l.prototype.createGroup=function(e){const t=r.f("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},l.prototype.getPublicisedGroups=function(e){const t=r.f("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},l.prototype.setGroupPublicity=function(e,t){const s=r.f("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",s,void 0,{publicise:t})},l.prototype.getStateEvent=function(e,t,s,n){const i={$roomId:e,$eventType:t,$stateKey:s};let o=r.f("/rooms/$roomId/state/$eventType",i);return void 0!==s&&(o=r.f(o+"/$stateKey",i)),this._http.authedRequest(n,"GET",o)},l.prototype.sendStateEvent=function(e,t,s,n,i){const o={$roomId:e,$eventType:t,$stateKey:n};let a=r.f("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(a=r.f(a+"/$stateKey",o)),this._http.authedRequest(i,"PUT",a,void 0,s)},l.prototype.roomInitialSync=function(e,t,s){r.q(t)&&(s=t,t=void 0);const n=r.f("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(s,"GET",n,{limit:t})},l.prototype.setRoomReadMarkersHttpRequest=function(e,t,s,n){const i=r.f("/rooms/$roomId/read_markers",{$roomId:e}),o={"m.fully_read":t,"m.read":s,"m.hidden":Boolean(!!n&&n.hidden)};return this._http.authedRequest(void 0,"POST",i,void 0,o)},l.prototype.getJoinedRooms=function(){const e=r.f("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},l.prototype.getJoinedRoomMembers=function(e){const t=r.f("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const s={};return e.server&&(s.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(s).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",s,e)},l.prototype.createAlias=function(e,t,s){const n=r.f("/directory/room/$alias",{$alias:e}),i={room_id:t};return this._http.authedRequest(s,"PUT",n,void 0,i)},l.prototype.deleteAlias=function(e,t){const s=r.f("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",s,void 0,void 0)},l.prototype.unstableGetLocalAliases=function(e,t){const s=r.f("/rooms/$roomId/aliases",{$roomId:e}),n=a.i+"/org.matrix.msc2432";return this._http.authedRequest(t,"GET",s,null,null,{prefix:n})},l.prototype.getRoomIdForAlias=function(e,t){const s=r.f("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",s)},l.prototype.resolveRoomAlias=function(e,t){const s=r.f("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",s)},l.prototype.getRoomDirectoryVisibility=function(e,t){const s=r.f("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",s)},l.prototype.setRoomDirectoryVisibility=function(e,t,s){const n=r.f("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(s,"PUT",n,void 0,{visibility:t})},l.prototype.setRoomDirectoryVisibilityAppService=function(e,t,s,n){const i=r.f("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(n,"PUT",i,void 0,{visibility:s})},l.prototype.searchUserDirectory=function(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},l.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},l.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},l.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},l.prototype.getProfileInfo=function(e,t,s){r.q(t)&&(s=t,t=void 0);const n=t?r.f("/profile/$userId/$info",{$userId:e,$info:t}):r.f("/profile/$userId",{$userId:e});return this._http.authedRequest(s,"GET",n)},l.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},l.prototype.addThreePid=function(e,t,s){const n={threePidCreds:e,bind:t};return this._http.authedRequest(s,"POST","/account/3pid",null,n)},l.prototype.addThreePidOnly=async function(e){const t=await this.isVersionSupported("r0.6.0")?a.h:a.i;return this._http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})},l.prototype.bindThreePid=async function(e){const t=await this.isVersionSupported("r0.6.0")?a.h:a.i;return this._http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})},l.prototype.unbindThreePid=async function(e,t){const s={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},n=await this.isVersionSupported("r0.6.0")?a.h:a.i;return this._http.authedRequest(void 0,"POST","/account/3pid/unbind",null,s,{prefix:n})},l.prototype.deleteThreePid=function(e,t){const s={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,s)},l.prototype.setPassword=function(e,t,s){const n={auth:e,new_password:t};return this._http.authedRequest(s,"POST","/account/password",null,n)},l.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},l.prototype.setDeviceDetails=function(e,t){const s=r.f("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",s,void 0,t)},l.prototype.deleteDevice=function(e,t){const s=r.f("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this._http.authedRequest(void 0,"DELETE",s,void 0,n)},l.prototype.deleteMultipleDevices=function(e,t){const s={devices:e};t&&(s.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,s)},l.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},l.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},l.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then(e=>o.a.rewriteDefaultRules(e))},l.prototype.addPushRule=function(e,t,s,n,i){const o=r.f("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this._http.authedRequest(i,"PUT",o,void 0,n)},l.prototype.deletePushRule=function(e,t,s,n){const i=r.f("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this._http.authedRequest(n,"DELETE",i)},l.prototype.setPushRuleEnabled=function(e,t,s,n,i){const o=r.f("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:s});return this._http.authedRequest(i,"PUT",o,void 0,{enabled:n})},l.prototype.setPushRuleActions=function(e,t,s,n,i){const o=r.f("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:s});return this._http.authedRequest(i,"PUT",o,void 0,{actions:n})},l.prototype.search=function(e,t){const s={};return e.next_batch&&(s.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",s,e.body)},l.prototype.uploadKeysRequest=function(e,t,s){return this._http.authedRequest(s,"POST","/keys/upload",void 0,e)},l.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:a.i})},l.prototype.downloadKeysForUsers=function(e,t){if(r.q(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const s={device_keys:{}};return"token"in(t=t||{})&&(s.token=t.token),e.forEach(e=>{s.device_keys[e]=[]}),this._http.authedRequest(void 0,"POST","/keys/query",void 0,s)},l.prototype.claimOneTimeKeys=function(e,t,s){const n={};void 0===t&&(t="signed_curve25519");for(let s=0;s<e.length;++s){const i=e[s][0],o=e[s][1],r=n[i]||{};n[i]=r,r[o]=t}const i={one_time_keys:n};s&&(i.timeout=s);return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,i)},l.prototype.getKeyChanges=function(e,t){const s={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",s,void 0)},l.prototype.uploadDeviceSigningKeys=function(e,t){const s=Object.assign({},t);return e&&Object.assign(s,{auth:e}),this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,s,{prefix:a.i})},l.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+a.f+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},l.prototype.requestEmailToken=async function(e,t,s,n,i,o){const r={client_secret:t,email:e,send_attempt:s,next_link:n};return await this._http.idServerRequest(i,"POST","/validate/email/requestToken",r,a.f,o)},l.prototype.requestMsisdnToken=async function(e,t,s,n,i,o,r){const c={client_secret:s,country:e,phone_number:t,send_attempt:n,next_link:i};return await this._http.idServerRequest(o,"POST","/validate/msisdn/requestToken",c,a.f,r)},l.prototype.submitMsisdnToken=async function(e,t,s,n){const i={sid:e,client_secret:t,token:s};return await this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,a.f,n)},l.prototype.submitMsisdnTokenOtherUrl=function(e,t,s,n){const i={sid:t,client_secret:s,token:n};return this._http.requestOtherUrl(void 0,"POST",e,void 0,i)},l.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,a.f,e)},l.prototype.identityHashedLookup=async function(t,s){const n={},i=await this.getIdentityHashDetails(s);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=i.lookup_pepper;const o={};if(i.algorithms.includes("sha256")){const s=new e.Olm.Utility;n.addresses=t.map(e=>{const t=e[0].toLowerCase(),i=e[1].toLowerCase(),r=s.sha256(`${t} ${i} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[r]=e[0],r}),n.algorithm="sha256"}else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t}),n.algorithm="none"}const r=await this._http.idServerRequest(void 0,"POST","/lookup",n,a.f,s);if(!r||!r.mappings)return[];const c=[];for(const e of Object.keys(r.mappings)){const t=r.mappings[e],s=o[e];if(!s)throw new Error("Identity server returned more results than expected");c.push({address:s,mxid:t})}return c},l.prototype.lookupThreePid=async function(e,t,s,n){const i=(await this.identityHashedLookup([[t,e]],n)).find(e=>e.address===t);if(!i)return s&&s(null,{}),{};const o={address:t,medium:e,mxid:i.mxid};return s&&s(null,o),o},l.prototype.bulkLookupThreePids=async function(e,t){const s=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),n=[];for(const t of s){const s=e.find(e=>e[1]===t.address);if(!s)throw new Error("Identity sever returned unexpected results");n.push([s[0],t.address,t.mxid])}return{threepids:n}},l.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,a.f,e)},l.prototype.sendToDevice=function(e,t,s){const n=r.f("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:s||this.makeTxnId()}),o={messages:t},a=Object.keys(t).reduce((e,s)=>(e[s]=Object.keys(t[s]),e),{});return i.a.log("PUT "+n,a),this._http.authedRequest(void 0,"PUT",n,void 0,o)},l.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: "+e);return e})},l.prototype.getThirdpartyLocation=function(e,t){const s=r.f("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",s,t,void 0)},l.prototype.getThirdpartyUser=function(e,t){const s=r.f("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",s,t,void 0)},l.prototype.getTerms=function(e,t){const s=c(e,t);return this._http.requestOtherUrl(void 0,"GET",s)},l.prototype.agreeToTerms=function(e,t,s,n){const i=c(e,t),o={Authorization:"Bearer "+s};return this._http.requestOtherUrl(void 0,"POST",i,null,{user_accepts:n},{headers:o})},l.prototype.reportEvent=function(e,t,s,n){const i=r.f("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",i,null,{score:s,reason:n})}}).call(this,s(6))},,function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(0);let i,o=0;const r=[];let a=Date.now;function c(e,t){(t=t||0)<0&&(t=0);const s=Array.prototype.slice.call(arguments,2),n=a()+t,i=o++,c={runAt:n,func:e,params:s,key:i},l=h(r,(function(e){return e.runAt-n}));return r.splice(l,0,c),d(),i}function l(e){if(0===r.length)return;let t;for(t=0;t<r.length;t++){if(r[t].key==e){r.splice(t,1);break}}0===t&&d()}function d(){i&&e.clearTimeout(i);const t=r[0];if(!t)return;const s=a(),n=Math.min(t.runAt-s,1e3);i=e.setTimeout(u,n)}function u(){let t;const s=a(),i=[];for(;;){const e=r[0];if(!e||e.runAt>s)break;t=r.shift(),t.key,i.push(t)}d();for(let s=0;s<i.length;s++){t=i[s];try{t.func.apply(e,t.params)}catch(e){n.a.error("Uncaught exception in callback function",e.stack||e)}}}function h(e,t){let s=0,n=e.length;for(;s<n;){const i=s+n>>1;t(e[i])>0?n=i:s=i+1}return s}}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return p}));var n=s(133),i=s(187),o=s(226),r=s(1),a=s(266),c=s(107),l=s(157),d=s(0),u=s(158);function h(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function m(...e){d.a.log(...e)}function p(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function g(e,t){const s=new n.a(t);return e.reEmitter.reEmit(s,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),s}p.prototype.createRoom=function(e){const t=this.client,{timelineSupport:s,unstableClientRelationAggregation:n}=t,o=new i.a(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:s,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(o,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(o),o},p.prototype.createGroup=function(e){const t=this.client,s=new o.a(e);return t.reEmitter.reEmit(s,["Group.profile","Group.myMembership"]),t.store.storeGroup(s),s},p.prototype._registerStateListeners=function(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,s,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},p.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},p.prototype.syncLeftRooms=function(){const e=this.client,t=this,s=new a.a(this.client.credentials.userId);s.setTimelineLimit(1),s.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,i={timeout:0};return e.getOrCreateFilter(h(e.credentials.userId,"LEFT_ROOMS"),s).then((function(t){return i.filter=t,e._http.authedRequest(void 0,"GET","/sync",i,void 0,n)})).then((function(s){let n=[];s.rooms&&s.rooms.leave&&(n=t._mapSyncResponseToRoomArray(s.rooms.leave));const i=[];return n.forEach((function(s){const n=s.room;if(i.push(n),!s.isBrandNewRoom)return;s.timeline=s.timeline||{};const o=t._mapSyncEventsFormat(s.timeline,n),r=t._mapSyncEventsFormat(s.state,n);n.getLiveTimeline().setPaginationToken(s.timeline.prev_batch,c.a.BACKWARDS),t._processRoomEvents(n,r,o),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,o)})),i}))},p.prototype.peek=function(e){const t=this,s=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then((function(n){n.messages=n.messages||{},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];const i=t.createRoom(e),o=r.u(r.c(n.state),s.getEventMapper()),a=r.u(n.state,s.getEventMapper()),c=r.u(n.messages.chunk,s.getEventMapper());return n.presence&&r.p(n.presence)&&n.presence.map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=g(s,e.getContent().user_id),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit("event",e)})),n.messages.start&&(i.oldState.paginationToken=n.messages.start),i.oldState.setStateEvents(o),i.currentState.setStateEvents(a),t._resolveInvites(i),i.recalculate(),i.addEventsToTimeline(c.reverse(),!0,i.getLiveTimeline(),n.messages.start),s.store.storeRoom(i),s.emit("Room",i),t._peekPoll(i),i}))},p.prototype.stopPeeking=function(){this._peekRoomId=null},p.prototype._peekPoll=function(e,t){if(this._peekRoomId!==e.roomId)return void m("Stopped peeking in room %s",e.roomId);const s=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(s._peekRoomId!==e.roomId)return void m("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(s.client.getEventMapper()).forEach((function(e){let t=s.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=g(s.client,e.getContent().user_id),t.setPresenceEvent(e),s.client.store.storeUser(t)),s.client.emit("event",e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(s.client.getEventMapper());e.addLiveEvents(n),s._peekPoll(e,t.end)}),(function(n){d.a.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){s._peekPoll(e,t)}),3e4)}))},p.prototype.getSyncState=function(){return this._syncState},p.prototype.getSyncStateData=function(){return this._syncStateData},p.prototype.recoverFromSyncStartupError=async function(e,t){await e;const s=this._startKeepAlives();this._updateSyncState("ERROR",{error:t}),await s},p.prototype._wasLazyLoadingToggled=async function(e){e=!!e;let t=!1;if(!await this.client.store.isNewlyCreated()){const s=await this.client.store.getClientOptions();return s&&(t=!!s.lazyLoadMembers),t!==e}return!1},p.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.a.warn("Token no longer valid - assuming logout"),this.stop(),!0)},p.prototype.sync=function(){const t=this.client,s=this;this._running=!0,e.document&&(this._onOnlineBound=this._onOnline.bind(this),e.document.addEventListener("online",this._onOnlineBound,!1));let n=Promise.resolve(),i=null;function o(){const e=new a.a(t.credentials.userId);return e.setTimelineLimit(s.opts.initialSyncLimit),e}const r=async()=>{if(m("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){m("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(m("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=o()),this.opts.filter.setLazyLoadMembers(!0)):(m("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}m("Checking whether lazy loading has changed in store...");if(await this._wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this._storeIsInvalid=!0;const e=u.b.TOGGLED_LAZY_LOADING,t=new u.b(e,!!this.opts.lazyLoadMembers);return this._updateSyncState("ERROR",{error:t}),void d.a.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{m("Storing client options..."),await this.client._storeClientOptions(),m("Stored client options")}catch(e){throw d.a.error("Storing client options failed",e),e}!async function e(){let r,a;m("Getting filter..."),r=s.opts.filter?s.opts.filter:o();try{a=await t.getOrCreateFilter(h(t.credentials.userId),r)}catch(t){if(d.a.error("Getting filter failed",t),s._shouldAbortSync(t))return;return m("Waiting for saved sync before retrying filter..."),await s.recoverFromSyncStartupError(n,t),void e()}t.resetNotifTimelineSet(),null===s._currentSyncRequest&&(m("Sending first sync request..."),s._currentSyncRequest=s._doSyncRequest({filterId:a},i));m("Waiting for saved sync before starting sync processing..."),await n,s._sync({filterId:a})}()};t.isGuest()?s._sync({}):(m("Getting saved sync token..."),n=t.store.getSavedSyncToken().then(e=>(m("Got saved sync token"),i=e,m("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(m("Got reply from saved sync, exists? "+!!e),e)return s._syncFromCache(e)}).catch(e=>{d.a.error("Getting saved sync failed",e)}),async function e(){try{m("Getting push rules...");const e=await t.getPushRules();m("Got push rules"),t.pushRules=e}catch(t){if(d.a.error("Getting push rules failed",t),s._shouldAbortSync(t))return;return m("Waiting for saved sync before retrying push rules..."),await s.recoverFromSyncStartupError(n,t),void e()}r()}())},p.prototype.stop=function(){m("SyncApi.stop"),e.document&&(e.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},p.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},p.prototype._syncFromCache=async function(e){m("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const s={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this._processSyncResponse(s,n)}catch(e){d.a.error("Error processing cached sync",e.stack||e)}this._storeIsInvalid||this._updateSyncState("PREPARED",s)},p.prototype._sync=async function(e){const t=this.client;if(!this._running)return m("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");const s=t.store.getSyncToken();let n;try{null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,s)),n=await this._currentSyncRequest}catch(t){return void this._onSyncError(t,e)}finally{this._currentSyncRequest=null}t.store.setSyncToken(n.next_batch),this._failedSyncCount=0,await t.store.setSyncData(n);const i={oldSyncToken:s,nextSyncToken:n.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(i);try{await this._processSyncResponse(i,n)}catch(e){d.a.error("Caught /sync error",e.stack||e),this.client.emit("sync.unexpectedError",e)}i.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",i),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(i),this._updateSyncState("SYNCING",i),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this._sync(e)},p.prototype._doSyncRequest=function(e,t){const s=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",s,void 0,s.timeout+8e4)},p.prototype._getSyncParams=function(e,t){let s=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,s=0);let n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());const i={filter:n,timeout:s};return this.opts.disablePresence&&(i.set_presence="offline"),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i},p.prototype._onSyncError=function(e,t){if(!this._running)return m("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");d.a.error("/sync error %s",e),d.a.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,d.a.log("Number of consecutive failed sync requests:",this._failedSyncCount),m("Starting keep-alive"),this._startKeepAlives().then(e=>{e&&"ERROR"===this.getSyncState()&&this._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this._sync(t)}),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},p.prototype._processSyncResponse=async function(e,t){const s=this.client,n=this;if(t.presence&&r.p(t.presence.events)&&t.presence.events.map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=g(s,e.getSender()),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit("event",e)})),t.account_data&&r.p(t.account_data.events)){const e=t.account_data.events.map(s.getEventMapper()),n=e.reduce((e,t)=>(e[t.getId()]=s.store.getAccountData(t.getType()),e),{});s.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){const t=e.getContent();s.pushRules=l.a.rewriteDefaultRules(t)}const t=n[e.getId()];return s.emit("accountData",e,t),e}))}if(t.to_device&&r.p(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(s.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const s=t.getContent().transaction_id;s&&e.push(s)}return t}).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const s=n.transaction_id;e.includes(s)&&t.flagCancelled()}s.emit("toDeviceEvent",t)}else d.a.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this._catchingUp=!1;t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave"));let i=[],o=[],a=[];if(t.rooms&&(t.rooms.invite&&(i=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(o=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(a=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],i.forEach((function(e){const t=e.room,i=n._mapSyncEventsFormat(e.invite_state,t);n._processRoomEvents(t,i),e.isBrandNewRoom&&(t.recalculate(),s.store.storeRoom(t),s.emit("Room",t)),i.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("invite")})),await r.w(o,(async function(t){const i=t.room,o=n._mapSyncEventsFormat(t.state,i),a=n._mapSyncEventsFormat(t.timeline,i),l=n._mapSyncEventsFormat(t.ephemeral),d=n._mapSyncEventsFormat(t.account_data);if(t.unread_notifications){i.setUnreadNotificationCount("total",t.unread_notifications.notification_count);const e=s.isRoomEncrypted(i.roomId);(!e||e&&i.getUnreadNotificationCount("highlight")<=0)&&i.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)}if(t.timeline=t.timeline||{},t.isBrandNewRoom)i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.a.BACKWARDS);else if(t.timeline.limited){let o=!0;for(let e=a.length-1;e>=0;e--){const t=a[e].getId();if(i.getTimelineForEvent(t)){m("Already have event "+t+" in limited sync - not resetting"),o=!1,a.splice(0,e);break}}o&&(n._deregisterStateListeners(i),i.resetLiveTimeline(t.timeline.prev_batch,n.opts.canResetEntireTimeline(i.roomId)?null:e.oldSyncToken),s.resetNotifTimelineSet(),n._registerStateListeners(i))}async function u(e){if(s.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&n.opts.crypto&&await n.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=s.store.getUser(e.getStateKey());t?t._unstable_updateStatusMessage(e):(t=g(s,e.getStateKey()),t._unstable_updateStatusMessage(e),s.store.storeUser(t))}}n._processRoomEvents(i,o,a,e.fromCache),t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(l),i.addAccountData(d),i.recalculate(),t.isBrandNewRoom&&(s.store.storeRoom(i),s.emit("Room",i)),n._processEventsForNotifs(i,a),await r.w(o,u),await r.w(a,u),l.forEach((function(e){s.emit("event",e)})),d.forEach((function(e){s.emit("event",e)})),i.updateMyMembership("join")})),a.forEach((function(e){const t=e.room,i=n._mapSyncEventsFormat(e.state,t),o=n._mapSyncEventsFormat(e.timeline,t),r=n._mapSyncEventsFormat(e.account_data);n._processRoomEvents(t,i,o),t.addAccountData(r),t.recalculate(),e.isBrandNewRoom&&(s.store.storeRoom(t),s.emit("Room",t)),n._processEventsForNotifs(t,o),i.forEach((function(e){s.emit("event",e)})),o.forEach((function(e){s.emit("event",e)})),r.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){s.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}},p.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);const t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=r.d()),this._connectionReturnedDefer.promise},p.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);const t=this;function s(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){s()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(s,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},p.prototype._processGroupSyncEntry=function(e,t){for(const s of Object.keys(e)){const n=e[s];let i=this.client.store.getGroup(s);const o=null===i;null===i&&(i=this.createGroup(s)),n.profile&&i.setProfile(n.profile.name,n.profile.avatar_url),n.inviter&&i.setInviter({userId:n.inviter}),i.setMyMembership(t),o&&this.client.emit("Group",i)}},p.prototype._mapSyncResponseToRoomArray=function(e){const t=this.client,s=this;return r.t(e).map((function(n){const i=e[n];let o=t.store.getRoom(n),r=!1;return o||(o=s.createRoom(n),r=!0),i.room=o,i.isBrandNewRoom=r,i}))},p.prototype._mapSyncEventsFormat=function(e,t){if(!e||!r.p(e.events))return[];const s=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),s(e)}))},p.prototype._resolveInvites=function(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(s){if(s._requestedProfileInfo)return;s._requestedProfileInfo=!0;const n=t.getUser(s.userId);let i;i=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(s.userId),i.then((function(t){const n=s.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,s.setMembershipEvent(n,e.currentState))}),(function(e){}))}))},p.prototype._processRoomEvents=function(e,t,s,n){const i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(s||[],null,n)},p.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const s=this.client.getPushActionsForEvent(t[e]);s&&s.notify&&s.tweaks&&s.tweaks.highlight&&this._notifEvents.push(t[e])}},p.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},p.prototype._updateSyncState=function(e,t){const s=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,s,t)},p.prototype._onOnline=function(){m("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,s(6))},function(e,t,s){"use strict";function n(){this.fromToken=null}s.d(t,"a",(function(){return n})),n.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,s,n){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(108);class i{constructor(e){this._cryptoStore=e,this._roomEncryption={}}async init(){await this._cryptoStore.doTxn("readwrite",[n.a.STORE_ROOMS],e=>{this._cryptoStore.getEndToEndRooms(e,e=>{this._roomEncryption=e})})}getRoomEncryption(e){return this._roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this._roomEncryption[e]=t,await this._cryptoStore.doTxn("readwrite",[n.a.STORE_ROOMS],s=>{this._cryptoStore.storeEndToEndRoom(e,t,s)})}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return a}));var n=s(0),i=s(1);const o=9;class r{constructor(e){this._db=e,e.onversionchange=t=>{n.a.log(`versionchange for indexeddb ${this._dbName}: closing`),e.close()}}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((s,i)=>{const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");o.onerror=i,this._getOutgoingRoomKeyRequest(o,t,i=>{if(i)return n.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void s(i);n.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),o.oncomplete=()=>{s(e)};o.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,s)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=s,this._getOutgoingRoomKeyRequest(n,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,s){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=e=>{const n=e.target.result;if(!n)return void s(null);const o=n.value;i.b(o.requestBody,t)?s(o):n.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,s=0;const n=this._db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),o=e[s];return i.index("state").openCursor(o).onsuccess=function n(i){const o=i.target.result;if(o)return void(t=o.value);if(s++,s>=e.length)return;const r=e[s];i.target.source.openCursor(r).onsuccess=n},l(n).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,s)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=e=>t(e.target.result),n.onerror=e=>s(e.target.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,s){let n=0;const i=[];const o=this._db.transaction("outgoingRoomKeyRequests","readonly"),r=o.objectStore("outgoingRoomKeyRequests"),a=s[n];return r.index("state").openCursor(a).onsuccess=function o(r){const a=r.target.result;if(a){const s=a.value;s.recipients.includes({userId:e,deviceId:t})&&i.push(s),a.continue()}else{if(n++,n>=s.length)return;const e=s[n];r.target.source.openCursor(e).onsuccess=o}},l(o).then(()=>i)}updateOutgoingRoomKeyRequest(e,t,s){let i=null;const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");return o.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const o=e.target.result;if(!o)return;const r=o.value;r.state==t?(Object.assign(r,s),o.update(r),i=r):n.a.warn(`Cannot update room key request from ${t} as it was already updated to `+r.state)},l(o).then(()=>i)}deleteOutgoingRoomKeyRequest(e,t){const s=this._db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=e=>{const s=e.target.result;if(!s)return;const i=s.value;i.state==t?s.delete():n.a.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`)},l(s)}getAccount(e,t){const s=e.objectStore("account").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const s=e.objectStore("account").get("crossSigningKeys");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}getSecretStorePrivateKey(e,t,s){const n=e.objectStore("account").get("ssss_cache:"+s);n.onsuccess=function(){try{t(n.result||null)}catch(t){c(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,s){e.objectStore("account").put(s,"ssss_cache:"+t)}countEndToEndSessions(e,t){const s=e.objectStore("sessions").count();s.onsuccess=function(){try{t(s.result)}catch(t){c(e,t)}}}getEndToEndSessions(e,t,s){const n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){const e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{s(i)}catch(e){c(t,e)}}}getEndToEndSession(e,t,s,n){const i=s.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){c(s,e)}}}getAllEndToEndSessions(e,t){const s=e.objectStore("sessions").openCursor();s.onsuccess=function(){try{const e=s.result;e?(t(e.value),e.continue()):t(null)}catch(t){c(e,t)}}}storeEndToEndSession(e,t,s,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,s){const n=this._db.transaction("session_problems","readwrite");return n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:s,time:Date.now()}),l(n)}async getEndToEndSessionProblem(e,t){let s;const n=this._db.transaction("session_problems","readwrite"),i=n.objectStore("session_problems").index("deviceKey").getAll(e);return i.onsuccess=e=>{const n=i.result;if(!n.length)return void(s=null);n.sort((e,t)=>e.time-t.time);const o=n[n.length-1];for(const e of n)if(e.time>t)return void(s=Object.assign({},e,{fixed:o.fixed}));s=o.fixed?null:o},await l(n),s}async filterOutNotifiedErrorDevices(e){const t=this._db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),s=[];return await Promise.all(e.map(e=>new Promise(n=>{const{userId:i,deviceInfo:o}=e,r=t.get([i,o.deviceId]);r.onsuccess=function(){r.result||(t.put({userId:i,deviceId:o.deviceId}),s.push(e)),n()}}))),s}getEndToEndInboundGroupSession(e,t,s,n){let i=!1,o=!1;const r=s.objectStore("inbound_group_sessions").get([e,t]);r.onsuccess=function(){try{i=r.result?r.result.session:null,!1!==o&&n(i,o)}catch(e){c(s,e)}};const a=s.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(i,o)}catch(e){c(s,e)}}}getAllEndToEndInboundGroupSessions(e,t){const s=e.objectStore("inbound_group_sessions").openCursor();s.onsuccess=function(){const n=s.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){c(e,t)}n.continue()}else try{t(null)}catch(t){c(e,t)}}}addEndToEndInboundGroupSession(e,t,s,i){const o=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:s});o.onerror=s=>{"ConstraintError"===o.error.name?(s.stopPropagation(),s.preventDefault(),n.a.log("Ignoring duplicate inbound group session: "+e+" / "+t)):c(i,new Error("Failed to add inbound group session: "+o.error))}}storeEndToEndInboundGroupSession(e,t,s,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:s})}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:s})}getEndToEndDeviceData(e,t){const s=e.objectStore("device_data").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,s){s.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const s={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){const i=n.result;if(i)s[i.key]=i.value,i.continue();else try{t(s)}catch(t){c(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,s)=>{const n=[],i=this._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=s,i.oncomplete=function(){t(n)};const o=i.objectStore("sessions_needing_backup"),r=i.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){const t=a.result;if(t){const s=r.get(t.key);s.onsuccess=function(){n.push({senderKey:s.result.senderCurve25519Key,sessionId:s.result.sessionId,sessionData:s.result.session})},(!e||n.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,s)=>{const n=t.count();n.onerror=s,n.onsuccess=()=>e(n.result)})}unmarkSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n})))}markSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n})))}doTxn(e,t,s){const n=this._db.transaction(t,e),i=l(n),o=s(n);return i.then(()=>o)}}function a(e,t){if(n.a.log("Upgrading IndexedDBCryptoStore from version "+t+" to "+o),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e),t<2&&e.createObjectStore("account"),t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}if(t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]}),t<5&&e.createObjectStore("device_data"),t<6&&e.createObjectStore("rooms"),t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]}),t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]}),t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}}function c(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function l(e){return new Promise((t,s)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&s(e._mx_abortexception),t()},e.onerror=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.a.log("Error performing indexeddb txn",t),s(t.target.error))},e.onabort=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.a.log("Error performing indexeddb txn",t),s(t.target.error))}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(10),i=s(0),o=s(228),r=s(229),a=s(85),c=s(108),l=s(1);class d extends n.EventEmitter{constructor(e,t,s){super(),this._cryptoStore=t,this._devices={},this._crossSigningInfo={},this._userByIdentityKey={},this._deviceTrackingStatus={},this._syncToken=null,this._serialiser=new u(e,s,this),this._keyDownloadsInProgressByUser={},this._dirty=!1,this._savePromise=null,this._resolveSavePromise=null,this._savePromiseTime=null,this._saveTimer=null,this._hasFetched=null}async load(){await this._cryptoStore.doTxn("readonly",[c.a.STORE_DEVICE_DATA],e=>{this._cryptoStore.getEndToEndDeviceData(e,e=>{this._hasFetched=Boolean(e&&e.devices),this._devices=e?e.devices:{},this._crossSigningInfo=e&&e.crossSigningInfo||{},this._deviceTrackingStatus=e?e.trackingStatus:{},this._syncToken=e?e.syncToken:null,this._userByIdentityKey={};for(const e of Object.keys(this._devices)){const t=this._devices[e];for(const s of Object.keys(t)){const n=t[s].keys["curve25519:"+s];void 0!==n&&(this._userByIdentityKey[n]=e)}}})});for(const e of Object.keys(this._deviceTrackingStatus))2==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=1)}stop(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}async saveIfDirty(e){if(!this._dirty)return Promise.resolve(!1);void 0===e&&(e=500);const t=Date.now+e;this._savePromiseTime&&t<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null);let s=this._savePromise;if(null===s&&(s=new Promise((e,t)=>{this._resolveSavePromise=e}),this._savePromise=s),null===this._saveTimer){const s=this._resolveSavePromise;this._savePromiseTime=t,this._saveTimer=setTimeout(()=>{i.a.log("Saving device tracking data",this._syncToken),this._savePromiseTime=null,this._saveTimer=null,this._savePromise=null,this._resolveSavePromise=null,this._cryptoStore.doTxn("readwrite",[c.a.STORE_DEVICE_DATA],e=>{this._cryptoStore.storeEndToEndDeviceData({devices:this._devices,crossSigningInfo:this._crossSigningInfo,trackingStatus:this._deviceTrackingStatus,syncToken:this._syncToken},e)}).then(()=>{this._dirty=!1,s()},e=>{i.a.error("Failed to save device tracking data",this._syncToken),i.a.error(e)})},e)}return s}getSyncToken(){return this._syncToken}setSyncToken(e){this._syncToken=e}downloadKeys(e,t){const s=[],n=[];if(e.forEach(e=>{const o=this._deviceTrackingStatus[e];this._keyDownloadsInProgressByUser[e]?(i.a.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),n.push(this._keyDownloadsInProgressByUser[e])):(t||3!=o)&&s.push(e)}),0!=s.length){i.a.log("downloadKeys: downloading for",s);const e=this._doKeyDownload(s);n.push(e)}return 0===n.length&&i.a.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this._getDevicesFromStore(e))}_getDevicesFromStore(e){const t={},s=this;return e.map((function(e){t[e]={};(s.getStoredDevicesForUser(e)||[]).map((function(s){t[e][s.deviceId]=s}))})),t}getKnownUserIds(){return Object.keys(this._devices)}getStoredDevicesForUser(e){const t=this._devices[e];if(!t)return null;const s=[];for(const e in t)t.hasOwnProperty(e)&&s.push(o.a.fromStorage(t[e],e));return s}getRawStoredDevicesForUser(e){return this._devices[e]}getStoredCrossSigningForUser(e){return this._crossSigningInfo[e]?r.a.fromStorage(this._crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}getStoredDevice(e,t){const s=this._devices[e];if(s&&s[t])return o.a.fromStorage(s[t],t)}getUserByIdentityKey(e,t){return e!==a.OLM_ALGORITHM&&e!==a.MEGOLM_ALGORITHM?null:this._userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const s=this.getUserByIdentityKey(e,t);if(!s)return null;const n=this._devices[s];if(!n)return null;for(const e in n){if(!n.hasOwnProperty(e))continue;const s=n[e];for(const n in s.keys){if(!s.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(s.keys[n]==t)return o.a.fromStorage(s,e)}}return null}storeDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,s]of Object.entries(this._devices[e])){const e=s.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[s,n]of Object.entries(t)){const t=n.keys["curve25519:"+s];this._userByIdentityKey[t]=e}this._dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(i.a.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}stopTrackingDeviceList(e){this._deviceTrackingStatus[e]&&(i.a.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this._deviceTrackingStatus))this._deviceTrackingStatus[e]=0;this._dirty=!0}invalidateUserDeviceList(e){this._deviceTrackingStatus[e]&&(i.a.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this._deviceTrackingStatus)){1==this._deviceTrackingStatus[t]&&e.push(t)}return this._doKeyDownload(e)}_setRawStoredDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,s]of Object.entries(this._devices[e])){const e=s.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[s,n]of Object.entries(t)){const t=n.keys["curve25519:"+s];this._userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this._crossSigningInfo[e]=t}_doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this._serialiser.updateDevicesForUsers(e,this._syncToken).then(()=>{s(!0)},t=>{throw i.a.error("Error downloading keys for "+e+":",t),s(!1),t});e.forEach(e=>{this._keyDownloadsInProgressByUser[e]=t;1==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=2)});const s=s=>{this.emit("crypto.willUpdateDevices",e,!this._hasFetched),e.forEach(e=>{if(this._dirty=!0,this._keyDownloadsInProgressByUser[e]!==t)return void i.a.log("Another update in the queue for",e,"- not marking up-to-date");delete this._keyDownloadsInProgressByUser[e];2==this._deviceTrackingStatus[e]&&(s?(this._deviceTrackingStatus[e]=3,i.a.log("Device list for",e,"now up to date")):this._deviceTrackingStatus[e]=1)}),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e,!this._hasFetched),this._hasFetched=!0};return t}}class u{constructor(e,t,s){this._baseApis=e,this._olmDevice=t,this._deviceList=s,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}updateDevicesForUsers(e,t){return e.forEach(e=>{this._keyDownloadsQueuedByUser[e]=!0}),this._queuedQueryDeferred||(this._queuedQueryDeferred=Object(l.d)()),this._syncToken=t,this._downloadInProgress?(i.a.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}_doQueuedQueries(){if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");const e=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};const t=this._queuedQueryDeferred;this._queuedQueryDeferred=null,i.a.log("Starting key download for",e),this._downloadInProgress=!0;const s={};return this._syncToken&&(s.token=this._syncToken),this._baseApis.downloadKeysForUsers(e,s).then(async t=>{const s=t.device_keys||{},n=t.master_keys||{},o=t.self_signing_keys||{},r=t.user_signing_keys||{};for(const t of e){await Object(l.A)(5);try{await this._processQueryResponseForUser(t,s[t],{master:n[t],self_signing:o[t],user_signing:r[t]})}catch(e){i.a.error(`Error processing keys for ${t}:`,e)}}}).then(()=>{i.a.log("Completed key download for "+e),this._downloadInProgress=!1,t.resolve(),this._queuedQueryDeferred&&this._doQueuedQueries()},s=>{i.a.warn("Error downloading keys for "+e+":",s),this._downloadInProgress=!1,t.reject(s)}),t.promise}async _processQueryResponseForUser(e,t,s){i.a.log("got device keys for "+e+":",t),i.a.log("got cross-signing keys for "+e+":",s);{const s={},n=this._deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach(e=>{const t=o.a.fromStorage(n[e],e);s[e]=t}),await async function(e,t,s,n){let o=!1;for(const e in s)s.hasOwnProperty(e)&&(e in n||(i.a.log("Device "+t+":"+e+" has been removed"),delete s[e],o=!0));for(const r in n){if(!n.hasOwnProperty(r))continue;const a=n[r];a.user_id===t?a.device_id===r?await h(e,s,a)&&(o=!0):i.a.warn("Mismatched device_id "+a.device_id+" in keys from "+t+":"+r):i.a.warn("Mismatched user_id "+a.user_id+" in keys from "+t+":"+r)}return o}(this._olmDevice,e,s,t||{});const r={};Object.keys(s).forEach(e=>{r[e]=s[e].toStorage()}),this._deviceList._setRawStoredDevicesForUser(e,r)}if(s&&(s.master||s.self_signing||s.user_signing)){const t=this._deviceList.getStoredCrossSigningForUser(e)||new r.a(e);t.setKeys(s),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this._deviceList.emit("userCrossSigningUpdated",e)}}}async function h(e,t,s){if(!s.keys)return!1;const n=s.device_id,r=s.user_id,c="ed25519:"+n,l=s.keys[c];if(!l)return i.a.warn("Device "+r+":"+n+" has no ed25519 key"),!1;const d=s.unsigned||{},u=s.signatures||{};try{await a.verifySignature(e,s,r,n,l)}catch(e){return i.a.warn("Unable to verify signature on device "+r+":"+n+":"+e),!1}let h;if(n in t){if(h=t[n],h.getFingerprint()!=l)return i.a.warn("Ed25519 key for device "+r+":"+n+" has changed"),!1}else t[n]=h=new o.a(n);return h.keys=s.keys||{},h.algorithms=s.algorithms||[],h.unsigned=d,h.signatures=u,!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(0),i=s(81),o=s(10),r=s(229),a=s(108),c=s(192);class l{constructor(e,t){this.accountDataClientAdapter=new u(e),this.crossSigningCallbacks=new h,this.ssssCryptoCallbacks=new m(t),this._crossSigningKeys=null,this._keySignatures=null,this._keyBackupInfo=null}addCrossSigningKeys(e,t){this._crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this._keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this._sessionBackupPrivateKey=e}addKeySignature(e,t,s){this._keySignatures||(this._keySignatures={});const n=this._keySignatures[e]||{};this._keySignatures[e]=n,n[t]=s}setAccountData(e,t){return this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter._values;return new d(e,this._crossSigningKeys,this._keyBackupInfo,this._keySignatures)}async persist(e){if(this._crossSigningKeys){const t=Object(r.d)(e._cryptoStore,e._olmDevice);for(const e of["master","self_signing","user_signing"]){n.a.log(`Cache ${e} cross-signing private key locally`);const s=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,s)}await e._cryptoStore.doTxn("readwrite",[a.a.STORE_ACCOUNT],t=>{e._cryptoStore.storeCrossSigningKeys(t,this._crossSigningKeys.keys)})}this._sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this._sessionBackupPrivateKey)}}class d{constructor(e,t,s,n){this._accountData=e,this._crossSigningKeys=t,this._keyBackupInfo=s,this._keySignatures=n}async apply(e){const t=e._baseApis;if(this._crossSigningKeys){const s={};for(const[e,t]of Object.entries(this._crossSigningKeys.keys))s[e+"_key"]=t;await this._crossSigningKeys.authUpload(e=>t.uploadDeviceSigningKeys(e,s)),e._crossSigningInfo.setKeys(this._crossSigningKeys.keys)}if(this._accountData)for(const[e,s]of this._accountData)await t.setAccountData(e,s);this._keySignatures&&await t.uploadKeySignatures(this._keySignatures),this._keyBackupInfo&&(this._keyBackupInfo.version?await t._http.authedRequest(void 0,"PUT","/room_keys/version/"+this._keyBackupInfo.version,void 0,{algorithm:this._keyBackupInfo.algorithm,auth_data:this._keyBackupInfo.auth_data},{prefix:c.i}):await t._http.authedRequest(void 0,"POST","/room_keys/version",void 0,this._keyBackupInfo,{prefix:c.i}))}}class u extends o.EventEmitter{constructor(e){super(),this._existingValues=e,this._values=new Map}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this._values.get(e);if(t)return t;const s=this._existingValues[e];return s?s.getContent():null}setAccountData(e,t){const s=this._values.get(e);return this._values.set(e,t),Promise.resolve().then(()=>{const n=new i.b({type:e,content:t});this.emit("accountData",n,s)})}}class h{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,s]of Object.entries(e))this.privateKeys.set(t,s)}}class m{constructor(e){this._privateKeys=new Map,this._delegateCryptoCallbacks=e}async getSecretStorageKey({keys:e},t){for(const t of Object.keys(e)){const e=this._privateKeys.get(t);if(e)return[t,e]}if(this._delegateCryptoCallbacks){const s=await this._delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(s){const[e,t]=s;this._privateKeys.set(e,t)}return s}}addPrivateKey(e,t){this._privateKeys.set(e,t),this._delegateCryptoCallbacks&&this._delegateCryptoCallbacks.cacheSecretStorageKey&&this._delegateCryptoCallbacks.cacheSecretStorageKey(e,t)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(10),i=s(0),o=s(85),r=s(12),a=s(275);const c="m.secret_storage.v1.aes-hmac-sha2";class l extends n.EventEmitter{constructor(e,t){super(),this._baseApis=e,this._cryptoCallbacks=t,this._requests={},this._incomingRequests={}}async getDefaultKeyId(){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(async(t,s)=>{const n=s=>{"m.secret_storage.default_key"===s.getType()&&s.getContent().key===e&&(this._baseApis.removeListener("accountData",n),t())};this._baseApis.on("accountData",n);try{await this._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}catch(e){this._baseApis.removeListener("accountData",n),s(e)}})}async addKey(e,t,s){const n={algorithm:e};if(t||(t={}),t.name&&(n.name=t.name),e!==c)throw new Error("Unknown key algorithm "+t.algorithm);if(t.passphrase&&(n.passphrase=t.passphrase),t.key){const{iv:e,mac:s}=await l._calculateKeyCheck(t.key);n.iv=e,n.mac=s}if(!s)do{s=Object(r.a)(32)}while(await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+s));return await this._baseApis.setAccountData("m.secret_storage.key."+s,n),s}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!await this.getKey(e)}async checkKey(e,t){if(t.algorithm===c){if(t.mac){const{mac:s}=await l._calculateKeyCheck(e,t.iv);return t.mac.replace(/=+$/g,"")===s.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}static async _calculateKeyCheck(e,t){return await Object(a.b)("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}async store(e,t,s){const n={};if(!s){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");s=[e]}if(0===s.length)throw new Error("Zero keys given to encrypt with!");for(const o of s){const s=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+o);if(!s)throw new Error("Unknown key: "+o);if(s.algorithm===c){const i={[o]:s},[,r]=await this._getSecretStorageKey(i,e);n[o]=await r.encrypt(t)}else i.a.warn("unknown algorithm for secret storage key "+o+": "+s.algorithm)}await this._baseApis.setAccountData(e,{encrypted:n})}async _fixupStoredSecret(e,t){const s=Object.keys(t);if(1===s.length&&"encrypted"!==s[0]&&t[s[0]].passthrough){if(await this.hasKey(s[0])){console.log("Fixing up passthrough secret: "+e),await this.storePassthrough(e,s[0]);return await this._baseApis.getAccountDataFromServer(e)}}return null}async get(e){let t=await this._baseApis.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted&&(t=await this._fixupStoredSecret(e,t),!t||!t.encrypted))throw new Error("Content is not encrypted!");const s={};for(const e of Object.keys(t.encrypted)){const n=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e),i=t.encrypted[e];n.algorithm===c&&i.iv&&i.ciphertext&&i.mac&&(s[e]=n)}if(0===Object.keys(s).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let n,i;try{[n,i]=await this._getSecretStorageKey(s,e);const r=t.encrypted[n];return r.passthrough?Object(o.encodeBase64)(i.get_private_key()):await i.decrypt(r)}finally{i&&i.free&&i.free()}}async isStored(e,t){let s=await this._baseApis.getAccountDataFromServer(e);if(!s)return null;if(!s.encrypted&&(s=await this._fixupStoredSecret(e,s),!s||!s.encrypted))return null;void 0===t&&(t=!0);const n={};for(const e of Object.keys(s.encrypted)){const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);if(!t)continue;const i=s.encrypted[e];t.algorithm===c&&i.iv&&i.ciphertext&&i.mac&&(n[e]=t)}return Object.keys(n).length?n:null}request(e,t){const s=this._baseApis.makeTxnId(),n=this._requests[s]={name:e,devices:t},o=new Promise((e,t)=>{n.resolve=e,n.reject=t}),r={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:s},a={};for(const e of t)a[e]=r;return i.a.info(`Request secret ${e} from ${t}, id ${s}`),this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:a}),{request_id:s,promise:o,cancel:e=>{const i={action:"request_cancellation",requesting_device_id:this._baseApis.deviceId,request_id:s},o={};for(const e of t)o[e]=i;this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:o}),n.reject(new Error(e||"Cancelled"))}}}async _onRequestReceived(e){const t=e.getSender(),s=e.getContent();if(t!==this._baseApis.getUserId()||!(s.name&&s.action&&s.requesting_device_id&&s.request_id))return;const n=s.requesting_device_id;if("request_cancellation"===s.action)this._incomingRequests[n]&&this._incomingRequests[n][s.request_id]&&(i.a.info("received request cancellation for secret ("+t+", "+n+", "+s.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:n,request_id:s.request_id}));else if("request"===s.action){if(n===this._baseApis.deviceId)return;if(i.a.info("received request for secret ("+t+", "+n+", "+s.request_id+")"),!this._cryptoCallbacks.onSecretRequested)return;const e=await this._cryptoCallbacks.onSecretRequested({user_id:t,device_id:n,request_id:s.request_id,name:s.name,device_trust:this._baseApis.checkDeviceTrust(t,n)});if(e){i.a.info(`Preparing ${s.name} secret for ${n}`);const r={type:"m.secret.send",content:{request_id:s.request_id,secret:e}},a={algorithm:o.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}};await o.ensureOlmSessionsForDevices(this._baseApis._crypto._olmDevice,this._baseApis,{[t]:[this._baseApis.getStoredDevice(t,n)]}),await o.encryptMessageForDevice(a.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,t,this._baseApis.getStoredDevice(t,n),r);const c={[t]:{[n]:a}};i.a.info(`Sending ${s.name} secret for ${n}`),this._baseApis.sendToDevice("m.room.encrypted",c)}else i.a.info(`Request denied for ${s.name} secret for ${n}`)}}_onSecretReceived(e){if(e.getSender()!==this._baseApis.getUserId())return;const t=e.getContent();i.a.log("got secret share for request",t.request_id);const s=this._requests[t.request_id];if(s){const n=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,e.getSenderKey());if(!n)return void i.a.log("secret share from unknown device with key",e.getSenderKey());if(!s.devices.includes(n.deviceId))return void i.a.log("unsolicited secret share from device",n.deviceId);i.a.log(`Successfully received secret ${s.name} from `+n.deviceId),s.resolve(t.secret)}}async _getSecretStorageKey(e,t){if(!this._cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const s=await this._cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!s)throw new Error("getSecretStorageKey callback returned falsey");if(s.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,i]=s;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===c){return[n,{encrypt:async function(e){return await Object(a.b)(e,i,t)},decrypt:async function(e){return await Object(a.a)(e,i,t)}}]}throw new Error("Unknown key type: "+e[n].algorithm)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(0),i=s(1);const o=0,r=1,a=2,c=3;class l{constructor(e,t,s){this._baseApis=e,this._deviceId=t,this._cryptoStore=s,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}start(){this._clientRunning=!0}stop(){n.a.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}sendQueuedRequests(){this._startTimer()}async queueRoomKeyRequest(e,t,s=!1){const i=await this._cryptoStore.getOutgoingRoomKeyRequest(e);if(i)switch(i.state){case c:case o:return;case a:{const e=s?c:r;await this._cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,a,{state:e,cancellationTxnId:this._baseApis.makeTxnId()});break}case r:if(s){const o=c,a=await this._cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,r,{state:o,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});if(!a)return await this.queueRoomKeyRequest(e,t,s);try{await this._sendOutgoingRoomKeyRequestCancellation(a,!0)}catch(e){n.a.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+i.state)}else await this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:o})}cancelRoomKeyRequest(e){return this._cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case a:case c:return;case o:return n.a.log("deleting unnecessary room key request for "+d(e)),this._cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,o);case r:return this._cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,r,{state:a,cancellationTxnId:this._baseApis.makeTxnId()}).then(t=>{t?this._sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{n.a.error("Error sending room key request cancellation; will retry later.",e),this._startTimer()}):n.a.log("Tried to cancel room key request for "+d(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[r])}async cancelAndResendAllOutgoingRequests(){const e=await this._cryptoStore.getAllOutgoingRoomKeyRequestsByState(r);return Promise.all(e.map(({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0)))}_startTimer(){if(this._sendOutgoingRoomKeyRequestsTimer)return;this._sendOutgoingRoomKeyRequestsTimer=e.setTimeout(()=>{if(this._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this._sendOutgoingRoomKeyRequestsRunning=!0,this._sendOutgoingRoomKeyRequests().finally(()=>{this._sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{n.a.warn("error in OutgoingRoomKeyRequestManager: "+e)})},500)}_sendOutgoingRoomKeyRequests(){return this._clientRunning?this._cryptoStore.getOutgoingRoomKeyRequestByState([a,c,o]).then(e=>{if(!e)return void(this._sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case o:t=this._sendOutgoingRoomKeyRequest(e);break;case a:t=this._sendOutgoingRoomKeyRequestCancellation(e);break;case c:t=this._sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this._sendOutgoingRoomKeyRequests()).catch(e=>{n.a.error("Error sending room key request; will retry later.",e),this._sendOutgoingRoomKeyRequestsTimer=null})}):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}_sendOutgoingRoomKeyRequest(e){n.a.log("Requesting keys for "+d(e.requestBody)+" from "+u(e.recipients)+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,o,{state:r}))}_sendOutgoingRoomKeyRequestCancellation(e,t){n.a.log("Sending cancellation for key request for "+d(e.requestBody)+" to "+u(e.recipients)+" "+`(cancellation id ${e.cancellationTxnId})`);const s={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(s,e.recipients,e.cancellationTxnId).then(()=>t?this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,c,{state:o}):this._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,a))}_sendMessageToDevices(e,t,s){const n={};for(const s of t)n[s.userId]||(n[s.userId]={}),n[s.userId][s.deviceId]=e;return this._baseApis.sendToDevice("m.room_key_request",n,s)}}function d(e){return e.room_id+" / "+e.session_id}function u(e){return"["+i.u(e,e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}}).call(this,s(6))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return O}));var n=s(276),i=s(274),o=s.n(i),r=s(194),a=s(0);const c="m.key.verification.start",l=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let d;const u=Object(r.a)("m.mismatched_sas","Mismatched short authentication string"),h=Object(r.a)("m.mismatched_commitment","Mismatched commitment");const m=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];const p={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>m[e])}};function g(e,t){const s={};for(const n of t)n in p&&(s[n]=p[n](e));return s}const f={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function _(e,t){return function(...s){const n=e[f[t]].apply(e,s);return a.a.log("SAS calculateMAC:",t,s,n),n}}const v={"curve25519-hkdf-sha256":function(e,t,s){const n=`${e._baseApis.getUserId()}|${e._baseApis.deviceId}|`+e.ourSASPubKey+"|",i=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,s)},curve25519:function(e,t,s){const n=`${e._baseApis.getUserId()}${e._baseApis.deviceId}`,i=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,s)}},y=["curve25519-hkdf-sha256","curve25519"],b=["sha256"],E=["hkdf-hmac-sha256","hmac-sha256"],S=Object.keys(p),w=new Set(y),C=new Set(b),R=new Set(E),k=new Set(S);function I(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}class O extends n.b{static get NAME(){return"m.sas.v1"}get events(){return l}async _doVerification(){await e.Olm.init(),d=d||new e.Olm.Utility,await this._baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this._doSendVerification():await this._doRespondVerification()}catch(e){if(!(e instanceof n.a))throw e;this.startEvent=e.startEvent,t=!0}}while(t)}canSwitchStartEvent(e){if(e.getType()!==c)return!1;const t=e.getContent();return t&&t.method===O.NAME&&this._waitingForAccept}async _sendStart(){const e=this._channel.completeContent(c,{method:O.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:y,hashes:b,message_authentication_codes:E,short_authentication_string:S});return await this._channel.sendCompleted(c,e),e}async _doSendVerification(){let t,s;if(this._waitingForAccept=!0,t=this.startEvent?this._channel.completedContentFromEvent(this.startEvent):await this._sendStart(),!this.initiatedByMe)throw new n.a(this.startEvent);try{s=await this._waitForEvent("m.key.verification.accept")}finally{this._waitingForAccept=!1}let i=s.getContent();const a=I(i.short_authentication_string,k);if(!(w.has(i.key_agreement_protocol)&&C.has(i.hash)&&R.has(i.message_authentication_code)&&a.length))throw Object(r.g)();if("string"!=typeof i.commitment)throw Object(r.c)();const c=i.key_agreement_protocol,l=i.message_authentication_code,m=i.commitment,p=new e.Olm.SAS;try{this.ourSASPubKey=p.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey}),s=await this._waitForEvent("m.key.verification.key"),i=s.getContent();const e=i.key+o.a.stringify(t);if(d.sha256(e)!==m)throw h();this.theirSASPubKey=i.key,p.set_their_key(i.key);const n=v[c](this,p,6),f=new Promise((e,t)=>{this.sasEvent={sas:g(n,a),confirm:async()=>{try{await this._sendMAC(p,l),e()}catch(e){t(e)}},cancel:()=>t(Object(r.h)()),mismatch:()=>t(u())},this.emit("show_sas",this.sasEvent)});[s]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),f]),i=s.getContent(),await this._checkMAC(p,i,l)}finally{p.free()}}async _doRespondVerification(){let t=this._channel.completedContentFromEvent(this.startEvent);const s=I(y,new Set(t.key_agreement_protocols))[0],n=I(b,new Set(t.hashes))[0],i=I(E,new Set(t.message_authentication_codes))[0],a=I(t.short_authentication_string,k);if(void 0===s||void 0===n||void 0===i||!a.length)throw Object(r.g)();const c=new e.Olm.SAS;try{const e=c.get_pubkey()+o.a.stringify(t);await this._send("m.key.verification.accept",{key_agreement_protocol:s,hash:n,message_authentication_code:i,short_authentication_string:a,commitment:d.sha256(e)});let l=await this._waitForEvent("m.key.verification.key");t=l.getContent(),this.theirSASPubKey=t.key,c.set_their_key(t.key),this.ourSASPubKey=c.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey});const h=v[s](this,c,6),m=new Promise((e,t)=>{this.sasEvent={sas:g(h,a),confirm:async()=>{try{await this._sendMAC(c,i),e()}catch(e){t(e)}},cancel:()=>t(Object(r.h)()),mismatch:()=>t(u())},this.emit("show_sas",this.sasEvent)});[l]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),m]),t=l.getContent(),await this._checkMAC(c,t,i)}finally{c.free()}}_sendMAC(e,t){const s={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,o="ed25519:"+this._baseApis.deviceId;s[o]=_(e,t)(this._baseApis.getDeviceEd25519Key(),i+o),n.push(o);const r=this._baseApis.getCrossSigningId();if(r){const o="ed25519:"+r;s[o]=_(e,t)(r,i+o),n.push(o)}const a=_(e,t)(n.sort().join(","),i+"KEY_IDS");return this._send("m.key.verification.mac",{mac:s,keys:a})}async _checkMAC(e,t,s){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId;if(t.keys!==_(e,s)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw Object(r.d)();await this._verifyKeys(this.userId,t.mac,(t,i,o)=>{if(o!==_(e,s)(i.keys[t],n+t))throw Object(r.d)()})}}}).call(this,s(6))},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));var n=s(135),i=s(0);class o{constructor(e,t,s=null){this._client=e,this._roomId=t,this.userId=s,this._requestEventId=null}get receiveStartFromOtherDevices(){return!0}get roomId(){return this._roomId}get transactionId(){return this._requestEventId}static getOtherPartyUserId(e,t){if(o.getEventType(e)!==n.i)return;const s=t.getUserId(),i=e.getSender(),r=e.getContent().to;return i===s?r:r===s?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===n.i}static getTransactionId(e){if(o.getEventType(e)===n.i)return e.getId();{const t=e.getRelation();if(t&&"m.reference"===t.rel_type)return t.event_id}}static validateEvent(e,t){const s=o.getTransactionId(e);if("string"!=typeof s||0===s.length)return!1;const r=o.getEventType(e),a=e.getContent();if(r===n.i){if(!a||"string"!=typeof a.to||!a.to.length)return i.a.log("InRoomChannel: validateEvent: no valid to "+(a&&a.to)),!1;if(!o.getOtherPartyUserId(e,t))return i.a.log("InRoomChannel: validateEvent: not directed to or sent by me: "+e.getSender()+", "+(a&&a.to)),!1}return n.k.validateEvent(r,e,t)}static getEventType(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===n.i)return n.i}}return t&&t!==n.i?t:""}async handleEvent(e,t,s){if(t.hasEventId(e.getId()))return;const n=o.getEventType(e);if(e.getRoomId()!==this._roomId)return;if(null===this.userId){const t=o.getOtherPartyUserId(e,this._client);t&&(this.userId=t)}const r=this._client.getUserId(),a=e.getSender();if(null!==this.userId&&a!==r&&a!==this.userId)return void i.a.log("InRoomChannel: ignoring verification event from non-participating sender "+a);null===this._requestEventId&&(this._requestEventId=o.getTransactionId(e));const c=!!e.getUnsigned().transaction_id,l=e.getSender()===this._client.getUserId();return await t.handleEvent(n,e,s,c,l)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==n.i&&e!==n.h&&e!==n.j||(t.from_device=this._client.getDeviceId()),e===n.i?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:n.i,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}send(e,t){const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s=e;e===n.i&&(s="m.room.message");const i=await this._client.sendEvent(this._roomId,s,t);e===n.i&&(this._requestEventId=i.event_id)}}class r{constructor(){this._requestsByRoomId=new Map}getRequest(e){const t=e.getRoomId(),s=o.getTransactionId(e);return this._getRequestByTxnId(t,s)}getRequestByChannel(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}_getRequestByTxnId(e,t){const s=this._requestsByRoomId.get(e);if(s)return s.get(t)}setRequest(e,t){this._setRequest(e.getRoomId(),o.getTransactionId(e),t)}setRequestByChannel(e,t){this._setRequest(e.roomId,e.transactionId,t)}_setRequest(e,t,s){let n=this._requestsByRoomId.get(e);n||(n=new Map,this._requestsByRoomId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getRoomId(),s=this._requestsByRoomId.get(t);s&&(s.delete(o.getTransactionId(e)),0===s.size&&this._requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this._requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(12),i=s(0),o=s(135),r=s(194),a=s(81);class c{constructor(e,t,s,n=null,i=null){this._client=e,this.userId=t,this._devices=s,this.transactionId=n,this._deviceId=i}isToDevices(e){if(e.length===this._devices.length){for(const t of e){if(!this._devices.find(e=>e.deviceId===t.deviceId))return!1}return!0}return!1}get deviceId(){return this._deviceId}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===o.i||e===o.j}static validateEvent(e,t){if(e.isCancelled())return i.a.warn("Ignoring flagged verification request from "+e.getSender()),!1;const s=e.getContent();if(!s)return i.a.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!s.transaction_id)return i.a.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===o.i){if(!Number.isFinite(s.timestamp))return i.a.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&s.from_device==t.getDeviceId())return i.a.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return o.k.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,s){const n=e.getType(),i=e.getContent();if(n===o.i||n===o.h||n===o.j){this.transactionId||(this.transactionId=i.transaction_id);const e=i.from_device;if(!this._deviceId&&this._devices.includes(e)&&(this._deviceId=e),!this._deviceId||this._deviceId!==e){const t=this.completeContent(Object(r.b)(Object(r.f)()));return this._sendToDevices(o.a,t,[e])}}const a=t.phase===o.f||t.phase===o.d;await t.handleEvent(e.getType(),e,s,!1,!1);const c=t.phase===o.f||t.phase===o.d;if((n===o.j||n===o.h)&&!a&&c&&this._deviceId){const e=this._devices.filter(e=>e!==this._deviceId);if(e.length){const t=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"});await this._sendToDevices(o.a,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==o.i&&e!==o.h&&e!==o.j||(t.from_device=this._client.getDeviceId()),e===o.i&&(t.timestamp=Date.now()),t}send(e,t={}){e!==o.i&&e!==o.j||this.transactionId||(this.transactionId=c.makeTransactionId());const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s;s=e===o.i?await this._sendToDevices(e,t,this._devices):await this._sendToDevices(e,t,[this._deviceId]);const n=new a.b({sender:this._client.getUserId(),content:t,type:e});return await this._request.handleEvent(e,n,!0,!0,!0),s}_sendToDevices(e,t,s){if(s.length){const n={};for(const e of s)n[e]=t;return this._client.sendToDevice(e,{[this.userId]:n})}return Promise.resolve()}static makeTransactionId(){return Object(n.a)(32)}}class l{constructor(){this._requestsByUserId=new Map}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const s=this._requestsByUserId.get(e);if(s)return s.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,s){let n=this._requestsByUserId.get(e);n||(n=new Map,this._requestsByUserId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getSender(),s=this._requestsByUserId.get(t);s&&(s.delete(c.getTransactionId(e)),0===s.size&&this._requestsByUserId.delete(t))}findRequestInProgress(e,t){const s=this._requestsByUserId.get(e);if(s)for(const e of s.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this._requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(276);class i extends n.b{static factory(...e){return new i(...e)}static get NAME(){return"org.matrix.illegal_method"}async _doVerification(){throw new Error("Verification is not possible with this method")}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(1);function o(e,t,s){this._workerScript=e,this._dbName=t,this._workerApi=s,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}o.prototype={connect:function(){return this._ensureStarted().then(()=>this._doCmd("connect"))},clearDatabase:function(){return this._ensureStarted().then(()=>this._doCmd("clearDatabase"))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then(()=>{n.a.log("IndexedDB worker is ready")})),this._startPromise},_doCmd:function(e,t){return Promise.resolve().then(()=>{const s=this._nextSeq++,n=Object(i.d)();return this._inFlight[s]=n,this._worker.postMessage({command:e,seq:s,args:t}),n.promise})},_onWorkerMessage:function(e){const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void n.a.error("Got reply from worker with no seq");const e=this._inFlight[t.seq];if(void 0===e)return void n.a.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const s=new Error(t.error.message);s.name=t.error.name,e.reject(s)}}else n.a.warn("Unrecognised message from worker: "+t)}}},,,,,,,function(e,t,s){"use strict";(function(e){class n{constructor(){this.components=null}getComponent(e){if(!e)throw new Error("Invalid component name: "+e);if(null===this.components)throw new Error("Attempted to get a component before a skin has been loaded. This is probably because either: a) Your app has not called sdk.loadSkin(), or b) A component has called getComponent at the root level");const t=(t=>{if(!t)return null;let s=t[e];return s||(s=t["views."+e]),s})(this.components);if(!t)return null;if(!("function"==typeof t))throw new Error(`Not a valid component: ${e} (type = ${typeof t}).`);return t}load(e){if(null!==this.components)throw new Error("Attempted to load a skin while a skin is already loadedIf you want to change the active skin, call resetSkin first");this.components={};const t=Object.keys(e.components);for(let s=0;s<t.length;++s){const n=e.components[t[s]];this.addComponent(t[s],n)}const n=s(1154);if(!n||!n.components)throw new Error("Invalid react-sdk component index");for(const e in n.components)this.components[e]||(this.components[e]=n.components[e])}addComponent(e,t){let s=e;void 0!==t.replaces&&(s=t.replaces.indexOf(".")>-1?t.replaces:e.substr(0,e.lastIndexOf(".")+1)+t.replaces.split(".").pop()),this.components[s]=t}reset(){this.components=null}}void 0===e.mxSkinner&&(e.mxSkinner=new n),t.a=e.mxSkinner}).call(this,s(6))},,,function(e,t){e.exports="img/feather-customised/check.237da63.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(750);function i(){return n({words:3}).raw.map(e=>e[0].toUpperCase()+e.substring(1).toLowerCase()).join("")}},,,,,function(e,t){e.exports="img/icon-pill-remove.7719165.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(2),i=s.n(n);class o{constructor(e){this.fn=e,i()(this,"marked",!1)}reset(){this.marked=!1}mark(){this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,s){"use strict";var n=s(2),i=s.n(n),o=s(74);class r{constructor(){i()(this,"listeners",{}),i()(this,"_activeRoomId",o.a.getRoomId()),i()(this,"roomStoreToken",void 0),i()(this,"onRoomViewStoreUpdate",()=>{this._activeRoomId&&this.emit(this._activeRoomId,!1),this._activeRoomId=o.a.getRoomId(),this._activeRoomId&&this.emit(this._activeRoomId,!0)}),this.roomStoreToken=o.a.addListener(this.onRoomViewStoreUpdate)}get activeRoomId(){return this._activeRoomId}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeListener(e,t){if(this.listeners[e]){const s=this.listeners[e].indexOf(t);s>-1&&this.listeners[e].splice(s,1)}else console.warn("Unregistering unrecognised listener (roomId="+e+")")}emit(e,t){if(this.listeners[e])for(const s of this.listeners[e])s.call(null,t)}}void 0===window.mxActiveRoomObserver&&(window.mxActiveRoomObserver=new r),t.a=window.mxActiveRoomObserver},,,,,,,,,,,,function(e,t){e.exports="img/rotate-ccw.be2daef.svg"},function(e,t){e.exports="img/rotate-cw.cddc22b.svg"},function(e,t){e.exports="img/cancel-white.d84db7e.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(459);class i{constructor(){}static forRoom(e){return n.a.instance.getOrCreateChamberForRoom(e)}}},,function(e,t,s){"use strict";function n(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}s.d(t,"a",(function(){return n}))},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(62),r=s(47),a=s(55),c=s(87),l=s(50),d=s(10),u=s(57);class h extends d.EventEmitter{constructor(){super(),i()(this,"onSync",async(e,t,s)=>{const n=o.a.get().getEventIndexingManager();if("PREPARED"===t&&"SYNCING"===e){return await n.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"!==t||"SYNCING"!==e||await n.commitLiveEvents()}),i()(this,"onRoomTimeline",async(e,t,s,n,i)=>{if(r.a.get().isRoomEncrypted(t.roomId)&&!s&&i&&i.liveEvent&&!e.isRedacted())if(e.isBeingDecrypted()){const t=e.getId();this.liveEventsForIndex.add(t)}else await this.addLiveEventToIndex(e)}),i()(this,"onRoomStateEvent",async(e,t)=>{r.a.get().isRoomEncrypted(t.roomId)&&("m.room.encryption"!==e.getType()||await this.isRoomIndexed(t.roomId)||(console.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),i()(this,"onEventDecrypted",async(e,t)=>{const s=e.getId();this.liveEventsForIndex.delete(s)&&(t||await this.addLiveEventToIndex(e))}),i()(this,"onRedaction",async(e,t)=>{if(!r.a.get().isRoomEncrypted(t.roomId))return;const s=o.a.get().getEventIndexingManager();try{await s.deleteEvent(e.getAssociatedId())}catch(e){console.log("EventIndex: Error deleting event from index",e)}}),i()(this,"onTimelineReset",async(e,t,s)=>{null!==e&&r.a.get().isRoomEncrypted(e.roomId)&&(console.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}),this.crawlerCheckpoints=[],this._crawlerIdleTime=5e3,this._eventsPerCrawl=100,this._crawler=null,this._currentCheckpoint=null,this.liveEventsForIndex=new Set}async init(){const e=o.a.get().getEventIndexingManager();this.crawlerCheckpoints=await e.loadCheckpoints(),console.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners()}registerListeners(){const e=r.a.get();e.on("sync",this.onSync),e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted),e.on("Room.timelineReset",this.onTimelineReset),e.on("Room.redaction",this.onRedaction),e.on("RoomState.events",this.onRoomStateEvent)}removeListeners(){const e=r.a.get();null!==e&&(e.removeListener("sync",this.onSync),e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Room.timelineReset",this.onTimelineReset),e.removeListener("Room.redaction",this.onRedaction),e.removeListener("RoomState.events",this.onRoomStateEvent))}async addInitialCheckpoints(){const e=o.a.get().getEventIndexingManager(),t=r.a.get(),s=t.getRooms().filter(e=>t.isRoomEncrypted(e.roomId));console.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(s.map(async t=>{const s=t.getLiveTimeline().getPaginationToken("b"),n={roomId:t.roomId,token:s,direction:"b",fullCrawl:!0},i={roomId:t.roomId,token:s,direction:"f"};try{n.token&&(await e.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),i.token&&(await e.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i))}catch(e){console.log("EventIndex: Error adding initial checkpoints for room",t.roomId,n,i,e)}}))}isValidEvent(e){const t=["m.room.message","m.room.name","m.room.topic"].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let s=!0,n=!0;if("m.room.message"!==e.getType()||e.isRedacted())"m.room.topic"!==e.getType()||e.isRedacted()?"m.room.name"!==e.getType()||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;s=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&s&&n}eventToJson(e){const t=e.toJSON(),s=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(s.curve25519Key=e.getSenderKey(),s.ed25519Key=e.getClaimedEd25519Key(),s.algorithm=e.getWireContent().algorithm,s.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete s.curve25519Key,delete s.ed25519Key,delete s.algorithm,delete s.forwardingCurve25519KeyChain),s}async addLiveEventToIndex(e){const t=o.a.get().getEventIndexingManager();if(!this.isValidEvent(e))return;const s=this.eventToJson(e),n={displayname:e.sender.rawDisplayName,avatar_url:e.sender.getMxcAvatarUrl()};await t.addEventToIndex(s,n)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const s=t[e];await this.addLiveEventToIndex(s)}}async addRoomCheckpoint(e,t=!1){const s=o.a.get().getEventIndexingManager(),n=r.a.get().getRoom(e);if(!n)return;const i=n.getLiveTimeline(),a=i.getPaginationToken("b");if(!a)return void await this.addEventsFromLiveTimeline(i);const c={roomId:n.roomId,token:a,fullCrawl:t,direction:"b"};console.log("EventIndex: Adding checkpoint",c);try{await s.addCrawlerCheckpoint(c)}catch(e){console.log("EventIndex: Error adding new checkpoint for room",n.roomId,c,e)}this.crawlerCheckpoints.push(c)}async crawlerFunc(){let e=!1;const t=r.a.get(),s=o.a.get().getEventIndexingManager();this._crawler={},this._crawler.cancel=()=>{e=!0};let n=!1;for(;!e;){let i=l.a.getValueAt(u.a.DEVICE,"crawlerSleepTime");if(i=Math.max(i,100),n&&(i=this._crawlerIdleTime),null!==this._currentCheckpoint&&(this._currentCheckpoint=null,this.emitNewCheckpoint()),await Object(c.c)(i),e)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){n=!0;continue}this._currentCheckpoint=o,this.emitNewCheckpoint(),n=!1;const r=t.getEventMapper({preventReEmit:!0});let a;try{a=await t._createMessagesRequest(o.roomId,o.token,this._eventsPerCrawl,o.direction)}catch(e){if(403===e.httpStatus){console.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await s.removeCrawlerCheckpoint(o)}catch(e){console.log("EventIndex: Error removing checkpoint",o,e)}continue}console.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(e){this.crawlerCheckpoints.push(o);break}if(0===a.chunk.length){console.log("EventIndex: Done with the checkpoint",o);try{await s.removeCrawlerCheckpoint(o)}catch(e){console.log("EventIndex: Error removing checkpoint",o,e)}continue}const d=a.chunk.map(r);let h=[];void 0!==a.state&&(h=a.state.map(r));const m={};h.forEach(e=>{e.event.content&&"join"===e.event.content.membership&&(m[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})});const p=[];d.forEach(e=>{(e.isBeingDecrypted()||e.isDecryptionFailure())&&p.push(e._decryptionPromise)}),await Promise.all(p);const g=d.filter(this.isValidEvent),f=d.filter(e=>"m.room.redaction"===e.getType()),_=g.map(e=>{const t=this.eventToJson(e);let s={};t.sender in m&&(s=m[t.sender]);return{event:t,profile:s}});let v;a.end&&(v={roomId:o.roomId,token:a.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<f.length;e++){const t=f[e],n=t.getAssociatedId();n?await s.deleteEvent(n):console.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await s.addHistoricEvents(_,v,o);if(!v){console.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==v.fullCrawl?(console.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await s.removeCrawlerCheckpoint(v)):(!0===e&&console.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(v))}catch(e){console.log("EventIndex: Error durring a crawl",e),this.crawlerCheckpoints.push(o)}}this._crawler=null}startCrawler(){null===this._crawler&&this.crawlerFunc()}stopCrawler(){null!==this._crawler&&this._crawler.cancel()}async close(){const e=o.a.get().getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await e.closeEventIndex()}async search(e){return o.a.get().getEventIndexingManager().searchEventIndex(e)}async loadFileEvents(e,t=10,s=null,n=a.c.BACKWARDS){const i=r.a.get(),c=o.a.get().getEventIndexingManager(),l={roomId:e.roomId,limit:t};let d;s&&(l.fromEvent=s,l.direction=n);try{d=await c.loadFileEvents(l)}catch(e){return console.log("EventIndex: Error getting file events",e),[]}const u=i.getEventMapper();return d.map(t=>{const s=u(t.event),n=new a.k(e.roomId,s.getSender());n.name=t.profile.displayname+" ("+s.getSender()+")";const i=u({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:"m.room.member",event_id:s.getId()+":eventIndex",room_id:s.getRoomId(),sender:s.getSender(),origin_server_ts:s.getTs(),state_key:s.getSender()});return n.events.member=i,s.sender=n,s})}async populateFileTimeline(e,t,s,n=10,i=null,o=a.c.BACKWARDS){const r=await this.loadFileEvents(s,n,i,o);null===i&&(r.reverse(),o=o==a.c.BACKWARDS?a.c.FORWARDS:a.c.BACKWARDS),r.forEach(s=>{e.eventIdToTimeline(s.getId())||e.addEventToTimeline(s,t,o==a.c.BACKWARDS)});let c=!1,l="";return r.length>0&&(l=r[r.length-1].getId(),c=!0),console.log("EventIndex: Populating file panel with",r.length,"events and setting the pagination token to",l),t.setPaginationToken(l,a.c.BACKWARDS),c}paginateTimelineWindow(e,t,s,n){const i=t.getTimelineIndex(s);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(t.extend(s,n))return Promise.resolve(!0);const o=(async(e,t,s,n,i)=>{const o=e._timelineSet,r=t.timeline.getPaginationToken(n),a=await this.populateFileTimeline(o,t.timeline,s,i,r,n);return t.pendingPaginate=null,e.extend(n,i),a})(t,i,e,s,n);return i.pendingPaginate=o,o}async getStats(){return o.a.get().getEventIndexingManager().getStats()}async isRoomIndexed(e){return o.a.get().getEventIndexingManager().isRoomIndexed(e)}currentRoom(){if(null===this._currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=r.a.get();return null!==this._currentCheckpoint?e.getRoom(this._currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,s)=>{t.add(e.roomId)}),null!==this._currentCheckpoint&&t.add(this._currentCheckpoint.roomId);const s=r.a.get();return s.getRooms().filter(e=>s.isRoomEncrypted(e.roomId)).forEach((t,s)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}},function(e,t){e.exports="img/e2e/verified.f3662a7.svg"},,,function(e,t){e.exports="img/element-icons/roomlist/dark-light-mode.0169ba1.svg"},,,,,,,,,,function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.5bb743a.woff2"},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.fb38407.woff2"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return X}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(51),c=s.n(a),l=s(202),d=s(44),u=s(65),h=s(224),m=s(49),p=s(46),g=s(101),f=s(48),_=s(215),v=s(182),y=s(253),b=s(248),E=s(841),S=s(58),w=s(343),C=s(344),R=s(74),k=s(875),I=s(171),O=s(50),T=s(52),x=s(218),N=s(141),j=s(504),P=s(59),D=s(876),A=s(54),U=s(57),M=s(70),L=s(505),F=s(506),B=s(508),V=s(509),K=s(510),q=s(511),G=s(512),W=s(513),H=s(549),$=s(517),z=s(518),Y=s(353);let J=function(e){};const Q="sandbox"in document.createElement("iframe");class X extends r.a.Component{constructor(t,s){super(t,s),i()(this,"dispatcherRef",void 0),i()(this,"roomStoreToken",void 0),i()(this,"rightPanelStoreToken",void 0),i()(this,"showReadReceiptsWatchRef",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"unmounted",!1),i()(this,"permalinkCreators",{}),i()(this,"searchId",void 0),i()(this,"roomView",Object(o.createRef)()),i()(this,"searchResultsPanel",Object(o.createRef)()),i()(this,"messagePanel",void 0),i()(this,"onReadReceiptsChange",()=>{this.setState({showReadReceipts:O.a.getValue("showReadReceipts",this.state.roomId)})}),i()(this,"onRoomViewStoreUpdate",e=>{if(this.unmounted)return;if(!e&&this.state.roomId!==R.a.getRoomId())return;const t=R.a.getRoomId(),s={roomId:t,roomAlias:R.a.getRoomAlias(),roomLoading:R.a.isRoomLoading(),roomLoadError:R.a.getRoomLoadError(),joining:R.a.isJoining(),initialEventId:R.a.getInitialEventId(),isInitialEventHighlighted:R.a.isInitialEventHighlighted(),forwardingEvent:R.a.getForwardingEvent(),shouldPeek:this.state.matrixClientIsReady&&R.a.shouldPeek(),showingPinned:O.a.getValue("PinnedEvents.isOpen",t),showReadReceipts:O.a.getValue("showReadReceipts",t)};if(e||!this.state.shouldPeek||s.shouldPeek||this.context.stopPeeking(),console.log("RVS update:",s.roomId,s.roomAlias,"loading?",s.roomLoading,"joining?",s.joining,"initial?",e,"shouldPeek?",s.shouldPeek),e&&(s.room=this.context.getRoom(s.roomId),s.room&&(s.showApps=this.shouldShowApps(s.room),this.onRoomLoaded(s.room))),null===this.state.roomId&&null!==s.roomId&&!s.initialEventId){const e=k.a.getScrollState(s.roomId);e&&(s.initialEventId=e.focussedEvent,s.initialEventPixelOffset=e.pixelOffset)}this.state.initialEventId!==s.initialEventId&&(s.searchResults=null),this.setState(s),e&&this.setupRoom(s.room,s.roomId,s.joining,s.shouldPeek)}),i()(this,"getRoomId",()=>this.state.room?this.state.room.roomId:this.state.roomId),i()(this,"onWidgetEchoStoreUpdate",()=>{this.setState({showApps:this.shouldShowApps(this.state.room)})}),i()(this,"onLayoutChange",()=>{this.setState({useIRCLayout:O.a.getValue("useIRCLayout")})}),i()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:x.a.getSharedInstance().isOpenForRoom})}),i()(this,"onPageUnload",e=>h.a.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(d.a)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(d.a)("You seem to be in a call, are you sure you want to quit?"):void 0),i()(this,"onNativeKeyDown",e=>{let t=!1;const s=Object(S.d)(e);switch(e.key){case S.a.D:s&&(this.onMuteAudioClick(),t=!0);break;case S.a.E:s&&(this.onMuteVideoClick(),t=!0)}t&&(e.stopPropagation(),e.preventDefault())}),i()(this,"onReactKeyDown",e=>{let t=!1;switch(e.key){case S.a.ESCAPE:e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||(this.messagePanel.forgetReadMarker(),this.jumpToLiveTimeline(),t=!0);break;case S.a.PAGE_UP:e.altKey||e.ctrlKey||!e.shiftKey||e.metaKey||(this.jumpToReadMarker(),t=!0);break;case S.a.U.toUpperCase():Object(S.c)(e)&&e.shiftKey&&(f.a.dispatch({action:"upload_file"}),t=!0)}t&&(e.stopPropagation(),e.preventDefault())}),i()(this,"onAction",t=>{switch(t.action){case"message_send_failed":case"message_sent":this.checkIfAlone(this.state.room);break;case"post_sticker_message":this.injectSticker(t.data.content.url,t.data.content.info,t.data.description||t.data.name);break;case"picture_snapshot":h.a.sharedInstance().sendContentListToRoom([t.file],this.state.room.roomId,this.context);break;case"notifier_enabled":case"upload_started":case"upload_finished":case"upload_canceled":this.forceUpdate();break;case"call_state":{if(!t.room_id)return;const e=this.getCallForRoom();let s="ended";e&&(s=e.call_state),this.updateConfCallNotification(),this.setState({callState:s});break}case"appsDrawer":this.setState({showApps:t.show});break;case"reply_to_event":this.state.searchResults&&t.event.getRoomId()===this.state.roomId&&!this.unmounted&&this.onCancelSearchClick();break;case"quote":if(this.state.searchResults){const s=t.event.getRoomId();s===this.state.roomId&&this.onCancelSearchClick(),e(()=>{f.a.dispatch({action:"view_room",room_id:s,deferred_action:t})})}break;case"sync_state":this.state.matrixClientIsReady||this.setState({matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},()=>{this.onRoomViewStoreUpdate(!0)})}}),i()(this,"onRoomTimeline",(e,t,s,n,i)=>{this.unmounted||t&&this.state.room&&t.roomId==this.state.room.roomId&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&this.updateE2EStatus(t),!s&&i&&i.liveEvent&&(this.state.joining||e.getSender()!==this.context.credentials.userId&&(!this.state.searchResults&&this.state.atEndOfLiveTimeline||Object(l.a)(e)||this.setState((e,t)=>({numUnreadMessages:e.numUnreadMessages+1})))))}),i()(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),i()(this,"onRoomRecoveryReminderDontAskAgain",()=>{this.forceUpdate()}),i()(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),i()(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),i()(this,"onRoomLoaded",e=>{this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e)}),i()(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&this.setState({room:e},()=>{this.onRoomLoaded(e)})}),i()(this,"onDeviceVerificationChanged",(e,t)=>{const s=this.state.room;s.currentState.getMember(e)&&this.updateE2EStatus(s)}),i()(this,"onUserVerificationChanged",(e,t)=>{const s=this.state.room;s&&s.currentState.getMember(e)&&this.updateE2EStatus(s)}),i()(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),i()(this,"onAccountData",e=>{const t=e.getType();"org.matrix.preview_urls"!==t&&"im.vector.web.settings"!==t||!this.state.room||this.updatePreviewUrlVisibility(this.state.room)}),i()(this,"onRoomAccountData",(e,t)=>{if(t.roomId==this.state.roomId){const s=e.getType();if("org.matrix.room.color_scheme"===s){const t=e.getContent();console.log("Tinter.tint from onRoomAccountData"),_.a.tint(t.primary_color,t.secondary_color)}else"org.matrix.room.preview_urls"!==s&&"im.vector.web.settings"!==s||this.updatePreviewUrlVisibility(t)}}),i()(this,"onRoomStateEvents",(e,t)=>{this.state.room&&this.state.room.roomId===t.roomId&&this.updatePermissions(this.state.room)}),i()(this,"onRoomStateMember",(e,t,s)=>{this.state.room&&s.roomId===this.state.room.roomId&&this.updateRoomMembers(s)}),i()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),i()(this,"updateRoomMembers",Object(v.a)(e=>{this.updateConfCallNotification(),this.updateDMState();let t=0;e&&"invite"===e.membership&&0===this.state.room.getInvitedMemberCount()&&(t=1),this.checkIfAlone(this.state.room,t),this.updateE2EStatus(this.state.room)},500)),i()(this,"onSearchResultsFillRequest",e=>{if(!e)return Promise.resolve(!1);if(this.state.searchResults.next_batch){J("requesting more search results");const e=Object(E.b)(this.state.searchResults);return this.handleSearchResult(e)}return J("no more search results"),Promise.resolve(!1)}),i()(this,"onInviteButtonClick",()=>{f.a.dispatch({action:"view_invite",roomId:this.state.room.roomId}),this.setState({isAlone:!1})}),i()(this,"onStopAloneWarningClick",()=>{localStorage&&localStorage.setItem("mx_user_alone_warned_"+this.state.room.roomId,String(!0)),this.setState({isAlone:!1})}),i()(this,"onJoinButtonClicked",()=>{this.context&&this.context.isGuest()?(f.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_room",room_id:this.getRoomId()}}),f.a.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{const e=this.props.thirdPartyInvite?this.props.thirdPartyInvite.inviteSignUrl:void 0;return f.a.dispatch({action:"join_room",opts:{inviteSignUrl:e,viaServers:this.props.viaServers}}),Promise.resolve()})}),i()(this,"onMessageListScroll",e=>{this.messagePanel.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),i()(this,"onDragOver",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="none";const t=[...e.dataTransfer.items];if(t.length>=1){t.every((function(e){return"file"==e.kind}))&&(this.setState({draggingFile:!0}),e.dataTransfer.dropEffect="copy")}}),i()(this,"onDrop",e=>{e.stopPropagation(),e.preventDefault(),h.a.sharedInstance().sendContentListToRoom(e.dataTransfer.files,this.state.room.roomId,this.context),this.setState({draggingFile:!1}),f.a.fire(A.a.FocusComposer)}),i()(this,"onDragLeaveOrEnd",e=>{e.stopPropagation(),e.preventDefault(),this.setState({draggingFile:!1})}),i()(this,"onSearch",(e,t)=>{let s;this.setState({searchTerm:e,searchScope:t,searchResults:{},searchHighlights:[]}),this.searchResultsPanel.current&&this.searchResultsPanel.current.resetScrollState(),this.searchId=(new Date).getTime(),"Room"===t&&(s=this.state.room.roomId),J("sending search request");const n=Object(E.a)(e,s);this.handleSearchResult(n)}),i()(this,"onPinnedClick",()=>{const e=!this.state.showingPinned,t=this.state.room.roomId;this.setState({showingPinned:e,searching:!1}),O.a.setValue("PinnedEvents.isOpen",t,U.a.ROOM_DEVICE,e)}),i()(this,"onSettingsClick",()=>{f.a.dispatch({action:A.a.SetRightPanelPhase,phase:M.b.RoomSummary})}),i()(this,"onCancelClick",()=>{console.log("updateTint from onCancelClick"),this.updateTint(),this.state.forwardingEvent&&f.a.dispatch({action:"forward_event",event:null}),f.a.fire(A.a.FocusComposer)}),i()(this,"onLeaveClick",()=>{f.a.dispatch({action:"leave_room",room_id:this.state.room.roomId})}),i()(this,"onForgetClick",()=>{f.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})}),i()(this,"onRejectButtonClicked",e=>{this.setState({rejecting:!0}),this.context.leave(this.state.roomId).then(()=>{f.a.dispatch({action:"view_next_room"}),this.setState({rejecting:!1})},e=>{console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(d.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})})}),i()(this,"onRejectAndIgnoreClick",async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.getUserId()).events.member,t=this.context.getIgnoredUsers();t.push(e.getSender()),await this.context.setIgnoredUsers(t),await this.context.leave(this.state.roomId),f.a.dispatch({action:"view_next_room"}),this.setState({rejecting:!1})}catch(e){console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(d.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}}),i()(this,"onRejectThreepidInviteButtonClicked",e=>{f.a.fire(A.a.ViewRoomDirectory)}),i()(this,"onSearchClick",()=>{this.setState({searching:!this.state.searching,showingPinned:!1})}),i()(this,"onCancelSearchClick",()=>{this.setState({searching:!1,searchResults:null})}),i()(this,"jumpToLiveTimeline",()=>{this.messagePanel.jumpToLiveTimeline(),f.a.fire(A.a.FocusComposer)}),i()(this,"jumpToReadMarker",()=>{this.messagePanel.jumpToReadMarker()}),i()(this,"forgetReadMarker",e=>{e.stopPropagation(),this.messagePanel.forgetReadMarker()}),i()(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),i()(this,"onResize",()=>{let e=window.innerHeight-261;e<50&&(e=50),this.setState({auxPanelMaxHeight:e})}),i()(this,"onFullscreenClick",()=>{f.a.dispatch({action:"video_fullscreen",fullscreen:!0},!0)}),i()(this,"onMuteAudioClick",()=>{const e=this.getCallForRoom();if(!e)return;const t=!e.isMicrophoneMuted();e.setMicrophoneMuted(t),this.forceUpdate()}),i()(this,"onMuteVideoClick",()=>{const e=this.getCallForRoom();if(!e)return;const t=!e.isLocalVideoMuted();e.setLocalVideoMuted(t),this.forceUpdate()}),i()(this,"onStatusBarVisible",()=>{this.unmounted||this.setState({statusBarVisible:!0})}),i()(this,"onStatusBarHidden",()=>{this.unmounted||this.setState({statusBarVisible:!1})}),i()(this,"handleScrollKey",e=>{let t;this.searchResultsPanel.current?t=this.searchResultsPanel.current:this.messagePanel&&(t=this.messagePanel),t&&t.handleScrollKey(e)}),i()(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e,e&&(console.log("updateTint from RoomView.gatherTimelinePanelRef"),this.updateTint())}),i()(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&f.a.dispatch({action:"view_room",room_id:e.roomId})});const n=this.context.hasLazyLoadMembersEnabled();this.state={roomId:null,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!n,numUnreadMessages:0,draggingFile:!1,searching:!1,searchResults:null,callState:null,guestsCanJoin:!1,canPeek:!1,showApps:!1,isAlone:!1,isPeeking:!1,showingPinned:!1,showReadReceipts:!0,showRightPanel:x.a.getSharedInstance().isOpenForRoom,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,useIRCLayout:O.a.getValue("useIRCLayout"),matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},this.dispatcherRef=f.a.register(this.onAction),this.context.on("Room",this.onRoom),this.context.on("Room.timeline",this.onRoomTimeline),this.context.on("Room.name",this.onRoomName),this.context.on("Room.accountData",this.onRoomAccountData),this.context.on("RoomState.events",this.onRoomStateEvents),this.context.on("RoomState.members",this.onRoomStateMember),this.context.on("Room.myMembership",this.onMyMembership),this.context.on("accountData",this.onAccountData),this.context.on("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.on("userTrustStatusChanged",this.onUserVerificationChanged),this.context.on("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.roomStoreToken=R.a.addListener(this.onRoomViewStoreUpdate),this.rightPanelStoreToken=x.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),I.a.on("update",this.onWidgetEchoStoreUpdate),this.showReadReceiptsWatchRef=O.a.watchSetting("showReadReceipts",null,this.onReadReceiptsChange),this.layoutWatcherRef=O.a.watchSetting("useIRCLayout",null,this.onLayoutChange)}UNSAFE_componentWillMount(){this.onRoomViewStoreUpdate(!0)}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new u.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,s,n){!s&&t&&(this.props.autoJoin?this.onJoinButtonClicked():!e&&n?(console.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),this.context.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}})):e&&(this.context.stopPeeking(),this.setState({isPeeking:!1})))}shouldShowApps(e){if(!Q)return!1;return"false"===localStorage.getItem(e.roomId+"_hide_widget_drawer")}componentDidMount(){const e=this.getCallForRoom(),t=e?e.call_state:"ended";this.setState({callState:t}),this.updateConfCallNotification(),window.addEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResized",this.onResize),this.onResize(),document.addEventListener("keydown",this.onNativeKeyDown)}shouldComponentUpdate(e,t){return!y.a(this.props,e)||!y.a(this.state,t)}componentDidUpdate(){if(this.roomView.current){const e=this.roomView.current;e.ondrop||(e.addEventListener("drop",this.onDrop),e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragleave",this.onDragLeaveOrEnd),e.addEventListener("dragend",this.onDragLeaveOrEnd))}this.messagePanel&&!this.state.atEndOfLiveTimelineInit&&this.setState({atEndOfLiveTimelineInit:!0,atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){if(this.unmounted=!0,this.state.roomId&&k.a.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek&&this.context.stopPeeking(),this.stopAllPermalinkCreators(),this.roomView.current){const e=this.roomView.current;e.removeEventListener("drop",this.onDrop),e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragleave",this.onDragLeaveOrEnd),e.removeEventListener("dragend",this.onDragLeaveOrEnd)}f.a.unregister(this.dispatcherRef),this.context&&(this.context.removeListener("Room",this.onRoom),this.context.removeListener("Room.timeline",this.onRoomTimeline),this.context.removeListener("Room.name",this.onRoomName),this.context.removeListener("Room.accountData",this.onRoomAccountData),this.context.removeListener("RoomState.events",this.onRoomStateEvents),this.context.removeListener("Room.myMembership",this.onMyMembership),this.context.removeListener("RoomState.members",this.onRoomStateMember),this.context.removeListener("accountData",this.onAccountData),this.context.removeListener("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.context.removeListener("crossSigning.keysChanged",this.onCrossSigningKeysChanged)),window.removeEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResized",this.onResize),document.removeEventListener("keydown",this.onNativeKeyDown),this.roomStoreToken&&this.roomStoreToken.remove(),this.rightPanelStoreToken&&this.rightPanelStoreToken.remove(),I.a.removeListener("update",this.onWidgetEchoStoreUpdate),this.showReadReceiptsWatchRef&&O.a.unwatchSetting(this.showReadReceiptsWatchRef),this.updateRoomMembers.cancelPendingCall(),O.a.unwatchSetting(this.layoutWatcherRef)}async calculateRecommendedVersion(e){this.setState({upgradeRecommendation:await e.getRecommendedVersion()})}async loadMembersIfJoined(e){if(this.context.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const s=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;console.error(s),console.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents("m.room.guest_access","");t&&"can_join"===t.getContent().guest_access&&this.setState({guestsCanJoin:!0});const s=e.currentState.getStateEvents("m.room.history_visibility","");s&&"world_readable"===s.getContent().history_visibility&&this.setState({canPeek:!0})}updatePreviewUrlVisibility({roomId:e}){const t=this.context.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:O.a.getValue(t,e)})}async updateE2EStatus(e){this.context.isRoomEncrypted(e.roomId)&&(this.context.isCryptoEnabled()?this.setState({e2eStatus:await Object(D.b)(this.context,e)}):this.setState({e2eStatus:D.a.Warning}))}updateTint(){const e=this.state.room;if(!e)return;console.log("Tinter.tint from updateTint");const t=O.a.getValue("roomColor",e.roomId);_.a.tint(t.primary_color,t.secondary_color)}updatePermissions(e){if(e){const t=this.context.getUserId(),s="join"===e.getMyMembership()&&e.currentState.maySendEvent("m.reaction",t),n=e.maySendMessage();this.setState({canReact:s,canReply:n})}}checkIfAlone(e,t){let s=!1;if(localStorage&&(s=Boolean(localStorage.getItem("mx_user_alone_warned_"+this.state.room.roomId))),s)return void(this.state.isAlone&&this.setState({isAlone:!1}));let n=e.getJoinedMemberCount()+e.getInvitedMemberCount();t&&(n+=t),this.setState({isAlone:1===n})}updateConfCallNotification(){const e=this.state.room;if(!e||!this.props.ConferenceHandler)return;const t=e.getMember(this.props.ConferenceHandler.getConferenceUserIdForRoom(e.roomId));if(!t)return;const s=this.props.ConferenceHandler.getConferenceCallForRoom(t.roomId);this.setState({displayConfCallNotification:(!s||"ended"===s.call_state)&&"join"===t.membership})}updateDMState(){const e=this.state.room;if("join"!=e.getMyMembership())return;const t=e.getDMInviter();t&&b.c(e.roomId,t)}injectSticker(e,t,s){this.context.isGuest()?f.a.dispatch({action:"require_registration"}):h.a.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,t,s,this.context).then(void 0,e=>{e.name})}handleSearchResult(e){const t=this.searchId;return this.setState({searchInProgress:!0}),e.then(e=>{if(J("search complete"),this.unmounted||!this.state.searching||this.searchId!=t)return void console.error("Discarding stale search results");let s=e.highlights;s.indexOf(this.state.searchTerm)<0&&(s=s.concat(this.state.searchTerm)),s=s.sort((function(e,t){return t.length-e.length})),this.setState({searchHighlights:s,searchResults:e})},e=>{const t=p.getComponent("dialogs.ErrorDialog");console.error("Search failed",e),m.a.createTrackedDialog("Search failed","",t,{title:Object(d.a)("Search failed"),description:e&&e.message?e.message:Object(d.a)("Server may be unavailable, overloaded, or search timed out :(")})}).finally(()=>{this.setState({searchInProgress:!1})})}getSearchResultTiles(){const e=p.getComponent("rooms.SearchResultTile"),t=p.getComponent("elements.Spinner"),s=[];this.state.searchInProgress&&s.push(r.a.createElement("li",{key:"search-spinner"},r.a.createElement(t,null))),this.state.searchResults.next_batch||(0==this.state.searchResults.results.length?s.push(r.a.createElement("li",{key:"search-top-marker"},r.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(d.a)("No results")))):s.push(r.a.createElement("li",{key:"search-top-marker"},r.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(d.a)("No more results")))));const n=()=>{const e=this.searchResultsPanel.current;e&&e.checkScroll()};let i;for(let t=this.state.searchResults.results.length-1;t>=0;t--){const o=this.state.searchResults.results[t],a=o.context.getEvent(),c=a.getRoomId(),l=this.context.getRoom(c);if(!l){console.log("Hiding search result from an unknown room",c);continue}if(!Object(N.b)(a))continue;"All"===this.state.searchScope&&c!==i&&(s.push(r.a.createElement("li",{key:a.getId()+"-room"},r.a.createElement("h2",null,Object(d.a)("Room"),": ",l.name))),i=c);const u="#/room/"+c+"/"+a.getId();s.push(r.a.createElement(e,{key:a.getId(),searchResult:o,searchHighlights:this.state.searchHighlights,resultLink:u,permalinkCreator:this.getPermalinkCreatorForRoom(l),onHeightChanged:n}))}return s}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?g.a.getCallForRoom(this.state.room.roomId):null}getOldRoom(){const e=this.state.room.currentState.getStateEvents("m.room.create","");return e&&e.getContent().predecessor?this.context.getRoom(e.getContent().predecessor.room_id):null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount("highlight"):0}render(){if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return r.a.createElement("div",{className:"mx_RoomView"},r.a.createElement(B.a,null,r.a.createElement(V.a,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData})))}{let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);let t=void 0;this.props.thirdPartyInvite&&(t=this.props.thirdPartyInvite.invitedEmail);const s=this.state.roomAlias;return r.a.createElement("div",{className:"mx_RoomView"},r.a.createElement(B.a,null,r.a.createElement(V.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:s,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:this.props.thirdPartyInvite?this.props.thirdPartyInvite.inviteSignUrl:null,room:this.state.room})))}}const e=this.state.room.getMyMembership();if("invite"==e){if(this.state.joining||this.state.rejecting)return r.a.createElement(B.a,null,r.a.createElement(V.a,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting}));{const e=this.context.credentials.userId,t=this.state.room.getMember(e),s=t?t.events.member:null;let n=Object(d.a)("Unknown");return s&&(n=s.sender?s.sender.name:s.getSender()),r.a.createElement("div",{className:"mx_RoomView"},r.a.createElement(B.a,null,r.a.createElement(V.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room})))}}const t=this.getCallForRoom();let n=!1;t&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(n=!0);const i=c()({mx_RoomView_scrollheader:!0});let o,a=!0;if(h.a.sharedInstance().getCurrentUploads().length>0){const e=p.getComponent("structures.UploadBar");o=r.a.createElement(e,{room:this.state.room})}else if(!this.state.searchResults){const t=p.getComponent("structures.RoomStatusBar");a=this.state.statusBarVisible,o=r.a.createElement(t,{room:this.state.room,sentMessageAndIsAlone:this.state.isAlone,hasActiveCall:n,isPeeking:"join"!==e,onInviteClick:this.onInviteButtonClick,onStopWarningClick:this.onStopAloneWarningClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden})}const l=this.state.upgradeRecommendation,u=l&&l.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.credentials.userId),m=this.context.isCryptoEnabled()&&O.a.getValue("showRoomRecoveryReminder")&&this.context.isRoomEncrypted(this.state.room.roomId)&&!1===this.context.getKeyBackupEnabled(),g=this.getHiddenHighlightCount();let f,_=null,v=!1,y=!1;if(this.state.forwardingEvent)_=r.a.createElement(K.a,{onCancelClick:this.onCancelClick});else if(this.state.searching)v=!0,_=r.a.createElement(q.a,{searchInProgress:this.state.searchInProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch});else if(u)_=r.a.createElement(G.a,{room:this.state.room,recommendation:l}),v=!0;else if(m)_=r.a.createElement(W.a,{onDontAskAgainSet:this.onRoomRecoveryReminderDontAskAgain}),v=!0;else if(this.state.showingPinned)v=!0,_=r.a.createElement(H.a,{room:this.state.room,onCancelClick:this.onPinnedClick});else if("join"!==e){let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);let t=void 0;if(this.props.thirdPartyInvite&&(t=this.props.thirdPartyInvite.invitedEmail),v=!0,f=r.a.createElement(V.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room}),!this.state.canPeek)return r.a.createElement("div",{className:"mx_RoomView"},f);y=!0}else g>0&&(_=r.a.createElement(T.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(d.a)("You have %(count)s unread notifications in a prior version of this room.",{count:g})));const b=r.a.createElement($.a,{room:this.state.room,fullHeight:!1,userId:this.context.credentials.userId,conferenceHandler:this.props.ConferenceHandler,draggingFile:this.state.draggingFile,displayConfCallNotification:this.state.displayConfCallNotification,maxHeight:this.state.auxPanelMaxHeight,showApps:this.state.showApps,hideAppsDrawer:!1,onResize:this.onResize,resizeNotifier:this.props.resizeNotifier},_);let E,S;if("join"===e&&!this.state.searchResults){const e=p.getComponent("rooms.MessageComposer");E=r.a.createElement(e,{room:this.state.room,callState:this.state.callState,disabled:this.props.disabled,showApps:this.state.showApps,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room)})}if(this.state.searchResults&&(S={searchTerm:this.state.searchTerm,searchScope:this.state.searchScope,searchCount:this.state.searchResults.count}),n){let e,n;"video"===t.type&&(e=r.a.createElement("div",{className:"mx_RoomView_voipButton",onClick:this.onFullscreenClick,title:Object(d.a)("Fill screen")},r.a.createElement(Y.a,{src:s(879),width:"29",height:"22",style:{marginTop:1,marginRight:4}})),n=r.a.createElement("div",{className:"mx_RoomView_voipButton",onClick:this.onMuteVideoClick},r.a.createElement(Y.a,{src:t.isLocalVideoMuted()?s(880):s(881),alt:t.isLocalVideoMuted()?Object(d.a)("Click to unmute video"):Object(d.a)("Click to mute video"),width:"",height:"27"})));const i=r.a.createElement("div",{className:"mx_RoomView_voipButton",onClick:this.onMuteAudioClick},r.a.createElement(Y.a,{src:t.isMicrophoneMuted()?s(882):s(883),alt:t.isMicrophoneMuted()?Object(d.a)("Click to unmute audio"):Object(d.a)("Click to mute audio"),width:"21",height:"26"}));o=r.a.createElement("div",{className:"mx_RoomView_callStatusBar"},i,n,e,o)}let R,k=!1;this.state.searchResults&&(R=void 0===this.state.searchResults.results?r.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"}):r.a.createElement(L.a,{ref:this.searchResultsPanel,className:"mx_RoomView_messagePanel mx_RoomView_searchResultsPanel mx_GroupLayout",onFillRequest:this.onSearchResultsFillRequest,resizeNotifier:this.props.resizeNotifier},r.a.createElement("li",{className:i}),this.getSearchResultTiles()),k=!0);const I=this.state.isInitialEventHighlighted;let x=null;this.state.forwardingEvent?x=this.state.forwardingEvent.getId():I&&(x=this.state.initialEventId);const N=c()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.useIRCLayout,mx_GroupLayout:!this.state.useIRCLayout}),P=r.a.createElement(F.a,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,manageReadMarkers:!this.state.isPeeking,hidden:k,highlightedEventId:x,eventId:this.state.initialEventId,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:N,membersLoaded:this.state.membersLoaded,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),resizeNotifier:this.props.resizeNotifier,showReactions:!0,useIRCLayout:this.state.useIRCLayout});let D,A=null;if(this.state.showTopUnreadMessagesBar&&!this.state.searchResults){const e=p.getComponent("rooms.TopUnreadMessagesBar");A=r.a.createElement(e,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})}if(!this.state.atEndOfLiveTimeline&&!this.state.searchResults){const e=p.getComponent("rooms.JumpToBottomButton");D=r.a.createElement(e,{highlight:this.state.room.getUnreadNotificationCount("highlight")>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline})}const U=c()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:a}),M=c()("mx_RoomView_body","mx_fadable",{mx_fadable_faded:this.props.disabled}),J=!y&&this.state.room&&this.state.showRightPanel?r.a.createElement(C.a,{room:this.state.room,resizeNotifier:this.props.resizeNotifier}):null,Q=c()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),X=c()("mx_RoomView",{mx_RoomView_inCall:n});return r.a.createElement(j.a.Provider,{value:this.state},r.a.createElement("main",{className:X,ref:this.roomView,onKeyDown:this.onReactKeyDown},r.a.createElement(B.a,null,r.a.createElement(z.a,{room:this.state.room,searchInfo:S,oobData:this.props.oobData,inRoom:"join"===e,onSearchClick:this.onSearchClick,onSettingsClick:this.onSettingsClick,onPinnedClick:this.onPinnedClick,onCancelClick:_&&!v?this.onCancelClick:null,onForgetClick:"leave"===e?this.onForgetClick:null,onLeaveClick:"join"===e?this.onLeaveClick:null,e2eStatus:this.state.e2eStatus}),r.a.createElement(w.a,{panel:J,resizeNotifier:this.props.resizeNotifier},r.a.createElement("div",{className:M},b,r.a.createElement("div",{className:Q},A,D,P,R),r.a.createElement("div",{className:U},r.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},r.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),o)),f,E)))))}}i()(X,"contextType",P.a)}).call(this,s(136).setImmediate)},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f}));var n=s(177),i=s(47);async function o(e,t){const s=i.a.get(),n={limit:10};void 0!==t&&(n.rooms=[t]);const o={search_categories:{room_events:{search_term:e,filter:n,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await s.search({body:o}),query:o}}async function r(e,t){const s=i.a.get(),n=await o(e,t),r={_query:n.query,results:[],highlights:[]};return s._processRoomEventsSearch(r,n.response)}function a(e,t){const s=e.result,n=t.result;return s.origin_server_ts>n.origin_server_ts?-1:s.origin_server_ts<n.origin_server_ts?1:0}async function c(e,t,s=!0){const i=n.a.get(),o={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(o.room_id=t);const r=await i.search(o);o.next_batch=r.next_batch;return{response:r,query:o}}function l(e,t){try{const s=e.results[e.results.length-1].result,n=t.results[t.results.length-1].result;return s.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function d(e,t,s,n){const i=s.concat(n).sort(a);t.results=i.slice(0,10),e.cachedEvents=i.slice(10)}function u(e,t,s){const n=function(e,t,s){const n={},i=e.cachedEvents;let o=e.oldestEventFrom;return n.highlights=e.highlights,t&&s?(l(t,s)<0&&(o="local"),d(e,n,t.results,s.results),n.highlights=t.highlights.concat(s.highlights)):t?(l(t,i)<0&&(o="local"),d(e,n,t.results,i)):s?(l(s,i)<0&&(o="server"),d(e,n,s.results,i)):(n.results=i,e.cachedEvents=[]),e.oldestEventFrom=o,n}(e,t,s);return e.count?n.count=e.count:n.count=t.count+s.count,t&&(e.seshatQuery.next_batch=t.next_batch),s&&(e.serverSideNextBatch=s.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function h(e){for(let t=0;t<e.length;t++){const s=e[t].context.getTimeline();for(let e=0;e<s.length;e++){const t=s[e];t.event.curve25519Key&&(t.makeEncrypted("m.room.encrypted",{algorithm:t.event.algorithm},t.event.curve25519Key,t.event.ed25519Key),t._forwardingCurve25519KeyChain=t.event.forwardingCurve25519KeyChain,delete t.event.curve25519Key,delete t.event.ed25519Key,delete t.event.algorithm,delete t.event.forwardingCurve25519KeyChain)}}}function m(e,t){let s;return s=void 0!==t?i.a.get().isRoomEncrypted(t)?async function(e,t){const s={results:[],highlights:[]};if(""===e)return s;const n=await c(e,t);s.seshatQuery=n.query;const o={search_categories:{room_events:n.response}},r=i.a.get()._processRoomEventsSearch(s,o);return h(r.results),r}(e,t):r(e,t):async function(e){const t=i.a.get(),s=o(e),n=c(e);await Promise.all([s,n]);const r=await n,a=await s,l=a.query,d=a.response,m=r.query,p=r.response,g={seshatQuery:m,_query:l,serverSideNextBatch:d.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},f={search_categories:{room_events:u(g,p,d.search_categories.room_events)}},_=t._processRoomEventsSearch(g,f);return h(_.results),_}(e),s}function p(e){const t=i.a.get(),s=e.seshatQuery,o=e._query;if(s){if(o){const t=async function(e){const t=n.a.get(),s=i.a.get(),o=e.seshatQuery,r=e.oldestEventFrom;let a,c,l;if(!o.next_batch||e.serverSideNextBatch&&"server"!==r||(a=await t.search(o)),e.serverSideNextBatch&&("local"===r||!o.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};c=await s.search(t)}c&&(l=c.search_categories.room_events);const d={search_categories:{room_events:u(e,a,l)}},m=e.results.length,p=s._processRoomEventsSearch(e,d),g=p.results.length-m;return h(p.results.slice(Math.max(p.results.length-g,0))),e.pendingRequest=null,p}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=n.a.get(),s=e.seshatQuery,o=await t.search(s);e.seshatQuery.next_batch=o.next_batch;const r=o.results.length,a={search_categories:{room_events:o}},c=i.a.get()._processRoomEventsSearch(e,a);return h(c.results.slice(Math.max(c.results.length-r,0))),e.pendingRequest=null,c}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}function g(e){const t=n.a.get(),s=i.a.get();return e.pendingRequest?e.pendingRequest:null===t?s.backPaginateRoomEventsSearch(e):p(e)}function f(e,t){return null===n.a.get()?r(e,t):m(e,t)}},,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/facebook.d547f79.png"},function(e,t){e.exports="img/social/twitter-2.6517b36.png"},function(e,t){e.exports="img/social/linkedin.ab157f6.png"},function(e,t){e.exports="img/social/reddit.eeab8e6.png"},function(e,t){e.exports="img/social/email-1.1134895.png"},function(e,t){e.exports="img/element-icons/room/default_app.313ebe9.svg"},function(e,t){e.exports="img/element-icons/room/default_cal.8c4a54e.svg"},function(e,t){e.exports="img/element-icons/room/default_doc.eda1b1c.svg"},function(e,t){e.exports="img/element-icons/room/default_clock.8bca3f6.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return u}));var n=s(1159),i=s(873),o=s(49),r=s(47),a=s(50),c=s(501),l=s(76),d=s(7);e.mxFromWidgetMessaging||(e.mxFromWidgetMessaging=new n.a,e.mxFromWidgetMessaging.start()),e.mxToWidgetMessaging||(e.mxToWidgetMessaging=new i.a,e.mxToWidgetMessaging.start());class u{constructor(t,s,n,i,o){this.widgetId=t,this.wurl=s,this.renderedUrl=n,this.isUserWidget=i,this.target=o,this.fromWidget=e.mxFromWidgetMessaging,this.toWidget=e.mxToWidgetMessaging,this._onOpenIdRequest=this._onOpenIdRequest.bind(this),this.start()}messageToWidget(e){return e.widgetId=this.widgetId,this.toWidget.exec(e,this.target).then(e=>{if(void 0===e.response)throw new Error("Missing 'response' field");if(e.response&&e.response.error){const t=e.response.error,s=String(t.message?t.message:"An error was returned");throw t._error&&console.error(t._error),new Error(s)}return e.response})}flagReadyToContinue(){return this.messageToWidget({api:"toWidget",action:d.b.ClientReady})}terminate(){return this.messageToWidget({api:"toWidget",action:d.b.Terminate})}getScreenshot(){return console.log("Requesting screenshot for",this.widgetId),this.messageToWidget({api:"toWidget",action:"screenshot"}).catch(e=>new Error("Failed to get screenshot: "+e.message)).then(e=>e.screenshot)}getCapabilities(){return console.log("Requesting capabilities for",this.widgetId),this.messageToWidget({api:"toWidget",action:"capabilities"}).then(e=>(console.log("Got capabilities for",this.widgetId,e.capabilities),e.capabilities))}sendVisibility(e){return this.messageToWidget({api:"toWidget",action:"visibility",visible:e}).catch(e=>{console.error("Failed to send visibility: ",e)})}start(){this.fromWidget.addEndpoint(this.widgetId,this.renderedUrl),this.fromWidget.addListener("get_openid",this._onOpenIdRequest)}stop(){this.fromWidget.removeEndpoint(this.widgetId,this.renderedUrl),this.fromWidget.removeListener("get_openid",this._onOpenIdRequest)}async _onOpenIdRequest(e,t){if(e.widgetId!==this.widgetId)return;const s=l.a.getWidgetSecurityKey(this.widgetId,this.wurl,this.isUserWidget),n=a.a.getValue("widgetOpenIDPermissions");if(n.deny&&n.deny.includes(s))this.fromWidget.sendResponse(t,{state:"blocked"});else{if(n.allow&&n.allow.includes(s)){const e={state:"allowed"},s=await r.a.get().getOpenIdToken();return Object.assign(e,s),void this.fromWidget.sendResponse(t,e)}this.fromWidget.sendResponse(t,{state:"request"}),o.a.createTrackedDialog("OpenID widget permissions","",c.a,{widgetUrl:this.wurl,widgetId:this.widgetId,isUserWidget:this.isUserWidget,onFinished:async t=>{const s={success:t,state:t?"allowed":"blocked",original_request_id:e.requestId};if(t){const e=await r.a.get().getOpenIdToken();Object.assign(s,e)}this.messageToWidget({api:"toWidget",action:"openid_credentials",data:s}).catch(e=>{console.error("Failed to send OpenID credentials: ",e)})}})}}}}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this._timeoutMs=e||5e3,this._counter=0,this._requestMap={},this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.onPostMessage=this.onPostMessage.bind(this)}start(){window.addEventListener("message",this.onPostMessage)}stop(){window.removeEventListener("message",this.onPostMessage)}onPostMessage(e){const t=e.data;if(void 0===t.response)return;const s=this._requestMap[t.requestId];s&&(delete this._requestMap[t.requestId],s.resolve(t))}exec(e,t,s){return t=t||window.parent,s=s||"*",this._counter+=1,e.requestId=Date.now()+"-"+Math.random().toString(36)+"-"+this._counter,new Promise((n,i)=>{this._requestMap[e.requestId]={resolve:n,reject:i},t.postMessage(e,s),this._timeoutMs>0&&setTimeout(()=>{this._requestMap[e.requestId]&&(console.error("postMessage request timed out. Sent object: "+JSON.stringify(e),this._requestMap),this._requestMap[e.requestId].reject(new Error("Timed out")),delete this._requestMap[e.requestId])},this._timeoutMs)})}}},,function(e,t,s){"use strict";(function(e){class s{constructor(){this._scrollStateMap={}}getScrollState(e){return this._scrollStateMap[e]}setScrollState(e,t){this._scrollStateMap[e]=t}}void 0===e.mx_RoomScrollStateStore&&(e.mx_RoomScrollStateStore=new s),t.a=e.mx_RoomScrollStateStore}).call(this,s(6))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(90);let i;async function o(e,t){const s=(await t.getEncryptionTargetMembers()).map(({userId:e})=>e),o=!!n.a.shared().getUserIdForRoomId(t.roomId),r=[],a=[];s.filter(t=>t!==e.getUserId()).forEach(t=>{(e.checkUserTrust(t).isCrossSigningVerified()?r:a).push(t)});for(const t of a)if(e.checkUserTrust(t).wasCrossSigningVerified())return i.Warning;const c=r.length>0&&!o&&2!==s.length||1===s.length?[...r,e.getUserId()]:r;for(const t of c){if(e.getStoredDevicesForUser(t).some(({deviceId:s})=>!e.checkDeviceTrust(t,s).isVerified()))return i.Warning}return 0===a.length?i.Verified:i.Normal}!function(e){e.Warning="warning",e.Verified="verified",e.Normal="normal"}(i||(i={}))},function(e,t){e.exports="img/cancel-red.4f46f99.svg"},function(e,t){e.exports="img/upload-big.7487f87.svg"},function(e,t){e.exports="img/element-icons/call/fullscreen.1e28952.svg"},function(e,t){e.exports="img/element-icons/call/video-muted.fe60dbc.svg"},function(e,t){e.exports="img/element-icons/call/video-call.60e09e9.svg"},function(e,t){e.exports="img/element-icons/call/voice-muted.c619a22.svg"},function(e,t){e.exports="img/element-icons/call/voice-unmuted.896feb9.svg"},,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/icons-room-add.9e8d369.svg"},function(e,t){e.exports="img/camera.3d903f1.svg"},function(e,t){e.exports="img/icons-groups.870fab1.svg"},function(e,t){e.exports="img/element-icons/room/in-call.b74fbaf.svg"},function(e,t){e.exports="img/fileicon.a04644a.png"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/matrix-org-bw-logo.6de779a.svg"},function(e,t){e.exports="img/ems-logo.bc64656.svg"},function(e,t){e.exports="img/feather-customised/globe.be7ccf1.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return d}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=s(44);class d extends r.a.Component{constructor(e){super(e),this.state={errorText:null},this._captchaWidgetId=null,this._recaptchaContainer=Object(o.createRef)()}componentDidMount(){if(e.grecaptcha)this._onCaptchaLoaded();else{console.log("Loading recaptcha script..."),window.mx_on_recaptcha_loaded=()=>{this._onCaptchaLoaded()};const e=document.createElement("script");e.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mx_on_recaptcha_loaded&render=explicit"),this._recaptchaContainer.current.appendChild(e)}}componentWillUnmount(){this._resetRecaptcha()}_renderRecaptcha(t){if(!e.grecaptcha)throw console.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const s=this.props.sitePublicKey;if(!s)throw console.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");console.info("Rendering to %s",t),this._captchaWidgetId=e.grecaptcha.render(t,{sitekey:s,callback:this.props.onCaptchaResponse})}_resetRecaptcha(){null!==this._captchaWidgetId&&e.grecaptcha.reset(this._captchaWidgetId)}_onCaptchaLoaded(){console.log("Loaded recaptcha script.");try{this._renderRecaptcha("mx_recaptcha")}catch(e){this.setState({errorText:e.toString()})}}render(){let e=null;return this.state.errorText&&(e=r.a.createElement("div",{className:"error"},this.state.errorText)),r.a.createElement("div",{ref:this._recaptchaContainer},r.a.createElement("p",null,Object(l.a)("This homeserver would like to make sure you are not a robot.")),r.a.createElement("div",{id:"mx_recaptcha"}),e)}}i()(d,"propTypes",{sitePublicKey:c.a.string,onCaptchaResponse:c.a.func}),i()(d,"defaultProps",{onCaptchaResponse:()=>{}})}).call(this,s(6))},function(e,t){e.exports="img/icon_context_delete.2ee531e.svg"},,,,,,,,,,,,,,,function(e,t){e.exports="img/feather-customised/files.a484b40.svg"},function(e,t){e.exports="img/search-icon-vector.c463bb6.svg"},function(e,t){e.exports="img/icon-email-user.4f6a544.svg"},function(e,t){e.exports="img/icon-address-delete.3ce3a36.svg"},function(e,t){e.exports="img/icons-directory.39c3b72.svg"},function(e,t){e.exports="img/icons-people.e226241.svg"},,,function(e,t){e.exports="img/download.c281461.svg"},function(e,t){e.exports="img/icons-show-stickers.4e420bf.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return T}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(79),c=s.n(a),l=s(45),d=s.n(l),u=s(537),h=s.n(u),m=s(77),p=s(75),g=s(46),f=s(49),_=s(48),v=s(44),y=s(61),b=s(50),E=s(170),S=s(542),w=s(93),C=s(65),R=s(260),k=s(68);function I(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function O(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?I(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):I(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class T extends r.a.Component{constructor(t){super(t),i()(this,"onCancelClick",t=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()}),i()(this,"onEmoteSenderClick",e=>{const t=this.props.mxEvent;_.a.dispatch({action:"insert_mention",user_id:t.getSender()})}),i()(this,"getEventTileOps",()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}})),i()(this,"onStarterLinkClick",(e,t)=>{t.preventDefault();const s=w.a.sharedInstance();if(!s.hasManager())return void s.openNoManagerDialog();const n=s.getPrimaryManager(),i=n.getScalarClient();i.connect().then(()=>{const t=i.getStarterLink(e),s=g.getComponent("dialogs.QuestionDialog"),o=n.uiUrl;f.a.createTrackedDialog("Add an integration","",s,{title:Object(v.a)("Add an Integration"),description:r.a.createElement("div",null,Object(v.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:o})),button:Object(v.a)("Continue"),onFinished(e){if(!e)return;const s=window.screen.width>1024?1024:window.screen.width,n=window.screen.height>800?800:window.screen.height,i=(window.screen.width-s)/2,o=`height=${n}, width=${s}, top=${(window.screen.height-n)/2}, left=${i},`;window.open(t,"_blank",o).opener=null}})})}),i()(this,"_openHistoryDialog",async()=>{const e=g.getComponent("views.dialogs.MessageEditHistoryDialog");f.a.createDialog(e,{mxEvent:this.props.mxEvent})}),this._content=Object(o.createRef)(),this.state={links:[],widgetHidden:!1}}componentDidMount(){this._unmounted=!1,this._pills=[],this.props.editState||this._applyFormatting()}_applyFormatting(){if(this.activateSpoilers([this._content.current]),Object(S.a)([this._content.current],this.props.mxEvent,this._pills),m.e(this._content.current),this.calculateUrlPreview(),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const e=c.a.findDOMNode(this).getElementsByTagName("code");e.length>0&&setTimeout(()=>{if(!this._unmounted)for(let t=0;t<e.length;t++)if(b.a.getValue("enableSyntaxHighlightLanguageDetection"))h.a.highlightBlock(e[t]);else{0!=e[t].className.split(/\s+/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")})).length&&h.a.highlightBlock(e[t])}},10),this._addCodeCopyButton()}}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this._applyFormatting()}}componentWillUnmount(){this._unmounted=!0,Object(S.b)(this._pills)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden}calculateUrlPreview(){if(this.props.showUrlPreview){let t=this.findLinks([this._content.current]);if(t.length){const s=new Set;if(t=t.filter(e=>!s.has(e)&&(s.add(e),!0)),this.setState({links:t}),e.localStorage){const t=e.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:t})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),s=t.getAttribute("data-mx-spoiler"),n=g.getComponent("elements.Spoiler");t.removeAttribute("data-mx-spoiler");const i=r.a.createElement(n,{reason:s,contentHtml:t.outerHTML});c.a.render(i,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if("A"===n.tagName&&n.getAttribute("href"))this.isLinkPreviewable(n)&&t.push(n.getAttribute("href"));else{if("PRE"===n.tagName||"CODE"===n.tagName||"BLOCKQUOTE"===n.tagName)continue;n.children&&n.children.length&&(t=t.concat(this.findLinks(n.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(C.c)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}_addCodeCopyButton(){Array.from(c.a.findDOMNode(this).querySelectorAll(".mx_EventTile_body pre")).forEach(e=>{const t=document.createElement("span");t.className="mx_EventTile_copyButton",t.onclick=async()=>{const e=t.parentNode.getElementsByTagName("pre")[0],s=await Object(R.b)(e.textContent),n=t.getBoundingClientRect(),i=g.getComponent("context_menus.GenericTextContextMenu"),{close:o}=y.l(i,O(O({},Object(y.n)(n,2)),{},{message:s?Object(v.a)("Copied!"):Object(v.a)("Failed to copy")}));t.onmouseleave=o};const s=document.createElement("div");s.className="mx_EventTile_pre_container",e.parentNode.replaceChild(s,e),s.appendChild(e),s.appendChild(t)})}_renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(p.a)(e),s=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Tooltip_title"},Object(v.a)("Edited at %(date)s",{date:t})),r.a.createElement("div",{className:"mx_Tooltip_sub"},Object(v.a)("Click to view edits")));return r.a.createElement(k.a,{className:"mx_EventTile_edited",onClick:this._openHistoryDialog,title:Object(v.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:s},r.a.createElement("span",null,`(${Object(v.a)("edited")})`))}render(){if(this.props.editState){const e=g.getComponent("rooms.EditMessageComposer");return r.a.createElement(e,{editState:this.props.editState,className:"mx_EventTile_content"})}const e=this.props.mxEvent,t=e.getContent(),s=E.a.getParentEventId(e);let n,i=m.a(t,this.props.highlights,{disableBigEmoji:"m.emote"===t.msgtype||!b.a.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this._content});if(this.props.replacingEventId&&(i=[i,this._renderEditedMarker()]),this.props.highlightLink?i=r.a.createElement("a",{href:this.props.highlightLink},i):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(i=r.a.createElement("a",{href:"#",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},i)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview){const e=g.getComponent("rooms.LinkPreviewWidget");n=this.state.links.map(t=>r.a.createElement(e,{key:t,link:t,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged}))}switch(t.msgtype){case"m.emote":return r.a.createElement("span",{className:"mx_MEmoteBody mx_EventTile_content"},"* ",r.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",i,n);case"m.notice":return r.a.createElement("span",{className:"mx_MNoticeBody mx_EventTile_content"},i,n);default:return r.a.createElement("span",{className:"mx_MTextBody mx_EventTile_content"},i,n)}}}i()(T,"propTypes",{mxEvent:d.a.object.isRequired,highlights:d.a.array,highlightLink:d.a.string,showUrlPreview:d.a.bool,onHeightChanged:d.a.func,tileShape:d.a.string})}).call(this,s(6))},function(e,t){e.exports="img/plus.c04dc9a.svg"},,,,,function(e,t){e.exports="img/stickerpack-placeholder.9c54c13.png"},function(e,t){e.exports="img/room_replaced.90ddacd.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return g}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(45),c=s.n(a),l=(s(1141),s(44)),d=s(75),u=s(1142),h=s(46),m=s(251);let p=!1;try{e.localStorage&&(p="true"==e.localStorage.getItem("avatar_bounce"))}catch(e){}class g extends r.a.Component{constructor(e){super(e),this._avatar=Object(o.createRef)(),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;if(!e)return;if(this.props.checkUnmounting&&this.props.checkUnmounting())return;const t=this._avatar.current;e.top=t.offsetTop,e.left=t.offsetLeft,e.parent=t.offsetParent}componentDidMount(){if(!this.state.suppressDisplay)return;let e=-15;const t=this.props.readReceiptInfo;t&&t.parent&&(e=t.top+t.parent.getBoundingClientRect().top);const s=this._avatar.current;let n;s.offsetParent?n=e-s.offsetParent.getBoundingClientRect().top:(console.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} in has no offsetParent`),n=0);const i=[],o=[];if(t&&t.left){i.push({top:n+"px",left:Object(m.a)(t.left)});const e={duration:100,easing:"easeOut"};o.push(e)}i.push({top:n+"px",left:"0px"}),o.push({duration:p?Math.min(200*Math.log(Math.abs(n)),3e3):300,easing:p?"easeOutBounce":"easeOutCubic"}),this.setState({suppressDisplay:!1,startStyles:i,enterTransitionOpts:o})}render(){const e=h.getComponent("avatars.MemberAvatar");if(this.state.suppressDisplay)return r.a.createElement("div",{ref:this._avatar});const t={left:Object(m.a)(this.props.leftOffset),top:"0px",visibility:this.props.hidden?"hidden":"visible"};let s;if(this.props.timestamp){const e=Object(d.a)(new Date(this.props.timestamp),this.props.showTwelveHour);s=this.props.member&&this.props.fallbackUserId!==this.props.member.rawDisplayName?Object(l.a)("Seen by %(displayName)s (%(userName)s) at %(dateTime)s",{displayName:this.props.member.rawDisplayName,userName:this.props.fallbackUserId,dateTime:e}):Object(l.a)("Seen by %(userName)s at %(dateTime)s",{userName:this.props.fallbackUserId,dateTime:e})}return r.a.createElement(u.a,{startStyles:this.state.startStyles,enterTransitionOpts:this.state.enterTransitionOpts},r.a.createElement(e,{member:this.props.member,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true",width:14,height:14,resizeMethod:"crop",style:t,title:s,onClick:this.props.onClick,inputRef:this._avatar}))}}i()(g,"propTypes",{member:c.a.object,fallbackUserId:c.a.string.isRequired,leftOffset:c.a.number,hidden:c.a.bool,suppressAnimation:c.a.bool,readReceiptInfo:c.a.object,checkUnmounting:c.a.func,onClick:c.a.func,timestamp:c.a.number,showTwelveHour:c.a.bool}),i()(g,"defaultProps",{leftOffset:0})}).call(this,s(6))},function(e,t,s){"use strict";var n=s(543);s.n(n).a.Easings.easeOutBounce=function(e){return 1-function(e){let t,s=4;for(;e<((t=Math.pow(2,--s))-1)/11;);return 1/Math.pow(4,3-s)-7.5625*Math.pow((3*t-2)/22-e,2)}(1-e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(2),i=s.n(n),o=s(43),r=s.n(o),a=s(79),c=s.n(a),l=s(543),d=s.n(l),u=s(45),h=s.n(u);class m extends r.a.Component{constructor(e){super(e),this.nodes={},this._updateChildren(this.props.children)}componentDidUpdate(){this._updateChildren(this.props.children)}_updateChildren(e){const t=this.children||{};this.children={},r.a.Children.toArray(e).forEach(e=>{if(t[e.key]){const s=t[e.key],n=c.a.findDOMNode(this.nodes[s.key]);n&&n.style.left!==e.props.style.left&&d()(n,{left:e.props.style.left},this.props.transition).then(()=>{"visible"===n.style.visibility&&"hidden"===e.props.style.visibility&&(n.style.visibility=e.props.style.visibility)}),n&&"hidden"===n.style.visibility&&"visible"===e.props.style.visibility&&(n.style.visibility=e.props.style.visibility),this.children[e.key]=r.a.cloneElement(s,e.props,e.props.children)}else{const t={},s=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this._collectNode(e.key,t,s),this.children[e.key]=r.a.cloneElement(e,t)}})}_collectNode(e,t,s){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,i=this.props.enterTransitionOpts,o=c.a.findDOMNode(t);for(var n=1;n<e.length;++n)d()(o,e[n],i[n-1]);d()(o,s,i[n-1]).then(()=>{o.style.visibility=s.visibility})}else if(null===t){const t=c.a.findDOMNode(this.nodes[e]);t&&d.a.Utilities.removeData(t)}this.nodes[e]=t}render(){return r.a.createElement("span",null,Object.values(this.children))}}i()(m,"propTypes",{children:h.a.any,transition:h.a.object,startStyles:h.a.array,enterTransitionOpts:h.a.array}),i()(m,"defaultProps",{startStyles:[],enterTransitionOpts:[]})},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return c}));var n=s(154),i=s.n(n);function o(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function r(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?o(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):o(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const a={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class c{constructor(e={}){i()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),i()(this,"params",void 0),i()(this,"canvas",void 0),i()(this,"baseImage",void 0),i()(this,"context",void 0),i()(this,"icons",void 0),i()(this,"isReady",!1),i()(this,"readyCb",()=>{}),this.params=r(r({},a),e),this.icons=c.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const s={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(s.y<.6?s.y=s.y-.4:s.y=s.y-2*s.y+(1-s.w)),t.isLeft&&(s.x<.6?s.x=s.x-.4:s.x=s.x-2*s.x+(1-s.h)),s.x=this.canvas.width*s.x,s.y=this.canvas.height*s.y,s.w=this.canvas.width*s.w,s.h=this.canvas.height*s.h,s}circle(e,t){const s=r(r({},this.params),t),n=this.options(e,s);let i=!1;2===n.len?(n.x=n.x-.4*n.w,n.w=1.4*n.w,i=!0):n.len>=3&&(n.x=n.x-.65*n.w,n.w=1.65*n.w,i=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const o=Math.floor(n.h*(n.n>99?.85:1))+"px";if(this.context.font=`${s.fontWeight} ${o} ${s.fontFamily}`,this.context.textAlign="center",i?(this.context.moveTo(n.x+n.w/2,n.y),this.context.lineTo(n.x+n.w-n.h/2,n.y),this.context.quadraticCurveTo(n.x+n.w,n.y,n.x+n.w,n.y+n.h/2),this.context.lineTo(n.x+n.w,n.y+n.h-n.h/2),this.context.quadraticCurveTo(n.x+n.w,n.y+n.h,n.x+n.w-n.h/2,n.y+n.h),this.context.lineTo(n.x+n.h/2,n.y+n.h),this.context.quadraticCurveTo(n.x,n.y+n.h,n.x,n.y+n.h-n.h/2),this.context.lineTo(n.x,n.y+n.h/2),this.context.quadraticCurveTo(n.x,n.y,n.x+n.h/2,n.y)):this.context.arc(n.x+n.w/2,n.y+n.h/2,n.h/2,0,2*Math.PI),this.context.fillStyle=s.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=s.textColor,"number"==typeof n.n&&n.n>999){const e=(n.n>9999?9:Math.floor(n.n/1e3))+"k+";this.context.fillText(e,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.2*n.h))}else this.context.fillText(""+n.n,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.15*n.h));this.context.closePath()}ready(){this.isReady||(this.isReady=!0,this.readyCb())}setIcon(t){e(()=>{this.setIconSrc(t.toDataURL("image/png"))})}setIconSrc(e){if(this.browser.ff||this.browser.opera){const t=this.icons[this.icons.length-1],s=window.document.createElement("link");this.icons=[s],s.setAttribute("rel","icon"),s.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(s),s.setAttribute("href",e),t.parentNode&&t.parentNode.removeChild(t)}else this.icons.forEach(t=>{t.setAttribute("href",e)})}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(let s=0;s<t.length;s++)/(^|\s)icon(\s|$)/i.test(t[s].getAttribute("rel"))&&e.push(t[s]);return e}static getIcons(){let e=c.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach(e=>{e.setAttribute("type","image/png")}),e}}}).call(this,s(136).setImmediate)},,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"components",(function(){return Tp}));var n=s(61),i=s(43),o=s.n(i),r=s(69),a=s(282),c=s(44),l=s(53),d=s(46),u=s(48),h=s(54);var m=()=>{const e=l.a.get(),t=Object(a.a)(e);if(t){const e=d.getComponent("structures.EmbeddedPage");return i.createElement(e,{className:"mx_HomePage",url:t,scrollbar:!0})}const s=e.branding;let n="themes/element/img/logos/element-logo.svg";s&&s.authHeaderLogoUrl&&(n=s.authHeaderLogoUrl);d.getComponent("elements.AccessibleButton");return i.createElement(r.a,{className:"mx_HomePage mx_HomePage_default"},i.createElement("div",{className:"mx_HomePage_default_wrapper"},i.createElement("img",{src:n,alt:e.brand||"Element"}),i.createElement("h1",null,Object(c.a)("Welcome to %(appName)s",{appName:e.brand||"Element"}))))},p=s(2),g=s.n(p),f=s(110),_=s(283);class v{static fetchJoinedGroups(e){return Object(_.a)("GroupActions.fetchJoinedGroups",()=>e.getJoinedGroups(),null)}}var y=s(235),b=s(51),E=s.n(b),S=s(59),w=s(50),C=s(68);class R extends o.a.PureComponent{constructor(e){super(e),g()(this,"tagStoreRef",void 0),g()(this,"onTagStoreUpdate",()=>{const e=0===f.a.getSelectedTags().length;this.setState({selected:e})}),g()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"deselect_tags"})}),this.state={selected:0===f.a.getSelectedTags().length}}componentDidMount(){this.tagStoreRef=f.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.tagStoreRef.remove()}render(){const e=E()({mx_TagTile:!0,mx_TagTile_prototype:!0,mx_TagTile_selected_prototype:this.state.selected,mx_TagTile_home:!0});return o.a.createElement(C.a,{className:e,onClick:this.onTileClick,title:Object(c.a)("Home")},o.a.createElement("div",{className:"mx_TagTile_avatar"},o.a.createElement("div",{className:"mx_TagTile_homeIcon"})))}}class k extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{orderedTags:[],selectedTags:[]}),g()(this,"_onGroupMyMembership",()=>{this.unmounted||u.a.dispatch(v.fetchJoinedGroups(this.context))}),g()(this,"_onClientSync",(e,t)=>{"ERROR"!==e&&t!==e&&u.a.dispatch(v.fetchJoinedGroups(this.context))}),g()(this,"onMouseDown",e=>{this.state.selectedTags.length>0&&u.a.dispatch({action:"deselect_tags"})}),g()(this,"onClearFilterClick",e=>{u.a.dispatch({action:"deselect_tags"})})}componentDidMount(){this.unmounted=!1,this.context.on("Group.myMembership",this._onGroupMyMembership),this.context.on("sync",this._onClientSync),this._tagOrderStoreToken=f.a.addListener(()=>{this.unmounted||this.setState({orderedTags:f.a.getOrderedTags()||[],selectedTags:f.a.getSelectedTags()})}),u.a.dispatch(v.fetchJoinedGroups(this.context))}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Group.myMembership",this._onGroupMyMembership),this.context.removeListener("sync",this._onClientSync),this._tagOrderStoreToken&&this._tagOrderStoreToken.remove()}renderGlobalIcon(){return w.a.getValue("feature_communities_v2_prototypes")?o.a.createElement("div",null,o.a.createElement(R,null),o.a.createElement("hr",{className:"mx_TagPanel_divider"})):null}render(){const e=d.getComponent("elements.DNDTagTile"),t=d.getComponent("elements.ActionButton"),s=this.state.orderedTags.map((t,s)=>o.a.createElement(e,{key:t,tag:t,index:s,selected:this.state.selectedTags.includes(t)})),n=this.state.selectedTags.length>0,i=E()("mx_TagPanel",{mx_TagPanel_items_selected:n});let a=o.a.createElement(t,{tooltip:!0,label:Object(c.a)("Communities"),action:"toggle_my_groups",className:"mx_TagTile mx_TagTile_plus"});return w.a.getValue("feature_communities_v2_prototypes")&&(a=o.a.createElement(t,{tooltip:!0,label:Object(c.a)("Create community"),action:"view_create_group",className:"mx_TagTile mx_TagTile_plus"})),o.a.createElement("div",{className:i,onClick:this.onClearFilterClick},o.a.createElement(r.a,{className:"mx_TagPanel_scroller",onMouseDown:this.onMouseDown},o.a.createElement(y.Droppable,{droppableId:"tag-panel-droppable",type:"draggable-TagTile"},(e,t)=>o.a.createElement("div",{className:"mx_TagPanel_tagTileContainer",ref:e.innerRef},this.renderGlobalIcon(),s,o.a.createElement("div",null,a),e.placeholder))))}}g()(k,"contextType",S.a);var I=k,O=s(430),T=s(91);class x extends o.a.Component{constructor(e){super(e),this.state={tags:O.a.getSortedTags()}}componentDidMount(){this._tagStoreToken=O.a.addListener(()=>{this.setState({tags:O.a.getSortedTags()})})}componentWillUnmount(){this._tagStoreToken&&this._tagStoreToken.remove()}render(){const e=this.state.tags.map(e=>o.a.createElement(N,{tag:e,key:e.name})),t=E()("mx_CustomRoomTagPanel",{mx_CustomRoomTagPanel_empty:0===this.state.tags.length});return o.a.createElement("div",{className:t},o.a.createElement("div",{className:"mx_CustomRoomTagPanel_divider"}),o.a.createElement(r.a,{className:"mx_CustomRoomTagPanel_scroller"},e))}}class N extends o.a.Component{constructor(...e){super(...e),g()(this,"onClick",()=>{u.a.dispatch({action:"select_custom_room_tag",tag:this.props.tag.name})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleTooltipButton"),s=this.props.tag,n=E()({CustomRoomTagPanel_tileSelected:s.selected}),i=s.name,r=s.badgeNotifState;let a;if(r){const e=E()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:r.hasMentions});a=o.a.createElement("div",{className:e},T.c(r.count))}return o.a.createElement(t,{className:n,onClick:this.onClick,title:i},o.a.createElement("div",{className:"mx_TagTile_avatar"},o.a.createElement(e,{name:s.avatarLetter,idName:i,width:40,height:40}),a))}}var j=x,P=s(132),D=s(89),A=s(74),U=s(71),M=s(322),L=s(47),F=s(56),B=s.n(F),V=s(60),K=s.n(V),q=s(127);class G extends o.a.Component{getGroupAvatarUrl(){return L.a.get().mxcUrlToHttp(this.props.groupAvatarUrl,this.props.width,this.props.height,this.props.resizeMethod)}render(){const e=this.props,{groupId:t,groupAvatarUrl:s,groupName:n}=e,i=K()(e,["groupId","groupAvatarUrl","groupName"]);return o.a.createElement(q.a,B()({name:n||this.props.groupId[1],idName:this.props.groupId,url:this.getGroupAvatarUrl()},i))}}g()(G,"defaultProps",{width:36,height:36,resizeMethod:"crop"});var W=s(212);class H extends o.a.Component{constructor(e){super(e),g()(this,"onTileMouseEnter",()=>{this.setState({hover:!0})}),g()(this,"onTileMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=E()({mx_RoomTile:!0,mx_TemporaryTile:!0,mx_RoomTile_selected:this.props.isSelected,mx_RoomTile_minimized:this.props.isMinimized}),t=o.a.createElement(W.a,{notification:this.props.notificationState,forceCount:!1});let s=this.props.displayName;"string"!=typeof s&&(s=""),s=s.replace(":",":​");const n=E()({mx_RoomTile_name:!0,mx_RoomTile_nameHasUnreadEvents:this.props.notificationState.isUnread});let i=o.a.createElement("div",{className:"mx_RoomTile_nameContainer"},o.a.createElement("div",{title:s,className:n,tabIndex:-1,dir:"auto"},s));this.props.isMinimized&&(i=null);let r=P.a;return this.props.isMinimized&&(r=P.b),o.a.createElement(o.a.Fragment,null,o.a.createElement(r,{className:e,onMouseEnter:this.onTileMouseEnter,onMouseLeave:this.onTileMouseLeave,onClick:this.props.onClick,role:"treeitem",title:this.props.isMinimized?s:void 0},o.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},this.props.avatar),i,o.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},t)))}}var $=s(175);class z extends $.b{constructor(e,t,s){super(),this._symbol=e,this._count=t,this._color=s}static forCount(e,t){return new z(null,e,t)}static forSymbol(e,t){return new z(e,0,t)}}var Y=s(174),J=s(131),Q=s(3),X=s(11),Z=s(52);const ee=[U.a.Invite,U.a.Favourite,U.a.DM,U.a.Untagged,U.a.LowPriority,U.a.ServerNotice,U.a.Archived],te=U.a.LowPriority,se=[U.a.DM,U.a.Untagged],ne={[U.a.Invite]:{sectionLabel:Object(c.b)("Invites"),isInvite:!0,defaultHidden:!1},[U.a.Favourite]:{sectionLabel:Object(c.b)("Favourites"),isInvite:!1,defaultHidden:!1},[U.a.DM]:{sectionLabel:Object(c.b)("People"),isInvite:!1,defaultHidden:!1},[U.a.Untagged]:{sectionLabel:Object(c.b)("Rooms"),isInvite:!1,defaultHidden:!1},[U.a.LowPriority]:{sectionLabel:Object(c.b)("Low priority"),isInvite:!1,defaultHidden:!1},[U.a.ServerNotice]:{sectionLabel:Object(c.b)("System Alerts"),isInvite:!1,defaultHidden:!1},[U.a.Archived]:{sectionLabel:Object(c.b)("Historical"),isInvite:!1,defaultHidden:!0}};class ie extends i.PureComponent{constructor(e){super(e),g()(this,"dispatcherRef",void 0),g()(this,"customTagStoreRef",void 0),g()(this,"onAction",e=>{if(e.action===h.a.ViewRoomDelta){const t=e,s=A.a.getRoomId(),n=this.getRoomDelta(s,t.delta,t.unread);n&&u.a.dispatch({action:"view_room",room_id:n.roomId,show_room_tile:!0})}}),g()(this,"getRoomDelta",(e,t,s=!1)=>{const n=D.b.instance.orderedLists,i=[];ee.forEach(t=>{let o=n[t];s&&(o=o.filter(t=>{const s=J.a.instance.getRoomState(t);return s.room.roomId===e||s.isUnread})),i.push(...o)});const o=i.findIndex(t=>t.roomId===e),[r]=i.slice((o+t)%i.length);return r}),g()(this,"updateLists",()=>{const e=D.b.instance.orderedLists;w.a.getValue("advancedRoomListLogging")&&console.log("new lists",e);const t=Object.keys(this.state.sublists),s=Object.keys(e).filter(e=>!Object(U.d)(e)||O.a.getTags()[e]);let n=Object(Q.d)(t,s);if(!n)for(const t of s){const s=this.state.sublists[t],i=e[t];if(s.length!==i.length){n=!0;break}}if(n){const t=Object(X.f)(e,s),n=Object(X.e)(t,(e,t)=>Object(Q.c)(t));this.setState({sublists:n},()=>{this.props.onResize()})}}),g()(this,"onExplore",()=>{u.a.fire(h.a.ViewRoomDirectory)}),this.state={sublists:{}},this.dispatcherRef=u.a.register(this.onAction)}componentDidMount(){D.b.instance.on(D.a,this.updateLists),this.customTagStoreRef=O.a.addListener(this.updateLists),this.updateLists()}componentWillUnmount(){D.b.instance.off(D.a,this.updateLists),u.a.unregister(this.dispatcherRef),this.customTagStoreRef&&this.customTagStoreRef.remove()}renderCommunityInvites(){return L.a.get().getGroups().filter(e=>"invite"===e.myMembership).map(e=>{const t=i.createElement(G,{groupId:e.groupId,groupName:e.name,groupAvatarUrl:e.avatarUrl,width:32,height:32,resizeMethod:"crop"});return i.createElement(H,{isMinimized:this.props.isMinimized,isSelected:!1,displayName:e.name,avatar:t,notificationState:z.forSymbol("!",Y.a.Red),onClick:()=>{u.a.dispatch({action:"view_group",group_id:e.groupId})},key:"temporaryGroupTile_"+e.groupId})})}renderSublists(){const e=[],t=ee.reduce((e,t)=>{if(t===te){const t=Object.keys(this.state.sublists).filter(e=>Object(U.d)(e));e.push(...t)}return e.push(t),e},[]);for(const n of t){const t=this.state.sublists[n]||[],o=n===U.a.Invite?this.renderCommunityInvites():null;if(0===t.length+(o?o.length:0)&&!se.includes(n))continue;const r=Object(U.d)(n)?((s=n).startsWith("u.")&&(s=s.substring(2)),{sectionLabel:Object(c.b)("Custom Tag"),sectionLabelRaw:s,isInvite:!1,defaultHidden:!1}):ne[n];if(!r)throw new Error(`Tag ${n} does not have aesthetics`);e.push(i.createElement(M.b,{key:"sublist-"+n,tagId:n,forRooms:!0,startAsHidden:r.defaultHidden,label:r.sectionLabelRaw?r.sectionLabelRaw:Object(c.a)(r.sectionLabel),onAddRoom:r.onAddRoom,addRoomLabel:r.addRoomLabel?Object(c.a)(r.addRoomLabel):r.addRoomLabel,addRoomContextMenu:r.addRoomContextMenu,isMinimized:this.props.isMinimized,onResize:this.props.onResize,extraBadTilesThatShouldntExist:o}))}var s;return e}render(){let e;D.b.instance.getFirstNameFilterCondition()&&(e=i.createElement("div",{className:"mx_RoomList_explorePrompt"},i.createElement("div",null,Object(c.a)("Can't see what you’re looking for?")),i.createElement(Z.a,{kind:"link",onClick:this.onExplore},Object(c.a)("Explore all public rooms"))));const t=this.renderSublists();return i.createElement(P.c,{handleHomeEnd:!0,onKeyDown:this.props.onKeyDown},({onKeyDownHandler:s})=>i.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:s,className:"mx_RoomList",role:"tree","aria-label":Object(c.a)("Rooms")},t,e))}}var oe=s(45),re=s.n(oe);class ae{constructor(e,t,s,n){this.id=e,this.label=t,this.icon=s,this.body=n}}class ce extends i.Component{constructor(e){super(e);let t=0;if(e.initialTabId){const s=e.tabs.findIndex(t=>t.id===e.initialTabId);s>=0&&(t=s)}this.state={activeTabIndex:t}}_getActiveTabIndex(){return this.state&&this.state.activeTabIndex?this.state.activeTabIndex:0}_setActiveTab(e){const t=this.props.tabs.indexOf(e);-1!==t?this.setState({activeTabIndex:t}):console.error("Could not find tab "+e.label+" in tabs")}_renderTabLabel(e){const t=d.getComponent("elements.AccessibleButton");let s="mx_TabbedView_tabLabel ";this.props.tabs.indexOf(e)===this._getActiveTabIndex()&&(s+="mx_TabbedView_tabLabel_active");let n=null;e.icon&&(n=i.createElement("span",{className:"mx_TabbedView_maskedIcon "+e.icon}));const o=Object(c.a)(e.label);return i.createElement(t,{className:s,key:"tab_label_"+e.label,onClick:()=>this._setActiveTab(e)},n,i.createElement("span",{className:"mx_TabbedView_tabLabel_text"},o))}_renderTabPanel(e){return i.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},i.createElement(r.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){const e=this.props.tabs.map(e=>this._renderTabLabel(e)),t=this._renderTabPanel(this.props.tabs[this._getActiveTabIndex()]);return i.createElement("div",{className:"mx_TabbedView"},i.createElement("div",{className:"mx_TabbedView_tabLabels"},e),t)}}var le=s(64),de=s(55),ue=s(66),he=s.n(ue),me=s(470),pe=s.n(me);function ge(e){const t=l.a.get().hosting_signup_link;if(!t)return null;if(!e)return t;if("matrix.org"!==L.a.get().getDomain())return null;try{const s=he.a.parse(t),n=pe.a.parse(s.query);return n.utm_campaign=e,s.search=void 0,s.query=n,s.format()}catch(e){return t}}class fe extends o.a.Component{constructor(){super(),g()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),g()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:void 0,avatarFile:void 0,enableProfileSave:!0})}),g()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=L.a.get(),s={};if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(this.state.displayName),s.originalDisplayName=this.state.displayName),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),s.avatarUrl=t.mxcUrlToHttp(e,96,96,"crop",!1),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("");this.setState(s)}),g()(this,"_onDisplayNameChanged",e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})}),g()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const e=L.a.get();let t=e.getUser(e.getUserId());t||(console.warn("User object not found - creating one for ProfileSettings"),t=new de.n(e.getUserId()));let s=t.avatarUrl;s&&(s=e.mxcUrlToHttp(s,96,96,"crop",!1)),this.state={userId:t.userId,originalDisplayName:t.rawDisplayName,displayName:t.rawDisplayName,originalAvatarUrl:s,avatarUrl:s,avatarFile:null,enableProfileSave:!1},this._avatarUpload=Object(i.createRef)()}render(){const e=ge("user-settings");let t=null;e&&(t=o.a.createElement("span",{className:"mx_ProfileSettings_hostingSignup"},Object(c.a)("<a>Upgrade</a> to your own domain",{},{a:t=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)}),o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},o.a.createElement("img",{src:s(472),width:"11",height:"10",alt:""}))));const n=d.getComponent("elements.AccessibleButton"),i=d.getComponent("settings.AvatarSetting");return o.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0},o.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),o.a.createElement("div",{className:"mx_ProfileSettings_profile"},o.a.createElement("div",{className:"mx_ProfileSettings_controls"},o.a.createElement("p",null,this.state.userId,t),o.a.createElement(le.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this._onDisplayNameChanged})),o.a.createElement(i,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.state.userId,avatarAltText:Object(c.a)("Profile picture"),uploadAvatar:this._uploadAvatar,removeAvatar:this._removeAvatar})),o.a.createElement(n,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(c.a)("Save")))}}class _e extends o.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this.state={searchQuery:"",langs:null}}componentDidMount(){if(c.c().then(e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})}).catch(()=>{this.setState({langs:["en"]})}),!this.props.value){const e=w.a.getValue("language",null,!0);if(e)this.props.onOptionChange(e);else{const e=c.i(c.e());this.props.onOptionChange(e)}}}_onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.langs){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}const e=d.getComponent("elements.Dropdown");let t;t=this.state.searchQuery?this.state.langs.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.langs;const s=t.map(e=>o.a.createElement("div",{key:e.value},e.label));let n=w.a.getValue("language",null,!0),i=null;return n||(n=navigator.language||navigator.userLanguage),i=this.props.value||n,o.a.createElement(e,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this._onSearchChange,searchEnabled:!0,value:i,label:Object(c.a)("Language Dropdown"),disabled:this.props.disabled},s)}}_e.propTypes={className:re.a.string,onOptionChange:re.a.func.isRequired,value:re.a.string};var ve=s(72),ye=s(223),be=s(148);const Ee=new Error("User cancelled auth session");class Se extends o.a.Component{constructor(e){super(e),g()(this,"_requestEmailToken",async(...e)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(...e)}finally{this.setState({busy:!1})}}),g()(this,"tryContinue",()=>{this._stageComponent.current&&this._stageComponent.current.tryContinue&&this._stageComponent.current.tryContinue()}),g()(this,"_authStateUpdated",(e,t)=>{const s=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error},()=>{s!=e&&this._setFocus()})}),g()(this,"_requestCallback",e=>this.props.makeRequest(e)),g()(this,"_onBusyChanged",e=>{e&&this.setState({busy:!0,errorText:null,stageErrorText:null})}),g()(this,"_submitAuthDict",e=>{this._authLogic.submitAuthDict(e)}),g()(this,"_onPhaseChange",e=>{this.props.onStagePhaseChange&&this.props.onStagePhaseChange(this.state.authStage,e||0)}),g()(this,"_onStageCancel",()=>{this.props.onAuthFinished(!1,Ee)}),g()(this,"_onAuthStageFailed",e=>{this.props.onAuthFinished(!1,e)}),g()(this,"_setEmailSid",e=>{this._authLogic.setEmailSid(e)}),this.state={authStage:null,busy:!1,errorText:null,stageErrorText:null,submitButtonEnabled:!1},this._unmounted=!1,this._authLogic=new de.g({authData:this.props.authData,doRequest:this._requestCallback,busyChanged:this._onBusyChanged,inputs:this.props.inputs,stateUpdated:this._authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this._requestEmailToken}),this._intervalId=null,this.props.poll&&(this._intervalId=setInterval(()=>{this._authLogic.poll()},2e3)),this._stageComponent=Object(i.createRef)()}UNSAFE_componentWillMount(){this._authLogic.attemptAuth().then(e=>{const t={emailSid:this._authLogic.getEmailSid(),clientSecret:this._authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)}).catch(e=>{if(this.props.onAuthFinished(!1,e),console.error("Error during user-interactive auth:",e),this._unmounted)return;const t=e.message||e.toString();this.setState({errorText:t})})}componentWillUnmount(){this._unmounted=!0,null!==this._intervalId&&clearInterval(this._intervalId)}_setFocus(){this._stageComponent.current&&this._stageComponent.current.focus&&this._stageComponent.current.focus()}_renderCurrentStage(){const e=this.state.authStage;if(!e){if(this.state.busy){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}return null}const t=Object(be.d)(e);return o.a.createElement(t,{ref:this._stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this._authLogic.getSessionId(),clientSecret:this._authLogic.getClientSecret(),stageParams:this._authLogic.getStageParams(e),submitAuthDict:this._submitAuthDict,errorText:this.state.stageErrorText,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this._onAuthStageFailed,setEmailSid:this._setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this._onPhaseChange,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this._onStageCancel})}render(){let e=null;return this.state.errorText&&(e=o.a.createElement("div",{className:"error"},this.state.errorText)),o.a.createElement("div",null,o.a.createElement("div",null,this._renderCurrentStage(),e))}}g()(Se,"propTypes",{matrixClient:re.a.object.isRequired,authData:re.a.shape({flows:re.a.array,params:re.a.object,session:re.a.string}),makeRequest:re.a.func.isRequired,onAuthFinished:re.a.func.isRequired,inputs:re.a.object,requestEmailToken:re.a.func,sessionId:re.a.string,clientSecret:re.a.string,emailSid:re.a.string,poll:re.a.bool,continueIsManaged:re.a.bool,onStagePhaseChange:re.a.func,continueText:re.a.string,continueKind:re.a.string});var we=s(94);class Ce extends o.a.Component{constructor(e){super(e),g()(this,"_onStagePhaseChange",(e,t)=>{const s={[be.c.PHASE_PREAUTH]:{body:Object(c.a)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"danger"},[be.c.PHASE_POSTAUTH]:{body:Object(c.a)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(c.a)("Confirm account deactivation"),continueKind:"danger"}},n={[be.c.LOGIN_TYPE]:s,[be.c.UNSTABLE_LOGIN_TYPE]:s,[be.b.LOGIN_TYPE]:{[be.a]:{body:Object(c.a)("To continue, please enter your password:")}}}[e];let i=null,o=null,r=null;if(n){const e=n[t];e&&e.body&&(i=e.body),e&&e.continueText&&(o=e.continueText),e&&e.continueKind&&(r=e.continueKind)}this.setState({bodyText:i,continueText:o,continueKind:r})}),g()(this,"_onUIAuthFinished",(e,t,s)=>{e||(t!==Ee?(console.error("Error during UI Auth:",{result:t,extra:s}),this.setState({errStr:Object(c.a)("There was a problem communicating with the server. Please try again.")})):this._onCancel())}),g()(this,"_onUIAuthComplete",e=>{L.a.get().deactivateAccount(e,this.state.shouldErase).then(e=>{ve.a.trackEvent("Account","Deactivate Account"),ye.k(),this.props.onFinished(!0)}).catch(e=>{console.error(e),this.setState({errStr:Object(c.a)("There was a problem communicating with the server. Please try again.")})})}),g()(this,"_onEraseFieldChange",e=>{this.setState({shouldErase:e.target.checked,authEnabled:!1}),this._initAuth(e.target.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0,bodyText:null,continueText:null,continueKind:null},this._initAuth(!1)}_onCancel(){this.props.onFinished(!1)}_initAuth(e){L.a.get().deactivateAccount(null,e).then(e=>{console.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(c.a)("Server did not require any authentication")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(c.a)("Server did not return valid authentication information.")})})}render(){const e=d.getComponent("views.dialogs.BaseDialog");let t=null;this.state.errStr&&(t=o.a.createElement("div",{className:"error"},this.state.errStr));let s=o.a.createElement("div",null,Object(c.a)("Loading..."));return this.state.authData&&this.state.authEnabled&&(s=o.a.createElement("div",null,this.state.bodyText,o.a.createElement(Se,{matrixClient:L.a.get(),authData:this.state.authData,makeRequest:this._onUIAuthComplete,onAuthFinished:this._onUIAuthFinished,onStagePhaseChange:this._onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),o.a.createElement(e,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(c.a)("Deactivate Account")},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("This will make your account permanently unusable. You will not be able to log in, and no one will be able to re-register the same user ID. This will cause your account to leave all rooms it is participating in, and it will remove your account details from your identity server. <b>This action is irreversible.</b>",{},{b:e=>o.a.createElement("b",null," ",e," ")})),o.a.createElement("p",null,Object(c.a)("Deactivating your account <b>does not by default cause us to forget messages you have sent.</b> If you would like us to forget your messages, please tick the box below.",{},{b:e=>o.a.createElement("b",null," ",e," ")})),o.a.createElement("p",null,Object(c.a)("Message visibility in Matrix is similar to email. Our forgetting your messages means that messages you have sent will not be shared with any new or unregistered users, but registered users who already have access to these messages will still have access to their copy.")),o.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},o.a.createElement("p",null,o.a.createElement(we.a,{checked:this.state.shouldErase,onChange:this._onEraseFieldChange},Object(c.a)("Please forget all messages I have sent when my account is deactivated (<b>Warning:</b> this will cause future users to see an incomplete view of conversations)",{},{b:e=>o.a.createElement("b",null,e)}))),t,s)))}}Ce.propTypes={onFinished:re.a.func.isRequired};var Re=s(62),ke=s(49),Ie=s(203),Oe=s(123),Te=s(173);async function xe(e,t){const s=e.getUserId();let{threepids:n}=await e.getThreePids();if(t&&(n=n.filter(e=>e.medium===t)),n.length>0&&e.getIdentityServerUrl())try{const i=new Oe.a,o=await i.getAccessToken({check:!1}),r=n.map(({medium:e,address:t})=>[e,t]),a=await e.bulkLookupThreePids(r,o);for(const[e,i,o]of a.threepids){if(o!==s)continue;if(t&&e!==t)continue;const r=n.find(t=>t.medium===e&&t.address===i);r&&(r.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return n}var Ne=s(99),je=s(57);class Pe extends o.a.Component{constructor(){super(),g()(this,"_onAction",e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(L.a.get().getIdentityServerUrl())}),this._getThreepidState())}),g()(this,"_onEmailsChange",e=>{this.setState({emails:e})}),g()(this,"_onMsisdnsChange",e=>{this.setState({msisdns:e})}),g()(this,"_onLanguageChange",e=>{this.state.language!==e&&(w.a.setValue("language",null,je.a.DEVICE,e),this.setState({language:e}),Re.a.get().reload())}),g()(this,"_onPasswordChangeError",e=>{let t=e.error||"";403===e.httpStatus?t=Object(c.a)("Failed to change password. Is your password correct?"):e.httpStatus&&(t+=` (HTTP status ${e.httpStatus})`);const s=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change password: "+t),ke.a.createTrackedDialog("Failed to change password","",s,{title:Object(c.a)("Error"),description:t})}),g()(this,"_onPasswordChanged",()=>{const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Password changed","",e,{title:Object(c.a)("Success"),description:Object(c.a)("Your password was successfully changed. You will not receive push notifications on other sessions until you log back in to them")+"."})}),g()(this,"_onDeactivateClicked",()=>{ke.a.createTrackedDialog("Deactivate Account","",Ce,{onFinished:e=>{e&&this.props.closeSettingsFn()}})}),this.state={language:c.d(),haveIdServer:Boolean(L.a.get().getIdentityServerUrl()),serverSupportsSeparateAddAndBind:null,idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1},emails:[],msisdns:[],loading3pids:!0},this.dispatcherRef=u.a.register(this._onAction)}async UNSAFE_componentWillMount(){const e=L.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),s=(await e.getCapabilities())["m.change_password"],n=!s||!1!==s.enabled;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n}),this._getThreepidState()}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}async _getThreepidState(){const e=L.a.get();this._checkTerms();let t=[];try{t=await xe(e)}catch(e){const t=L.a.get().getIdentityServerUrl();console.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),console.warn(e)}this.setState({emails:t.filter(e=>"email"===e.medium),msisdns:t.filter(e=>"msisdn"===e.medium),loading3pids:!1})}async _checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=L.a.get().getIdentityServerUrl(),t=new Oe.a;try{const s=await t.getAccessToken({check:!1});await Object(Ie.d)([new Ie.a(de.l.IS,e,s)],(t,s,n)=>new Promise((n,i)=>{this.setState({idServerName:Object(Te.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:s,resolve:n}})})),this.setState({requiredPolicyInfo:{hasTerms:!1}})}catch(t){console.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),console.warn(t)}}_renderProfileSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Profile")),o.a.createElement(fe,null))}_renderAccountSection(){const e=d.getComponent("views.settings.ChangePassword"),t=d.getComponent("views.settings.account.EmailAddresses"),s=d.getComponent("views.settings.account.PhoneNumbers");let n=o.a.createElement(e,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this._onPasswordChangeError,onFinished:this._onPasswordChanged}),i=null;if(this.state.haveIdServer||!0===this.state.serverSupportsSeparateAddAndBind){const e=this.state.loading3pids?o.a.createElement(Ne.a,null):o.a.createElement(t,{emails:this.state.emails,onEmailsChange:this._onEmailsChange}),n=this.state.loading3pids?o.a.createElement(Ne.a,null):o.a.createElement(s,{msisdns:this.state.msisdns,onMsisdnsChange:this._onMsisdnsChange});i=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),e,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),n)}else null===this.state.serverSupportsSeparateAddAndBind&&(i=o.a.createElement(Ne.a,null));let r=Object(c.a)("Set a new account password...");return this.state.canChangePassword||(r=null,n=null),o.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account")),o.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},r),n,i)}_renderLanguageSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Language and region")),o.a.createElement(_e,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this._onLanguageChange,value:this.state.language}))}_renderDiscoverySection(){const e=d.getComponent("views.settings.SetIdServer");if(this.state.requiredPolicyInfo.hasTerms){const t=d.getComponent("views.terms.InlineTermsAgreement"),s=o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Agree to the identity server (%(serverName)s) Terms of Service to allow yourself to be discoverable by email address or phone number.",{serverName:this.state.idServerName}));return o.a.createElement("div",null,o.a.createElement(t,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:s}),o.a.createElement(e,{missingTerms:!0}))}const t=d.getComponent("views.settings.discovery.EmailAddresses"),s=d.getComponent("views.settings.discovery.PhoneNumbers"),n=this.state.loading3pids?o.a.createElement(Ne.a,null):o.a.createElement(t,{emails:this.state.emails}),i=this.state.loading3pids?o.a.createElement(Ne.a,null):o.a.createElement(s,{msisdns:this.state.msisdns}),r=this.state.haveIdServer?o.a.createElement("div",{className:"mx_GeneralUserSettingsTab_discovery"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),n,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),i):null;return o.a.createElement("div",{className:"mx_SettingsTab_section"},r,o.a.createElement(e,null))}_renderManagementSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account management")),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Deactivating your account is a permanent action - be careful!")),o.a.createElement(Z.a,{onClick:this._onDeactivateClicked,kind:"danger"},Object(c.a)("Deactivate Account")))}_renderIntegrationManagerSection(){const e=d.getComponent("views.settings.SetIntegrationManager");return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(e,null))}render(){const e=this.state.requiredPolicyInfo.hasTerms?o.a.createElement("img",{className:"mx_GeneralUserSettingsTab_warningIcon",src:s(337),width:"18",height:"18",alt:Object(c.a)("Warning")}):null;return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("General")),this._renderProfileSection(),this._renderAccountSection(),this._renderLanguageSection(),o.a.createElement("div",{className:"mx_SettingsTab_heading"},e," ",Object(c.a)("Discovery")),this._renderDiscoverySection(),this._renderIntegrationManagerSection(),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Deactivate account")),this._renderManagementSection())}}g()(Pe,"propTypes",{closeSettingsFn:re.a.func.isRequired});var De=s(129);class Ae extends o.a.Component{constructor(...e){super(...e),g()(this,"_onChange",async e=>{await w.a.setValue(this.props.featureId,null,je.a.DEVICE,e),this.forceUpdate()})}render(){const e=w.a.getDisplayName(this.props.featureId),t=w.a.getValue(this.props.featureId),s=w.a.canSetValue(this.props.featureId,null,je.a.DEVICE);return o.a.createElement(De.a,{value:t,label:e,onChange:this._onChange,disabled:!s})}}g()(Ae,"propTypes",{featureId:re.a.string.isRequired});class Ue extends o.a.Component{constructor(){super()}render(){const e=d.getComponent("views.elements.SettingsFlag"),t=w.a.getFeatureSettingNames().map(e=>o.a.createElement(Ae,{featureId:e,key:e}));return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Labs")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Customise your experience with experimental labs features. <a>Learn more</a>.",{},{a:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),o.a.createElement("div",{className:"mx_SettingsTab_section"},t,o.a.createElement(e,{name:"enableWidgetScreenshots",level:je.a.ACCOUNT}),o.a.createElement(e,{name:"showHiddenEventsInTimeline",level:je.a.DEVICE}),o.a.createElement(e,{name:"lowBandwidth",level:je.a.DEVICE}),o.a.createElement(e,{name:"sendReadReceipts",level:je.a.ACCOUNT}),o.a.createElement(e,{name:"advancedRoomListLogging",level:je.a.DEVICE})))}}var Me=s(216),Le=s(334);class Fe extends i.Component{offset(e,t){const s=e.reduce((e,s)=>t>s?e+1:e,0);if(0===s)return 0;if(s===e.length)return 100;const n=e[s-1],i=e[s],o=1/(e.length-1);return 100*(s-1+(t-n)/(i-n))*o}render(){const e=this.props.values.map(e=>i.createElement(Be,{active:e<=this.props.value,label:this.props.displayFunc(e),onClick:this.props.disabled?()=>{}:()=>this.props.onSelectionChange(e),key:e,disabled:this.props.disabled}));let t=null;if(!this.props.disabled){const e=this.offset(this.props.values,this.props.value);t=i.createElement("div",{className:"mx_Slider_selection"},i.createElement("div",{className:"mx_Slider_selectionDot",style:{left:"calc(-0.55em + "+e+"%)"}}),i.createElement("hr",{style:{width:e+"%"}}))}return i.createElement("div",{className:"mx_Slider"},i.createElement("div",null,i.createElement("div",{className:"mx_Slider_bar"},i.createElement("hr",{onClick:this.props.disabled?()=>{}:this.onClick.bind(this)}),t),i.createElement("div",{className:"mx_Slider_dotContainer"},e)))}onClick(e){const t=e.target.clientWidth,s=e.nativeEvent.offsetX/t,n=this.props.values[Math.round(s*(this.props.values.length-1))];this.props.onSelectionChange(n)}}class Be extends i.PureComponent{render(){let e="mx_Slider_dot";return!this.props.disabled&&this.props.active&&(e+=" mx_Slider_dotActive"),i.createElement("span",{onClick:this.props.onClick,className:"mx_Slider_dotValue"},i.createElement("div",{className:e}),i.createElement("div",{className:"mx_Slider_labelContainer"},i.createElement("div",{className:"mx_Slider_label"},this.props.label)))}}var Ve=s(482),Ke=s(195),qe=s(258);class Ge extends o.a.Component{constructor(e){super(e),g()(this,"onChange",async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}),g()(this,"checkBoxOnChange",e=>{this.onChange(e.target.checked)}),g()(this,"save",async e=>{await w.a.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)}),this.state={value:w.a.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){const e=w.a.canSetValue(this.props.name,this.props.roomId,this.props.level);let t=this.props.label;return t=t?Object(c.a)(t):w.a.getDisplayName(this.props.name,this.props.level),this.props.useCheckbox?o.a.createElement(we.a,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!e},t):o.a.createElement("div",{className:"mx_SettingsFlag"},o.a.createElement("span",{className:"mx_SettingsFlag_label"},t),o.a.createElement(qe.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!e,"aria-label":t}))}}var We=s(81),He=s(209),$e=s(141);class ze extends o.a.Component{constructor(e){super(e),this.state={userId:"@erim:fink.fink",displayname:"Erimayas Fink",avatar_url:null}}async componentDidMount(){const e=L.a.get(),t=e.getUserId(),s=await e.getProfileInfo(t),n=He.c({avatarUrl:s.avatar_url},32,32,"crop");this.setState({userId:t,displayname:s.displayname,avatar_url:n})}fakeEvent({userId:e,displayname:t,avatar_url:s}){const n=new We.b(JSON.parse(`{\n                "type": "m.room.message",\n                "sender": "${e}",\n                "content": {\n                  "m.new_content": {\n                    "msgtype": "m.text",\n                    "body": "${this.props.message}",\n                    "displayname": "${t}",\n                    "avatar_url": "${s}"\n                  },\n                  "msgtype": "m.text",\n                  "body": "${this.props.message}",\n                  "displayname": "${t}",\n                  "avatar_url": "${s}"\n                },\n                "unsigned": {\n                  "age": 97\n                },\n                "event_id": "$9999999999999999999999999999999999999999999",\n                "room_id": "!999999999999999999:matrix.org"\n              }`));return n.sender={name:t,userId:e,getAvatarUrl:(...e)=>s},n}render(){const e=this.fakeEvent(this.state),t=E()(this.props.className,{mx_IRCLayout:this.props.useIRCLayout,mx_GroupLayout:!this.props.useIRCLayout});return o.a.createElement("div",{className:t},o.a.createElement($e.a,{mxEvent:e,useIRCLayout:this.props.useIRCLayout}))}}var Ye=function({name:e,definitions:t,value:s,className:n,outlined:i,onChange:r}){const a=e=>{r(e.target.value)};return o.a.createElement(o.a.Fragment,null,t.map(t=>o.a.createElement(o.a.Fragment,{key:t.value},o.a.createElement(Ke.a,{className:E()(n,t.className),onChange:a,checked:void 0!==t.checked?t.checked:t.value===s,name:e,value:t.value,disabled:t.disabled,outlined:i},t.label),t.description)))};function Je(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Qe(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Je(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Je(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class Xe extends o.a.Component{constructor(e){super(e),g()(this,"MESSAGE_PREVIEW_TEXT",Object(c.a)("Hey you. You're the best!")),g()(this,"themeTimer",void 0),g()(this,"onThemeChange",e=>{if(this.state.theme===e)return;const t=w.a.getValue("theme");w.a.setValue("theme",null,je.a.DEVICE,e).catch(()=>{u.a.dispatch({action:h.a.RecheckTheme}),this.setState({theme:t})}),this.setState({theme:e}),u.a.dispatch({action:h.a.RecheckTheme,forceTheme:e})}),g()(this,"onUseSystemThemeChanged",e=>{this.setState({useSystemTheme:e}),w.a.setValue("use_system_theme",null,je.a.DEVICE,e),u.a.dispatch({action:h.a.RecheckTheme})}),g()(this,"onFontSizeChanged",e=>{this.setState({fontSize:e.toString()}),w.a.setValue("baseFontSize",null,je.a.DEVICE,e-Ve.a.SIZE_DIFF)}),g()(this,"onValidateFontSize",async({value:e})=>{const t=parseFloat(e),s=Ve.a.MIN_SIZE+Ve.a.SIZE_DIFF,n=Ve.a.MAX_SIZE+Ve.a.SIZE_DIFF;return isNaN(t)?{valid:!1,feedback:Object(c.a)("Size must be a number")}:s<=t&&t<=n?(w.a.setValue("baseFontSize",null,je.a.DEVICE,parseInt(e,10)-Ve.a.SIZE_DIFF),{valid:!0,feedback:Object(c.a)("Use between %(min)s pt and %(max)s pt",{min:s,max:n})}):{valid:!1,feedback:Object(c.a)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:s,max:n})}}),g()(this,"onAddCustomTheme",async()=>{let e=w.a.getValue("custom_themes");e||(e=[]),e=e.map(e=>e),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),s=await t.json();if(!s||"string"!=typeof s.name||"object"!=typeof s.colors)return void this.setState({customThemeMessage:{text:Object(c.a)("Invalid theme schema."),isError:!0}});e.push(s)}catch(e){return console.error(e),void this.setState({customThemeMessage:{text:Object(c.a)("Error downloading theme information."),isError:!0}})}await w.a.setValue("custom_themes",null,je.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(c.a)("Theme added!"),isError:!1}}),this.themeTimer=setTimeout(()=>{this.setState({customThemeMessage:{text:"",isError:!1}})},3e3)}),g()(this,"onCustomThemeChange",e=>{this.setState({customThemeUrl:e.target.value})}),g()(this,"onLayoutChange",e=>{const t="true"===e.target.value;this.setState({useIRCLayout:t}),w.a.setValue("useIRCLayout",null,je.a.DEVICE,t)}),g()(this,"renderLayoutSection",()=>o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Layout"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Message layout")),o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_Layout_RadioButtons"},o.a.createElement("div",{className:E()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:this.state.useIRCLayout})},o.a.createElement(ze,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:!0}),o.a.createElement(Ke.a,{name:"layout",value:"true",checked:this.state.useIRCLayout,onChange:this.onLayoutChange},Object(c.a)("Compact"))),o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_spacer"}),o.a.createElement("div",{className:E()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:!this.state.useIRCLayout})},o.a.createElement(ze,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:!1}),o.a.createElement(Ke.a,{name:"layout",value:"false",checked:!this.state.useIRCLayout,onChange:this.onLayoutChange},Object(c.a)("Modern")))))),this.state=Qe(Qe({fontSize:(w.a.getValue("baseFontSize",null)+Ve.a.SIZE_DIFF).toString()},this.calculateThemeState()),{},{customThemeUrl:"",customThemeMessage:{isError:!1,text:""},useCustomFontSize:w.a.getValue("useCustomFontSize"),useSystemFont:w.a.getValue("useSystemFont"),systemFont:w.a.getValue("systemFont"),showAdvanced:!1,useIRCLayout:w.a.getValue("useIRCLayout")})}calculateThemeState(){const e=w.a.getValue("theme"),t=w.a.getValueAt(je.a.DEVICE,"use_system_theme",null,!1,!0),s=w.a.getValueAt(je.a.DEVICE,"theme",null,!1,!0);return t?{theme:e,useSystemTheme:!0}:s?{theme:e,useSystemTheme:!1}:{theme:e,useSystemTheme:w.a.getValueAt(je.a.DEVICE,"use_system_theme")}}renderThemeSection(){let e,t;if((new Le.a).isSystemThemeSupported()&&(e=o.a.createElement("div",null,o.a.createElement(we.a,{checked:this.state.useSystemTheme,onChange:e=>this.onUseSystemThemeChanged(e.target.checked)},w.a.getDisplayName("use_system_theme")))),w.a.getValue("feature_custom_themes")){let e=null;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?o.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):o.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),t=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("form",{onSubmit:this.onAddCustomTheme},o.a.createElement(le.a,{label:Object(c.a)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),o.a.createElement(Z.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(c.a)("Add theme")),e))}const s=Object.entries(Object(Me.b)()).map(e=>({id:e[0],name:e[1]})),n=s.filter(e=>!e.id.startsWith("custom-")),i=s.filter(e=>!n.includes(e)).sort((e,t)=>e.name.localeCompare(t.name)),r=[...n,...i];return o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_themeSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Theme")),e,o.a.createElement("div",{className:"mx_ThemeSelectors"},o.a.createElement(Ye,{name:"theme",definitions:r.map(e=>({value:e.id,label:e.name,disabled:this.state.useSystemTheme,className:"mx_ThemeSelector_"+e.id})),onChange:this.onThemeChange,value:this.state.useSystemTheme?void 0:this.state.theme,outlined:!0})),t)}renderFontSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_fontScaling"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Font size")),o.a.createElement(ze,{className:"mx_AppearanceUserSettingsTab_fontSlider_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:this.state.useIRCLayout}),o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider"},o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_smallText"},"Aa"),o.a.createElement(Fe,{values:[13,14,15,16,18],value:parseInt(this.state.fontSize,10),onSelectionChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize}),o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_largeText"},"Aa")),o.a.createElement(Ge,{name:"useCustomFontSize",level:je.a.ACCOUNT,onChange:e=>this.setState({useCustomFontSize:e}),useCheckbox:!0}),o.a.createElement(le.a,{type:"number",label:Object(c.a)("Font size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_SettingsTab_customFontSizeField"}))}renderAdvancedSection(){const e=l.a.get().brand,t=o.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_AdvancedToggle",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced})},this.state.showAdvanced?"Hide advanced":"Show advanced");let s;if(this.state.showAdvanced){const t=Object(c.a)("Set the name of a font installed on your system & %(brand)s will attempt to use it.",{brand:e});s=o.a.createElement(o.a.Fragment,null,o.a.createElement(Ge,{name:"useCompactLayout",level:je.a.DEVICE,useCheckbox:!0,disabled:this.state.useIRCLayout}),o.a.createElement(Ge,{name:"useIRCLayout",level:je.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useIRCLayout:e})}),o.a.createElement(Ge,{name:"useSystemFont",level:je.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),o.a.createElement(le.a,{className:"mx_AppearanceUserSettingsTab_systemFont",label:w.a.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),w.a.setValue("systemFont",null,je.a.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Advanced"},t,s)}render(){const e=l.a.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Customise your appearance")),o.a.createElement("div",{className:"mx_SettingsTab_SubHeading"},Object(c.a)("Appearance Settings only affect this %(brand)s session.",{brand:e})),this.renderThemeSection(),this.renderFontSection(),this.renderAdvancedSection())}}var Ze=s(87),et=s(98);class tt extends o.a.Component{constructor(...e){super(...e),g()(this,"_onUnignoreClicked",e=>{this.props.onUnignored(this.props.userId)})}render(){const e="mx_SecurityUserSettingsTab_ignoredUser_"+this.props.userId;return o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},o.a.createElement(Z.a,{onClick:this._onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(c.a)("Unignore")),o.a.createElement("span",{id:e},this.props.userId))}}g()(tt,"propTypes",{userId:re.a.string.isRequired,onUnignored:re.a.func.isRequired,inProgress:re.a.bool.isRequired});class st extends o.a.Component{constructor(){super(),g()(this,"_updateBlacklistDevicesFlag",e=>{L.a.get().setGlobalBlacklistUnverifiedDevices(e)}),g()(this,"_updateAnalytics",e=>{e?ve.a.enable():ve.a.disable()}),g()(this,"_onExportE2eKeysClicked",()=>{ke.a.createTrackedDialogAsync("Export E2E Keys","",s.e(1).then(s.bind(null,1165)),{matrixClient:L.a.get()})}),g()(this,"_onImportE2eKeysClicked",()=>{ke.a.createTrackedDialogAsync("Import E2E Keys","",s.e(21).then(s.bind(null,1166)),{matrixClient:L.a.get()})}),g()(this,"_onGoToUserProfileClick",()=>{u.a.dispatch({action:"view_user_info",userId:L.a.get().getUserId()}),this.props.closeSettingsFn()}),g()(this,"_onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:s}=this.state,n=t.filter(e=>!s.includes(e)),i=n.indexOf(e);-1!==i&&(n.splice(i,1),this.setState(({waitingUnignored:t})=>({waitingUnignored:[...t,e]})),L.a.get().setIgnoredUsers(n))}),g()(this,"_getInvitedRooms",()=>L.a.get().getRooms().filter(e=>e.hasMembershipState(L.a.get().getUserId(),"invite"))),g()(this,"_manageInvites",async e=>{this.setState({managingInvites:!0});const t=this._getInvitedRooms().map(e=>e.roomId),s=this,n=L.a.get(),i=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await i(n).then(()=>{this.setState({invitedRoomAmt:s.state.invitedRoomAmt-1})},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(Ze.c)(t.retry_after_ms||2500),e--):console.warn(t)})}this.setState({managingInvites:!1})}),g()(this,"_onAcceptAllInvitesClicked",e=>{this._manageInvites(!0)}),g()(this,"_onRejectAllInvitesClicked",e=>{this._manageInvites(!1)});const e=this._getInvitedRooms();this.state={ignoredUserIds:L.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomAmt:e.length},this._onAction=this._onAction.bind(this)}_onAction({action:e}){if("ignore_state_changed"===e){const e=L.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}componentDidMount(){this.dispatcherRef=u.a.register(this._onAction)}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}_renderCurrentDeviceInfo(){const e=d.getComponent("views.elements.SettingsFlag"),t=L.a.get(),s=t.deviceId;let n=t.getDeviceEd25519Key();n=n?T.e(n):Object(c.a)("<not supported>");let i=null;return t.isCryptoEnabled()&&(i=o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_importExportButtons"},o.a.createElement(Z.a,{kind:"primary",onClick:this._onExportE2eKeysClicked},Object(c.a)("Export E2E room keys")),o.a.createElement(Z.a,{kind:"primary",onClick:this._onImportE2eKeysClicked},Object(c.a)("Import E2E room keys")))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Cryptography")),o.a.createElement("ul",{className:"mx_SettingsTab_subsectionText mx_SecurityUserSettingsTab_deviceInfo"},o.a.createElement("li",null,o.a.createElement("label",null,Object(c.a)("Session ID:")),o.a.createElement("span",null,o.a.createElement("code",null,s))),o.a.createElement("li",null,o.a.createElement("label",null,Object(c.a)("Session key:")),o.a.createElement("span",null,o.a.createElement("code",null,o.a.createElement("b",null,n))))),i,o.a.createElement(e,{name:"blacklistUnverifiedDevices",level:je.a.DEVICE,onChange:this._updateBlacklistDevicesFlag}))}_renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state;if(!t||0===t.length)return null;const s=t.map(t=>o.a.createElement(tt,{userId:t,onUnignored:this._onUserUnignored,key:t,inProgress:e.includes(t)}));return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},s))}_renderManageInvites(){if(0===this.state.invitedRoomAmt)return null;const e=this._getInvitedRooms(),t=d.getComponent("elements.InlineSpinner"),s=this._onAcceptAllInvitesClicked.bind(this,e),n=this._onRejectAllInvitesClicked.bind(this,e);return o.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Bulk options")),o.a.createElement(Z.a,{onClick:s,kind:"primary",disabled:this.state.managingInvites},Object(c.a)("Accept all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),o.a.createElement(Z.a,{onClick:n,kind:"danger",disabled:this.state.managingInvites},Object(c.a)("Reject all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),this.state.managingInvites?o.a.createElement(t,null):o.a.createElement("div",null))}render(){const e=l.a.get().brand,t=d.getComponent("views.settings.DevicesPanel"),s=d.getComponent("views.elements.SettingsFlag"),n=d.getComponent("views.settings.EventIndexPanel"),i=d.getComponent("views.settings.KeyBackupPanel"),r=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Key backup")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(i,null))),a=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Message search")),o.a.createElement(n,null)),u=d.getComponent("views.settings.CrossSigningPanel"),h=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Cross-signing")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(u,null))),m=d.getComponent("views.settings.E2eAdvancedPanel");let p;return Object(et.e)()||(p=o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(c.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),o.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},p,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Where you’re logged in")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",null,Object(c.a)("Manage the names of and sign out of your sessions below or <a>verify them in your User Profile</a>.",{},{a:e=>o.a.createElement(Z.a,{kind:"link",onClick:this._onGoToUserProfileClick},e)})),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("A session's public name is visible to people you communicate with"),o.a.createElement(t,null))),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Encryption")),o.a.createElement("div",{className:"mx_SettingsTab_section"},r,a,h,this._renderCurrentDeviceInfo()),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Privacy")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Analytics")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s collects anonymous analytics to allow us to improve the application.",{brand:e})," ",Object(c.a)("Privacy is important to us, so we don't collect any personal or identifiable data for our analytics."),o.a.createElement(Z.a,{className:"mx_SettingsTab_linkBtn",onClick:ve.a.showDetailsModal},Object(c.a)("Learn more about how we use analytics."))),o.a.createElement(s,{name:"analyticsOptIn",level:je.a.DEVICE,onChange:this._updateAnalytics})),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_section"},this._renderIgnoredUsers(),this._renderManageInvites(),o.a.createElement(m,null)))}}g()(st,"propTypes",{closeSettingsFn:re.a.func.isRequired});class nt extends o.a.Component{constructor(){super()}render(){const e=d.getComponent("views.settings.Notifications");return o.a.createElement("div",{className:"mx_SettingsTab mx_NotificationUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Notifications")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(e,null)))}}class it extends o.a.Component{constructor(){super(),g()(this,"_onAutoLaunchChange",e=>{Re.a.get().setAutoLaunchEnabled(e).then(()=>this.setState({autoLaunch:e}))}),g()(this,"_onAlwaysShowMenuBarChange",e=>{Re.a.get().setAutoHideMenuBarEnabled(!e).then(()=>this.setState({alwaysShowMenuBar:e}))}),g()(this,"_onMinimizeToTrayChange",e=>{Re.a.get().setMinimizeToTrayEnabled(e).then(()=>this.setState({minimizeToTray:e}))}),g()(this,"_onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),w.a.setValue("autocompleteDelay",null,je.a.DEVICE,e.target.value)}),g()(this,"_onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),w.a.setValue("readMarkerInViewThresholdMs",null,je.a.DEVICE,e.target.value)}),g()(this,"_onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),w.a.setValue("readMarkerOutOfViewThresholdMs",null,je.a.DEVICE,e.target.value)}),this.state={autoLaunch:!1,autoLaunchSupported:!1,alwaysShowMenuBar:!0,alwaysShowMenuBarSupported:!1,minimizeToTray:!0,minimizeToTraySupported:!1,autocompleteDelay:w.a.getValueAt(je.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:w.a.getValueAt(je.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:w.a.getValueAt(je.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}async componentDidMount(){const e=Re.a.get(),t=await e.supportsAutoLaunch();let s=!1;t&&(s=await e.getAutoLaunchEnabled());const n=await e.supportsAutoHideMenuBar();let i=!0;n&&(i=!await e.getAutoHideMenuBarEnabled());const o=await e.supportsMinimizeToTray();let r=!0;o&&(r=await e.getMinimizeToTrayEnabled()),this.setState({autoLaunch:s,autoLaunchSupported:t,alwaysShowMenuBarSupported:n,alwaysShowMenuBar:i,minimizeToTraySupported:o,minimizeToTray:r})}_renderGroup(e){const t=d.getComponent("views.elements.SettingsFlag");return e.map(e=>o.a.createElement(t,{key:e,name:e,level:je.a.ACCOUNT}))}render(){let e=null;this.state.autoLaunchSupported&&(e=o.a.createElement(De.a,{value:this.state.autoLaunch,onChange:this._onAutoLaunchChange,label:Object(c.a)("Start automatically after system login")}));let t=null;this.state.alwaysShowMenuBarSupported&&(t=o.a.createElement(De.a,{value:this.state.alwaysShowMenuBar,onChange:this._onAlwaysShowMenuBarChange,label:Object(c.a)("Always show the window menu bar")}));let s=null;return this.state.minimizeToTraySupported&&(s=o.a.createElement(De.a,{value:this.state.minimizeToTray,onChange:this._onMinimizeToTrayChange,label:Object(c.a)("Show tray icon and minimize window to it on close")})),o.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Preferences")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room list")),this._renderGroup(it.ROOM_LIST_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Composer")),this._renderGroup(it.COMPOSER_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Timeline")),this._renderGroup(it.TIMELINE_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Advanced")),this._renderGroup(it.ADVANCED_SETTINGS),s,t,e,o.a.createElement(le.a,{label:Object(c.a)("Autocomplete delay (ms)"),type:"number",value:this.state.autocompleteDelay,onChange:this._onAutocompleteDelayChange}),o.a.createElement(le.a,{label:Object(c.a)("Read Marker lifetime (ms)"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this._onReadMarkerInViewThresholdMs}),o.a.createElement(le.a,{label:Object(c.a)("Read Marker off-screen lifetime (ms)"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this._onReadMarkerOutOfViewThresholdMs})))}}g()(it,"ROOM_LIST_SETTINGS",["breadcrumbs"]),g()(it,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.suggestEmoji","sendTypingNotifications"]),g()(it,"TIMELINE_SETTINGS",["showTypingNotifications","autoplayGifsAndVideos","urlPreviewsEnabled","TextualBody.enableBigEmoji","showReadReceipts","showTwelveHourTimestamps","alwaysShowTimestamps","showRedactions","enableSyntaxHighlightLanguageDetection","showJoinLeaves","showAvatarChanges","showDisplaynameChanges","showImages"]),g()(it,"ADVANCED_SETTINGS",["alwaysShowEncryptionIcons","Pill.shouldShowPillAvatar","TagPanel.enableTagPanel","promptBeforeInviteUnknownUsers"]);var ot=async function(){return(await navigator.mediaDevices.enumerateDevices()).some(e=>!!e.label)},rt=function(){return navigator.mediaDevices.enumerateDevices().then((function(e){const t=[],s=[],n=[];return e.forEach(e=>{switch(e.kind){case"audiooutput":t.push(e);break;case"audioinput":s.push(e);break;case"videoinput":n.push(e)}}),{audiooutput:t,audioinput:s,videoinput:n}}),e=>{console.log("Unable to refresh WebRTC Devices: ",e)})},at=function(){const e=w.a.getValue("webrtc_audiooutput"),t=w.a.getValue("webrtc_audioinput"),s=w.a.getValue("webrtc_videoinput");de.t(e),de.s(t),de.u(s)},ct=function(e){w.a.setValue("webrtc_audiooutput",null,je.a.DEVICE,e),de.t(e)},lt=function(e){w.a.setValue("webrtc_audioinput",null,je.a.DEVICE,e),de.s(e)},dt=function(e){w.a.setValue("webrtc_videoinput",null,je.a.DEVICE,e),de.u(e)},ut=function(){return w.a.getValueAt(je.a.DEVICE,"webrtc_audiooutput")},ht=function(){return w.a.getValueAt(je.a.DEVICE,"webrtc_audioinput")},mt=function(){return w.a.getValueAt(je.a.DEVICE,"webrtc_videoinput")};class pt extends o.a.Component{constructor(){super(),g()(this,"_refreshMediaDevices",async e=>{this.setState({mediaDevices:await rt(),activeAudioOutput:ut(),activeAudioInput:ht(),activeVideoInput:mt()}),e&&e.getTracks().forEach(e=>e.stop())}),g()(this,"_requestMediaPermissions",async()=>{let e,t,s;try{e={video:!0,audio:!0},t=await navigator.mediaDevices.getUserMedia(e)}catch(n){if("NotFoundError"===n.name){e={audio:!0};try{t=await navigator.mediaDevices.getUserMedia(e)}catch(e){s=e}}else s=n}if(s){const e=l.a.get().brand,t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("No media permissions","",t,{title:Object(c.a)("No media permissions"),description:Object(c.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}else this._refreshMediaDevices(t)}),g()(this,"_setAudioOutput",e=>{ct(e.target.value),this.setState({activeAudioOutput:e.target.value})}),g()(this,"_setAudioInput",e=>{lt(e.target.value),this.setState({activeAudioInput:e.target.value})}),g()(this,"_setVideoInput",e=>{dt(e.target.value),this.setState({activeVideoInput:e.target.value})}),g()(this,"_changeWebRtcMethod",e=>{L.a.get().setForceTURN(!e)}),g()(this,"_changeFallbackICEServerAllowed",e=>{L.a.get().setFallbackICEServerAllowed(e)}),this.state={mediaDevices:!1,activeAudioOutput:null,activeAudioInput:null,activeVideoInput:null}}async componentDidMount(){await ot()&&this._refreshMediaDevices()}_renderDeviceOptions(e,t){return e.map(e=>o.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}render(){const e=d.getComponent("views.elements.SettingsFlag");let t=null,s=null,n=null,i=null;if(!1===this.state.mediaDevices)t=o.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},o.a.createElement("p",null,Object(c.a)("Missing media permissions, click the button below to request.")),o.a.createElement(Z.a,{onClick:this._requestMediaPermissions,kind:"primary"},Object(c.a)("Request media permissions")));else if(this.state.mediaDevices){s=o.a.createElement("p",null,Object(c.a)("No Audio Outputs detected")),n=o.a.createElement("p",null,Object(c.a)("No Microphones detected")),i=o.a.createElement("p",null,Object(c.a)("No Webcams detected"));const e={deviceId:"",label:Object(c.a)("Default Device")},t=t=>t.some(e=>"default"===e.deviceId)?"default":(t.unshift(e),""),r=this.state.mediaDevices.audiooutput.slice(0);if(r.length>0){const e=t(r);s=o.a.createElement(le.a,{element:"select",label:Object(c.a)("Audio Output"),value:this.state.activeAudioOutput||e,onChange:this._setAudioOutput},this._renderDeviceOptions(r,"audioOutput"))}const a=this.state.mediaDevices.audioinput.slice(0);if(a.length>0){const e=t(a);n=o.a.createElement(le.a,{element:"select",label:Object(c.a)("Microphone"),value:this.state.activeAudioInput||e,onChange:this._setAudioInput},this._renderDeviceOptions(a,"audioInput"))}const l=this.state.mediaDevices.videoinput.slice(0);if(l.length>0){const e=t(l);i=o.a.createElement(le.a,{element:"select",label:Object(c.a)("Camera"),value:this.state.activeVideoInput||e,onChange:this._setVideoInput},this._renderDeviceOptions(l,"videoInput"))}}return o.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Voice & Video")),o.a.createElement("div",{className:"mx_SettingsTab_section"},t,s,n,i,o.a.createElement(e,{name:"VideoView.flipVideoHorizontally",level:je.a.ACCOUNT}),o.a.createElement(e,{name:"webRtcAllowPeerToPeer",level:je.a.DEVICE,onChange:this._changeWebRtcMethod}),o.a.createElement(e,{name:"fallbackICEServerAllowed",level:je.a.DEVICE,onChange:this._changeFallbackICEServerAllowed})))}}var gt=s(338),ft=s(180);var _t=s(181);function vt(){Re.a.get().installUpdate()}const yt=[ft.c.Ready,ft.c.Error,ft.c.NotAvailable];var bt=()=>{const[e,t]=Object(i.useState)(null);((e,t)=>{const s=Object(i.useRef)(e=>{});Object(i.useEffect)(()=>{s.current=t},[t]),Object(i.useEffect)(()=>{const t=e.register(e=>s.current(e));return()=>{e.unregister(t)}},[e])})(u.a,e=>{let{action:s}=e,n=K()(e,["action"]);s===h.a.CheckUpdates&&t(n)});const s=e&&!yt.includes(e.status);let n;return e&&(n=o.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case ft.c.Error:return Object(c.a)("Error encountered (%(errorDetail)s).",{errorDetail:t});case ft.c.Checking:return Object(c.a)("Checking for an update...");case ft.c.NotAvailable:return Object(c.a)("No update available.");case ft.c.Downloading:return Object(c.a)("Downloading update...");case ft.c.Ready:return Object(c.a)("New version available. <a>Update now.</a>",{},{a:e=>o.a.createElement(Z.a,{kind:"link",onClick:vt},e)})}}(e.status,e.detail),s&&o.a.createElement(_t.a,null))),o.a.createElement(o.a.Fragment,null,o.a.createElement(Z.a,{onClick:()=>{t(null),Re.a.get().startUpdateCheck()},kind:"primary",disabled:s},Object(c.a)("Check for update")),n)};class Et extends o.a.Component{constructor(){super(),g()(this,"_onClearCacheAndReload",e=>{Re.a.get()&&(console.log("Clear cache & reload clicked"),L.a.get().stopClient(),L.a.get().store.deleteAllData().then(()=>{Re.a.get().reload()}))}),g()(this,"_onBugReport",e=>{const t=d.getComponent("dialogs.BugReportDialog");t&&ke.a.createTrackedDialog("Bug Report Dialog","",t,{})}),g()(this,"_onStartBotChat",e=>{this.props.closeSettingsFn(),Object(et.b)({dmUserId:l.a.get().welcomeUserId,andView:!0})}),g()(this,"_showSpoiler",e=>{const t=e.target;t.innerHTML=t.getAttribute("data-spoiler");const s=document.createRange();s.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(s)}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){Re.a.get().getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{console.error("Error getting vector version: ",e)}),Re.a.get().canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{console.error("Error getting self updatability: ",e)})}_renderLegal(){if(!l.a.get().terms_and_conditions_links)return null;const e=[];for(const t of l.a.get().terms_and_conditions_links)e.push(o.a.createElement("div",{key:t.url},o.a.createElement("a",{href:t.url,rel:"noreferrer noopener",target:"_blank"},t.text)));return o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Legal")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},e))}_renderCredits(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Credits")),o.a.createElement("ul",null,o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},"default cover photo")," is © ",o.a.createElement("a",{href:"https://www.flickr.com/golan",rel:"noreferrer noopener",target:"_blank"},"Jesús Roncero")," ","used under the terms of ",o.a.createElement("a",{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY-SA 4.0"),"."),o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"}," twemoji-colr")," font is © ",o.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," ","used under the terms of ",o.a.createElement("a",{href:"http://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),o.a.createElement("li",null,"The ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," emoji art is © ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," used under the terms of ",o.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}render(){const e=l.a.get().brand;let t=Object(c.a)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)});l.a.get().welcomeUserId&&Object(c.d)().startsWith("en")&&(t=o.a.createElement("div",null,Object(c.a)("For help with using %(brand)s, click <a>here</a> or start a chat with our bot using the button below.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)}),o.a.createElement("div",null,o.a.createElement(Z.a,{onClick:this._onStartBotChat,kind:"primary"},Object(c.a)("Chat with %(brand)s Bot",{brand:e})))));const s=this.state.appVersion||"unknown";let n=L.a.get().olmVersion;n=n?`${n[0]}.${n[1]}.${n[2]}`:"<not-enabled>";let i=null;return this.state.canUpdate&&(i=o.a.createElement(bt,null)),o.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Help & About")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Bug reporting")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages."),o.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},o.a.createElement(Z.a,{onClick:this._onBugReport,kind:"primary"},Object(c.a)("Submit debug logs"))),o.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},o.a.createElement(Z.a,{onClick:this._onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))),Object(c.a)("To report a Matrix-related security issue, please read the Matrix.org <a>Security Disclosure Policy</a>.",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)}))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("FAQ")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t),o.a.createElement(Z.a,{kind:"primary",onClick:gt.d},Object(c.a)("Keyboard Shortcuts"))),o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Versions")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s version:",{brand:e})," ",s,o.a.createElement("br",null),Object(c.a)("olm version:")," ",n,o.a.createElement("br",null),i)),this._renderLegal(),this._renderCredits(),o.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Homeserver is")," ",o.a.createElement("code",null,L.a.get().getHomeserverUrl()),o.a.createElement("br",null),Object(c.a)("Identity Server is")," ",o.a.createElement("code",null,L.a.get().getIdentityServerUrl()),o.a.createElement("br",null),Object(c.a)("Access Token:")+" ",o.a.createElement(Z.a,{element:"span",onClick:this._showSpoiler,"data-spoiler":L.a.get().getAccessToken()},"<",Object(c.a)("click to reveal"),">"))))}}g()(Et,"propTypes",{closeSettingsFn:re.a.func.isRequired});class St extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{error:null,groups:null})}componentDidMount(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups||[],error:null})},e=>{console.error(e),this.setState({groups:null,error:e})})}render(){let e="",t=null;const s=this.state.groups;if(this.state.error)e=Object(c.a)("Something went wrong when trying to get your communities.");else if(null===s)e=Object(c.a)("Loading...");else if(s.length>0){const n=d.getComponent("groups.GroupPublicityToggle");t=s.map((e,t)=>o.a.createElement(n,{key:t,groupId:e})),e=Object(c.a)("Display your community flair in rooms configured to show it.")}else e=Object(c.a)("You're not currently a member of any communities.");return o.a.createElement("div",null,o.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},e),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}}g()(St,"contextType",S.a);class wt extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("span",{className:"mx_SettingsTab_heading"},Object(c.a)("Flair")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(St,null)))}}var Ct=s(330),Rt=(s(551),s(252));class kt extends o.a.Component{constructor(){super(),g()(this,"_onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),g()(this,"_onNewListChanged",e=>{this.setState({newList:e.target.value})}),g()(this,"_onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=Rt.d;this.state.newPersonalRule.startsWith("@")&&(t=Rt.e),this.setState({busy:!0});try{const e=await Ct.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(c.a)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to add Mjolnir rule","",t,{title:Object(c.a)("Error adding ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}),g()(this,"_onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await L.a.get().joinRoom(this.state.newList);await Ct.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to subscribe to Mjolnir list","",t,{title:Object(c.a)("Error subscribing to list"),description:Object(c.a)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async _removePersonalRule(e){this.setState({busy:!0});try{const t=Ct.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove Mjolnir rule","",t,{title:Object(c.a)("Error removing ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async _unsubscribeFromList(e){this.setState({busy:!0});try{await Ct.a.sharedInstance().unsubscribeFromList(e.roomId),await L.a.get().leave(e.roomId)}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to unsubscribe from Mjolnir list","",t,{title:Object(c.a)("Error unsubscribing from list"),description:Object(c.a)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}_viewListRules(e){const t=d.getComponent("dialogs.QuestionDialog"),s=L.a.get().getRoom(e.roomId),n=s?s.name:e.roomId,i=e=>{if(0===e.length)return o.a.createElement("i",null,Object(c.a)("None"));const t=[];for(const s of e)t.push(o.a.createElement("li",{key:s.kind+s.entity},o.a.createElement("code",null,s.entity)));return o.a.createElement("ul",null,t)};ke.a.createTrackedDialog("View Mjolnir list rules","",t,{title:Object(c.a)("Ban list rules - %(roomName)s",{roomName:n}),description:o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Server rules")),i(e.serverRules),o.a.createElement("h3",null,Object(c.a)("User rules")),i(e.userRules)),button:Object(c.a)("Close"),hasCancelButton:!1})}_renderPersonalBanListRules(){const e=d.getComponent("elements.AccessibleButton"),t=Ct.a.sharedInstance().getPersonalList(),s=t?[...t.userRules,...t.serverRules]:[];if(!t||s.length<=0)return o.a.createElement("i",null,Object(c.a)("You have not ignored anyone."));const n=[];for(const t of s)n.push(o.a.createElement("li",{key:t.entity,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(e,{kind:"danger_sm",onClick:()=>this._removePersonalRule(t),disabled:this.state.busy},Object(c.a)("Remove"))," ",o.a.createElement("code",null,t.entity)));return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are currently ignoring:")),o.a.createElement("ul",null,n))}_renderSubscribedBanLists(){const e=d.getComponent("elements.AccessibleButton"),t=Ct.a.sharedInstance().getPersonalList(),s=Ct.a.sharedInstance().lists.filter(e=>!t||t.roomId!==e.roomId);if(!s||s.length<=0)return o.a.createElement("i",null,Object(c.a)("You are not subscribed to any lists"));const n=[];for(const t of s){const s=L.a.get().getRoom(t.roomId),i=s?o.a.createElement("span",null,s.name," (",o.a.createElement("code",null,t.roomId),")"):o.a.createElement("code",null,"list.roomId");n.push(o.a.createElement("li",{key:t.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(e,{kind:"danger_sm",onClick:()=>this._unsubscribeFromList(t),disabled:this.state.busy},Object(c.a)("Unsubscribe"))," ",o.a.createElement(e,{kind:"primary_sm",onClick:()=>this._viewListRules(t),disabled:this.state.busy},Object(c.a)("View rules"))," ",i))}return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are currently subscribed to:")),o.a.createElement("ul",null,n))}render(){const e=d.getComponent("elements.Field"),t=d.getComponent("elements.AccessibleButton"),s=l.a.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(c.a)("⚠ These settings are meant for advanced users.")),o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:s},{code:e=>o.a.createElement("code",null,e)}),o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Personal ban list")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named 'My Ban List' - stay in this room to keep the ban list in effect.")),o.a.createElement("div",null,this._renderPersonalBanListRules()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this._onAddPersonalRule,autoComplete:"off"},o.a.createElement(e,{type:"text",label:Object(c.a)("Server or user ID to ignore"),placeholder:Object(c.a)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this._onPersonalRuleChanged}),o.a.createElement(t,{type:"submit",kind:"primary",onClick:this._onAddPersonalRule,disabled:this.state.busy},Object(c.a)("Ignore"))))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Subscribed lists")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(c.a)("Subscribing to a ban list will cause you to join it!"))," ",o.a.createElement("span",null,Object(c.a)("If this isn't what you want, please use a different tool to ignore users."))),o.a.createElement("div",null,this._renderSubscribedBanLists()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this._onSubscribeList,autoComplete:"off"},o.a.createElement(e,{type:"text",label:Object(c.a)("Room ID or address of ban list"),value:this.state.newList,onChange:this._onNewListChanged}),o.a.createElement(t,{type:"submit",kind:"primary",onClick:this._onSubscribeList,disabled:this.state.busy},Object(c.a)("Subscribe"))))))}}class It extends o.a.Component{constructor(){super(),this.state={mjolnirEnabled:w.a.getValue("feature_mjolnir")}}componentDidMount(){this._mjolnirWatcher=w.a.watchSetting("feature_mjolnir",null,this._mjolnirChanged.bind(this))}componentWillUnmount(){w.a.unwatchSetting(this._mjolnirWatcher)}_mjolnirChanged(e,t,s,n){this.setState({mjolnirEnabled:n})}_getTabs(){const e=[];return e.push(new ae("USER_GENERAL_TAB",Object(c.b)("General"),"mx_UserSettingsDialog_settingsIcon",o.a.createElement(Pe,{closeSettingsFn:this.props.onFinished}))),e.push(new ae("USER_APPEARANCE_TAB",Object(c.b)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",o.a.createElement(Xe,null))),e.push(new ae("USER_FLAIR_TAB",Object(c.b)("Flair"),"mx_UserSettingsDialog_flairIcon",o.a.createElement(wt,null))),e.push(new ae("USER_NOTIFICATIONS_TAB",Object(c.b)("Notifications"),"mx_UserSettingsDialog_bellIcon",o.a.createElement(nt,null))),e.push(new ae("USER_PREFERENCES_TAB",Object(c.b)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",o.a.createElement(it,null))),e.push(new ae("USER_VOICE_TAB",Object(c.b)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",o.a.createElement(pt,null))),e.push(new ae("USER_SECURITY_TAB",Object(c.b)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",o.a.createElement(st,{closeSettingsFn:this.props.onFinished}))),l.a.get().showLabsSettings&&e.push(new ae("USER_LABS_TAB",Object(c.b)("Labs"),"mx_UserSettingsDialog_labsIcon",o.a.createElement(Ue,null))),this.state.mjolnirEnabled&&e.push(new ae("USER_MJOLNIR_TAB",Object(c.b)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",o.a.createElement(kt,null))),e.push(new ae("USER_HELP_TAB",Object(c.b)("Help & About"),"mx_UserSettingsDialog_helpIcon",o.a.createElement(Et,{closeSettingsFn:this.props.onFinished}))),e}render(){const e=d.getComponent("views.dialogs.BaseDialog");return o.a.createElement(e,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Settings")},o.a.createElement("div",{className:"ms_SettingsDialog_content"},o.a.createElement(ce,{tabs:this._getTabs(),initialTabId:this.props.initialTabId})))}}g()(It,"propTypes",{onFinished:re.a.func.isRequired,initialTabId:re.a.string});var Ot=s(147),Tt=e=>{const t=Object(c.a)("If you run into any bugs or have feedback you'd like to share, please let us know on GitHub."),s=Object(c.a)("To help avoid duplicate issues, please <existingIssuesLink>view existing issues</existingIssuesLink> first (and add a +1) or <newIssueLink>create a new issue</newIssueLink> if you can't find it.",{},{existingIssuesLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues/new"},e)});return o.a.createElement(Ot.a,{hasCancelButton:!1,title:Object(c.a)("Report bugs & give feedback"),description:o.a.createElement("div",null,o.a.createElement("p",null,t),o.a.createElement("p",null,s)),button:Object(c.a)("Go back"),onFinished:e.onFinished})};class xt extends o.a.Component{constructor(){super(),g()(this,"defaultProps",{onFinished:function(){}}),this._onSettingsLinkClick=this._onSettingsLinkClick.bind(this),this._onExportE2eKeysClicked=this._onExportE2eKeysClicked.bind(this),this._onFinished=this._onFinished.bind(this),this._onSetRecoveryMethodClick=this._onSetRecoveryMethodClick.bind(this),this._onLogoutConfirm=this._onLogoutConfirm.bind(this);const e=L.a.get(),t=e.isCryptoEnabled()&&!e.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:t,loading:t,backupInfo:null,error:null},t&&this._loadBackupStatus()}async _loadBackupStatus(){try{const e=await L.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){console.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}_onSettingsLinkClick(){this.props.onFinished()}_onExportE2eKeysClicked(){ke.a.createTrackedDialogAsync("Export E2E Keys","",s.e(1).then(s.bind(null,1165)),{matrixClient:L.a.get()})}_onFinished(e){e&&u.a.dispatch({action:"logout"}),this.props.onFinished()}_onSetRecoveryMethodClick(){if(this.state.backupInfo){const e=d.getComponent("dialogs.keybackup.RestoreKeyBackupDialog");ke.a.createTrackedDialog("Restore Backup","",e,null,null,!1,!0)}else ke.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(0).then(s.bind(null,544)),null,null,!1,!0);this.props.onFinished()}_onLogoutConfirm(){u.a.dispatch({action:"logout"}),this.props.onFinished()}render(){if(this.state.shouldLoadBackupStatus){const e=d.getComponent("views.dialogs.BaseDialog"),t=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),o.a.createElement("p",null,Object(c.a)("Back up your keys before signing out to avoid losing them.")));let s;if(this.state.loading){const e=d.getComponent("views.elements.Spinner");s=o.a.createElement(e,null)}else{const e=d.getComponent("views.elements.DialogButtons");let n;n=this.state.backupInfo?Object(c.a)("Connect this session to Key Backup"):Object(c.a)("Start using Key Backup"),s=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t),o.a.createElement(e,{primaryButton:n,hasCancel:!1,onPrimaryButtonClick:this._onSetRecoveryMethodClick,focus:!0},o.a.createElement("button",{onClick:this._onLogoutConfirm},Object(c.a)("I don't want my encrypted messages"))),o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("p",null,o.a.createElement("button",{onClick:this._onExportE2eKeysClicked},Object(c.a)("Manually export keys")))))}return o.a.createElement(e,{title:Object(c.a)("You'll lose access to your encrypted messages"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this._onFinished},s)}{const e=d.getComponent("views.dialogs.QuestionDialog");return o.a.createElement(e,{hasCancelButton:!0,title:Object(c.a)("Sign out"),description:Object(c.a)("Are you sure you want to sign out?"),button:Object(c.a)("Sign out"),onFinished:this._onFinished})}}}var Nt=s(103),jt=s(63);class Pt extends Nt.a{constructor(){super(u.a,{}),g()(this,"monitoredUser",void 0),g()(this,"onProfileUpdate",async()=>{const e=await this.matrixClient.getProfileInfo(this.matrixClient.getUserId());await this.updateState({displayName:e.displayname,avatarUrl:e.avatar_url})}),g()(this,"onStateEvents",Object(jt.throttle)(async e=>{const t=L.a.get().getUserId();"m.room.member"===e.getType()&&e.getSender()===t&&e.getStateKey()===t&&await this.onProfileUpdate()},200,{trailing:!0,leading:!0}))}static get instance(){return Pt.internalInstance}get displayName(){return this.matrixClient?this.matrixClient.isGuest()?Object(c.a)("Guest"):this.state.displayName?this.state.displayName:this.matrixClient.getUserId():this.state.displayName||null}get avatarMxc(){return this.state.avatarUrl||null}getHttpAvatarUrl(e){return this.avatarMxc?this.matrixClient.mxcUrlToHttp(this.avatarMxc,e,e):null}async onNotReady(){this.monitoredUser&&(this.monitoredUser.removeListener("User.displayName",this.onProfileUpdate),this.monitoredUser.removeListener("User.avatarUrl",this.onProfileUpdate)),this.matrixClient&&this.matrixClient.removeListener("RoomState.events",this.onStateEvents),await this.reset({})}async onReady(){const e=this.matrixClient.getUserId();this.monitoredUser=this.matrixClient.getUser(e),this.monitoredUser&&(this.monitoredUser.on("User.displayName",this.onProfileUpdate),this.monitoredUser.on("User.avatarUrl",this.onProfileUpdate)),this.matrixClient.on("RoomState.events",this.onStateEvents),await this.onProfileUpdate()}async onAction(e){}}g()(Pt,"internalInstance",new Pt);var Dt=s(86),At=s(213),Ut=s(124),Mt=s(97),Lt=s(70),Ft=s(140),Bt=s(143),Vt=s(88);class Kt extends o.a.PureComponent{constructor(e){super(e),g()(this,"avatarUploadRef",o.a.createRef()),g()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),g()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e=this.state.currentAvatarUrl||"";this.state.avatarFile&&(e=await L.a.get().uploadContent(this.state.avatarFile)),await L.a.get().setGroupProfile(this.props.communityId,{name:this.state.name,avatar_url:e}),await Vt.a.refreshGroupProfile(L.a.get(),this.props.communityId),this.props.onFinished(!0)}catch(e){console.error(e),this.setState({busy:!1,error:Object(c.a)("There was an error updating your community. The server is unable to process your request.")})}}}),g()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),g()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()});const t=Ut.a.instance.getCommunityProfile(e.communityId);this.state={name:(null==t?void 0:t.name)||"",error:null,busy:!1,avatarFile:null,avatarPreview:null,currentAvatarUrl:null==t?void 0:t.avatarUrl}}render(){let e=o.a.createElement("img",{src:this.state.avatarPreview,className:"mx_EditCommunityPrototypeDialog_avatar"});if(!this.state.avatarPreview)if(this.state.currentAvatarUrl){const t=L.a.get().mxcUrlToHttp(this.state.currentAvatarUrl);e=o.a.createElement("img",{src:t,className:"mx_EditCommunityPrototypeDialog_avatar"})}else e=o.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_placeholderAvatar"});return o.a.createElement(Bt.a,{className:"mx_EditCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(c.a)("Update community")},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowName"},o.a.createElement(le.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(c.a)("Enter name"),label:Object(c.a)("Enter name")})),o.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowAvatar"},o.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),o.a.createElement(Z.a,{onClick:this.onChangeAvatar,className:"mx_EditCommunityPrototypeDialog_avatarContainer"},e),o.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_tip"},o.a.createElement("b",null,Object(c.a)("Add image (optional)")),o.a.createElement("span",null,Object(c.a)("An image will help people identify your community.")))),o.a.createElement(Z.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(c.a)("Save")))))}}class qt extends o.a.Component{constructor(e){super(e),g()(this,"dispatcherRef",void 0),g()(this,"themeWatcherRef",void 0),g()(this,"buttonRef",Object(i.createRef)()),g()(this,"tagStoreRef",void 0),g()(this,"onTagStoreUpdate",()=>{this.forceUpdate()}),g()(this,"onProfileUpdate",async()=>{this.forceUpdate()}),g()(this,"onThemeChanged",()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme()})}),g()(this,"onAction",e=>{e.action===h.a.ToggleUserMenu&&(this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click())}),g()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),g()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),g()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),g()(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation(),w.a.setValue("use_system_theme",null,je.a.DEVICE,!1);const t=this.state.isDarkTheme?"light":"dark";w.a.setValue("theme",null,je.a.DEVICE,t)}),g()(this,"onSettingsOpen",(e,t)=>{e.preventDefault(),e.stopPropagation();const s={action:h.a.ViewUserSettings,initialTabId:t};u.a.dispatch(s),this.setState({contextMenuPosition:null})}),g()(this,"onShowArchived",e=>{e.preventDefault(),e.stopPropagation(),console.log("TODO: Show archived rooms")}),g()(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),ke.a.createTrackedDialog("Report bugs & give feedback","",Tt),this.setState({contextMenuPosition:null})}),g()(this,"onSignOutClick",e=>{e.preventDefault(),e.stopPropagation(),ke.a.createTrackedDialog("Logout from LeftPanel","",xt),this.setState({contextMenuPosition:null})}),g()(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_home_page"})}),g()(this,"onCommunitySettingsClick",e=>{e.preventDefault(),e.stopPropagation(),ke.a.createTrackedDialog("Edit Community","",Kt,{communityId:Ut.a.instance.getSelectedCommunityId()}),this.setState({contextMenuPosition:null})}),g()(this,"onCommunityMembersClick",e=>{e.preventDefault(),e.stopPropagation();const t=Ut.a.instance.getSelectedCommunityGeneralChat();t?(u.a.dispatch({action:"view_room",room_id:t.roomId},!0),u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Lt.b.RoomMemberList})):ke.a.createTrackedDialog("Failed to find general chat","",Ft.a,{title:Object(c.a)("Failed to find the general chat for this community"),description:Object(c.a)("Failed to find the general chat for this community")}),this.setState({contextMenuPosition:null})}),g()(this,"onCommunityInviteClick",e=>{e.preventDefault(),e.stopPropagation(),Object(Mt.e)(Ut.a.instance.getSelectedCommunityId()),this.setState({contextMenuPosition:null})}),g()(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;const e=Ut.a.instance.getSelectedCommunityName();let t;const n=ge("user-context-menu");n&&(t=o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},Object(c.a)("<a>Upgrade</a> to your own domain",{},{a:e=>o.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener",tabIndex:-1},e)})));let i=null;this.hasHomePage&&(i=o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(c.a)("Home"),onClick:this.onHomeClick}));let r=o.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},Pt.instance.displayName),o.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},L.a.get().getUserId())),a=o.a.createElement(o.a.Fragment,null,o.a.createElement(At.c,null,i,o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(c.a)("Notification settings"),onClick:e=>this.onSettingsOpen(e,"USER_NOTIFICATIONS_TAB")}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(c.a)("Security & privacy"),onClick:e=>this.onSettingsOpen(e,"USER_SECURITY_TAB")}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("All settings"),onClick:e=>this.onSettingsOpen(e,null)}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(c.a)("Feedback"),onClick:this.onProvideFeedback})),o.a.createElement(At.c,{red:!0},o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(c.a)("Sign out"),onClick:this.onSignOutClick}))),l=null;e&&(r=o.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},e)),a=o.a.createElement(At.c,null,o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("Settings"),"aria-label":Object(c.a)("Community settings"),onClick:this.onCommunitySettingsClick}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconMembers",label:Object(c.a)("Members"),onClick:this.onCommunityMembersClick}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconInvite",label:Object(c.a)("Invite"),onClick:this.onCommunityInviteClick})),l=o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},Pt.instance.displayName),o.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},L.a.get().getUserId()))),o.a.createElement(At.c,null,o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("Settings"),"aria-label":Object(c.a)("User settings"),onClick:e=>this.onSettingsOpen(e,null)}),o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(c.a)("Feedback"),onClick:this.onProvideFeedback})),o.a.createElement(At.c,{red:!0},o.a.createElement(At.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(c.a)("Sign out"),onClick:this.onSignOutClick}))));const d=E()({mx_UserMenu_contextMenu:!0,mx_UserMenu_contextMenu_prototype:!!e});return o.a.createElement(At.e,{left:this.state.contextMenuPosition.width+this.state.contextMenuPosition.left-10,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height+8,onFinished:this.onCloseMenu,className:d},o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},r,o.a.createElement(C.a,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?Object(c.a)("Switch to light mode"):Object(c.a)("Switch to dark mode")},o.a.createElement("img",{src:s(825),alt:Object(c.a)("Switch theme"),width:16}))),t,a,l)}),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme()},Pt.instance.on(Dt.b,this.onProfileUpdate)}get hasHomePage(){return!!Object(a.a)(l.a.get())}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),this.themeWatcherRef=w.a.watchSetting("theme",null,this.onThemeChanged),this.tagStoreRef=f.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.themeWatcherRef&&w.a.unwatchSetting(this.themeWatcherRef),this.dispatcherRef&&u.a.unregister(this.dispatcherRef),Pt.instance.off(Dt.b,this.onProfileUpdate),this.tagStoreRef.remove()}isUserOnDarkTheme(){const e=w.a.getValue("theme");return e.startsWith("custom-")?Object(Me.c)(e.substring("custom-".length)).is_dark:"dark"===e}render(){const e=Pt.instance.displayName||L.a.get().getUserId(),t=Pt.instance.getHttpAvatarUrl(32),s=Ut.a.instance.getSelectedCommunityName();let i=!1,r=Object(c.a)("User menu"),a=o.a.createElement("span",{className:"mx_UserMenu_userName"},e),l=o.a.createElement("span",{className:"mx_UserMenu_headerButtons"});s?(a=o.a.createElement("div",{className:"mx_UserMenu_doubleName"},o.a.createElement("span",{className:"mx_UserMenu_userName"},s),o.a.createElement("span",{className:"mx_UserMenu_subUserName"},e)),r=Object(c.a)("Community and user menu"),i=!0):w.a.getValue("feature_communities_v2_prototypes")&&(a=o.a.createElement("div",{className:"mx_UserMenu_doubleName"},o.a.createElement("span",{className:"mx_UserMenu_userName"},Object(c.a)("Home")),o.a.createElement("span",{className:"mx_UserMenu_subUserName"},e)),i=!0),this.props.isMinimized&&(a=null,l=null);const d=E()({mx_UserMenu:!0,mx_UserMenu_minimized:this.props.isMinimized,mx_UserMenu_prototype:i});return o.a.createElement(o.a.Fragment,null,o.a.createElement(n.c,{className:d,onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:r,isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},o.a.createElement("div",{className:"mx_UserMenu_row"},o.a.createElement("span",{className:"mx_UserMenu_userAvatarContainer"},o.a.createElement(q.a,{idName:e,name:e,url:t,width:32,height:32,resizeMethod:"crop",className:"mx_UserMenu_userAvatar"})),a,l)),this.renderContextMenu())}}var Gt=s(486),Wt=s(1);class Ht extends Nt.a{constructor(){super(u.a),g()(this,"waitingRooms",[]),g()(this,"onMyMembership",async e=>{const t=w.a.getValue("breadcrumbs",null,!0);this.meetsRoomRequirement&&Object(Wt.r)(t)&&await w.a.setValue("breadcrumbs",null,je.a.ACCOUNT,!0)}),g()(this,"onRoom",async e=>{const t=this.waitingRooms.find(t=>t.roomId===e.roomId);t&&(this.waitingRooms.splice(this.waitingRooms.indexOf(t),1),Date.now()-t.addedTs>9e4||await this.appendRoom(e))}),w.a.monitorSetting("breadcrumb_rooms",null),w.a.monitorSetting("breadcrumbs",null)}static get instance(){return Ht.internalInstance}get rooms(){return this.state.rooms||[]}get visible(){return this.state.enabled&&this.meetsRoomRequirement}get meetsRoomRequirement(){return this.matrixClient&&this.matrixClient.getVisibleRooms().length>=20}async onAction(e){if(this.matrixClient)if("setting_updated"===e.action)"breadcrumb_rooms"===e.settingName?await this.updateRooms():"breadcrumbs"===e.settingName&&await this.updateState({enabled:w.a.getValue("breadcrumbs",null)});else if("view_room"===e.action)if(e.auto_join&&!this.matrixClient.getRoom(e.room_id))this.waitingRooms.push({roomId:e.room_id,addedTs:Date.now()});else{const t=this.matrixClient.getRoom(e.room_id);t&&await this.appendRoom(t)}}async onReady(){await this.updateRooms(),await this.updateState({enabled:w.a.getValue("breadcrumbs",null)}),this.matrixClient.on("Room.myMembership",this.onMyMembership),this.matrixClient.on("Room",this.onRoom)}async onNotReady(){this.matrixClient.removeListener("Room.myMembership",this.onMyMembership),this.matrixClient.removeListener("Room",this.onRoom)}async updateRooms(){let e=w.a.getValue("breadcrumb_rooms");e&&0!==e.length||(e=[]);const t=e.map(e=>this.matrixClient.getRoom(e)).filter(e=>!!e),s=this.state.rooms||[];Object(Q.d)(t,s)&&await this.updateState({rooms:t})}async appendRoom(e){let t=!1;const s=(this.state.rooms||[]).slice(),n=this.matrixClient.getRoomUpgradeHistory(e.roomId);if(n.length>1){e=n[n.length-1];for(let e=0;e<n.length-1;e++){const i=s.findIndex(t=>t.roomId===n[e].roomId);-1!==i&&(s.splice(i,1),t=!0)}}const i=s.findIndex(t=>t.roomId===e.roomId);if(0!==i&&(-1!==i&&s.splice(i,1),s.splice(0,0,e),t=!0),s.length>20&&(s.splice(20,s.length-20),t=!0),t){await this.updateState({rooms:s});const e=s.map(e=>e.roomId);e.length>0&&await w.a.setValue("breadcrumb_rooms",null,je.a.ACCOUNT,e)}}}g()(Ht,"internalInstance",new Ht);var $t=s(267),zt=s(826),Yt=s(58);var Jt=e=>{let{children:t}=e,s=K()(e,["children"]);return o.a.createElement(P.c,{handleHomeEnd:!0,onKeyDown:(e,t)=>{const s=e.target;let n=!0;switch(e.key){case Yt.a.ARROW_UP:case Yt.a.ARROW_DOWN:s.hasAttribute("aria-haspopup")&&s.click();break;case Yt.a.ARROW_LEFT:case Yt.a.ARROW_RIGHT:if(t.refs.length>0){const s=t.refs.findIndex(e=>e===t.activeRef),n=e.key===Yt.a.ARROW_RIGHT?1:-1;t.refs.slice((s+n)%t.refs.length)[0].current.focus()}break;default:n=!1}n&&(e.preventDefault(),e.stopPropagation())}},({onKeyDownHandler:e})=>o.a.createElement("div",B()({},s,{onKeyDown:e,role:"toolbar"}),t))};class Qt extends o.a.PureComponent{constructor(e){super(e),g()(this,"isMounted",!0),g()(this,"onBreadcrumbsUpdate",()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),g()(this,"viewRoom",(e,t)=>{ve.a.trackEvent("Breadcrumbs","click_node",t),u.a.dispatch({action:"view_room",room_id:e.roomId})}),this.state={doAnimation:!0,skipFirst:!1},Ht.instance.on(Dt.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,Ht.instance.off(Dt.b,this.onBreadcrumbsUpdate)}render(){const e=Ht.instance.rooms.map((e,t)=>{const s=D.b.instance.getTagsForRoom(e),n=s.includes(U.a.DM)?U.a.DM:s[0];return o.a.createElement(P.b,{className:"mx_RoomBreadcrumbs_crumb",key:e.roomId,onClick:()=>this.viewRoom(e,t),"aria-label":Object(c.a)("Room %(name)s",{name:e.name}),title:e.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip"},o.a.createElement($t.a,{room:e,avatarSize:32,tag:n,displayBadge:!0,forceCount:!0}))});return e.length>0?o.a.createElement(zt.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},o.a.createElement(Jt,{className:"mx_RoomBreadcrumbs"},e.slice(this.state.skipFirst?1:0))):o.a.createElement("div",{className:"mx_RoomBreadcrumbs"},o.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(c.a)("No recently visited rooms")))}}class Xt extends o.a.Component{constructor(e){super(e),g()(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this._scrollElement){const t=0,s=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this._likelyTrackpadUser=!0,this._checkAgainForTrackpad=n+6e4):this._likelyTrackpadUser&&n>=this._checkAgainForTrackpad&&(this._likelyTrackpadUser=!1),this._likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this._scrollElement.scrollLeft+=n*s}}}),this._collectScroller=this._collectScroller.bind(this),this._collectScrollerComponent=this._collectScrollerComponent.bind(this),this.checkOverflow=this.checkOverflow.bind(this),this._scrollElement=null,this._autoHideScrollbar=null,this._likelyTrackpadUser=null,this._checkAgainForTrackpad=0,this.state={leftIndicatorOffset:0,rightIndicatorOffset:0}}moveToOrigin(){this._scrollElement&&(this._scrollElement.scrollLeft=0,this._scrollElement.scrollTop=0)}_collectScroller(e){e&&!this._scrollElement&&(this._scrollElement=e,this._scrollElement.addEventListener("scroll",this.checkOverflow),this.checkOverflow())}_collectScrollerComponent(e){this._autoHideScrollbar=e}componentDidUpdate(e){(e&&e.children&&e.children.length||0)!==(this.props.children&&this.props.children.length||0)&&this.checkOverflow()}componentDidMount(){this.checkOverflow()}checkOverflow(){const e=this._scrollElement.scrollTop>0,t=this._scrollElement.scrollHeight>this._scrollElement.scrollTop+this._scrollElement.clientHeight,s=this._scrollElement.scrollLeft>0,n=this._scrollElement.scrollWidth>this._scrollElement.scrollLeft+this._scrollElement.clientWidth;e?this._scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this._scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),s?this._scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this._scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:s?this._scrollElement.scrollLeft+"px":"0",rightIndicatorOffset:n?`-${this._scrollElement.scrollLeft}px`:"0"})}getScrollTop(){return this._autoHideScrollbar.getScrollTop()}componentWillUnmount(){this._scrollElement&&this._scrollElement.removeEventListener("scroll",this.checkOverflow)}render(){const e={left:this.state.leftIndicatorOffset},t={right:this.state.rightIndicatorOffset},s=this.props.trackHorizontalOverflow?o.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:e}):null,n=this.props.trackHorizontalOverflow?o.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:t}):null;return o.a.createElement(r.a,B()({ref:this._collectScrollerComponent,wrappedRef:this._collectScroller,onWheel:this.onMouseWheel},this.props),s,this.props.children,n)}}g()(Xt,"propTypes",{trackHorizontalOverflow:re.a.bool,verticalScrollsHorizontally:re.a.bool});var Zt=s(145);var es=()=>{const[e,t]=Object(i.useState)(null);return Object(Zt.a)(D.b.instance,D.a,()=>{if(D.b.instance.getFirstNameFilterCondition()){const e=Object.values(D.b.instance.orderedLists).flat(1).length;t(e)}else t(null)}),"number"!=typeof e?null:o.a.createElement("div",{className:"mx_LeftPanel_roomListFilterCount"},Object(c.a)("%(count)s results",{count:e}))};const ts=["mx_RoomSearch_input","mx_RoomSearch_icon","mx_RoomSublist_headerText","mx_RoomTile","mx_RoomSublist_showNButton"];class ss extends i.Component{constructor(e){super(e),g()(this,"listContainerRef",Object(i.createRef)()),g()(this,"tagPanelWatcherRef",void 0),g()(this,"bgImageWatcherRef",void 0),g()(this,"focusedElement",null),g()(this,"isDoingStickyHeaders",!1),g()(this,"onExplore",()=>{u.a.fire(h.a.ViewRoomDirectory)}),g()(this,"onBreadcrumbsUpdate",()=>{const e=Ht.instance.visible;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),g()(this,"onBackgroundImageUpdate",()=>{let e=Pt.instance.getHttpAvatarUrl(32);const t=w.a.getValue("RoomList.backgroundImage");t&&(e=L.a.get().mxcUrlToHttp(t,32,32));const s=`url(${e})`;document.body.style.getPropertyValue("--avatar-url")!==s&&document.body.style.setProperty("--avatar-url",s)}),g()(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),g()(this,"onResize",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),g()(this,"onFocus",e=>{this.focusedElement=e.target}),g()(this,"onBlur",()=>{this.focusedElement=null}),g()(this,"onKeyDown",e=>{if(this.focusedElement)switch(e.key){case Yt.a.ARROW_UP:case Yt.a.ARROW_DOWN:e.stopPropagation(),e.preventDefault(),this.onMoveFocus(e.key===Yt.a.ARROW_UP)}}),g()(this,"onEnter",()=>{const e=this.listContainerRef.current.querySelector(".mx_RoomTile");if(e)return e.click(),!0}),g()(this,"onMoveFocus",e=>{let t,s=this.focusedElement,n=!1;do{const i=e?s.lastElementChild:s.firstElementChild,o=e?s.previousElementSibling:s.nextElementSibling;n?i?s=i:o?s=o:(n=!1,s=s.parentElement):o?(s=o,n=!0):s=s.parentElement,s&&(t=s.classList)}while(s&&!ts.some(e=>t.contains(e)));s&&(s.focus(),this.focusedElement=s)}),this.state={showBreadcrumbs:Ht.instance.visible,showTagPanel:!1},Ht.instance.on(Dt.b,this.onBreadcrumbsUpdate),D.b.instance.on(D.a,this.onBreadcrumbsUpdate),Pt.instance.on(Dt.b,this.onBackgroundImageUpdate),this.bgImageWatcherRef=w.a.watchSetting("RoomList.backgroundImage",null,this.onBackgroundImageUpdate),this.tagPanelWatcherRef=w.a.watchSetting("TagPanel.enableTagPanel",null,()=>{this.setState({showTagPanel:w.a.getValue("TagPanel.enableTagPanel")})}),this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize)}componentWillUnmount(){w.a.unwatchSetting(this.tagPanelWatcherRef),w.a.unwatchSetting(this.bgImageWatcherRef),Ht.instance.off(Dt.b,this.onBreadcrumbsUpdate),D.b.instance.off(D.a,this.onBreadcrumbsUpdate),Pt.instance.off(Dt.b,this.onBackgroundImageUpdate),this.props.resizeNotifier.off("middlePanelResizedNoisy",this.onResize)}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){const t=e.scrollTop,s=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist"),i=e.clientWidth-16,o=new Map;let r,a;for(const e of n){const i=e.querySelector(".mx_RoomSublist_stickable");i.style.removeProperty("display");const c=.4,l=e.offsetTop+c*M.a<=t,d=e.offsetTop+c*M.a>=s;l||e===n[0]?(o.set(i,{stickyTop:!0}),r&&(r.style.display="none",o.set(r,{makeInvisible:!0})),r=i):d&&!a?(o.set(i,{stickyBottom:!0}),a=i):o.set(i,{})}for(const t of o.keys()){const s=o.get(t);if(s.makeInvisible)t.style.display="none";else{if(s.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const s=e.parentElement.offsetTop+"px";t.style.top!==s&&(t.style.top=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(s.stickyBottom?t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom"):t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),s.stickyTop||s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=i+"px";t.style.width!==e&&(t.style.width=e)}else s.stickyTop||s.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const c=e.parentElement;r?c.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):c.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),a?c.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):c.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom")}renderHeader(){return i.createElement("div",{className:"mx_LeftPanel_userHeader"},i.createElement(qt,{isMinimized:this.props.isMinimized}))}renderBreadcrumbs(){if(this.state.showBreadcrumbs&&!this.props.isMinimized)return i.createElement(Xt,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0,tabIndex:-1},i.createElement(Qt,null))}renderSearchExplore(){return i.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},i.createElement(Gt.a,{isMinimized:this.props.isMinimized,onVerticalArrow:this.onKeyDown,onEnter:this.onEnter}),i.createElement(C.a,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:Object(c.a)("Explore rooms")}))}render(){const e=this.state.showTagPanel?i.createElement("div",{className:"mx_LeftPanel_tagPanelContainer"},i.createElement(I,null),w.a.getValue("feature_custom_tags")?i.createElement(j,null):null):null,t=i.createElement(ie,{onKeyDown:this.onKeyDown,resizeNotifier:null,collapsed:!1,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,onResize:this.onResize}),s=E()({mx_LeftPanel:!0,mx_LeftPanel_hasTagPanel:!!e,mx_LeftPanel_minimized:this.props.isMinimized}),n=E()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return i.createElement("div",{className:s},e,i.createElement("aside",{className:"mx_LeftPanel_roomListContainer"},this.renderHeader(),this.renderBreadcrumbs(),i.createElement(es,null),i.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},i.createElement("div",{className:n,onScroll:this.onScroll,ref:this.listContainerRef,tabIndex:-1},t))))}}var ns=s(191),is=s(479);async function os(){console.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return console.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){console.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],s=t[2],n=e.split("_").map(e=>parseInt(e,10)),i=s.split(".").map(e=>parseInt(e,10)),o=n[0]>=10&&n[1]>=14&&i[0]>=12;return console.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${s} on macOS ${e}, COLR supported: `+o),o}}catch(e){console.error("Error in Safari COLR version check",e)}return console.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),s=new Image,n=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),console.log("Waiting for COLR SVG to load"),await new Promise(e=>s.onload=e),console.log("Drawing canvas to detect COLR support"),t.drawImage(s,0,0);const i=200===t.getImageData(10,10,1,1).data[0];return console.log("Canvas check revealed COLR is supported? "+i),i}catch(e){return console.error("Couldn't load COLR font",e),!1}}let rs=!1;async function as(){if(!rs)if(rs=!0,await os()){const e=`url('${s(835)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}else{const e=`url('${s(836)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}}var cs=s(196);const ls={cachedPassword:localStorage.getItem("mx_pass")};class ds extends cs.Store{constructor(){super(u.a),this._state=ls}_update(){this._state.cachedPassword?localStorage.setItem("mx_pass",this._state.cachedPassword):localStorage.removeItem("mx_pass",this._state.cachedPassword),this.__emitChange()}_setState(e){this._state=Object.assign(this._state,e),this._update()}__onDispatch(e){switch(e.action){case"cached_password":this._setState({cachedPassword:e.cachedPassword});break;case"password_changed":this._setState({cachedPassword:null});break;case"on_client_not_viable":case"on_logged_out":this._setState({cachedPassword:null})}}getCachedPassword(){return this._state.cachedPassword}}let us=null;us||(us=new ds);var hs=us,ms=s(280);class ps{static moveTag(e,t,s){let n=f.a.getOrderedTags(),i=f.a.getRemovedTagsAccountData()||[];if(!n)return;n=n.filter(e=>e!==t),n=[...n.slice(0,s),t,...n.slice(s)],i=i.filter(e=>e!==t);const o=f.a.getStoreId();return Object(_.a)("TagOrderActions.moveTag",()=>(ve.a.trackEvent("TagOrderActions","commitTagOrdering"),e.setAccountData("im.vector.web.tag_ordering",{tags:n,removedTags:i,_storeId:o})),()=>({tags:n,removedTags:i}))}static removeTag(e,t){const s=f.a.getOrderedTags(),n=f.a.getRemovedTagsAccountData()||[];if(n.includes(t))return new ms.a(()=>{});n.push(t);const i=f.a.getStoreId();return Object(_.a)("TagOrderActions.removeTag",()=>(ve.a.trackEvent("TagOrderActions","removeTag"),e.setAccountData("im.vector.web.tag_ordering",{tags:s,removedTags:n,_storeId:i})),()=>({removedTags:n}))}}var gs=s(458);const fs=e=>{const t=["mx_ResizeHandle"];return e.vertical?t.push("mx_ResizeHandle_vertical"):t.push("mx_ResizeHandle_horizontal"),e.reverse&&t.push("mx_ResizeHandle_reverse"),o.a.createElement("div",{className:t.join(" "),"data-id":e.id},o.a.createElement("div",null))};fs.propTypes={vertical:re.a.bool,reverse:re.a.bool,id:re.a.string};var _s=fs;class vs{constructor(e,t,s){const n=e.getAttribute("data-id"),i=t.isReverseResizeHandle(e),o=i?e.nextElementSibling:e.previousElementSibling;this.domNode=o,this.id=n,this.reverse=i,this.resizer=t,this.sizer=s}_copyWith(e,t,s){return new(0,this.constructor)(e,t,s)}_advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const s=e!==this.reverse;do{t=s?t.nextElementSibling:t.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this._copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this._advance(!0)}previous(){return this._advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}setSize(e){this.sizer.setItemSize(this.domNode,e);const t=this.resizer.config.onResized;t&&t(e,this.id,this.domNode)}clearSize(){this.sizer.clearItemSize(this.domNode);const e=this.resizer.config.onResized;e&&e(null,this.id,this.domNode)}first(){const e=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));if(e)return this._copyWith(e,this.resizer,this.sizer)}last(){const e=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));if(e)return this._copyWith(e,this.resizer,this.sizer)}}class ys{constructor(e,t,s){this.container=e,this.reverse=s,this.vertical=t}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this._getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}_getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}_getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}setItemSize(e,t){this.vertical?e.style.height=Math.round(t)+"px":e.style.width=Math.round(t)+"px"}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this._getPageOffset()+this.getTotalSize()-t:t-this._getPageOffset()}}class bs extends vs{notifyCollapsed(e){const t=this.resizer.config.onCollapsed;t&&t(e,this.id,this.domNode)}}class Es extends class{static createItem(e,t,s){return new vs(e,t,s)}static createSizer(e,t,s){return new ys(e,t,s)}constructor(e){this.item=e,this.beforeOffset=e.offset()}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){}finish(){}}{static createItem(e,t,s){return new bs(e,t,s)}constructor(e,t){super(e),this.toggleSize=t&&t.toggleSize,this.isCollapsed=!1}resize(e){const t=e<this.toggleSize;t&&!this.isCollapsed?(this.isCollapsed=!0,this.item.notifyCollapsed(!0)):!t&&this.isCollapsed&&(this.item.notifyCollapsed(!1),this.isCollapsed=!1),t||super.resize(e)}}class Ss{constructor(e,t,s){if(!e)throw new Error("Resizer requires a non-null `container` arg");this.container=e,this.distributorCtor=t,this.config=s,this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"},this._onMouseDown=this._onMouseDown.bind(this)}setClassNames(e){this.classNames=e}attach(){this.container.addEventListener("mousedown",this._onMouseDown,!1)}detach(){this.container.removeEventListener("mousedown",this._onMouseDown,!1)}forHandleAt(e){const t=this._getResizeHandles()[e];if(t){const{distributor:e}=this._createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this._getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this._createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e&&e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e&&e.classList.contains(this.classNames.handle)}_onMouseDown(e){const t=e.target&&e.target.closest("."+this.classNames.handle);if(!t||t.parentElement!==this.container)return;e.preventDefault(),this.classNames.resizing&&this.container.classList.add(this.classNames.resizing),this.config.onResizeStart&&this.config.onResizeStart();const{sizer:s,distributor:n}=this._createSizerAndDistributor(t);n.start();const i=e=>{const t=s.offsetFromEvent(e);n.resizeFromContainerOffset(t)},o=document.body,r=()=>{this.classNames.resizing&&this.container.classList.remove(this.classNames.resizing),this.config.onResizeStop&&this.config.onResizeStop(),n.finish(),o.removeEventListener("mouseup",r,!1),document.removeEventListener("mouseleave",r,!1),o.removeEventListener("mousemove",i,!1)};o.addEventListener("mouseup",r,!1),document.addEventListener("mouseleave",r,!1),o.addEventListener("mousemove",i,!1)}_createSizerAndDistributor(e){const t=e.classList.contains(this.classNames.vertical),s=this.isReverseResizeHandle(e),n=this.distributorCtor,i=n.createSizer(this.container,t,s),o=n.createItem(e,this,i);return{sizer:i,distributor:new n(o,this.config)}}_getResizeHandles(){return Array.from(this.container.children).filter(e=>this.isResizeHandle(e))}}const ws=function(e){const t=d.getComponent("views.dialogs.BaseDialog");let s=Object(c.a)("You have successfully set a password!");e.didSetEmail&&(s=Object(c.a)("You have successfully set a password and an email address!"));const n=Object(c.a)("You can now return to your account after signing out, and sign in on other devices.");let i=null;return e.didSetEmail||(i=Object(c.a)("Remember, you can always set an email address in user settings if you change your mind.")),o.a.createElement(t,{className:"mx_SetPasswordDialog",onFinished:e.onFinished,title:s},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,n),o.a.createElement("p",null,i)),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{className:"mx_Dialog_primary",autoFocus:!0,onClick:e.onFinished},Object(c.a)("Continue"))))};class Cs extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{error:null}),g()(this,"_onPasswordChanged",e=>{ke.a.createDialog(ws,{didSetEmail:e.didSetEmail,onFinished:()=>{this.props.onFinished()}})}),g()(this,"_onPasswordChangeError",e=>{let t=e.error||"";403===e.httpStatus?t=Object(c.a)("Failed to change password. Is your password correct?"):e.httpStatus&&(t+=" "+Object(c.a)("(HTTP status %(httpStatus)s)",{httpStatus:e.httpStatus})),this.setState({error:t})})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.settings.ChangePassword");return o.a.createElement(e,{className:"mx_SetPasswordDialog",onFinished:this.props.onFinished,title:Object(c.a)("Please set a password!")},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("This will allow you to return to your account after signing out, and sign in on other sessions.")),o.a.createElement(t,{className:"mx_SetPasswordDialog_change_password",rowClassName:"",buttonClassNames:"mx_Dialog_primary mx_SetPasswordDialog_change_password_button",buttonKind:"primary",confirm:!1,autoFocusNewPasswordInput:!0,shouldAskForEmail:!0,onError:this._onPasswordChangeError,onFinished:this._onPasswordChanged}),o.a.createElement("div",{className:"error"},this.state.error)))}}g()(Cs,"propTypes",{onFinished:re.a.func.isRequired});var Rs=s(92),ks=s(78);const Is=()=>{ke.a.createTrackedDialog("Set Password Dialog","Password Nag Bar",Cs)},Os=()=>{ks.a.sharedInstance().dismissToast("setpassword")};var Ts=s(217);const xs=()=>{ks.a.sharedInstance().dismissToast("serverlimit")};var Ns=s(101),js=s(341),Ps=s(176),Ds=s(329);class As extends o.a.Component{constructor(e){super(e),g()(this,"dispatcherRef",void 0),g()(this,"onAction",e=>{switch(e.action){case"call_state":{const t=Ns.a.getCall(e.room_id);t&&"ringing"===t.call_state?this.setState({incomingCall:t}):this.setState({incomingCall:null})}}}),g()(this,"onAnswerClick",e=>{e.stopPropagation(),u.a.dispatch({action:"answer",room_id:this.state.incomingCall.roomId})}),g()(this,"onRejectClick",e=>{e.stopPropagation(),u.a.dispatch({action:"hangup",room_id:this.state.incomingCall.roomId})}),this.dispatcherRef=u.a.register(this.onAction),this.state={incomingCall:null}}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}render(){if(!this.state.incomingCall)return null;let e=null;this.state.incomingCall&&(e=L.a.get().getRoom(this.state.incomingCall.roomId));const t=e?e.name:Object(c.a)("Unknown caller");let s=null;return this.state.incomingCall&&(s="voice"===this.state.incomingCall.type?Object(c.a)("Incoming voice call"):"video"===this.state.incomingCall.type?Object(c.a)("Incoming video call"):Object(c.a)("Incoming call")),o.a.createElement("div",{className:"mx_IncomingCallBox"},o.a.createElement("div",{className:"mx_IncomingCallBox_CallerInfo"},o.a.createElement(js.a,null,o.a.createElement(Ps.a,{room:e,height:32,width:32})),o.a.createElement("div",null,o.a.createElement("h1",null,t),o.a.createElement("p",null,s))),o.a.createElement("div",{className:"mx_IncomingCallBox_buttons"},o.a.createElement(Ds.a,{className:"mx_IncomingCallBox_decline",onClick:this.onRejectClick,kind:"danger",label:Object(c.a)("Decline")}),o.a.createElement("div",{className:"mx_IncomingCallBox_spacer"}),o.a.createElement(Ds.a,{className:"mx_IncomingCallBox_accept",onClick:this.onAnswerClick,kind:"primary",label:Object(c.a)("Accept")})))}}var Us=s(342),Ms=s(142),Ls=s(76);class Fs extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{roomId:A.a.getRoomId(),persistentWidgetId:Ms.a.getPersistentWidgetId()}),g()(this,"_onRoomViewStoreUpdate",e=>{A.a.getRoomId()!==this.state.roomId&&this.setState({roomId:A.a.getRoomId()})}),g()(this,"_onActiveWidgetStoreUpdate",()=>{this.setState({persistentWidgetId:Ms.a.getPersistentWidgetId()})})}componentDidMount(){this._roomStoreToken=A.a.addListener(this._onRoomViewStoreUpdate),Ms.a.on("update",this._onActiveWidgetStoreUpdate)}componentWillUnmount(){this._roomStoreToken&&this._roomStoreToken.remove(),Ms.a.removeListener("update",this._onActiveWidgetStoreUpdate)}render(){if(this.state.persistentWidgetId){const e=Ms.a.getRoomId(this.state.persistentWidgetId);if(this.state.roomId!==e){const t=L.a.get().getRoom(e),s=Ls.a.getRoomWidgets(t).find(e=>e.getStateKey()===Ms.a.getPersistentWidgetId()),n=Ls.a.makeAppConfig(s.getStateKey(),s.getContent(),s.getSender(),e,s.getId()),i=Ls.a.getCapWhitelistForAppTypeInRoomId(n.type,e),r=d.getComponent("elements.AppTile");return o.a.createElement(r,{key:n.id,app:n,fullWidth:!0,room:t,userId:L.a.get().credentials.userId,show:!0,creatorUserId:n.creatorUserId,widgetPageTitle:Ls.a.getWidgetDataTitle(n),waitForIframeLoad:n.waitForIframeLoad,whitelistCapabilities:i,showDelete:!1,showMinimise:!1,miniMode:!0})}}return null}}class Bs extends o.a.Component{constructor(e){super(e),g()(this,"roomStoreToken",void 0),g()(this,"dispatcherRef",void 0),g()(this,"settingsWatcherRef",void 0),g()(this,"onRoomViewStoreUpdate",e=>{A.a.getRoomId()!==this.state.roomId&&this.setState({roomId:A.a.getRoomId()})}),g()(this,"onAction",e=>{switch(e.action){case"call_state":this.setState({activeCall:Ns.a.getAnyActiveCall()})}}),g()(this,"onCallViewClick",()=>{const e=Ns.a.getAnyActiveCall();e&&u.a.dispatch({action:"view_room",room_id:e.groupRoomId||e.roomId})}),this.state={roomId:A.a.getRoomId(),activeCall:Ns.a.getAnyActiveCall()}}componentDidMount(){this.roomStoreToken=A.a.addListener(this.onRoomViewStoreUpdate),this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){this.roomStoreToken&&this.roomStoreToken.remove(),u.a.unregister(this.dispatcherRef),w.a.unwatchSetting(this.settingsWatcherRef)}render(){const e=Ns.a.getCallForRoom(this.state.roomId);return this.state.activeCall&&"connected"===this.state.activeCall.call_state&&!e?o.a.createElement(Us.a,{className:"mx_CallPreview",onClick:this.onCallViewClick,ConferenceHandler:this.props.ConferenceHandler,showHangup:!0}):o.a.createElement(Fs,null)}}var Vs=s(491);class Ks extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_CallContainer"},o.a.createElement(As,null),o.a.createElement(Bs,{ConferenceHandler:Vs}))}}var qs=s(465);class Gs extends i.PureComponent{constructor(e,t){super(e,t),g()(this,"onUpdateToasts",()=>{this.setState({toasts:qs.a.instance.components})}),this.state={toasts:qs.a.instance.components},qs.a.instance.on(Dt.b,this.onUpdateToasts)}componentWillUnmount(){qs.a.instance.off(Dt.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>i.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:"toast-"+t},i.createElement(e,{})));return i.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}function Ws(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName||!!e.getAttribute("contenteditable")}class Hs extends i.Component{constructor(e,t){super(e,t),g()(this,"_matrixClient",void 0),g()(this,"_roomView",void 0),g()(this,"_resizeContainer",void 0),g()(this,"_sessionStore",void 0),g()(this,"_sessionStoreToken",void 0),g()(this,"_compactLayoutWatcherRef",void 0),g()(this,"resizer",void 0),g()(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),g()(this,"_setStateFromSessionStore",()=>{this._sessionStore.getCachedPassword()?ks.a.sharedInstance().addOrReplaceToast({key:"setpassword",title:Object(c.a)("Set password"),props:{description:Object(c.a)("To return to your account in future you need to set a password"),acceptLabel:Object(c.a)("Set Password"),onAccept:Is,rejectLabel:Object(c.a)("Later"),onReject:Os},component:Rs.a,priority:60}):Os()}),g()(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&u.a.dispatch({action:"ignore_state_changed"})}),g()(this,"onCompactLayoutChanged",(e,t,s,n,i)=>{this.setState({useCompactLayout:n})}),g()(this,"onSync",(e,t,s)=>{const n=this.state.syncErrorData&&this.state.syncErrorData.error&&this.state.syncErrorData.error.errcode,i=s&&s.error&&s.error.errcode;e===t&&n===i||("ERROR"===e?this.setState({syncErrorData:s}):this.setState({syncErrorData:null}),"PREPARED"===t&&"SYNCING"===e?this._updateServerNoticeEvents():this._calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),g()(this,"onRoomStateEvents",(e,t)=>{const s=D.b.instance.orderedLists[U.a.ServerNotice];s&&s.some(t=>t.roomId===e.getRoomId())&&this._updateServerNoticeEvents()}),g()(this,"_updateServerNoticeEvents",async()=>{const e=D.b.instance.orderedLists[U.a.ServerNotice];if(!e)return[];const t=[];for(const s of e){const e=s.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;const n=e.getContent().pinned.slice(0,2);for(const e of n){const n=(await this._matrixClient.getEventTimeline(s.getUnfilteredTimelineSet(),e,0)).getEvents().find(t=>t.getId()===e);n&&t.push(n)}}const s=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),n=s&&s.getContent();this._calculateServerLimitToast(this.state.syncErrorData,n),this.setState({usageLimitEventContent:n})}),g()(this,"_onPaste",e=>{let t=!1,s=e.target;for(;!t&&s;)t=Ws(s),s=s.parentElement;t||u.a.fire(h.a.FocusComposer,!0)}),g()(this,"_onReactKeyDown",e=>{this._onKeyDown(e)}),g()(this,"_onNativeKeyDown",e=>{e.target===document.body&&this._onKeyDown(e)}),g()(this,"_onKeyDown",e=>{let t=!1;const s=Object(Yt.d)(e),n=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey,i=e.key===Yt.a.ALT||e.key===Yt.a.CONTROL||e.key===Yt.a.META||e.key===Yt.a.SHIFT;switch(e.key){case Yt.a.PAGE_UP:case Yt.a.PAGE_DOWN:n||i||(this._onScrollKeyPressed(e),t=!0);break;case Yt.a.HOME:case Yt.a.END:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||(this._onScrollKeyPressed(e),t=!0);break;case Yt.a.K:s&&(u.a.dispatch({action:"focus_room_filter"}),t=!0);break;case Yt.a.BACKTICK:s&&(u.a.fire(h.a.ToggleUserMenu),t=!0);break;case Yt.a.SLASH:Object(Yt.c)(e)&&(gt.d(),t=!0);break;case Yt.a.ARROW_UP:case Yt.a.ARROW_DOWN:!e.altKey||e.ctrlKey||e.metaKey||(u.a.dispatch({action:h.a.ViewRoomDelta,delta:e.key===Yt.a.ARROW_UP?-1:1,unread:e.shiftKey}),t=!0);break;case Yt.a.PERIOD:!s||"room_view"!==this.props.page_type&&"group_view"!==this.props.page_type||(u.a.dispatch({action:h.a.ToggleRightPanel,type:"room_view"===this.props.page_type?"room":"group"}),t=!0);break;default:t=Re.a.get().onKeyDown(e)}if(t)e.stopPropagation(),e.preventDefault();else if(!(i||e.altKey||e.ctrlKey||e.metaKey)){const t=e.target!==document.body&&(e.key===Yt.a.SPACE||e.key===Yt.a.ENTER);if(e.key===Yt.a.CONTEXT_MENU)return;t||e.key===Yt.a.TAB||Ws(e.target)||(u.a.fire(h.a.FocusComposer,!0),e.stopPropagation())}}),g()(this,"_onScrollKeyPressed",e=>{this._roomView.current&&this._roomView.current.handleScrollKey(e)}),g()(this,"_onDragEnd",e=>{if(!e.destination)return;const t=e.destination.droppableId;if("tag-panel-droppable"===t){const t=e.draggableId.split(" ").pop();u.a.dispatch(ps.moveTag(this._matrixClient,t,e.destination.index),!0)}else t.startsWith("room-sub-list-droppable_")&&this._onRoomTileEndDrag(e)}),g()(this,"_onRoomTileEndDrag",e=>{let t=e.destination.droppableId.split("_")[1],s=e.source.droppableId.split("_")[1];"undefined"===t&&(t=void 0),"undefined"===s&&(s=void 0);const n=e.draggableId.split("_")[1],i=e.source.index,o=e.destination.index;u.a.dispatch(gs.a.tagRoom(this._matrixClient,this._matrixClient.getRoom(n),s,t,i,o),!0)}),g()(this,"_onMouseDown",e=>{if(this.props.leftDisabled&&this.props.rightDisabled){const t=new Set(e.target.className.split(" "));(t.has("mx_MatrixChat")||t.has("mx_MatrixChat_middlePanel")||t.has("mx_RoomView"))&&this.setState({mouseDown:{x:e.pageX,y:e.pageY}})}}),g()(this,"_onMouseUp",e=>{if(!this.state.mouseDown)return;const t=e.pageX-this.state.mouseDown.x,s=e.pageY-this.state.mouseDown.y;Math.sqrt(t*t+(s+s))<5&&u.a.dispatch({action:"close_settings"}),this.setState({mouseDown:null})}),this.state={mouseDown:void 0,syncErrorData:void 0,useCompactLayout:w.a.getValue("useCompactLayout")},this._matrixClient=this.props.matrixClient,at(),document.addEventListener("keydown",this._onNativeKeyDown,!1),this._sessionStore=hs,this._sessionStoreToken=this._sessionStore.addListener(this._setStateFromSessionStore),this._setStateFromSessionStore(),this._updateServerNoticeEvents(),this._matrixClient.on("accountData",this.onAccountData),this._matrixClient.on("sync",this.onSync),this._matrixClient.on("RoomState.events",this.onRoomStateEvents),this._compactLayoutWatcherRef=w.a.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),as(),this._roomView=i.createRef(),this._resizeContainer=i.createRef()}componentDidMount(){this.resizer=this._createResizer(),this.resizer.attach(),this._loadResizerPreferences()}componentWillUnmount(){document.removeEventListener("keydown",this._onNativeKeyDown,!1),this._matrixClient.removeListener("accountData",this.onAccountData),this._matrixClient.removeListener("sync",this.onSync),this._matrixClient.removeListener("RoomState.events",this.onRoomStateEvents),w.a.unwatchSetting(this._compactLayoutWatcherRef),this._sessionStoreToken&&this._sessionStoreToken.remove(),this.resizer.detach()}shouldComponentUpdate(){return Boolean(L.a.get())}_createResizer(){const e={toggleSize:210,onCollapsed:e=>{e?(u.a.dispatch({action:"hide_left_panel"},!0),window.localStorage.setItem("mx_lhs_size","0")):u.a.dispatch({action:"show_left_panel"},!0)},onResized:e=>{window.localStorage.setItem("mx_lhs_size",""+e),this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{this.props.resizeNotifier.stopResizing()}},t=new Ss(this._resizeContainer.current,Es,e);return t.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),t}_loadResizerPreferences(){let e=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(e)&&(e=350),this.resizer.forHandleAt(0).resize(e)}_calculateServerLimitToast(e,t){const s=e&&e.error&&"M_RESOURCE_LIMIT_EXCEEDED"===e.error.errcode;s&&(t=e.error.data),t?((e,t,s)=>{const n=Object(Ts.a)(e,t,{monthly_active_user:Object(c.b)("Your homeserver has exceeded its user limit."),"":Object(c.b)("Your homeserver has exceeded one of its resource limits.")}),i=Object(Ts.a)(e,t,{"":Object(c.b)("Contact your <a>server admin</a>.")});ks.a.sharedInstance().addOrReplaceToast({key:"serverlimit",title:Object(c.a)("Warning"),props:{description:o.a.createElement(o.a.Fragment,null,n," ",i),acceptLabel:Object(c.a)("Ok"),onAccept:xs},component:Rs.a,priority:70})})(t.limit_type,t.admin_contact):xs()}render(){const e=d.getComponent("structures.RoomView"),t=d.getComponent("structures.UserView"),s=d.getComponent("structures.GroupView"),n=d.getComponent("structures.MyGroups"),o=d.getComponent("structures.ToastContainer");let r;switch(this.props.page_type){case is.a.RoomView:r=i.createElement(e,{ref:this._roomView,autoJoin:this.props.autoJoin,onRegistered:this.props.onRegistered,thirdPartyInvite:this.props.thirdPartyInvite,oobData:this.props.roomOobData,viaServers:this.props.viaServers,key:this.props.currentRoomId||"roomview",disabled:this.props.middleDisabled,ConferenceHandler:this.props.ConferenceHandler,resizeNotifier:this.props.resizeNotifier});break;case is.a.MyGroups:r=i.createElement(n,null);break;case is.a.RoomDirectory:break;case is.a.HomePage:r=i.createElement(m,null);break;case is.a.UserView:r=i.createElement(t,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier});break;case is.a.GroupView:r=i.createElement(s,{groupId:this.props.currentGroupId,isNew:this.props.currentGroupIsNew,resizeNotifier:this.props.resizeNotifier})}let a="mx_MatrixChat";this.state.useCompactLayout&&(a+=" mx_MatrixChat_useCompactLayout");const c=i.createElement(ss,{isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier});return i.createElement(S.a.Provider,{value:this._matrixClient},i.createElement("div",{onPaste:this._onPaste,onKeyDown:this._onReactKeyDown,className:"mx_MatrixChat_wrapper","aria-hidden":this.props.hideToSRUsers,onMouseDown:this._onMouseDown,onMouseUp:this._onMouseUp},i.createElement(o,null),i.createElement(y.DragDropContext,{onDragEnd:this._onDragEnd},i.createElement("div",{ref:this._resizeContainer,className:a},c,i.createElement(_s,null),r))),i.createElement(Ks,null),i.createElement(Gs,null))}}g()(Hs,"displayName","LoggedInView"),g()(Hs,"propTypes",{matrixClient:oe.instanceOf(ns.b).isRequired,page_type:oe.string.isRequired,onRoomCreated:oe.func,onRegistered:oe.func,viaServers:oe.arrayOf(oe.string)});var $s=Hs,zs=s(546),Ys=s(837);class Js extends i.Component{constructor(e,t){super(e,t),g()(this,"_onToastStoreUpdate",()=>{this.setState({toasts:ks.a.sharedInstance().getToasts(),countSeen:ks.a.sharedInstance().getCountSeen()})}),this.state={toasts:ks.a.sharedInstance().getToasts(),countSeen:ks.a.sharedInstance().getCountSeen()},ks.a.sharedInstance().on("update",this._onToastStoreUpdate)}componentWillUnmount(){ks.a.sharedInstance().removeListener("update",this._onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let s;if(0!==e){const n=this.state.toasts[0],{title:o,icon:r,key:a,component:c,props:l}=n,d=E()("mx_Toast_toast",{mx_Toast_hasIcon:r,["mx_Toast_icon_"+r]:r});let u;(t||this.state.countSeen>0)&&(u=` (${this.state.countSeen+1}/${this.state.countSeen+e})`);const h=Object.assign({},l,{key:a,toastKey:a});s=i.createElement("div",{className:d},i.createElement("div",{className:"mx_Toast_title"},i.createElement("h2",null,o),i.createElement("span",null,u)),i.createElement("div",{className:"mx_Toast_body"},i.createElement(c,h)))}const n=E()("mx_ToastContainer",{mx_ToastContainer_stacked:t});return i.createElement("div",{className:n,role:"alert"},s)}}var Qs=s(263),Xs=s(219),Zs=s(443),en=s(483),tn=s(467),sn=s(495);class nn extends o.a.Component{constructor(e){super(e),g()(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),g()(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return o.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown.bind(this)})}}class on extends o.a.Component{constructor(e){super(e),g()(this,"dragFunc",(e,t)=>{const s=t.clientX-e.currentX,n=this.state.width+s;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})}),this.state={width:w.a.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){this.state.IRCLayoutRoot.style.setProperty("--name-width",e+"px")}onMoueUp(e){this.props.roomId&&w.a.setValue("ircDisplayNameWidth",this.props.roomId,je.a.ROOM_DEVICE,this.state.width)}render(){return o.a.createElement(nn,{className:"mx_ProfileResizer",dragFunc:this.dragFunc.bind(this),onMouseUp:this.onMoueUp.bind(this)})}}var rn=s(484);var an=({value:e,max:t})=>o.a.createElement("progress",{className:"mx_ProgressBar",max:t,value:e}),cn=s(346),ln=s(232),dn=s(185),un=s(350),hn=s(149);const mn=({text:e})=>{const t=d.getComponent("elements.Spinner");return o.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},o.a.createElement(t,null),e)};var pn,gn,fn,_n=({waitingForOtherParty:e,waitingForNetwork:t,member:s,onStartVerification:n,isRoomEncrypted:i,inDialog:r,isSelfVerification:a})=>{let l,u;if(e||t){let t;t=e?a?Object(c.a)("Waiting for you to accept on your other session…"):Object(c.a)("Waiting for %(displayName)s to accept…",{displayName:s.displayName||s.name||s.userId}):Object(c.a)("Accepting…"),l=o.a.createElement(mn,{text:t})}else{const e=d.getComponent("elements.AccessibleButton");l=o.a.createElement(e,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:n},Object(c.a)("Start Verification"))}return u=i?o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Messages in this room are end-to-end encrypted.")),o.a.createElement("p",null,Object(c.a)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Messages in this room are not end-to-end encrypted.")),o.a.createElement("p",null,Object(c.a)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),r?l:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Encryption")),u),o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Verify User")),o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("For extra security, verify this user by checking a one-time code on both of your devices.")),o.a.createElement("p",null,Object(c.a)("To be secure, do this in person or use a trusted way to communicate.")),l)))},vn=s(227),yn=s(193),bn=s(179);let En=Object(bn.a)("views.elements.crypto.VerificationQRCode")((fn=gn=class extends o.a.PureComponent{render(){return o.a.createElement(cn.a,{data:[{data:this.props.qrCodeData.buffer,mode:"byte"}],className:"mx_VerificationQRCode",width:196})}},g()(gn,"propTypes",{qrCodeData:re.a.object.isRequired}),pn=fn))||pn;var Sn,wn=s(146),Cn=s(135);!function(e){e[e.PHASE_UNSENT=0]="PHASE_UNSENT",e[e.PHASE_REQUESTED=1]="PHASE_REQUESTED",e[e.PHASE_READY=2]="PHASE_READY",e[e.PHASE_DONE=3]="PHASE_DONE",e[e.PHASE_STARTED=4]="PHASE_STARTED",e[e.PHASE_CANCELLED=5]="PHASE_CANCELLED"}(Sn||(Sn={}));class Rn extends o.a.PureComponent{constructor(e){super(e),g()(this,"hasVerifier",void 0),g()(this,"onReciprocateYesClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.confirm()}),g()(this,"onReciprocateNoClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.cancel()}),g()(this,"startSAS",async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(vn.d.SAS);try{await e.verify()}catch(e){console.error(e)}}),g()(this,"onSasMatchesClick",()=>{this.state.sasEvent.confirm()}),g()(this,"onSasMismatchesClick",()=>{this.state.sasEvent.mismatch()}),g()(this,"updateVerifierState",()=>{const{request:e}=this.props,{sasEvent:t,reciprocateQREvent:s}=e.verifier;e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState),this.setState({sasEvent:t,reciprocateQREvent:s})}),g()(this,"onRequestChange",async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){e.verifier.on("show_sas",this.updateVerifierState),e.verifier.on("show_reciprocate_qr",this.updateVerifierState);try{await e.verifier.verify()}catch(e){console.error("error verify",e)}}}),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,s=t.otherPartySupportsMethod(vn.d.SAS),n=t.otherPartySupportsMethod(yn.c),i=d.getComponent("elements.AccessibleButton"),r=l.a.get().brand,a=s||n?null:o.a.createElement("p",null,Object(c.a)("The session you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:r}));if("dialog"===this.props.layout){let e,r;n&&(e=o.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},o.a.createElement("p",null,Object(c.a)("Scan this unique code")),o.a.createElement(En,{qrCodeData:t.qrCodeData}))),s&&(r=o.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},o.a.createElement("p",null,Object(c.a)("Compare unique emoji")),o.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(c.a)("Compare a unique set of emoji if you don't have a camera on either device")),o.a.createElement(i,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(c.a)("Start"))));const l=e&&r?o.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(c.a)("or")):null;return o.a.createElement("div",null,Object(c.a)("Verify this session by completing one of the following:"),o.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,l,r,a))}let u,h;if(n&&(u=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Verify by scanning")),o.a.createElement("p",null,Object(c.a)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),o.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},o.a.createElement(En,{qrCodeData:t.qrCodeData})))),s){const e=this.state.emojiButtonClicked,t=n?Object(c.a)("If you can't scan the code above, verify by comparing unique emoji."):Object(c.a)("Verify by comparing unique emoji.");h=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Verify by emoji")),o.a.createElement("p",null,t),o.a.createElement(i,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(c.a)("Verify by emoji")))}const m=a?o.a.createElement("div",{className:"mx_UserInfo_container"},a):null;return o.a.createElement(o.a.Fragment,null,u,h,m)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId;return L.a.get().getStoredDevice(L.a.get().getUserId(),e)}renderQRReciprocatePhase(){const{member:e,request:t}=this.props;let s;s=this.props.inDialog?d.getComponent("elements.AccessibleButton"):d.getComponent("elements.FormButton");const n=t.isSelfVerification?Object(c.a)("Almost there! Is your other session showing the same shield?"):Object(c.a)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let i;return i=this.state.reciprocateQREvent?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,n),o.a.createElement(wn.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),o.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},o.a.createElement(s,{label:Object(c.a)("No"),kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(c.a)("No")),o.a.createElement(s,{label:Object(c.a)("Yes"),kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(c.a)("Yes")))):o.a.createElement("p",null,o.a.createElement(Ne.a,null)),o.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},o.a.createElement("h3",null,Object(c.a)("Verify by scanning")),i)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let s,n;if(t.isSelfVerification||(s=this.props.isRoomEncrypted?Object(c.a)("Verify all users in a room to ensure it's secure."):Object(c.a)("In encrypted rooms, verify all users to ensure it’s secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(c.a)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(console.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(c.a)("You've successfully verified your device!"))}else n=Object(c.a)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});const i=d.getComponent("elements.AccessibleButton");return o.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},o.a.createElement("h3",null,Object(c.a)("Verified")),o.a.createElement("p",null,n),o.a.createElement(wn.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),s?o.a.createElement("p",null,s):null,o.a.createElement(i,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(c.a)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props,s=d.getComponent("elements.AccessibleButton");let n,i;return n=t.isSelfVerification?Object(c.a)("Start verification again from the notification."):Object(c.a)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?i=Object(c.a)("Verification timed out.")+" "+n:t.cancellingUserId===t.otherUserId?(i=t.isSelfVerification?Object(c.a)("You cancelled verification on your other session."):Object(c.a)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),i=`${i} ${n}`):i=Object(c.a)("You cancelled verification.")+" "+n,o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Verification cancelled")),o.a.createElement("p",null,i),o.a.createElement(s,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(c.a)("Got it")))}render(){const{member:e,phase:t,request:s}=this.props,n=e.displayName||e.name||e.userId;switch(t){case Cn.d:return this.renderQRPhase();case Cn.f:switch(s.chosenMethod){case vn.d.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case vn.d.SAS:{const e=d.getComponent("views.verification.VerificationShowSas"),t=this.state.sasEvent?o.a.createElement(e,{displayName:n,device:this.getDevice(),sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:s.isSelfVerification}):o.a.createElement(Ne.a,null);return o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Compare emoji")),t)}default:return null}case Cn.c:return this.renderVerifiedPhase();case Cn.b:return this.renderCancelledPhase()}return console.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on("change",this.onRequestChange),e.verifier){const{sasEvent:t,reciprocateQREvent:s}=e.verifier;this.setState({sasEvent:t,reciprocateQREvent:s})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState)),e.off("change",this.onRequestChange)}}const kn=["m.key_mismatch","m.user_error","m.mismatched_sas"];var In=e=>{const{verificationRequest:t,verificationRequestPromise:n,member:r,onClose:a,layout:l,isRoomEncrypted:u}=e,[h,m]=Object(i.useState)(t),[p,g]=Object(i.useState)(!1),[f,_]=Object(i.useState)(h&&h.phase);Object(i.useEffect)(()=>{m(t),t&&(g(!1),_(t.phase))},[t]),Object(i.useEffect)(()=>{n&&async function(){g(!0);const e=await n;g(!1),m(e),_(e.phase)}()},[n]);const v=Object(i.useCallback)(()=>{if(h&&h.cancelled&&kn.includes(h.cancellationCode)){const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(256),title:Object(c.a)("Your messages are not secure"),description:o.a.createElement("div",null,Object(c.a)("One of the following may be compromised:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(c.a)("Your homeserver")),o.a.createElement("li",null,Object(c.a)("The homeserver the user you’re verifying is connected to")),o.a.createElement("li",null,Object(c.a)("Yours, or the other users’ internet connection")),o.a.createElement("li",null,Object(c.a)("Yours, or the other users’ session")))),onFinished:a})}else h&&_(h.phase)},[a,h]);Object(Zt.a)(h,"change",v);const y=Object(i.useCallback)((function(){h&&h.cancel()}),[h]);let b;if("dialog"!==l&&h&&h.pending){const e=d.getComponent("elements.AccessibleButton");b=o.a.createElement(e,{className:"mx_EncryptionPanel_cancel",onClick:y,title:Object(c.a)("Cancel")})}const E=Object(i.useCallback)(async()=>{g(!0);const e=L.a.get(),t=await Object(et.c)(e,r.userId),s=await e.requestVerificationDM(r.userId,t);m(s),_(s.phase)},[r.userId]),S=!h&&p||h&&(f===Cn.e||f===Cn.g||void 0===f),w=h?h.isSelfVerification:r.userId===L.a.get().getUserId();if(!h||S){const e=!h&&p||h&&h.initiatedByMe;return o.a.createElement(o.a.Fragment,null,b,o.a.createElement(_n,{isRoomEncrypted:u,onStartVerification:E,member:r,isSelfVerification:w,waitingForOtherParty:S&&e,waitingForNetwork:S&&!e,inDialog:"dialog"===l}))}return o.a.createElement(o.a.Fragment,null,b,o.a.createElement(Rn,{isRoomEncrypted:u,layout:l,onClose:a,member:r,request:h,key:h.channel.transactionId,inDialog:"dialog"===l,phase:f}))},On=s(351),Tn=s(352);const xn=[Lt.b.GroupMemberInfo,Lt.b.GroupMemberList],Nn=[Lt.b.GroupRoomList,Lt.b.GroupRoomInfo];class jn extends Tn.b{constructor(e){super(e,Tn.a.Group),g()(this,"onMembersClicked",()=>{this.state.phase===Lt.b.GroupMemberInfo?this.setPhase(Lt.b.GroupMemberInfo):this.setPhase(Lt.b.GroupMemberList)}),g()(this,"onRoomsClicked",()=>{this.setPhase(Lt.b.GroupRoomList)})}onAction(e){e.action===h.a.ViewUser?e.member?this.setPhase(Lt.b.RoomMemberInfo,{member:e.member}):this.setPhase(Lt.b.GroupMemberList):"view_group"===e.action?this.setPhase(Lt.b.GroupMemberList):"view_group_room"===e.action?this.setPhase(Lt.b.GroupRoomInfo,{groupRoomId:e.groupRoomId,groupId:e.groupId}):"view_group_room_list"===e.action?this.setPhase(Lt.b.GroupRoomList):"view_group_member_list"===e.action?this.setPhase(Lt.b.GroupMemberList):"view_group_user"===e.action&&this.setPhase(Lt.b.GroupMemberInfo,{member:e.member})}renderButtons(){return[o.a.createElement(On.a,{key:"groupMembersButton",name:"groupMembersButton",title:Object(c.a)("Members"),isHighlighted:this.isPhase(xn),onClick:this.onMembersClicked,analytics:["Right Panel","Group Member List Button","click"]}),o.a.createElement(On.a,{key:"roomsButton",name:"roomsButton",title:Object(c.a)("Rooms"),isHighlighted:this.isPhase(Nn),onClick:this.onRoomsClicked,analytics:["Right Panel","Group Room List Button","click"]})]}}var Pn=s(520),Dn=s(345),An=s(500);class Un{constructor(e,t){if(g()(this,"commandRegex",void 0),g()(this,"forcedCommandRegex",void 0),e){if(!e.global)throw new Error("commandRegex must have global flag set");this.commandRegex=e}if(t){if(!t.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=t}}destroy(){}getCurrentCommand(e,t,s=!1){let n,i=this.commandRegex;if(s&&this.shouldForceComplete()&&(i=this.forcedCommandRegex||/\S+/g),!i)return null;for(i.lastIndex=0;null!==(n=i.exec(e));){const e=n.index,s=e+n[0].length;if(t.start<=s&&t.end>=e)return{command:n,range:{start:e,end:s}}}return{command:null,range:{start:-1,end:-1}}}async getCompletions(e,t,s=!1){return[]}getName(){return"Default Provider"}renderCompletions(e){return console.error("stub; should be implemented in subclasses"),null}shouldForceComplete(){return!1}}function Mn(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Ln(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Mn(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Mn(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class Fn{constructor(e,t={keys:[]}){g()(this,"_options",void 0),g()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0),void 0===this._options.shouldMatchPrefix&&(this._options.shouldMatchPrefix=!1)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(jt.at)(t,this._options.keys);if(this._options.funcs)for(const s of this._options.funcs)e.push(s(t));for(const[s,n]of Object.entries(e)){if(!n)continue;const e=this.processQuery(n);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(s),object:t})}}}match(e){if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const t=[];for(const[s,n]of this._items.entries()){let i=s;this._options.shouldMatchWordsOnly&&(i=i.replace(/[^\w]/g,""));const o=i.indexOf(e);-1===o||this._options.shouldMatchPrefix&&0!==o||t.push(...n.map(e=>Ln({index:o},e)))}return t.sort((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1}),Object(jt.uniq)(t.map(e=>e.object))}processQuery(e){return!1!==this._options.fuzzy?Object(Wt.z)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}const Bn=Object(i.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:r}=e,a=K()(e,["title","subtitle","description","className"]);return o.a.createElement("div",B()({},a,{className:E()("mx_Autocomplete_Completion_block",r),role:"option",ref:t}),o.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),o.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),o.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))}),Vn=Object(i.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:r,children:a}=e,c=K()(e,["title","subtitle","description","className","children"]);return o.a.createElement("div",B()({},c,{className:E()("mx_Autocomplete_Completion_pill",r),role:"option",ref:t}),a,o.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),o.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),o.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))});var Kn=s(247),qn=s(77);function Gn(e){const t=360/e.length;return Array.from(e).map((e,s)=>{const[n,i,o]=function(e,t,s){const n=t*(1-Math.abs(2*s-1)),i=n*(1-Math.abs(e/60%2-1)),o=s-n/2;let r=0,a=0,c=0;return 0<=e&&e<60?(r=n,a=i,c=0):60<=e&&e<120?(r=i,a=n,c=0):120<=e&&e<180?(r=0,a=n,c=i):180<=e&&e<240?(r=0,a=i,c=n):240<=e&&e<300?(r=i,a=0,c=n):300<=e&&e<360&&(r=n,a=0,c=i),[Math.round(255*(r+o)),Math.round(255*(a+o)),Math.round(255*(c+o))]}(s*t,1,.5);return'<font color="#'+n.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+o.toString(16).padStart(2,"0")+'">'+e+"</font>"}).join("")}var Wn=s(172),Hn=s(205),$n=s(65),zn=s(102),Yn=s(316),Jn=s(884),Qn=s(526);class Xn extends o.a.Component{constructor(e){super(e),g()(this,"_onDownload",async e=>{this.setState({downloadBusy:!0}),this._downloadProgressCallback(Object(c.a)("Preparing to download logs"));try{await Object(Qn.b)({sendLogs:!0,progressCallback:this._downloadProgressCallback,label:this.props.label}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this._unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(c.a)("Failed to send logs: ")+""+e.message})}}),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this._unmounted=!1,this._onSubmit=this._onSubmit.bind(this),this._onCancel=this._onCancel.bind(this),this._onTextChange=this._onTextChange.bind(this),this._onIssueUrlChange=this._onIssueUrlChange.bind(this),this._onSendLogsChange=this._onSendLogsChange.bind(this),this._sendProgressCallback=this._sendProgressCallback.bind(this),this._downloadProgressCallback=this._downloadProgressCallback.bind(this)}componentWillUnmount(){this._unmounted=!0}_onCancel(e){this.props.onFinished(!1)}_onSubmit(e){if(!(this.state.text&&this.state.text.trim()||this.state.issueUrl&&this.state.issueUrl.trim()))return void this.setState({err:Object(c.a)("Please tell us what went wrong or, better, create a GitHub issue that describes the problem.")});const t=(this.state.text.length>0?this.state.text+"\n\n":"")+"Issue: "+(this.state.issueUrl.length>0?this.state.issueUrl:"No issue link given");this.setState({busy:!0,progress:null,err:null}),this._sendProgressCallback(Object(c.a)("Preparing to send logs")),Object(Qn.a)(l.a.get().bug_report_endpoint_url,{userText:t,sendLogs:!0,progressCallback:this._sendProgressCallback,label:this.props.label}).then(()=>{if(!this._unmounted){this.props.onFinished(!1);const e=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Bug report sent","",e,{title:Object(c.a)("Logs sent"),description:Object(c.a)("Thank you!"),hasCancelButton:!1})}},e=>{this._unmounted||this.setState({busy:!1,progress:null,err:Object(c.a)("Failed to send logs: ")+""+e.message})})}_onTextChange(e){this.setState({text:e.target.value})}_onIssueUrlChange(e){this.setState({issueUrl:e.target.value})}_onSendLogsChange(e){this.setState({sendLogs:e.target.checked})}_sendProgressCallback(e){this._unmounted||this.setState({progress:e})}_downloadProgressCallback(e){this._unmounted||this.setState({downloadProgress:e})}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons"),n=d.getComponent("elements.Field");let i=null;this.state.err&&(i=o.a.createElement("div",{className:"error"},this.state.err));let r,a=null;return this.state.busy&&(a=o.a.createElement("div",{className:"progress"},o.a.createElement(e,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some(e=>!1===e)&&(r=o.a.createElement("p",null,o.a.createElement("b",null,Object(c.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),o.a.createElement(t,{className:"mx_BugReportDialog",onFinished:this._onCancel,title:Object(c.a)("Submit debug logs"),contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},r,o.a.createElement("p",null,Object(c.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages.")),o.a.createElement("p",null,o.a.createElement("b",null,Object(c.a)("Before submitting logs, you must <a>create a GitHub issue</a> to describe your problem.",{},{a:e=>o.a.createElement("a",{target:"_blank",href:"https://github.com/vector-im/element-web/issues/new"},e)}))),o.a.createElement("div",{className:"mx_BugReportDialog_download"},o.a.createElement(Z.a,{onClick:this._onDownload,kind:"link",disabled:this.state.downloadBusy},Object(c.a)("Download logs")),this.state.downloadProgress&&o.a.createElement("span",null,this.state.downloadProgress," ...")),o.a.createElement(n,{type:"text",className:"mx_BugReportDialog_field_input",label:Object(c.a)("GitHub issue"),onChange:this._onIssueUrlChange,value:this.state.issueUrl,placeholder:"https://github.com/vector-im/element-web/issues/..."}),o.a.createElement(n,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(c.a)("Notes"),rows:5,onChange:this._onTextChange,value:this.state.text,placeholder:Object(c.a)("If there is additional context that would help in analysing the issue, such as what you were doing at the time, room IDs, user IDs, etc., please include those things here.")}),a,i),o.a.createElement(s,{primaryButton:Object(c.a)("Send logs"),onPrimaryButtonClick:this._onSubmit,focus:!0,onCancel:this._onCancel,disabled:this.state.busy}))}}Xn.propTypes={onFinished:re.a.func.isRequired,initialText:re.a.string};var Zn=s(139);function ei(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function ti(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ei(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ei(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const si=async()=>new Promise(e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{const s=t.target.files[0],n=d.getComponent("dialogs.UploadConfirmDialog");ke.a.createTrackedDialog("Upload Files confirmation","",n,{file:s,onFinished:t=>{e(t?L.a.get().uploadContent(s):null)}})},t.click()}),ni={messages:Object(c.b)("Messages"),actions:Object(c.b)("Actions"),admin:Object(c.b)("Admin"),advanced:Object(c.b)("Advanced"),other:Object(c.b)("Other")};class ii{constructor(e){g()(this,"command",void 0),g()(this,"aliases",void 0),g()(this,"args",void 0),g()(this,"description",void 0),g()(this,"runFn",void 0),g()(this,"category",void 0),g()(this,"hideCompletionAfterSpace",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=e.runFn,this.category=e.category||ni.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1}getCommand(){return"/"+this.command}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t,s){return this.runFn?this.runFn.bind(this)(e,t,s):oi(Object(c.a)("Command error"))}getUsage(){return Object(c.a)("Usage")+": "+this.getCommandWithArgs()}}function oi(e){return{error:e}}function ri(e){return{promise:e}}const ai=[new ii({command:"shrug",args:"<message>",description:Object(c.b)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let s="¯\\_(ツ)_/¯";return t&&(s=s+" "+t),ri(L.a.get().sendTextMessage(e,s))},category:ni.messages}),new ii({command:"lenny",args:"<message>",description:Object(c.b)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let s="( ͡° ͜ʖ ͡°)";return t&&(s=s+" "+t),ri(L.a.get().sendTextMessage(e,s))},category:ni.messages}),new ii({command:"plain",args:"<message>",description:Object(c.b)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e,t){return ri(L.a.get().sendTextMessage(e,t))},category:ni.messages}),new ii({command:"html",args:"<message>",description:Object(c.b)("Sends a message as html, without interpreting it as markdown"),runFn:function(e,t){return ri(L.a.get().sendHtmlMessage(e,t,t))},category:ni.messages}),new ii({command:"ddg",args:"<query>",description:Object(c.b)("Searches DuckDuckGo for results"),runFn:function(){const e=d.getComponent("dialogs.ErrorDialog");return ke.a.createTrackedDialog("Slash Commands","/ddg is not a command",e,{title:Object(c.a)("/ddg is not a command"),description:Object(c.a)("To use it, just wait for autocomplete results to load and tab through them.")}),ri()},category:ni.actions,hideCompletionAfterSpace:!0}),new ii({command:"upgraderoom",args:"<new_version>",description:Object(c.b)("Upgrades a room to a new version"),runFn:function(e,t){if(t){const s=L.a.get(),n=s.getRoom(e);if(!n.currentState.mayClientSendStateEvent("m.room.tombstone",s))return oi(Object(c.a)("You do not have the required permissions to use this command."));const i=d.getComponent("dialogs.RoomUpgradeWarningDialog"),{finished:o}=ke.a.createTrackedDialog("Slash Commands","upgrade room confirmation",i,{roomId:e,targetVersion:t},null,!1,!0);return ri(o.then(async([i])=>{if(!i.continue)return;let o;try{const r=s.upgradeRoom(e,t);i.invite&&(o=async e=>{const{replacement_room:t}=await r;if(e.roomId!==t)return;const i=[...n.getMembersWithMembership("join"),...n.getMembersWithMembership("invite")].map(e=>e.userId).filter(e=>e!==s.getUserId());i.length>0&&await Object(Mt.b)(t,i),s.removeListener("Room",o)},s.on("Room",o)),await r}catch(e){console.error(e),o&&s.removeListener("Room",o);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Slash Commands","room upgrade error",t,{title:Object(c.a)("Error upgrading room"),description:Object(c.a)("Double check that your server supports the room version chosen and try again.")})}}))}return oi(this.getUsage())},category:ni.admin}),new ii({command:"nick",args:"<display_name>",description:Object(c.b)("Changes your display nickname"),runFn:function(e,t){return t?ri(L.a.get().setDisplayName(t)):oi(this.getUsage())},category:ni.actions}),new ii({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(c.b)("Changes your display nickname in the current room only"),runFn:function(e,t){if(t){const s=L.a.get(),n=s.getRoom(e).currentState.getStateEvents("m.room.member",s.getUserId()),i=ti(ti({},n?n.getContent():{membership:"join"}),{},{displayname:t});return ri(s.sendStateEvent(e,"m.room.member",i,s.getUserId()))}return oi(this.getUsage())},category:ni.actions}),new ii({command:"roomavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes the avatar of the current room"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=si()),ri(s.then(t=>{if(t)return L.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")}))},category:ni.actions}),new ii({command:"myroomavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes your avatar in this current room only"),runFn:function(e,t){const s=L.a.get(),n=s.getRoom(e),i=s.getUserId();let o=Promise.resolve(t);return t||(o=si()),ri(o.then(t=>{if(!t)return;const o=n.currentState.getStateEvents("m.room.member",i),r=ti(ti({},o?o.getContent():{membership:"join"}),{},{avatar_url:t});return s.sendStateEvent(e,"m.room.member",r,i)}))},category:ni.actions}),new ii({command:"myavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes your avatar in all rooms"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=si()),ri(s.then(e=>{if(e)return L.a.get().setAvatarUrl(e)}))},category:ni.actions}),new ii({command:"topic",args:"[<topic>]",description:Object(c.b)("Gets or sets the room topic"),runFn:function(e,t){const s=L.a.get();if(t)return ri(s.setRoomTopic(e,t));const n=s.getRoom(e);if(!n)return oi(Object(c.a)("Failed to set topic"));const o=n.currentState.getStateEvents("m.room.topic",""),r=o&&o.getContent().topic,a=r?Object(qn.d)(r):Object(c.a)("This room has no topic."),l=d.getComponent("dialogs.InfoDialog");return ke.a.createTrackedDialog("Slash Commands","Topic",l,{title:n.name,description:i.createElement("div",{dangerouslySetInnerHTML:{__html:a}}),hasCloseButton:!0}),ri()},category:ni.admin}),new ii({command:"roomname",args:"<name>",description:Object(c.b)("Sets the room name"),runFn:function(e,t){return t?ri(L.a.get().setRoomName(e,t)):oi(this.getUsage())},category:ni.admin}),new ii({command:"invite",args:"<user-id>",description:Object(c.b)("Invites user with given id to current room"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s){const t=s[1];let n=Promise.resolve();if("email"===Object(Wn.c)(t)&&!L.a.get().getIdentityServerUrl()){const e=Object(Hn.c)();if(!e)return oi(Object(c.a)("Use an identity server to invite by email. Manage in Settings."));{const{finished:t}=ke.a.createTrackedDialog("Slash Commands","Identity server",Ot.a,{title:Object(c.a)("Use an identity server"),description:i.createElement("p",null,Object(c.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object(Te.a)(e)})),button:Object(c.a)("Continue")});n=t.then(([e])=>{if(!e)throw new Error(Object(c.a)("Use an identity server to invite by email. Manage in Settings."));Object(Hn.d)()})}}const o=new Kn.a(e);return ri(n.then(()=>o.invite([t])).then(()=>{if("invited"!==o.getCompletionState(t))throw new Error(o.getErrorText(t))}))}}return oi(this.getUsage())},category:ni.actions}),new ii({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(c.b)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return oi(this.getUsage());let s=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),n=t.host||t.hostname;Object($n.c)(n)&&(s=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+L.a.get().getDomain()),u.a.dispatch({action:"view_room",room_alias:t,auto_join:!0}),ri()}if("!"===e[0][0]){const[t,...s]=e;return u.a.dispatch({action:"view_room",room_id:t,opts:{viaServers:s},via_servers:s,auto_join:!0}),ri()}if(s){const t=Object($n.h)(e[0]);if(!t)return oi(this.getUsage());if(!t.roomIdOrAlias)return oi(this.getUsage());const s=t.roomIdOrAlias,n=t.viaServers,i=t.eventId,o={action:"view_room",auto_join:!0};return"!"===s[0]?o.room_id=s:o.room_alias=s,i&&(o.event_id=i,o.highlighted=!0),n&&(o.opts={viaServers:n},o.via_servers=n),u.a.dispatch(o),ri()}}return oi(this.getUsage())},category:ni.actions}),new ii({command:"part",args:"[<room-address>]",description:Object(c.b)("Leave room"),runFn:function(e,t){const s=L.a.get();let n;if(t){const e=t.match(/^(\S+)$/);if(e){let t=e[1];if("#"!==t[0])return oi(this.getUsage());t.includes(":")||(t+=":"+s.getDomain());const i=s.getRooms();for(let e=0;e<i.length;e++){const s=i[e].currentState.getStateEvents("m.room.aliases");for(let o=0;o<s.length;o++){const r=s[o].getContent().aliases||[];for(let s=0;s<r.length;s++)if(r[s]===t){n=i[e].roomId;break}if(n)break}if(n)break}if(!n)return oi(Object(c.a)("Unrecognised room address:")+" "+t)}}return n||(n=e),ri(Object(Zn.c)(n))},category:ni.actions}),new ii({command:"kick",args:"<user-id> [reason]",description:Object(c.b)("Kicks user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return ri(L.a.get().kick(e,s[1],s[3]))}return oi(this.getUsage())},category:ni.admin}),new ii({command:"ban",args:"<user-id> [reason]",description:Object(c.b)("Bans user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return ri(L.a.get().ban(e,s[1],s[3]))}return oi(this.getUsage())},category:ni.admin}),new ii({command:"unban",args:"<user-id>",description:Object(c.b)("Unbans user with given ID"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s)return ri(L.a.get().unban(e,s[1]))}return oi(this.getUsage())},category:ni.admin}),new ii({command:"ignore",args:"<user-id>",description:Object(c.b)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=L.a.get(),s=t.match(/^(@[^:]+:\S+)$/);if(s){const t=s[1],n=e.getIgnoredUsers();return n.push(t),ri(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");ke.a.createTrackedDialog("Slash Commands","User ignored",e,{title:Object(c.a)("Ignored user"),description:i.createElement("div",null,i.createElement("p",null,Object(c.a)("You are now ignoring %(userId)s",{userId:t})))})}))}}return oi(this.getUsage())},category:ni.actions}),new ii({command:"unignore",args:"<user-id>",description:Object(c.b)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=L.a.get(),s=t.match(/(^@[^:]+:\S+$)/);if(s){const t=s[1],n=e.getIgnoredUsers(),o=n.indexOf(t);return-1!==o&&n.splice(o,1),ri(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");ke.a.createTrackedDialog("Slash Commands","User unignored",e,{title:Object(c.a)("Unignored user"),description:i.createElement("div",null,i.createElement("p",null,Object(c.a)("You are no longer ignoring %(userId)s",{userId:t})))})}))}}return oi(this.getUsage())},category:ni.actions}),new ii({command:"op",args:"<user-id> [<power-level>]",description:Object(c.b)("Define the power level of a user"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(-?\d+))?$/);let n=50;if(s){const t=s[1];if(4===s.length&&void 0!==s[3]&&(n=parseInt(s[3],10)),!isNaN(n)){const s=L.a.get(),i=s.getRoom(e);if(!i)return oi(Object(c.a)("Command failed"));const o=i.getMember(t);if(!o||Object(Zn.b)(o.membership)===Zn.a.Leave)return oi(Object(c.a)("Could not find user in room"));const r=i.currentState.getStateEvents("m.room.power_levels","");return ri(s.setPowerLevel(e,t,n,r))}}}return oi(this.getUsage())},category:ni.admin}),new ii({command:"deop",args:"<user-id>",description:Object(c.b)("Deops user with given id"),runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const s=L.a.get(),n=s.getRoom(e);if(!n)return oi(Object(c.a)("Command failed"));const i=n.currentState.getStateEvents("m.room.power_levels","");return i.getContent().users[t]?ri(s.setPowerLevel(e,t,void 0,i)):oi(Object(c.a)("Could not find user in room"))}}return oi(this.getUsage())},category:ni.admin}),new ii({command:"devtools",description:Object(c.b)("Opens the Developer Tools dialog"),runFn:function(e){const t=d.getComponent("dialogs.DevtoolsDialog");return ke.a.createDialog(t,{roomId:e}),ri()},category:ni.advanced}),new ii({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(c.b)("Adds a custom widget by URL to the room"),runFn:function(e,t){if(!t)return oi(Object(c.a)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(Jn.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const s=e.childNodes[0];if("iframe"===s.tagName.toLowerCase()&&s.attrs){const e=s.attrs.find(e=>"src"===e.name);console.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return oi(Object(c.a)("Please supply a https:// or http:// widget URL"));if(Ls.a.canUserModifyWidgets(e)){const s=L.a.get().getUserId(),n=(new Date).getTime(),i=encodeURIComponent(`${e}_${s}_${n}`);let o=zn.a.CUSTOM,r="Custom Widget",a={};const c=Yn.a.getInstance().parsePreferredConferenceUrl(t);return c&&(console.log("Making /addwidget widget a Jitsi conference"),o=zn.a.JITSI,r="Jitsi Conference",a=c,t=Ls.a.getLocalJitsiWrapperUrl()),ri(Ls.a.setRoomWidget(e,i,o,t,r,a))}return oi(Object(c.a)("You cannot modify widgets in this room."))},category:ni.admin}),new ii({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(c.b)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=L.a.get(),s=e[1],n=e[2],o=e[3];return ri((async()=>{const e=t.getStoredDevice(s,n);if(!e)throw new Error(Object(c.a)("Unknown (user, session) pair:")+` (${s}, ${n})`);if((await t.checkDeviceTrust(s,n)).isVerified())throw e.getFingerprint()===o?new Error(Object(c.a)("Session already verified!")):new Error(Object(c.a)("WARNING: Session already verified, but keys do NOT MATCH!"));if(e.getFingerprint()!==o){const t=e.getFingerprint();throw new Error(Object(c.a)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:s,deviceId:n,fingerprint:o}))}await t.setDeviceVerified(s,n,!0);const r=d.getComponent("dialogs.InfoDialog");ke.a.createTrackedDialog("Slash Commands","Verified key",r,{title:Object(c.a)("Verified key"),description:i.createElement("div",null,i.createElement("p",null,Object(c.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:s,deviceId:n})))})})())}}return oi(this.getUsage())},category:ni.advanced}),new ii({command:"discardsession",description:Object(c.b)("Forces the current outbound group session in an encrypted room to be discarded"),runFn:function(e){try{L.a.get().forceDiscardSession(e)}catch(e){return oi(e.message)}return ri()},category:ni.advanced}),new ii({command:"rainbow",description:Object(c.b)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?ri(L.a.get().sendHtmlMessage(e,t,Gn(t))):oi(this.getUserId())},category:ni.messages}),new ii({command:"rainbowme",description:Object(c.b)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?ri(L.a.get().sendHtmlEmote(e,t,Gn(t))):oi(this.getUserId())},category:ni.messages}),new ii({command:"help",description:Object(c.b)("Displays list of commands with usages and descriptions"),runFn:function(){const e=d.getComponent("dialogs.SlashCommandHelpDialog");return ke.a.createTrackedDialog("Slash Commands","Help",e),ri()},category:ni.advanced}),new ii({command:"whois",description:Object(c.b)("Displays information about a user"),args:"<user-id>",runFn:function(e,t){if(!t||!t.startsWith("@")||!t.includes(":"))return oi(this.getUsage());const s=L.a.get().getRoom(e).getMember(t);return u.a.dispatch({action:h.a.ViewUser,member:s||{userId:t}}),ri()},category:ni.advanced}),new ii({command:"rageshake",aliases:["bugreport"],description:Object(c.b)("Send a bug report with logs"),args:"<description>",runFn:function(e,t){return ri(ke.a.createTrackedDialog("Slash Commands","Bug Report Dialog",Xn,{initialText:t}).finished)},category:ni.advanced}),new ii({command:"query",description:Object(c.b)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){return t&&t.startsWith("@")&&t.includes(":")?ri((async()=>{u.a.dispatch({action:"view_room",room_id:await Object(et.c)(L.a.get(),t)})})()):oi(this.getUsage())},category:ni.actions}),new ii({command:"msg",description:Object(c.b)("Sends a message to the given user"),args:"<user-id> <message>",runFn:function(e,t){if(t){const e=t.match(/^([\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uFEFE\uFF00-\uFFFF]+?)(?: +([\s\S]*))?$/);if(e){const[t,s]=e.slice(1);if(s&&t&&t.startsWith("@")&&t.includes(":"))return ri((async()=>{const e=L.a.get(),n=await Object(et.c)(e,t);u.a.dispatch({action:"view_room",room_id:n}),e.sendTextMessage(n,s)})())}}return oi(this.getUsage())},category:ni.actions}),new ii({command:"me",args:"<message>",description:Object(c.b)("Displays action"),category:ni.messages,hideCompletionAfterSpace:!0})],ci=new Map;function li(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?: +((.|\n)*))?$/);let s,n;return t?(s=t[1].substring(1).toLowerCase(),n=t[2]):s=e,{cmd:s,args:n}}function di(e,t){const{cmd:s,args:n}=li(t);if(ci.has(s))return()=>ci.get(s).run(e,n,s)}ai.forEach(e=>{ci.set(e.command,e),e.aliases.forEach(t=>{ci.set(t,e)})});const ui=/(^\/\w*)(?: .*)?/g;const hi=/\B\+\S*/g;const mi=/\/ddg\s+(.+)$/g;class pi extends Un{constructor(){super(mi)}static getQueryUri(e){return"https://api.duckduckgo.com/?q="+encodeURIComponent(e)+"&format=json&no_redirect=1&no_html=1&t="+encodeURIComponent("vector")}async getCompletions(e,t,s=!1){const{command:n,range:i}=this.getCurrentCommand(e,t);if(!e||!n)return[];const r=await fetch(pi.getQueryUri(n[1]),{method:"GET"}),a=await r.json(),c=a.Results.map(e=>({completion:e.Text,component:o.a.createElement(Bn,{title:e.Text,description:e.Result}),range:i}));return a.Answer&&c.unshift({completion:a.Answer,component:o.a.createElement(Bn,{title:a.Answer,description:a.AnswerType}),range:i}),a.RelatedTopics&&a.RelatedTopics.length>0&&c.unshift({completion:a.RelatedTopics[0].Text,component:o.a.createElement(Bn,{title:a.RelatedTopics[0].Text}),range:i}),a.AbstractText&&c.unshift({completion:a.AbstractText,component:o.a.createElement(Bn,{title:a.AbstractText}),range:i}),c}getName(){return"🔍 "+Object(c.a)("Results from DuckDuckGo")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(c.a)("DuckDuckGo Results")},e)}}const gi=/\B#\S*/g;function fi(e,t,s=""){return{room:e,matchName:s,displayedAlias:t}}const _i=/\B@\S*/g,vi=/[^/,:; \t\n]\S*/g;var yi=s(210),bi=s(533),Ei=s.n(bi);const Si=new RegExp("("+Ei.a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),wi=yi.b.sort((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group).map((e,t)=>({emoji:e,shortname:`:${e.shortcodes[0]}:`,_orderBy:t}));function Ci(e,t){const s=t.indexOf(e);return-1===s?1/0:s}const Ri=/@\S*/g;const ki=[class extends Un{constructor(e){super(_i,vi),g()(this,"matcher",void 0),g()(this,"users",void 0),g()(this,"room",void 0),g()(this,"onRoomTimeline",(e,t,s,n,i)=>{t&&(n||t.roomId===this.room.roomId&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!s&&i&&i.liveEvent&&this.onUserSpoke(e.sender))}),g()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.room.roomId&&(this.users=null)}),this.room=e,this.matcher=new Fn([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchPrefix:!0,shouldMatchWordsOnly:!1}),L.a.get().on("Room.timeline",this.onRoomTimeline),L.a.get().on("RoomState.members",this.onRoomStateMember)}destroy(){L.a.get()&&(L.a.get().removeListener("Room.timeline",this.onRoomTimeline),L.a.get().removeListener("RoomState.members",this.onRoomStateMember))}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.MemberAvatar");this.users||this._makeUsers();let i=[];const{command:r,range:a}=this.getCurrentCommand(e,t,s);if(!r)return i;const c=r[0];if(c&&"@"!==c){const e=c.startsWith("@")?c.substring(1):c;i=this.matcher.match(e).map(e=>{const s=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===a.start?": ":" ",href:Object($n.g)(e.userId),component:o.a.createElement(Vn,{title:s,description:e.userId},o.a.createElement(n,{member:e,width:24,height:24})),range:a}})}return i}getName(){return Object(c.a)("Users")}_makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const s of e)t[s.getSender()]=s.getTs();const s=L.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter(({userId:e})=>e!==s),this.users=Object(jt.sortBy)(this.users,e=>1e20-t[e.userId]||1e20),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==L.a.get().credentials.userId&&(this.users.splice(this.users.findIndex(t=>t.userId===e.userId),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(c.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}},class extends Un{constructor(){super(gi),g()(this,"matcher",void 0),this.matcher=new Fn([],{keys:["displayedAlias","matchName"]})}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.RoomAvatar"),i=L.a.get();let r=[];const{command:a,range:c}=this.getCurrentCommand(e,t,s);if(a){let e=i.getVisibleRooms().reduce((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(fi(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const s=t.getAltAliases().map(e=>fi(t,e));e=e.concat(s)}return e},[]);e=e.filter(t=>{const s=t.room.currentState.getStateEvents("m.room.tombstone","");if(s&&s.getContent()&&s.getContent().replacement_room){return!e.some(e=>e.room.roomId===s.getContent().replacement_room)}return!0}),this.matcher.setObjects(e);const t=a[0];r=this.matcher.match(t),r=Object(jt.sortBy)(r,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(t,e.displayedAlias),e=>e.displayedAlias.length]),r=Object(jt.uniqBy)(r,e=>e.room),r=r.map(e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object($n.f)(e.displayedAlias),component:o.a.createElement(Vn,{title:e.room.name,description:e.displayedAlias},o.a.createElement(n,{width:24,height:24,room:e.room})),range:c})).filter(e=>!!e.completion&&e.completion.length>0).slice(0,4)}return r}getName(){return Object(c.a)("Rooms")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Room Autocomplete")},e)}},class extends Un{constructor(){super(Si),g()(this,"matcher",void 0),g()(this,"nameMatcher",void 0),this.matcher=new Fn(wi,{keys:["emoji.emoticon","shortname"],funcs:[e=>e.emoji.shortcodes.length>1?e.emoji.shortcodes.slice(1).map(e=>`:${e}:`).join(" "):""],shouldMatchWordsOnly:!1}),this.nameMatcher=new Fn(wi,{keys:["emoji.annotation"],shouldMatchWordsOnly:!0})}async getCompletions(e,t,s){if(!w.a.getValue("MessageComposerInput.suggestEmoji"))return[];let n=[];const{command:i,range:r}=this.getCurrentCommand(e,t);if(i){const e=i[0];n=this.matcher.match(e),n=n.concat(this.nameMatcher.match(e));const t=[];t.push(t=>Ci(e,t.emoji.emoticon||"")),t.push(t=>Ci(e,t.shortname)),t.push(t=>Math.min(...t.emoji.shortcodes.map(t=>Ci(e.substring(1),t)))),e.length>1&&t.push(e=>e.shortname.length),t.push(e=>e._orderBy),n=Object(jt.sortBy)(Object(jt.uniq)(n),t),n=n.map(({shortname:e})=>{const t=Object(qn.h)(e);return{completion:t,component:o.a.createElement(Vn,{title:e,"aria-label":t},o.a.createElement("span",null,t)),range:r}}).slice(0,20)}return n}getName(){return"😃 "+Object(c.a)("Emoji")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(c.a)("Emoji Autocomplete")},e)}},class extends Un{constructor(e){super(Ri),g()(this,"room",void 0),this.room=e}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.RoomAvatar"),i=L.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",i.credentials.userId))return[];const{command:r,range:a}=this.getCurrentCommand(e,t,s);return r&&r[0]&&"@room".startsWith(r[0])&&r[0].length>1?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:o.a.createElement(Vn,{title:"@room",description:Object(c.a)("Notify the whole room")},o.a.createElement(n,{width:24,height:24,room:this.room})),range:a}]:[]}getName(){return"❗️ "+Object(c.a)("Room Notification")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Notification Autocomplete")},e)}},class extends Un{constructor(){super(ui),g()(this,"matcher",void 0),this.matcher=new Fn(ai,{keys:["command","args","description"],funcs:[({aliases:e})=>e.join(" ")]})}async getCompletions(e,t,s){const{command:n,range:i}=this.getCurrentCommand(e,t);if(!n)return[];let r=[];if(n[0]!==n[1]){const e=n[1].substr(1);if(ci.has(e)){if(ci.get(e).hideCompletionAfterSpace)return[];r=[ci.get(e)]}}else r="/"===e?ai:this.matcher.match(n[1]);return r.map(e=>{let t=e.getCommand()+" ";const s=e.aliases.find(e=>"/"+e===n[1]);return(s||e.getCommand()===n[1])&&(t=n[0]),{completion:t,type:"command",component:o.a.createElement(Bn,{title:"/"+(s||e.command),subtitle:e.args,description:Object(c.a)(e.description)}),range:i}})}getName(){return"*️⃣ "+Object(c.a)("Commands")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(c.a)("Command Autocomplete")},e)}},class extends Un{constructor(){super(hi),g()(this,"matcher",void 0),this.matcher=new Fn([],{keys:["groupId","name","shortDescription"]})}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.BaseAvatar");if(/^(\/join|\/leave)/.test(e))return[];const i=L.a.get();let r=[];const{command:a,range:c}=this.getCurrentCommand(e,t,s);if(a){const e=i.getGroups().filter(({myMembership:e})=>"join"===e),t=await Promise.all(e.map(async({groupId:e})=>{try{return Vt.a.getGroupProfileCached(i,e)}catch(t){return Promise.resolve({name:"",groupId:e,avatarUrl:"",shortDescription:""})}}));this.matcher.setObjects(t);const s=a[0];r=this.matcher.match(s),r=Object(jt.sortBy)(r,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(s,e.groupId),e=>e.groupId.length]).map(({avatarUrl:e,groupId:t,name:s})=>({completion:t,suffix:" ",type:"community",href:Object($n.e)(t),component:o.a.createElement(Vn,{title:s,description:t},o.a.createElement(n,{name:s||t,width:24,height:24,url:e?i.mxcUrlToHttp(e,24,24):null})),range:c})).slice(0,4)}return r}getName(){return"💬 "+Object(c.a)("Communities")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Community Autocomplete")},e)}},pi];class Ii{constructor(e){g()(this,"room",void 0),g()(this,"providers",void 0),this.room=e,this.providers=ki.map(t=>new t(e))}destroy(){this.providers.forEach(e=>{e.destroy()})}async getCompletions(e,t,s=!1){return(await Promise.all(this.providers.map(n=>Object(Ze.d)(n.getCompletions(e,t,s),null,3e3)))).map((n,i)=>{if(n&&n.length)return{completions:n,provider:this.providers[i],command:this.providers[i].getCurrentCommand(e,t,s)}}).filter(Boolean)}}const Oi=e=>"mx_Autocomplete_Completion_"+e;class Ti extends o.a.PureComponent{constructor(e){super(e),g()(this,"autocompleter",void 0),g()(this,"queryRequested",void 0),g()(this,"debounceCompletionsRequest",void 0),g()(this,"containerRef",Object(i.createRef)()),g()(this,"hide",()=>{this.setState({hide:!0,selectionOffset:0,completions:[],completionList:[]})}),g()(this,"onCompletionClicked",e=>0!==this.countCompletions()&&0!==e&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)),this.autocompleter=new Ii(e.room),this.state={completions:[],completionList:[],selectionOffset:0,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new Ii(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:0,hide:!0}),Promise.resolve(null);let s=w.a.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(s=0),new Promise(n=>{this.debounceCompletionsRequest=setTimeout(()=>{n(this.processQuery(e,t))},s)})}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete).then(t=>{e===this.queryRequested&&this.processCompletions(t)})}processCompletions(e){const t=Object(jt.flatMap)(e,e=>e.completions);let s=0;if(t.length>0){const e=0===this.state.selectionOffset?null:this.state.completionList[this.state.selectionOffset-1].completion;s=t.findIndex(t=>t.completion===e),-1===s?s=0:s++}let n=this.state.hide;n=!e.some(e=>!!e.command.command),this.setState({completions:e,completionList:t,selectionOffset:s,hide:n,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const s=(this.state.selectionOffset+e+t+1)%(t+1);this.setSelection(s)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise(e=>{this.setState({forceComplete:!0,hide:!1},()=>{this.complete(this.props.query,this.props.selection).then(()=>{e(this.countCompletions())})})})}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(this.state.completionList[e-1],e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs["completion"+this.state.selectionOffset];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map((t,s)=>{const n=t.completions.map((t,s)=>{const n=e===this.state.selectionOffset,i=E()("mx_Autocomplete_Completion",{selected:n}),r=e;e++;return o.a.cloneElement(t.component,{key:s,ref:"completion"+r,id:Oi(r-1),className:i,onClick:()=>{this.onCompletionClicked(r)},"aria-selected":n})});return n.length>0?o.a.createElement("div",{key:s,className:"mx_Autocomplete_ProviderSection"},o.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(n)):null}).filter(e=>!!e);return!this.state.hide&&t.length>0?o.a.createElement("div",{className:"mx_Autocomplete",ref:this.containerRef},t):null}}class xi{constructor(){g()(this,"stack",[]),g()(this,"newlyTypedCharCount",0),g()(this,"currentIndex",-1),g()(this,"changedSinceLastPush",!1),g()(this,"lastCaret",null),g()(this,"nonWordBoundarySinceLastPush",!1),g()(this,"addedSinceLastPush",!1),g()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,s=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!s)||(s||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const s=e.serializeParts();this.stack.push({parts:s,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,s,n){if("historyUndo"===s||"historyRedo"===s)return!1;const i=this.shouldPush(s,n);return i?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),i}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}function Ni(e,t){const s=!t||"newline"===t.type;return!e.canEdit&&(s||!t.canEdit)}function ji(e,t){return!e.canEdit&&t}function Pi(e,t){const s=e.nextSibling;s?e.parentElement.insertBefore(t,s):e.parentElement.appendChild(t)}function Di(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode("\ufeff")),e}function Ai(e){"\ufeff"!==e.textContent&&(e.textContent="\ufeff")}function Ui(e){return e&&"SPAN"===e.tagName&&"caretNode"===e.className}function Mi(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function Li(e,t){const s=t.parts.reduce((e,t)=>{if("newline"===t.type)e.push([]);else{e[e.length-1].push(t)}return e},[[]]);s.forEach((t,s)=>{let n=e.childNodes[s];for(;n&&("DIV"!==n.tagName||n.className);)e.removeChild(n),n=e.childNodes[s];n||(n=document.createElement("div"),e.appendChild(n)),t.length?function(e,t){let s,n;const i=t[t.length-1];for(const o of t){for(s=!n?e.firstChild:s.nextSibling,Ni(o,n)&&(Ui(s)?(Ai(s),s=s.nextSibling):e.insertBefore(Di(),s));s&&!o.canUpdateDOMNode(s);){const t=s.nextSibling;e.removeChild(s),s=t}if(s&&o?o.updateDOMNode(s):o&&(s=o.toDOMNode(),e.appendChild(s)),ji(o,o===i))if(Ui(s.nextSibling))s=s.nextSibling,Ai(s);else{const e=Di();Pi(s,e),s=e}n=o}Mi(s)}(n,t):function(e){let t=!1,s=e.firstChild;for(;s;){const e=s.nextSibling;t||"BR"!==s.tagName?s.remove():t=!0,s=e}t||e.appendChild(document.createElement("br"))}(n)}),s.length?Mi(e.children[s.length-1]):function(e){const t=e.firstChild;t&&(Mi(t),t.remove())}(e)}class Fi{constructor(e,t,s=t){this.model=e,g()(this,"_start",void 0),g()(this,"_end",void 0);const n=t.compare(s)<0;this._start=n?t:s,this._end=n?s:t}moveStart(e){this._start=this._start.forwardsWhile(this.model,()=>(e-=1)>=0)}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.text.substring(s,n);e+=i}),e}replace(e){const t=e.reduce((e,t)=>e+t.text.length,0);let s=0;return this._start.iteratePartsBetween(this._end,this.model,(e,t,n)=>{s+=n-t}),this.model.replaceRange(this._start,this._end,e),t-s}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.serialize();i.text=t.text.substring(s,n);const o=this.model.partCreator.deserializePart(i);e.push(o)}),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{e+=n-s}),e}get start(){return this._start}get end(){return this._end}}function Bi(e,t,s){s instanceof Fi?function(e,t,s){const n=document.getSelection();n.removeAllRanges();const i=document.createRange(),o=Vi(e,t,s.start);i.setStart(o.node,o.offset);const r=Vi(e,t,s.end);i.setEnd(r.node,r.offset),n.addRange(i)}(e,t,s):function(e,t,s){const n=document.createRange(),{node:i,offset:o}=Vi(e,t,s);n.setStart(i,o),n.collapse(!0);const r=document.getSelection();if(1===r.rangeCount){const e=r.getRangeAt(0);if(e.startContainer===n.startContainer&&e.startOffset===n.startOffset&&e.collapsed===n.collapsed)return}r.removeAllRanges(),r.addRange(n)}(e,t,s)}function Vi(e,t,s){const{offset:n,lineIndex:i,nodeIndex:o}=function(e,t){const{parts:s}=e,n=t.index,i=function(e,t){let s=0,n=-1,i=null;for(let o=0;o<=t;++o){const r=e[o];if("newline"===r.type)s+=1,n=-1,i=null;else{if(n+=1,Ni(r,i)&&(n+=1),o<t){const t=e[o+1],s=!t||"newline"===t.type;ji(r,s)&&(n+=1)}i=r}}return{lineIndex:s,nodeIndex:n}}(s,n),{lineIndex:o}=i;let{nodeIndex:r}=i,{offset:a}=t;-1===r?a=0:({nodeIndex:r,offset:a}=function(e,t,s,n){const i=e[t];if(i&&!i.canEdit)if(0===n){s-=1;const o=e[t-1];Ni(i,o)||(n=o.text.length)}else s+=1,n=0;return{nodeIndex:s,offset:n}}(s,n,r,a));return{lineIndex:o,nodeIndex:r,offset:a}}(t,s),r=e.childNodes[i];let a;return-1===o?a=r:(a=r.childNodes[o],a.nodeType===Node.ELEMENT_NODE&&a.firstChild&&(a=a.firstChild)),{node:a,offset:n}}function Ki(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,i=e.replace(t),o=e.start.asOffset(s),r=o.add(n+i);return s.startRange(o.asPosition(s),r.asPosition(s))})}function qi(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,i=e.replace(t);return e.start.asOffset(s).add(n+i).asPosition(s)})}function Gi(e){const{model:t}=e,s=0!==e.start.offset,n=0===e.start.index,i=!n&&"newline"===t.parts[e.start.index-1].type;return!s&&(n||i)}function Wi(e){const{model:t}=e,s=t.parts[e.end.index],n=e.end.offset!==s.text.length,i=e.end.index===t.parts.length-1,o=!i&&"newline"===t.parts[e.end.index+1].type;return!n&&(i||o)}const Hi=e=>!e.text||!/\S/.test(e.text),$i=e=>"newline"===e.type;function zi(e,t,s=t){const{model:n,parts:i}=e,{partCreator:o}=n,r=[];let a=0;for(let e=2;e<i.length;e++)Hi(i[e-2])&&$i(i[e-1])&&!$i(i[e])&&!Hi(i[e])&&(a=e),$i(i[e-1])&&$i(i[e])?(r.push([a,e-1]),a=e+1):$i(i[e-2])&&Hi(i[e-1])&&$i(i[e])&&(r.push([a,e-2]),a=e+1);const c=i.map(Hi).lastIndexOf(!1);a<=c&&r.push([a,c+1]);let l=0;r.forEach(([e,n])=>{const r=e+l,a=n+l;if(a-r>0&&i[r].text.startsWith(t)&&i[a-1].text.endsWith(s)){const e=i[r].serialize();e.text=e.text.substr(t.length),i[r]=o.deserializePart(e);const n=i[a-1].serialize(),c=n.text;n.text=c.substring(0,c.length-s.length),i[a-1]=o.deserializePart(n)}else i.splice(a,0,o.plain(s)),i.splice(r,0,o.plain(t)),l+=2}),Ki(e,i)}class Yi{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e,t=!1){return new Yi(this.offset+e,t)}}function Ji(e,t,s){let n=e.firstChild;for(;n&&n!==e;){if(t(n)&&n.firstChild)n=n.firstChild;else if(n.nextSibling)n=n.nextSibling;else{for(;!n.nextSibling&&n!==e;)n=n.parentElement,n!==e&&s(n);n!==e&&(n=n.nextSibling)}}}function Qi(e,t){const{offset:s,text:n}=Xi(e,t.focusNode,t.focusOffset);return{caret:s,text:n}}function Xi(e,t,s){const{node:n,characterOffset:i}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const s=e.childNodes.length;if(!s)break;t>=s?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,s),{text:o,offsetToNode:r}=function(e,t){let s=0,n=!1,i="";function o(e){n||e===t&&(n=!0),"BR"===e.tagName&&e.nextSibling&&(n||(s+=1),i+="\n");const o=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;return Ui(e.parentElement)?1!==t.length?t.replace("\ufeff",""):"":t}(e);return o&&(n||(s+=o.length),i+=o),!0}function r(e){"DIV"===e.tagName&&e.nextSibling&&"DIV"===e.nextSibling.tagName&&(i+="\n",n||(s+=1))}return Ji(e,o,r),{text:i,offsetToNode:s}}(e,n);return{offset:function(e,t,s){if(!e)return new Yi(0,!1);let n=s===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&Ui(e.parentElement)){const t=e.nodeValue.indexOf("\ufeff");-1!==t&&t<s&&(s-=1),n=!0}return new Yi(t+s,n)}(n,r,i),text:o}}function Zi(e,t,s){const n=Xi(e,s.focusNode,s.focusOffset).offset,i=Xi(e,s.anchorNode,s.anchorOffset).offset,o=n.asPosition(t),r=i.asPosition(t);return t.startRange(o,r)}class eo{constructor(e,t,s,n){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=s,this.partCreator=n,g()(this,"queryPart",void 0),g()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e),this.updateCallback({replaceParts:[this.partCreator.plain(this.queryPart.text)],close:!0})}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}onEnter(){this.updateCallback({close:!0})}async onTab(e){const t=this.getAutocompleterComponent();0===t.countCompletions()?(await t.forceComplete(),await t.moveSelection(1)):await t.moveSelection(e.shiftKey?-1:1)}onUpArrow(e){this.getAutocompleterComponent().moveSelection(-1)}onDownArrow(e){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.queryPart=e,this.partIndex=t.index,this.updateQuery(e.text)}onComponentSelectionChange(e){e?this.updateCallback({replaceParts:this.partForCompletion(e)}):this.updateCallback({replaceParts:[this.queryPart]})}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,s=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(s,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(this.partIndex,s,t);case"command":return[this.partCreator.command(s)];default:return[this.partCreator.plain(s)]}}}var to;!function(e){e.Plain="plain",e.Newline="newline",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(to||(to={}));class so{constructor(e=""){g()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,s){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.substr(e);return this._text=this.text.substr(0,e),new io(t)}remove(e,t){const s=this.text.substr(0,e)+this.text.substr(e+t);for(let n=e;n<t+e;++n){const e=this.text.charAt(n);if(!this.acceptsRemoval(n,e))return s}this._text=s}appendUntilRejected(e,t){const s=this.text.length;for(let n=0;n<e.length;++n){const i=e.charAt(n);if(!this.acceptsInsertion(i,s+n,t))return this._text=this._text+e.substr(0,n),e.substr(n)}this._text=this._text+e}validateAndInsert(e,t,s){for(let n=0;n<t.length;++n){const i=t.charAt(n);if(!this.acceptsInsertion(i,e+n,s))return!1}const n=this._text.substr(0,e),i=this._text.substr(e);return this._text=n+t+i,!0}createAutoComplete(e){}trim(e){const t=this._text.substr(e);return this._text=this._text.substr(0,e),t}get text(){return this._text}get canEdit(){return!0}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class no extends so{acceptsInsertion(e,t,s){return"\n"!==e&&("insertFromPaste"===s||"insertFromDrop"===s||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||" "!==this._text[t-1]))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class io extends no{get type(){return to.Plain}}class oo extends so{constructor(e,t){super(t),this.resourceId=e}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}_setAvatarVars(e,t,s){const n=`url('${t}')`,i=`'${s}'`;e.style.getPropertyValue("--avatar-background")!==n&&e.style.setProperty("--avatar-background",n),e.style.getPropertyValue("--avatar-letter")!==i&&e.style.setProperty("--avatar-letter",i)}get canEdit(){return!1}}class ro extends so{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return to.Newline}get canEdit(){return!1}}class ao extends oo{constructor(e,t){super(e,e),this.room=t}setAvatar(e){let t="",s=He.b(this.room,16*window.devicePixelRatio,16*window.devicePixelRatio,"crop");s||(t=He.e(this.room?this.room.name:this.resourceId),s=He.d(this.room?this.room.roomId:this.resourceId)),this._setAvatarVars(e,s,t)}get type(){return to.RoomPill}get className(){return"mx_RoomPill mx_Pill"}}class co extends ao{get type(){return to.AtRoomPill}}class lo extends oo{constructor(e,t,s){super(e,t),this.member=s}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,s=He.d(this.member.userId),n=He.a(this.member,16*window.devicePixelRatio,16*window.devicePixelRatio,"crop");let i="";n===s&&(i=He.e(t)),this._setAvatarVars(e,n,i)}get type(){return to.UserPill}get className(){return"mx_UserPill mx_Pill"}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}}class uo extends no{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,s){return 0===t||super.acceptsInsertion(e,t,s)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return to.PillCandidate}}class ho{constructor(e,t,s=null){this.room=e,this.client=t,g()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:s&&s(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,s){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new ro;default:return new io}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case to.Plain:return this.plain(e.text);case to.Newline:return this.newline();case to.AtRoomPill:return this.atRoomPill(e.text);case to.PillCandidate:return this.pillCandidate(e.text);case to.RoomPill:return this.roomPill(e.text);case to.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new io(e)}newline(){return new ro("\n")}pillCandidate(e){return new uo(e,this.autoCompleteCreator)}roomPill(e,t){let s;return s=t||"#"!==e[0]?this.client.getRoom(t||e):this.client.getRooms().find(t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e)),new ao(e,s)}atRoomPill(e){return new co(e,this.room)}userPill(e,t){const s=this.room.getMember(t);return new lo(t,e,s)}createMentionParts(e,t,s){return[this.userPill(t,s),this.plain(0===e?": ":" ")]}}class mo extends ho{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new po(e,this.autoCompleteCreator)}deserializePart(e){return"command"===e.type?this.command(e.text):super.deserializePart(e)}}class po extends uo{get type(){return to.Command}}function go(e,t){const s=[];return e.split("@room").forEach((e,n,i)=>{e.length&&s.push(t.plain(e));n===i.length-1||s.push(t.atRoomPill("@room"))}),s}function fo(e,t,s,n){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t){const s=parseInt(e.nodeName.substr(1),10);return t.plain("#".repeat(s)+" ")}(e,t);case"A":return function(e,t){const{href:s}=e,n=Object($n.b)(s);switch(n?n[0]:void 0){case"@":return t.userPill(e.textContent,n);case"#":return t.roomPill(n);default:return s===e.textContent?t.plain(e.textContent):t.plain(`[${e.textContent.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}}(e,t);case"BR":return t.newline();case"EM":return t.plain(`_${e.textContent}_`);case"STRONG":return t.plain(`**${e.textContent}**`);case"PRE":return function(e,t){const s=[];let n="";if(e.firstChild&&"CODE"===e.firstChild.nodeName)for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){n=t.substr("language-".length);break}const i=("```"+n+"\n"+e.textContent+"```").split("\n");return i.forEach((e,n)=>{s.push(t.plain(e)),n<i.length-1&&s.push(t.newline())}),s}(e,t);case"CODE":return t.plain(`\`${e.textContent}\``);case"DEL":return t.plain(`<del>${e.textContent}</del>`);case"LI":{const s="  ".repeat(n.listDepth-1);if("OL"===e.parentElement.nodeName){const e=n.listIndex[n.listIndex.length-1];return n.listIndex[n.listIndex.length-1]+=1,t.plain(`${s}${e}. `)}return t.plain(s+"- ")}case"P":if(s)return t.newline();break;case"OL":n.listIndex.push(e.start||1);case"UL":n.listDepth=(n.listDepth||0)+1;default:if(!_o(e))return t.plain(e.textContent)}}function _o(e){switch(e.nodeName){case"PRE":return!1;default:return Object(qn.b)(e)}}function vo(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}function yo(e,t,s){const n=e.split(/\r\n|\r|\n/g);return n.reduce((e,i,o)=>{s&&e.push(t.plain("> ")),e.push(...go(i,t));return o===n.length-1||e.push(t.newline()),e},[])}function bo(e,t,{isQuotedMessage:s=!1}={}){const n=e.getContent();let i;return i="org.matrix.custom.html"===n.format?function(e,t,s){const n=(new DOMParser).parseFromString(e,"text/html").body,i=[];let o,r=s;const a={listIndex:[]};return Ji(n,(function(e){if(vo(e))return!1;"BLOCKQUOTE"===e.nodeName&&(r=!0);const s=[];if(o&&(Object(qn.b)(o)||Object(qn.b)(e))&&s.push(t.newline()),e.nodeType===Node.TEXT_NODE)s.push(...go(e.nodeValue,t));else if(e.nodeType===Node.ELEMENT_NODE){const n=fo(e,t,o,a);n&&(Array.isArray(n)?s.push(...n):s.push(n))}if(s.length&&r){!function(e,t,s){e&&t.splice(0,0,s.plain("> "));for(let e=0;e<t.length;e+=1)"newline"===t[e].type&&(t.splice(e+1,0,s.plain("> ")),e+=1)}(0===i.length,s,t)}i.push(...s);const n=_o(e);return o=n?null:e,n}),(function(e){if(!vo(e)){switch(e.nodeName){case"BLOCKQUOTE":r=!1;break;case"OL":a.listIndex.pop();case"UL":a.listDepth-=1}o=e}})),i}(n.formatted_body||"",t,s):yo(n.body||"",t,s),"m.emote"===n.msgtype&&i.unshift(t.plain("/me ")),i}var Eo=s(475);class So extends o.a.PureComponent{constructor(e){super(e),this.state={visible:!1}}render(){const e=E()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return o.a.createElement("div",{className:e,ref:e=>this._formatBarRef=e},o.a.createElement(wo,{label:Object(c.a)("Bold"),onClick:()=>this.props.onAction("bold"),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),o.a.createElement(wo,{label:Object(c.a)("Italics"),onClick:()=>this.props.onAction("italics"),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),o.a.createElement(wo,{label:Object(c.a)("Strikethrough"),onClick:()=>this.props.onAction("strikethrough"),icon:"Strikethrough",visible:this.state.visible}),o.a.createElement(wo,{label:Object(c.a)("Code block"),onClick:()=>this.props.onAction("code"),icon:"Code",visible:this.state.visible}),o.a.createElement(wo,{label:Object(c.a)("Quote"),onClick:()=>this.props.onAction("quote"),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}))}showAt(e){this.setState({visible:!0});const t=this._formatBarRef.parentElement.getBoundingClientRect();this._formatBarRef.style.left=e.left-t.left+"px",this._formatBarRef.style.top=e.top-t.top-16-12+"px"}hide(){this.setState({visible:!1})}}g()(So,"propTypes",{onAction:re.a.func.isRequired,shortcuts:re.a.object.isRequired});class wo extends o.a.PureComponent{render(){const e="mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon"+this.props.icon;let t;this.props.shortcut&&(t=o.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const s=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),o.a.createElement("div",{className:"mx_Tooltip_sub"},t));return o.a.createElement(C.a,{as:"span",role:"button",onClick:this.props.onClick,title:this.props.label,tooltip:s,className:e})}}g()(wo,"propTypes",{label:re.a.string.isRequired,onClick:re.a.func.isRequired,icon:re.a.string.isRequired,shortcut:re.a.string,visible:re.a.bool});const Co=new RegExp("(?:^|\\s)("+Ei.a.source+")\\s$"),Ro=-1!==navigator.platform.indexOf("Mac");function ko(e){return(Ro?"⌘":"Ctrl")+"+"+e}function Io(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}var Oo;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote"}(Oo||(Oo={}));class To extends o.a.Component{constructor(e){super(e),g()(this,"editorRef",Object(i.createRef)()),g()(this,"autocompleteRef",Object(i.createRef)()),g()(this,"formatBarRef",Object(i.createRef)()),g()(this,"modifiedFlag",!1),g()(this,"isIMEComposing",!1),g()(this,"hasTextSelected",!1),g()(this,"_isCaretAtEnd",void 0),g()(this,"lastCaret",void 0),g()(this,"lastSelection",void 0),g()(this,"emoticonSettingHandle",void 0),g()(this,"shouldShowPillAvatarSettingHandle",void 0),g()(this,"historyManager",new xi),g()(this,"replaceEmoticon",e=>{const{model:t}=this.props,s=t.startRange(e);let n=8;s.expandBackwardsWhile((e,s)=>{const i=t.parts[e];return n-=1,n>=0&&("plain"===i.type||"pill-candidate"===i.type)});const i=Co.exec(s.text);if(i){const e=i[1].replace("-",""),n=yi.c.get(e)||yi.c.get(e.toLowerCase());if(n){const{partCreator:e}=t,o=" "===i[0][0];return s.moveStart(i.index+(o?1:0)),s.replace([e.plain(n.unicode+" ")])}}}),g()(this,"updateEditorState",(e,t,s)=>{if(Li(this.editorRef.current,this.props.model),e){try{Bi(this.editorRef.current,this.props.model,e)}catch(e){console.error(e)}const t=e instanceof Fi?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:n}=this.props.model;this.props.placeholder&&(n?this.showPlaceholder():this.hidePlaceholder()),n&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete}),this.historyManager.tryPush(this.props.model,e,t,s);let i=!this.props.model.isEmpty;if(i&&"command"===this.props.model.parts[0].type){const{cmd:e}=li(this.props.model.parts[0].text);ci.has(e)&&ci.get(e).category===ni.messages||(i=!1)}Eo.a.sharedInstance().setSelfTyping(this.props.room.roomId,i),this.props.onChange&&this.props.onChange()}),g()(this,"onCompositionStart",()=>{this.isIMEComposing=!0,this.hidePlaceholder()}),g()(this,"onCompositionEnd",()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then(()=>{this.onInput({inputType:"insertCompositionText"})})}),g()(this,"onCutCopy",(e,t)=>{const s=document.getSelection(),n=s.toString();if(n){const{model:i}=this.props,o=Zi(this.editorRef.current,i,s),r=o.parts.map(e=>e.serialize());e.clipboardData.setData("application/x-element-composer",JSON.stringify(r)),e.clipboardData.setData("text/plain",n),"cut"===t&&(this.modifiedFlag=!0,qi(o,[])),e.preventDefault()}}),g()(this,"onCopy",e=>{this.onCutCopy(e,"copy")}),g()(this,"onCut",e=>{this.onCutCopy(e,"cut")}),g()(this,"onPaste",e=>{if(e.preventDefault(),this.props.onPaste&&this.props.onPaste(e,this.props.model))return!0;const{model:t}=this.props,{partCreator:s}=t,n=e.clipboardData.getData("application/x-element-composer");let i;if(n){i=JSON.parse(n).map(e=>s.deserializePart(e))}else{i=yo(e.clipboardData.getData("text/plain"),s)}this.modifiedFlag=!0;qi(Zi(this.editorRef.current,t,document.getSelection()),i)}),g()(this,"onInput",e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:s,text:n}=Qi(this.editorRef.current,t);this.props.model.update(n,e.inputType,s)}),g()(this,"onBlur",()=>{document.removeEventListener("selectionchange",this.onSelectionChange)}),g()(this,"onFocus",()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()}),g()(this,"onSelectionChange",()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,this.formatBarRef.current&&this.formatBarRef.current.hide();else if(!t.isCollapsed&&!e&&(this.hasTextSelected=!0,this.formatBarRef.current)){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}),g()(this,"onKeyDown",e=>{const t=this.props.model,s=Ro?e.metaKey:e.ctrlKey;let n=!1;if(s&&e.key===Yt.a.B)this.onFormatAction(Oo.Bold),n=!0;else if(s&&e.key===Yt.a.I)this.onFormatAction(Oo.Italics),n=!0;else if(s&&e.key===Yt.a.GREATER_THAN)this.onFormatAction(Oo.Quote),n=!0;else if(!Ro&&s&&e.key===Yt.a.Y||Ro&&s&&e.shiftKey&&e.key===Yt.a.Z){if(this.historyManager.canRedo()){const{parts:e,caret:s}=this.historyManager.redo();t.reset(e,s,"historyRedo")}n=!0}else if(s&&e.key===Yt.a.Z){if(this.historyManager.canUndo()){const{parts:e,caret:s}=this.historyManager.undo(this.props.model);t.reset(e,s,"historyUndo")}n=!0}else if(e.key===Yt.a.ENTER&&(e.shiftKey||Ro&&e.altKey))this.insertText("\n"),n=!0;else if(s&&e.key===Yt.a.HOME&&!e.shiftKey)Bi(this.editorRef.current,t,{index:0,offset:0}),n=!0;else if(s&&e.key===Yt.a.END&&!e.shiftKey)Bi(this.editorRef.current,t,{index:t.parts.length-1,offset:t.parts[t.parts.length-1].text.length}),n=!0;else{const s=e.metaKey||e.altKey,i=s||e.shiftKey;if(t.autoComplete&&t.autoComplete.hasCompletions()){const o=t.autoComplete;switch(e.key){case Yt.a.ARROW_UP:i||(o.onUpArrow(e),n=!0);break;case Yt.a.ARROW_DOWN:i||(o.onDownArrow(e),n=!0);break;case Yt.a.TAB:s||(o.onTab(e),n=!0);break;case Yt.a.ESCAPE:i||(o.onEscape(e),n=!0);break;default:return}}else e.key===Yt.a.TAB?(this.tabCompleteName(e),n=!0):e.key!==Yt.a.BACKSPACE&&e.key!==Yt.a.DELETE||this.formatBarRef.current.hide()}n&&(e.preventDefault(),e.stopPropagation())}),g()(this,"onAutoCompleteConfirm",e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)}),g()(this,"onAutoCompleteSelectionChange",(e,t)=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentSelectionChange(e),this.setState({completionIndex:t})}),g()(this,"configureEmoticonAutoReplace",()=>{const e=w.a.getValue("MessageComposerInput.autoReplaceEmoji");this.props.model.setTransformCallback(e?this.replaceEmoticon:null)}),g()(this,"configureShouldShowPillAvatar",()=>{const e=w.a.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})}),g()(this,"onFormatAction",e=>{const t=Zi(this.editorRef.current,this.props.model,document.getSelection());if(0!==t.length)switch(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,e){case Oo.Bold:zi(t,"**");break;case Oo.Italics:zi(t,"_");break;case Oo.Strikethrough:zi(t,"<del>","</del>");break;case Oo.Code:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;s.some(e=>"newline"===e.type)?(s.unshift(n.plain("```"),n.newline()),Gi(e)||s.unshift(n.newline()),s.push(n.newline(),n.plain("```")),Wi(e)||s.push(n.newline())):(s.unshift(n.plain("`")),s.push(n.plain("`"))),Ki(e,s)}(t);break;case Oo.Quote:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;for(let e=0;e<s.length;++e){"newline"===s[e].type&&s.splice(e+1,0,n.plain("> "))}s.unshift(n.plain("> ")),Gi(e)||s.unshift(n.newline()),Wi(e)||s.push(n.newline()),s.push(n.newline()),Ki(e,s)}(t)}}),this.state={showPillAvatar:w.a.getValue("Pill.shouldShowPillAvatar")},this.emoticonSettingHandle=w.a.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=w.a.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar)}componentDidUpdate(e){if(this.props.placeholder!==e.placeholder&&this.props.placeholder){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e,t="insertText"){const s=document.getSelection(),{caret:n,text:i}=Qi(this.editorRef.current,s),o=i.substr(0,n.offset)+e+i.substr(n.offset);n.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(o,t,n)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=Io(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,s=e,t.anchorNode!==s.anchorNode||t.anchorOffset!==s.anchorOffset||t.focusNode!==s.focusNode||t.focusOffset!==s.focusOffset||t.isCollapsed!==s.isCollapsed||t.rangeCount!==s.rangeCount||t.type!==s.type)){this.lastSelection=Io(e);const{caret:t,text:s}=Qi(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===s.length}var t,s;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(e){try{await new Promise(e=>this.setState({showVisualBell:!1},e));const{model:t}=this.props,s=this.getCaret(),n=t.positionForOffset(s.offset,s.atNodeEnd),i=t.startRange(n);i.expandBackwardsWhile((e,t,s)=>" "!==s.text[t]&&("plain"===s.type||"pill-candidate"===s.type||"command"===s.type));const{partCreator:o}=t;await t.transform(()=>{const e=i.replace([o.pillCandidate(i.text)]);return t.positionForOffset(s.offset+e,!0)}),t.autoComplete&&(await t.autoComplete.onTab(e),t.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),t.autoComplete.close()))}catch(e){console.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),w.a.unwatchSetting(this.emoticonSettingHandle),w.a.unwatchSetting(this.shouldShowPillAvatarSettingHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);var t,s;e.partCreator.setAutoCompleteCreator((t=()=>this.autocompleteRef.current,s=e=>new Promise(t=>this.setState({query:e},t)),e=>n=>new eo(n,t,s,e))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,s=t.length;e=o.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},o.a.createElement(Ti,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:s,start:s},room:this.props.room}))}const t=E()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),s=E()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar}),n={bold:ko("B"),italics:ko("I"),quote:ko(">")},{completionIndex:i}=this.state;return o.a.createElement("div",{className:t},e,o.a.createElement(So,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:n}),o.a.createElement("div",{className:s,contentEditable:"true",tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"both","aria-haspopup":"listbox","aria-expanded":Boolean(this.state.autoComplete),"aria-activedescendant":i>=0?Oi(i):void 0,dir:"auto"}))}focus(){this.editorRef.current.focus()}}var xo=s(454),No=s(80);const jo=/^#\/(?:user|room|group)\/(([#!@+]).*?)(?=\/|\?|$)/;class Po extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{resourceId:null,pillType:null,member:null,group:null,room:null}),g()(this,"onUserPillClicked",()=>{u.a.dispatch({action:h.a.ViewUser,member:this.state.member})})}static isPillUrl(e){return!!Object($n.b)(e)}static isMessagePillUrl(e){return!!jo.exec(e)}static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}async UNSAFE_componentWillReceiveProps(e){let t,s;if(e.url)if(e.inMessage){const n=jo.exec(e.url)||[];t=n[1],s=n[2]}else t=Object($n.b)(e.url),s=t?t[0]:void 0;const n=this.props.type||{"@":Po.TYPE_USER_MENTION,"#":Po.TYPE_ROOM_MENTION,"!":Po.TYPE_ROOM_MENTION,"+":Po.TYPE_GROUP_MENTION}[s];let i,o,r;switch(n){case Po.TYPE_AT_ROOM_MENTION:r=e.room;break;case Po.TYPE_USER_MENTION:{const s=e.room?e.room.getMember(t):void 0;i=s,s||(i=new de.k(null,t),this.doProfileLookup(t,i))}break;case Po.TYPE_ROOM_MENTION:{const e="#"===t[0]?L.a.get().getRooms().find(e=>e.getCanonicalAlias()===t||e.getAltAliases().includes(t)):L.a.get().getRoom(t);r=e}break;case Po.TYPE_GROUP_MENTION:{const e=L.a.get();try{o=await Vt.a.getGroupProfileCached(e,t)}catch(e){o={groupId:t,avatarUrl:null,name:null}}}}this.setState({resourceId:t,pillType:n,member:i,group:o,room:r})}componentDidMount(){this._unmounted=!1,this._matrixClient=L.a.get(),this.UNSAFE_componentWillReceiveProps(this.props)}componentWillUnmount(){this._unmounted=!0}doProfileLookup(e,t){L.a.get().getProfileInfo(e).then(e=>{this._unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))}).catch(t=>{console.error("Could not retrieve profile data for "+e+":",t)})}render(){const e=d.getComponent("views.avatars.BaseAvatar"),t=d.getComponent("avatars.MemberAvatar"),s=d.getComponent("avatars.RoomAvatar"),n=this.state.resourceId;let i,r,a,c=null,l=n,u=this.props.url;switch(this.state.pillType){case Po.TYPE_AT_ROOM_MENTION:{const e=this.props.room;e&&(l="@room",this.props.shouldShowPillAvatar&&(c=o.a.createElement(s,{room:e,width:16,height:16,"aria-hidden":"true"})),i="mx_AtRoomPill")}break;case Po.TYPE_USER_MENTION:{const e=this.state.member;e&&(r=e.userId,e.rawDisplayName=e.rawDisplayName||"",l=e.rawDisplayName,this.props.shouldShowPillAvatar&&(c=o.a.createElement(t,{member:e,width:16,height:16,"aria-hidden":"true"})),i="mx_UserPill",u=null,a=this.onUserPillClicked)}break;case Po.TYPE_ROOM_MENTION:{const e=this.state.room;e&&(l=n,this.props.shouldShowPillAvatar&&(c=o.a.createElement(s,{room:e,width:16,height:16,"aria-hidden":"true"}))),i="mx_RoomPill"}break;case Po.TYPE_GROUP_MENTION:if(this.state.group){const{avatarUrl:t,groupId:s,name:n}=this.state.group,r=L.a.get();l=s,this.props.shouldShowPillAvatar&&(c=o.a.createElement(e,{name:n||s,width:16,height:16,"aria-hidden":"true",url:t?r.mxcUrlToHttp(t,16,16):null})),i="mx_GroupPill"}}const h=E()("mx_Pill",i,{mx_UserPill_me:r===L.a.get().getUserId(),mx_UserPill_selected:this.props.isSelected});return this.state.pillType?o.a.createElement(S.a.Provider,{value:this._matrixClient},this.props.inMessage?o.a.createElement("a",{className:h,href:u,onClick:a,title:n,"data-offset-key":this.props.offsetKey},c,l):o.a.createElement("span",{className:h,title:n,"data-offset-key":this.props.offsetKey},c,l)):null}}g()(Po,"TYPE_USER_MENTION","TYPE_USER_MENTION"),g()(Po,"TYPE_ROOM_MENTION","TYPE_ROOM_MENTION"),g()(Po,"TYPE_GROUP_MENTION","TYPE_GROUP_MENTION"),g()(Po,"TYPE_AT_ROOM_MENTION","TYPE_AT_ROOM_MENTION"),g()(Po,"propTypes",{type:re.a.string,url:re.a.string,inMessage:re.a.bool,room:re.a.instanceOf(de.j),shouldShowPillAvatar:re.a.bool,isSelected:re.a.bool});var Do,Ao,Uo,Mo=Po;let Lo=Object(bn.a)("views.settings.BridgeTile")((Uo=Ao=class extends o.a.PureComponent{constructor(...e){super(...e),g()(this,"state",{visible:!1})}_toggleVisible(){this.setState({visible:!this.state.visible})}render(){const e=this.props.ev.getContent(),{channel:t,network:s,protocol:n}=e,i=n.displayname||n.id,r=t.displayname||t.id,a=s?s.displayname||s.id:i;let l=null;e.creator&&(l=Object(c.a)("This bridge was provisioned by <user />.",{},{user:o.a.createElement(Mo,{type:Mo.TYPE_USER_MENTION,room:this.props.room,url:Object($n.g)(e.creator),shouldShowPillAvatar:w.a.getValue("Pill.shouldShowPillAvatar")})}));const d=Object(c.a)("This bridge is managed by <user />.",{},{user:o.a.createElement(Mo,{type:Mo.TYPE_USER_MENTION,room:this.props.room,url:Object($n.g)(this.props.ev.getSender()),shouldShowPillAvatar:w.a.getValue("Pill.shouldShowPillAvatar")})});let u;if(n.avatar){const e=Object(No.a)(L.a.get().getHomeserverUrl(),n.avatar,64,64,"crop");u=o.a.createElement(q.a,{className:"protocol-icon",width:48,height:48,resizeMethod:"crop",name:i,idName:i,url:e})}else u=o.a.createElement("div",{class:"noProtocolIcon"});const h=this.props.ev.getId(),m="metadata"+(this.state.visible?" visible":"");return o.a.createElement("li",{key:h},o.a.createElement("div",{className:"column-icon"},u),o.a.createElement("div",{className:"column-data"},o.a.createElement("h3",null,i),o.a.createElement("p",{className:"workspace-channel-details"},o.a.createElement("span",null,Object(c.a)("Workspace: %(networkName)s",{networkName:a})),o.a.createElement("span",{className:"channel"},Object(c.a)("Channel: %(channelName)s",{channelName:r}))),o.a.createElement("p",{className:m},l," ",d),o.a.createElement(Z.a,{className:"mx_showMore",kind:"secondary",onClick:this._toggleVisible.bind(this)},this.state.visible?Object(c.a)("Show less"):Object(c.a)("Show more"))))}},g()(Ao,"propTypes",{ev:re.a.object.isRequired,room:re.a.object.isRequired}),Do=Uo))||Do;const Fo=["uk.half-shot.bridge"];class Bo extends o.a.Component{renderBridgeCard(e,t){const s=e.getContent();return s&&s.channel&&s.protocol?o.a.createElement(Lo,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){const t=L.a.get().getRoom(e).currentState;return[].concat(...Fo.map(e=>Array.from(t.events.get(e).values())))}render(){const e=Bo.getBridgeStateEvents(this.props.roomId),t=L.a.get().getRoom(this.props.roomId);let s;return s=e.length>0?o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),o.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},e.map(e=>this.renderBridgeCard(e,t)))):o.a.createElement("p",null,Object(c.a)("This room isn’t bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Bridges")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},s))}}var Vo=s(548),Ko=s(466);function qo(e,t){const s=L.a.get().getRoom(t),n=s&&s.getMember(e);return n?n.name:e}function Go(e,t){const s=qo(e,t);return s!==e?Object(c.a)("%(name)s (%(userId)s)",{name:s,userId:e}):e}class Wo extends o.a.PureComponent{constructor(e){super(e),g()(this,"intervalHandle",void 0),g()(this,"_checkRequestIsPending",()=>{const{request:e}=this.props;e.canAccept||ks.a.sharedInstance().dismissToast(this.props.toastKey)}),g()(this,"cancel",()=>{ks.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){console.error("Error while cancelling verification request",e)}}),g()(this,"accept",async()=>{ks.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=L.a.get();try{if(e.channel.roomId)u.a.dispatch({action:"view_room",room_id:e.channel.roomId,should_peek:!1}),u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Lt.b.EncryptionPanel,refireParams:{verificationRequest:e,member:t.getUser(e.otherUserId)}});else{const t=d.getComponent("views.dialogs.VerificationRequestDialog");ke.a.createTrackedDialog("Incoming Verification","",t,{verificationRequest:e},null,!1,!0)}await e.accept()}catch(e){console.error(e.message)}}),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on("change",this._checkRequestIsPending),this._checkRequestIsPending(),e.isSelfVerification){const t=L.a.get();this.setState({device:t.getStoredDevice(t.getUserId(),e.channel.deviceId)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off("change",this._checkRequestIsPending)}render(){const{request:e}=this.props;let t;if(e.isSelfVerification)this.state.device&&(t=Object(c.a)("From %(deviceName)s (%(deviceId)s)",{deviceName:this.state.device.getDisplayName(),deviceId:this.state.device.deviceId}));else{const s=e.otherUserId,n=e.channel.roomId;if(t=n?Go(s,n):s,t===s){const e=L.a.get().getUser(s);e&&e.displayName&&(t=Object(c.a)("%(name)s (%(userId)s)",{name:e.displayName,userId:s}))}}const s=0===this.state.counter?Object(c.a)("Decline"):Object(c.a)("Decline (%(counter)s)",{counter:this.state.counter});return o.a.createElement(Rs.a,{description:t,acceptLabel:Object(c.a)("Accept"),onAccept:this.accept,rejectLabel:s,onReject:this.cancel})}}var Ho=s(534),$o=s(177);class zo extends o.a.Component{constructor(...e){super(...e),g()(this,"decryptingEvents",new Set),g()(this,"state",{timelineSet:null}),g()(this,"onRoomTimeline",(e,t,s,n,i)=>{t.roomId===this.props.roomId&&!s&&i&&i.liveEvent&&!e.isRedacted()&&(e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e))}),g()(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const s=e.getId();this.decryptingEvents.delete(s)&&(t||this.addEncryptedLiveEvent(e))}),g()(this,"onPaginationRequest",(e,t,s)=>{const n=L.a.get(),i=$o.a.get(),o=this.props.roomId,r=n.getRoom(o);return n.isRoomEncrypted(o)&&null!==i?i.paginateTimelineWindow(r,e,t,s):e.paginate(t,s)})}addEncryptedLiveEvent(e,t){if(!this.state.timelineSet)return;const s=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&-1!=["m.file","m.image","m.video","m.audio"].indexOf(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,s,!1))}async componentDidMount(){const e=L.a.get();await this.updateTimelineSet(this.props.roomId),L.a.get().isRoomEncrypted(this.props.roomId)&&null!==$o.a.get()&&(e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted))}componentWillUnmount(){const e=L.a.get();null!==e&&L.a.get().isRoomEncrypted(this.props.roomId)&&null!==$o.a.get()&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted))}async fetchFileEventsServer(e){const t=L.a.get(),s=new de.d(t.credentials.userId);s.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}});const n=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,s);s.filterId=n;return e.getOrCreateFilteredTimelineSet(s)}async updateTimelineSet(e){const t=L.a.get(),s=t.getRoom(e),n=$o.a.get();if(this.noRoom=!s,s){let i;try{if(i=await this.fetchFileEventsServer(s),t.isRoomEncrypted(e)&&null!==n){const e=i.getLiveTimeline();await n.populateFileTimeline(i,e,s,10)}this.setState({timelineSet:i})}catch(e){console.error("Failed to get or create file panel filter",e)}}else console.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(L.a.get().isGuest())return o.a.createElement(hn.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(c.a)("You must <a>register</a> to use this functionality",{},{a:e=>o.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return o.a.createElement(hn.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(c.a)("You must join the room to see its files")));const e=d.getComponent("structures.TimelinePanel"),t=d.getComponent("elements.Spinner"),s=o.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},o.a.createElement("h2",null,Object(c.a)("No files visible in this room")),o.a.createElement("p",null,Object(c.a)("Attach files from chat or just drag and drop them anywhere in a room.")));return this.state.timelineSet?o.a.createElement(hn.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary,withoutScrollContainer:!0},o.a.createElement(e,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,tileShape:"file_grid",resizeNotifier:this.props.resizeNotifier,empty:s})):o.a.createElement(hn.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary},o.a.createElement(t,null))}}g()(zo,"propTypes",{roomId:re.a.string.isRequired,onClose:re.a.func.isRequired});var Yo=zo;class Jo extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_GenericErrorPage"},o.a.createElement("div",{className:"mx_GenericErrorPage_box"},o.a.createElement("h1",null,this.props.title),o.a.createElement("p",null,this.props.message)))}}g()(Jo,"propTypes",{title:re.a.object.isRequired,message:re.a.object.isRequired});var Qo=s(343),Xo=s(344),Zo=s(67),er=s(259),tr=s(218);const sr=Object(c.b)("<h1>HTML for your community's page</h1>\n<p>\n    Use the long description to introduce new members to the community, or distribute\n    some important <a href=\"foo\">links</a>\n</p>\n<p>\n    You can even use 'img' tags\n</p>\n"),nr=re.a.shape({room_id:re.a.string.isRequired,profile:re.a.shape({name:re.a.string,avatar_url:re.a.string,canonical_alias:re.a.string}).isRequired}),ir=re.a.shape({summaryInfo:re.a.shape({user_id:re.a.string.isRequired,role_id:re.a.string,avatar_url:re.a.string,displayname:re.a.string}).isRequired});class or extends o.a.Component{constructor(...e){super(...e),g()(this,"onAddRoomsToSummaryClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");ke.a.createTrackedDialog("Add Rooms to Group Summary","",t,{title:Object(c.a)("Add rooms to the community summary"),description:Object(c.a)("Which rooms would you like to add to this summary?"),placeholder:Object(c.a)("Room name or address"),button:Object(c.a)("Add to summary"),pickerType:"room",validAddressTypes:["mx-room-id"],groupId:this.props.groupId,onFinished:(e,t)=>{if(!e)return;const s=[];Object(Ze.a)(t.map(e=>Zo.a.addRoomToGroupSummary(this.props.groupId,e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to add the following room to the group summary","",e,{title:Object(c.a)("Failed to add the following rooms to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?o.a.createElement(Z.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddRoomsToSummaryClicked},o.a.createElement(e,{src:s(535),width:"64",height:"64"}),o.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(c.a)("Add a Room"))):o.a.createElement("div",null),n=this.props.rooms.map(e=>o.a.createElement(rr,{key:e.room_id,groupId:this.props.groupId,editing:this.props.editing,summaryInfo:e}));let i=o.a.createElement("div",null);return this.props.category&&this.props.category.profile&&(i=o.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.category.profile.name)),o.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},i,n,t)}}g()(or,"propTypes",{rooms:re.a.arrayOf(nr).isRequired,category:re.a.shape({profile:re.a.shape({name:re.a.string}).isRequired}),groupId:re.a.string.isRequired,editing:re.a.bool.isRequired});class rr extends o.a.Component{constructor(...e){super(...e),g()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_room",room_alias:this.props.summaryInfo.profile.canonical_alias,room_id:this.props.summaryInfo.room_id})}),g()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),Zo.a.removeRoomFromGroupSummary(this.props.groupId,this.props.summaryInfo.room_id).catch(e=>{console.error("Error whilst removing room from group summary",e);const t=this.props.summaryInfo.name||this.props.summaryInfo.canonical_alias||this.props.summaryInfo.room_id,s=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove room from group summary","",s,{title:Object(c.a)("Failed to remove the room from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(c.a)("The room '%(roomName)s' could not be removed from the summary.",{roomName:t})})})})}render(){const e=d.getComponent("avatars.RoomAvatar"),t=this.props.summaryInfo.profile.name||this.props.summaryInfo.profile.canonical_alias||Object(c.a)("Unnamed Room"),n={roomId:this.props.summaryInfo.room_id,avatarUrl:this.props.summaryInfo.profile.avatar_url,name:t};let i=null;this.props.summaryInfo.profile&&this.props.summaryInfo.profile.canonical_alias&&(i=Object($n.e)(this.props.summaryInfo.profile.canonical_alias));let r=null;r=i?o.a.createElement("a",{href:i,onClick:this.onClick},t):o.a.createElement("span",null,t);const a=this.props.editing?o.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(536),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):o.a.createElement("div",null);return o.a.createElement(Z.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},o.a.createElement(e,{oobData:n,width:64,height:64}),o.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},r),a)}}g()(rr,"propTypes",{summaryInfo:nr.isRequired,editing:re.a.bool.isRequired,groupId:re.a.string.isRequired});class ar extends o.a.Component{constructor(...e){super(...e),g()(this,"onAddUsersClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");ke.a.createTrackedDialog("Add Users to Group Summary","",t,{title:Object(c.a)("Add users to the community summary"),description:Object(c.a)("Who would you like to add to this summary?"),placeholder:Object(c.a)("Name or Matrix ID"),button:Object(c.a)("Add to summary"),validAddressTypes:["mx-user-id"],groupId:this.props.groupId,shouldOmitSelf:!1,onFinished:(e,t)=>{if(!e)return;const s=[];Object(Ze.a)(t.map(e=>Zo.a.addUserToGroupSummary(e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to add the following users to the community summary","",e,{title:Object(c.a)("Failed to add the following users to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?o.a.createElement(Z.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddUsersClicked},o.a.createElement(e,{src:s(535),width:"64",height:"64"}),o.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(c.a)("Add a User"))):o.a.createElement("div",null),n=this.props.users.map(e=>o.a.createElement(cr,{key:e.user_id,summaryInfo:e,editing:this.props.editing,groupId:this.props.groupId}));let i=o.a.createElement("div",null);return this.props.role&&this.props.role.profile&&(i=o.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.role.profile.name)),o.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},i,n,t)}}g()(ar,"propTypes",{users:re.a.arrayOf(ir).isRequired,role:re.a.shape({profile:re.a.shape({name:re.a.string}).isRequired}),groupId:re.a.string.isRequired,editing:re.a.bool.isRequired});class cr extends o.a.Component{constructor(...e){super(...e),g()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_start_chat_or_reuse",user_id:this.props.summaryInfo.user_id})}),g()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),Zo.a.removeUserFromGroupSummary(this.props.groupId,this.props.summaryInfo.user_id).catch(e=>{console.error("Error whilst removing user from group summary",e);const t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,s=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove user from community summary","",s,{title:Object(c.a)("Failed to remove a user from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(c.a)("The user '%(displayName)s' could not be removed from the summary.",{displayName:t})})})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,n=Object($n.g)(this.props.summaryInfo.user_id),i=o.a.createElement("a",{href:n,onClick:this.onClick},t),r=L.a.get().mxcUrlToHttp(this.props.summaryInfo.avatar_url,64,64),a=this.props.editing?o.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(536),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):o.a.createElement("div",null);return o.a.createElement(Z.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},o.a.createElement(e,{name:t,url:r,width:64,height:64}),o.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},i),a)}}g()(cr,"propTypes",{summaryInfo:ir.isRequired,editing:re.a.bool.isRequired,groupId:re.a.string.isRequired});class lr extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{summary:null,isGroupPublicised:null,isUserPrivileged:null,groupRooms:null,groupRoomsLoading:null,error:null,editing:!1,saving:!1,uploadingAvatar:!1,avatarChanged:!1,membershipBusy:!1,publicityBusy:!1,inviterProfile:null,showRightPanel:tr.a.getSharedInstance().isOpenForGroup}),g()(this,"_onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:tr.a.getSharedInstance().isOpenForGroup})}),g()(this,"_onGroupMyMembership",e=>{this._unmounted||e.groupId!==this.props.groupId||("leave"===e.myMembership&&this._closeSettings(),this.setState({membershipBusy:!1}))}),g()(this,"onGroupStoreUpdated",e=>{if(this._unmounted)return;const t=Zo.a.getSummary(this.props.groupId);t.profile&&["avatar_url","long_description","name","short_description"].forEach(e=>{t.profile[e]=t.profile[e]||""}),this.setState({summary:t,summaryLoading:!Zo.a.isStateReady(this.props.groupId,Zo.a.STATE_KEY.Summary),isGroupPublicised:Zo.a.getGroupPublicity(this.props.groupId),isUserPrivileged:Zo.a.isUserPrivileged(this.props.groupId),groupRooms:Zo.a.getGroupRooms(this.props.groupId),groupRoomsLoading:!Zo.a.isStateReady(this.props.groupId,Zo.a.STATE_KEY.GroupRooms),isUserMember:Zo.a.getGroupMembers(this.props.groupId).some(e=>e.userId===this._matrixClient.credentials.userId)}),this.props.groupIsNew&&e&&this._onEditClick()}),g()(this,"_onEditClick",()=>{this.setState({editing:!0,profileForm:Object.assign({},this.state.summary.profile),joinableForm:{policyType:this.state.summary.profile.is_openly_joinable?"open":"invite"}})}),g()(this,"_onShareClick",()=>{const e=d.getComponent("dialogs.ShareDialog");ke.a.createTrackedDialog("share community dialog","",e,{target:this._matrixClient.getGroup(this.props.groupId)||new de.e(this.props.groupId)})}),g()(this,"_onCancelClick",()=>{this._closeSettings()}),g()(this,"_onAction",e=>{switch(e.action){case"close_settings":this.setState({editing:!1,profileForm:null})}}),g()(this,"_closeSettings",()=>{u.a.dispatch({action:"close_settings"})}),g()(this,"_onNameChange",e=>{const t=Object.assign(this.state.profileForm,{name:e});this.setState({profileForm:t})}),g()(this,"_onShortDescChange",e=>{const t=Object.assign(this.state.profileForm,{short_description:e});this.setState({profileForm:t})}),g()(this,"_onLongDescChange",e=>{const t=Object.assign(this.state.profileForm,{long_description:e.target.value});this.setState({profileForm:t})}),g()(this,"_onAvatarSelected",e=>{const t=e.target.files[0];t&&(this.setState({uploadingAvatar:!0}),this._matrixClient.uploadContent(t).then(e=>{const t=Object.assign(this.state.profileForm,{avatar_url:e});this.setState({uploadingAvatar:!1,profileForm:t,avatarChanged:!0})}).catch(e=>{this.setState({uploadingAvatar:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to upload avatar image",e),ke.a.createTrackedDialog("Failed to upload image","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to upload image")})}))}),g()(this,"_onJoinableChange",e=>{this.setState({joinableForm:{policyType:e.target.value}})}),g()(this,"_onSaveClick",()=>{this.setState({saving:!0});(this.state.isUserPrivileged?this._saveGroup():Promise.resolve()).then(e=>{this.setState({saving:!1,editing:!1,summary:null}),u.a.dispatch({action:"panel_disable"}),this._initGroupStore(this.props.groupId),this.state.avatarChanged&&Vt.a.refreshGroupProfile(this._matrixClient,this.props.groupId)}).catch(e=>{this.setState({saving:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to save community profile",e),ke.a.createTrackedDialog("Failed to update group","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to update community")})}).finally(()=>{this.setState({avatarChanged:!1})})}),g()(this,"_onAcceptInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(Ze.c)(500),Zo.a.acceptGroupInvite(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error accepting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to accept invite")})})}),g()(this,"_onRejectInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(Ze.c)(500),Zo.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to reject invite")})})}),g()(this,"_onJoinClick",async()=>{this._matrixClient.isGuest()?u.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+this.props.groupId}}):(this.setState({membershipBusy:!0}),await Object(Ze.c)(500),Zo.a.joinGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error joining room","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to join community")})}))}),g()(this,"_onLeaveClick",()=>{const e=d.getComponent("dialogs.QuestionDialog"),t=this._leaveGroupWarnings();ke.a.createTrackedDialog("Leave Group","",e,{title:Object(c.a)("Leave Community"),description:o.a.createElement("span",null,Object(c.a)("Leave %(groupName)s?",{groupName:this.props.groupId}),t),button:Object(c.a)("Leave"),danger:this.state.isUserPrivileged,onFinished:async e=>{e&&(this.setState({membershipBusy:!0}),await Object(Ze.c)(500),Zo.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error leaving community","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to leave community")})}))}})}),g()(this,"_onAddRoomsClick",()=>{Object(er.a)(this.props.groupId)})}componentDidMount(){this._unmounted=!1,this._matrixClient=L.a.get(),this._matrixClient.on("Group.myMembership",this._onGroupMyMembership),this._initGroupStore(this.props.groupId,!0),this._dispatcherRef=u.a.register(this._onAction),this._rightPanelStoreToken=tr.a.getSharedInstance().addListener(this._onRightPanelStoreUpdate)}componentWillUnmount(){this._unmounted=!0,this._matrixClient.removeListener("Group.myMembership",this._onGroupMyMembership),u.a.unregister(this._dispatcherRef),this._rightPanelStoreToken&&this._rightPanelStoreToken.remove()}UNSAFE_componentWillReceiveProps(e){this.props.groupId!==e.groupId&&this.setState({summary:null,error:null},()=>{this._initGroupStore(e.groupId)})}_initGroupStore(e,t){const s=this._matrixClient.getGroup(e);s&&s.inviter&&s.inviter.userId&&this._fetchInviterProfile(s.inviter.userId),Zo.a.registerListener(e,this.onGroupStoreUpdated.bind(this,t));let n=!1;Zo.a.on("error",(t,s,i)=>{this._unmounted||e!==s||("M_GUEST_ACCESS_FORBIDDEN"!==t.errcode||n||(u.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_group",group_id:e}}),u.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+e}}),n=!0),i===Zo.a.STATE_KEY.Summary&&this.setState({summary:null,error:t,editing:!1}))})}_fetchInviterProfile(e){this.setState({inviterProfileBusy:!0}),this._matrixClient.getProfileInfo(e).then(e=>{this._unmounted||this.setState({inviterProfile:{avatarUrl:e.avatar_url,displayName:e.displayname}})}).catch(e=>{console.error("Error getting group inviter profile",e)}).finally(()=>{this._unmounted||this.setState({inviterProfileBusy:!1})})}async _saveGroup(){await this._matrixClient.setGroupProfile(this.props.groupId,this.state.profileForm),await this._matrixClient.setGroupJoinPolicy(this.props.groupId,{type:this.state.joinableForm.policyType})}_leaveGroupWarnings(){const e=[];return this.state.isUserPrivileged&&e.push(o.a.createElement("span",{className:"warning"}," ",Object(c.a)("You are an administrator of this community. You will not be able to rejoin without an invite from another administrator."))),e}_getGroupSection(){const e=E()({mx_GroupView_group:this.state.editing,mx_GroupView_group_disabled:this.state.editing&&!this.state.isUserPrivileged}),t=this.state.editing?o.a.createElement("h2",null," ",Object(c.a)("Community Settings")," "):o.a.createElement("div",null),n=ge("community-settings");let i=null;n&&this.state.isUserPrivileged&&(i=o.a.createElement("div",{className:"mx_GroupView_hostingSignup"},Object(c.a)("Want more than a community? <a>Get your own server</a>",{},{a:e=>o.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},e)}),o.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},o.a.createElement("img",{src:s(472),width:"11",height:"10",alt:""}))));const r=this.state.editing&&this.state.isUserPrivileged?o.a.createElement("div",{className:"mx_GroupView_changeDelayWarning"},Object(c.a)("Changes made to your community <bold1>name</bold1> and <bold2>avatar</bold2> might not be seen by other users for up to 30 minutes.",{},{bold1:e=>o.a.createElement("b",null," ",e," "),bold2:e=>o.a.createElement("b",null," ",e," ")})):o.a.createElement("div",null);return o.a.createElement("div",{className:e},t,i,r,this._getJoinableNode(),this._getLongDescriptionNode(),this._getRoomsNode())}_getRoomsNode(){const e=d.getComponent("rooms.RoomDetailList"),t=d.getComponent("elements.AccessibleButton"),n=d.getComponent("elements.TintableSvg"),i=d.getComponent("elements.Spinner"),r=d.getComponent("elements.TooltipButton"),a=this.state.editing?o.a.createElement(r,{helpText:Object(c.a)("These rooms are displayed to community members on the community page. Community members can join the rooms by clicking on them.")}):o.a.createElement("div",null),l=this.state.editing?o.a.createElement(t,{className:"mx_GroupView_rooms_header_addRow",onClick:this._onAddRoomsClick},o.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_button"},o.a.createElement(n,{src:s(908),width:"24",height:"24"})),o.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_label"},Object(c.a)("Add rooms to this community"))):o.a.createElement("div",null),u=E()({mx_fadable:!0,mx_fadable_faded:this.state.editing});return o.a.createElement("div",{className:"mx_GroupView_rooms"},o.a.createElement("div",{className:"mx_GroupView_rooms_header"},o.a.createElement("h3",null,Object(c.a)("Rooms"),a),l),this.state.groupRoomsLoading?o.a.createElement(i,null):o.a.createElement(e,{rooms:this.state.groupRooms,className:u}))}_getFeaturedRoomsNode(){const e=this.state.summary,t=[],s={};e.rooms_section.rooms.forEach(e=>{if(null===e.category_id)t.push(e);else{let t=s[e.category_id];void 0===t&&(t=[],s[e.category_id]=t),t.push(e)}});const n=o.a.createElement(or,{rooms:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.rooms_section.categories[t];return o.a.createElement(or,{key:t,rooms:s[t],category:n,groupId:this.props.groupId,editing:this.state.editing})});return o.a.createElement("div",{className:"mx_GroupView_featuredThings"},o.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(c.a)("Featured Rooms:")),n,i)}_getFeaturedUsersNode(){const e=this.state.summary,t=[],s={};e.users_section.users.forEach(e=>{if(null===e.role_id)t.push(e);else{let t=s[e.role_id];void 0===t&&(t=[],s[e.role_id]=t),t.push(e)}});const n=o.a.createElement(ar,{users:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.users_section.roles[t];return o.a.createElement(ar,{key:t,users:s[t],role:n,groupId:this.props.groupId,editing:this.state.editing})});return o.a.createElement("div",{className:"mx_GroupView_featuredThings"},o.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(c.a)("Featured Users:")),n,i)}_getMembershipSection(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("avatars.BaseAvatar"),s=this._matrixClient.getGroup(this.props.groupId);if(s&&"invite"===s.myMembership){if(this.state.membershipBusy||this.state.inviterProfileBusy)return o.a.createElement("div",{className:"mx_GroupView_membershipSection"},o.a.createElement(e,null));const n=this.state.inviterProfile?this._matrixClient.mxcUrlToHttp(this.state.inviterProfile.avatarUrl,36,36):null,i=s.inviter||{};let r=i.userId;return this.state.inviterProfile&&(r=this.state.inviterProfile.displayName||i.userId),o.a.createElement("div",{className:"mx_GroupView_membershipSection mx_GroupView_membershipSection_invited"},o.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},o.a.createElement("div",{className:"mx_GroupView_membershipSection_description"},o.a.createElement(t,{url:n,name:r,width:36,height:36}),Object(c.a)("%(inviter)s has invited you to join this community",{inviter:r||Object(c.a)("Someone")})),o.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},o.a.createElement(Z.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onAcceptInviteClick},Object(c.a)("Accept")),o.a.createElement(Z.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onRejectInviteClick},Object(c.a)("Decline")))))}let n,i,r,a,l;if((!s||"leave"===s.myMembership)&&this.state.summary&&this.state.summary.profile&&Boolean(this.state.summary.profile.is_openly_joinable))a=Object(c.a)("Join this community"),l=this._onJoinClick,i="mx_GroupView_joinButton",n="mx_GroupView_membershipSection_leave";else{if(!s||"join"!==s.myMembership||!this.state.editing)return null;a=Object(c.a)("Leave this community"),l=this._onLeaveClick,r=this.state.isUserPrivileged?Object(c.a)("You are an administrator of this community"):Object(c.a)("You are a member of this community"),i={mx_GroupView_leaveButton:!0,mx_RoomHeader_textButton_danger:this.state.isUserPrivileged},n="mx_GroupView_membershipSection_joined"}const u=E()(["mx_RoomHeader_textButton","mx_GroupView_textButton"],i),h=E()("mx_GroupView_membershipSection",n);return o.a.createElement("div",{className:h},o.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},this.state.membershipBusy?o.a.createElement(e,null):o.a.createElement("div",null),o.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},o.a.createElement(Z.a,{className:u,onClick:l,title:r},a))))}_getJoinableNode(){const e=d.getComponent("elements.InlineSpinner");return this.state.editing?o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Who can join this community?"),this.state.groupJoinableLoading?o.a.createElement(e,null):o.a.createElement("div",null)),o.a.createElement("div",null,o.a.createElement("label",null,o.a.createElement("input",{type:"radio",value:"invite",checked:"invite"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),o.a.createElement("div",{className:"mx_GroupView_label_text"},Object(c.a)("Only people who have been invited")))),o.a.createElement("div",null,o.a.createElement("label",null,o.a.createElement("input",{type:"radio",value:"open",checked:"open"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),o.a.createElement("div",{className:"mx_GroupView_label_text"},Object(c.a)("Everyone"))))):null}_getLongDescriptionNode(){const e=this.state.summary;let t=null;e.profile&&e.profile.long_description?t=Object(qn.f)(e.profile.long_description):this.state.isUserPrivileged&&(t=o.a.createElement("div",{className:"mx_GroupView_groupDesc_placeholder",onClick:this._onEditClick},Object(c.a)("Your community hasn't got a Long Description, a HTML page to show to community members.<br />Click here to open settings and give it one!",{},{br:o.a.createElement("br",null)})));const s=E()({mx_GroupView_groupDesc:!0,mx_GroupView_groupDesc_disabled:!this.state.isUserPrivileged});return this.state.editing?o.a.createElement("div",{className:s},o.a.createElement("h3",null," ",Object(c.a)("Long Description (HTML)")," "),o.a.createElement("textarea",{value:this.state.profileForm.long_description,placeholder:Object(c.a)(sr),onChange:this._onLongDescChange,tabIndex:"4",key:"editLongDesc"})):o.a.createElement("div",{className:"mx_GroupView_groupDesc"},t)}render(){const e=d.getComponent("avatars.GroupAvatar"),t=d.getComponent("elements.Spinner");if(this.state.summaryLoading&&null===this.state.error||this.state.saving)return o.a.createElement(t,null);if(this.state.summary&&!this.state.error){const n=this.state.summary;let i,a,l;const u=[];if(this.state.editing&&this.state.isUserPrivileged){let e;if(this.state.uploadingAvatar)e=o.a.createElement(t,null);else{const t=d.getComponent("avatars.GroupAvatar");e=o.a.createElement(t,{groupId:this.props.groupId,groupName:this.state.profileForm.name,groupAvatarUrl:this.state.profileForm.avatar_url,width:28,height:28,resizeMethod:"crop"})}i=o.a.createElement("div",{className:"mx_GroupView_avatarPicker"},o.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},e),o.a.createElement("div",{className:"mx_GroupView_avatarPicker_edit"},o.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},o.a.createElement("img",{src:s(909),alt:Object(c.a)("Upload avatar"),title:Object(c.a)("Upload avatar"),width:"17",height:"15"})),o.a.createElement("input",{id:"avatarInput",className:"mx_GroupView_uploadInput",type:"file",onChange:this._onAvatarSelected})));const n=d.getComponent("elements.EditableText");a=o.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(c.a)("Community Name"),blurToCancel:!1,initialValue:this.state.profileForm.name,onValueChanged:this._onNameChange,tabIndex:"0",dir:"auto"}),l=o.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(c.a)("Description"),blurToCancel:!1,initialValue:this.state.profileForm.short_description,onValueChanged:this._onShortDescChange,tabIndex:"0",dir:"auto"})}else{const t=this.state.isUserMember?this._onEditClick:null,s=n.profile?n.profile.avatar_url:null,r=n.profile?n.profile.name:null;i=o.a.createElement(e,{groupId:this.props.groupId,groupAvatarUrl:s,groupName:r,onClick:t,width:28,height:28}),a=n.profile&&n.profile.name?o.a.createElement("div",{onClick:t},o.a.createElement("span",null,n.profile.name),o.a.createElement("span",{className:"mx_GroupView_header_groupid"},"(",this.props.groupId,")")):o.a.createElement("span",{onClick:t},this.props.groupId),n.profile&&n.profile.short_description&&(l=o.a.createElement("span",{onClick:t},n.profile.short_description))}this.state.editing?(u.push(o.a.createElement(Z.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",key:"_saveButton",onClick:this._onSaveClick},Object(c.a)("Save"))),u.push(o.a.createElement(Z.a,{className:"mx_RoomHeader_cancelButton",key:"_cancelButton",onClick:this._onCancelClick},o.a.createElement("img",{src:s(152),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(c.a)("Cancel")})))):(n.user&&"join"===n.user.membership&&u.push(o.a.createElement(Z.a,{className:"mx_GroupHeader_button mx_GroupHeader_editButton",key:"_editButton",onClick:this._onEditClick,title:Object(c.a)("Community Settings")})),u.push(o.a.createElement(Z.a,{className:"mx_GroupHeader_button mx_GroupHeader_shareButton",key:"_shareButton",onClick:this._onShareClick,title:Object(c.a)("Share Community")})));const h=this.state.showRightPanel?o.a.createElement(Xo.a,{groupId:this.props.groupId}):void 0,m={mx_GroupView_header:!0,"light-panel":!0,mx_GroupView_header_view:!this.state.editing,mx_GroupView_header_isUserMember:this.state.isUserMember};return o.a.createElement("main",{className:"mx_GroupView"},o.a.createElement("div",{className:E()(m)},o.a.createElement("div",{className:"mx_GroupView_header_leftCol"},o.a.createElement("div",{className:"mx_GroupView_header_avatar"},i),o.a.createElement("div",{className:"mx_GroupView_header_info"},o.a.createElement("div",{className:"mx_GroupView_header_name"},a),o.a.createElement("div",{className:"mx_GroupView_header_shortDesc"},l))),o.a.createElement("div",{className:"mx_GroupView_header_rightCol"},u),o.a.createElement(jn,null)),o.a.createElement(Qo.a,{panel:h,resizeNotifier:this.props.resizeNotifier},o.a.createElement(r.a,{className:"mx_GroupView_body"},this._getMembershipSection(),this._getGroupSection())))}if(this.state.error){if(404===this.state.error.httpStatus)return o.a.createElement("div",{className:"mx_GroupView_error"},Object(c.a)("Community %(groupId)s not found",{groupId:this.props.groupId}));{let e;return"M_UNRECOGNIZED"===this.state.error.errcode&&(e=o.a.createElement("div",null,Object(c.a)("This homeserver does not support communities"))),o.a.createElement("div",{className:"mx_GroupView_error"},Object(c.a)("Failed to load %(groupId)s",{groupId:this.props.groupId}),e)}}return console.error("Invalid state for GroupView"),o.a.createElement("div",null)}}g()(lr,"propTypes",{groupId:re.a.string.isRequired,groupIsNew:re.a.bool});var dr=s(79),ur=s.n(dr),hr=s(202),mr=s(75),pr=s(246);const gr=["m.sticker","m.room.message"];const fr=e=>"m.room.member"===e.getType()||"m.room.third_party_invite"===e.getType();class _r extends o.a.Component{constructor(e){super(e),g()(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:w.a.getValue("showTypingNotifications")})}),g()(this,"_isUnmounting",()=>!this._isMounted),g()(this,"_collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),g()(this,"_onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),g()(this,"_collectEventNode",(e,t)=>{this.eventNodes[e]=t}),g()(this,"_onHeightChanged",()=>{const e=this._scrollPanel.current;e&&e.checkScroll()}),g()(this,"_onTypingShown",()=>{const e=this._scrollPanel.current;e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),g()(this,"_onTypingHidden",()=>{const e=this._scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:w.a.getValue("showTypingNotifications")},this._readReceiptMap={},this._readReceiptsByEvent={},this._readReceiptsByUserId={},this._showHiddenEventsInTimeline=w.a.getValue("showHiddenEventsInTimeline"),this._isMounted=!1,this._readMarkerNode=Object(i.createRef)(),this._whoIsTyping=Object(i.createRef)(),this._scrollPanel=Object(i.createRef)(),this._showTypingNotificationsWatcherRef=w.a.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){this._isMounted=!0}componentWillUnmount(){this._isMounted=!1,w.a.unwatchSetting(this._showTypingNotificationsWatcherRef)}componentDidUpdate(e,t){if(e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}}getNodeForEventId(e){if(this.eventNodes)return this.eventNodes[e]}isAtBottom(){return this._scrollPanel.current&&this._scrollPanel.current.isAtBottom()}getScrollState(){return this._scrollPanel.current?this._scrollPanel.current.getScrollState():null}getReadMarkerPosition(){const e=this._readMarkerNode.current,t=this._scrollPanel.current;if(!e||!t)return null;const s=ur.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<s.top?-1:n.top<s.bottom?0:1}scrollToTop(){this._scrollPanel.current&&this._scrollPanel.current.scrollToTop()}scrollToBottom(){this._scrollPanel.current&&this._scrollPanel.current.scrollToBottom()}scrollRelative(e){this._scrollPanel.current&&this._scrollPanel.current.scrollRelative(e)}handleScrollKey(e){this._scrollPanel.current&&this._scrollPanel.current.handleScrollKey(e)}scrollToEvent(e,t,s){this._scrollPanel.current&&this._scrollPanel.current.scrollToToken(e,t,s)}scrollToEventIfNeeded(e){const t=this.eventNodes[e];t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}checkFillState(){this._scrollPanel.current&&this._scrollPanel.current.checkFillState()}_shouldShowEvent(e){return(!e.sender||!L.a.get().isUserIgnored(e.sender.userId))&&(!!this._showHiddenEventsInTimeline||!!Object($e.b)(e)&&(this.props.highlightedEventId===e.getId()||!Object(hr.a)(e)))}_readMarkerForEvent(e,t){const s=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return s&&(t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),o.a.createElement("li",{key:"readMarker_"+e,ref:this._readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this._collectGhostReadMarker,onTransitionEnd:this._onGhostTransitionEnd,"data-eventid":e});return o.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}_getEventTiles(){let e,t;this.eventNodes={};let s=-1;for(e=this.props.events.length-1;e>=0;e--){const n=this.props.events[e];if(this._shouldShowEvent(n)&&(void 0===t&&(t=n),!n.status)){s=e;break}}const n=[];let i=null;this._readReceiptsByEvent={},this.props.showReadReceipts&&(this._readReceiptsByEvent=this._getReadReceiptsByShownEvent());let o=null;for(e=0;e<this.props.events.length;e++){const r=this.props.events[e],a=r.getId(),c=r===t;if(o){if(o.shouldGroup(r)){o.add(r);continue}n.push(...o.getTiles()),i=o.getNewPrevEvent(),o=null}for(const e of br)e.canStartGroup(this,r)&&(o=new e(this,r,i,t));if(!o){this._shouldShowEvent(r)&&(n.push(...this._getTilesForEvent(i,r,c)),i=r);const t=this._readMarkerForEvent(a,e>=s);t&&n.push(t)}}return o&&n.push(...o.getTiles()),n}_getTilesForEvent(e,t,s){const n=d.getComponent("messages.TileErrorBoundary"),i=d.getComponent("rooms.EventTile"),r=d.getComponent("messages.DateSeparator"),a=[],c=this.props.editState&&this.props.editState.getEvent().getId()===t.getId();let l=t.getTs(),u=t.getDate();t.status&&(u=new Date,l=u.getTime());const h=this._wantsDateSeparator(e,u);if(h){const e=o.a.createElement("li",{key:l},o.a.createElement(r,{key:l,ts:l}));a.push(e)}const m=!h&&function(e,t){return!!(e&&e.sender&&t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(!!(t.getType()===e.getType()||gr.includes(t.getType())&&gr.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&!!Object($e.b)(e))))}(e,t),p=t.getId(),g=p===this.props.highlightedEventId,f=t.status?void 0:p,_=this._readReceiptsByEvent[p];return a.push(o.a.createElement("li",{key:t.getTxnId()||p,ref:this._collectEventNode.bind(this,p),"data-scroll-tokens":f},o.a.createElement(n,{mxEvent:t},o.a.createElement(i,{mxEvent:t,continuation:m,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:c&&this.props.editState,onHeightChanged:this._onHeightChanged,readReceipts:_,readReceiptMap:this._readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this._isUnmounting,eventSendStatus:t.getAssociatedStatus(),tileShape:this.props.tileShape,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:s,isSelectedEvent:g,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,useIRCLayout:this.props.useIRCLayout})))),a}_wantsDateSeparator(e,t){return null==e?!this.props.suppressFirstDateSeparator:Object(mr.e)(e.getDate(),t)}_getReadReceiptsForEvent(e){const t=L.a.get().credentials.userId,{room:s}=this.props;if(!s)return null;const n=[];return s.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||"m.read"!==e.type||e.userId===t)return;if(L.a.get().isUserIgnored(e.userId))return;const i=s.getMember(e.userId);n.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})}),n}_getReadReceiptsByShownEvent(){const e={},t={};let s;for(const n of this.props.events){if(this._shouldShowEvent(n)&&(s=n.getId()),!s)continue;const i=e[s]||[],o=this._getReadReceiptsForEvent(n);e[s]=i.concat(o);for(const e of o)t[e.userId]={lastShownEventId:s,receipt:e}}for(const s in this._readReceiptsByUserId){if(t[s])continue;const{lastShownEventId:n,receipt:i}=this._readReceiptsByUserId[s],o=e[n]||[];e[n]=o.concat(i),t[s]={lastShownEventId:n,receipt:i}}this._readReceiptsByUserId=t;for(const t in e)e[t].sort((e,t)=>t.ts-e.ts);return e}updateTimelineMinHeight(){const e=this._scrollPanel.current;if(e){const t=e.isAtBottom(),s=this._whoIsTyping.current,n=s&&s.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this._scrollPanel.current;e&&e.clearPreventShrinking()}render(){const e=d.getComponent("elements.ErrorBoundary"),t=d.getComponent("structures.ScrollPanel"),s=d.getComponent("rooms.WhoIsTypingTile"),n=d.getComponent("elements.Spinner");let i,r;this.props.backPaginating&&(i=o.a.createElement("li",{key:"_topSpinner"},o.a.createElement(n,null))),this.props.forwardPaginating&&(r=o.a.createElement("li",{key:"_bottomSpinner"},o.a.createElement(n,null)));const a=this.props.hidden?{display:"none"}:{},c=E()(this.props.className,{mx_MessagePanel_alwaysShowTimestamps:this.props.alwaysShowTimestamps});let l;this.props.room&&!this.props.tileShape&&this.state.showTypingNotifications&&(l=o.a.createElement(s,{room:this.props.room,onShown:this._onTypingShown,onHidden:this._onTypingHidden,ref:this._whoIsTyping}));let u=null;return this.props.useIRCLayout&&(u=o.a.createElement(on,{minWidth:20,maxWidth:600,roomId:this.props.room?this.props.room.roomId:null})),o.a.createElement(e,null,o.a.createElement(t,{ref:this._scrollPanel,className:c,onScroll:this.props.onScroll,onResize:this.onResize,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:a,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:u},i,this._getEventTiles(),l,r))}}g()(_r,"propTypes",{hidden:re.a.bool,backPaginating:re.a.bool,forwardPaginating:re.a.bool,events:re.a.array.isRequired,highlightedEventId:re.a.string,room:re.a.object,showUrlPreview:re.a.bool,readMarkerEventId:re.a.string,readMarkerVisible:re.a.bool,ourUserId:re.a.string,suppressFirstDateSeparator:re.a.bool,showReadReceipts:re.a.bool,stickyBottom:re.a.bool,onScroll:re.a.func,onFillRequest:re.a.func,className:re.a.string.isRequired,tileShape:re.a.string,isTwelveHour:re.a.bool,alwaysShowTimestamps:re.a.bool,getRelationsForEvent:re.a.func,showReactions:re.a.bool,useIRCLayout:re.a.bool});class vr{constructor(e,t,s,n){this.panel=e,this.createEvent=t,this.prevEvent=s,this.lastShownEvent=n,this.events=[],this.ejectedEvents=[],this.readMarker=e._readMarkerForEvent(t.getId(),t===n)}shouldGroup(e){const t=this.panel,s=this.createEvent;return!t._shouldShowEvent(e)||!t._wantsDateSeparator(this.createEvent,e.getDate())&&(("m.room.member"!==e.getType()||e.getStateKey()===s.getSender()&&"join"===e.getContent().membership)&&!(!e.isState()||e.getSender()!==s.getSender()))}add(e){const t=this.panel;this.readMarker=this.readMarker||t._readMarkerForEvent(e.getId(),e===this.lastShownEvent),t._shouldShowEvent(e)&&("m.room.encryption"===e.getType()?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.EventListSummary"),s=this.panel,n=[],i=this.createEvent,r=this.lastShownEvent;if(s._wantsDateSeparator(this.prevEvent,i.getDate())){const t=i.getTs();n.push(o.a.createElement("li",{key:t+"~"},o.a.createElement(e,{key:t+"~",ts:t})))}s._shouldShowEvent(i)&&n.push(...s._getTilesForEvent(i,i,!1));for(const e of this.ejectedEvents)n.push(...s._getTilesForEvent(i,e,i===r));const a=this.events.map(e=>s._getTilesForEvent(e,e,e===r)).reduce((e,t)=>e.concat(t),[]),l=this.events[this.events.length-1];return n.push(o.a.createElement(t,{key:"roomcreationsummary",events:this.events,onToggle:s._onHeightChanged,summaryMembers:[l.sender],summaryText:Object(c.a)("%(creator)s created and configured the room.",{creator:l.sender?l.sender.name:l.getSender()})},a)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.createEvent}}g()(vr,"canStartGroup",(function(e,t){return"m.room.create"===t.getType()}));class yr{constructor(e,t,s,n){this.panel=e,this.readMarker=e._readMarkerForEvent(t.getId(),t===n),this.events=[t],this.prevEvent=s,this.lastShownEvent=n}shouldGroup(e){return!this.panel._wantsDateSeparator(this.events[0],e.getDate())&&fr(e)}add(e){if("m.room.member"===e.getType()){const t=Object(pr.a)(e);if(!t||0===t.trim().length)return}this.readMarker=this.readMarker||this.panel._readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.events.push(e)}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.MemberEventListSummary"),s=this.panel,n=this.lastShownEvent,i=[];if(s._wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const t=this.events[0].getTs();i.push(o.a.createElement("li",{key:t+"~"},o.a.createElement(e,{key:t+"~",ts:t})))}const r="membereventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial");let a,c=this.events.map(e=>(e.getId()===s.props.highlightedEventId&&(a=!0),s._getTilesForEvent(e,e,e===n))).reduce((e,t)=>e.concat(t),[]);return 0===c.length&&(c=null),i.push(o.a.createElement(t,{key:r,events:this.events,onToggle:s._onHeightChanged,startExpanded:a},c)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.events[0]}}g()(yr,"canStartGroup",(function(e,t){return e._shouldShowEvent(t)&&fr(t)}));const br=[vr,yr];class Er extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{groups:null,error:null}),g()(this,"_onCreateGroupClick",()=>{u.a.dispatch({action:"view_create_group"})})}componentDidMount(){this._fetch()}_fetch(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups,error:null})},e=>{"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode?this.setState({groups:null,error:e}):this.setState({groups:[],error:null})})}render(){const e=l.a.get().brand,t=d.getComponent("elements.Spinner"),n=d.getComponent("rooms.SimpleRoomHeader"),i=d.getComponent("groups.GroupTile");let a,u;if(this.state.groups){const t=[];this.state.groups.forEach(e=>{t.push(o.a.createElement(i,{key:e,groupId:e}))}),u=t.length>0?o.a.createElement("h3",null,Object(c.a)("Your Communities")):o.a.createElement("div",null),a=t.length>0?o.a.createElement(r.a,{className:"mx_MyGroups_scrollable"},o.a.createElement("div",{className:"mx_MyGroups_microcopy"},o.a.createElement("p",null,Object(c.a)("Did you know: you can use communities to filter your %(brand)s experience!",{brand:e})),o.a.createElement("p",null,Object(c.a)("To set up a filter, drag a community avatar over to the filter panel on the far left hand side of the screen. You can click on an avatar in the filter panel at any time to see only the rooms and people associated with that community."))),o.a.createElement("div",{className:"mx_MyGroups_joinedGroups"},t)):o.a.createElement("div",{className:"mx_MyGroups_placeholder"},Object(c.a)("You're not currently a member of any communities."))}else a=this.state.error?o.a.createElement("div",{className:"mx_MyGroups_error"},Object(c.a)("Error whilst fetching joined communities")):o.a.createElement(t,null);return o.a.createElement("div",{className:"mx_MyGroups"},o.a.createElement(n,{title:Object(c.a)("Communities"),icon:s(910)}),o.a.createElement("div",{className:"mx_MyGroups_header"},o.a.createElement("div",{className:"mx_MyGroups_headerCard"},o.a.createElement(Z.a,{className:"mx_MyGroups_headerCard_button",onClick:this._onCreateGroupClick}),o.a.createElement("div",{className:"mx_MyGroups_headerCard_content"},o.a.createElement("div",{className:"mx_MyGroups_headerCard_header"},Object(c.a)("Create a new community")),Object(c.a)("Create a community to group together users and rooms! Build a custom homepage to mark out your space in the Matrix universe.")))),o.a.createElement("div",{className:"mx_MyGroups_content"},u,a))}}g()(Er,"contextType",S.a);class Sr extends o.a.Component{render(){const e=d.getComponent("structures.TimelinePanel"),t=d.getComponent("elements.Spinner"),s=o.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},o.a.createElement("h2",null,Object(c.a)("You’re all caught up")),o.a.createElement("p",null,Object(c.a)("You have no visible notifications in this room.")));let n;const i=L.a.get().getNotifTimelineSet();return i?n=o.a.createElement(e,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:i,showUrlPreview:!1,tileShape:"notif",empty:s}):(console.error("No notifTimelineSet available!"),n=o.a.createElement(t,null)),o.a.createElement(hn.b,{className:"mx_NotificationPanel",onClose:this.props.onClose,withoutScrollContainer:!0},n)}}g()(Sr,"propTypes",{onClose:re.a.func.isRequired});var wr=Sr;function Cr(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return n}function Rr(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return s}const kr=Symbol("ALL_ROOMS"),Ir=Object(dn.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(c.a)("Enter a server name")},{key:"available",final:!0,test:async({value:e})=>{try{const t={limit:1,server:e};return await L.a.get().publicRooms(t),!0}catch(e){return!1}},valid:()=>Object(c.a)("Looks good"),invalid:()=>Object(c.a)("Can't find this server or its room list")}]}),Or=({onOptionChange:e,protocols:t={},selectedServerName:s,selectedInstanceId:r})=>{const[a,u,h,m]=Object(n.o)(),p=((e,t=null,s=!1)=>{const[n,o]=Object(i.useState)(w.a.getValue(e,t,s));return Object(i.useEffect)(()=>{const n=w.a.watchSetting(e,t,()=>{o(w.a.getValue(e,t,s))});return()=>{w.a.unwatchSetting(n)}},[e,t,s]),n})("room_directory_servers"),[g,f]=Object(i.useState)(p),_=(t,s)=>()=>{e(t,s),m()},v=e=>{f(e),w.a.setValue("room_directory_servers",null,"account",e)};let y;if(Object(i.useEffect)(()=>{f(p)},[p]),a){const i=l.a.get().roomDirectory||{},a=L.a.getHomeserverName(),h=new Set(i.servers),p=new Set(g.filter(e=>!h.has(e)&&e!==a)),f=[a,...Array.from(h).filter(e=>e!==a).sort(),...Array.from(p).sort()],E=f.map(i=>{const l=i===s,u=[],h=i===a?Object.values(t):[];let g,y;if(h.length>0&&h.push({instances:[{instance_id:kr,desc:Object(c.a)("All rooms")}]}),h.forEach(({instances:e=[]})=>{[...e].sort((e,t)=>t.desc.localeCompare(e.desc)).forEach(({desc:e,instance_id:t})=>{u.push(o.a.createElement(n.h,{key:String(t),active:l&&t===r,onClick:_(i,t),label:e,className:"mx_NetworkDropdown_server_network"},e))})}),i===a&&(g=o.a.createElement("div",{className:"mx_NetworkDropdown_server_subtitle"},Object(c.a)("Your server"))),p.has(i)){const t=async()=>{m();const t=d.getComponent("dialogs.QuestionDialog"),{finished:s}=ke.a.createTrackedDialog("Network Dropdown","Remove server",t,{title:Object(c.a)("Are you sure?"),description:Object(c.a)("Are you sure you want to remove <b>%(serverName)s</b>",{serverName:i},{b:e=>o.a.createElement("b",null,e)}),button:Object(c.a)("Remove"),fixedWidth:!1},"mx_NetworkDropdown_dialog"),[n]=await s;n&&(v(f.filter(e=>e!==i)),l===i&&e(a,void 0))};y=o.a.createElement(n.f,{onClick:t,label:Object(c.a)("Remove server")})}return o.a.createElement(n.e,{label:i,className:"mx_NetworkDropdown_server",key:i},o.a.createElement("div",{className:"mx_NetworkDropdown_server_title"},i,y),g,o.a.createElement(n.h,{active:l&&!r,onClick:_(i,void 0),label:Object(c.a)("Matrix"),className:"mx_NetworkDropdown_server_network"},Object(c.a)("Matrix")),u)}),S=async()=>{m();const t=d.getComponent("dialogs.TextInputDialog"),{finished:s}=ke.a.createTrackedDialog("Network Dropdown","Add a new server",t,{title:Object(c.a)("Add a new server"),description:Object(c.a)("Enter the name of a new server you want to explore."),button:Object(c.a)("Add"),hasCancel:!1,placeholder:Object(c.a)("Server name"),validator:Ir,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[n,i]=await s;n&&(g.includes(i)||v([...g,i]),e(i))},w=u.current.getBoundingClientRect();y=o.a.createElement(n.b,B()({},(b=w,{right:window.innerWidth-b.right,top:b.top,chevronOffset:0,chevronFace:"none"}),{onFinished:m}),o.a.createElement("div",{className:"mx_NetworkDropdown_menu"},E,o.a.createElement(n.f,{className:"mx_NetworkDropdown_server_add",label:void 0,onClick:S},Object(c.a)("Add a new server..."))))}else{let e;if(r===kr)e=Object(c.a)("All rooms");else if(r){const s=Cr(t,r);e=Object(c.a)("%(networkName)s rooms",{networkName:s.desc})}else e=Object(c.a)("Matrix rooms");y=o.a.createElement(n.c,{className:"mx_NetworkDropdown_handle",onClick:h,isExpanded:a},o.a.createElement("span",null,e)," ",o.a.createElement("span",{className:"mx_NetworkDropdown_handle_server"},"(",s,")"))}var b;return o.a.createElement("div",{className:"mx_NetworkDropdown",ref:u},y)};Or.propTypes={onOptionChange:re.a.func.isRequired,protocols:re.a.object};var Tr=Or;function xr(e){ve.a.trackEvent("RoomDirectory",e)}class Nr extends o.a.Component{constructor(e){super(e),g()(this,"refreshRoomList",()=>{this.state.selectedCommunityId?this.setState({publicRooms:Zo.a.getGroupRooms(this.state.selectedCommunityId).map(e=>({room_id:e.roomId,name:e.name,topic:e.topic,canonical_alias:e.canonicalAlias,num_joined_members:e.numJoinedMembers,avatarUrl:e.avatarUrl,world_readable:e.worldReadable,guest_can_join:e.guestsCanJoin})).filter(e=>{const t=this.state.filterString;if(t){const s=e=>(e||"").toLowerCase().includes(t.toLowerCase());return s(e.name)||s(e.topic)||s(e.canonical_alias)}return!0}),loading:!1}):(this.nextBatch=null,this.setState({publicRooms:[],loading:!0}),this.getMoreRooms())}),g()(this,"onRoomClicked",(e,t)=>{t.shiftKey&&!this.state.selectedCommunityId?(t.preventDefault(),this.removeFromDirectory(e)):this.showRoom(e)}),g()(this,"onOptionChange",(e,t)=>{this.nextBatch=null,this.setState({publicRooms:[],roomServer:e,instanceId:t,error:null},this.refreshRoomList)}),g()(this,"onFillRequest",e=>e||!this.nextBatch?Promise.resolve(!1):this.getMoreRooms()),g()(this,"onFilterChange",e=>{this.setState({filterString:e||null}),this.filterTimeout&&clearTimeout(this.filterTimeout),this.filterTimeout=setTimeout(()=>{this.filterTimeout=null,this.refreshRoomList()},700)}),g()(this,"onFilterClear",()=>{this.setState({filterString:null},this.refreshRoomList),this.filterTimeout&&clearTimeout(this.filterTimeout)}),g()(this,"onJoinFromSearchClick",e=>{if(this.state.instanceId&&this.state.instanceId!==kr){const t=Rr(this.protocols,this.state.instanceId),s=Cr(this.protocols,this.state.instanceId),n=t?this._getFieldsForThirdPartyLocation(e,this.protocols[t],s):null;if(!n){const e=d.getComponent("dialogs.ErrorDialog"),t=l.a.get().brand;return void ke.a.createTrackedDialog("Unable to join network","",e,{title:Object(c.a)("Unable to join network"),description:Object(c.a)("%(brand)s does not know how to join a room on this network",{brand:t})})}L.a.get().getThirdpartyLocation(t,n).then(e=>{if(e.length>0&&e[0].alias)this.showRoomAlias(e[0].alias,!0);else{const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Room not found","",e,{title:Object(c.a)("Room not found"),description:Object(c.a)("Couldn't find a matching Matrix room")})}},e=>{const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Fetching third party location failed","",t,{title:Object(c.a)("Fetching third party location failed"),description:Object(c.a)("Unable to look up room ID from server")})})}else-1==e.indexOf(":")&&(e=e+":"+this.state.roomServer),this.showRoomAlias(e,!0)}),g()(this,"onPreviewClick",(e,t)=>{this.props.onFinished(),u.a.dispatch({action:"view_room",room_id:t.room_id,should_peek:!0}),e.stopPropagation()}),g()(this,"onViewClick",(e,t)=>{this.props.onFinished(),u.a.dispatch({action:"view_room",room_id:t.room_id,should_peek:!1}),e.stopPropagation()}),g()(this,"onJoinClick",(e,t)=>{this.showRoom(t,null,!0),e.stopPropagation()}),g()(this,"onCreateRoomClick",e=>{this.props.onFinished(),u.a.dispatch({action:"view_create_room",public:!0})}),g()(this,"collectScrollPanel",e=>{this.scrollPanel=e}),g()(this,"handleScrollKey",e=>{this.scrollPanel&&this.scrollPanel.handleScrollKey(e)});const t=f.a.getSelectedTags()[0];this.state={publicRooms:[],loading:!0,protocolsLoading:!0,error:null,instanceId:void 0,roomServer:L.a.getHomeserverName(),filterString:null,selectedCommunityId:w.a.getValue("feature_communities_v2_prototypes")?t:null,communityName:null},this._unmounted=!1,this.nextBatch=null,this.filterTimeout=null,this.scrollPanel=null,this.protocols=null,this.setState({protocolsLoading:!0}),L.a.get()?(this.state.selectedCommunityId?(this.setState({protocolsLoading:!1}),Vt.a.getGroupProfileCached(L.a.get(),this.state.selectedCommunityId).then(e=>{this.setState({communityName:e.name})})):L.a.get().getThirdpartyProtocols().then(e=>{this.protocols=e,this.setState({protocolsLoading:!1})},e=>{if(console.warn("error loading third party protocols: "+e),this.setState({protocolsLoading:!1}),L.a.get().isGuest())return;xr("Failed to get protocol list from homeserver");const t=l.a.get().brand;this.setState({error:Object(c.a)("%(brand)s failed to get the protocol list from the homeserver. The homeserver may be too old to support third party networks.",{brand:t})})}),this.refreshRoomList()):this.setState({protocolsLoading:!1})}componentWillUnmount(){this.filterTimeout&&clearTimeout(this.filterTimeout),this._unmounted=!0}getMoreRooms(){if(this.state.selectedCommunityId)return Promise.resolve();if(!L.a.get())return Promise.resolve();this.setState({loading:!0});const e=this.state.filterString,t=this.state.roomServer,s=this.nextBatch,n={limit:20};return t!=L.a.getHomeserverName()&&(n.server=t),this.state.instanceId===kr?n.include_all_networks=!0:this.state.instanceId&&(n.third_party_instance_id=this.state.instanceId),this.nextBatch&&(n.since=this.nextBatch),e&&(n.filter={generic_search_term:e}),L.a.get().publicRooms(n).then(n=>{if(e==this.state.filterString&&t==this.state.roomServer&&s==this.nextBatch&&!this._unmounted)return this.nextBatch=n.next_batch,this.setState(e=>(e.publicRooms.push(...n.chunk||[]),e.loading=!1,e)),Boolean(n.next_batch)},n=>{if(e!=this.state.filterString||t!=this.state.roomServer||s!=this.nextBatch)return;if(this._unmounted)return;console.error("Failed to get publicRooms: %s",JSON.stringify(n)),xr("Failed to get public room list");const i=l.a.get().brand;this.setState({loading:!1,error:Object(c.a)("%(brand)s failed to get the public room list.",{brand:i})+(n&&n.message)?n.message:Object(c.a)("The homeserver may be unavailable or overloaded.")})})}removeFromDirectory(e){const t=jr(e),s=e.name||t||Object(c.a)("Unnamed room"),n=d.getComponent("dialogs.QuestionDialog"),i=d.getComponent("dialogs.ErrorDialog");let o;o=t?Object(c.a)("Delete the room address %(alias)s and remove %(name)s from the directory?",{alias:t,name:s}):Object(c.a)("Remove %(name)s from the directory?",{name:s}),ke.a.createTrackedDialog("Remove from Directory","",n,{title:Object(c.a)("Remove from Directory"),description:o,onFinished:n=>{if(!n)return;const o=d.getComponent("elements.Spinner"),r=ke.a.createDialog(o);let a=Object(c.a)("remove %(name)s from the directory.",{name:s});L.a.get().setRoomDirectoryVisibility(e.room_id,"private").then(()=>{if(t)return a=Object(c.a)("delete the address."),L.a.get().deleteAlias(t)}).then(()=>{r.close(),this.refreshRoomList()},e=>{r.close(),this.refreshRoomList(),console.error("Failed to "+a+": "+e),ke.a.createTrackedDialog("Remove from Directory Error","",i,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("The server may be unavailable or overloaded")})})}})}showRoomAlias(e,t=!1){this.showRoom(null,e,t)}showRoom(e,t,s=!1){this.props.onFinished();const n={action:"view_room",auto_join:s};if(e){if(L.a.get().isGuest()&&!e.world_readable&&!e.guest_can_join)return void u.a.dispatch({action:"require_registration"});t||(t=jr(e)),n.oob_data={avatarUrl:e.avatar_url,name:e.name||t||Object(c.a)("Unnamed room")},this.state.roomServer&&(n.opts={viaServers:[this.state.roomServer]})}t?n.room_alias=t:n.room_id=e.room_id,u.a.dispatch(n)}getRow(e){const t=L.a.get(),s=t.getRoom(e.room_id),n=s&&"join"===s.getMyMembership(),i=t.isGuest(),r=d.getComponent("avatars.BaseAvatar"),a=d.getComponent("elements.AccessibleButton");let l,u;e.world_readable&&!n&&(l=o.a.createElement(a,{kind:"secondary",onClick:t=>this.onPreviewClick(t,e)},Object(c.a)("Preview"))),n?u=o.a.createElement(a,{kind:"secondary",onClick:t=>this.onViewClick(t,e)},Object(c.a)("View")):i&&!e.guest_can_join||(u=o.a.createElement(a,{kind:"primary",onClick:t=>this.onJoinClick(t,e)},Object(c.a)("Join")));let h=e.name||jr(e)||Object(c.a)("Unnamed room");h.length>80&&(h=h.substring(0,80)+"...");let m=e.topic||"";m.length>160&&(m=m.substring(0,160)+"..."),m=Object(qn.d)(m);const p=Object(No.a)(L.a.get().getHomeserverUrl(),e.avatar_url,32,32,"crop");return o.a.createElement("tr",{key:e.room_id,onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()}},o.a.createElement("td",{className:"mx_RoomDirectory_roomAvatar"},o.a.createElement(r,{width:32,height:32,resizeMethod:"crop",name:h,idName:h,url:p})),o.a.createElement("td",{className:"mx_RoomDirectory_roomDescription"},o.a.createElement("div",{className:"mx_RoomDirectory_name"},h)," ",o.a.createElement("div",{className:"mx_RoomDirectory_topic",onClick:e=>{e.stopPropagation()},dangerouslySetInnerHTML:{__html:m}}),o.a.createElement("div",{className:"mx_RoomDirectory_alias"},jr(e))),o.a.createElement("td",{className:"mx_RoomDirectory_roomMemberCount"},e.num_joined_members),o.a.createElement("td",{className:"mx_RoomDirectory_preview"},l),o.a.createElement("td",{className:"mx_RoomDirectory_join"},u))}_stringLooksLikeId(e,t){let s=/^#[^\s]+:[^\s]/;return t&&t.regexp&&(s=new RegExp(t.regexp)),s.test(e)}_getFieldsForThirdPartyLocation(e,t,s){const n=t.location_fields;if(!n)return null;const i={};for(let e=0;e<n.length-1;++e){const t=n[e];if(void 0===s.fields[t])return null;i[t]=s.fields[t]}return i[n[n.length-1]]=e,i}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("elements.AccessibleButton");let n,i;if(this.state.error)n=this.state.error;else if(this.state.protocolsLoading)n=o.a.createElement(e,null);else{const t=(this.state.publicRooms||[]).map(e=>this.getRow(e));let s,i;this.state.loading&&(s=o.a.createElement(e,null)),i=0!==t.length||this.state.loading?o.a.createElement("table",{className:"mx_RoomDirectory_table"},o.a.createElement("tbody",null,t)):o.a.createElement("i",null,Object(c.a)("No rooms to show"));const r=d.getComponent("structures.ScrollPanel");n=o.a.createElement(r,{ref:this.collectScrollPanel,className:"mx_RoomDirectory_tableWrapper",onFillRequest:this.onFillRequest,stickyBottom:!1,startAtBottom:!1},i,s)}if(!this.state.protocolsLoading){const e=d.getComponent("directory.NetworkDropdown"),t=d.getComponent("elements.DirectorySearchBox"),s=Rr(this.protocols,this.state.instanceId);let n;if(s&&this.protocols&&this.protocols[s]&&this.protocols[s].location_fields.length>0&&this.protocols[s].field_types){const e=this.protocols[s].location_fields.slice(-1)[0];n=this.protocols[s].field_types[e]}let r=Object(c.a)("Find a room…");this.state.instanceId&&this.state.instanceId!==kr?n&&(r=n.placeholder):r=Object(c.a)("Find a room… (e.g. %(exampleRoom)s)",{exampleRoom:"#example:"+this.state.roomServer});let a=this._stringLooksLikeId(this.state.filterString,n);if(s){const e=Cr(this.protocols,this.state.instanceId);null===this._getFieldsForThirdPartyLocation(this.state.filterString,this.protocols[s],e)&&(a=!1)}let l=o.a.createElement(e,{protocols:this.protocols,onOptionChange:this.onOptionChange,selectedServerName:this.state.roomServer,selectedInstanceId:this.state.instanceId});this.state.selectedCommunityId&&(l=null),i=o.a.createElement("div",{className:"mx_RoomDirectory_listheader"},o.a.createElement(t,{className:"mx_RoomDirectory_searchbox",onChange:this.onFilterChange,onClear:this.onFilterClear,onJoinClick:this.onJoinFromSearchClick,placeholder:r,showJoinButton:a}),l)}const r=Object(c.a)("If you can't find the room you're looking for, ask for an invite or <a>Create a new room</a>.",null,{a:e=>o.a.createElement(s,{kind:"secondary",onClick:this.onCreateRoomClick},e)}),a=this.state.selectedCommunityId?Object(c.a)("Explore rooms in %(communityName)s",{communityName:this.state.communityName||this.state.selectedCommunityId}):Object(c.a)("Explore rooms");return o.a.createElement(t,{className:"mx_RoomDirectory_dialog",hasCancel:!0,onFinished:this.props.onFinished,title:a},o.a.createElement("div",{className:"mx_RoomDirectory"},r,o.a.createElement("div",{className:"mx_RoomDirectory_list"},i,n)))}}function jr(e){return e.canonical_alias||(e.aliases?e.aliases[0]:"")}g()(Nr,"propTypes",{onFinished:re.a.func.isRequired});class Pr{static resendUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===de.b.NOT_SENT})).forEach((function(e){Pr.resend(e)}))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===de.b.NOT_SENT})).forEach((function(e){Pr.removeFromQueue(e)}))}static resend(e){const t=L.a.get().getRoom(e.getRoomId());L.a.get().resendEvent(e,t).then((function(t){u.a.dispatch({action:"message_sent",event:e})}),(function(t){console.log("Resend got send failure: "+t.name+"("+t+")"),u.a.dispatch({action:"message_send_failed",event:e})}))}static removeFromQueue(e){L.a.get().cancelPendingEvent(e)}}function Dr(e){return e?e.getPendingEvents().filter((function(e){return e.status===de.r.EventStatus.NOT_SENT})):[]}class Ar extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{syncState:L.a.get().getSyncState(),syncStateData:L.a.get().getSyncStateData(),unsentMessages:Dr(this.props.room)}),g()(this,"onSyncStateChange",(e,t,s)=>{"SYNCING"===e&&"SYNCING"===t||this.setState({syncState:e,syncStateData:s})}),g()(this,"_onResendAllClick",()=>{Pr.resendUnsentEvents(this.props.room),u.a.fire(h.a.FocusComposer)}),g()(this,"_onCancelAllClick",()=>{Pr.cancelUnsentEvents(this.props.room),u.a.fire(h.a.FocusComposer)}),g()(this,"_onRoomLocalEchoUpdated",(e,t,s,n)=>{t.roomId===this.props.room.roomId&&this.setState({unsentMessages:Dr(this.props.room)})})}componentDidMount(){L.a.get().on("sync",this.onSyncStateChange),L.a.get().on("Room.localEchoUpdated",this._onRoomLocalEchoUpdated),this._checkSize()}componentDidUpdate(){this._checkSize()}componentWillUnmount(){const e=L.a.get();e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this._onRoomLocalEchoUpdated))}_checkSize(){this._getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}_getSize(){return this._shouldShowConnectionError()||this.props.hasActiveCall||this.props.sentMessageAndIsAlone?1:this.state.unsentMessages.length>0?2:0}_getIndicator(){if(this.props.hasActiveCall){const e=d.getComponent("elements.TintableSvg");return o.a.createElement(e,{src:s(911),width:"23",height:"20"})}return this._shouldShowConnectionError(),null}_shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.errcode);return"ERROR"===this.state.syncState&&!e}_getUnsentMessageContent(){const e=this.state.unsentMessages;if(!e.length)return null;let t,n=null,i=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){n=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){i=t.error;break}}t=n?Object(c.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>o.a.createElement("a",{href:n.data&&n.data.consent_uri,target:"_blank"},e)}):i?Object(Ts.a)(i.data.limit_type,i.data.admin_contact,{monthly_active_user:Object(c.b)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),"":Object(c.b)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):1===e.length&&e[0].error&&e[0].error.data&&e[0].error.data.error?Object(Ts.b)(e[0].error.data)||e[0].error.data.error:Object(c.a)("%(count)s of your messages have not been sent.",{count:e.length});const r=Object(c.a)("%(count)s <resendText>Resend all</resendText> or <cancelText>cancel all</cancelText> now. You can also select individual messages to resend or cancel.",{count:e.length},{resendText:e=>o.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"resend",onClick:this._onResendAllClick},e),cancelText:e=>o.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"cancel",onClick:this._onCancelAllClick},e)});return o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},o.a.createElement("img",{src:s(337),width:"24",height:"24",title:Object(c.a)("Warning"),alt:""}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},t),o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},r)))}_getContent(){return this._shouldShowConnectionError()?o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},o.a.createElement("img",{src:s(337),width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(c.a)("Connectivity to the server has been lost.")),o.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(c.a)("Sent messages will be stored until your connection has returned.")))):this.state.unsentMessages.length>0?this._getUnsentMessageContent():this.props.hasActiveCall?o.a.createElement("div",{className:"mx_RoomStatusBar_callBar"},o.a.createElement("b",null,Object(c.a)("Active call"))):this.props.sentMessageAndIsAlone&&!this.props.isPeeking?o.a.createElement("div",{className:"mx_RoomStatusBar_isAlone"},Object(c.a)("There's no one else here! Would you like to <inviteText>invite others</inviteText> or <nowarnText>stop warning about the empty room</nowarnText>?",{},{inviteText:e=>o.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"invite",onClick:this.props.onInviteClick},e),nowarnText:e=>o.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"nowarn",onClick:this.props.onStopWarningClick},e)})):null}render(){const e=this._getContent(),t=this._getIndicator();return o.a.createElement("div",{className:"mx_RoomStatusBar"},o.a.createElement("div",{className:"mx_RoomStatusBar_indicator"},t),o.a.createElement("div",{role:"alert"},e))}}g()(Ar,"propTypes",{room:re.a.object.isRequired,sentMessageAndIsAlone:re.a.bool,hasActiveCall:re.a.bool,isPeeking:re.a.bool,onResendAllClick:re.a.func,onCancelAllClick:re.a.func,onInviteClick:re.a.func,onStopWarningClick:re.a.func,onResize:re.a.func,onHidden:re.a.func,onVisible:re.a.func});var Ur=s(505);class Mr extends o.a.Component{constructor(e){super(e),g()(this,"onAction",e=>{if(this.props.enableRoomSearchFocus)switch(e.action){case"view_room":this._search.current&&e.clear_search&&this._clearSearch();break;case"focus_room_filter":this._search.current&&this._search.current.focus()}}),g()(this,"onChange",()=>{this._search.current&&(this.setState({searchTerm:this._search.current.value}),this.onSearch())}),g()(this,"onSearch",Object(jt.throttle)(()=>{this.props.onSearch(this._search.current.value)},200,{trailing:!0,leading:!0})),g()(this,"_onKeyDown",e=>{switch(e.key){case Yt.a.ESCAPE:this._clearSearch("keyboard")}this.props.onKeyDown&&this.props.onKeyDown(e)}),g()(this,"_onFocus",e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)}),g()(this,"_onBlur",e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)}),this._search=Object(i.createRef)(),this.state={searchTerm:"",blurred:!0}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}_clearSearch(e){this._search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){if(this.props.collapsed)return null;const e=!this.state.blurred||this.state.searchTerm?o.a.createElement(Z.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this._clearSearch("button")}}):void 0,t=this.state.blurred&&this.props.blurredPlaceholder||this.props.placeholder,s=this.props.className||"";return o.a.createElement("div",{className:E()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},o.a.createElement("input",{key:"searchfield",type:"text",ref:this._search,className:"mx_textinput_icon mx_textinput_search "+s,value:this.state.searchTerm,onFocus:this._onFocus,onChange:this.onChange,onKeyDown:this._onKeyDown,onBlur:this._onBlur,placeholder:t,autoComplete:"off"}),e)}}g()(Mr,"propTypes",{onSearch:re.a.func,onCleared:re.a.func,onKeyDown:re.a.func,className:re.a.string,placeholder:re.a.string.isRequired,enableRoomSearchFocus:re.a.bool}),g()(Mr,"defaultProps",{enableRoomSearchFocus:!1});var Lr=s(506),Fr=s(224),Br=s(211),Vr=s.n(Br);class Kr extends o.a.Component{constructor(...e){super(...e),g()(this,"onAction",e=>{switch(e.action){case"upload_progress":case"upload_finished":case"upload_canceled":case"upload_failed":this.mounted&&this.forceUpdate()}})}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,u.a.unregister(this.dispatcherRef)}render(){const e=Fr.a.sharedInstance().getCurrentUploads();if(0==e.length)return o.a.createElement("div",null);let t;for(let s=0;s<e.length;++s)if(e[s].roomId==this.props.room.roomId){t=e[s];break}if(!t)return o.a.createElement("div",null);const n={width:t.loaded/(t.total||1)*100+"%"};let i=Vr()(t.loaded);const r=Vr()(t.total);i.replace(/^.* /,"")===r.replace(/^.* /,"")&&(i=i.replace(/ .*/,""));const a=Object(c.a)("Uploading %(filename)s and %(count)s others",{filename:t.fileName,count:e.length-1});return o.a.createElement("div",{className:"mx_UploadBar"},o.a.createElement("div",{className:"mx_UploadBar_uploadProgressOuter"},o.a.createElement("div",{className:"mx_UploadBar_uploadProgressInner",style:n})),o.a.createElement("img",{className:"mx_UploadBar_uploadIcon mx_filterFlipColor",src:s(912),width:"17",height:"22"}),o.a.createElement("img",{className:"mx_UploadBar_uploadCancel mx_filterFlipColor",src:s(152),width:"18",height:"18",onClick:function(){Fr.a.sharedInstance().cancelUpload(t.promise)}}),o.a.createElement("div",{className:"mx_UploadBar_uploadBytes"},i," / ",r),o.a.createElement("div",{className:"mx_UploadBar_uploadFilename"},a))}}g()(Kr,"propTypes",{room:re.a.object});class qr extends o.a.Component{static get propTypes(){return{userId:re.a.string}}constructor(e){super(e),this.state={}}componentDidMount(){this.props.userId&&this._loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this._loadProfileInfo()}async _loadProfileInfo(){const e=L.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){const t=d.getComponent("dialogs.ErrorDialog");return ke.a.createTrackedDialog(Object(c.a)("Could not load user profile"),"",t,{title:Object(c.a)("Could not load user profile"),description:e&&e.message?e.message:Object(c.a)("Operation failed")}),void this.setState({loading:!1})}const s=new de.r.MatrixEvent({type:"m.room.member",content:t}),n=new de.r.RoomMember(null,this.props.userId);n.setMembershipEvent(s),this.setState({member:n,loading:!1})}render(){if(this.state.loading){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}if(this.state.member){const e=d.getComponent("structures.RightPanel"),t=d.getComponent("structures.MainSplit"),s=o.a.createElement(e,{user:this.state.member});return o.a.createElement(t,{panel:s,resizeNotifier:this.props.resizeNotifier},o.a.createElement(m,null))}return o.a.createElement("div",null)}}var Gr=s(537);class Wr extends o.a.Component{constructor(e){super(e),this._ref=this._ref.bind(this)}componentDidUpdate(){this._el&&Object(Gr.highlightBlock)(this._el)}_ref(e){this._el=e,this.componentDidUpdate()}render(){const{className:e,children:t}=this.props;return o.a.createElement("pre",{className:e+" mx_SyntaxHighlight",ref:this._ref},o.a.createElement("code",null,t))}}g()(Wr,"propTypes",{className:re.a.string,children:re.a.node});class Hr extends o.a.Component{render(){const e=d.getComponent("views.dialogs.BaseDialog");return o.a.createElement(e,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(c.a)("View Source")},o.a.createElement("div",{className:"mx_ViewSource_label_left"},"Room ID: ",this.props.roomId),o.a.createElement("div",{className:"mx_ViewSource_label_right"},"Event ID: ",this.props.eventId),o.a.createElement("div",{className:"mx_ViewSource_label_bottom"}),o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(Wr,{className:"json"},JSON.stringify(this.props.content,null,2))))}}g()(Hr,"propTypes",{content:re.a.object.isRequired,onFinished:re.a.func.isRequired,roomId:re.a.string.isRequired,eventId:re.a.string.isRequired});var $r=s(332),zr=s(331);class Yr extends o.a.Component{constructor(){super(),g()(this,"_onStoreUpdate",()=>{const e=$r.f.sharedInstance();this.setState({phase:e.phase})});const e=$r.f.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase}}componentWillUnmount(){const e=$r.f.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=d.getComponent("auth.AuthPage"),t=d.getComponent("auth.CompleteSecurityBody"),{phase:s}=this.state;let n,i;if(s===$r.e)n=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Verify this login");else if(s===$r.c)n=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),i=Object(c.a)("Session verified");else if(s===$r.b)n=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Are you sure?");else{if(s!==$r.a)throw new Error("Unknown phase "+s);n=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Verify this login")}return o.a.createElement(e,null,o.a.createElement(t,null,o.a.createElement("h2",{className:"mx_CompleteSecurity_header"},n,i),o.a.createElement("div",{className:"mx_CompleteSecurity_body"},o.a.createElement(zr.a,{onFinished:this.props.onFinished}))))}}g()(Yr,"propTypes",{onFinished:re.a.func.isRequired});var Jr=s(379);class Qr extends o.a.Component{constructor(){super(),this._createStorageDialogPromise=s.e(2).then(s.bind(null,1145))}render(){const e=d.getComponent("auth.AuthPage"),t=d.getComponent("auth.CompleteSecurityBody");return o.a.createElement(e,null,o.a.createElement(t,null,o.a.createElement(Jr.a,{prom:this._createStorageDialogPromise,hasCancel:!1,onFinished:this.props.onFinished,accountPassword:this.props.accountPassword})))}}g()(Qr,"propTypes",{onFinished:re.a.func.isRequired,accountPassword:re.a.string});class Xr{constructor(e,t){this.client=de.p({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret(),this.identityServerDomain=t?t.split("://")[1]:null}doesServerRequireIdServerParam(){return this.client.doesServerRequireIdServerParam()}resetPassword(e,t){return this.password=t,this.client.requestPasswordEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(c.a)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};await this.doesServerRequireIdServerParam()&&(e.id_server=this.identityServerDomain);try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password)}catch(e){throw 401===e.httpStatus?e.message=Object(c.a)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(c.a)("Your email address does not appear to be associated with a Matrix ID on this Homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}var Zr,ea=s(84);let ta=Object(bn.a)("views.auth.AuthPage")(Zr=class extends o.a.PureComponent{render(){const e=d.getComponent("auth.AuthFooter");return o.a.createElement("div",{className:"mx_AuthPage"},o.a.createElement("div",{className:"mx_AuthPage_modal"},this.props.children),o.a.createElement(e,null))}})||Zr;class sa extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{phase:1,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:"",serverRequiresIdServer:null}),g()(this,"onVerify",async e=>{if(e.preventDefault(),this.reset)try{await this.reset.checkEmailLinkClicked(),this.setState({phase:4})}catch(e){this.showErrorDialog(e.message)}else console.error("onVerify called before submitPasswordReset!")}),g()(this,"onSubmitForm",async e=>{if(e.preventDefault(),await this._checkServerLiveliness(this.props.serverConfig),this.state.email)if(this.state.password&&this.state.password2)if(this.state.password!==this.state.password2)this.showErrorDialog(Object(c.a)("New passwords must match each other."));else{const e=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Forgot Password Warning","",e,{title:Object(c.a)("Warning!"),description:o.a.createElement("div",null,Object(c.a)("Changing your password will reset any end-to-end encryption keys on all of your sessions, making encrypted chat history unreadable. Set up Key Backup or export your room keys from another session before resetting your password.")),button:Object(c.a)("Continue"),onFinished:e=>{e&&this.submitPasswordReset(this.state.email,this.state.password)}})}else this.showErrorDialog(Object(c.a)("A new password must be entered."));else this.showErrorDialog(Object(c.a)("The email address linked to your account must be entered."))}),g()(this,"onInputChanged",(e,t)=>{this.setState({[e]:t.target.value})}),g()(this,"onServerDetailsNextPhaseClick",async()=>{this.setState({phase:1})}),g()(this,"onEditServerDetailsClick",e=>{e.preventDefault(),e.stopPropagation(),this.setState({phase:0})}),g()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})}componentDidMount(){this.reset=null,this._checkServerLiveliness(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this._checkServerLiveliness(e.serverConfig)}async _checkServerLiveliness(e){try{await ea.b.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl);const t=new Xr(e.hsUrl,e.isUrl),s=await t.doesServerRequireIdServerParam();this.setState({serverIsAlive:!0,serverRequiresIdServer:s})}catch(e){this.setState(ea.b.authComponentStateForError(e,"forgot_password"))}}submitPasswordReset(e,t){this.setState({phase:2}),this.reset=new Xr(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.reset.resetPassword(e,t).then(()=>{this.setState({phase:3})},e=>{this.showErrorDialog(Object(c.a)("Failed to send email")+": "+e.message),this.setState({phase:1})})}showErrorDialog(e,t){const s=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Forgot Password Error","",s,{title:t,description:e})}renderServerDetails(){const e=d.getComponent("auth.ServerConfig");return l.a.get().disable_custom_urls?null:o.a.createElement(e,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,delayTimeMs:0,showIdentityServerIfRequiredByHomeserver:!0,onAfterSubmit:this.onServerDetailsNextPhaseClick,submitText:Object(c.a)("Next"),submitClass:"mx_Login_submit"})}renderForgot(){const e=d.getComponent("elements.Field");let t=null;const s=this.state.errorText;let n;if(s&&(t=o.a.createElement("div",{className:"mx_Login_error"},s)),!this.state.serverIsAlive){const e=E()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=o.a.createElement("div",{className:e},this.state.serverDeadError)}let i=Object(c.a)("Your Matrix account on %(serverName)s",{serverName:this.props.serverConfig.hsName});if(this.props.serverConfig.hsNameIsDifferent){const e=d.getComponent("elements.TextWithTooltip");i=Object(c.a)("Your Matrix account on <underlinedServerName />",{},{underlinedServerName:()=>o.a.createElement(e,{class:"mx_Login_underlinedServerName",tooltip:this.props.serverConfig.hsUrl},this.props.serverConfig.hsName)})}let r=null;return l.a.get().disable_custom_urls||(r=o.a.createElement("a",{className:"mx_AuthBody_editServerDetails",href:"#",onClick:this.onEditServerDetailsClick},Object(c.a)("Change"))),!this.props.serverConfig.isUrl&&this.state.serverRequiresIdServer?o.a.createElement("div",null,o.a.createElement("h3",null,i,r),Object(c.a)("No identity server is configured: add one in server settings to reset your password."),o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(c.a)("Sign in instead"))):o.a.createElement("div",null,t,n,o.a.createElement("h3",null,i,r),o.a.createElement("form",{onSubmit:this.onSubmitForm},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(e,{name:"reset_email",type:"text",label:Object(c.a)("Email"),value:this.state.email,onChange:this.onInputChanged.bind(this,"email"),autoFocus:!0})),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(e,{name:"reset_password",type:"password",label:Object(c.a)("Password"),value:this.state.password,onChange:this.onInputChanged.bind(this,"password")}),o.a.createElement(e,{name:"reset_password_confirm",type:"password",label:Object(c.a)("Confirm"),value:this.state.password2,onChange:this.onInputChanged.bind(this,"password2")})),o.a.createElement("span",null,Object(c.a)("A verification email will be sent to your inbox to confirm setting your new password.")),o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Send Reset Email")})),o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(c.a)("Sign in instead")))}renderSendingEmail(){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}renderEmailSent(){return o.a.createElement("div",null,Object(c.a)("An email has been sent to %(emailAddress)s. Once you've followed the link it contains, click below.",{emailAddress:this.state.email}),o.a.createElement("br",null),o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.onVerify,value:Object(c.a)("I have verified my email address")}))}renderDone(){return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Your password has been reset.")),o.a.createElement("p",null,Object(c.a)("You have been logged out of all sessions and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")),o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(c.a)("Return to login screen")}))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody");let s;switch(this.state.phase){case 0:s=this.renderServerDetails();break;case 1:s=this.renderForgot();break;case 2:s=this.renderSendingEmail();break;case 3:s=this.renderEmailSent();break;case 4:s=this.renderDone()}return o.a.createElement(ta,null,o.a.createElement(e,null),o.a.createElement(t,null,o.a.createElement("h2",null," ",Object(c.a)("Set a new password")," "),s))}}g()(sa,"propTypes",{serverConfig:re.a.instanceOf(ea.a).isRequired,onServerConfigChange:re.a.func.isRequired,onLoginClick:re.a.func,onComplete:re.a.func.isRequired});var na=s(255);const ia=e=>{let{matrixClient:t,loginType:s,fragmentAfterLogin:n}=e,i=K()(e,["matrixClient","loginType","fragmentAfterLogin"]);return o.a.createElement(Z.a,B()({},i,{kind:"primary",onClick:()=>{Re.a.get().startSingleSignOn(t,s,n)}}),Object(c.a)("Sign in with single sign-on"))};ia.propTypes={matrixClient:re.a.object.isRequired,loginType:re.a.oneOf(["sso","cas"]),fragmentAfterLogin:re.a.string};var oa=ia;function ra(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function aa(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ra(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ra(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const ca=/^[0-9()\-\s]*$/;Object(c.b)("Invalid homeserver discovery response"),Object(c.b)("Failed to get autodiscovery configuration from server"),Object(c.b)("Invalid base_url for m.homeserver"),Object(c.b)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(c.b)("Invalid identity server discovery response"),Object(c.b)("Invalid base_url for m.identity_server"),Object(c.b)("Identity server URL does not appear to be a valid identity server"),Object(c.b)("General failure");class la extends o.a.Component{constructor(e){super(e),g()(this,"onPasswordLoginError",e=>{this.setState({errorText:e,loginIncorrect:Boolean(e)})}),g()(this,"isBusy",()=>this.state.busy||this.props.busy),g()(this,"onPasswordLogin",async(e,t,s,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await ea.b.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const s=ea.b.authComponentStateForError(t);this.setState(aa({busy:!1,busyLoggingIn:!1},s)),e=!s.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this._loginLogic.loginViaPassword(e,t,s,n).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)},t=>{if(this._unmounted)return;let s;const n=e.indexOf("@")>0;if(400===t.httpStatus&&n)s=Object(c.a)("This homeserver does not support login using email address.");else if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const e=Object(Ts.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(c.b)("This homeserver has hit its Monthly Active User limit."),"":Object(c.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(Ts.a)(t.data.limit_type,t.data.admin_contact,{"":Object(c.b)("Please <a>contact your service administrator</a> to continue using this service.")});s=o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement("div",{className:"mx_Login_smallError"},n))}else 401===t.httpStatus||403===t.httpStatus?"M_USER_DEACTIVATED"===t.errcode?s=Object(c.a)("This account has been deactivated."):l.a.get().disable_custom_urls&&(s=o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("Incorrect username and/or password.")),o.a.createElement("div",{className:"mx_Login_smallError"},Object(c.a)("Please note you are logging into the %(hs)s server, not matrix.org.",{hs:this.props.serverConfig.hsName})))):s=this._errorTextFromError(t);this.setState({busy:!1,busyLoggingIn:!1,errorText:s,loginIncorrect:401===t.httpStatus||403===t.httpStatus})})}),g()(this,"onUsernameChanged",e=>{this.setState({username:e})}),g()(this,"onUsernameBlur",async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await ea.b.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){console.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=Object(c.a)("Failed to perform homeserver discovery");e.translatedMessage&&(t=e.translatedMessage);let s=t,n={};ea.b.isLivelinessError(e)&&(s=this.state.errorText,n=ea.b.authComponentStateForError(e)),this.setState(aa({busy:!1,errorText:s},n))}}}),g()(this,"onPhoneCountryChanged",e=>{this.setState({phoneCountry:e})}),g()(this,"onPhoneNumberChanged",e=>{this.setState({phoneNumber:e})}),g()(this,"onPhoneNumberBlur",e=>{ca.test(e)?this.setState({errorText:null,canTryLogin:!0}):this.setState({errorText:Object(c.a)("The phone number entered looks invalid"),canTryLogin:!1})}),g()(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),g()(this,"onTryRegisterClick",e=>{const t=this._getCurrentFlowStep();if("m.login.sso"===t||"m.login.cas"===t){e.preventDefault(),e.stopPropagation();const s="m.login.sso"===t?"sso":"cas";Re.a.get().startSingleSignOn(this._loginLogic.createTemporaryClient(),s,this.props.fragmentAfterLogin)}else this.onRegisterClick(e)}),g()(this,"onServerDetailsNextPhaseClick",()=>{this.setState({phase:1})}),g()(this,"onEditServerDetailsClick",e=>{e.preventDefault(),e.stopPropagation(),this.setState({phase:0})}),g()(this,"_renderPasswordStep",()=>{const e=d.getComponent("auth.PasswordLogin");let t=null;return l.a.get().disable_custom_urls||(t=this.onEditServerDetailsClick),o.a.createElement(e,{onSubmit:this.onPasswordLogin,onError:this.onPasswordLoginError,onEditServerDetailsClick:t,initialUsername:this.state.username,initialPhoneCountry:this.state.phoneCountry,initialPhoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onPhoneNumberBlur:this.onPhoneNumberBlur,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})}),g()(this,"_renderSsoStep",e=>{const t=d.getComponent("views.auth.SignInToText");let s=null;return l.a.get().disable_custom_urls||(s=this.onEditServerDetailsClick),o.a.createElement("div",null,o.a.createElement(t,{serverConfig:this.props.serverConfig,onEditServerDetailsClick:s}),o.a.createElement(oa,{className:"mx_Login_sso_link mx_Login_submit",matrixClient:this._loginLogic.createTemporaryClient(),loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin}))}),this._unmounted=!1,this.state={busy:!1,busyLoggingIn:null,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:"",phoneCountry:null,phoneNumber:"",phase:1,currentFlow:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this._stepRendererMap={"m.login.password":this._renderPasswordStep,"m.login.cas":()=>this._renderSsoStep("cas"),"m.login.sso":()=>this._renderSsoStep("sso")}}UNSAFE_componentWillMount(){this._initLoginLogic()}componentWillUnmount(){this._unmounted=!0}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this._initLoginLogic(e.serverConfig.hsUrl,e.serverConfig.isUrl)}async _initLoginLogic(e,t){e=e||this.props.serverConfig.hsUrl,t=t||this.props.serverConfig.isUrl;let s=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(s=!0);const n=s?this.props.fallbackHsUrl:null,i=new na.a(e,t,n,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this._loginLogic=i,this.setState({busy:!0,currentFlow:null,loginIncorrect:!1});try{const{warning:s}=await ea.b.validateServerConfigWithStaticUrls(e,t);s?this.setState(aa(aa({},ea.b.authComponentStateForError(s)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){if(this.setState(aa({busy:!1},ea.b.authComponentStateForError(e))),this.state.serverErrorIsFatal)return void this.setState({phase:0})}i.getFlows().then(e=>{for(let t=0;t<e.length;t++)if(this._isSupportedFlow(e[t]))return i.chooseFlow(t),void this.setState({currentFlow:this._getCurrentFlowStep()});this.setState({errorText:Object(c.a)("This homeserver doesn't offer any login flows which are supported by this client.")})},e=>{this.setState({errorText:this._errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}_isSupportedFlow(e){return!!this._stepRendererMap[e.type]||(console.log("Skipping flow",e,"due to unsupported login type",e.type),!1)}_getCurrentFlowStep(){return this._loginLogic?this._loginLogic.getCurrentFlowStep():null}_errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let s=Object(c.a)("Error: Problem communicating with the given homeserver.")+(t?" ("+t+")":"");return"rejected"===e.cors&&(s="https:"!==window.location.protocol||!this.props.serverConfig.hsUrl.startsWith("http:")&&this.props.serverConfig.hsUrl.startsWith("http")?o.a.createElement("span",null,Object(c.a)("Can't connect to homeserver - please check your connectivity, ensure your <a>homeserver's SSL certificate</a> is trusted, and that a browser extension is not blocking requests.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:this.props.serverConfig.hsUrl},e)})):o.a.createElement("span",null,Object(c.a)("Can't connect to homeserver via HTTP when an HTTPS URL is in your browser bar. Either use HTTPS or <a>enable unsafe scripts</a>.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://www.google.com/search?&q=enable%20unsafe%20scripts"},e)}))),s}renderServerComponent(){const e=d.getComponent("auth.ServerConfig");if(l.a.get().disable_custom_urls)return null;if(0!==this.state.phase)return null;const t={};return t.onAfterSubmit=this.onServerDetailsNextPhaseClick,t.submitText=Object(c.a)("Next"),t.submitClass="mx_Login_submit",o.a.createElement(e,B()({serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,delayTimeMs:250},t))}renderLoginComponentForStep(){if(1!==this.state.phase)return null;const e=this.state.currentFlow;if(!e)return null;const t=this._stepRendererMap[e];return t?t():null}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("elements.InlineSpinner"),s=d.getComponent("auth.AuthHeader"),n=d.getComponent("auth.AuthBody"),i=this.isBusy()&&!this.state.busyLoggingIn?o.a.createElement("div",{className:"mx_Login_loader"},o.a.createElement(e,null)):null,r=this.state.errorText;let a,l,u;if(r&&(a=o.a.createElement("div",{className:"mx_Login_error"},r)),!this.state.serverIsAlive){const e=E()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});l=o.a.createElement("div",{className:e},this.state.serverDeadError)}return u=this.props.isSyncing||this.state.busyLoggingIn?o.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},o.a.createElement(t,{w:20,h:20}),this.props.isSyncing?Object(c.a)("Syncing..."):Object(c.a)("Signing In...")),this.props.isSyncing&&o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(c.a)("If you've joined lots of rooms, this might take a while"))):o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onTryRegisterClick,href:"#"},Object(c.a)("Create account")),o.a.createElement(ta,null,o.a.createElement(s,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),o.a.createElement(n,null,o.a.createElement("h2",null,Object(c.a)("Sign in"),i),a,l,this.renderServerComponent(),this.renderLoginComponentForStep()))}}g()(la,"propTypes",{onLoggedIn:re.a.func.isRequired,busy:re.a.bool,fallbackHsUrl:re.a.string,defaultDeviceDisplayName:re.a.string,onRegisterClick:re.a.func.isRequired,onForgotPasswordClick:re.a.func,onServerConfigChange:re.a.func.isRequired,serverConfig:re.a.instanceOf(ea.a).isRequired,isSyncing:re.a.bool});class da extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{avatarUrl:null,errorString:null,busy:!1})}componentDidMount(){const e=L.a.get();this.setState({busy:!0});const t=this;e.getProfileInfo(e.credentials.userId).then((function(e){t.setState({avatarUrl:L.a.get().mxcUrlToHttp(e.avatar_url),busy:!1})}),(function(e){t.setState({errorString:Object(c.a)("Failed to fetch avatar URL"),busy:!1})}))}render(){const e=d.getComponent("settings.ChangeDisplayName"),t=d.getComponent("settings.ChangeAvatar"),s=d.getComponent("auth.AuthHeader"),n=d.getComponent("auth.AuthBody");return o.a.createElement(ta,null,o.a.createElement(s,null),o.a.createElement(n,null,o.a.createElement("div",{className:"mx_Login_profile"},Object(c.a)("Set a display name:"),o.a.createElement(e,null),Object(c.a)("Upload an avatar:"),o.a.createElement(t,{initialAvatarUrl:this.state.avatarUrl}),o.a.createElement("button",{onClick:this.props.onComplete},Object(c.a)("Continue")),this.state.errorString)))}}g()(da,"propTypes",{onComplete:re.a.func.isRequired});var ua=s(481);const ha={FREE:{id:"Free",label:()=>Object(c.a)("Free"),logo:()=>o.a.createElement("img",{src:s(1103)}),description:()=>Object(c.a)("Join millions for free on the largest public server"),serverConfig:Object(ua.a)(ea.a,{hsUrl:"https://matrix-client.matrix.org",hsName:"matrix.org",hsNameIsDifferent:!1,isUrl:"https://vector.im"})},PREMIUM:{id:"Premium",label:()=>Object(c.a)("Premium"),logo:()=>o.a.createElement("img",{src:s(1104),height:16}),description:()=>Object(c.a)("Premium hosting for organisations <a>Learn more</a>",{},{a:e=>o.a.createElement("a",{href:"https://element.io/matrix-services?utm_source=element-web&utm_medium=web&utm_campaign=element-web-authentication",target:"_blank",rel:"noreferrer noopener"},e)}),identityServerUrl:"https://vector.im"},ADVANCED:{id:"Advanced",label:()=>Object(c.a)("Advanced"),logo:()=>o.a.createElement("div",null,o.a.createElement("img",{src:s(1105)}),Object(c.a)("Other")),description:()=>Object(c.a)("Find other public servers or use a custom server")}};function ma(e){const{hsUrl:t}=e;return t?t===ha.FREE.serverConfig.hsUrl?"Free":new URL(t).hostname.endsWith(".modular.im")?"Premium":"Advanced":null}class pa extends o.a.PureComponent{constructor(e){super(e),g()(this,"onClick",e=>{e.stopPropagation();const t=e.currentTarget.dataset.id;this.updateSelectedType(t)});const{selected:t}=e;this.state={selected:t}}updateSelectedType(e){this.state.selected!==e&&(this.setState({selected:e}),this.props.onChange&&this.props.onChange(e))}render(){const e=d.getComponent("elements.AccessibleButton"),t=[];for(const s of Object.values(ha)){const{id:n,label:i,logo:r,description:a}=s,c=E()("mx_ServerTypeSelector_type","mx_ServerTypeSelector_type_"+n,{mx_ServerTypeSelector_type_selected:n===this.state.selected});t.push(o.a.createElement("div",{className:c,key:n},o.a.createElement("div",{className:"mx_ServerTypeSelector_label"},i()),o.a.createElement(e,{onClick:this.onClick,"data-id":n},o.a.createElement("div",{className:"mx_ServerTypeSelector_logo"},r()),o.a.createElement("div",{className:"mx_ServerTypeSelector_description"},a()))))}return o.a.createElement("div",{className:"mx_ServerTypeSelector"},t)}}function ga(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}g()(pa,"propTypes",{selected:re.a.string,onChange:re.a.func.isRequired});class fa extends o.a.Component{constructor(e){super(e),g()(this,"onServerTypeChange",e=>{switch(this.setState({serverType:e}),e){case"Free":{const{serverConfig:e}=ha.FREE;this.props.onServerConfigChange(e);break}case"Premium":break;case"Advanced":this.props.onServerConfigChange(l.a.get().validated_server_config)}this.setState({phase:this.getDefaultPhaseForServerType(e)})}),g()(this,"onFormSubmit",e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})}),g()(this,"_requestEmailToken",(e,t,s,n)=>this.state.matrixClient.requestRegisterEmailToken(e,t,s,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))),g()(this,"_onUIAuthFinished",async(e,t,s)=>{if(!e){let e=t.message||t.toString();if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const s=Object(Ts.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(c.b)("This homeserver has hit its Monthly Active User limit."),"":Object(c.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(Ts.a)(t.data.limit_type,t.data.admin_contact,{"":Object(c.b)("Please <a>contact your service administrator</a> to continue using this service.")});e=o.a.createElement("div",null,o.a.createElement("p",null,s),o.a.createElement("p",null,n))}else if(t.required_stages&&t.required_stages.indexOf("m.login.msisdn")>-1){let s=!1;for(const e of t.available_flows)s|=e.stages.indexOf("m.login.msisdn")>-1;s||(e=Object(c.a)("This server does not support authentication with a phone number."))}return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}L.a.setJustRegisteredUserId(t.user_id);const n={doingUIAuth:!1,registeredUsername:t.user_id},i=ye.d(),r=ye.c();i&&!r&&i!==t.userId?(console.log(`Found a session for ${i} but ${t.userId} has just registered.`),n.differentLoggedInUserId=i):n.differentLoggedInUserId=null,t.access_token?(await this.props.onLoggedIn({userId:t.user_id,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:t.access_token},this.state.formVals.password),this._setupPushers(),n.busy=!0):(n.busy=!1,n.completedNoSignin=!0),this.setState(n)}),g()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),g()(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this._replaceClient(),this.setState({busy:!1,doingUIAuth:!1,phase:1})}),g()(this,"onServerDetailsNextPhaseClick",async()=>{this.setState({phase:1})}),g()(this,"onEditServerDetailsClick",e=>{e.preventDefault(),e.stopPropagation(),this.setState({phase:0})}),g()(this,"_makeRegisterRequest",e=>{let t=Boolean(this.state.formVals.email);this.state.formVals.password||(t=null);const s={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName};return e&&(s.auth=e),null!=t&&(s.inhibit_login=t),this.state.matrixClient.registerRequest(s)}),g()(this,"_onLoginClickWithCheck",async e=>{e.preventDefault();await ye.i({ignoreGuest:!0})||this.props.onLoginClick()});const t=ma(this.props.serverConfig);this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),serverType:t,phase:1,flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:"",matrixClient:null,serverRequiresIdServer:null,registeredUsername:null,differentLoggedInUserId:null}}componentDidMount(){this._unmounted=!1,this._replaceClient()}UNSAFE_componentWillReceiveProps(e){if(e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl)return;this._replaceClient(e.serverConfig);const t=ma(e.serverConfig);t!==this.state.serverType&&this.setState({serverType:t,phase:this.getDefaultPhaseForServerType(t)})}getDefaultPhaseForServerType(e){switch(e){case"Free":return 1;case"Premium":case"Advanced":return 0}}async _replaceClient(e){this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0}),e||(e=this.props.serverConfig);try{await ea.b.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(e){if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ga(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ga(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({busy:!1},ea.b.authComponentStateForError(e,"register"))),this.state.serverErrorIsFatal)return}const{hsUrl:t,isUrl:s}=e,n=de.r.createClient({baseUrl:t,idBaseUrl:s});let i=!0;try{i=await n.doesServerRequireIdServerParam()}catch(e){console.log("Unable to determine is server needs id_server param",e)}this.setState({matrixClient:n,serverRequiresIdServer:i,busy:!1});const o=e=>{this.setState({errorText:Object(c.a)("Unable to query for supported registration methods."),flows:[]})};try{this.state.doingUIAuth||(await this._makeRegisterRequest(null),console.log("Expecting 401 from register request but got success!"))}catch(e){if(401===e.httpStatus)this.setState({flows:e.data.flows});else if(403===e.httpStatus&&"M_UNKNOWN"===e.errcode)try{const e=new na.a(t,s,null,{defaultDeviceDisplayName:"Element login check"}),n=await e.getFlows();n.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type)?u.a.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:Object(c.a)("Registration has been disabled on this homeserver."),flows:[]})}catch(e){console.error("Failed to get login flows to check for SSO support",e),o()}else console.log("Unable to query for supported registration methods.",e),o()}}_setupPushers(){if(!this.props.brand)return Promise.resolve();const e=L.a.get();return e.getPushers().then(t=>{const s=t.pushers;for(let t=0;t<s.length;++t)if("email"===s[t].kind){const n=s[t];n.data={brand:this.props.brand},e.setPusher(n).then(()=>{console.log("Set email branding to "+this.props.brand)},e=>{console.error("Couldn't set email branding: "+e)})}},e=>{console.error("Couldn't get pushers: "+e)})}_getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderServerComponent(){const e=d.getComponent("auth.ServerTypeSelector"),t=d.getComponent("auth.ServerConfig"),s=d.getComponent("auth.ModularServerConfig");if(l.a.get().disable_custom_urls)return null;if(0!==this.state.phase&&!this.state.serverErrorIsFatal)return o.a.createElement("div",null,o.a.createElement(e,{selected:this.state.serverType,onChange:this.onServerTypeChange}));const n={};n.onAfterSubmit=this.onServerDetailsNextPhaseClick,n.submitText=Object(c.a)("Next"),n.submitClass="mx_Login_submit";let i=null;switch(this.state.serverType){case"Free":break;case"Premium":i=o.a.createElement(s,B()({serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,delayTimeMs:250},n));break;case"Advanced":i=o.a.createElement(t,B()({serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,delayTimeMs:250,showIdentityServerIfRequiredByHomeserver:!0},n))}return o.a.createElement("div",null,o.a.createElement(e,{selected:this.state.serverType,onChange:this.onServerTypeChange}),i)}renderRegisterComponent(){if(1!==this.state.phase)return null;const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("elements.Spinner"),s=d.getComponent("auth.RegistrationForm");if(this.state.matrixClient&&this.state.doingUIAuth)return o.a.createElement(e,{matrixClient:this.state.matrixClient,makeRequest:this._makeRegisterRequest,onAuthFinished:this._onUIAuthFinished,inputs:this._getUIAuthInputs(),requestEmailToken:this._requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return o.a.createElement("div",{className:"mx_AuthBody_spinner"},o.a.createElement(t,null));if(this.state.flows.length){let e=null;return l.a.get().disable_custom_urls||"Free"===this.state.serverType||(e=this.onEditServerDetailsClick),o.a.createElement(s,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,onEditServerDetailsClick:e,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,serverRequiresIdServer:this.state.serverRequiresIdServer})}}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");let n;const i=this.state.errorText;let r;if(i&&(n=o.a.createElement("div",{className:"mx_Login_error"},i)),!this.state.serverIsAlive){const e=E()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});r=o.a.createElement("div",{className:e},this.state.serverDeadError)}const a=o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(c.a)("Sign in instead"));let l,u;if((1!==this.state.phase||this.state.doingUIAuth)&&(l=o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked,href:"#"},Object(c.a)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),o.a.createElement("p",null,o.a.createElement(s,{element:"span",className:"mx_linkButton",onClick:this._onLoginClickWithCheck},Object(c.a)("Continue with previous account")))):this.state.formVals.password?o.a.createElement("h3",null,Object(c.a)("<a>Log in</a> to your new account.",{},{a:e=>o.a.createElement("a",{href:"#/login",onClick:this._onLoginClickWithCheck},e)})):o.a.createElement("h3",null,Object(c.a)("You can now close this window or <a>log in</a> to your new account.",{},{a:e=>o.a.createElement("a",{href:"#/login",onClick:this._onLoginClickWithCheck},e)})),u=o.a.createElement("div",null,o.a.createElement("h2",null,Object(c.a)("Registration Successful")),e)}else u=o.a.createElement("div",null,o.a.createElement("h2",null,Object(c.a)("Create your account")),n,r,this.renderServerComponent(),this.renderRegisterComponent(),l,a);return o.a.createElement(ta,null,o.a.createElement(e,null),o.a.createElement(t,null,u))}}g()(fa,"propTypes",{onLoggedIn:re.a.func.isRequired,clientSecret:re.a.string,sessionId:re.a.string,makeRegistrationUrl:re.a.func.isRequired,idSid:re.a.string,serverConfig:re.a.instanceOf(ea.a).isRequired,brand:re.a.string,email:re.a.string,onLoginClick:re.a.func.isRequired,onServerConfigChange:re.a.func.isRequired,defaultDeviceDisplayName:re.a.string});const _a=1,va=2,ya=3,ba=4,Ea=5,Sa={"m.login.password":va,"m.login.cas":ya,"m.login.sso":ba};class wa extends o.a.Component{constructor(){super(),g()(this,"onClearAll",()=>{const e=d.getComponent("dialogs.ConfirmWipeDeviceDialog");ke.a.createTrackedDialog("Clear Data","Soft Logout",e,{onFinished:e=>{e&&(console.log("Clearing data from soft-logged-out session"),ye.j())}})}),g()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),g()(this,"onForgotPassword",()=>{u.a.dispatch({action:"start_password_recovery"})}),g()(this,"onPasswordLogin",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const t=L.a.get().getHomeserverUrl(),s=L.a.get().getIdentityServerUrl(),n={identifier:{type:"m.id.user",user:L.a.get().getUserId()},password:this.state.password,device_id:L.a.get().getDeviceId()};let i=null;try{i=await Object(na.b)(t,s,"m.login.password",n)}catch(e){let t=Object(c.a)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(c.a)("Incorrect password")),void this.setState({busy:!1,errorText:t})}ye.f(i).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(c.a)("Failed to re-authenticate")})})}),this.state={loginView:_a,keyBackupNeeded:!0,busy:!1,password:"",errorText:""}}componentDidMount(){ye.h()?(this._initLogin(),L.a.get().countSessionsNeedingBackup().then(e=>{this.setState({keyBackupNeeded:e>0})})):u.a.dispatch({action:"start_login"})}async _initLogin(){const e=this.props.realQueryParams;if(e&&e.loginToken)return this.setState({loginView:_a}),void this.trySsoLogin();const t=L.a.get(),s=(await t.loginFlows()).flows.map(e=>Sa[e.type]).filter(e=>!!e)[0]||Ea;this.setState({loginView:s})}async trySsoLogin(){this.setState({busy:!0});const e=localStorage.getItem(ft.a),t=localStorage.getItem(ft.b)||L.a.get().getIdentityServerUrl(),s={token:this.props.realQueryParams.loginToken,device_id:L.a.get().getDeviceId()};let n=null;try{n=await Object(na.b)(e,t,"m.login.token",s)}catch(e){return console.error(e),void this.setState({busy:!1,loginView:Ea})}ye.f(n).then(()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()}).catch(e=>{console.error(e),this.setState({busy:!1,loginView:Ea})})}_renderSignInSection(){if(this.state.loginView===_a){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}let e=null;if(this.state.keyBackupNeeded&&(e=Object(c.a)("Regain access to your account and recover encryption keys stored in this session. Without them, you won’t be able to read all of your secure messages in any session.")),this.state.loginView===va){const t=d.getComponent("elements.Field"),s=d.getComponent("elements.AccessibleButton");let n=null;return this.state.errorText&&(n=o.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),e||(e=Object(c.a)("Enter your password to sign in and regain access to your account.")),o.a.createElement("form",{onSubmit:this.onPasswordLogin},o.a.createElement("p",null,e),n,o.a.createElement(t,{type:"password",label:Object(c.a)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),o.a.createElement(s,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(c.a)("Sign In")),o.a.createElement(s,{onClick:this.onForgotPassword,kind:"link"},Object(c.a)("Forgotten your password?")))}return this.state.loginView===ba||this.state.loginView===ya?(e||(e=Object(c.a)("Sign in and regain access to your account.")),o.a.createElement("div",null,o.a.createElement("p",null,e),o.a.createElement(oa,{matrixClient:L.a.get(),loginType:this.state.loginView===ya?"cas":"sso",fragmentAfterLogin:this.props.fragmentAfterLogin}))):o.a.createElement("p",null,Object(c.a)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");return o.a.createElement(ta,null,o.a.createElement(e,null),o.a.createElement(t,null,o.a.createElement("h2",null,Object(c.a)("You're signed out")),o.a.createElement("h3",null,Object(c.a)("Sign in")),o.a.createElement("div",null,this._renderSignInSection()),o.a.createElement("h3",null,Object(c.a)("Clear personal data")),o.a.createElement("p",null,Object(c.a)("Warning: Your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),o.a.createElement("div",null,o.a.createElement(s,{onClick:this.onClearAll,kind:"danger"},Object(c.a)("Clear all data")))))}}g()(wa,"propTypes",{realQueryParams:re.a.object,onTokenLoginCompleted:re.a.func});class Ca extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_AuthBody"},this.props.children)}}class Ra extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_AuthFooter"},o.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(c.a)("powered by Matrix")))}}class ka extends o.a.Component{render(){const e=d.getComponent("auth.AuthHeaderLogo"),t=d.getComponent("views.auth.LanguageSelector");return o.a.createElement("div",{className:"mx_AuthHeader"},o.a.createElement(e,null),o.a.createElement(t,{disabled:this.props.disableLanguageSelector}))}}g()(ka,"propTypes",{disableLanguageSelector:re.a.bool});class Ia extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_AuthHeaderLogo"},"Matrix")}}var Oa=s(1106);class Ta extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}const xa=/^[0-9 -.]+$/;const Na=127462-"A".charCodeAt(0),ja=/^[A-Z]{2}$/,Pa=[{iso2:"GB",name:"United Kingdom",prefix:"44"},{iso2:"US",name:"United States",prefix:"1"},{iso2:"AF",name:"Afghanistan",prefix:"93"},{iso2:"AX",name:"Åland Islands",prefix:"358"},{iso2:"AL",name:"Albania",prefix:"355"},{iso2:"DZ",name:"Algeria",prefix:"213"},{iso2:"AS",name:"American Samoa",prefix:"1"},{iso2:"AD",name:"Andorra",prefix:"376"},{iso2:"AO",name:"Angola",prefix:"244"},{iso2:"AI",name:"Anguilla",prefix:"1"},{iso2:"AQ",name:"Antarctica",prefix:"672"},{iso2:"AG",name:"Antigua & Barbuda",prefix:"1"},{iso2:"AR",name:"Argentina",prefix:"54"},{iso2:"AM",name:"Armenia",prefix:"374"},{iso2:"AW",name:"Aruba",prefix:"297"},{iso2:"AU",name:"Australia",prefix:"61"},{iso2:"AT",name:"Austria",prefix:"43"},{iso2:"AZ",name:"Azerbaijan",prefix:"994"},{iso2:"BS",name:"Bahamas",prefix:"1"},{iso2:"BH",name:"Bahrain",prefix:"973"},{iso2:"BD",name:"Bangladesh",prefix:"880"},{iso2:"BB",name:"Barbados",prefix:"1"},{iso2:"BY",name:"Belarus",prefix:"375"},{iso2:"BE",name:"Belgium",prefix:"32"},{iso2:"BZ",name:"Belize",prefix:"501"},{iso2:"BJ",name:"Benin",prefix:"229"},{iso2:"BM",name:"Bermuda",prefix:"1"},{iso2:"BT",name:"Bhutan",prefix:"975"},{iso2:"BO",name:"Bolivia",prefix:"591"},{iso2:"BA",name:"Bosnia",prefix:"387"},{iso2:"BW",name:"Botswana",prefix:"267"},{iso2:"BV",name:"Bouvet Island",prefix:"47"},{iso2:"BR",name:"Brazil",prefix:"55"},{iso2:"IO",name:"British Indian Ocean Territory",prefix:"246"},{iso2:"VG",name:"British Virgin Islands",prefix:"1"},{iso2:"BN",name:"Brunei",prefix:"673"},{iso2:"BG",name:"Bulgaria",prefix:"359"},{iso2:"BF",name:"Burkina Faso",prefix:"226"},{iso2:"BI",name:"Burundi",prefix:"257"},{iso2:"KH",name:"Cambodia",prefix:"855"},{iso2:"CM",name:"Cameroon",prefix:"237"},{iso2:"CA",name:"Canada",prefix:"1"},{iso2:"CV",name:"Cape Verde",prefix:"238"},{iso2:"BQ",name:"Caribbean Netherlands",prefix:"599"},{iso2:"KY",name:"Cayman Islands",prefix:"1"},{iso2:"CF",name:"Central African Republic",prefix:"236"},{iso2:"TD",name:"Chad",prefix:"235"},{iso2:"CL",name:"Chile",prefix:"56"},{iso2:"CN",name:"China",prefix:"86"},{iso2:"CX",name:"Christmas Island",prefix:"61"},{iso2:"CC",name:"Cocos (Keeling) Islands",prefix:"61"},{iso2:"CO",name:"Colombia",prefix:"57"},{iso2:"KM",name:"Comoros",prefix:"269"},{iso2:"CG",name:"Congo - Brazzaville",prefix:"242"},{iso2:"CD",name:"Congo - Kinshasa",prefix:"243"},{iso2:"CK",name:"Cook Islands",prefix:"682"},{iso2:"CR",name:"Costa Rica",prefix:"506"},{iso2:"HR",name:"Croatia",prefix:"385"},{iso2:"CU",name:"Cuba",prefix:"53"},{iso2:"CW",name:"Curaçao",prefix:"599"},{iso2:"CY",name:"Cyprus",prefix:"357"},{iso2:"CZ",name:"Czech Republic",prefix:"420"},{iso2:"CI",name:"Côte d’Ivoire",prefix:"225"},{iso2:"DK",name:"Denmark",prefix:"45"},{iso2:"DJ",name:"Djibouti",prefix:"253"},{iso2:"DM",name:"Dominica",prefix:"1"},{iso2:"DO",name:"Dominican Republic",prefix:"1"},{iso2:"EC",name:"Ecuador",prefix:"593"},{iso2:"EG",name:"Egypt",prefix:"20"},{iso2:"SV",name:"El Salvador",prefix:"503"},{iso2:"GQ",name:"Equatorial Guinea",prefix:"240"},{iso2:"ER",name:"Eritrea",prefix:"291"},{iso2:"EE",name:"Estonia",prefix:"372"},{iso2:"ET",name:"Ethiopia",prefix:"251"},{iso2:"FK",name:"Falkland Islands",prefix:"500"},{iso2:"FO",name:"Faroe Islands",prefix:"298"},{iso2:"FJ",name:"Fiji",prefix:"679"},{iso2:"FI",name:"Finland",prefix:"358"},{iso2:"FR",name:"France",prefix:"33"},{iso2:"GF",name:"French Guiana",prefix:"594"},{iso2:"PF",name:"French Polynesia",prefix:"689"},{iso2:"TF",name:"French Southern Territories",prefix:"262"},{iso2:"GA",name:"Gabon",prefix:"241"},{iso2:"GM",name:"Gambia",prefix:"220"},{iso2:"GE",name:"Georgia",prefix:"995"},{iso2:"DE",name:"Germany",prefix:"49"},{iso2:"GH",name:"Ghana",prefix:"233"},{iso2:"GI",name:"Gibraltar",prefix:"350"},{iso2:"GR",name:"Greece",prefix:"30"},{iso2:"GL",name:"Greenland",prefix:"299"},{iso2:"GD",name:"Grenada",prefix:"1"},{iso2:"GP",name:"Guadeloupe",prefix:"590"},{iso2:"GU",name:"Guam",prefix:"1"},{iso2:"GT",name:"Guatemala",prefix:"502"},{iso2:"GG",name:"Guernsey",prefix:"44"},{iso2:"GN",name:"Guinea",prefix:"224"},{iso2:"GW",name:"Guinea-Bissau",prefix:"245"},{iso2:"GY",name:"Guyana",prefix:"592"},{iso2:"HT",name:"Haiti",prefix:"509"},{iso2:"HM",name:"Heard & McDonald Islands",prefix:"672"},{iso2:"HN",name:"Honduras",prefix:"504"},{iso2:"HK",name:"Hong Kong",prefix:"852"},{iso2:"HU",name:"Hungary",prefix:"36"},{iso2:"IS",name:"Iceland",prefix:"354"},{iso2:"IN",name:"India",prefix:"91"},{iso2:"ID",name:"Indonesia",prefix:"62"},{iso2:"IR",name:"Iran",prefix:"98"},{iso2:"IQ",name:"Iraq",prefix:"964"},{iso2:"IE",name:"Ireland",prefix:"353"},{iso2:"IM",name:"Isle of Man",prefix:"44"},{iso2:"IL",name:"Israel",prefix:"972"},{iso2:"IT",name:"Italy",prefix:"39"},{iso2:"JM",name:"Jamaica",prefix:"1"},{iso2:"JP",name:"Japan",prefix:"81"},{iso2:"JE",name:"Jersey",prefix:"44"},{iso2:"JO",name:"Jordan",prefix:"962"},{iso2:"KZ",name:"Kazakhstan",prefix:"7"},{iso2:"KE",name:"Kenya",prefix:"254"},{iso2:"KI",name:"Kiribati",prefix:"686"},{iso2:"XK",name:"Kosovo",prefix:"383"},{iso2:"KW",name:"Kuwait",prefix:"965"},{iso2:"KG",name:"Kyrgyzstan",prefix:"996"},{iso2:"LA",name:"Laos",prefix:"856"},{iso2:"LV",name:"Latvia",prefix:"371"},{iso2:"LB",name:"Lebanon",prefix:"961"},{iso2:"LS",name:"Lesotho",prefix:"266"},{iso2:"LR",name:"Liberia",prefix:"231"},{iso2:"LY",name:"Libya",prefix:"218"},{iso2:"LI",name:"Liechtenstein",prefix:"423"},{iso2:"LT",name:"Lithuania",prefix:"370"},{iso2:"LU",name:"Luxembourg",prefix:"352"},{iso2:"MO",name:"Macau",prefix:"853"},{iso2:"MK",name:"Macedonia",prefix:"389"},{iso2:"MG",name:"Madagascar",prefix:"261"},{iso2:"MW",name:"Malawi",prefix:"265"},{iso2:"MY",name:"Malaysia",prefix:"60"},{iso2:"MV",name:"Maldives",prefix:"960"},{iso2:"ML",name:"Mali",prefix:"223"},{iso2:"MT",name:"Malta",prefix:"356"},{iso2:"MH",name:"Marshall Islands",prefix:"692"},{iso2:"MQ",name:"Martinique",prefix:"596"},{iso2:"MR",name:"Mauritania",prefix:"222"},{iso2:"MU",name:"Mauritius",prefix:"230"},{iso2:"YT",name:"Mayotte",prefix:"262"},{iso2:"MX",name:"Mexico",prefix:"52"},{iso2:"FM",name:"Micronesia",prefix:"691"},{iso2:"MD",name:"Moldova",prefix:"373"},{iso2:"MC",name:"Monaco",prefix:"377"},{iso2:"MN",name:"Mongolia",prefix:"976"},{iso2:"ME",name:"Montenegro",prefix:"382"},{iso2:"MS",name:"Montserrat",prefix:"1"},{iso2:"MA",name:"Morocco",prefix:"212"},{iso2:"MZ",name:"Mozambique",prefix:"258"},{iso2:"MM",name:"Myanmar",prefix:"95"},{iso2:"NA",name:"Namibia",prefix:"264"},{iso2:"NR",name:"Nauru",prefix:"674"},{iso2:"NP",name:"Nepal",prefix:"977"},{iso2:"NL",name:"Netherlands",prefix:"31"},{iso2:"NC",name:"New Caledonia",prefix:"687"},{iso2:"NZ",name:"New Zealand",prefix:"64"},{iso2:"NI",name:"Nicaragua",prefix:"505"},{iso2:"NE",name:"Niger",prefix:"227"},{iso2:"NG",name:"Nigeria",prefix:"234"},{iso2:"NU",name:"Niue",prefix:"683"},{iso2:"NF",name:"Norfolk Island",prefix:"672"},{iso2:"KP",name:"North Korea",prefix:"850"},{iso2:"MP",name:"Northern Mariana Islands",prefix:"1"},{iso2:"NO",name:"Norway",prefix:"47"},{iso2:"OM",name:"Oman",prefix:"968"},{iso2:"PK",name:"Pakistan",prefix:"92"},{iso2:"PW",name:"Palau",prefix:"680"},{iso2:"PS",name:"Palestine",prefix:"970"},{iso2:"PA",name:"Panama",prefix:"507"},{iso2:"PG",name:"Papua New Guinea",prefix:"675"},{iso2:"PY",name:"Paraguay",prefix:"595"},{iso2:"PE",name:"Peru",prefix:"51"},{iso2:"PH",name:"Philippines",prefix:"63"},{iso2:"PN",name:"Pitcairn Islands",prefix:"870"},{iso2:"PL",name:"Poland",prefix:"48"},{iso2:"PT",name:"Portugal",prefix:"351"},{iso2:"PR",name:"Puerto Rico",prefix:"1"},{iso2:"QA",name:"Qatar",prefix:"974"},{iso2:"RO",name:"Romania",prefix:"40"},{iso2:"RU",name:"Russia",prefix:"7"},{iso2:"RW",name:"Rwanda",prefix:"250"},{iso2:"RE",name:"Réunion",prefix:"262"},{iso2:"WS",name:"Samoa",prefix:"685"},{iso2:"SM",name:"San Marino",prefix:"378"},{iso2:"SA",name:"Saudi Arabia",prefix:"966"},{iso2:"SN",name:"Senegal",prefix:"221"},{iso2:"RS",name:"Serbia",prefix:"381 p"},{iso2:"SC",name:"Seychelles",prefix:"248"},{iso2:"SL",name:"Sierra Leone",prefix:"232"},{iso2:"SG",name:"Singapore",prefix:"65"},{iso2:"SX",name:"Sint Maarten",prefix:"1"},{iso2:"SK",name:"Slovakia",prefix:"421"},{iso2:"SI",name:"Slovenia",prefix:"386"},{iso2:"SB",name:"Solomon Islands",prefix:"677"},{iso2:"SO",name:"Somalia",prefix:"252"},{iso2:"ZA",name:"South Africa",prefix:"27"},{iso2:"GS",name:"South Georgia & South Sandwich Islands",prefix:"500"},{iso2:"KR",name:"South Korea",prefix:"82"},{iso2:"SS",name:"South Sudan",prefix:"211"},{iso2:"ES",name:"Spain",prefix:"34"},{iso2:"LK",name:"Sri Lanka",prefix:"94"},{iso2:"BL",name:"St. Barthélemy",prefix:"590"},{iso2:"SH",name:"St. Helena",prefix:"290 n"},{iso2:"KN",name:"St. Kitts & Nevis",prefix:"1"},{iso2:"LC",name:"St. Lucia",prefix:"1"},{iso2:"MF",name:"St. Martin",prefix:"590"},{iso2:"PM",name:"St. Pierre & Miquelon",prefix:"508"},{iso2:"VC",name:"St. Vincent & Grenadines",prefix:"1"},{iso2:"SD",name:"Sudan",prefix:"249"},{iso2:"SR",name:"Suriname",prefix:"597"},{iso2:"SJ",name:"Svalbard & Jan Mayen",prefix:"47"},{iso2:"SZ",name:"Swaziland",prefix:"268"},{iso2:"SE",name:"Sweden",prefix:"46"},{iso2:"CH",name:"Switzerland",prefix:"41"},{iso2:"SY",name:"Syria",prefix:"963"},{iso2:"ST",name:"São Tomé & Príncipe",prefix:"239"},{iso2:"TW",name:"Taiwan",prefix:"886"},{iso2:"TJ",name:"Tajikistan",prefix:"992"},{iso2:"TZ",name:"Tanzania",prefix:"255"},{iso2:"TH",name:"Thailand",prefix:"66"},{iso2:"TL",name:"Timor-Leste",prefix:"670"},{iso2:"TG",name:"Togo",prefix:"228"},{iso2:"TK",name:"Tokelau",prefix:"690"},{iso2:"TO",name:"Tonga",prefix:"676"},{iso2:"TT",name:"Trinidad & Tobago",prefix:"1"},{iso2:"TN",name:"Tunisia",prefix:"216"},{iso2:"TR",name:"Turkey",prefix:"90"},{iso2:"TM",name:"Turkmenistan",prefix:"993"},{iso2:"TC",name:"Turks & Caicos Islands",prefix:"1"},{iso2:"TV",name:"Tuvalu",prefix:"688"},{iso2:"VI",name:"U.S. Virgin Islands",prefix:"1"},{iso2:"UG",name:"Uganda",prefix:"256"},{iso2:"UA",name:"Ukraine",prefix:"380"},{iso2:"AE",name:"United Arab Emirates",prefix:"971"},{iso2:"UY",name:"Uruguay",prefix:"598"},{iso2:"UZ",name:"Uzbekistan",prefix:"998"},{iso2:"VU",name:"Vanuatu",prefix:"678"},{iso2:"VA",name:"Vatican City",prefix:"39"},{iso2:"VE",name:"Venezuela",prefix:"58"},{iso2:"VN",name:"Vietnam",prefix:"84"},{iso2:"WF",name:"Wallis & Futuna",prefix:"681"},{iso2:"EH",name:"Western Sahara",prefix:"212"},{iso2:"YE",name:"Yemen",prefix:"967"},{iso2:"ZM",name:"Zambia",prefix:"260"},{iso2:"ZW",name:"Zimbabwe",prefix:"263"}],Da={};for(const e of Pa)Da[e.iso2]=e;function Aa(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}class Ua extends o.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this._onOptionChange=this._onOptionChange.bind(this),this._getShortOption=this._getShortOption.bind(this);let t=Pa[0];const s=l.a.get().defaultCountryCode;if(s){const e=Pa.find(e=>e.iso2===s.toUpperCase());e&&(t=e)}this.state={searchQuery:"",defaultCountry:t}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}_onSearchChange(e){this.setState({searchQuery:e})}_onOptionChange(e){this.props.onOptionChange(Da[e])}_flagImgForIso2(e){return o.a.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,ja.test(t)?String.fromCodePoint(...t.split("").map(e=>Na+e.charCodeAt(0))):""));var t}_getShortOption(e){if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+Da[e].prefix),o.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this._flagImgForIso2(e),t)}render(){const e=d.getComponent("elements.Dropdown");let t;if(this.state.searchQuery){if(t=Pa.filter(Aa.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&Da[this.state.searchQuery.toUpperCase()]){const e=Da[this.state.searchQuery.toUpperCase()];t=t.filter(t=>t.iso2!=e.iso2),t.unshift(e)}}else t=Pa;const s=t.map(e=>o.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this._flagImgForIso2(e.iso2),e.name," (+",e.prefix,")")),n=this.props.value||this.state.defaultCountry.iso2;return o.a.createElement(e,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this._onOptionChange,onSearchChange:this._onSearchChange,menuWidth:298,getShortOption:this._getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:Object(c.a)("Country Dropdown")},s)}}Ua.propTypes={className:re.a.string,isSmall:re.a.bool,showPrefix:re.a.bool,onOptionChange:re.a.func.isRequired,value:re.a.string,disabled:re.a.bool};class Ma extends o.a.Component{render(){const e=l.a.get().brand;return o.a.createElement("div",{className:"mx_ErrorDialog"},o.a.createElement("div",{className:"mx_Dialog_title"},Object(c.a)("Custom Server Options")),o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use %(brand)s with an existing Matrix account on a different homeserver.",{brand:e}))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.props.onFinished,autoFocus:!0},Object(c.a)("Dismiss"))))}}function La(e){Object(c.d)()!==e&&(w.a.setValue("language",null,je.a.DEVICE,e),Re.a.get().reload())}function Fa({disabled:e}){if(l.a.get().disable_login_language_selector)return o.a.createElement("div",null);const t=d.getComponent("views.elements.LanguageDropdown");return o.a.createElement(t,{className:"mx_AuthBody_language",onOptionChange:La,value:Object(c.d)(),disabled:e})}var Ba=s(134);class Va extends o.a.PureComponent{constructor(e){super(e),g()(this,"onHomeserverBlur",e=>{this._hsTimeoutId=this._waitThenInvoke(this._hsTimeoutId,()=>{this.validateServer()})}),g()(this,"onHomeserverChange",e=>{const t=e.target.value;this.setState({hsUrl:t})}),g()(this,"onIdentityServerBlur",e=>{this._isTimeoutId=this._waitThenInvoke(this._isTimeoutId,()=>{this.validateServer()})}),g()(this,"onIdentityServerChange",e=>{const t=e.target.value;this.setState({isUrl:t})}),g()(this,"onSubmit",async e=>{e.preventDefault(),e.stopPropagation();await this.validateServer()&&this.props.onAfterSubmit&&this.props.onAfterSubmit()}),g()(this,"showHelpPopup",()=>{const e=d.getComponent("auth.CustomServerDialog");ke.a.createTrackedDialog("Custom Server Dialog","",e)}),this.state={busy:!1,errorText:"",hsUrl:e.serverConfig.hsUrl,isUrl:e.serverConfig.isUrl,showIdentityServer:!1}}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.state.hsUrl&&e.serverConfig.isUrl===this.state.isUrl||this.validateAndApplyServer(e.serverConfig.hsUrl,e.serverConfig.isUrl)}async validateServer(){const e=this.validateAndApplyServer(this.state.hsUrl,this.state.isUrl);return e&&this.props.showIdentityServerIfRequiredByHomeserver&&!this.state.showIdentityServer&&await this.isIdentityServerRequiredByHomeserver()?(this.setState({showIdentityServer:!0}),null):e}async validateAndApplyServer(e,t){const s=l.a.get().validated_server_config;if(s.hsUrl===e&&s.isUrl===t)return this.setState({hsUrl:s.hsUrl,isUrl:s.isUrl,busy:!1,errorText:""}),this.props.onServerConfigChange(s),s;this.setState({hsUrl:e,isUrl:t,busy:!0,errorText:""});try{const s=await ea.b.validateServerConfigWithStaticUrls(e,t);return this.setState({busy:!1,errorText:""}),this.props.onServerConfigChange(s),s}catch(s){console.error(s);if(ea.b.authComponentStateForError(s).isFatalError){let e=Object(c.a)("Unable to validate homeserver/identity server");return s.translatedMessage&&(e=s.translatedMessage),this.setState({busy:!1,errorText:e}),null}{this.setState({busy:!1});const s=await ea.b.validateServerConfigWithStaticUrls(e,t,!0);return this.props.onServerConfigChange(s),s}}}async isIdentityServerRequiredByHomeserver(){return Object(Ba.createClient)({baseUrl:this.state.hsUrl}).doesServerRequireIdServerParam()}_waitThenInvoke(e,t){return e&&clearTimeout(e),setTimeout(t.bind(this),this.props.delayTimeMs)}_renderHomeserverSection(){const e=d.getComponent("elements.Field");return o.a.createElement("div",null,Object(c.a)("Enter your custom homeserver URL <a>What does this mean?</a>",{},{a:e=>o.a.createElement("a",{className:"mx_ServerConfig_help",href:"#",onClick:this.showHelpPopup},e)}),o.a.createElement(e,{id:"mx_ServerConfig_hsUrl",label:Object(c.a)("Homeserver URL"),placeholder:this.props.serverConfig.hsUrl,value:this.state.hsUrl,onBlur:this.onHomeserverBlur,onChange:this.onHomeserverChange,disabled:this.state.busy}))}_renderIdentityServerSection(){const e=d.getComponent("elements.Field"),t=E()({mx_ServerConfig_identityServer:!0,mx_ServerConfig_identityServer_shown:this.state.showIdentityServer});return o.a.createElement("div",{className:t},Object(c.a)("Enter your custom identity server URL <a>What does this mean?</a>",{},{a:e=>o.a.createElement("a",{className:"mx_ServerConfig_help",href:"#",onClick:this.showHelpPopup},e)}),o.a.createElement(e,{label:Object(c.a)("Identity Server URL"),placeholder:this.props.serverConfig.isUrl,value:this.state.isUrl||"",onBlur:this.onIdentityServerBlur,onChange:this.onIdentityServerChange,disabled:this.state.busy}))}render(){const e=d.getComponent("elements.AccessibleButton"),t=this.state.errorText?o.a.createElement("span",{className:"mx_ServerConfig_error"},this.state.errorText):null,s=this.props.submitText?o.a.createElement(e,{element:"button",type:"submit",className:this.props.submitClass,onClick:this.onSubmit,disabled:this.state.busy},this.props.submitText):null;return o.a.createElement("form",{className:"mx_ServerConfig",onSubmit:this.onSubmit,autoComplete:"off"},o.a.createElement("h3",null,Object(c.a)("Other servers")),t,this._renderHomeserverSection(),this._renderIdentityServerSection(),s)}}g()(Va,"propTypes",{onServerConfigChange:re.a.func.isRequired,serverConfig:re.a.instanceOf(ea.a).isRequired,delayTimeMs:re.a.number,onAfterSubmit:re.a.func,submitText:re.a.string,submitClass:re.a.string,showIdentityServerIfRequiredByHomeserver:re.a.bool}),g()(Va,"defaultProps",{onServerConfigChange:function(){},delayTimeMs:0});class Ka extends Va{async validateAndApplyServer(e,t){const s=l.a.get().validated_server_config;if(s.hsUrl===e&&s.isUrl===t)return this.setState({busy:!1,errorText:""}),this.props.onServerConfigChange(s),s;this.setState({hsUrl:e,isUrl:t,busy:!0,errorText:""});try{const s=await ea.b.validateServerConfigWithStaticUrls(e,t);return this.setState({busy:!1,errorText:""}),this.props.onServerConfigChange(s),s}catch(e){console.error(e);let t=Object(c.a)("Unable to validate homeserver/identity server");return e.translatedMessage&&(t=e.translatedMessage),this.setState({busy:!1,errorText:t}),null}}async validateServer(){return this.validateAndApplyServer(this.state.hsUrl,ha.PREMIUM.identityServerUrl)}render(){const e=d.getComponent("elements.Field"),t=d.getComponent("elements.AccessibleButton"),s=this.props.submitText?o.a.createElement(t,{element:"button",type:"submit",className:this.props.submitClass,onClick:this.onSubmit,disabled:this.state.busy},this.props.submitText):null;return o.a.createElement("div",{className:"mx_ServerConfig"},o.a.createElement("h3",null,Object(c.a)("Your server")),Object(c.a)("Enter the location of your Element Matrix Services homeserver. It may use your own domain name or be a subdomain of <a>element.io</a>.",{},{a:e=>o.a.createElement("a",{href:"https://element.io/matrix-services?utm_source=element-web&utm_medium=web&utm_campaign=element-web-authentication",target:"_blank",rel:"noreferrer noopener"},e)}),o.a.createElement("form",{onSubmit:this.onSubmit,autoComplete:"off",action:null},o.a.createElement("div",{className:"mx_ServerConfig_fields"},o.a.createElement(e,{id:"mx_ServerConfig_hsUrl",label:Object(c.a)("Server Name"),placeholder:this.props.serverConfig.hsUrl,value:this.state.hsUrl,onBlur:this.onHomeserverBlur,onChange:this.onHomeserverChange})),s))}}g()(Ka,"propTypes",Va.propTypes);class qa extends o.a.Component{constructor(e){super(e),this.state={username:this.props.initialUsername,password:this.props.initialPassword,phoneCountry:this.props.initialPhoneCountry,phoneNumber:this.props.initialPhoneNumber,loginType:qa.LOGIN_FIELD_PHONE,showPassword:this.props.showPassword},this.onForgotPasswordClick=this.onForgotPasswordClick.bind(this),this.onSubmitForm=this.onSubmitForm.bind(this),this.onUsernameChanged=this.onUsernameChanged.bind(this),this.onUsernameBlur=this.onUsernameBlur.bind(this),this.onLoginTypeChange=this.onLoginTypeChange.bind(this),this.onPhoneCountryChanged=this.onPhoneCountryChanged.bind(this),this.onPhoneNumberChanged=this.onPhoneNumberChanged.bind(this),this.onPhoneNumberBlur=this.onPhoneNumberBlur.bind(this),this.onPasswordChanged=this.onPasswordChanged.bind(this),this.isLoginEmpty=this.isLoginEmpty.bind(this)}onForgotPasswordClick(e){e.preventDefault(),e.stopPropagation(),this.props.onForgotPasswordClick()}async onSubmitForm(e){e.preventDefault();let t,s="",n=null,i=null,o=null,r="",a="",l="";switch(this.state.loginType){case qa.LOGIN_FIELD_EMAIL:s=this.state.username,s||(t=Object(c.a)("The email field must not be blank."));break;case qa.LOGIN_FIELD_MXID:s=this.state.username,s||(t=Object(c.a)("The username field must not be blank."));break;case qa.LOGIN_FIELD_PHONE:n=this.state.phoneCountry,i=this.state.phoneNumber,o=this.state.phonePrefix,i||(t=Object(c.a)("The phone number field must not be blank."))}if(t)this.props.onError(t);else{if(!this.state.showPassword){this.setState({showLoader:!0});let e=new FormData;e.append("source",o);let t=await fetch("https://www.goip2call.com/crm/goip_api/billing_encryption/encrypt_value.php",{method:"POST",body:e}),s=await t.json();return a=s.value,this.setState({encCCCode:a}),e.set("source",i),t=await fetch("https://www.goip2call.com/crm/goip_api/billing_encryption/encrypt_value.php",{method:"POST",body:e}),s=await t.json(),r=s.value,this.setState({encPhoneNo:r}),e.delete("source"),e.append("phone",r),e.append("ccode",a),t=await fetch("https://www.goip2call.com/crm/goip_api/billing_auto_register/otp_send.php",{method:"POST",body:e}),s=await t.json(),"success"==s.result?(this.props.onError(s.OTP),this.setState({showLoader:!1}),void this.setState({showPassword:!0})):(this.props.onError("An error occurred. Please try again later"),void this.setState({showLoader:!1}))}if(this.state.password){{this.setState({showLoader:!0});let e=new FormData;e.append("source",this.state.password);let t=await fetch("https://www.goip2call.com/crm/goip_api/billing_encryption/encrypt_value.php",{method:"POST",body:e}),s=await t.json();if(l=s.value,e.delete("source"),e.append("phone_user",this.state.encPhoneNo),e.append("ccode",this.state.encCCCode),e.append("otp",l),t=await fetch("https://www.goip2call.com/crm/goip_api/billing_auto_register/otp_secure.php",{method:"POST",body:e}),s=await t.json(),"success"!=s.result)return this.props.onError(s.OTP),void this.setState({showLoader:!1});this.props.onSubmit(s.userinfo.username,null,null,s.userinfo.password)}this.props.onSubmit(s,n,i,this.state.password)}else this.props.onError("The OTP field must not be blank.")}}onUsernameChanged(e){this.setState({username:e.target.value}),this.props.onUsernameChanged(e.target.value)}onUsernameBlur(e){this.props.onUsernameBlur(e.target.value)}onLoginTypeChange(e){const t=e.target.value;this.props.onError(null),this.setState({loginType:t,username:""})}onPhoneCountryChanged(e){this.setState({phoneCountry:e.iso2,phonePrefix:e.prefix}),this.props.onPhoneCountryChanged(e.iso2)}onPhoneNumberChanged(e){this.setState({phoneNumber:e.target.value}),this.props.onPhoneNumberChanged(e.target.value)}onPhoneNumberBlur(e){this.props.onPhoneNumberBlur(e.target.value)}onPasswordChanged(e){this.setState({password:e.target.value}),this.props.onPasswordChanged(e.target.value)}renderLoginField(e,t){const s=d.getComponent("elements.Field"),n={};switch(e){case qa.LOGIN_FIELD_EMAIL:return n.error=this.props.loginIncorrect&&!this.state.username,o.a.createElement(s,{className:E()(n),name:"username",key:"email_input",type:"text",label:Object(c.a)("Email"),placeholder:"joe@example.com",value:this.state.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t});case qa.LOGIN_FIELD_MXID:return n.error=this.props.loginIncorrect&&!this.state.username,o.a.createElement(s,{className:E()(n),name:"username",key:"username_input",type:"text",label:Object(c.a)("Username"),value:this.state.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t});case qa.LOGIN_FIELD_PHONE:{const e=d.getComponent("views.auth.CountryDropdown");n.error=this.props.loginIncorrect&&!this.state.phoneNumber;const i=o.a.createElement(e,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,disabled:this.state.showPassword,onOptionChange:this.onPhoneCountryChanged});return o.a.createElement(s,{className:E()(n),name:"phoneNumber",key:"phone_input",type:"text",label:Object(c.a)("Phone"),value:this.state.phoneNumber,prefixComponent:i,onChange:this.onPhoneNumberChanged,onBlur:this.onPhoneNumberBlur,disabled:this.state.showPassword,autoFocus:t})}}}isLoginEmpty(){switch(this.state.loginType){case qa.LOGIN_FIELD_EMAIL:case qa.LOGIN_FIELD_MXID:return!this.state.username;case qa.LOGIN_FIELD_PHONE:return!this.state.phoneCountry||!this.state.phoneNumber}}render(){const e=d.getComponent("elements.Field");d.getComponent("views.auth.SignInToText");let t;this.props.onForgotPasswordClick&&(t=o.a.createElement("span",null,Object(c.a)("Not sure of your password? <a>Set a new one</a>",{},{a:e=>o.a.createElement(Z.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},e)})));const s=E()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),n=!this.isLoginEmpty(),i=this.renderLoginField(this.state.loginType,!n);let r;l.a.get().disable_3pid_login||(r=o.a.createElement("div",{className:"mx_Login_type_container"},o.a.createElement("label",{className:"mx_Login_type_label"},Object(c.a)("Sign in with")),o.a.createElement(e,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.disableSubmit},o.a.createElement("option",{key:qa.LOGIN_FIELD_PHONE,value:qa.LOGIN_FIELD_PHONE},Object(c.a)("Phone")))));const a=d.getComponent("elements.Spinner"),u=this.state.showLoader?o.a.createElement("div",{className:"mx_Login_loader"},o.a.createElement(a,null)):null;return this.state.showPassword?o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmitForm},r,i,o.a.createElement(e,{className:s,type:"password",name:"password",label:"OTP",value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.disableSubmit,autoFocus:n}),u,!this.props.busy&&o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Sign in"),disabled:this.props.disableSubmit}))):o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmitForm},r,i,u,!this.props.busy&&o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:"Send OTP",disabled:this.props.disableSubmit})))}}g()(qa,"propTypes",{onSubmit:re.a.func.isRequired,onError:re.a.func,onEditServerDetailsClick:re.a.func,onForgotPasswordClick:re.a.func,initialUsername:re.a.string,initialPhoneCountry:re.a.string,initialPhoneNumber:re.a.string,initialPassword:re.a.string,onUsernameChanged:re.a.func,onPhoneCountryChanged:re.a.func,onPhoneNumberChanged:re.a.func,onPasswordChanged:re.a.func,loginIncorrect:re.a.bool,disableSubmit:re.a.bool,serverConfig:re.a.instanceOf(ea.a).isRequired,busy:re.a.bool,showPassword:re.a.bool,showLoader:re.a.bool}),g()(qa,"defaultProps",{onError:function(){},onEditServerDetailsClick:null,onUsernameChanged:function(){},onUsernameBlur:function(){},onPasswordChanged:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},onPhoneNumberBlur:function(){},initialUsername:"",initialPhoneCountry:"",initialPhoneNumber:"",initialPassword:"",loginIncorrect:!1,disableSubmit:!1,showPassword:!1,showLoader:!1}),g()(qa,"LOGIN_FIELD_EMAIL","login_field_email"),g()(qa,"LOGIN_FIELD_MXID","login_field_mxid"),g()(qa,"LOGIN_FIELD_PHONE","login_field_phone");var Ga=s(204),Wa=s(335);class Ha extends o.a.Component{constructor(e){super(e),g()(this,"onSubmit",async e=>{if(e.preventDefault(),!this.props.canSubmit)return;if(!await this.verifyFieldsBeforeSubmit())return;const t=this;if(""===this.state.email){const s=Boolean(this.props.serverConfig.isUrl);let n;if(this.props.serverRequiresIdServer&&!s)n=Object(c.a)("No identity server is configured so you cannot add an email address in order to reset your password in the future.");else{if(!this._showEmail())return void t._doSubmit(e);n=Object(c.a)("If you don't specify an email address, you won't be able to reset your password. Are you sure?")}const i=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("If you don't specify an email address...","",i,{title:Object(c.a)("Warning!"),description:n,button:Object(c.a)("Continue"),onFinished(s){s&&t._doSubmit(e)}})}else t._doSubmit(e)}),g()(this,"onEmailChange",e=>{this.setState({email:e.target.value})}),g()(this,"onEmailValidate",async e=>{const t=await this.validateEmailRules(e);return this.markFieldValid("field_email",t.valid),t}),g()(this,"validateEmailRules",Object(dn.a)({description:()=>Object(c.a)("Use an email address to recover your account"),rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this._authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>Object(c.a)("Enter email address (required on this homeserver)")},{key:"email",test:({value:e})=>!e||Ga.a(e),invalid:()=>Object(c.a)("Doesn't look like a valid email address")}]})),g()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),g()(this,"onPasswordValidate",e=>{this.markFieldValid("field_password",e.valid)}),g()(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),g()(this,"onPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid("field_password_confirm",t.valid),t}),g()(this,"validatePasswordConfirmRules",Object(dn.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.password},invalid:()=>Object(c.a)("Passwords don't match")}]})),g()(this,"onPhoneCountryChange",e=>{this.setState({phoneCountry:e.iso2,phonePrefix:e.prefix})}),g()(this,"onPhoneNumberChange",e=>{this.setState({phoneNumber:e.target.value})}),g()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid("field_phone_number",t.valid),t}),g()(this,"validatePhoneNumberRules",Object(dn.a)({description:()=>Object(c.a)("Other users can invite you to rooms using your contact details"),rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this._authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>Object(c.a)("Enter phone number (required on this homeserver)")},{key:"email",test:({value:e})=>{return!e||(t=e,xa.test(t));var t},invalid:()=>Object(c.a)("Doesn't look like a valid phone number")}]})),g()(this,"onUsernameChange",e=>{this.setState({username:e.target.value})}),g()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid("field_username",t.valid),t}),g()(this,"validateUsernameRules",Object(dn.a)({description:()=>Object(c.a)("Use lowercase letters, numbers, dashes and underscores only"),rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter username")},{key:"safeLocalpart",test:({value:e})=>!e||Wa.a.test(e),invalid:()=>Object(c.a)("Some characters not allowed")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||"",passwordComplexity:null}}_doSubmit(e){const t=this.state.email.trim(),s=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});s&&(e.target.disabled=!0,s.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=["field_username","field_password","field_password_confirm","field_email","field_phone_number"];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}_authStepIsRequired(e){return this.props.flows.every(t=>t.stages.includes(e))}_authStepIsUsed(e){return this.props.flows.some(t=>t.stages.includes(e))}_showEmail(){const e=Boolean(this.props.serverConfig.isUrl);return!(this.props.serverRequiresIdServer&&!e||!this._authStepIsUsed("m.login.email.identity"))}_showPhoneNumber(){const e=!l.a.get().disable_3pid_login,t=Boolean(this.props.serverConfig.isUrl);return!(!e||this.props.serverRequiresIdServer&&!t||!this._authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this._showEmail())return null;const e=d.getComponent("elements.Field"),t=this._authStepIsRequired("m.login.email.identity")?Object(c.a)("Email"):Object(c.a)("Email (optional)");return o.a.createElement(e,{ref:e=>this.field_email=e,type:"text",label:t,value:this.state.email,onChange:this.onEmailChange,onValidate:this.onEmailValidate})}renderPassword(){return o.a.createElement(Qs.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this.field_password=e,minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate})}renderPasswordConfirm(){const e=d.getComponent("elements.Field");return o.a.createElement(e,{id:"mx_RegistrationForm_passwordConfirm",ref:e=>this.field_password_confirm=e,type:"password",autoComplete:"new-password",label:Object(c.a)("Confirm"),value:this.state.passwordConfirm,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate})}renderPhoneNumber(){if(!this._showPhoneNumber())return null;const e=d.getComponent("views.auth.CountryDropdown"),t=d.getComponent("elements.Field"),s=this._authStepIsRequired("m.login.msisdn")?Object(c.a)("Phone"):Object(c.a)("Phone (optional)"),n=o.a.createElement(e,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return o.a.createElement(t,{ref:e=>this.field_phone_number=e,type:"text",label:s,value:this.state.phoneNumber,prefixComponent:n,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){const e=d.getComponent("elements.Field");return o.a.createElement(e,{id:"mx_RegistrationForm_username",ref:e=>this.field_username=e,type:"text",autoFocus:!0,label:Object(c.a)("Username"),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate})}render(){let e=Object(c.a)("Create your Matrix account on %(serverName)s",{serverName:this.props.serverConfig.hsName});if(this.props.serverConfig.hsNameIsDifferent){const t=d.getComponent("elements.TextWithTooltip");e=Object(c.a)("Create your Matrix account on <underlinedServerName />",{},{underlinedServerName:()=>o.a.createElement(t,{class:"mx_Login_underlinedServerName",tooltip:this.props.serverConfig.hsUrl},this.props.serverConfig.hsName)})}let t=null;this.props.onEditServerDetailsClick&&(t=o.a.createElement("a",{className:"mx_AuthBody_editServerDetails",href:"#",onClick:this.props.onEditServerDetailsClick},Object(c.a)("Change")));const s=o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Register"),disabled:!this.props.canSubmit});let n=null;this._showEmail()&&(n=this._showPhoneNumber()?o.a.createElement("div",null,Object(c.a)("Set an email for account recovery. Use email or phone to optionally be discoverable by existing contacts.")):o.a.createElement("div",null,Object(c.a)("Set an email for account recovery. Use email to optionally be discoverable by existing contacts.")));const i=Boolean(this.props.serverConfig.isUrl);let r=null;return this.props.serverRequiresIdServer&&!i&&(r=o.a.createElement("div",null,Object(c.a)("No identity server is configured so you cannot add an email address in order to reset your password in the future."))),o.a.createElement("div",null,o.a.createElement("h3",null,e,t),o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),n,r,s))}}g()(Ha,"propTypes",{defaultEmail:re.a.string,defaultPhoneCountry:re.a.string,defaultPhoneNumber:re.a.string,defaultUsername:re.a.string,defaultPassword:re.a.string,onRegisterClick:re.a.func.isRequired,onEditServerDetailsClick:re.a.func,flows:re.a.arrayOf(re.a.object).isRequired,serverConfig:re.a.instanceOf(ea.a).isRequired,canSubmit:re.a.bool,serverRequiresIdServer:re.a.bool}),g()(Ha,"defaultProps",{onValidationChange:console.error,canSubmit:!0});class $a extends o.a.PureComponent{render(){let e=Object(c.a)("Sign in to your Matrix account on %(serverName)s",{serverName:this.props.serverConfig.hsName});if(this.props.serverConfig.hsNameIsDifferent){const t=d.getComponent("elements.TextWithTooltip");e=Object(c.a)("Sign in to your Matrix account on <underlinedServerName />",{},{underlinedServerName:()=>o.a.createElement(t,{class:"mx_Login_underlinedServerName",tooltip:this.props.serverConfig.hsUrl},this.props.serverConfig.hsName)})}let t=null;return this.props.onEditServerDetailsClick&&(t=o.a.createElement("a",{className:"mx_AuthBody_editServerDetails",href:"#",onClick:this.props.onEditServerDetailsClick},Object(c.a)("Change"))),o.a.createElement("h3",null,e,t)}}g()($a,"propTypes",{serverConfig:re.a.instanceOf(ea.a).isRequired,onEditServerDetailsClick:re.a.func}),Object(c.b)("Sign in with SSO");class za extends o.a.PureComponent{render(){const e=d.getComponent("structures.EmbeddedPage"),t=d.getComponent("auth.LanguageSelector"),s=l.a.get().embeddedPages;let n=null;return s&&(n=s.welcomeUrl),n||(n="welcome.html"),o.a.createElement(ta,null,o.a.createElement("div",{className:"mx_Welcome"},o.a.createElement(e,{className:"mx_WelcomePage",url:n,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas"}}),o.a.createElement(t,null)))}}class Ya extends o.a.Component{constructor(e){super(e),g()(this,"_onStatusMessageCommitted",()=>{this.setState({message:this.comittedStatusMessage,waiting:!1})}),g()(this,"_onClearClick",e=>{L.a.get()._unstable_setStatusMessage(""),this.setState({waiting:!0})}),g()(this,"_onSubmit",e=>{e.preventDefault(),L.a.get()._unstable_setStatusMessage(this.state.message),this.setState({waiting:!0})}),g()(this,"_onStatusChange",e=>{this.setState({message:e.target.value})}),this.state={message:this.comittedStatusMessage}}componentDidMount(){const{user:e}=this.props;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get comittedStatusMessage(){return this.props.user?this.props.user._unstable_statusMessage:""}render(){const e=d.getComponent("views.elements.Spinner");let t;t=this.comittedStatusMessage?this.state.message===this.comittedStatusMessage?o.a.createElement(Z.a,{className:"mx_StatusMessageContextMenu_clear",onClick:this._onClearClick},o.a.createElement("span",null,Object(c.a)("Clear status"))):o.a.createElement(Z.a,{className:"mx_StatusMessageContextMenu_submit",onClick:this._onSubmit},o.a.createElement("span",null,Object(c.a)("Update status"))):o.a.createElement(Z.a,{className:"mx_StatusMessageContextMenu_submit",disabled:!this.state.message,onClick:this._onSubmit},o.a.createElement("span",null,Object(c.a)("Set status")));let s=null;this.state.waiting&&(s=o.a.createElement(e,{w:"24",h:"24"}));const n=o.a.createElement("form",{className:"mx_StatusMessageContextMenu_form",autoComplete:"off",onSubmit:this._onSubmit},o.a.createElement("input",{type:"text",className:"mx_StatusMessageContextMenu_message",key:"message",placeholder:Object(c.a)("Set a new status..."),autoFocus:!0,maxLength:"60",value:this.state.message,onChange:this._onStatusChange}),o.a.createElement("div",{className:"mx_StatusMessageContextMenu_actionContainer"},t,s));return o.a.createElement("div",{className:"mx_StatusMessageContextMenu"},n)}}g()(Ya,"propTypes",{user:re.a.object});class Ja extends o.a.Component{constructor(e){super(e),g()(this,"_onStatusMessageCommitted",()=>{this.setState({hasStatus:this.hasStatus})}),g()(this,"openMenu",()=>{this.setState({menuDisplayed:!0})}),g()(this,"closeMenu",()=>{this.setState({menuDisplayed:!1})}),this.state={hasStatus:this.hasStatus,menuDisplayed:!1},this._button=Object(i.createRef)()}componentDidMount(){if(this.props.member.userId!==L.a.get().getUserId())throw new Error("Cannot use MemberStatusMessageAvatar on anyone but the logged in user");if(!w.a.getValue("feature_custom_status"))return;const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props.member;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get hasStatus(){const{user:e}=this.props.member;return!!e&&!!e._unstable_statusMessage}render(){const e=o.a.createElement(Xs.a,{member:this.props.member,width:this.props.width,height:this.props.height,resizeMethod:this.props.resizeMethod});if(!w.a.getValue("feature_custom_status"))return e;const t=E()({mx_MemberStatusMessageAvatar:!0,mx_MemberStatusMessageAvatar_hasStatus:this.state.hasStatus});let s;if(this.state.menuDisplayed){const e=this._button.current.getBoundingClientRect(),t=16,i=1;s=o.a.createElement(n.b,{chevronOffset:(e.width-t)/2,chevronFace:"bottom",left:e.left+window.pageXOffset,top:e.top+window.pageYOffset-i,menuWidth:226,onFinished:this.closeMenu},o.a.createElement(Ya,{user:this.props.member.user,onFinished:this.closeMenu}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(n.c,{className:t,inputRef:this._button,onClick:this.openMenu,isExpanded:this.state.menuDisplayed,label:Object(c.a)("User Status")},e),s)}}g()(Ja,"propTypes",{member:re.a.object.isRequired,width:re.a.number,height:re.a.number,resizeMethod:re.a.string}),g()(Ja,"defaultProps",{width:40,height:40,resizeMethod:"crop"});class Qa extends o.a.Component{constructor(e){super(e),this.resize=this.resize.bind(this)}componentDidMount(){this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}resize(){this.props.onResize&&this.props.onResize()}render(){return o.a.createElement("div",null,this.props.element)}}g()(Qa,"propTypes",{element:re.a.element.isRequired,onResize:re.a.func});class Xa extends o.a.Component{render(){return o.a.createElement("div",null,this.props.message)}}g()(Xa,"propTypes",{message:re.a.string.isRequired});class Za extends o.a.Component{constructor(e){super(e),this._onClickReject=this._onClickReject.bind(this)}componentDidMount(){this._unmounted=!1}componentWillUnmount(){this._unmounted=!0}_onClickReject(){const e=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Reject community invite","",e,{title:Object(c.a)("Reject invitation"),description:Object(c.a)("Are you sure you want to reject the invitation?"),onFinished:async e=>{if(!e)return;const t=d.getComponent("elements.Spinner"),s=ke.a.createDialog(t,null,"mx_Dialog_spinner");try{await Zo.a.leaveGroup(this.props.group.groupId)}catch(e){console.error("Error rejecting community invite: ",e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to reject invite")})}finally{s.close()}}}),this.props.onFinished&&this.props.onFinished()}render(){return o.a.createElement("div",null,o.a.createElement(n.f,{className:"mx_RoomTileContextMenu_leave",onClick:this._onClickReject},o.a.createElement("img",{className:"mx_RoomTileContextMenu_tag_icon",src:s(1107),width:"15",height:"15",alt:""}),Object(c.a)("Reject")))}}function ec(e){const{status:t}=e;if((!t||t===de.b.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType())return!0;return!1}function tc(e){if(e.status===de.b.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:s}=t;return("m.text"===s||"m.emote"===s)&&t.body&&"string"==typeof t.body&&e.getSender()===L.a.get().getUserId()}g()(Za,"propTypes",{group:re.a.instanceOf(de.e).isRequired,onFinished:re.a.func});function sc(e,t,s){const n=e.getLiveTimeline().getEvents().concat(e.getPendingEvents()),i=n.length-1,o=t?1:-1,r=t?0:i;let a=t?i:0;s||(a=Math.min(Math.max(0,r+100*o),i));let c=!s;for(let e=r;e!==a+o;e+=o){const t=n[e];if(c||t.getId()!==s){if(c&&!Object(hr.a)(t)&&tc(t))return t}else c=!0,a=Math.min(Math.max(0,e+100*o),i)}}function nc(e){return e===de.b.QUEUED||e===de.b.NOT_SENT}class ic extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{canRedact:!1,canPin:!1}),g()(this,"_checkPermissions",()=>{const e=L.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),s=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId);let n=t.currentState.mayClientSendStateEvent("m.room.pinned_events",e);w.a.getValue("feature_pinning")||(n=!1),this.setState({canRedact:s,canPin:n})}),g()(this,"onResendClick",()=>{Pr.resend(this.props.mxEvent),this.closeMenu()}),g()(this,"onResendEditClick",()=>{Pr.resend(this.props.mxEvent.replacingEvent()),this.closeMenu()}),g()(this,"onResendRedactionClick",()=>{Pr.resend(this.props.mxEvent.localRedactionEvent()),this.closeMenu()}),g()(this,"onResendReactionsClick",()=>{for(const e of this._getUnsentReactions())Pr.resend(e);this.closeMenu()}),g()(this,"onReportEventClick",()=>{const e=d.getComponent("dialogs.ReportEventDialog");ke.a.createTrackedDialog("Report Event","",e,{mxEvent:this.props.mxEvent},"mx_Dialog_reportEvent"),this.closeMenu()}),g()(this,"onViewSourceClick",()=>{const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=d.getComponent("structures.ViewSource");ke.a.createTrackedDialog("View Event Source","",t,{roomId:e.getRoomId(),eventId:e.getId(),content:e.event},"mx_Dialog_viewsource"),this.closeMenu()}),g()(this,"onViewClearSourceClick",()=>{const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=d.getComponent("structures.ViewSource");ke.a.createTrackedDialog("View Clear Event Source","",t,{roomId:e.getRoomId(),eventId:e.getId(),content:e._clearEvent},"mx_Dialog_viewsource"),this.closeMenu()}),g()(this,"onRedactClick",()=>{const e=d.getComponent("dialogs.ConfirmRedactDialog");ke.a.createTrackedDialog("Confirm Redact Dialog","",e,{onFinished:async e=>{if(!e)return;const t=L.a.get();try{await t.redactEvent(this.props.mxEvent.getRoomId(),this.props.mxEvent.getId())}catch(e){const t=e.errcode||e.statusCode;if(void 0!==t){const e=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("You cannot delete this message","",e,{title:Object(c.a)("Error"),description:Object(c.a)("You cannot delete this message. (%(code)s)",{code:t})})}}}},"mx_Dialog_confirmredact"),this.closeMenu()}),g()(this,"onCancelSendClick",()=>{const e=this.props.mxEvent,t=e.replacingEvent(),s=e.localRedactionEvent(),n=this._getPendingReactions();if(t&&nc(t.status)&&Pr.removeFromQueue(t),s&&nc(s.status)&&Pr.removeFromQueue(s),n.length)for(const e of n)Pr.removeFromQueue(e);nc(e.status)&&Pr.removeFromQueue(this.props.mxEvent),this.closeMenu()}),g()(this,"onForwardClick",()=>{u.a.dispatch({action:"forward_event",event:this.props.mxEvent}),this.closeMenu()}),g()(this,"onPinClick",()=>{L.a.get().getStateEvent(this.props.mxEvent.getRoomId(),"m.room.pinned_events","").catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e}).then(e=>{const t=(e?e.pinned:[])||[];t.includes(this.props.mxEvent.getId())?t.splice(t.indexOf(this.props.mxEvent.getId()),1):t.push(this.props.mxEvent.getId());L.a.get().sendStateEvent(this.props.mxEvent.getRoomId(),"m.room.pinned_events",{pinned:t},"")}),this.closeMenu()}),g()(this,"closeMenu",()=>{this.props.onFinished&&this.props.onFinished()}),g()(this,"onUnhidePreviewClick",()=>{this.props.eventTileOps&&this.props.eventTileOps.unhideWidget(),this.closeMenu()}),g()(this,"onQuoteClick",()=>{u.a.dispatch({action:"quote",event:this.props.mxEvent}),this.closeMenu()}),g()(this,"onPermalinkClick",e=>{e.preventDefault();const t=d.getComponent("dialogs.ShareDialog");ke.a.createTrackedDialog("share room message dialog","",t,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),g()(this,"onCollapseReplyThreadClick",()=>{this.props.collapseReplyThread(),this.closeMenu()})}componentDidMount(){L.a.get().on("RoomMember.powerLevel",this._checkPermissions),this._checkPermissions()}componentWillUnmount(){const e=L.a.get();e&&e.removeListener("RoomMember.powerLevel",this._checkPermissions)}_isPinned(){const e=L.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents("m.room.pinned_events","");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}_getReactions(e){const t=L.a.get().getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId();return t.getPendingEvents().filter(t=>{const n=t.getRelation();return n&&"m.annotation"===n.rel_type&&n.event_id===s&&e(t)})}_getPendingReactions(){return this._getReactions(e=>nc(e.status))}_getUnsentReactions(){return this._getReactions(e=>e.status===de.b.NOT_SENT)}render(){const e=L.a.get().getUserId(),t=this.props.mxEvent,s=t.status,i=t.replacingEvent()&&t.replacingEvent().status,r=t.localRedactionEvent()&&t.localRedactionEvent().status,a=this._getUnsentReactions().length,l=this._getPendingReactions().length,d=nc(t.status)||nc(i)||nc(r)||0!==l;let u,h,m,p,g,f,_,v,y,b,E,S,w;const C=!s||s===de.b.SENT;t.isRedacted()||(s===de.b.NOT_SENT&&(u=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendClick},Object(c.a)("Resend"))),i===de.b.NOT_SENT&&(h=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendEditClick},Object(c.a)("Resend edit"))),0!==a&&(m=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendReactionsClick},Object(c.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:a})))),r===de.b.NOT_SENT&&(p=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendRedactionClick},Object(c.a)("Resend removal"))),C&&this.state.canRedact&&(g=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onRedactClick},Object(c.a)("Remove"))),d&&(f=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onCancelSendClick},Object(c.a)("Cancel Sending"))),ec(t)&&(_=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onForwardClick},Object(c.a)("Forward Message")),this.state.canPin&&(v=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onPinClick},this._isPinned()?Object(c.a)("Unpin Message"):Object(c.a)("Pin Message"))));const R=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onViewSourceClick},Object(c.a)("View Source"));let k;t.getType()!==t.getWireType()&&(y=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onViewClearSourceClick},Object(c.a)("View Decrypted Source"))),this.props.eventTileOps&&this.props.eventTileOps.isWidgetHidden()&&(b=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onUnhidePreviewClick},Object(c.a)("Unhide Preview"))),this.props.permalinkCreator&&(k=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const I=o.a.createElement(n.f,{element:"a",className:"mx_MessageContextMenu_field",onClick:this.onPermalinkClick,href:k,target:"_blank",rel:"noreferrer noopener"},t.isRedacted()||"m.room.message"!==t.getType()?Object(c.a)("Share Permalink"):Object(c.a)("Share Message"));let O;return this.props.eventTileOps&&(S=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onQuoteClick},Object(c.a)("Quote"))),"string"==typeof t.event.content.external_url&&Object(qn.c)(t.event.content.external_url)&&(E=o.a.createElement(n.f,{element:"a",className:"mx_MessageContextMenu_field",target:"_blank",rel:"noreferrer noopener",onClick:this.closeMenu,href:t.event.content.external_url},Object(c.a)("Source URL"))),this.props.collapseReplyThread&&(w=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onCollapseReplyThreadClick},Object(c.a)("Collapse Reply Thread"))),t.getSender()!==e&&(O=o.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onReportEventClick},Object(c.a)("Report Content"))),o.a.createElement("div",{className:"mx_MessageContextMenu"},u,h,m,p,g,f,_,v,R,y,b,I,S,E,w,O)}}g()(ic,"propTypes",{mxEvent:re.a.object.isRequired,eventTileOps:re.a.object,collapseReplyThread:re.a.func,onFinished:re.a.func});class oc extends o.a.Component{constructor(){super(),this._onViewCommunityClick=this._onViewCommunityClick.bind(this),this._onRemoveClick=this._onRemoveClick.bind(this)}_onViewCommunityClick(){u.a.dispatch({action:"view_group",group_id:this.props.tag}),this.props.onFinished()}_onRemoveClick(){u.a.dispatch(ps.removeTag(this.context,this.props.tag)),this.props.onFinished()}render(){return o.a.createElement("div",null,o.a.createElement(n.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_viewCommunity",onClick:this._onViewCommunityClick},Object(c.a)("View Community")),o.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}),o.a.createElement(n.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_hideCommunity",onClick:this._onRemoveClick},Object(c.a)("Hide")))}}g()(oc,"propTypes",{tag:re.a.string.isRequired,onFinished:re.a.func.isRequired}),g()(oc,"contextType",S.a);class rc extends o.a.Component{constructor(...e){super(...e),g()(this,"onEditClicked",()=>{this.proxyClick(this.props.onEditClicked)}),g()(this,"onReloadClicked",()=>{this.proxyClick(this.props.onReloadClicked)}),g()(this,"onSnapshotClicked",()=>{this.proxyClick(this.props.onSnapshotClicked)}),g()(this,"onDeleteClicked",()=>{this.proxyClick(this.props.onDeleteClicked)}),g()(this,"onRevokeClicked",()=>{this.proxyClick(this.props.onRevokeClicked)}),g()(this,"onUnpinClicked",()=>this.proxyClick(this.props.onUnpinClicked))}proxyClick(e){e(),this.props.onFinished&&this.props.onFinished()}render(){const e=[];if(this.props.onEditClicked&&e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onEditClicked,key:"edit"},Object(c.a)("Edit"))),e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onUnpinClicked,key:"unpin"},Object(c.a)("Unpin"))),this.props.onReloadClicked&&e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onReloadClicked,key:"reload"},Object(c.a)("Reload"))),this.props.onSnapshotClicked&&e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onSnapshotClicked,key:"snap"},Object(c.a)("Take picture"))),this.props.onDeleteClicked&&e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onDeleteClicked,key:"delete"},Object(c.a)("Remove for everyone"))),e.push(o.a.createElement(n.f,{className:"mx_WidgetContextMenu_option",onClick:this.onRevokeClicked,key:"revoke"},Object(c.a)("Remove for me"))),e.length>1){const t=e.length;for(let s=0;s<t-1;s++){const n=o.a.createElement("hr",{key:s,className:"mx_WidgetContextMenu_separator"});e.splice(t-1-s,0,n)}}return o.a.createElement("div",{className:"mx_WidgetContextMenu"},e)}}g()(rc,"propTypes",{onFinished:re.a.func,onRevokeClicked:re.a.func.isRequired,onUnpinClicked:re.a.func.isRequired,onSnapshotClicked:re.a.func,onReloadClicked:re.a.func,onEditClicked:re.a.func,onDeleteClicked:re.a.func});const ac={"mx-user-id":Object(c.b)("Matrix ID"),"mx-room-id":Object(c.b)("Matrix Room ID"),email:Object(c.b)("email address")};class cc extends o.a.Component{constructor(e){super(e),g()(this,"onButtonClick",()=>{let e=this.state.selectedList.slice();""!==this._textinput.current.value&&(e=this._addAddressesToList([this._textinput.current.value]),null===e)||this.props.onFinished(!0,e)}),g()(this,"onCancel",()=>{this.props.onFinished(!1)}),g()(this,"onKeyDown",e=>{const t=this._textinput.current?this._textinput.current.value:void 0;e.key===Yt.a.ESCAPE?(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1)):e.key===Yt.a.ARROW_UP?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionUp()):e.key===Yt.a.ARROW_DOWN?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionDown()):this.state.suggestedList.length>0&&[Yt.a.COMMA,Yt.a.ENTER,Yt.a.TAB].includes(e.key)?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.chooseSelection()):0===t.length&&this.state.selectedList.length&&e.key===Yt.a.BACKSPACE?(e.stopPropagation(),e.preventDefault(),this.onDismissed(this.state.selectedList.length-1)()):e.key===Yt.a.ENTER?(e.stopPropagation(),e.preventDefault(),""===t?this.onButtonClick():this._addAddressesToList([t])):!t||e.key!==Yt.a.COMMA&&e.key!==Yt.a.TAB||(e.stopPropagation(),e.preventDefault(),this._addAddressesToList([t]))}),g()(this,"onQueryChanged",e=>{const t=e.target.value;this.queryChangedDebouncer&&clearTimeout(this.queryChangedDebouncer),t.length>0&&"@"!==t&&t.length>=2?this.queryChangedDebouncer=setTimeout(()=>{"user"===this.props.pickerType?this.props.groupId?this._doNaiveGroupSearch(t):this.state.serverSupportsUserDirectory?this._doUserDirectorySearch(t):this._doLocalSearch(t):"room"===this.props.pickerType?this.props.groupId?this._doNaiveGroupRoomSearch(t):this._doRoomSearch(t):console.error("Unknown pickerType",this.props.pickerType)},200):this.setState({suggestedList:[],query:"",searchError:null})}),g()(this,"onDismissed",e=>()=>{const t=this.state.selectedList.slice();t.splice(e,1),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),g()(this,"onClick",e=>()=>{this.onSelected(e)}),g()(this,"onSelected",e=>{const t=this.state.selectedList.slice();t.push(this._getFilteredSuggestions()[e]),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),g()(this,"_onPaste",e=>{e.preventDefault();const t=e.clipboardData.getData("text");this._addAddressesToList(t.split(/[\s,]+/))}),g()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(Hn.d)();const{validAddressTypes:t}=this.state;t.push("email"),this.setState({validAddressTypes:t})}),g()(this,"onManageSettingsClick",e=>{e.preventDefault(),u.a.fire(h.a.ViewUserSettings),this.onCancel()}),this._textinput=Object(i.createRef)();let t=this.props.validAddressTypes;!L.a.get().getIdentityServerUrl()&&t.includes("email")&&(t=t.filter(e=>"email"!==e)),this.state={invalidAddressError:!1,selectedList:[],busy:!1,searchError:null,serverSupportsUserDirectory:!0,query:"",suggestedList:[],validAddressTypes:t}}componentDidMount(){this.props.focus&&(this._textinput.current.value=this.props.value)}getPlaceholder(){const{placeholder:e}=this.props;return"string"==typeof e?e:e(this.state.validAddressTypes)}_doNaiveGroupSearch(e){const t=e.toLowerCase();this.setState({busy:!0,query:e,searchError:null}),L.a.get().getGroupUsers(this.props.groupId).then(s=>{const n=[];s.chunk.forEach(e=>{const s=e.user_id.toLowerCase().includes(t),i=(e.displayname||"").toLowerCase().includes(t);(s||i)&&n.push({user_id:e.user_id,avatar_url:e.avatar_url,display_name:e.displayname})}),this._processResults(n,e)}).catch(e=>{console.error("Error whilst searching group rooms: ",e),this.setState({searchError:e.errcode?e.message:Object(c.a)("Something went wrong!")})}).then(()=>{this.setState({busy:!1})})}_doNaiveGroupRoomSearch(e){const t=e.toLowerCase(),s=[];Zo.a.getGroupRooms(this.props.groupId).forEach(e=>{const n=(e.name||"").toLowerCase().includes(t),i=(e.topic||"").toLowerCase().includes(t),o=(e.canonical_alias||"").toLowerCase().includes(t);(n||i||o)&&s.push({room_id:e.room_id,avatar_url:e.avatar_url,name:e.name||e.canonical_alias})}),this._processResults(s,e),this.setState({busy:!1})}_doRoomSearch(e){const t=e.toLowerCase(),s=L.a.get().getRooms(),n=[];s.forEach(e=>{let s=1/0;const i=e.currentState.getStateEvents("m.room.name",""),o=i?i.getContent().name:"",r=e.getCanonicalAlias(),a=e.currentState.getStateEvents("m.room.aliases").map(e=>e.getContent().aliases).reduce((e,t)=>e.concat(t),[]),l=(o||"").toLowerCase().includes(t);let d=!1,u=1/0;if(a.forEach(e=>{(e||"").toLowerCase().includes(t)&&(d=!0,u>e.length&&(u=e.length))}),!l&&!d)return;d&&(s=u);const h=e.currentState.getStateEvents("m.room.avatar",""),m=h?h.getContent().url:void 0;n.push({rank:s,room_id:e.roomId,avatar_url:m,name:o||r||a[0]||Object(c.a)("Unnamed Room")})});const i=n.sort((e,t)=>e.rank-t.rank);this._processResults(i,e),this.setState({busy:!1})}_doUserDirectorySearch(e){this.setState({busy:!0,query:e,searchError:null}),L.a.get().searchUserDirectory({term:e}).then(t=>{this.state.query===e&&this._processResults(t.results,e)}).catch(t=>{console.error("Error whilst searching user directory: ",t),this.setState({searchError:t.errcode?t.message:Object(c.a)("Something went wrong!")}),"M_UNRECOGNIZED"===t.errcode&&(this.setState({serverSupportsUserDirectory:!1}),this._doLocalSearch(e))}).then(()=>{this.setState({busy:!1})})}_doLocalSearch(e){this.setState({query:e,searchError:null});const t=e.toLowerCase(),s=[];L.a.get().getUsers().forEach(e=>{-1===e.userId.toLowerCase().indexOf(t)&&-1===e.displayName.toLowerCase().indexOf(t)||s.push({user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl})}),this._processResults(s,e)}_processResults(e,t){const s=[];e.forEach(e=>{if(e.room_id){const t=L.a.get(),n=t.getRoom(e.room_id);if(n){const e=n.currentState.getStateEvents("m.room.tombstone","");if(e&&e.getContent()&&e.getContent().replacement_room){if(t.getRoom(e.getContent().replacement_room))return}}s.push({addressType:"mx-room-id",address:e.room_id,displayName:e.name,avatarMxc:e.avatar_url,isKnown:!0})}else(this.props.includeSelf||e.user_id!==L.a.get().credentials.userId)&&s.push({addressType:"mx-user-id",address:e.user_id,displayName:e.display_name,avatarMxc:e.avatar_url,isKnown:!0})});const n=Object(Wn.c)(t);if(this.state.validAddressTypes.includes(n)){if("email"===n&&!Ga.a(t))return void this.setState({searchError:Object(c.a)("That doesn't look like a valid email address")});s.unshift({addressType:n,address:t,isKnown:!1}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),"email"===n&&this._lookupThreepid(n,t)}this.setState({suggestedList:s,invalidAddressError:!1},()=>{this.addressSelector&&this.addressSelector.moveSelectionTop()})}_addAddressesToList(e){const t=this.state.selectedList.slice();let s=!1;return e.forEach(e=>{e=e.trim();const n=Object(Wn.c)(e),i={addressType:n,address:e,isKnown:!1};if(this.state.validAddressTypes.includes(n)){if("mx-user-id"===n){const e=L.a.get().getUser(i.address);e&&(i.displayName=e.displayName,i.avatarMxc=e.avatarUrl,i.isKnown=!0)}else if("mx-room-id"===n){const e=L.a.get().getRoom(i.address);e&&(i.displayName=e.name,i.avatarMxc=e.avatarUrl,i.isKnown=!0)}}else s=!0;t.push(i)}),this.setState({selectedList:t,suggestedList:[],query:"",invalidAddressError:!!s||this.state.invalidAddressError}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),s?null:t}async _lookupThreepid(e,t){let s=!1;if(this._cancelThreepidLookup=function(){s=!0},await Object(Ze.c)(500),s)return null;try{const n=new Oe.a,i=await n.getAccessToken();if(s)return null;const o=await L.a.get().lookupThreePid(e,t,void 0,i);if(s||null===o||!o.mxid)return null;const r=await L.a.get().getProfileInfo(o.mxid);if(s||null===r)return null;this.setState({suggestedList:[{addressType:e,address:t,displayName:r.displayname,avatarMxc:r.avatar_url,isKnown:!0}]})}catch(e){console.error(e),this.setState({searchError:Object(c.a)("Something went wrong!")})}}_getFilteredSuggestions(){const e={};return this.state.selectedList.forEach(({address:t,addressType:s})=>{e[s]||(e[s]=new Set),e[s].add(t)}),this.state.suggestedList.filter(({address:t,addressType:s})=>!(e[s]&&e[s].has(t)))}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.AddressSelector");let n;this.scrollElement=null,this.props.description&&(n=o.a.createElement("div",{className:"mx_AddressPickerDialog_label"},o.a.createElement("label",{htmlFor:"textinput"},this.props.description)));const i=[];if(this.state.selectedList.length>0){const e=d.getComponent("elements.AddressTile");for(let t=0;t<this.state.selectedList.length;t++)i.push(o.a.createElement(e,{key:t,address:this.state.selectedList[t],canDismiss:!0,onDismissed:this.onDismissed(t),showAddress:"user"===this.props.pickerType}))}i.push(o.a.createElement("textarea",{key:this.state.selectedList.length,onPaste:this._onPaste,rows:"1",id:"textinput",ref:this._textinput,className:"mx_AddressPickerDialog_input",onChange:this.onQueryChanged,placeholder:this.getPlaceholder(),defaultValue:this.props.value,autoFocus:this.props.focus}));const r=this._getFilteredSuggestions();let a,l,u;if(this.state.invalidAddressError){const e=this.state.validAddressTypes.map(e=>Object(c.a)(ac[e]));a=o.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("You have entered an invalid address."),o.a.createElement("br",null),Object(c.a)("Try using one of the following valid address types: %(validTypesList)s.",{validTypesList:e.join(", ")}))}else this.state.searchError?a=o.a.createElement("div",{className:"mx_AddressPickerDialog_error"},this.state.searchError):this.state.query.length>0&&0===r.length&&!this.state.busy?a=o.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("No results")):l=o.a.createElement(s,{ref:e=>{this.addressSelector=e},addressList:r,showAddress:"user"===this.props.pickerType,onSelected:this.onSelected,truncateAt:40});if("user"===this.props.pickerType&&!this.state.validAddressTypes.includes("email")&&this.props.validAddressTypes.includes("email")){const e=Object(Hn.c)();u=e?o.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(c.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(Te.a)(e)},{default:e=>o.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>o.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):o.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(c.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>o.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}return o.a.createElement(e,{className:"mx_AddressPickerDialog",onKeyDown:this.onKeyDown,onFinished:this.props.onFinished,title:this.props.title},n,o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_AddressPickerDialog_inputContainer"},i),a,l,this.props.extraNode,u),o.a.createElement(t,{primaryButton:this.props.button,onPrimaryButtonClick:this.onButtonClick,onCancel:this.onCancel}))}}g()(cc,"propTypes",{title:re.a.string.isRequired,description:re.a.node,extraNode:re.a.node,value:re.a.string,placeholder:re.a.oneOfType([re.a.string,re.a.func]),roomId:re.a.string,button:re.a.string,focus:re.a.bool,validAddressTypes:re.a.arrayOf(re.a.oneOf(Wn.b)),onFinished:re.a.func.isRequired,groupId:re.a.string,pickerType:re.a.oneOf(["user","room"]),includeSelf:re.a.bool}),g()(cc,"defaultProps",{value:"",focus:!0,validAddressTypes:Wn.b,pickerType:"user",includeSelf:!1});class lc extends o.a.Component{constructor(...e){super(...e),g()(this,"_onInviteClicked",()=>{this.props.onInviteAnyways(),this.props.onFinished(!0)}),g()(this,"_onInviteNeverWarnClicked",()=>{w.a.setValue("promptBeforeInviteUnknownUsers",null,je.a.ACCOUNT,!1),this.props.onInviteAnyways(),this.props.onFinished(!0)}),g()(this,"_onGiveUpClicked",()=>{this.props.onGiveUp(),this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=this.props.unknownProfileUsers.map(e=>o.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText));return o.a.createElement(e,{className:"mx_RetryInvitesDialog",onFinished:this._onGiveUpClicked,title:Object(c.a)("The following users may not exist"),contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),o.a.createElement("ul",null,t)),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this._onGiveUpClicked},Object(c.a)("Close")),o.a.createElement("button",{onClick:this._onInviteNeverWarnClicked},Object(c.a)("Invite anyway and never warn me again")),o.a.createElement("button",{onClick:this._onInviteClicked,autoFocus:!0},Object(c.a)("Invite anyway"))))}}g()(lc,"propTypes",{unknownProfileUsers:re.a.array.isRequired,onInviteAnyways:re.a.func.isRequired,onGiveUp:re.a.func.isRequired,onFinished:re.a.func.isRequired});var dc=s(485);class uc extends o.a.PureComponent{constructor(e){super(e),g()(this,"onParentFinished",async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)}),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=d.getComponent("dialogs.ErrorDialog"),t=this.state.redactionErrorCode;return o.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Error"),description:Object(c.a)("You cannot delete this message. (%(code)s)",{code:t})})}{const e=d.getComponent("dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");return o.a.createElement(e,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(c.a)("Removing…")},o.a.createElement(t,null))}}{const e=d.getComponent("dialogs.ConfirmRedactDialog");return o.a.createElement(e,{onFinished:this.onParentFinished})}}}class hc extends o.a.Component{constructor(...e){super(...e),g()(this,"_onConfirm",()=>{this.props.onFinished(!0)}),g()(this,"_onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Destroy cross-signing keys?")},o.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},o.a.createElement("p",null,Object(c.a)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),o.a.createElement(t,{primaryButton:Object(c.a)("Clear cross-signing keys"),onPrimaryButtonClick:this._onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this._onDecline}))}}g()(hc,"propTypes",{onFinished:re.a.func.isRequired});class mc extends o.a.Component{render(){const e=d.getComponent("views.dialogs.QuestionDialog");return o.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Confirm Removal"),description:Object(c.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),button:Object(c.a)("Remove")})}}var pc=s(233);class gc extends o.a.Component{constructor(e){super(e),g()(this,"onOk",()=>{let e;this._reasonField&&(e=this._reasonField.value),this.props.onFinished(!0,e)}),g()(this,"onCancel",()=>{this.props.onFinished(!1)}),g()(this,"_collectReasonField",e=>{this._reasonField=e}),this._reasonField=null}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.avatars.MemberAvatar"),n=d.getComponent("views.avatars.BaseAvatar"),i=this.props.danger?"danger":"";let r,a,l,u;if(this.props.askReason&&(r=o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onOk},o.a.createElement("input",{className:"mx_ConfirmUserActionDialog_reasonField",ref:this._collectReasonField,placeholder:Object(c.a)("Reason"),autoFocus:!0})))),this.props.member)a=o.a.createElement(s,{member:this.props.member,width:48,height:48}),l=this.props.member.name,u=this.props.member.userId;else{const e=this.props.groupMember.avatarUrl?this.props.matrixClient.mxcUrlToHttp(this.props.groupMember.avatarUrl,48,48):null;l=this.props.groupMember.displayname||this.props.groupMember.userId,u=this.props.groupMember.userId,a=o.a.createElement(n,{name:l,url:e,width:48,height:48})}return o.a.createElement(e,{className:"mx_ConfirmUserActionDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},a),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},l),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_userId"},u)),r,o.a.createElement(t,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:i,focus:!this.props.askReason,onCancel:this.onCancel}))}}g()(gc,"propTypes",{member:re.a.object,groupMember:pc.a,matrixClient:re.a.instanceOf(de.h),action:re.a.string.isRequired,title:re.a.string.isRequired,askReason:re.a.bool,danger:re.a.bool,onFinished:re.a.func.isRequired}),g()(gc,"defaultProps",{danger:!1,askReason:!1});class fc extends o.a.Component{constructor(...e){super(...e),g()(this,"_onConfirm",()=>{this.props.onFinished(!0)}),g()(this,"_onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Clear all data in this session?")},o.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},o.a.createElement("p",null,Object(c.a)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),o.a.createElement(t,{primaryButton:Object(c.a)("Clear all data"),onPrimaryButtonClick:this._onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this._onDecline}))}}g()(fc,"propTypes",{onFinished:re.a.func.isRequired});class _c extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{groupName:"",groupId:"",groupError:null,creating:!1,createError:null}),g()(this,"_onGroupNameChange",e=>{this.setState({groupName:e.target.value})}),g()(this,"_onGroupIdChange",e=>{this.setState({groupId:e.target.value})}),g()(this,"_onGroupIdBlur",e=>{this._checkGroupId()}),g()(this,"_onFormSubmit",e=>{if(e.preventDefault(),this._checkGroupId())return;const t={};""!==this.state.groupName&&(t.name=this.state.groupName),this.setState({creating:!0}),L.a.get().createGroup({localpart:this.state.groupId,profile:t}).then(e=>{u.a.dispatch({action:"view_group",group_id:e.group_id,group_is_new:!0}),this.props.onFinished(!0)}).catch(e=>{this.setState({createError:e})}).finally(()=>{this.setState({creating:!1})})}),g()(this,"_onCancel",()=>{this.props.onFinished(!1)})}_checkGroupId(e){let t=null;return this.state.groupId?/^[a-z0-9=_\-./]*$/.test(this.state.groupId)||(t=Object(c.a)("Community IDs may only contain characters a-z, 0-9, or '=_-./'")):t=Object(c.a)("Community IDs cannot be empty."),this.setState({groupIdError:t,createError:null}),t}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");if(this.state.creating)return o.a.createElement(t,null);let s;return this.state.createError&&(s=o.a.createElement("div",{className:"error",role:"alert"},o.a.createElement("div",null,Object(c.a)("Something went wrong whilst creating your community")),o.a.createElement("div",null,this.state.createError.message))),o.a.createElement(e,{className:"mx_CreateGroupDialog",onFinished:this.props.onFinished,title:Object(c.a)("Create Community")},o.a.createElement("form",{onSubmit:this._onFormSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},o.a.createElement("div",{className:"mx_CreateGroupDialog_label"},o.a.createElement("label",{htmlFor:"groupname"},Object(c.a)("Community Name"))),o.a.createElement("div",null,o.a.createElement("input",{id:"groupname",className:"mx_CreateGroupDialog_input",autoFocus:!0,size:"64",placeholder:Object(c.a)("Example"),onChange:this._onGroupNameChange,value:this.state.groupName}))),o.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},o.a.createElement("div",{className:"mx_CreateGroupDialog_label"},o.a.createElement("label",{htmlFor:"groupid"},Object(c.a)("Community ID"))),o.a.createElement("div",{className:"mx_CreateGroupDialog_input_group"},o.a.createElement("span",{className:"mx_CreateGroupDialog_prefix"},"+"),o.a.createElement("input",{id:"groupid",className:"mx_CreateGroupDialog_input mx_CreateGroupDialog_input_hasPrefixAndSuffix",size:"32",placeholder:Object(c.a)("example"),onChange:this._onGroupIdChange,onBlur:this._onGroupIdBlur,value:this.state.groupId}),o.a.createElement("span",{className:"mx_CreateGroupDialog_suffix"},":",L.a.get().getDomain()))),o.a.createElement("div",{className:"error"},this.state.groupIdError),s),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{type:"submit",value:Object(c.a)("Create"),className:"mx_Dialog_primary"}),o.a.createElement("button",{onClick:this._onCancel},Object(c.a)("Cancel")))))}}g()(_c,"propTypes",{onFinished:re.a.func.isRequired});class vc extends o.a.Component{constructor(e){super(e),g()(this,"_onKeyDown",e=>{e.key===Yt.a.ENTER&&(this.onOk(),e.preventDefault(),e.stopPropagation())}),g()(this,"onOk",async()=>{const e=document.activeElement;if(e&&e.blur(),await this._nameFieldRef.validate({allowEmpty:!1}),this._aliasFieldRef&&await this._aliasFieldRef.validate({allowEmpty:!1}),await new Promise(e=>this.setState({},e)),!this.state.nameIsValid||this._aliasFieldRef&&!this._aliasFieldRef.isValid){let e;this.state.nameIsValid?this._aliasFieldRef&&!this._aliasFieldRef.isValid&&(e=this._aliasFieldRef):e=this._nameFieldRef,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this._roomCreateOptions())}),g()(this,"onCancel",()=>{this.props.onFinished(!1)}),g()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),g()(this,"onTopicChange",e=>{this.setState({topic:e.target.value})}),g()(this,"onPublicChange",e=>{this.setState({isPublic:e})}),g()(this,"onEncryptedChange",e=>{this.setState({isEncrypted:e})}),g()(this,"onAliasChange",e=>{this.setState({alias:e})}),g()(this,"onDetailsToggled",e=>{this.setState({detailsOpen:e.target.open})}),g()(this,"onNoFederateChange",e=>{this.setState({noFederate:e})}),g()(this,"collectDetailsRef",e=>{this._detailsRef=e}),g()(this,"onNameValidate",async e=>{const t=await vc._validateRoomName(e);return this.setState({nameIsValid:t.valid}),t});const t=l.a.get();this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:Object(et.e)(),name:"",topic:"",alias:"",detailsOpen:!1,noFederate:!1===t.default_federate,nameIsValid:!1}}_roomCreateOptions(){const e={},t=e.createOpts={};if(t.name=this.state.name,this.state.isPublic){t.visibility="public",t.preset="public_chat",e.guestAccess=!1;const{alias:s}=this.state,n=s.substr(1,s.indexOf(":")-1);t.room_alias_name=n}return this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),this.state.isPublic||(e.encryption=this.state.isEncrypted),Ut.a.instance.getSelectedCommunityId()&&(e.associatedWithCommunity=Ut.a.instance.getSelectedCommunityId()),e}componentDidMount(){this._detailsRef.addEventListener("toggle",this.onDetailsToggled),this._nameFieldRef.focus()}componentWillUnmount(){this._detailsRef.removeEventListener("toggle",this.onDetailsToggled)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.elements.Field"),n=d.getComponent("views.elements.LabelledToggleSwitch"),i=d.getComponent("views.elements.RoomAliasField");let r;if(this.state.isPublic){const e=L.a.get().getDomain();r=o.a.createElement("div",{className:"mx_CreateRoomDialog_aliasContainer"},o.a.createElement(i,{ref:e=>this._aliasFieldRef=e,onChange:this.onAliasChange,domain:e,value:this.state.alias}))}let a,u=o.a.createElement("p",null,Object(c.a)("Private rooms can be found and joined by invitation only. Public rooms can be found and joined by anyone."));if(Ut.a.instance.getSelectedCommunityId()&&(u=o.a.createElement("p",null,Object(c.a)("Private rooms can be found and joined by invitation only. Public rooms can be found and joined by anyone in this community."))),!this.state.isPublic){let e;e=Object(et.e)()?Object(c.a)("You can’t disable this later. Bridges & most bots won’t work yet."):Object(c.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."),a=o.a.createElement(o.a.Fragment,null,o.a.createElement(n,{label:Object(c.a)("Enable end-to-end encryption"),onChange:this.onEncryptedChange,value:this.state.isEncrypted,className:"mx_CreateRoomDialog_e2eSwitch"}),o.a.createElement("p",null,e))}let h=Object(c.a)("You might enable this if the room will only be used for collaborating with internal teams on your homeserver. This cannot be changed later.");!1===l.a.get().default_federate&&(h=Object(c.a)("You might disable this if the room will be used for collaborating with external teams who have their own homeserver. This cannot be changed later."));let m=this.state.isPublic?Object(c.a)("Create a public room"):Object(c.a)("Create a private room");if(Ut.a.instance.getSelectedCommunityId()){const e=Ut.a.instance.getSelectedCommunityName();m=Object(c.a)("Create a room in %(communityName)s",{communityName:e})}return o.a.createElement(e,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:m},o.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this._onKeyDown},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(s,{ref:e=>this._nameFieldRef=e,label:Object(c.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),o.a.createElement(s,{label:Object(c.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),o.a.createElement(n,{label:Object(c.a)("Make this room public"),onChange:this.onPublicChange,value:this.state.isPublic}),u,a,r,o.a.createElement("details",{ref:this.collectDetailsRef,className:"mx_CreateRoomDialog_details"},o.a.createElement("summary",{className:"mx_CreateRoomDialog_details_summary"},this.state.detailsOpen?Object(c.a)("Hide advanced"):Object(c.a)("Show advanced")),o.a.createElement(n,{label:Object(c.a)("Block anyone not part of %(serverName)s from ever joining this room.",{serverName:L.a.getHomeserverName()}),onChange:this.onNoFederateChange,value:this.state.noFederate}),o.a.createElement("p",null,h)))),o.a.createElement(t,{primaryButton:Object(c.a)("Create Room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}}g()(vc,"propTypes",{onFinished:re.a.func.isRequired,defaultPublic:re.a.bool}),g()(vc,"_validateRoomName",Object(dn.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(c.a)("Please enter a name for the room")}]}));var yc=e=>{const t=l.a.get().brand,s=Object(c.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t}),n=d.getComponent("views.dialogs.BaseDialog"),i=d.getComponent("views.elements.DialogButtons");return o.a.createElement(n,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(c.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},s),o.a.createElement(i,{primaryButton:Object(c.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:e.onFinished},o.a.createElement("button",{onClick:()=>{const s=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Logout e2e db too new","",s,{title:Object(c.a)("Sign out"),description:Object(c.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(c.a)("Sign out"),focus:!1,onFinished:t=>{t&&(u.a.dispatch({action:"logout"}),e.onFinished())}})}},Object(c.a)("Sign out"))))};class bc extends o.a.PureComponent{constructor(e){super(e),this._onChange=this._onChange.bind(this),this.onBack=this.onBack.bind(this)}onBack(){this.state.message?this.setState({message:null}):this.props.onBack()}_onChange(e){this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}_buttons(){return o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),!this.state.message&&o.a.createElement("button",{onClick:this._send},Object(c.a)("Send")))}textInput(e,t){return o.a.createElement(le.a,{id:e,label:t,size:"42",autoFocus:!0,type:"text",autoComplete:"on",value:this.state[e],onChange:this._onChange})}}class Ec extends bc{static getLabel(){return Object(c.a)("Send Custom Event")}constructor(e){super(e),this._send=this._send.bind(this);const{eventType:t,stateKey:s,evContent:n}=Object.assign({eventType:"",stateKey:"",evContent:"{\n\n}"},this.props.inputs);this.state={isStateEvent:Boolean(this.props.forceStateEvent),eventType:t,stateKey:s,evContent:n}}send(e){const t=this.context;return this.state.isStateEvent?t.sendStateEvent(this.props.room.roomId,this.state.eventType,e,this.state.stateKey):t.sendEvent(this.props.room.roomId,this.state.eventType,e)}async _send(){if(""===this.state.eventType)return void this.setState({message:Object(c.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.send(t),e=Object(c.a)("Event sent!")}catch(t){e=Object(c.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})}render(){return this.state.message?o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this._buttons()):o.a.createElement("div",null,o.a.createElement("div",{className:"mx_DevTools_content"},o.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},this.textInput("eventType",Object(c.a)("Event Type")),this.state.isStateEvent&&this.textInput("stateKey",Object(c.a)("State Key"))),o.a.createElement("br",null),o.a.createElement(le.a,{id:"evContent",label:Object(c.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this._onChange,element:"textarea"})),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),!this.state.message&&o.a.createElement("button",{onClick:this._send},Object(c.a)("Send")),!this.state.message&&!this.props.forceStateEvent&&o.a.createElement("div",{style:{float:"right"}},o.a.createElement("input",{id:"isStateEvent",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isStateEvent}),o.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Event","data-tg-on":"State Event",htmlFor:"isStateEvent"}))))}}g()(Ec,"propTypes",{onBack:re.a.func.isRequired,room:re.a.instanceOf(de.j).isRequired,forceStateEvent:re.a.bool,inputs:re.a.object}),g()(Ec,"contextType",S.a);class Sc extends bc{static getLabel(){return Object(c.a)("Send Account Data")}constructor(e){super(e),this._send=this._send.bind(this);const{eventType:t,evContent:s}=Object.assign({eventType:"",evContent:"{\n\n}"},this.props.inputs);this.state={isRoomAccountData:Boolean(this.props.isRoomAccountData),eventType:t,evContent:s}}send(e){const t=this.context;return this.state.isRoomAccountData?t.setRoomAccountData(this.props.room.roomId,this.state.eventType,e):t.setAccountData(this.state.eventType,e)}async _send(){if(""===this.state.eventType)return void this.setState({message:Object(c.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.send(t),e=Object(c.a)("Event sent!")}catch(t){e=Object(c.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})}render(){return this.state.message?o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this._buttons()):o.a.createElement("div",null,o.a.createElement("div",{className:"mx_DevTools_content"},this.textInput("eventType",Object(c.a)("Event Type")),o.a.createElement("br",null),o.a.createElement(le.a,{id:"evContent",label:Object(c.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this._onChange,element:"textarea"})),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),!this.state.message&&o.a.createElement("button",{onClick:this._send},Object(c.a)("Send")),!this.state.message&&o.a.createElement("div",{style:{float:"right"}},o.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isRoomAccountData,disabled:this.props.forceMode}),o.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}g()(Sc,"propTypes",{room:re.a.instanceOf(de.j).isRequired,isRoomAccountData:re.a.bool,forceMode:re.a.bool,inputs:re.a.object}),g()(Sc,"contextType",S.a);class wc extends o.a.PureComponent{static filterChildren(e,t){if(!t)return e;const s=t.toLowerCase();return e.filter(e=>e.key.toLowerCase().includes(s))}constructor(e){super(e),g()(this,"showAll",()=>{this.setState({truncateAt:this.state.truncateAt+50})}),g()(this,"createOverflowElement",(e,t)=>o.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",onClick:this.showAll},Object(c.a)("and %(count)s others...",{count:e}))),g()(this,"onQuery",e=>{this.props.onChange&&this.props.onChange(e.target.value)}),g()(this,"getChildren",(e,t)=>this.state.filteredChildren.slice(e,t)),g()(this,"getChildCount",()=>this.state.filteredChildren.length),this.state={filteredChildren:wc.filterChildren(this.props.children,this.props.query),truncateAt:20}}UNSAFE_componentWillReceiveProps(e){this.props.children===e.children&&this.props.query===e.query||this.setState({filteredChildren:wc.filterChildren(e.children,e.query),truncateAt:20})}render(){const e=d.getComponent("elements.TruncatedList");return o.a.createElement("div",null,o.a.createElement(le.a,{label:Object(c.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.props.query,onChange:this.onQuery,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:this.props.children[0]?this.props.children[0].key:""}),o.a.createElement(e,{getChildren:this.getChildren,getChildCount:this.getChildCount,truncateAt:this.state.truncateAt,createOverflowElement:this.createOverflowElement}))}}g()(wc,"propTypes",{children:re.a.any,query:re.a.string,onChange:re.a.func});class Cc extends o.a.PureComponent{static getLabel(){return Object(c.a)("Explore Room State")}constructor(e){super(e),g()(this,"roomStateEvents",void 0),this.roomStateEvents=this.props.room.currentState.events,this.onBack=this.onBack.bind(this),this.editEv=this.editEv.bind(this),this.onQueryEventType=this.onQueryEventType.bind(this),this.onQueryStateKey=this.onQueryStateKey.bind(this),this.state={eventType:null,event:null,editing:!1,queryEventType:"",queryStateKey:""}}browseEventType(e){return()=>{this.setState({eventType:e})}}onViewSourceClick(e){return()=>{this.setState({event:e})}}onBack(){this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.state.eventType?this.setState({eventType:null}):this.props.onBack()}editEv(){this.setState({editing:!0})}onQueryEventType(e){this.setState({queryEventType:e})}onQueryStateKey(e){this.setState({queryStateKey:e})}render(){if(this.state.event)return this.state.editing?o.a.createElement(Ec,{room:this.props.room,forceStateEvent:!0,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t"),stateKey:this.state.event.getStateKey()}}):o.a.createElement("div",{className:"mx_ViewSource"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(Wr,{className:"json"},JSON.stringify(this.state.event.event,null,2))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),o.a.createElement("button",{onClick:this.editEv},Object(c.a)("Edit"))));let e=null;const t="mx_DevTools_RoomStateExplorer_button";if(null===this.state.eventType)e=o.a.createElement(wc,{query:this.state.queryEventType,onChange:this.onQueryEventType},Array.from(this.roomStateEvents.entries()).map(([e,s])=>{let n;return n=1===s.size&&s.has("")?this.onViewSourceClick(s.get("")):this.browseEventType(e),o.a.createElement("button",{className:t,key:e,onClick:n},e)}));else{const s=this.roomStateEvents.get(this.state.eventType);e=o.a.createElement(wc,{query:this.state.queryStateKey,onChange:this.onQueryStateKey},Array.from(s.entries()).map(([e,s])=>o.a.createElement("button",{className:t,key:e,onClick:this.onViewSourceClick(s)},e)))}return o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},e),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back"))))}}g()(Cc,"propTypes",{onBack:re.a.func.isRequired,room:re.a.instanceOf(de.j).isRequired}),g()(Cc,"contextType",S.a);class Rc extends o.a.PureComponent{static getLabel(){return Object(c.a)("Explore Account Data")}constructor(e){super(e),this.onBack=this.onBack.bind(this),this.editEv=this.editEv.bind(this),this._onChange=this._onChange.bind(this),this.onQueryEventType=this.onQueryEventType.bind(this),this.state={isRoomAccountData:!1,event:null,editing:!1,queryEventType:""}}getData(){return this.state.isRoomAccountData?this.props.room.accountData:this.context.store.accountData}onViewSourceClick(e){return()=>{this.setState({event:e})}}onBack(){this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.props.onBack()}_onChange(e){this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}editEv(){this.setState({editing:!0})}onQueryEventType(e){this.setState({queryEventType:e})}render(){if(this.state.event)return this.state.editing?o.a.createElement(Sc,{room:this.props.room,isRoomAccountData:this.state.isRoomAccountData,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t")},forceMode:!0}):o.a.createElement("div",{className:"mx_ViewSource"},o.a.createElement("div",{className:"mx_DevTools_content"},o.a.createElement(Wr,{className:"json"},JSON.stringify(this.state.event.event,null,2))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),o.a.createElement("button",{onClick:this.editEv},Object(c.a)("Edit"))));const e=[],t=this.getData();return Object.keys(t).forEach(s=>{const n=t[s];e.push(o.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:s,onClick:this.onViewSourceClick(n)},s))}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(wc,{query:this.state.queryEventType,onChange:this.onQueryEventType},e)),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onBack},Object(c.a)("Back")),!this.state.message&&o.a.createElement("div",{style:{float:"right"}},o.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isRoomAccountData}),o.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}g()(Rc,"propTypes",{onBack:re.a.func.isRequired,room:re.a.instanceOf(de.j).isRequired}),g()(Rc,"contextType",S.a);class kc extends o.a.PureComponent{static getLabel(){return Object(c.a)("View Servers in Room")}constructor(e){super(e),g()(this,"onQuery",e=>{this.setState({query:e})});const t=this.props.room,s=new Set;t.currentState.getStateEvents("m.room.member").forEach(e=>s.add(e.getSender().split(":")[1])),this.servers=Array.from(s).map(e=>o.a.createElement("button",{key:e,className:"mx_DevTools_ServersInRoomList_button"},e)),this.state={query:""}}render(){return o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(wc,{query:this.state.query,onChange:this.onQuery},this.servers)),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.props.onBack},Object(c.a)("Back"))))}}g()(kc,"propTypes",{onBack:re.a.func.isRequired,room:re.a.instanceOf(de.j).isRequired}),g()(kc,"contextType",S.a);const Ic={[Cn.g]:"unsent",[Cn.e]:"requested",[Cn.d]:"ready",[Cn.c]:"done",[Cn.f]:"started",[Cn.b]:"cancelled"};function Oc({txnId:e,request:t}){const[,s]=Object(i.useState)(),[n,r]=Object(i.useState)(t.timeout);return Object(Zt.a)(t,"change",s),Object(i.useEffect)(()=>{if(0==t.timeout)return;const e=setInterval(()=>{r(t.timeout)},500);return()=>{clearInterval(e)}},[t]),o.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},o.a.createElement("dl",null,o.a.createElement("dt",null,"Transaction"),o.a.createElement("dd",null,e),o.a.createElement("dt",null,"Phase"),o.a.createElement("dd",null,Ic[t.phase]||t.phase),o.a.createElement("dt",null,"Timeout"),o.a.createElement("dd",null,Math.floor(n/1e3)),o.a.createElement("dt",null,"Methods"),o.a.createElement("dd",null,t.methods&&t.methods.join(", ")),o.a.createElement("dt",null,"requestingUserId"),o.a.createElement("dd",null,t.requestingUserId),o.a.createElement("dt",null,"observeOnly"),o.a.createElement("dd",null,JSON.stringify(t.observeOnly))))}class Tc extends o.a.Component{constructor(...e){super(...e),g()(this,"onNewRequest",()=>{this.forceUpdate()})}static getLabel(){return Object(c.a)("Verification Requests")}componentDidMount(){this.context.on("crypto.verification.request",this.onNewRequest)}componentWillUnmount(){this.context.off("crypto.verification.request",this.onNewRequest)}render(){const e=this.context,t=this.props.room,s=(e._crypto._inRoomVerificationRequests._requestsByRoomId||new Map).get(t.roomId)||new Map;return o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content"},Array.from(s.entries()).reverse().map(([e,t])=>o.a.createElement(Oc,{txnId:e,request:t,key:e}))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.props.onBack},Object(c.a)("Back"))))}}g()(Tc,"contextType",S.a);const xc=[Ec,Cc,Sc,Rc,kc,Tc];class Nc extends o.a.PureComponent{constructor(e){super(e),this.onBack=this.onBack.bind(this),this.onCancel=this.onCancel.bind(this),this.state={mode:null}}componentWillUnmount(){this._unmounted=!0}_setMode(e){return()=>{this.setState({mode:e})}}onBack(){this.prevMode?(this.setState({mode:this.prevMode}),this.prevMode=null):this.setState({mode:null})}onCancel(){this.props.onFinished(!1)}render(){let e;if(this.state.mode)e=o.a.createElement(S.a.Consumer,null,e=>o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_DevTools_label_left"},this.state.mode.getLabel()),o.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),o.a.createElement("div",{className:"mx_DevTools_label_bottom"}),o.a.createElement(this.state.mode,{onBack:this.onBack,room:e.getRoom(this.props.roomId)})));else{const t="mx_DevTools_RoomStateExplorer_button";e=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",null,o.a.createElement("div",{className:"mx_DevTools_label_left"},Object(c.a)("Toolbox")),o.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),o.a.createElement("div",{className:"mx_DevTools_label_bottom"}),o.a.createElement("div",{className:"mx_Dialog_content"},xc.map(e=>{const s=e.getLabel(),n=this._setMode(e);return o.a.createElement("button",{className:t,key:s,onClick:n},s)}))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{onClick:this.onCancel},Object(c.a)("Cancel"))))}const t=d.getComponent("views.dialogs.BaseDialog");return o.a.createElement(t,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:Object(c.a)("Developer Tools")},e)}}g()(Nc,"propTypes",{roomId:re.a.string.isRequired,onFinished:re.a.func.isRequired});class jc extends o.a.Component{constructor(e){super(e),g()(this,"_onFinished",()=>{this.props.onFinished(3===this.state.phase)}),g()(this,"_onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),g()(this,"_onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{console.log("Verification failed",e)})}),g()(this,"_onVerifierShowSas",e=>{this._showSasEvent=e,this.setState({phase:1,sas:e.sas})}),g()(this,"_onVerifierCancel",e=>{this.setState({phase:4})}),g()(this,"_onSasMatchesClick",()=>{this._showSasEvent.confirm(),this.setState({phase:2})}),g()(this,"_onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.cancelled&&(console.log("Verifier was cancelled in the background."),t=4),this._showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null},this.props.verifier.on("show_sas",this._onVerifierShowSas),this.props.verifier.on("cancel",this._onVerifierCancel),this._fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel("User cancel"),this.props.verifier.removeListener("show_sas",this._onVerifierShowSas)}async _fetchOpponentProfile(){try{const e=await L.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}_renderPhaseStart(){const e=d.getComponent("views.elements.DialogButtons"),t=d.getComponent("views.elements.Spinner"),s=d.getComponent("avatars.BaseAvatar"),n=this.props.verifier.userId==L.a.get().getUserId();let i;i=this.state.opponentProfile?o.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},o.a.createElement(s,{name:this.state.opponentProfile.displayname,idName:this.props.verifier.userId,url:L.a.get().mxcUrlToHttp(this.state.opponentProfile.avatar_url,Math.floor(48*window.devicePixelRatio),Math.floor(48*window.devicePixelRatio),"crop"),width:48,height:48,resizeMethod:"crop"}),o.a.createElement("h2",null,this.state.opponentProfile.displayname)):this.state.opponentProfileError?o.a.createElement("div",null,o.a.createElement(s,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),o.a.createElement("h2",null,this.props.verifier.userId)):o.a.createElement(t,null);const r=[o.a.createElement("p",{key:"p1"},Object(c.a)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(c.a)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],a=[o.a.createElement("p",{key:"p1"},Object(c.a)("Verify this device to mark it as trusted. Trusting this device gives you and other users extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(c.a)("Verifying this device will mark it as trusted, and users who have verified with you will trust this device."))];return o.a.createElement("div",null,i,n?a:r,o.a.createElement(e,{primaryButton:Object(c.a)("Continue"),hasCancel:!0,onPrimaryButtonClick:this._onContinueClick,onCancel:this._onCancelClick}))}_renderPhaseShowSas(){const e=d.getComponent("views.verification.VerificationShowSas");return o.a.createElement(e,{sas:this._showSasEvent.sas,onCancel:this._onCancelClick,onDone:this._onSasMatchesClick,isSelf:this.props.verifier.userId===L.a.get().getUserId(),inDialog:!0})}_renderPhaseWaitForPartnerToConfirm(){const e=d.getComponent("views.elements.Spinner");return o.a.createElement("div",null,o.a.createElement(e,null),o.a.createElement("p",null,Object(c.a)("Waiting for partner to confirm...")))}_renderPhaseVerified(){const e=d.getComponent("views.verification.VerificationComplete");return o.a.createElement(e,{onDone:this._onVerifiedDoneClick})}_renderPhaseCancelled(){const e=d.getComponent("views.verification.VerificationCancelled");return o.a.createElement(e,{onDone:this._onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this._renderPhaseStart();break;case 1:e=this._renderPhaseShowSas();break;case 2:e=this._renderPhaseWaitForPartnerToConfirm();break;case 3:e=this._renderPhaseVerified();break;case 4:e=this._renderPhaseCancelled()}const t=d.getComponent("dialogs.BaseDialog");return o.a.createElement(t,{title:Object(c.a)("Incoming Verification Request"),onFinished:this._onFinished,fixedWidth:!1},e)}}g()(jc,"propTypes",{verifier:re.a.object.isRequired});var Pc=s(538),Dc=s(440),Ac=s(437);class Uc extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{authError:null,uiaStage:null,uiaStagePhase:null}),g()(this,"_onAuthFinished",(e,t)=>{e?this.props.onFinished(!0,t):t===Ee?this.props.onFinished(!1,null):this.setState({authError:t})}),g()(this,"_onUpdateStagePhase",(e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})}),g()(this,"_onDismissClick",()=>{this.props.onFinished(!1)})}_getDefaultDialogAesthetics(){const e={[be.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[be.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm to continue"),body:Object(c.a)("Click the button below to confirm your identity."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}};return{[be.c.LOGIN_TYPE]:e,[be.c.UNSTABLE_LOGIN_TYPE]:e}}render(){const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("views.dialogs.BaseDialog");let s=this.state.authError?"Error":this.props.title||Object(c.a)("Authentication"),n=this.state.authError?null:this.props.body,i=null,r=null;const a=this.props.aestheticsForStagePhases||this._getDefaultDialogAesthetics();if(!this.state.authError&&a&&a[this.state.uiaStage]){const e=a[this.state.uiaStage][this.state.uiaStagePhase];e&&e.title&&(s=e.title),e&&e.body&&(n=e.body),e&&e.continueText&&(i=e.continueText),e&&e.continueKind&&(r=e.continueKind)}let l;return l=this.state.authError?o.a.createElement("div",{id:"mx_Dialog_content"},o.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),o.a.createElement("br",null),o.a.createElement(Z.a,{onClick:this._onDismissClick,className:"mx_GeneralButton",autoFocus:"true"},Object(c.a)("Dismiss"))):o.a.createElement("div",{id:"mx_Dialog_content"},n,o.a.createElement(e,{ref:this._collectInteractiveAuth,matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this._onAuthFinished,onStagePhaseChange:this._onUpdateStagePhase,continueText:i,continueKind:r})),o.a.createElement(t,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:s,contentId:"mx_Dialog_content"},l)}}g()(Uc,"propTypes",{matrixClient:re.a.object.isRequired,authData:re.a.shape({flows:re.a.array,params:re.a.object,session:re.a.string}),makeRequest:re.a.func.isRequired,onFinished:re.a.func.isRequired,title:re.a.string,body:re.a.string,aestheticsForStagePhases:re.a.object});var Mc=s(366);function Lc({failures:e,source:t,continuation:s,onFinished:n}){const r=d.getComponent("dialogs.BaseDialog"),a=d.getComponent("views.elements.DialogButtons"),u=d.getComponent("elements.Spinner"),[h,m]=Object(i.useState)(2),[p,g]=Object(i.useState)(!1),[f,_]=Object(i.useState)(!1),[v,y]=Object(i.useState)(!1),b=Object(i.useRef)(n),E=new Map([["_afterCrossSigningLocalKeyChange",Object(c.a)("a new master key signature")],["checkOwnCrossSigningTrust",Object(c.a)("a new cross-signing key signature")],["setDeviceVerification",Object(c.a)("a device cross-signing signature")]]),S=Object(c.a)("a key signature"),w=Object(i.useCallback)(async()=>{try{_(!0);const e=new Promise((e,t)=>{b.current=t}).finally(()=>{g(!0)});await Promise.race([s(),e]),y(!0)}catch(e){m(e=>e-1)}finally{b.current=n,_(!1)}},[s,n]);let C;if(!v&&!p&&s&&h>0){const s=E.get(t)||S,n=l.a.get().brand;C=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("%(brand)s encountered an error during upload of:",{brand:n})),o.a.createElement("p",null,s),f&&o.a.createElement(u,null),o.a.createElement("pre",null,JSON.stringify(e,null,2)),o.a.createElement(a,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:w,onCancel:b.current,primaryDisabled:f}))}else C=o.a.createElement("div",null,v?o.a.createElement("span",null,Object(c.a)("Upload completed")):p?o.a.createElement("span",null,Object(c.a)("Cancelled signature upload")):o.a.createElement("span",null,Object(c.a)("Unable to upload")),o.a.createElement(a,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:n}));return o.a.createElement(r,{title:v?Object(c.a)("Signature upload success"):Object(c.a)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},C)}var Fc=e=>{const t=l.a.get().brand,s=Object(c.a)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(c.a)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return o.a.createElement(Ot.a,{hasCancelButton:!1,title:Object(c.a)("Incompatible local cache"),description:o.a.createElement("div",null,o.a.createElement("p",null,s),o.a.createElement("p",null,n)),button:Object(c.a)("Clear cache and resync"),onFinished:e.onFinished})},Bc=e=>{const t=l.a.get().brand,s=Object(c.a)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return o.a.createElement(Ot.a,{hasCancelButton:!1,title:Object(c.a)("Updating %(brand)s",{brand:t}),description:o.a.createElement("div",null,s),button:Object(c.a)("OK"),onFinished:e.onFinished})};class Vc extends o.a.Component{constructor(...e){super(...e),g()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),g()(this,"_onLegacyFinished",e=>{e&&L.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)})}render(){const e=d.getComponent("dialogs.QuestionDialog");let t;t=L.a.get().getUserId()===this.props.userId?Object(c.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(c.a)("Confirm this user's session by comparing the following with their User Settings:");const s=T.e(this.props.device.getFingerprint()),n=o.a.createElement("div",null,o.a.createElement("p",null,t),o.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},o.a.createElement("ul",null,o.a.createElement("li",null,o.a.createElement("label",null,Object(c.a)("Session name"),":")," ",o.a.createElement("span",null,this.props.device.getDisplayName())),o.a.createElement("li",null,o.a.createElement("label",null,Object(c.a)("Session ID"),":")," ",o.a.createElement("span",null,o.a.createElement("code",null,this.props.device.deviceId))),o.a.createElement("li",null,o.a.createElement("label",null,Object(c.a)("Session key"),":")," ",o.a.createElement("span",null,o.a.createElement("code",null,o.a.createElement("b",null,s)))))),o.a.createElement("p",null,Object(c.a)("If they don't match, the security of your communication may be compromised.")));return o.a.createElement(e,{title:Object(c.a)("Verify session"),description:n,button:Object(c.a)("Verify session"),onFinished:this._onLegacyFinished})}}g()(Vc,"propTypes",{userId:re.a.string.isRequired,device:re.a.object.isRequired,onFinished:re.a.func.isRequired});class Kc extends o.a.PureComponent{constructor(e){super(e),g()(this,"loadMoreEdits",async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},s=this.props.mxEvent.getRoomId(),n=this.props.mxEvent.getId(),i=L.a.get();let o,r,a;const c=new Promise((e,t)=>{r=e,a=t});try{o=await i.relations(s,n,"m.replace","m.room.message",t)}catch(e){return e.errcode&&console.error("fetching /relations failed with error",e),this.setState({error:e},()=>a(e)),c}const l=o.events;return this._locallyRedactEventsIfNeeded(l),this.setState({originalEvent:this.state.originalEvent||o.originalEvent,events:this.state.events.concat(l),nextBatch:o.nextBatch,isLoading:!1},()=>{const e=!!this.state.nextBatch;r(e)}),c}),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:w.a.getValue("showTwelveHourTimestamps")}}_locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),s=L.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=s.find(e=>"m.room.redaction"===e.getType()&&e.getAssociatedId()===t.getId());e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}_renderEdits(){const e=d.getComponent("messages.EditHistoryMessage"),t=d.getComponent("messages.DateSeparator"),s=[];let n,i=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(i=i.concat(this.state.originalEvent));const r=this.props.mxEvent.getId();return i.forEach((a,c)=>{n&&!Object(mr.e)(n.getDate(),a.getDate())||s.push(o.a.createElement("li",{key:a.getTs()+"~"},o.a.createElement(t,{ts:a.getTs()})));const l=a.getId()===r;s.push(o.a.createElement(e,{key:a.getId(),previousEdit:l?null:i[c+1],isBaseEvent:l,mxEvent:a,isTwelveHour:this.state.isTwelveHour})),n=a}),s}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?o.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?o.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Something went wrong!")):o.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Cannot reach homeserver"),o.a.createElement("br",null),Object(c.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else if(this.state.isLoading){const t=d.getComponent("elements.Spinner");e=o.a.createElement(t,null)}else{const t=d.getComponent("structures.ScrollPanel");e=o.a.createElement(t,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},o.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits mx_MessagePanel_alwaysShowTimestamps"},this._renderEdits()))}const t=d.getComponent("views.dialogs.BaseDialog");return o.a.createElement(t,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Message edits")},e)}}g()(Kc,"propTypes",{mxEvent:re.a.object.isRequired});var qc=s(477),Gc=s(1108),Wc=s.n(Gc);const Hc=["sub","sup","del","u"],$c=["text","softbreak","linebreak","paragraph","document"];function zc(e){const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return Hc.indexOf(e)>-1}return!1}function Yc(e){zc(e)?this.lit(e.literal):this.lit(Object(jt.escape)(e.literal))}function Jc(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}class Qc{constructor(e){this.input=e;const t=new Wc.a.Parser;this.parsed=t.parse(this.input)}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!($c.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(zc(e))return!1}}return!0}toHTML({externalLinks:e=!1}={}){const t=new Wc.a.HtmlRenderer({safe:!1,softbreak:"<br />"}),s=t.paragraph;return t.paragraph=function(e,t){Jc(e)&&s.call(this,e,t)},t.link=function(t,s){const n=this.attrs(t);s?(n.push(["href",this.esc(t.destination)]),t.title&&n.push(["title",this.esc(t.title)]),e&&(n.push(["target","_blank"]),n.push(["rel","noreferrer noopener"])),this.tag("a",n)):this.tag("/a")},t.html_inline=Yc,t.html_block=function(e){Yc.call(this,e)},t.render(this.parsed)}toPlaintext(){const e=new Wc.a.HtmlRenderer({safe:!1});e.paragraph;return e.paragraph=function(e,t){Jc(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),Jc(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}class Xc extends i.PureComponent{constructor(e){super(e),g()(this,"_onReasonChange",({target:{value:e}})=>{this.setState({reason:e})}),g()(this,"_onCancel",()=>{this.props.onFinished(!1)}),g()(this,"_onSubmit",async()=>{if(this.state.reason&&this.state.reason.trim()){this.setState({busy:!0,err:null});try{const e=this.props.mxEvent;await L.a.get().reportEvent(e.getRoomId(),e.getId(),-100,this.state.reason.trim()),this.props.onFinished(!0)}catch(e){this.setState({busy:!1,err:e.message})}}else this.setState({err:Object(c.a)("Please fill why you're reporting.")})}),this.state={reason:"",busy:!1,err:null}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.Spinner"),n=d.getComponent("elements.Field");let i=null;this.state.err&&(i=o.a.createElement("div",{className:"error"},this.state.err));let r=null;this.state.busy&&(r=o.a.createElement("div",{className:"progress"},o.a.createElement(s,null)));const a=l.a.get().reportEvent&&l.a.get().reportEvent.adminMessageMD;let u;if(a){const e=new Qc(a).toHTML({externalLinks:!0});u=o.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}return o.a.createElement(e,{className:"mx_BugReportDialog",onFinished:this.props.onFinished,title:Object(c.a)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},o.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},o.a.createElement("p",null,Object(c.a)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),u,o.a.createElement(n,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(c.a)("Reason"),rows:5,onChange:this._onReasonChange,value:this.state.reason,disabled:this.state.busy}),r,i),o.a.createElement(t,{primaryButton:Object(c.a)("Send report"),onPrimaryButtonClick:this._onSubmit,focus:!0,onCancel:this._onCancel,disabled:this.state.busy}))}}function Zc(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}g()(Xc,"propTypes",{mxEvent:re.a.instanceOf(de.i).isRequired,onFinished:re.a.func.isRequired});class el extends o.a.Component{constructor(e){super(e),g()(this,"_upgradeRoom",e=>{const t=d.getComponent("dialogs.RoomUpgradeDialog"),s=L.a.get().getRoom(this.props.roomId);ke.a.createTrackedDialog("Upgrade Room Version","",t,{room:s})}),g()(this,"_openDevtools",e=>{const t=d.getComponent("dialogs.DevtoolsDialog");ke.a.createDialog(t,{roomId:this.props.roomId})}),g()(this,"_onOldRoomClicked",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_room",room_id:this.state.oldRoomId,event_id:this.state.oldEventId}),this.props.closeSettingsFn()}),this.state={upgradeRecommendation:null}}UNSAFE_componentWillMount(){const e=L.a.get().getRoom(this.props.roomId);e.getRecommendedVersion().then(t=>{const s=e.currentState.getStateEvents("m.room.tombstone",""),n={},i=e.currentState.getStateEvents("m.room.create",""),o=i?i.getContent().predecessor:null;o&&o.room_id&&(n.oldRoomId=o.room_id,n.oldEventId=o.event_id,n.hasPreviousRoom=!0),this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Zc(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Zc(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({upgraded:s&&s.getContent().replacement_room,upgradeRecommendation:t},n))})}render(){const e=L.a.get().getRoom(this.props.roomId);let t;const s=e.currentState.getStateEvents("m.room.create","");let n,i;if(s&&!1===s.getContent()["m.federate"]&&(t=o.a.createElement("div",null,Object(c.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(n=o.a.createElement("div",null,o.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(c.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>o.a.createElement("b",null,e),i:e=>o.a.createElement("i",null,e)})),o.a.createElement(Z.a,{onClick:this._upgradeRoom,kind:"primary"},Object(c.a)("Upgrade this room to the recommended room version")))),this.state.hasPreviousRoom){let e=Object(c.a)("this room");const t=L.a.get().getRoom(this.props.roomId);t&&t.name&&(e=t.name),i=o.a.createElement(Z.a,{element:"a",onClick:this._onOldRoomClicked},Object(c.a)("View older messages in %(roomName)s.",{roomName:e}))}return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room information")),o.a.createElement("div",null,o.a.createElement("span",null,Object(c.a)("Internal room ID:"))," ",this.props.roomId),t),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room version")),o.a.createElement("div",null,o.a.createElement("span",null,Object(c.a)("Room version:"))," ",e.getVersion()),i,n),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Developer options")),o.a.createElement(Z.a,{onClick:this._openDevtools,kind:"primary"},Object(c.a)("Open Devtools"))))}}g()(el,"propTypes",{roomId:re.a.string.isRequired,closeSettingsFn:re.a.func.isRequired});const tl={"m.room.avatar":Object(c.b)("Change room avatar"),"m.room.name":Object(c.b)("Change room name"),"m.room.canonical_alias":Object(c.b)("Change main address for the room"),"m.room.history_visibility":Object(c.b)("Change history visibility"),"m.room.power_levels":Object(c.b)("Change permissions"),"m.room.topic":Object(c.b)("Change topic"),"m.room.tombstone":Object(c.b)("Upgrade the room"),"m.room.encryption":Object(c.b)("Enable room encryption"),"im.vector.modular.widgets":Object(c.b)("Modify widgets")},sl={"m.room.avatar":{isState:!0},"m.room.name":{isState:!0},"m.room.canonical_alias":{isState:!0},"m.room.history_visibility":{isState:!0},"m.room.power_levels":{isState:!0},"m.room.topic":{isState:!0},"m.room.tombstone":{isState:!0},"m.room.encryption":{isState:!0},"im.vector.modular.widgets":{isState:!0}};function nl(e,t){const s=parseInt(e);return isNaN(s)?t:s}class il extends o.a.Component{constructor(...e){super(...e),g()(this,"_onUnbanClick",e=>{L.a.get().unban(this.props.member.roomId,this.props.member.userId).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to unban: "+e),ke.a.createTrackedDialog("Failed to unban","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to unban")})})})}render(){let e;this.props.canUnban&&(e=o.a.createElement(Z.a,{kind:"danger_sm",onClick:this._onUnbanClick,className:"mx_RolesRoomSettingsTab_unbanBtn"},Object(c.a)("Unban")));const t=this.props.member.name===this.props.member.userId?null:this.props.member.userId;return o.a.createElement("li",null,e,o.a.createElement("span",{title:Object(c.a)("Banned by %(displayName)s",{displayName:this.props.by})},o.a.createElement("strong",null,this.props.member.name)," ",t,this.props.reason?" "+Object(c.a)("Reason")+": "+this.props.reason:""))}}g()(il,"propTypes",{canUnban:re.a.bool,member:re.a.object.isRequired,by:re.a.string.isRequired,reason:re.a.string});class ol extends o.a.Component{constructor(...e){super(...e),g()(this,"_onRoomMembership",(e,t,s)=>{t.roomId===this.props.roomId&&this.forceUpdate()}),g()(this,"_onPowerLevelsChanged",(e,t)=>{const s=L.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let i=n&&n.getContent()||{};i=Object.assign({},i);if(e=parseInt(e),t.startsWith("event_levels_"))i.events=Object.assign({},i.events||{}),i.events[t.slice("event_levels_".length)]=e;else{const s=t.split(".");let n,o=i;for(const e of s)o[e]||(o[e]={}),n=o,o=o[e];n[s[s.length-1]]=e}s.sendStateEvent(this.props.roomId,"m.room.power_levels",i).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Power level requirement change failed","",t,{title:Object(c.a)("Error changing power level requirement"),description:Object(c.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})})}),g()(this,"_onUserPowerLevelChanged",(e,t)=>{const s=L.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let i=n&&n.getContent()||{};i=Object.assign({},i),i.users||(i.users={}),i.users[t]=e,s.sendStateEvent(this.props.roomId,"m.room.power_levels",i).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Power level change failed","",t,{title:Object(c.a)("Error changing power level"),description:Object(c.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})})})}componentDidMount(){L.a.get().on("RoomState.members",this._onRoomMembership)}componentWillUnmount(){const e=L.a.get();e&&e.removeListener("RoomState.members",this._onRoomMembership)}_populateDefaultPlEvents(e,t,s){for(const n of Object.keys(sl))n in e||(e[n]=sl[n].isState?t:s)}render(){const e=d.getComponent("elements.PowerSelector"),t=L.a.get(),s=t.getRoom(this.props.roomId),n=s.currentState.getStateEvents("m.room.power_levels",""),i=n&&n.getContent()||{},r=s.currentState.mayClientSendStateEvent("m.room.power_levels",t),a={users_default:{desc:Object(c.a)("Default role"),defaultValue:0},events_default:{desc:Object(c.a)("Send messages"),defaultValue:0},invite:{desc:Object(c.a)("Invite users"),defaultValue:50},state_default:{desc:Object(c.a)("Change settings"),defaultValue:50},kick:{desc:Object(c.a)("Kick users"),defaultValue:50},ban:{desc:Object(c.a)("Ban users"),defaultValue:50},redact:{desc:Object(c.a)("Remove messages"),defaultValue:50},"notifications.room":{desc:Object(c.a)("Notify everyone"),defaultValue:50}},l=i.events||{},u=i.users||{},h=nl(i.ban,a.ban.defaultValue),m=nl(i.users_default,a.users_default.defaultValue);let p=u[t.getUserId()];void 0===p&&(p=m),this._populateDefaultPlEvents(l,nl(i.state_default,a.state_default.defaultValue),nl(i.events_default,a.events_default.defaultValue));let g,f=o.a.createElement("div",null,Object(c.a)("No users have specific privileges in this room"));if(Object.keys(u).length){const t=[],s=[];Object.keys(u).forEach(n=>{const i=u[n]<p&&r;u[n]>m?t.push(o.a.createElement(e,{value:u[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this._onUserPowerLevelChanged})):u[n]<m&&s.push(o.a.createElement(e,{value:u[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this._onUserPowerLevelChanged}))});const n=(e,t)=>{const s=u[t.key]-u[e.key];return 0!==s?s:e.key.toLocaleLowerCase().localeCompare(t.key.toLocaleLowerCase())};t.sort(n),s.sort(n),t.length&&(f=o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Privileged Users")),t)),s.length&&(g=o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Muted Users")),s))}const _=s.getMembersWithMembership("ban");let v;if(_.length){const e=p>=h;v=o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Banned users")),o.a.createElement("ul",null,_.map(t=>{const n=t.events.member.getContent(),i=s.getMember(t.events.member.getSender());let r=t.events.member.getSender();return i&&(r=i.name),o.a.createElement(il,{key:t.userId,canUnban:e,member:t,reason:n.reason,by:r})})))}const y=Object.keys(a).map((t,s)=>{const n=a[t],c=t.split(".");let l=i;for(const e of c){if(void 0===l)break;l=l[e]}const d=nl(l,n.defaultValue);return o.a.createElement("div",{key:s,className:""},o.a.createElement(e,{label:n.desc,value:d,usersDefault:m,disabled:!r||p<d,powerLevelKey:t,onChange:this._onPowerLevelsChanged}))});t.isRoomEncrypted(this.props.roomId)&&delete l["m.room.encryption"];const b=Object.keys(l).map((t,s)=>{let n=tl[t];return n=n?Object(c.a)(n):Object(c.a)("Send %(eventType)s events",{eventType:t}),o.a.createElement("div",{className:"",key:t},o.a.createElement(e,{label:n,value:l[t],usersDefault:m,disabled:!r||p<l[t],powerLevelKey:"event_levels_"+t,onChange:this._onPowerLevelsChanged}))});return o.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Roles & Permissions")),f,g,v,o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Permissions")),o.a.createElement("p",null,Object(c.a)("Select the roles required to change various parts of the room")),y,b))}}g()(ol,"propTypes",{roomId:re.a.string.isRequired});class rl extends o.a.Component{constructor(e){super(e),g()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),g()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:void 0,avatarFile:void 0,enableProfileSave:!0})}),g()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=L.a.get(),s={};if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,this.state.displayName),s.originalDisplayName=this.state.displayName),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),s.avatarUrl=t.mxcUrlToHttp(e,96,96,"crop",!1),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:void 0},"");this.state.originalTopic!==this.state.topic&&(await t.setRoomTopic(this.props.roomId,this.state.topic),s.originalTopic=this.state.topic),this.setState(s)}),g()(this,"_onDisplayNameChanged",e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})}),g()(this,"_onTopicChanged",e=>{this.setState({topic:e.target.value,enableProfileSave:!0})}),g()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const t=L.a.get(),s=t.getRoom(e.roomId);if(!s)throw new Error("Expected a room for ID: ",e.roomId);const n=s.currentState.getStateEvents("m.room.avatar","");let o=n&&n.getContent()?n.getContent().url:null;o&&(o=t.mxcUrlToHttp(o,96,96,"crop",!1));const r=s.currentState.getStateEvents("m.room.topic",""),a=r&&r.getContent()?r.getContent().topic:"",c=s.currentState.getStateEvents("m.room.name",""),l=c&&c.getContent()?c.getContent().name:"";this.state={originalDisplayName:l,displayName:l,originalAvatarUrl:o,avatarUrl:o,avatarFile:null,originalTopic:a,topic:a,enableProfileSave:!1,canSetName:s.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:s.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:s.currentState.maySendStateEvent("m.room.avatar",t.getUserId())},this._avatarUpload=Object(i.createRef)()}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("settings.AvatarSetting");return o.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0},o.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),o.a.createElement("div",{className:"mx_ProfileSettings_profile"},o.a.createElement("div",{className:"mx_ProfileSettings_controls"},o.a.createElement(le.a,{label:Object(c.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this._onDisplayNameChanged,disabled:!this.state.canSetName}),o.a.createElement(le.a,{id:"profileTopic",label:Object(c.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this._onTopicChanged,element:"textarea"})),o.a.createElement(t,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(c.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this._uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this._removeAvatar:void 0})),o.a.createElement(e,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(c.a)("Save")))}}g()(rl,"propTypes",{roomId:re.a.string.isRequired});class al extends o.a.Component{constructor(){super(),g()(this,"_onLeaveClick",()=>{u.a.dispatch({action:"leave_room",room_id:this.props.roomId})}),this.state={isRoomPublished:!1}}render(){const e=d.getComponent("room_settings.AliasSettings"),t=d.getComponent("room_settings.RelatedGroupSettings"),s=d.getComponent("room_settings.UrlPreviewSettings"),n=this.context,i=n.getRoom(this.props.roomId),r=i.currentState.mayClientSendStateEvent("m.room.canonical_alias",n),a=i.currentState.getStateEvents("m.room.canonical_alias",""),l=i.currentState.getStateEvents("m.room.aliases"),u=i.currentState.mayClientSendStateEvent("m.room.related_groups",n),h=i.currentState.getStateEvents("m.room.related_groups","");return o.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("General")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},o.a.createElement(rl,{roomId:this.props.roomId})),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Room Addresses")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(e,{roomId:this.props.roomId,canSetCanonicalAlias:r,canSetAliases:!0,canonicalAliasEvent:a,aliasEvents:l})),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Other")),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Flair")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(t,{roomId:i.roomId,canSetRelatedGroups:u,relatedGroupsEvent:h})),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("URL Previews")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(s,{room:i})),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Leave room")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(Z.a,{kind:"danger",onClick:this._onLeaveClick},Object(c.a)("Leave room"))))}}g()(al,"propTypes",{roomId:re.a.string.isRequired}),g()(al,"contextType",S.a);class cl extends o.a.Component{constructor(){super(),g()(this,"_onStateEvent",e=>{["m.room.join_rules","m.room.guest_access","m.room.history_visibility","m.room.encryption"].includes(e.getType())&&this.forceUpdate()}),g()(this,"_onEncryptionChange",e=>{ke.a.createTrackedDialog("Enable encryption","",Ot.a,{title:Object(c.a)("Enable encryption?"),description:Object(c.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>o.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:"https://element.io/help#encryption"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),L.a.get().sendStateEvent(this.props.roomId,"m.room.encryption",{algorithm:"m.megolm.v1.aes-sha2"}).catch(e=>{console.error(e),this.setState({encrypted:t})})}})}),g()(this,"_fixGuestAccess",e=>{e.preventDefault(),e.stopPropagation();const t=this.state.joinRule,s=this.state.guestAccess;this.setState({joinRule:"invite",guestAccess:"can_join"});const n=L.a.get();n.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:"invite"},"").catch(e=>{console.error(e),this.setState({joinRule:t})}),n.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:"can_join"},"").catch(e=>{console.error(e),this.setState({guestAccess:s})})}),g()(this,"_onRoomAccessRadioToggle",e=>{let t="invite",s="can_join";switch(e){case"invite_only":break;case"public_no_guests":t="public",s="forbidden";break;case"public_with_guests":t="public",s="can_join"}const n=this.state.joinRule,i=this.state.guestAccess;this.setState({joinRule:t,guestAccess:s});const o=L.a.get();o.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:t},"").catch(e=>{console.error(e),this.setState({joinRule:n})}),o.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:s},"").catch(e=>{console.error(e),this.setState({guestAccess:i})})}),g()(this,"_onHistoryRadioToggle",e=>{const t=this.state.history;this.setState({history:e}),L.a.get().sendStateEvent(this.props.roomId,"m.room.history_visibility",{history_visibility:e},"").catch(e=>{console.error(e),this.setState({history:t})})}),g()(this,"_updateBlacklistDevicesFlag",e=>{L.a.get().getRoom(this.props.roomId).setBlacklistUnverifiedDevices(e)}),this.state={joinRule:"invite",guestAccess:"can_join",history:"shared",hasAliases:!1,encrypted:!1}}async UNSAFE_componentWillMount(){L.a.get().on("RoomState.events",this._onStateEvent);const e=L.a.get().getRoom(this.props.roomId).currentState,t=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.join_rules",""),"join_rule","invite"),s=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.guest_access",""),"guest_access","forbidden"),n=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.history_visibility",""),"history_visibility","shared"),i=L.a.get().isRoomEncrypted(this.props.roomId);this.setState({joinRule:t,guestAccess:s,history:n,encrypted:i});const o=await this._hasAliases();this.setState({hasAliases:o})}_pullContentPropertyFromEvent(e,t,s){return e&&e.getContent()&&e.getContent()[t]||s}componentWillUnmount(){L.a.get().removeListener("RoomState.events",this._onStateEvent)}async _hasAliases(){const e=L.a.get();if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const t=(await e.unstableGetLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}return!!(e.getRoom(this.props.roomId).currentState.getStateEvents("m.room.aliases")||[]).find(e=>(e.getContent().aliases||[]).length>0)}_renderRoomAccess(){const e=L.a.get(),t=e.getRoom(this.props.roomId),n=this.state.joinRule,i=this.state.guestAccess,r=t.currentState.mayClientSendStateEvent("m.room.join_rules",e)&&t.currentState.mayClientSendStateEvent("m.room.guest_access",e);let a=null;"public"!==n&&"forbidden"===i&&(a=o.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},o.a.createElement("img",{src:s(184),width:15,height:15}),o.a.createElement("span",null,Object(c.a)("Guests cannot join this room even if explicitly invited.")," ",o.a.createElement("a",{href:"",onClick:this._fixGuestAccess},Object(c.a)("Click here to fix")))));let l=null;return"public"!==n||this.state.hasAliases||(l=o.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},o.a.createElement("img",{src:s(184),width:15,height:15}),o.a.createElement("span",null,Object(c.a)("To link to this room, please add an address.")))),o.a.createElement("div",null,a,l,o.a.createElement(Ye,{name:"roomVis",value:n,onChange:this._onRoomAccessRadioToggle,definitions:[{value:"invite_only",disabled:!r,label:Object(c.a)("Only people who have been invited"),checked:"public"!==n},{value:"public_no_guests",disabled:!r,label:Object(c.a)("Anyone who knows the room's link, apart from guests"),checked:"public"===n&&"can_join"!==i},{value:"public_with_guests",disabled:!r,label:Object(c.a)("Anyone who knows the room's link, including guests"),checked:"public"===n&&"can_join"===i}]}))}_renderHistory(){const e=L.a.get(),t=this.state.history,s=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent("m.room.history_visibility",e);return o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.")),o.a.createElement(Ye,{name:"historyVis",value:t,onChange:this._onHistoryRadioToggle,definitions:[{value:"world_readable",disabled:!s,label:Object(c.a)("Anyone")},{value:"shared",disabled:!s,label:Object(c.a)("Members only (since the point in time of selecting this option)")},{value:"invited",disabled:!s,label:Object(c.a)("Members only (since they were invited)")},{value:"joined",disabled:!s,label:Object(c.a)("Members only (since they joined)")}]}))}render(){const e=d.getComponent("elements.SettingsFlag"),t=L.a.get(),s=t.getRoom(this.props.roomId),n=this.state.encrypted,i=s.currentState.mayClientSendStateEvent("m.room.encryption",t),r=!n&&i;let a=null;return n&&(a=o.a.createElement(e,{name:"blacklistUnverifiedDevices",level:je.a.ROOM_DEVICE,onChange:this._updateBlacklistDevicesFlag,roomId:this.props.roomId})),o.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Security & Privacy")),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Encryption")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityRoomSettingsTab_encryptionSection"},o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",null,Object(c.a)("Once enabled, encryption cannot be disabled."))),o.a.createElement(De.a,{value:n,onChange:this._onEncryptionChange,label:Object(c.a)("Encrypted"),disabled:!r})),a),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Who can access this room?")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this._renderRoomAccess()),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Who can read history?")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this._renderHistory()))}}g()(cl,"propTypes",{roomId:re.a.string.isRequired});var ll=s(214);class dl extends o.a.Component{constructor(){super(),g()(this,"_soundUpload",Object(i.createRef)()),this.state={currentSound:"default",uploadedFile:null}}UNSAFE_componentWillMount(){const e=ll.default.getSoundForRoom(this.props.roomId);e&&this.setState({currentSound:e.name||e.url})}async _triggerUploader(e){e.stopPropagation(),e.preventDefault(),this._soundUpload.current.click()}async _onSoundUploadChanged(e){if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})}async _onClickSaveSound(e){e.stopPropagation(),e.preventDefault();try{await this._saveSound()}catch(e){console.error("Unable to save notification sound for "+this.props.roomId),console.error(e)}}async _saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const t=await L.a.get().uploadContent(this.state.uploadedFile,{type:e});await w.a.setValue("notificationSound",this.props.roomId,je.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}_clearSound(e){e.stopPropagation(),e.preventDefault(),w.a.setValue("notificationSound",this.props.roomId,je.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})}render(){let e=null;return this.state.uploadedFile&&(e=o.a.createElement("div",null,o.a.createElement("span",null,Object(c.a)("Uploaded sound"),": ",o.a.createElement("code",null,this.state.uploadedFile.name)))),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Notifications")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Sounds")),o.a.createElement("div",null,o.a.createElement("span",null,Object(c.a)("Notification sound"),": ",o.a.createElement("code",null,this.state.currentSound)),o.a.createElement("br",null),o.a.createElement(Z.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this._clearSound.bind(this),kind:"primary"},Object(c.a)("Reset"))),o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Set a new custom sound")),o.a.createElement("form",{autoComplete:"off",noValidate:!0},o.a.createElement("input",{ref:this._soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onChange:this._onSoundUploadChanged.bind(this),accept:"audio/*"})),e,o.a.createElement(Z.a,{className:"mx_NotificationSound_browse",onClick:this._triggerUploader.bind(this),kind:"primary"},Object(c.a)("Browse")),o.a.createElement(Z.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this._onClickSaveSound.bind(this),kind:"primary"},Object(c.a)("Save")),o.a.createElement("br",null))))}}g()(dl,"propTypes",{roomId:re.a.string.isRequired});class ul extends o.a.Component{constructor(...e){super(...e),g()(this,"_onAction",e=>{"view_next_room"===e.action&&this.props.onFinished()})}componentDidMount(){this._dispatcherRef=u.a.register(this._onAction)}componentWillUnmount(){this._dispatcherRef&&u.a.unregister(this._dispatcherRef)}_getTabs(){const e=[];return e.push(new ae("ROOM_GENERAL_TAB",Object(c.b)("General"),"mx_RoomSettingsDialog_settingsIcon",o.a.createElement(al,{roomId:this.props.roomId}))),e.push(new ae("ROOM_SECURITY_TAB",Object(c.b)("Security & Privacy"),"mx_RoomSettingsDialog_securityIcon",o.a.createElement(cl,{roomId:this.props.roomId}))),e.push(new ae("ROOM_ROLES_TAB",Object(c.b)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",o.a.createElement(ol,{roomId:this.props.roomId}))),e.push(new ae("ROOM_NOTIFICATIONS_TAB",Object(c.b)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",o.a.createElement(dl,{roomId:this.props.roomId}))),w.a.getValue("feature_bridge_state")&&e.push(new ae("ROOM_BRIDGES_TAB",Object(c.b)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",o.a.createElement(Bo,{roomId:this.props.roomId}))),e.push(new ae("ROOM_ADVANCED_TAB",Object(c.b)("Advanced"),"mx_RoomSettingsDialog_warningIcon",o.a.createElement(el,{roomId:this.props.roomId,closeSettingsFn:this.props.onFinished}))),e}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=L.a.get().getRoom(this.props.roomId).name;return o.a.createElement(e,{className:"mx_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Room Settings - %(roomName)s",{roomName:t})},o.a.createElement("div",{className:"ms_SettingsDialog_content"},o.a.createElement(ce,{tabs:this._getTabs()})))}}g()(ul,"propTypes",{roomId:re.a.string.isRequired,onFinished:re.a.func.isRequired});class hl extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{busy:!0}),g()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),g()(this,"_onUpgradeClick",()=>{this.setState({busy:!0}),L.a.get().upgradeRoom(this.props.room.roomId,this._targetVersion).then(()=>{this.props.onFinished(!0)}).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to upgrade room","",t,{title:Object(c.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(c.a)("The room upgrade could not be completed")})}).finally(()=>{this.setState({busy:!1})})})}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this._targetVersion=e.version,this.setState({busy:!1})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.elements.Spinner");let n;return n=this.state.busy?o.a.createElement(s,null):o.a.createElement(t,{primaryButton:Object(c.a)("Upgrade this room to version %(version)s",{version:this._targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this._onUpgradeClick,focus:this.props.focus,onCancel:this._onCancelClick}),o.a.createElement(e,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(c.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},o.a.createElement("p",null,Object(c.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),o.a.createElement("ol",null,o.a.createElement("li",null,Object(c.a)("Create a new room with the same name, description and avatar")),o.a.createElement("li",null,Object(c.a)("Update any local room aliases to point to the new room")),o.a.createElement("li",null,Object(c.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),o.a.createElement("li",null,Object(c.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),n)}}g()(hl,"propTypes",{room:re.a.object.isRequired,onFinished:re.a.func.isRequired});class ml extends o.a.Component{constructor(e){super(e),g()(this,"_onContinue",()=>{this.props.onFinished({continue:!0,invite:this.state.isPrivate&&this.state.inviteUsersToNewRoom})}),g()(this,"_onCancel",()=>{this.props.onFinished({continue:!1,invite:!1})}),g()(this,"_onInviteUsersToggle",e=>{this.setState({inviteUsersToNewRoom:e})}),g()(this,"_openBugReportDialog",e=>{e.preventDefault(),e.stopPropagation();const t=d.getComponent("dialogs.BugReportDialog");ke.a.createTrackedDialog("Bug Report Dialog","",t,{})});const t=L.a.get().getRoom(this.props.roomId),s=t?t.currentState.getStateEvents("m.room.join_rules",""):null,n=!s||"public"!==s.getContent().join_rule;this.state={currentVersion:t?t.getVersion():"1",isPrivate:n,inviteUsersToNewRoom:!0}}render(){const e=l.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons");let n=null;this.state.isPrivate&&(n=o.a.createElement(De.a,{value:this.state.inviteUsersToNewRoom,onChange:this._onInviteUsersToggle,label:Object(c.a)("Automatically invite users")}));const i=this.state.isPrivate?Object(c.a)("Upgrade private room"):Object(c.a)("Upgrade public room");return o.a.createElement(t,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:i},o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),o.a.createElement("p",null,Object(c.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>o.a.createElement("a",{href:"#",onClick:this._openBugReportDialog},e)})),o.a.createElement("p",null,Object(c.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>o.a.createElement("code",null,this.state.currentVersion),newVersion:()=>o.a.createElement("code",null,this.props.targetVersion)})),n),o.a.createElement(s,{primaryButton:Object(c.a)("Upgrade"),onPrimaryButtonClick:this._onContinue,cancelButton:Object(c.a)("Cancel"),onCancel:this._onCancel}))}}g()(ml,"propTypes",{onFinished:re.a.func.isRequired,roomId:re.a.string.isRequired,targetVersion:re.a.string.isRequired});class pl extends o.a.Component{constructor(...e){super(...e),g()(this,"_sendBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");ke.a.createTrackedDialog("Session Restore Error","Send Bug Report Dialog",e,{})}),g()(this,"_onClearStorageClick",()=>{const e=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Session Restore Confirm Logout","",e,{title:Object(c.a)("Sign out"),description:o.a.createElement("div",null,Object(c.a)("Sign out and remove encryption keys?")),button:Object(c.a)("Sign out"),danger:!0,onFinished:this.props.onFinished})}),g()(this,"_onRefreshClick",()=>{window.location.reload(!0)})}render(){const e=l.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons"),n=o.a.createElement("button",{onClick:this._onClearStorageClick,className:"danger"},Object(c.a)("Clear Storage and Sign Out"));let i;return i=l.a.get().bug_report_endpoint_url?o.a.createElement(s,{primaryButton:Object(c.a)("Send Logs"),onPrimaryButtonClick:this._sendBugReport,focus:!0,hasCancel:!1},n):o.a.createElement(s,{primaryButton:Object(c.a)("Refresh"),onPrimaryButtonClick:this._onRefreshClick,focus:!0,hasCancel:!1},n),o.a.createElement(t,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.a)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("We encountered an error trying to restore your previous session.")),o.a.createElement("p",null,Object(c.a)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),o.a.createElement("p",null,Object(c.a)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),i)}}function gl(){return L.a.get().idBaseUrl.split("://")[1]}g()(pl,"propTypes",{error:re.a.string.isRequired,onFinished:re.a.func.isRequired});class fl{constructor(){g()(this,"_makeAddThreepidOnlyRequest",e=>L.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e})),this.clientSecret=L.a.get().generateClientSecret(),this.sessionId=null,this.submitUrl=null}addEmailAddress(e){return L.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindEmailAddress(e){if(this.bind=!0,await L.a.get().doesServerSupportSeparateAddAndBind()){const t=new Oe.a,s=await t.getAccessToken();return L.a.get().requestEmailToken(e,this.clientSecret,1,void 0,void 0,s).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addEmailAddress(e)}addMsisdn(e,t){return L.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1).then(e=>(this.sessionId=e.sid,this.submitUrl=e.submit_url,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindMsisdn(e,t){if(this.bind=!0,await L.a.get().doesServerSupportSeparateAddAndBind()){const s=new Oe.a,n=await s.getAccessToken();return L.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,void 0,n).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addMsisdn(e,t)}async checkEmailLinkClicked(){try{if(await L.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new Oe.a,t=await e.getAccessToken();await L.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:gl(),id_access_token:t})}else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[be.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[be.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding email"),body:Object(c.a)("Click the button below to confirm adding this email address."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:n}=ke.a.createTrackedDialog("Add Email","",t,{title:Object(c.a)("Add Email Address"),matrixClient:L.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[be.c.LOGIN_TYPE]:s,[be.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await L.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:gl()},this.bind)}catch(e){throw 401===e.httpStatus?e.message=Object(c.a)("Failed to verify email address: make sure you clicked the link in the email"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}async haveMsisdnToken(e){const t=new Oe.a,s=await L.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await L.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&s)throw new Error("The add / bind with MSISDN flow is misconfigured");n=await L.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(s)if(this.bind)await L.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:gl(),id_access_token:await t.getAccessToken()});else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[be.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[be.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding phone number"),body:Object(c.a)("Click the button below to confirm adding this phone number."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:n}=ke.a.createTrackedDialog("Add MSISDN","",t,{title:Object(c.a)("Add Phone Number"),matrixClient:L.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[be.c.LOGIN_TYPE]:s,[be.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await L.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:gl()},this.bind)}}class _l extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{emailAddress:"",emailBusy:!1}),g()(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),g()(this,"onSubmit",()=>{const e=d.getComponent("dialogs.ErrorDialog"),t=d.getComponent("dialogs.QuestionDialog"),s=this.state.emailAddress;Ga.a(s)?(this._addThreepid=new fl,this._addThreepid.addEmailAddress(s).then(()=>{ke.a.createTrackedDialog("Verification Pending","",t,{title:Object(c.a)("Verification Pending"),description:Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})},t=>{this.setState({emailBusy:!1}),console.error("Unable to add email address "+s+" "+t),ke.a.createTrackedDialog("Unable to add email address","",e,{title:Object(c.a)("Unable to add email address"),description:t&&t.message?t.message:Object(c.a)("Operation failed")})}),this.setState({emailBusy:!0})):ke.a.createTrackedDialog("Invalid Email Address","",e,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")})}),g()(this,"onCancelled",()=>{this.props.onFinished(!1)}),g()(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})}verifyEmailAddress(){this._addThreepid.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{if(this.setState({emailBusy:!1}),"M_THREEPID_AUTH_FAILED"==e.errcode){const e=d.getComponent("dialogs.QuestionDialog"),t=Object(c.a)("Unable to verify email address.")+" "+Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue.");ke.a.createTrackedDialog("Verification Pending","3pid Auth Failed",e,{title:Object(c.a)("Verification Pending"),description:t,button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})}else{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify email address: "+e),ke.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner"),s=d.getComponent("elements.EditableText"),n=this.state.emailBusy?o.a.createElement(t,null):o.a.createElement(s,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",autoFocus:"true",placeholder:Object(c.a)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return o.a.createElement(e,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",{id:"mx_Dialog_content"},Object(c.a)("This will allow you to reset your password and receive notifications.")),n),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(c.a)("Continue"),onClick:this.onSubmit}),o.a.createElement("input",{type:"submit",value:Object(c.a)("Skip"),onClick:this.onCancelled})))}}g()(_l,"propTypes",{onFinished:re.a.func.isRequired});class vl extends o.a.Component{constructor(e){super(e),g()(this,"onValueChange",e=>{this.setState({username:e.target.value,usernameBusy:!0,usernameError:""},()=>{this.state.username&&this.state.usernameCheckSupport?(this._usernameCheckTimeout&&clearTimeout(this._usernameCheckTimeout),this._usernameCheckTimeout=setTimeout(()=>{this._doUsernameCheck().finally(()=>{this.setState({usernameBusy:!1})})},250)):this.setState({usernameBusy:!1})})}),g()(this,"onKeyUp",e=>{e.key===Yt.a.ENTER&&this.onSubmit()}),g()(this,"onSubmit",e=>{this._uiAuth.current&&this._uiAuth.current.tryContinue(),this.setState({doingUIAuth:!0})}),g()(this,"_makeRegisterRequest",e=>(this._generatedPassword||(this._generatedPassword=this._generatePassword()),this._matrixClient.register(this.state.username,this._generatedPassword,void 0,e,{},null))),g()(this,"_onUIAuthFinished",(e,t)=>{this.setState({doingUIAuth:!1}),e?this.props.onFinished(!0,{userId:t.user_id,deviceId:t.device_id,homeserverUrl:this._matrixClient.getHomeserverUrl(),identityServerUrl:this._matrixClient.getIdentityServerUrl(),accessToken:t.access_token,password:this._generatedPassword}):this.setState({authError:t.message})}),this._input_value=Object(i.createRef)(),this._uiAuth=Object(i.createRef)(),this.state={username:"",usernameBusy:!1,usernameError:"",usernameCheckSupport:!0,doingUIAuth:!1,authError:""}}componentDidMount(){this._input_value.current.select(),this._matrixClient=L.a.get()}_doUsernameCheck(){return Wa.a.test(this.state.username)?this._matrixClient.isUsernameAvailable(this.state.username).then(e=>{e&&this.setState({usernameError:""})},e=>{const t={usernameCheckSupport:"M_UNRECOGNIZED"!==e.errcode};switch(console.error("Error whilst checking username availability: ",e),e.errcode){case"M_USER_IN_USE":t.usernameError=Object(c.a)("Username not available");break;case"M_INVALID_USERNAME":t.usernameError=Object(c.a)("Username invalid: %(errMessage)s",{errMessage:e.message});break;case"M_UNRECOGNIZED":t.usernameError="";break;case void 0:t.usernameError=Object(c.a)("Something went wrong!");break;default:t.usernameError=Object(c.a)("An error occurred: %(error_string)s",{error_string:e.message})}this.setState(t)}):(this.setState({usernameError:Object(c.a)("A username can only contain lower case letters, numbers and '=_-./'")}),Promise.reject())}_generatePassword(){return Math.random().toString(36).slice(2)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("structures.InteractiveAuth");let s;this.state.doingUIAuth&&(s=o.a.createElement(t,{matrixClient:this._matrixClient,makeRequest:this._makeRegisterRequest,onAuthFinished:this._onUIAuthFinished,inputs:{},poll:!0,ref:this._uiAuth,continueIsManaged:!0}));const n=E()({mx_SetMxIdDialog_input:!0,error:Boolean(this.state.usernameError)});let i=null;if(this.state.usernameBusy)i=o.a.createElement("div",null,Object(c.a)("Checking..."));else{const e=this.state.username&&this.state.usernameCheckSupport&&!this.state.usernameError,t=E()({error:Boolean(this.state.usernameError),success:e});i=o.a.createElement("div",{className:t,role:"alert"},e?Object(c.a)("Username available"):this.state.usernameError)}let r=null;this.state.authError&&(r=o.a.createElement("div",{className:"error",role:"alert"},this.state.authError));const a=this.state.username&&!this.state.usernameError&&!this.state.usernameBusy;return o.a.createElement(e,{className:"mx_SetMxIdDialog",onFinished:this.props.onFinished,title:Object(c.a)("To get started, please pick a username!"),contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_SetMxIdDialog_input_group"},o.a.createElement("input",{type:"text",ref:this._input_value,value:this.state.username,autoFocus:!0,onChange:this.onValueChange,onKeyUp:this.onKeyUp,size:"30",className:n})),i,o.a.createElement("p",null,Object(c.a)("This will be your account name on the <span></span> homeserver, or you can pick a <a>different server</a>.",{},{span:o.a.createElement("span",null,this.props.homeserverUrl),a:e=>o.a.createElement("a",{href:"#",onClick:this.props.onDifferentServerClicked},e)})),o.a.createElement("p",null,Object(c.a)("If you already have a Matrix account you can <a>log in</a> instead.",{},{a:e=>o.a.createElement("a",{href:"#",onClick:this.props.onLoginClick},e)})),s,r),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(c.a)("Continue"),onClick:this.onSubmit,disabled:!a})))}}g()(vl,"propTypes",{onFinished:re.a.func.isRequired,onDifferentServerClicked:re.a.func.isRequired,onLoginClick:re.a.func.isRequired});var yl=s(476),bl=({onFinished:e})=>{const t=d.getComponent("dialogs.InfoDialog"),s={};ai.forEach(e=>{s[e.category]||(s[e.category]=[]),s[e.category].push(e)});const n=Object.values(ni).filter(e=>s[e]).map(e=>{const t=[o.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},o.a.createElement("td",{colSpan:3},o.a.createElement("h2",null,Object(c.a)(e))))];return s[e].forEach(e=>{t.push(o.a.createElement("tr",{key:e.command},o.a.createElement("td",null,o.a.createElement("strong",null,e.getCommand())),o.a.createElement("td",null,e.args),o.a.createElement("td",null,e.description)))}),t});return o.a.createElement(t,{className:"mx_SlashCommandHelpDialog",title:Object(c.a)("Command Help"),description:o.a.createElement("table",null,o.a.createElement("tbody",null,n)),hasCloseButton:!0,onFinished:e})};class El extends o.a.Component{constructor(...e){super(...e),g()(this,"_sendBugReport",e=>{e.preventDefault();const t=d.getComponent("dialogs.BugReportDialog");ke.a.createTrackedDialog("Storage evicted","Send Bug Report Dialog",t,{})}),g()(this,"_onSignOutClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s;return l.a.get().bug_report_endpoint_url&&(s=Object(c.a)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>o.a.createElement("a",{href:"#",onClick:this._sendBugReport},e)})),o.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.a)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),o.a.createElement("p",null,Object(c.a)("Your browser likely removed this data when running low on disk space.")," ",s)),o.a.createElement(t,{primaryButton:Object(c.a)("Sign out"),onPrimaryButtonClick:this._onSignOutClick,focus:!0,hasCancel:!1}))}}g()(El,"propTypes",{onFinished:re.a.func.isRequired});var Sl=s(438);class wl extends o.a.PureComponent{constructor(...e){super(...e),g()(this,"onChange",e=>{this.props.onChange(this.props.url,e.target.checked)})}render(){return o.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}g()(wl,"propTypes",{onChange:re.a.func.isRequired,url:re.a.string.isRequired,checked:re.a.bool.isRequired});class Cl extends o.a.PureComponent{constructor(e){super(),g()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),g()(this,"_onNextClick",()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter(e=>this.state.agreedUrls[e]))}),g()(this,"_onTermsCheckboxChange",(e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})}),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}_nameForServiceType(e,t){switch(e){case de.r.SERVICE_TYPES.IS:return o.a.createElement("div",null,Object(c.a)("Identity Server"),o.a.createElement("br",null),"(",t,")");case de.r.SERVICE_TYPES.IM:return o.a.createElement("div",null,Object(c.a)("Integration Manager"),o.a.createElement("br",null),"(",t,")")}}_summaryForServiceType(e){switch(e){case de.r.SERVICE_TYPES.IS:return o.a.createElement("div",null,Object(c.a)("Find others by phone or email"),o.a.createElement("br",null),Object(c.a)("Be found by phone or email"));case de.r.SERVICE_TYPES.IM:return o.a.createElement("div",null,Object(c.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=[];for(const e of this.props.policiesAndServicePairs){const t=he.a.parse(e.service.baseUrl),n=Object.values(e.policies);for(let i=0;i<n.length;++i){const r=n[i],a=Object(c.j)(Object.keys(r).filter(e=>"version"!==e));let l,d;0===i&&(l=this._nameForServiceType(e.service.serviceType,t.host),d=this._summaryForServiceType(e.service.serviceType)),s.push(o.a.createElement("tr",{key:r[a].url},o.a.createElement("td",{className:"mx_TermsDialog_service"},l),o.a.createElement("td",{className:"mx_TermsDialog_summary"},d),o.a.createElement("td",null,r[a].name," ",o.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:r[a].url},o.a.createElement("span",{className:"mx_TermsDialog_link"}))),o.a.createElement("td",null,o.a.createElement(wl,{url:r[a].url,onChange:this._onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[r[a].url])}))))}}let n=!1;for(const e of this.props.policiesAndServicePairs){let t=0;for(const s of Object.values(e.policies)){let e=!1;for(const t of Object.keys(s))if("version"!==t&&this.state.agreedUrls[s[t].url]){e=!0;break}e&&++t}if(t===Object.keys(e.policies).length){n=!0;break}}return o.a.createElement(e,{fixedWidth:!1,onFinished:this._onCancelClick,title:Object(c.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.a)("To continue you need to accept the terms of this service.")),o.a.createElement("table",{className:"mx_TermsDialog_termsTable"},o.a.createElement("tbody",null,o.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},o.a.createElement("th",null,Object(c.a)("Service")),o.a.createElement("th",null,Object(c.a)("Summary")),o.a.createElement("th",null,Object(c.a)("Document")),o.a.createElement("th",null,Object(c.a)("Accept"))),s))),o.a.createElement(t,{primaryButton:Object(c.a)("Next"),hasCancel:!0,onCancel:this._onCancelClick,onPrimaryButtonClick:this._onNextClick,primaryDisabled:!n}))}}g()(Cl,"propTypes",{policiesAndServicePairs:re.a.array.isRequired,agreedUrls:re.a.arrayOf(re.a.string),onFinished:re.a.func.isRequired});class Rl extends o.a.Component{constructor(e){super(e),g()(this,"onOk",async e=>{if(e.preventDefault(),this.props.validator&&(await this._field.current.validate({allowEmpty:!1}),!this._field.current.state.valid))return this._field.current.focus(),void this._field.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(!0,this.state.value)}),g()(this,"onCancel",()=>{this.props.onFinished(!1)}),g()(this,"onChange",e=>{this.setState({value:e.target.value})}),g()(this,"onValidate",async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t}),this._field=Object(i.createRef)(),this.state={value:this.props.value,valid:!1}}componentDidMount(){this.props.focus&&this._field.current.focus()}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},o.a.createElement("form",{onSubmit:this.onOk},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_TextInputDialog_label"},o.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),o.a.createElement("div",null,o.a.createElement(le.a,{className:"mx_TextInputDialog_input",ref:this._field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0,size:"64"})))),o.a.createElement(t,{primaryButton:this.props.button,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}}g()(Rl,"propTypes",{title:re.a.string,description:re.a.oneOfType([re.a.element,re.a.string]),value:re.a.string,placeholder:re.a.string,button:re.a.string,focus:re.a.bool,onFinished:re.a.func.isRequired,hasCancel:re.a.bool,validator:re.a.func,fixedWidth:re.a.bool}),g()(Rl,"defaultProps",{title:"",value:"",description:"",focus:!0,hasCancel:!0});class kl extends o.a.Component{constructor(e){super(e),g()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),g()(this,"_onUploadClick",()=>{this.props.onFinished(!0)}),g()(this,"_onUploadAllClick",()=>{this.props.onFinished(!0,!0)}),this._objectUrl=URL.createObjectURL(e.file)}componentWillUnmount(){this._objectUrl&&URL.revokeObjectURL(this._objectUrl)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let n,i,r;return n=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(c.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(c.a)("Upload files"),i=this.props.file.type.startsWith("image/")?o.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},o.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},o.a.createElement("div",null,o.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this._objectUrl})),o.a.createElement("div",null,this.props.file.name," (",Vr()(this.props.file.size),")"))):o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("img",{className:"mx_UploadConfirmDialog_fileIcon",src:s(1122)}),this.props.file.name," (",Vr()(this.props.file.size),")")),this.props.currentIndex+1<this.props.totalFiles&&(r=o.a.createElement("button",{onClick:this._onUploadAllClick},Object(c.a)("Upload all"))),o.a.createElement(e,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this._onCancelClick,title:n,contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content"},i),o.a.createElement(t,{primaryButton:Object(c.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this._onUploadClick,focus:!0},r))}}g()(kl,"propTypes",{file:re.a.object.isRequired,currentIndex:re.a.number,totalFiles:re.a.number,onFinished:re.a.func.isRequired}),g()(kl,"defaultProps",{totalFiles:1});class Il extends o.a.Component{constructor(...e){super(...e),g()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),g()(this,"_onUploadClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s,n;if(1===this.props.totalFiles&&1===this.props.badFiles.length)s=Object(c.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:Vr()(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:Vr()(this.props.badFiles[0].size)},{b:e=>o.a.createElement("b",null,e)}),n=o.a.createElement(t,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)s=Object(c.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:Vr()(this.props.contentMessages.getUploadLimit())},{b:e=>o.a.createElement("b",null,e)}),n=o.a.createElement(t,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else{s=Object(c.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:Vr()(this.props.contentMessages.getUploadLimit())},{b:e=>o.a.createElement("b",null,e)});const e=this.props.totalFiles-this.props.badFiles.length;n=o.a.createElement(t,{primaryButton:Object(c.a)("Upload %(count)s other files",{count:e}),onPrimaryButtonClick:this._onUploadClick,hasCancel:!0,cancelButton:Object(c.a)("Cancel All"),onCancel:this._onCancelClick,focus:!0})}return o.a.createElement(e,{className:"mx_UploadFailureDialog",onFinished:this._onCancelClick,title:Object(c.a)("Upload Error"),contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content"},s,void 0),n)}}g()(Il,"propTypes",{badFiles:re.a.arrayOf(re.a.object).isRequired,totalFiles:re.a.number.isRequired,contentMessages:re.a.instanceOf(Fr.a).isRequired,onFinished:re.a.func.isRequired});var Ol=s(478),Tl=s(501),xl=s(105);class Nl extends o.a.PureComponent{constructor(e){super(e),g()(this,"_onCancel",()=>{this.props.onFinished(!1)}),g()(this,"_onDone",()=>{this.props.onFinished(!0)}),g()(this,"_onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),g()(this,"_progressCallback",e=>{this.setState({progress:e})}),g()(this,"_onResetRecoveryClick",()=>{this.props.onFinished(!1),Object(xl.b)(()=>{},!0)}),g()(this,"_onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:L.a.get().isValidRecoveryKey(e.target.value)})}),g()(this,"_onPassPhraseNext",async()=>{this.setState({loading:!0,restoreError:null,restoreType:0});try{const e=await L.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=await L.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}),g()(this,"_onRecoveryKeyNext",async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:1});try{const e=await L.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=L.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}}),g()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:"prefetch"}}}componentDidMount(){this._loadBackupStatus()}async _restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:2});try{const e=await Object(xl.b)(async()=>L.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this._progressCallback}));this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async _restoreWithCachedKey(e){if(!e)return!1;try{const t=await L.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this._progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return console.log("restoreWithCachedKey failed:",e),!1}}async _loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=L.a.get(),t=await e.getKeyBackupVersion(),s=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:s});if(await this._restoreWithCachedKey(t))return console.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(s)return this._restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){console.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner"),s=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let n,i;if(this.state.loading){let e;if(i=Object(c.a)("Restoring keys from backup"),"fetch"===this.state.progress.stage)e=Object(c.a)("Fetching keys from server...");else if("load_keys"===this.state.progress.stage){const{total:t,successes:s,failures:n}=this.state.progress;e=Object(c.a)("%(completed)s of %(total)s keys restored",{total:t,completed:s+n})}else"prefetch"===this.state.progress.stage&&(e=Object(c.a)("Fetching keys from server..."));n=o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement(t,null))}else if(this.state.loadError)i=Object(c.a)("Error"),n=Object(c.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===de.h.RESTORE_BACKUP_ERROR_BAD_KEY?1===this.state.restoreType?(i=Object(c.a)("Recovery key mismatch"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Backup could not be decrypted with this recovery key: please verify that you entered the correct recovery key.")))):(i=Object(c.a)("Incorrect recovery passphrase"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Backup could not be decrypted with this recovery passphrase: please verify that you entered the correct recovery passphrase.")))):(i=Object(c.a)("Error"),n=Object(c.a)("Unable to restore backup"));else if(null===this.state.backupInfo)i=Object(c.a)("Error"),n=Object(c.a)("No backup found!");else if(this.state.recoverInfo){const e=d.getComponent("views.elements.DialogButtons");let t;i=Object(c.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(t=o.a.createElement("p",null,Object(c.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),t,o.a.createElement(e,{primaryButton:Object(c.a)("OK"),onPrimaryButtonClick:this._onDone,hasCancel:!1,focus:!0}))}else if(s&&!this.state.forceRecoveryKey){const e=d.getComponent("views.elements.DialogButtons"),t=d.getComponent("elements.AccessibleButton");i=Object(c.a)("Enter recovery passphrase"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(c.a)("Access your secure message history and set up secure messaging by entering your recovery passphrase.")),o.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},o.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this._onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),o.a.createElement(e,{primaryButton:Object(c.a)("Next"),onPrimaryButtonClick:this._onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this._onCancel,focus:!1})),Object(c.a)("If you've forgotten your recovery passphrase you can <button1>use your recovery key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onUseRecoveryKeyClick},e),button2:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}else{i=Object(c.a)("Enter recovery key");const e=d.getComponent("views.elements.DialogButtons"),t=d.getComponent("elements.AccessibleButton");let s;s=0===this.state.recoveryKey.length?o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(c.a)("This looks like a valid recovery key!")):o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(c.a)("Not a valid recovery key")),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(c.a)("Access your secure message history and set up secure messaging by entering your recovery key.")),o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},o.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this._onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),s,o.a.createElement(e,{primaryButton:Object(c.a)("Next"),onPrimaryButtonClick:this._onRecoveryKeyNext,hasCancel:!0,onCancel:this._onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(c.a)("If you've forgotten your recovery key you can <button>set up new recovery options</button>",{},{button:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}return o.a.createElement(e,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:i},o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},n))}}g()(Nl,"propTypes",{showSummary:re.a.bool,keyCallback:re.a.func}),g()(Nl,"defaultProps",{showSummary:!0});class jl extends o.a.PureComponent{constructor(e){super(e),g()(this,"_onCancel",()=>{this.props.onFinished(!1)}),g()(this,"_onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),g()(this,"_validateRecoveryKeyOnChange",Object(jt.debounce)(()=>{this._validateRecoveryKey()},200)),g()(this,"_onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this._fileUpload.current&&(this._fileUpload.current.value=null),this._validateRecoveryKeyOnChange()}),g()(this,"_onRecoveryKeyFileChange",async e=>{if(0===e.target.files.length)return;const t=e.target.files[0];if(t.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await t.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),this._validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}}),g()(this,"_onRecoveryKeyFileUploadClick",()=>{this._fileUpload.current.click()}),g()(this,"_onPassPhraseNext",async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),g()(this,"_onRecoveryKeyNext",async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),g()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value,keyMatches:null})}),this._fileUpload=o.a.createRef(),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null}}async _validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=L.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),s=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:s})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(c.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(c.a)("Looks good!"):this.state.recoveryKeyValid?Object(c.a)("Wrong Recovery Key"):null===this.state.recoveryKeyValid?"":Object(c.a)("Invalid Recovery Key")}render(){const e=d.getComponent("views.dialogs.BaseDialog");let t,s,n;if(this.props.keyInfo&&this.props.keyInfo.passphrase&&this.props.keyInfo.passphrase.salt&&this.props.keyInfo.passphrase.iterations&&!this.state.forceRecoveryKey){const e=d.getComponent("views.elements.DialogButtons"),i=d.getComponent("elements.AccessibleButton");let r;s=Object(c.a)("Security Phrase"),n=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],r=!1===this.state.keyMatches?o.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(c.a)("Unable to access secret storage. Please verify that you entered the correct recovery passphrase.")):o.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),t=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Enter your Security Phrase or <button>Use your Security Key</button> to continue.",{},{button:e=>o.a.createElement(i,{className:"mx_linkButton",element:"span",onClick:this._onUseRecoveryKeyClick},e)})),o.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this._onPassPhraseNext},o.a.createElement("input",{type:"password",className:"mx_AccessSecretStorageDialog_passPhraseInput",onChange:this._onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0,autoComplete:"new-password",placeholder:Object(c.a)("Security Phrase")}),r,o.a.createElement(e,{primaryButton:Object(c.a)("Continue"),onPrimaryButtonClick:this._onPassPhraseNext,hasCancel:!0,onCancel:this._onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length})))}else{s=Object(c.a)("Security Key"),n=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=d.getComponent("views.elements.DialogButtons"),i=E()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,mx_AccessSecretStorageDialog_recoveryKeyFeedback_valid:!0===this.state.recoveryKeyCorrect,mx_AccessSecretStorageDialog_recoveryKeyFeedback_invalid:!1===this.state.recoveryKeyCorrect}),r=o.a.createElement("div",{className:i},this.getKeyValidationText());t=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Use your Security Key to continue.")),o.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this._onRecoveryKeyNext,spellCheck:!1},o.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},o.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},o.a.createElement(le.a,{type:"text",label:Object(c.a)("Security Key"),value:this.state.recoveryKey,onChange:this._onRecoveryKeyChange,forceValidity:this.state.recoveryKeyCorrect})),o.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(c.a)("or")),o.a.createElement("div",null,o.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this._fileUpload,onChange:this._onRecoveryKeyFileChange}),o.a.createElement(Z.a,{kind:"primary",onClick:this._onRecoveryKeyFileUploadClick},Object(c.a)("Upload")))),r,o.a.createElement(e,{primaryButton:Object(c.a)("Continue"),onPrimaryButtonClick:this._onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(c.a)("Go Back"),cancelButtonClass:"danger",onCancel:this._onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})))}return o.a.createElement(e,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:s,titleClass:n},o.a.createElement("div",null,t))}}g()(jl,"propTypes",{keyInfo:re.a.object.isRequired,checkPrivateKey:re.a.func.isRequired});class Pl extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{showTooltip:!1}),g()(this,"_onClick",e=>{e.stopPropagation(),ve.a.trackEvent("Action Button","click",this.props.action),u.a.dispatch({action:this.props.action})}),g()(this,"_onMouseEnter",()=>{this.props.tooltip&&this.setState({showTooltip:!0}),this.props.mouseOverAction&&u.a.dispatch({action:this.props.mouseOverAction})}),g()(this,"_onMouseLeave",()=>{this.setState({showTooltip:!1})})}render(){const e=d.getComponent("elements.TintableSvg");let t;if(this.state.showTooltip){const e=d.getComponent("elements.Tooltip");t=o.a.createElement(e,{className:"mx_RoleButton_tooltip",label:this.props.label})}const s=this.props.iconPath?o.a.createElement(e,{src:this.props.iconPath,width:this.props.size,height:this.props.size}):void 0,n=["mx_RoleButton"];return this.props.className&&n.push(this.props.className),o.a.createElement(Z.a,{className:n.join(" "),onClick:this._onClick,onMouseEnter:this._onMouseEnter,onMouseLeave:this._onMouseLeave,"aria-label":this.props.label},s,t)}}g()(Pl,"propTypes",{size:re.a.string,tooltip:re.a.bool,action:re.a.string.isRequired,mouseOverAction:re.a.string,label:re.a.string.isRequired,iconPath:re.a.string,className:re.a.string}),g()(Pl,"defaultProps",{size:"25",tooltip:!1});class Dl extends o.a.Component{constructor(e){super(e),g()(this,"moveSelectionTop",()=>{this.state.selected>0&&this.setState({selected:0,hover:!1})}),g()(this,"moveSelectionUp",()=>{this.state.selected>0&&this.setState({selected:this.state.selected-1,hover:!1})}),g()(this,"moveSelectionDown",()=>{this.state.selected<this._maxSelected(this.props.addressList)&&this.setState({selected:this.state.selected+1,hover:!1})}),g()(this,"chooseSelection",()=>{this.selectAddress(this.state.selected)}),g()(this,"onClick",e=>{this.selectAddress(e)}),g()(this,"onMouseEnter",e=>{this.setState({selected:e,hover:!0})}),g()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),g()(this,"selectAddress",e=>{0!==this.props.addressList.length&&(this.props.onSelected(e),this.setState({hover:!1}))}),this.state={selected:void 0===this.props.selected?0:this.props.selected,hover:!1}}UNSAFE_componentWillReceiveProps(e){const t=this.state.selected,s=this._maxSelected(e.addressList);t>s&&this.setState({selected:s})}componentDidUpdate(){if(this.scrollElement&&this.props.addressList.length>0&&!this.state.hover){const e=this.addressListElement.getBoundingClientRect().height;this.scrollElement.scrollTop=this.state.selected*e-e}}createAddressListTiles(){const e=d.getComponent("elements.AddressTile"),t=this._maxSelected(this.props.addressList),n=[];if(this.props.addressList.length>0)for(let i=0;i<=t;i++){const t=E()({mx_AddressSelector_addressListElement:!0,mx_AddressSelector_selected:this.state.selected===i});n.push(o.a.createElement("div",{className:t,onClick:this.onClick.bind(this,i),onMouseEnter:this.onMouseEnter.bind(this,i),onMouseLeave:this.onMouseLeave,key:this.props.addressList[i].addressType+"/"+this.props.addressList[i].address,ref:e=>{this.addressListElement=e}},o.a.createElement(e,{address:this.props.addressList[i],showAddress:this.props.showAddress,justified:!0,networkName:"vector",networkUrl:s(1123)})))}return n}_maxSelected(e){const t=0===e.length?0:e.length-1;return t>this.props.truncateAt-1?this.props.truncateAt-1:t}render(){const e=E()({mx_AddressSelector:!0,mx_AddressSelector_empty:0===this.props.addressList.length});return o.a.createElement("div",{className:e,ref:e=>{this.scrollElement=e}},this.props.header,this.createAddressListTiles())}}g()(Dl,"propTypes",{onSelected:re.a.func.isRequired,addressList:re.a.arrayOf(Wn.a).isRequired,showAddress:re.a.bool,truncateAt:re.a.number.isRequired,selected:re.a.number,header:re.a.node});class Al extends o.a.Component{render(){const e=this.props.address,t=e.displayName||e.address,n=[],i=["mx-user-id","mx-room-id"].includes(e.addressType);i&&e.avatarMxc?n.push(L.a.get().mxcUrlToHttp(e.avatarMxc,25,25,"crop")):"email"===e.addressType&&n.push(s(1124));const r=d.getComponent("avatars.BaseAvatar"),a=d.getComponent("elements.TintableSvg"),l=E()({mx_AddressTile_name:!0,mx_AddressTile_justified:this.props.justified});let u,h=!1;if(i&&e.isKnown){const s=E()({mx_AddressTile_id:!0,mx_AddressTile_justified:this.props.justified});u=o.a.createElement("div",{className:"mx_AddressTile_mx"},o.a.createElement("div",{className:l},t),this.props.showAddress?o.a.createElement("div",{className:s},e.address):o.a.createElement("div",null))}else if(i){const e=E()({mx_AddressTile_unknownMx:!0,mx_AddressTile_justified:this.props.justified});u=o.a.createElement("div",{className:e},this.props.address.address)}else if("email"===e.addressType){const t=E()({mx_AddressTile_email:!0,mx_AddressTile_justified:this.props.justified});let s=null;e.displayName&&(s=o.a.createElement("div",{className:l},e.displayName)),u=o.a.createElement("div",{className:"mx_AddressTile_mx"},o.a.createElement("div",{className:t},e.address),s)}else{h=!0;const e=E()({mx_AddressTile_unknown:!0,mx_AddressTile_justified:this.props.justified});u=o.a.createElement("div",{className:e},Object(c.a)("Unknown Address"))}const m=E()({mx_AddressTile:!0,mx_AddressTile_error:h});let p;return this.props.canDismiss&&(p=o.a.createElement("div",{className:"mx_AddressTile_dismiss",onClick:this.props.onDismissed},o.a.createElement(a,{src:s(1125),width:"9",height:"9"}))),o.a.createElement("div",{className:m},o.a.createElement("div",{className:"mx_AddressTile_avatar"},o.a.createElement(r,{defaultToInitialLetter:!0,width:25,height:25,name:t,title:t,urls:n})),u,p)}}g()(Al,"propTypes",{address:Wn.a.isRequired,canDismiss:re.a.bool,onDismissed:re.a.func,justified:re.a.bool}),g()(Al,"defaultProps",{canDismiss:!1,onDismissed:function(){},justified:!1});var Ul=s(502),Ml=s(262),Ll=s(503);class Fl extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{hover:!1,profile:null}),g()(this,"_onFlairStoreUpdated",()=>{this.unmounted||Vt.a.getGroupProfileCached(this.context,this.props.tag).then(e=>{this.unmounted||this.setState({profile:e})}).catch(e=>{console.warn("Could not fetch group profile for "+this.props.tag,e)})}),g()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"select_tag",tag:this.props.tag,ctrlOrCmdKey:Object(Yt.c)(e),shiftKey:e.shiftKey}),"+"===this.props.tag[0]&&this._refreshGroup(this.props.tag)}),g()(this,"onMouseOver",()=>{w.a.getValue("feature_communities_v2_prototypes")||this.setState({hover:!0})}),g()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),g()(this,"openMenu",e=>{e.stopPropagation(),e.preventDefault(),w.a.getValue("feature_communities_v2_prototypes")||(this.setState({hover:!1}),this.props.openMenu())})}componentDidMount(){this.unmounted=!1,"+"===this.props.tag[0]&&(Vt.a.addListener("updateGroupProfile",this._onFlairStoreUpdated),this._onFlairStoreUpdated(),this._refreshGroup(this.props.tag))}componentWillUnmount(){this.unmounted=!0,"+"===this.props.tag[0]&&Vt.a.removeListener("updateGroupProfile",this._onFlairStoreUpdated)}_refreshGroup(e){Zo.a.refreshGroupRooms(e),Zo.a.refreshGroupMembers(e)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.state.profile||{},s=t.name||this.props.tag,n=t.avatarUrl?this.context.mxcUrlToHttp(t.avatarUrl,32,32,"crop"):null,i=w.a.getValue("feature_communities_v2_prototypes"),r=E()({mx_TagTile:!0,mx_TagTile_prototype:i,mx_TagTile_selected:this.props.selected&&!i,mx_TagTile_selected_prototype:this.props.selected&&i}),a=f.a.getGroupBadge(this.props.tag);let c;if(a&&!this.state.hover&&!this.props.menuDisplayed){const e=E()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:a.highlight});c=o.a.createElement("div",{className:e},T.c(a.count))}const l=this.state.hover||this.props.menuDisplayed?o.a.createElement(Z.a,{className:"mx_TagTile_context_button",onClick:this.openMenu,inputRef:this.props.contextMenuButtonRef},"···"):o.a.createElement("div",{ref:this.props.contextMenuButtonRef}),u=d.getComponent("elements.AccessibleTooltipButton");return o.a.createElement(u,{className:r,onClick:this.onClick,onContextMenu:this.openMenu,title:s},o.a.createElement("div",{className:"mx_TagTile_avatar",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},o.a.createElement(e,{name:s,idName:this.props.tag,url:n,width:32,height:32}),l,c))}}function Bl(e){const[t,s,i,r]=Object(n.o)();let a=null;if(t&&s.current){const t=s.current.getBoundingClientRect(),i=d.getComponent("context_menus.TagTileContextMenu");a=o.a.createElement(n.b,B()({},Object(n.n)(t),{onFinished:r}),o.a.createElement(i,{tag:e.tag,onFinished:r}))}return o.a.createElement("div",null,o.a.createElement(y.Draggable,{key:e.tag,draggableId:e.tag,index:e.index,type:"draggable-TagTile"},(n,r)=>o.a.createElement("div",B()({ref:n.innerRef},n.draggableProps,n.dragHandleProps),o.a.createElement(Fl,B()({},e,{contextMenuButtonRef:s,menuDisplayed:t,openMenu:i})))),a)}g()(Fl,"propTypes",{tag:re.a.string,contextMenuButtonRef:re.a.object,openMenu:re.a.func,menuDisplayed:re.a.bool,selected:re.a.bool}),g()(Fl,"contextType",S.a);var Vl=s(257);class Kl extends o.a.Component{constructor(){super(),this._collectInput=this._collectInput.bind(this),this._onClearClick=this._onClearClick.bind(this),this._onChange=this._onChange.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onJoinButtonClick=this._onJoinButtonClick.bind(this),this.input=null,this.state={value:""}}_collectInput(e){this.input=e}_onClearClick(){this.setState({value:""}),this.input&&(this.input.focus(),this.props.onClear&&this.props.onClear())}_onChange(e){this.input&&(this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value))}_onKeyUp(e){"Enter"==e.key&&this.props.showJoinButton&&this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}_onJoinButtonClick(){this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}render(){const e=d.getComponent("elements.AccessibleButton");let t;return{mx_DirectorySearchBox:!0}[this.props.className]=!0,this.props.showJoinButton&&(t=o.a.createElement(e,{className:"mx_DirectorySearchBox_joinButton",onClick:this._onJoinButtonClick},Object(c.a)("Join"))),o.a.createElement("div",{className:`mx_DirectorySearchBox ${this.props.className} mx_textinput`},o.a.createElement("input",{type:"text",name:"dirsearch",value:this.state.value,className:"mx_textinput_icon mx_textinput_search",ref:this._collectInput,onChange:this._onChange,onKeyUp:this._onKeyUp,placeholder:this.props.placeholder,autoFocus:!0}),t,o.a.createElement(e,{className:"mx_DirectorySearchBox_clear",onClick:this._onClearClick}))}}Kl.propTypes={className:re.a.string,onChange:re.a.func,onClear:re.a.func,onJoinClick:re.a.func,placeholder:re.a.string,showJoinButton:re.a.bool};class ql extends o.a.Component{constructor(e){super(e),this._onMouseEnter=this._onMouseEnter.bind(this),this._onClick=this._onClick.bind(this)}_onMouseEnter(){this.props.onMouseEnter(this.props.dropdownKey)}_onClick(e){e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)}render(){const e=E()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return o.a.createElement("div",{id:this.props.id,className:e,onClick:this._onClick,onMouseEnter:this._onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}g()(ql,"defaultProps",{disabled:!1}),ql.propTypes={children:re.a.oneOfType([re.a.arrayOf(re.a.node),re.a.node]),highlighted:re.a.bool,dropdownKey:re.a.string,onClick:re.a.func.isRequired,onMouseEnter:re.a.func.isRequired,inputRef:re.a.any};class Gl extends o.a.Component{constructor(e){super(e),g()(this,"_onInputKeyDown",e=>{let t=!0;switch(e.key){case Yt.a.ENTER:this.props.onOptionChange(this.state.highlightedOption);case Yt.a.ESCAPE:this._close();break;case Yt.a.ARROW_DOWN:this.setState({highlightedOption:this._nextOption(this.state.highlightedOption)});break;case Yt.a.ARROW_UP:this.setState({highlightedOption:this._prevOption(this.state.highlightedOption)});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())}),this.dropdownRootElement=null,this.ignoreEvent=null,this._onInputClick=this._onInputClick.bind(this),this._onRootClick=this._onRootClick.bind(this),this._onDocumentClick=this._onDocumentClick.bind(this),this._onMenuOptionClick=this._onMenuOptionClick.bind(this),this._onInputChange=this._onInputChange.bind(this),this._collectRoot=this._collectRoot.bind(this),this._collectInputTextBox=this._collectInputTextBox.bind(this),this._setHighlightedOption=this._setHighlightedOption.bind(this),this.inputTextBox=null,this._reindexChildren(this.props.children);const t=o.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""}}UNSAFE_componentWillMount(){this._button=Object(i.createRef)(),document.addEventListener("click",this._onDocumentClick,!1)}componentWillUnmount(){document.removeEventListener("click",this._onDocumentClick,!1)}UNSAFE_componentWillReceiveProps(e){if(!e.children||0===e.children.length)return;this._reindexChildren(e.children);const t=e.children[0];this.setState({highlightedOption:t?t.key:null})}_reindexChildren(e){this.childrenByKey={},o.a.Children.forEach(e,e=>{this.childrenByKey[e.key]=e})}_onDocumentClick(e){e!==this.ignoreEvent&&this.setState({expanded:!1})}_onRootClick(e){this.ignoreEvent=e}_onInputClick(e){this.props.disabled||this.state.expanded||(this.setState({expanded:!0}),e.preventDefault())}_close(){this.setState({expanded:!1}),this._button.current&&this._button.current.focus()}_onMenuOptionClick(e){this._close(),this.props.onOptionChange(e)}_onInputChange(e){this.setState({searchQuery:e.target.value}),this.props.onSearchChange&&this.props.onSearchChange(e.target.value)}_collectRoot(e){this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this._onRootClick,!1),e&&e.addEventListener("click",this._onRootClick,!1),this.dropdownRootElement=e}_collectInputTextBox(e){this.inputTextBox=e,e&&e.focus()}_setHighlightedOption(e){this.setState({highlightedOption:e})}_nextOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s+1)%t.length]}_prevOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s-1)%t.length]}_scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}_getMenuOptions(){const e=o.a.Children.map(this.props.children,e=>{const t=this.state.highlightedOption===e.key;return o.a.createElement(ql,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this._setHighlightedOption,onClick:this._onMenuOptionClick,inputRef:t?this._scrollIntoView:void 0},e)});return 0===e.length?[o.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option"},Object(c.a)("No results"))]:e}render(){let e;const t={};let s;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=o.a.createElement("input",{type:"text",className:"mx_Dropdown_option",ref:this._collectInputTextBox,onKeyDown:this._onInputKeyDown,onChange:this._onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-owns":this.props.id+"_listbox","aria-disabled":this.props.disabled,"aria-label":this.props.label})),s=o.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:this.props.id+"_listbox"},this._getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=o.a.createElement("div",{className:"mx_Dropdown_option",id:this.props.id+"_value"},t)}const n={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(n[this.props.className]=!0),o.a.createElement("div",{className:E()(n),ref:this._collectRoot},o.a.createElement(Z.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this._onInputClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this._button,"aria-label":this.props.label,"aria-describedby":this.props.id+"_value"},e,o.a.createElement("span",{className:"mx_Dropdown_arrow"}),s))}}Gl.propTypes={id:re.a.string.isRequired,menuWidth:re.a.number,onOptionChange:re.a.func.isRequired,onSearchChange:re.a.func,searchEnabled:re.a.bool,getShortOption:re.a.func,value:re.a.string,disabled:re.a.bool,label:re.a.string.isRequired};class Wl extends o.a.Component{constructor(){super(),g()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),g()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),g()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_EditableItem"},o.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(c.a)("Are you sure?")),o.a.createElement(Z.a,{onClick:this._onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("Yes")),o.a.createElement(Z.a,{onClick:this._onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("No"))):o.a.createElement("div",{className:"mx_EditableItem"},o.a.createElement("div",{onClick:this._onRemove,className:"mx_EditableItem_delete",title:Object(c.a)("Remove"),role:"button"}),o.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}g()(Wl,"propTypes",{index:re.a.number,value:re.a.string,onRemove:re.a.func});class Hl extends o.a.Component{constructor(...e){super(...e),g()(this,"_onItemAdded",e=>{e.stopPropagation(),e.preventDefault(),this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem)}),g()(this,"_onItemRemoved",e=>{this.props.onItemRemoved&&this.props.onItemRemoved(e)}),g()(this,"_onNewItemChanged",e=>{this.props.onNewItemChanged&&this.props.onNewItemChanged(e.target.value)})}_renderNewItemField(){return o.a.createElement("form",{onSubmit:this._onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},o.a.createElement(le.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this._onNewItemChanged,list:this.props.suggestionsListId}),o.a.createElement(Z.a,{onClick:this._onItemAdded,kind:"primary",type:"submit"},Object(c.a)("Add")))}render(){const e=this.props.items.map((e,t)=>this.props.canRemove?o.a.createElement(Wl,{key:e,index:t,value:e,onRemove:this._onItemRemoved}):o.a.createElement("li",{key:e},e)),t=this.props.canRemove?e:o.a.createElement("ul",null,e),s=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return o.a.createElement("div",{className:"mx_EditableItemList"},o.a.createElement("div",{className:"mx_EditableItemList_label"},s),t,this.props.canEdit?this._renderNewItemField():o.a.createElement("div",null))}}g()(Hl,"propTypes",{id:re.a.string.isRequired,items:re.a.arrayOf(re.a.string).isRequired,itemsLabel:re.a.string,noItemsLabel:re.a.string,placeholder:re.a.string,newItem:re.a.string,onItemAdded:re.a.func,onItemRemoved:re.a.func,onNewItemChanged:re.a.func,canEdit:re.a.bool,canRemove:re.a.bool});class $l extends o.a.Component{constructor(e){super(e),g()(this,"state",{phase:$l.Phases.Display}),g()(this,"showPlaceholder",e=>{e?(this._editable_div.current.textContent=this.props.placeholder,this._editable_div.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this._editable_div.current.textContent=this.value,this._editable_div.current.setAttribute("class",this.props.className),this.placeholder=!1)}),g()(this,"getValue",()=>this.value),g()(this,"setValue",e=>{this.value=e,this.showPlaceholder(!this.value)}),g()(this,"edit",()=>{this.setState({phase:$l.Phases.Edit})}),g()(this,"cancelEdit",()=>{this.setState({phase:$l.Phases.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),this._editable_div.current.blur()}),g()(this,"onValueChanged",e=>{this.props.onValueChanged(this.value,e)}),g()(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1),e.key===Yt.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),g()(this,"onKeyUp",e=>{e.target.textContent?this.placeholder||(this.value=e.target.textContent):this.showPlaceholder(!0),e.key===Yt.a.ENTER?this.onFinish(e):e.key===Yt.a.ESCAPE&&this.cancelEdit()}),g()(this,"onClickDiv",e=>{this.props.editable&&this.setState({phase:$l.Phases.Edit})}),g()(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const e=document.createRange();e.setStart(t,0),e.setEnd(t,t.length);const s=window.getSelection();s.removeAllRanges(),s.addRange(e)}}),g()(this,"onFinish",(e,t)=>{const s=this,n=e.key===Yt.a.ENTER||t;this.setState({phase:$l.Phases.Display},()=>{this.value!==this.props.initialValue&&s.onValueChanged(n)})}),g()(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.value="",this.placeholder=!1,this._editable_div=Object(i.createRef)()}UNSAFE_componentWillReceiveProps(e){e.initialValue!==this.props.initialValue&&(this.value=e.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:s,label:n,labelClassName:i}=this.props;let r;return r=!t||this.state.phase===$l.Phases.Display&&(n||i)&&!this.value?o.a.createElement("div",{className:e+" "+i,onClick:this.onClickDiv},n||s):o.a.createElement("div",{ref:this._editable_div,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),r}}g()($l,"propTypes",{onValueChanged:re.a.func,initialValue:re.a.string,label:re.a.string,placeholder:re.a.string,className:re.a.string,labelClassName:re.a.string,placeholderClassName:re.a.string,blurToCancel:re.a.bool,blurToSubmit:re.a.bool,editable:re.a.bool}),g()($l,"Phases",{Display:"display",Edit:"edit"}),g()($l,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class zl extends o.a.Component{constructor(e){super(e),this._unmounted=!1,this.state={busy:!1,errorString:null,value:e.initialValue},this._onValueChanged=this._onValueChanged.bind(this)}componentDidMount(){void 0!==this.props.getInitialValue&&(this.setState({busy:!0}),this.props.getInitialValue().then(e=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}componentWillUnmount(){this._unmounted=!0}_onValueChanged(e,t){t&&(this.setState({busy:!0,errorString:null}),this.props.onSubmit(e).then(()=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}render(){if(this.state.busy){const e=d.getComponent("elements.Spinner");return o.a.createElement(e,null)}if(this.state.errorString)return o.a.createElement("div",{className:"error"},this.state.errorString);{const e=d.getComponent("elements.EditableText");return o.a.createElement(e,{initialValue:this.state.value,placeholder:this.props.placeholder,onValueChanged:this._onValueChanged,blurToSubmit:this.props.blurToSubmit})}}}zl.propTypes={getInitialValue:re.a.func,initialValue:re.a.string,placeholder:re.a.string,onSubmit:re.a.func,blurToSubmit:re.a.bool},zl.defaultProps={initialValue:"",placeholder:"",blurToSubmit:!1,onSubmit:function(e){return Promise.resolve()}};var Yl=s(508);const Jl=({events:e,children:t,threshold:s=3,onToggle:n,startExpanded:r,summaryMembers:a=[],summaryText:l})=>{const[d,u]=(e=>{const[t,s]=Object(i.useState)(e);return[t,()=>{s(!t)},s]})(r);Object(i.useEffect)(()=>{n&&n()},[d]);const h=e.map(e=>e.getId()).join(",");if(e.length<s)return o.a.createElement("div",{className:"mx_EventListSummary","data-scroll-tokens":h},t);let m;if(d)m=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_EventListSummary_line"}," "),t);else{const e=a.map(e=>o.a.createElement(Xs.a,{key:e.userId,member:e,width:14,height:14}));m=o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("div",{className:"mx_EventTile_info"},o.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:u},e),o.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},l)))}return o.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":h},o.a.createElement(Z.a,{className:"mx_EventListSummary_toggle",onClick:u,"aria-expanded":d},d?Object(c.a)("collapse"):Object(c.a)("expand")),m)};Jl.propTypes={events:re.a.arrayOf(re.a.instanceOf(de.i)).isRequired,children:re.a.arrayOf(re.a.element).isRequired,threshold:re.a.number,onToggle:re.a.func,startExpanded:re.a.bool,summaryMembers:re.a.arrayOf(re.a.instanceOf(de.k)),summaryText:re.a.string};var Ql=Jl;class Xl extends o.a.Component{constructor(){super(),this.onClick=this.onClick.bind(this)}onClick(e){e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_group",group_id:this.props.groupProfile.groupId})}render(){const e=this.context.mxcUrlToHttp(this.props.groupProfile.avatarUrl,16,16,"scale",!1),t=this.props.groupProfile.name?`${this.props.groupProfile.name} (${this.props.groupProfile.groupId})`:this.props.groupProfile.groupId;return o.a.createElement("img",{src:e,width:"16",height:"16",onClick:this.onClick,title:t})}}Xl.propTypes={groupProfile:re.a.shape({groupId:re.a.string.isRequired,name:re.a.string,avatarUrl:re.a.string.isRequired})},Xl.contextType=S.a;class Zl extends o.a.Component{constructor(){super(),this.state={profiles:[]}}componentDidMount(){this._unmounted=!1,this._generateAvatars(this.props.groups)}componentWillUnmount(){this._unmounted=!0}UNSAFE_componentWillReceiveProps(e){this._generateAvatars(e.groups)}async _getGroupProfiles(e){const t=[];for(const s of e){let e=null;try{e=await Vt.a.getGroupProfileCached(this.context,s)}catch(e){console.error("Could not get profile for group",s,e)}t.push(e)}return t.filter(e=>null!==e)}async _generateAvatars(e){if(!e||0===e.length)return;const t=await this._getGroupProfiles(e);this.unmounted||this.setState({profiles:t.filter(e=>!!e&&e.avatarUrl)})}render(){if(0===this.state.profiles.length)return o.a.createElement("span",{className:"mx_Flair"});const e=this.state.profiles.map((e,t)=>o.a.createElement(Xl,{key:t,groupProfile:e}));return o.a.createElement("span",{className:"mx_Flair"},e)}}function ed(e){const{icon:t,className:s}=e,n=K()(e,["icon","className"]);let i=(s||"")+" mx_IconButton";i=i+" mx_IconButton_icon_"+t;const r=Object.assign({},n,{className:i});return o.a.createElement(Z.a,r)}Zl.propTypes={groups:re.a.arrayOf(re.a.string)},Zl.contextType=S.a,ed.propTypes=Object.assign({icon:re.a.string},Z.a.propTypes);var td=s(457);class sd{constructor(e,t,s){this.topCount=e,this.renderCount=t,this.bottomCount=s}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),s=Math.min(e,this.bottomCount);return new sd(this.topCount-t,this.renderCount+t+s,this.bottomCount-s)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}class nd extends o.a.Component{constructor(e){super(e),this.state={}}static getDerivedStateFromProps(e,t){const s=nd.getVisibleRangeFromProps(e),n=s.expand(e.overflowMargin),i=s.expand(e.overflowItems);return!(!!t.renderRange&&i.totalSize()!==t.renderRange.totalSize())&&t.renderRange&&t.renderRange.contains(n)?null:{renderRange:i}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:s,scrollTop:n,height:i}=e,o=t?t.length:0,r=Math.min(Math.max(0,Math.floor(n/s)),o),a=o-r,c=0!==i?Math.ceil(i/s):0,l=Math.min(c,a);return new sd(r,l,a-l)}render(){const{itemHeight:e,items:t,renderItem:s}=this.props,{renderRange:n}=this.state,{topCount:i,renderCount:r,bottomCount:a}=n,c=i*e,l=a*e,d=(t||[]).slice(i,i+r),u=this.props.element||"div",h={style:{paddingTop:c+"px",paddingBottom:l+"px"},className:this.props.className};return o.a.createElement(u,h,d.map(s))}}nd.defaultProps={overflowItems:20,overflowMargin:5},nd.propTypes={itemHeight:re.a.number.isRequired,renderItem:re.a.func.isRequired,scrollTop:re.a.number.isRequired,height:re.a.number.isRequired,items:re.a.array,overflowMargin:re.a.number,overflowItems:re.a.number};class id extends o.a.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold}_generateSummary(e,t){const s=t.map(t=>{const s=e[t],n=this._renderNameList(s),i=t.split(","),o=this._getCanonicalTransitions(i),r=this._coalesceRepeatedTransitions(o).map(e=>this._getDescriptionForTransition(e.transitionType,s.length,e.repeats)),a=Object(T.b)(r);return Object(c.a)("%(nameList)s %(transitionList)s",{nameList:n,transitionList:a})});return s?s.join(", "):null}_renderNameList(e){return Object(T.b)(e,this.props.summaryLength)}_getCanonicalTransitions(e){const t={joined:{after:"left",newTransition:"joined_and_left"},left:{after:"joined",newTransition:"left_and_joined"}},s=[];for(let n=0;n<e.length;n++){const i=e[n],o=e[n+1];let r=i;n<e.length-1&&t[i]&&t[i].after===o&&(r=t[i].newTransition,n++),s.push(r)}return s}_coalesceRepeatedTransitions(e){const t=[];for(let s=0;s<e.length;s++)t.length>0&&t[t.length-1].transitionType===e[s]?t[t.length-1].repeats+=1:t.push({transitionType:e[s],repeats:1});return t}_getDescriptionForTransition(e,t,s){let n=null;switch(e){case"joined":n=t>1?Object(c.a)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:s});break;case"left":n=t>1?Object(c.a)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sleft %(count)s times",{oneUser:"",count:s});break;case"joined_and_left":n=t>1?Object(c.a)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:s});break;case"left_and_joined":n=t>1?Object(c.a)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:s});break;case"invite_reject":n=t>1?Object(c.a)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:s});break;case"invite_withdrawal":n=t>1?Object(c.a)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:s});break;case"invited":n=t>1?Object(c.a)("were invited %(count)s times",{count:s}):Object(c.a)("was invited %(count)s times",{count:s});break;case"banned":n=t>1?Object(c.a)("were banned %(count)s times",{count:s}):Object(c.a)("was banned %(count)s times",{count:s});break;case"unbanned":n=t>1?Object(c.a)("were unbanned %(count)s times",{count:s}):Object(c.a)("was unbanned %(count)s times",{count:s});break;case"kicked":n=t>1?Object(c.a)("were kicked %(count)s times",{count:s}):Object(c.a)("was kicked %(count)s times",{count:s});break;case"changed_name":n=t>1?Object(c.a)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:s});break;case"changed_avatar":n=t>1?Object(c.a)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:s});break;case"no_change":n=t>1?Object(c.a)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:s})}return n}_getTransitionSequence(e){return e.map(this._getTransition)}_getTransition(e){if("m.room.third_party_invite"===e.mxEvent.getType())return Object(Mt.c)(e.mxEvent)?"invited":"invite_withdrawal";switch(e.mxEvent.getContent().membership){case"invite":return"invited";case"ban":return"banned";case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?"changed_name":e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?"changed_avatar":"no_change":"joined";case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())switch(e.mxEvent.getPrevContent().membership){case"invite":return"invite_reject";default:return"left"}switch(e.mxEvent.getPrevContent().membership){case"invite":return"invite_withdrawal";case"ban":return"unbanned";default:return"kicked"}default:return null}}_getAggregate(e){const t={},s={};return Object.keys(e).forEach(n=>{const i=e[n][0],o=i.displayName,r=this._getTransitionSequence(e[n]);t[r]||(t[r]=[],s[r]=-1),t[r].push(o),(-1===s[r]||i.index<s[r])&&(s[r]=i.index)}),{names:t,indices:s}}render(){const e=this.props.events,t={},s=[];e.forEach((e,n)=>{const i=e.getStateKey();t[i]||(t[i]=[],e.target&&s.push(e.target));let o=i;"m.room.third_party_invite"===e.getType()?o=e.getContent().display_name:e.target&&(o=e.target.name),t[i].push({mxEvent:e,displayName:o,index:n})});const n=this._getAggregate(t),i=Object.keys(n.names).sort((e,t)=>n.indices[e]>n.indices[t]),r=d.getComponent("views.elements.EventListSummary");return o.a.createElement(r,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:s,summaryText:this._generateSummary(n.names,i)})}}g()(id,"propTypes",{events:re.a.arrayOf(re.a.instanceOf(de.i)).isRequired,children:re.a.array.isRequired,summaryLength:re.a.number,avatarsMaxLength:re.a.number,threshold:re.a.number,onToggle:re.a.func,startExpanded:re.a.bool}),g()(id,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5});var od=s(349),rd=s(317);class ad extends o.a.Component{constructor(e){super(e),g()(this,"onSelectChange",e=>{"SELECT_VALUE_CUSTOM"===e.target.value?this.setState({custom:!0}):(this.props.onChange(e.target.value,this.props.powerLevelKey),this.setState({selectValue:e.target.value}))}),g()(this,"onCustomChange",e=>{this.setState({customValue:e.target.value})}),g()(this,"onCustomBlur",e=>{e.preventDefault(),e.stopPropagation(),this.props.onChange(parseInt(this.state.customValue),this.props.powerLevelKey)}),g()(this,"onCustomKeyDown",e=>{e.key===Yt.a.ENTER&&(e.preventDefault(),e.stopPropagation(),e.target.blur())}),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}UNSAFE_componentWillMount(){this._initStateFromProps(this.props)}UNSAFE_componentWillReceiveProps(e){this._initStateFromProps(e)}_initStateFromProps(e){const t=rd.a(e.usersDefault),s=Object.keys(t).filter(t=>void 0===t||t<=e.maxValue||t==e.value),n=void 0===t[e.value];this.setState({levelRoleMap:t,options:s,custom:n,customLevel:e.value,selectValue:n?"SELECT_VALUE_CUSTOM":e.value})}render(){let e;const t=void 0===this.props.label?Object(c.a)("Power level"):this.props.label;if(this.state.custom)e=o.a.createElement(le.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{let s=this.state.options.map(e=>({value:e,text:rd.b(e,this.props.usersDefault)}));s.push({value:"SELECT_VALUE_CUSTOM",text:Object(c.a)("Custom level")}),s=s.map(e=>o.a.createElement("option",{value:e.value,key:e.value},e.text)),e=o.a.createElement(le.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled},s)}return o.a.createElement("div",{className:"mx_PowerSelector"},e)}}g()(ad,"propTypes",{value:re.a.number.isRequired,maxValue:re.a.number.isRequired,usersDefault:re.a.number.isRequired,disabled:re.a.bool,onChange:re.a.func,powerLevelKey:re.a.string,label:re.a.string}),g()(ad,"defaultProps",{maxValue:1/0,usersDefault:0});var cd=s(170);class ld extends o.a.PureComponent{constructor(e){super(e),g()(this,"_onChange",e=>{this.props.onChange&&this.props.onChange(this._asFullAlias(e.target.value))}),g()(this,"_onValidate",async e=>{const t=await this._validationRules(e);return this.setState({isValid:t.valid}),t}),g()(this,"_validationRules",Object(dn.a)({rules:[{key:"safeLocalpart",test:async({value:e})=>{if(!e)return!0;const t=this._asFullAlias(e);return!e.includes("#")&&!e.includes(":")&&!e.includes(",")&&encodeURI(t)===t},invalid:()=>Object(c.a)("Some characters not allowed")},{key:"required",test:async({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Please provide a room address")},{key:"taken",final:!0,test:async({value:e})=>{if(!e)return!0;const t=L.a.get();try{return await t.getRoomIdForAlias(this._asFullAlias(e)),!1}catch(e){return!!e.errcode}},valid:()=>Object(c.a)("This address is available to use"),invalid:()=>Object(c.a)("This address is already in use")}]})),this.state={isValid:!0}}_asFullAlias(e){return`#${e}:${this.props.domain}`}render(){const e=d.getComponent("views.elements.Field"),t=o.a.createElement("span",null,"#"),s=":"+this.props.domain,n=o.a.createElement("span",{title:s},s),i=255-this.props.domain.length-2;return o.a.createElement(e,{label:Object(c.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:t,postfixComponent:n,ref:e=>this._fieldRef=e,onValidate:this._onValidate,placeholder:Object(c.a)("e.g. my-room"),onChange:this._onChange,value:this.props.value.substring(1,this.props.value.length-this.props.domain.length-1),maxLength:i})}get isValid(){return this.state.isValid}validate(e){return this._fieldRef.validate(e)}focus(){this._fieldRef.focus()}}g()(ld,"propTypes",{domain:re.a.string.isRequired,onChange:re.a.func,value:re.a.string.isRequired});const dd=function(e){const t=d.getComponent("elements.ActionButton");return o.a.createElement(t,{action:h.a.ViewRoomDirectory,mouseOverAction:e.callout?"callout_room_directory":null,label:Object(c.a)("Room directory"),iconPath:s(1126),size:e.size,tooltip:e.tooltip})};dd.propTypes={size:re.a.string,tooltip:re.a.bool};var ud=dd;class hd extends o.a.Component{constructor(e){super(e),this.state={visible:!1}}toggleVisible(e){this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})}render(){const e=this.props.reason?o.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return o.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible.bind(this)},e," ",o.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}}const md=function(e){const t=d.getComponent("elements.ActionButton");return o.a.createElement(t,{action:"view_create_chat",mouseOverAction:e.callout?"callout_start_chat":null,label:Object(c.a)("Start chat"),iconPath:s(1127),size:e.size,tooltip:e.tooltip})};md.propTypes={size:re.a.string,tooltip:re.a.bool};var pd=md,gd=s(325),fd=s(353);class _d extends o.a.Component{constructor(e){super(e)}render(){let e="mx_TintableSvgButton";return this.props.className&&(e+=" "+this.props.className),o.a.createElement("span",{width:this.props.width,height:this.props.height,className:e},o.a.createElement(fd.a,{src:this.props.src,width:this.props.width,height:this.props.height}),o.a.createElement(Z.a,{onClick:this.props.onClick,element:"span",title:this.props.title}))}}_d.propTypes={src:re.a.string,title:re.a.string,className:re.a.string,width:re.a.string.isRequired,height:re.a.string.isRequired,onClick:re.a.func},_d.defaultProps={onClick:function(){}};class vd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{hover:!1}),g()(this,"onMouseOver",()=>{this.setState({hover:!0})}),g()(this,"onMouseLeave",()=>{this.setState({hover:!1})})}render(){const e=d.getComponent("elements.Tooltip"),t=this.state.hover?o.a.createElement(e,{className:"mx_TooltipButton_container",tooltipClassName:"mx_TooltipButton_helpText",label:this.props.helpText}):o.a.createElement("div",null);return o.a.createElement("div",{className:"mx_TooltipButton",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},"?",t)}}class yd extends o.a.Component{_getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):o.a.Children.toArray(this.props.children).filter(e=>null!=e).slice(e,t)}_getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():o.a.Children.toArray(this.props.children).filter(e=>null!=e).length}render(){let e=null;const t=this._getChildCount();let s=t;if(this.props.truncateAt>=0){const n=t-this.props.truncateAt;n>1&&(e=this.props.createOverflowElement(n,t),s=this.props.truncateAt)}const n=this._getChildren(0,s);return o.a.createElement("div",{className:this.props.className},n,e)}}g()(yd,"propTypes",{truncateAt:re.a.number,className:re.a.string,getChildren:re.a.func,getChildCount:re.a.func,createOverflowElement:re.a.func}),g()(yd,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>o.a.createElement("div",null,Object(c.a)("And %(count)s more...",{count:e}))});function bd(){return w.a.getValue("recent_emoji")||[]}function Ed(e=24){let t=bd();t.length<1&&(!function(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort(([,[e,t]],[,[s,n]])=>n-t).map(([e,[t,s]])=>[e,t]);w.a.setValue("recent_emoji",null,je.a.ACCOUNT,t.slice(0,100))}(),t=bd());return Object(jt.orderBy)(t,"1","desc").slice(0,e).map(([e])=>e)}function Sd(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class wd extends o.a.Component{constructor(e){super(e),g()(this,"onScroll",()=>{const e=this.bodyRef.current;this.setState({scrollTop:e.scrollTop,viewportHeight:e.clientHeight}),this.updateVisibility()}),this.state={filter:"",previewEmoji:null,scrollTop:0,viewportHeight:280},this.recentlyUsed=Array.from(new Set(Ed().map(yi.e).filter(Boolean))),this.memoizedDataByCategory=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Sd(Object(s),!0).forEach((function(t){g()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Sd(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({recent:this.recentlyUsed},yi.a),this.categories=[{id:"recent",name:Object(c.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:o.a.createRef()},{id:"people",name:Object(c.a)("Smileys & People"),enabled:!0,visible:!0,ref:o.a.createRef()},{id:"nature",name:Object(c.a)("Animals & Nature"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"foods",name:Object(c.a)("Food & Drink"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"activity",name:Object(c.a)("Activities"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"places",name:Object(c.a)("Travel & Places"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"objects",name:Object(c.a)("Objects"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"symbols",name:Object(c.a)("Symbols"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"flags",name:Object(c.a)("Flags"),enabled:!0,visible:!1,ref:o.a.createRef()}],this.bodyRef=o.a.createRef(),this.onChangeFilter=this.onChangeFilter.bind(this),this.onHoverEmoji=this.onHoverEmoji.bind(this),this.onHoverEmojiEnd=this.onHoverEmojiEnd.bind(this),this.onClickEmoji=this.onClickEmoji.bind(this),this.scrollToCategory=this.scrollToCategory.bind(this),this.updateVisibility=this.updateVisibility.bind(this)}updateVisibility(){const e=this.bodyRef.current,t=e.getBoundingClientRect();for(const s of this.categories){const n=e.querySelector(`[data-category-id="${s.id}"]`);if(!n){s.visible=!1,s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const i=n.getBoundingClientRect(),o=i.y-t.y,r=i.y+i.height-t.y;s.visible=o<t.height&&r>0,s.visible?(s.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected",!0),s.ref.current.setAttribute("tabindex",0)):(s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected",!1),s.ref.current.setAttribute("tabindex",-1))}}scrollToCategory(e){this.bodyRef.current.querySelector(`[data-category-id="${e}"]`).scrollIntoView()}onChangeFilter(e){e=e.toLowerCase();for(const t of this.categories){let s;s=e.includes(this.state.filter)?this.memoizedDataByCategory[t.id]:"recent"===t.id?this.recentlyUsed:yi.a[t.id],s=s.filter(t=>t.filterString.includes(e)),this.memoizedDataByCategory[t.id]=s,t.enabled=s.length>0,t.ref.current.disabled=!t.enabled}this.setState({filter:e}),setTimeout(this.updateVisibility,0)}onHoverEmoji(e){this.setState({previewEmoji:e})}onHoverEmojiEnd(e){this.setState({previewEmoji:null})}onClickEmoji(e){!1!==this.props.onChoose(e.unicode)&&function(e){const t=bd(),s=t.findIndex(([t])=>t===e);let n;s>=0?([n]=t.splice(s,1),n[1]++):n=[e,1],w.a.setValue("recent_emoji",null,je.a.ACCOUNT,[n,...t].slice(0,100))}(e.unicode)}_categoryHeightForEmojiCount(e){return 0===e?0:22+37*Math.ceil(e/8)}render(){const e=d.getComponent("emojipicker.Header"),t=d.getComponent("emojipicker.Search"),s=d.getComponent("emojipicker.Category"),n=d.getComponent("emojipicker.Preview"),i=d.getComponent("emojipicker.QuickReactions");let a=0;return o.a.createElement("div",{className:"mx_EmojiPicker"},o.a.createElement(e,{categories:this.categories,defaultCategory:"recent",onAnchorClick:this.scrollToCategory}),o.a.createElement(t,{query:this.state.filter,onChange:this.onChangeFilter}),o.a.createElement(r.a,{className:"mx_EmojiPicker_body",wrappedRef:e=>this.bodyRef.current=e,onScroll:this.onScroll},this.categories.map(e=>{const t=this.memoizedDataByCategory[e.id],n=o.a.createElement(s,{key:e.id,id:e.id,name:e.name,heightBefore:a,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:t,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,selectedEmojis:this.props.selectedEmojis}),i=this._categoryHeightForEmojiCount(t.length);return a+=i,n})),this.state.previewEmoji||!this.props.showQuickReactions?o.a.createElement(n,{emoji:this.state.previewEmoji}):o.a.createElement(i,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}}g()(wd,"propTypes",{onChoose:re.a.func.isRequired,selectedEmojis:re.a.instanceOf(Set),showQuickReactions:re.a.bool});var Cd=wd;class Rd extends o.a.PureComponent{constructor(...e){super(...e),g()(this,"_renderEmojiRow",e=>{const{onClick:t,onMouseEnter:s,onMouseLeave:n,selectedEmojis:i,emojis:r}=this.props,a=r.slice(8*e,8*(e+1)),c=d.getComponent("emojipicker.Emoji");return o.a.createElement("div",{key:e},a.map(e=>o.a.createElement(c,{key:e.hexcode,emoji:e,selectedEmojis:i,onClick:t,onMouseEnter:s,onMouseLeave:n})))})}render(){const{emojis:e,name:t,heightBefore:s,viewportHeight:n,scrollTop:i}=this.props;if(!e||0===e.length)return null;const r=new Array(Math.ceil(e.length/8));for(let e=0;e<r.length;++e)r[e]=e;const a=d.getComponent("elements.LazyRenderList"),c=i,l=c+n,u=s+22,h=u+37*r.length,m=Math.max(c,u),p=Math.min(l,h),g=Math.max(0,p-m),f=Math.max(0,i-u);return o.a.createElement("section",{id:"mx_EmojiPicker_category_"+this.props.id,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},o.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),o.a.createElement(a,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:37,items:r,scrollTop:f,height:g,overflowItems:3,overflowMargin:0,renderItem:this._renderEmojiRow}))}}g()(Rd,"propTypes",{emojis:re.a.arrayOf(re.a.object).isRequired,name:re.a.string.isRequired,id:re.a.string.isRequired,onMouseEnter:re.a.func.isRequired,onMouseLeave:re.a.func.isRequired,onClick:re.a.func.isRequired,selectedEmojis:re.a.instanceOf(Set)});var kd=Rd;class Id extends o.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:s,emoji:i,selectedEmojis:r}=this.props,a=r&&r.has(i.unicode);return o.a.createElement(n.f,{element:"li",onClick:()=>e(i),onMouseEnter:()=>t(i),onMouseLeave:()=>s(i),className:"mx_EmojiPicker_item_wrapper",label:i.unicode},o.a.createElement("div",{className:"mx_EmojiPicker_item "+(a?"mx_EmojiPicker_item_selected":"")},i.unicode))}}g()(Id,"propTypes",{onClick:re.a.func,onMouseEnter:re.a.func,onMouseLeave:re.a.func,emoji:re.a.object.isRequired,selectedEmojis:re.a.instanceOf(Set)});var Od=Id;class Td extends o.a.PureComponent{constructor(...e){super(...e),g()(this,"onKeyDown",e=>{let t=!0;switch(e.key){case Yt.a.ARROW_LEFT:this.changeCategoryRelative(-1);break;case Yt.a.ARROW_RIGHT:this.changeCategoryRelative(1);break;case Yt.a.HOME:this.changeCategoryAbsolute(0);break;case Yt.a.END:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})}findNearestEnabled(e,t){e+=this.props.categories.length;const s=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<s.length&&e>=0;){if(s[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex(e=>e.visible);this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e,t=1){const s=this.props.categories[this.findNearestEnabled(e,t)];s&&(this.props.onAnchorClick(s.id),s.ref.current.focus())}render(){return o.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(c.a)("Categories"),onKeyDown:this.onKeyDown},this.props.categories.map(e=>{const t=E()("mx_EmojiPicker_anchor mx_EmojiPicker_anchor_"+e.id,{mx_EmojiPicker_anchor_visible:e.visible});return o.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:t,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":"mx_EmojiPicker_category_"+e.id})}))}}g()(Td,"propTypes",{categories:re.a.arrayOf(re.a.object).isRequired,onAnchorClick:re.a.func.isRequired});var xd=Td;class Nd extends o.a.PureComponent{render(){const{unicode:e="",annotation:t="",shortcodes:[s=""]}=this.props.emoji||{};return o.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},o.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),o.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},o.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),o.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},s)))}}g()(Nd,"propTypes",{emoji:re.a.object});var jd=Nd;const Pd=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map(e=>{const t=Object(yi.e)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t});class Dd extends o.a.Component{constructor(e){super(e),this.state={hover:null},this.onMouseEnter=this.onMouseEnter.bind(this),this.onMouseLeave=this.onMouseLeave.bind(this)}onMouseEnter(e){this.setState({hover:e})}onMouseLeave(){this.setState({hover:null})}render(){const e=d.getComponent("emojipicker.Emoji");return o.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},o.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.annotation),o.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(c.a)("Quick Reactions")),o.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(c.a)("Quick Reactions")},Pd.map(t=>o.a.createElement(e,{key:t.hexcode,emoji:t,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis}))))}}g()(Dd,"propTypes",{onClick:re.a.func.isRequired,selectedEmojis:re.a.instanceOf(Set)});var Ad=Dd;class Ud extends o.a.Component{constructor(e){super(e),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.onChoose=this.onChoose.bind(this),this.onReactionsChange=this.onReactionsChange.bind(this),this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getReactions(){if(!this.props.reactions)return{};const e=L.a.get().getUserId(),t=this.props.reactions.getAnnotationsBySender()[e]||[];return Object.fromEntries([...t].filter(e=>!e.isRedacted()).map(e=>[e.getRelation().key,e.getId()]))}onReactionsChange(){this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})}onChoose(e){this.componentWillUnmount(),this.props.onFinished();const t=this.getReactions();return t.hasOwnProperty(e)?(L.a.get().redactEvent(this.props.mxEvent.getRoomId(),t[e]),!1):(L.a.get().sendEvent(this.props.mxEvent.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:this.props.mxEvent.getId(),key:e}}),u.a.dispatch({action:"message_sent"}),!0)}render(){return o.a.createElement(Cd,{onChoose:this.onChoose,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}}g()(Ud,"propTypes",{mxEvent:re.a.object.isRequired,onFinished:re.a.func.isRequired,reactions:re.a.object});var Md=Ud;class Ld extends o.a.PureComponent{constructor(e){super(e),this.inputRef=o.a.createRef()}componentDidMount(){setTimeout(()=>this.inputRef.current.focus(),0)}render(){let e;return e=this.props.query?o.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(c.a)("Cancel search")}):o.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),o.a.createElement("div",{className:"mx_EmojiPicker_search"},o.a.createElement("input",{autoFocus:!0,type:"text",placeholder:"Search",value:this.props.query,onChange:e=>this.props.onChange(e.target.value),ref:this.inputRef}),e)}}g()(Ld,"propTypes",{query:re.a.string.isRequired,onChange:re.a.func.isRequired});var Fd=Ld;class Bd extends o.a.Component{constructor(e,t){super(e,t),g()(this,"onClick",e=>{u.a.dispatch({action:"view_group",group_id:this.props.group.groupId})}),g()(this,"onMouseEnter",()=>{const e={hover:!0};this.context.isGuest()||(e.badgeHover=!0),this.setState(e)}),g()(this,"onMouseLeave",()=>{this.setState({badgeHover:!1,hover:!1})}),g()(this,"onContextMenuButtonClick",e=>{e.stopPropagation(),e.preventDefault(),this._showContextMenu(e.target.getBoundingClientRect())}),g()(this,"onContextMenu",e=>{e.preventDefault(),this._showContextMenu({right:e.clientX,top:e.clientY,height:0})}),g()(this,"closeMenu",()=>{this.setState({contextMenuPosition:null})}),this.state={hover:!1,badgeHover:!1,menuDisplayed:!1,selected:null===this.props.group.groupId}}_showContextMenu(e){if(L.a.get().isGuest())return;const t={contextMenuPosition:e};this.props.collapsed&&(t.hover=!1),this.setState(t)}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("avatars.BaseAvatar"),s=this.props.group.name||this.props.group.groupId,i=this.props.group.avatarUrl?this.context.mxcUrlToHttp(this.props.group.avatarUrl,24,24):null,r=o.a.createElement(t,{name:s,width:24,height:24,url:i}),a=Boolean(this.state.contextMenuPosition),l=E()("mx_RoomTile_name mx_RoomTile_invite mx_RoomTile_badgeShown",{mx_RoomTile_badgeShown:this.state.badgeHover||a}),u=o.a.createElement("div",{title:this.props.group.groupId,className:l,tabIndex:-1,dir:"auto"},s),h=this.state.badgeHover||a,m=E()("mx_RoomTile_badge mx_RoomTile_highlight",{mx_RoomTile_badgeButton:h}),p=h?"···":"!";let g;if(this.props.collapsed&&this.state.hover){const e=d.getComponent("elements.Tooltip");g=o.a.createElement(e,{className:"mx_RoomTile_tooltip",label:s,dir:"auto"})}const f=E()("mx_RoomTile mx_RoomTile_highlight",{mx_RoomTile_menuDisplayed:a,mx_RoomTile_selected:this.state.selected,mx_GroupInviteTile:!0});let _;if(a){const e=d.getComponent("context_menus.GroupInviteTileContextMenu");_=o.a.createElement(n.b,B()({},Object(n.n)(this.state.contextMenuPosition),{onFinished:this.closeMenu}),o.a.createElement(e,{group:this.props.group,onFinished:this.closeMenu}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(P.d,null,({onFocus:t,isActive:s,ref:i})=>o.a.createElement(e,{onFocus:t,tabIndex:s?0:-1,inputRef:i,className:f,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onContextMenu:this.onContextMenu},o.a.createElement("div",{className:"mx_RoomTile_avatar"},r),o.a.createElement("div",{className:"mx_RoomTile_nameContainer"},u,o.a.createElement(n.c,{className:m,onClick:this.onContextMenuButtonClick,label:Object(c.a)("Options"),isExpanded:a,tabIndex:s?0:-1},p)),g)),_)}}g()(Bd,"propTypes",void 0),g()(Bd,"contextType",S.a);class Vd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{members:null,membersError:null,invitedMembers:null,invitedMembersError:null,truncateAt:30}),g()(this,"_createOverflowTile",(e,t)=>{const n=d.getComponent("rooms.EntityTile"),i=d.getComponent("avatars.BaseAvatar"),r=Object(c.a)("and %(count)s others...",{count:e});return o.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:o.a.createElement(i,{url:s(362),name:"...",width:36,height:36}),name:r,presenceState:"online",suppressOnHover:!0,onClick:this._showFullMemberList})}),g()(this,"_showFullMemberList",()=>{this.setState({truncateAt:-1})}),g()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),g()(this,"onInviteToGroupButtonClick",()=>{Object(er.b)(this.props.groupId).then(()=>{u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Lt.b.GroupMemberList,refireParams:{groupId:this.props.groupId}})})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0}_initGroupStore(e){Zo.a.registerListener(e,()=>{this._fetchMembers()}),Zo.a.on("error",(t,s,n)=>{this._unmounted||e!==s||(n===Zo.a.STATE_KEY.GroupMembers&&this.setState({membersError:t}),n===Zo.a.STATE_KEY.GroupInvitedMembers&&this.setState({invitedMembersError:t}))})}_fetchMembers(){this._unmounted||this.setState({members:Zo.a.getGroupMembers(this.props.groupId),invitedMembers:Zo.a.getGroupInvitedMembers(this.props.groupId)})}makeGroupMemberTiles(e,t,s){if(s)return o.a.createElement("div",{className:"warning"},Object(c.a)("Failed to load group members"));const n=d.getComponent("groups.GroupMemberTile"),i=d.getComponent("elements.TruncatedList");(e=(e||"").toLowerCase())&&(t=t.filter(t=>{const s=(t.displayname||"").toLowerCase().includes(e),n=t.userId.toLowerCase().includes(e);return!(!s&&!n)}));const r={};t.forEach(e=>{r[e.userId]||(r[e.userId]=e)}),(t=Object.keys(r).map(e=>r[e])).sort((e,t)=>{if(e.isPrivileged===t.isPrivileged){const s=e.displayname||e.userId,n=t.displayname||t.userId;return s<n?-1:s>n?1:0}return e.isPrivileged?-1:1});const a=t.map(e=>o.a.createElement(n,{key:e.userId,groupId:this.props.groupId,member:e}));return o.a.createElement(i,{className:"mx_MemberList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},a)}render(){if(this.state.fetching||this.state.fetchingInvitedMembers){const e=d.getComponent("elements.Spinner");return o.a.createElement("div",{className:"mx_MemberList"},o.a.createElement(e,null))}const e=o.a.createElement("input",{className:"mx_GroupMemberList_query mx_textinput",id:"mx_GroupMemberList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(c.a)("Filter community members"),autoComplete:"off"}),t=this.state.members?o.a.createElement("div",{className:"mx_MemberList_joined"},this.makeGroupMemberTiles(this.state.searchQuery,this.state.members,this.state.membersError)):o.a.createElement("div",null),s=this.state.invitedMembers&&this.state.invitedMembers.length>0?o.a.createElement("div",{className:"mx_MemberList_invited"},o.a.createElement("h2",null,Object(c.a)("Invited")),this.makeGroupMemberTiles(this.state.searchQuery,this.state.invitedMembers,this.state.invitedMembersError)):o.a.createElement("div",null);let n;return Zo.a.isUserPrivileged(this.props.groupId)&&(n=o.a.createElement(Z.a,{className:"mx_MemberList_invite mx_MemberList_inviteCommunity",onClick:this.onInviteToGroupButtonClick},o.a.createElement("span",null,Object(c.a)("Invite to this community")))),o.a.createElement("div",{className:"mx_MemberList",role:"tabpanel"},n,o.a.createElement(r.a,null,t,s),e)}}g()(Vd,"propTypes",{groupId:re.a.string.isRequired});class Kd extends o.a.Component{constructor(...e){super(...e),g()(this,"onClick",e=>{u.a.dispatch({action:"view_group_user",member:this.props.member,groupId:this.props.groupId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("rooms.EntityTile"),s=this.props.member.displayname||this.props.member.userId,n=this.context.mxcUrlToHttp(this.props.member.avatarUrl,36,36,"crop"),i=o.a.createElement(e,{"aria-hidden":"true",name:this.props.member.displayname||this.props.member.userId,idName:this.props.member.userId,width:36,height:36,url:n});return o.a.createElement(t,{name:s,avatarJsx:i,onClick:this.onClick,suppressOnHover:!0,presenceState:"online",powerStatus:this.props.member.isPrivileged?t.POWER_STATUS_ADMIN:null})}}g()(Kd,"propTypes",{groupId:re.a.string.isRequired,member:pc.a.isRequired}),g()(Kd,"contextType",S.a);class qd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{busy:!1,ready:!1,isGroupPublicised:!1}),g()(this,"_onPublicityToggle",()=>{this.setState({busy:!0,isGroupPublicised:!this.state.isGroupPublicised}),Zo.a.setGroupPublicity(this.props.groupId,!this.state.isGroupPublicised).then(()=>{this.setState({busy:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}_initGroupStore(e){this._groupStoreToken=Zo.a.registerListener(e,()=>{this.setState({isGroupPublicised:Boolean(Zo.a.getGroupPublicity(e)),ready:Zo.a.isStateReady(e,Zo.a.STATE_KEY.Summary)})})}componentWillUnmount(){this._groupStoreToken&&this._groupStoreToken.unregister()}render(){const e=d.getComponent("groups.GroupTile");return o.a.createElement("div",{className:"mx_GroupPublicity_toggle"},o.a.createElement(e,{groupId:this.props.groupId,showDescription:!1,avatarHeight:40,draggable:!1}),o.a.createElement(qe.a,{checked:this.state.isGroupPublicised,disabled:!this.state.ready||this.state.busy,onChange:this._onPublicityToggle}))}}g()(qd,"propTypes",{groupId:re.a.string.isRequired});class Gd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{isUserPrivilegedInGroup:null,groupRoom:null,groupRoomPublicityLoading:!1,groupRoomRemoveLoading:!1}),g()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:Zo.a.isUserPrivileged(this.props.groupId)}),this._updateGroupRoom()}),g()(this,"_onRemove",e=>{const t=this.props.groupId,s=this.state.groupRoom.displayname;e.preventDefault(),e.stopPropagation();const n=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Confirm removal of group from room","",n,{title:Object(c.a)("Are you sure you want to remove '%(roomName)s' from %(groupId)s?",{roomName:s,groupId:t}),description:Object(c.a)("Removing a room from the community will also remove it from the community page."),button:Object(c.a)("Remove"),onFinished:e=>{if(!e)return;this.setState({groupRoomRemoveLoading:!0});const t=this.props.groupId,n=this.props.groupRoomId;Zo.a.removeRoomFromGroup(this.props.groupId,n).then(()=>{u.a.dispatch({action:"view_group_room_list"})}).catch(e=>{console.error(`Error whilst removing ${n} from ${t}`,e);const i=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove room from group","",i,{title:Object(c.a)("Failed to remove room from community"),description:Object(c.a)("Failed to remove '%(roomName)s' from %(groupId)s",{groupId:t,roomName:s})})}).finally(()=>{this.setState({groupRoomRemoveLoading:!1})})}})}),g()(this,"_onCancel",e=>{u.a.dispatch({action:"view_group_room_list"})}),g()(this,"_changeGroupRoomPublicity",e=>{const t="public"===e.target.value;this.setState({groupRoomPublicityLoading:!0});const s=this.props.groupId,n=this.props.groupRoomId,i=this.state.groupRoom.displayname;Zo.a.updateGroupRoomVisibility(this.props.groupId,n,t).catch(e=>{console.error(`Error whilst changing visibility of ${n} in ${s} to ${t}`,e);const o=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove room from group","",o,{title:Object(c.a)("Something went wrong!"),description:Object(c.a)("The visibility of '%(roomName)s' in %(groupId)s could not be updated.",{roomName:i,groupId:s})})}).finally(()=>{this.setState({groupRoomPublicityLoading:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}componentWillUnmount(){this._unregisterGroupStore(this.props.groupId)}_initGroupStore(e){Zo.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(e){Zo.a.unregisterListener(this.onGroupStoreUpdated)}_updateGroupRoom(){this.setState({groupRoom:Zo.a.getGroupRooms(this.props.groupId).find(e=>e.roomId===this.props.groupRoomId)})}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.InlineSpinner");if(this.state.groupRoomRemoveLoading||!this.state.groupRoom){const e=d.getComponent("elements.Spinner");return o.a.createElement("div",{className:"mx_MemberInfo"},o.a.createElement(e,null))}let n;this.state.isUserPrivilegedInGroup&&(n=o.a.createElement("div",{className:"mx_MemberInfo_adminTools"},o.a.createElement("h3",null,Object(c.a)("Admin Tools")),o.a.createElement("div",{className:"mx_MemberInfo_buttons"},o.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this._onRemove},Object(c.a)("Remove from community"))),o.a.createElement("h3",null,Object(c.a)("Visibility in Room List"),this.state.groupRoomPublicityLoading?o.a.createElement(t,null):o.a.createElement("div",null)),o.a.createElement("div",null,o.a.createElement("label",null,o.a.createElement("input",{type:"radio",value:"public",checked:this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),o.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(c.a)("Visible to everyone")))),o.a.createElement("div",null,o.a.createElement("label",null,o.a.createElement("input",{type:"radio",value:"private",checked:!this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),o.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(c.a)("Only visible to community members"))))));const i=this.state.groupRoom.avatarUrl;let a;if(i){const e=this.context.mxcUrlToHttp(i,800,800);a=o.a.createElement("div",{className:"mx_MemberInfo_avatar"},o.a.createElement("img",{src:e}))}const l=this.state.groupRoom.displayname;return o.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},o.a.createElement(r.a,null,o.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this._onCancel},o.a.createElement("img",{src:s(152),width:"18",height:"18",className:"mx_filterFlipColor"})),a,o.a.createElement("h2",null,l),o.a.createElement("div",{className:"mx_MemberInfo_profile"},o.a.createElement("div",{className:"mx_MemberInfo_profileField"},this.state.groupRoom.canonicalAlias)),n))}}g()(Gd,"contextType",S.a),g()(Gd,"propTypes",{groupId:re.a.string,groupRoomId:re.a.string});class Wd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{rooms:null,truncateAt:30,searchQuery:""}),g()(this,"onGroupStoreUpdated",()=>{this._unmounted||this.setState({rooms:Zo.a.getGroupRooms(this.props.groupId)})}),g()(this,"_createOverflowTile",(e,t)=>{const n=d.getComponent("rooms.EntityTile"),i=d.getComponent("avatars.BaseAvatar"),r=Object(c.a)("and %(count)s others...",{count:e});return o.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:o.a.createElement(i,{url:s(362),name:"...",width:36,height:36}),name:r,presenceState:"online",suppressOnHover:!0,onClick:this._showFullRoomList})}),g()(this,"_showFullRoomList",()=>{this.setState({truncateAt:-1})}),g()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),g()(this,"onAddRoomToGroupButtonClick",()=>{Object(er.a)(this.props.groupId).then(()=>{this.forceUpdate()})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0,this._unregisterGroupStore()}_unregisterGroupStore(){Zo.a.unregisterListener(this.onGroupStoreUpdated)}_initGroupStore(e){Zo.a.registerListener(e,this.onGroupStoreUpdated),Zo.a.on("error",(t,s)=>{s===e&&this.setState({rooms:null})})}makeGroupRoomTiles(e){const t=d.getComponent("groups.GroupRoomTile");e=(e||"").toLowerCase();let s=this.state.rooms;return e&&(s=s.filter(t=>{const s=(t.name||"").toLowerCase().includes(e),n=(t.canonicalAlias||"").toLowerCase().includes(e);return s||n})),s=s.map((e,s)=>o.a.createElement(t,{key:s,groupId:this.props.groupId,groupRoom:e})),s}render(){if(null===this.state.rooms)return null;let e;Zo.a.isUserPrivileged(this.props.groupId)&&(e=o.a.createElement(Z.a,{className:"mx_MemberList_invite mx_MemberList_addRoomToCommunity",onClick:this.onAddRoomToGroupButtonClick},o.a.createElement("span",null,Object(c.a)("Add rooms to this community"))));const t=o.a.createElement("input",{className:"mx_GroupRoomList_query mx_textinput",id:"mx_GroupRoomList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(c.a)("Filter community rooms"),autoComplete:"off"}),s=d.getComponent("elements.TruncatedList");return o.a.createElement("div",{className:"mx_GroupRoomList",role:"tabpanel"},e,o.a.createElement(r.a,{className:"mx_GroupRoomList_joined mx_GroupRoomList_outerWrapper"},o.a.createElement(s,{className:"mx_GroupRoomList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},this.makeGroupRoomTiles(this.state.searchQuery))),t)}}g()(Wd,"propTypes",{groupId:re.a.string.isRequired});class Hd extends o.a.Component{constructor(...e){super(...e),g()(this,"onClick",e=>{u.a.dispatch({action:"view_group_room",groupId:this.props.groupId,groupRoomId:this.props.groupRoom.roomId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.context.mxcUrlToHttp(this.props.groupRoom.avatarUrl,36,36,"crop"),n=o.a.createElement(e,{name:this.props.groupRoom.displayname,width:36,height:36,url:s});return o.a.createElement(t,{className:"mx_GroupRoomTile",onClick:this.onClick},o.a.createElement("div",{className:"mx_GroupRoomTile_avatar"},n),o.a.createElement("div",{className:"mx_GroupRoomTile_name"},this.props.groupRoom.displayname))}}g()(Hd,"propTypes",{groupId:re.a.string.isRequired,groupRoom:pc.b.isRequired}),g()(Hd,"contextType",S.a);var $d=Hd;function zd(){}class Yd extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{profile:null}),g()(this,"onMouseDown",e=>{e.preventDefault(),u.a.dispatch({action:"view_group",group_id:this.props.groupId})})}componentDidMount(){Vt.a.getGroupProfileCached(this.context,this.props.groupId).then(e=>{this.setState({profile:e})}).catch(e=>{console.error("Error whilst getting cached profile for GroupTile",e)})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.state.profile||{},n=s.name||this.props.groupId,i=this.props.avatarHeight,r=this.props.showDescription?o.a.createElement("div",{className:"mx_GroupTile_desc"},s.shortDescription):o.a.createElement("div",null),a=s.avatarUrl?this.context.mxcUrlToHttp(s.avatarUrl,i,i,"crop"):null;let c=o.a.createElement("div",{className:"mx_GroupTile_avatar"},o.a.createElement(e,{name:n,idName:this.props.groupId,url:a,width:i,height:i}));if(this.props.draggable){const e=c;c=o.a.createElement(y.Droppable,{droppableId:"my-groups-droppable",type:"draggable-TagTile"},(t,s)=>o.a.createElement("div",{ref:t.innerRef},o.a.createElement(y.Draggable,{key:"GroupTile "+this.props.groupId,draggableId:"GroupTile "+this.props.groupId,index:this.props.groupId,type:"draggable-TagTile"},(t,s)=>o.a.createElement("div",null,o.a.createElement("div",B()({ref:t.innerRef},t.draggableProps,t.dragHandleProps),e),t.placeholder?e:o.a.createElement("div",null)))))}return o.a.createElement(t,{className:"mx_GroupTile",onMouseDown:this.onMouseDown,onClick:zd},c,o.a.createElement("div",{className:"mx_GroupTile_profile"},o.a.createElement("div",{className:"mx_GroupTile_name"},n),r,o.a.createElement("div",{className:"mx_GroupTile_groupId"},this.props.groupId)))}}g()(Yd,"propTypes",{groupId:re.a.string.isRequired,showDescription:re.a.bool,avatarHeight:re.a.number,draggable:re.a.bool}),g()(Yd,"contextType",S.a),g()(Yd,"defaultProps",{showDescription:!0,avatarHeight:50,draggable:!0});var Jd=Yd;class Qd extends o.a.Component{getLabel(){const e=new Date(this.props.ts),t=new Date,s=new Date,n=[Object(c.a)("Sunday"),Object(c.a)("Monday"),Object(c.a)("Tuesday"),Object(c.a)("Wednesday"),Object(c.a)("Thursday"),Object(c.a)("Friday"),Object(c.a)("Saturday")];return s.setDate(t.getDate()-1),e.toDateString()===t.toDateString()?Object(c.a)("Today"):e.toDateString()===s.toDateString()?Object(c.a)("Yesterday"):t.getTime()-e.getTime()<5184e5?n[e.getDay()]:Object(mr.c)(e)}render(){return o.a.createElement("h2",{className:"mx_DateSeparator",role:"separator",tabIndex:-1},o.a.createElement("hr",{role:"none"}),o.a.createElement("div",null,this.getLabel()),o.a.createElement("hr",{role:"none"}))}}g()(Qd,"propTypes",{ts:re.a.number.isRequired});var Xd=s(1128),Zd=s.n(Xd),eu=s(1129);const tu=function(){let e=null;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function su(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(qn.a)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(qn.a)(e,null,t))}function nu(e){const t=document.createElement(Object(qn.b)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function iu(e){const t=document.createElement(Object(qn.b)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function ou(e){if("#text"===e.nodeName)return lu(e.data);{const t=document.createElement(e.nodeName);if(e.attributes)for(const[s,n]of Object.entries(e.attributes))t.setAttribute(s,n);if(e.childNodes)for(const s of e.childNodes)t.appendChild(ou(s));return t}}function ru(e,t,s){t?e.insertBefore(s,t):e.appendChild(s)}function au(e,t){for(let s=0;s<e.length-1;++s)if(e[s]!==t[s])return!1;const s=e.length-1;return t[s]>=e[s]}function cu(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const s=1;for(const n of t)au(e.route,n.route)&&(n.route[e.route.length-1]+=s)}}function lu(e){return document.createTextNode(tu(e))}function du(e,t,s){const{refNode:n,refParentNode:i}=function(e,t,s){let n,i=e;const o=s?t.length-1:t.length;for(let e=0;e<o;++e)n=i,i=i.childNodes[t[e]];return{refNode:i,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{const e=document.createElement("span"),s=iu(ou(t.oldValue)),i=nu(ou(t.newValue));e.appendChild(s),e.appendChild(i),n.parentNode.replaceChild(e,n);break}case"removeTextElement":{const e=iu(lu(t.value));n.parentNode.replaceChild(e,n);break}case"removeElement":{const e=iu(ou(t.element));n.parentNode.replaceChild(e,n);break}case"modifyTextElement":{const e=s.diff_main(t.oldValue,t.newValue);s.diff_cleanupSemantic(e);const i=document.createElement("span");for(const[t,s]of e){let e=lu(s);t<0?e=iu(e):t>0&&(e=nu(e)),i.appendChild(e)}n.parentNode.replaceChild(i,n);break}case"addElement":ru(i,n,nu(ou(t.element)));break;case"addTextElement":ru(i,n,nu(lu("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{const e=iu(n.cloneNode(!0)),s=n.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?s.setAttribute(t.name,t.newValue):s.removeAttribute(t.name);const i=nu(s),o=document.createElement(Object(qn.b)(n)?"div":"span");o.appendChild(e),o.appendChild(i),n.parentNode.replaceChild(o,n);break}default:console.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}function uu(e,t){return e.length===t.length&&!e.some((e,s)=>e!==t[s])}function hu(e,t){const s=`<div>${su(e)}</div>`,n=`<div>${su(t)}</div>`,i=function(e){const t=e.slice();for(let e=0;e<t.length;++e){const s=t[e];if("removeTextElement"===s.action){const n=t[e+1];n&&"addTextElement"===n.action&&n.text===s.text&&uu(n.route,s.route)&&t.splice(e,2)}}return t}((new eu.DiffDOM).diff(s,n)),r=new Zd.a,a=(new DOMParser).parseFromString(s,"text/html").body.children[0];for(let e=0;e<i.length;++e){const t=i[e];du(a,t,r),cu(t,i.slice(e+1))}const c=a.innerHTML,l=E()({mx_EventTile_body:!0,"markdown-body":!0});return o.a.createElement("span",{key:"body",className:l,dangerouslySetInnerHTML:{__html:c},dir:"auto"})}var mu=s(542);function pu(e){const t=e.getOriginalContent();return t["m.new_content"]||t}class gu extends o.a.PureComponent{constructor(e){super(e),g()(this,"_onAssociatedStatusChanged",()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})}),g()(this,"_onRedactClick",async()=>{const e=this.props.mxEvent,t=L.a.get(),s=d.getComponent("dialogs.ConfirmAndWaitRedactDialog");ke.a.createTrackedDialog("Confirm Redact Dialog","Edit history",s,{redact:()=>t.redactEvent(e.getRoomId(),e.getId())},"mx_Dialog_confirmredact")}),g()(this,"_onViewSourceClick",()=>{const e=d.getComponent("structures.ViewSource");ke.a.createTrackedDialog("View Event Source","Edit history",e,{roomId:this.props.mxEvent.getRoomId(),eventId:this.props.mxEvent.getId(),content:this.props.mxEvent.event},"mx_Dialog_viewsource")});const t=L.a.get(),{userId:s}=t.credentials,n=this.props.mxEvent,o=t.getRoom(n.getRoomId());n.localRedactionEvent()&&n.localRedactionEvent().on("status",this._onAssociatedStatusChanged);const r=o.currentState.maySendRedactionForEvent(n,s);this.state={canRedact:r,sendStatus:n.getAssociatedStatus()},this._content=Object(i.createRef)(),this._pills=[]}pillifyLinks(){this._content.current&&Object(mu.a)(this._content.current.children,this.props.mxEvent,this._pills)}componentDidMount(){this.pillifyLinks()}componentWillUnmount(){Object(mu.b)(this._pills);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off("status",this._onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks()}_renderActionBar(){const e=d.getComponent("elements.AccessibleButton");let t;this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(t=o.a.createElement(e,{onClick:this._onRedactClick},Object(c.a)("Remove")));const s=o.a.createElement(e,{onClick:this._onViewSourceClick},Object(c.a)("View Source"));return o.a.createElement("div",{className:"mx_MessageActionBar"},t,s)}render(){const{mxEvent:e}=this.props,t=pu(e);let s;if(e.isRedacted())s=o.a.createElement(un.a,{mxEvent:this.props.mxEvent});else{let n;if(n=this.props.previousEdit?hu(pu(this.props.previousEdit),t):qn.a(t,null,{stripReplyFallback:!0}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();s=o.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},"* ",o.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",n)}else s=o.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},n)}const n=Object(mr.d)(new Date(e.getTs()),this.props.isTwelveHour),i=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),r=E()({mx_EventTile:!0,mx_EventTile_sending:i,mx_EventTile_notSent:"not_sent"===this.state.sendStatus});return o.a.createElement("li",null,o.a.createElement("div",{className:r},o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("span",{className:"mx_MessageTimestamp"},n),s,this._renderActionBar())))}}g()(gu,"propTypes",{mxEvent:re.a.instanceOf(de.i).isRequired,previousEdit:re.a.instanceOf(de.i),isBaseEvent:re.a.bool});class fu extends o.a.Component{render(){const{mxEvent:e}=this.props;let t,s="mx_EventTile_bubble mx_cryptoEvent mx_cryptoEvent_icon";return"m.megolm.v1.aes-sha2"===e.getContent().algorithm&&L.a.get().isRoomEncrypted(e.getRoomId())?t=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_cryptoEvent_title"},Object(c.a)("Encryption enabled")),o.a.createElement("div",{className:"mx_cryptoEvent_subtitle"},Object(c.a)("Messages in this room are end-to-end encrypted. Learn more & verify this user in their user profile."))):(t=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_cryptoEvent_title"},Object(c.a)("Encryption not enabled")),o.a.createElement("div",{className:"mx_cryptoEvent_subtitle"},Object(c.a)("The encryption used by this room isn't supported."))),s+=" mx_cryptoEvent_icon_warning"),o.a.createElement("div",{className:s},t)}}fu.propTypes={mxEvent:re.a.object.isRequired};var _u=s(492),vu=s.n(_u);const yu={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0};function bu(e){const t=L.a.get().mxcUrlToHttp(e.url);return Promise.resolve(fetch(t)).then((function(e){return e.arrayBuffer()})).then((function(t){return vu.a.decryptAttachment(t,e)})).then((function(t){let s=e.mimetype?e.mimetype.split(";")[0].trim():"";yu[s]||(s="application/octet-stream");return new Blob([t],{type:s})}))}var Eu=s(215),Su=s(188),wu=s.n(Su);let Cu,Ru=0;const ku={};function Iu(e){if(!e)return"";const t=window.getComputedStyle(e,null);let s=t.cssText;if(""==s)for(let e=0;e<t.length;e++)s+=t[e]+":",s+=t.getPropertyValue(t[e])+";";return s}Eu.a.registerTintable((function(){wu()({uri:s(1130)},(e,t,s)=>{if(e)return;const n=(new DOMParser).parseFromString(s,"image/svg+xml"),i=Eu.a.calcSvgFixups([{contentDocument:n}]);Eu.a.applySvgFixups(i);const o=(new XMLSerializer).serializeToString(n);Cu="data:image/svg+xml;base64,"+window.btoa(o),Object.keys(ku).forEach((function(e){ku[e].tint()}))})}));class Ou extends o.a.Component{constructor(e){super(e),g()(this,"tint",()=>{this._downloadImage.current&&(this._downloadImage.current.src=Cu),this._iframe.current&&this._iframe.current.contentWindow.postMessage({imgSrc:Cu,style:Iu(this._dummyLink.current)},"*")}),this.state={decryptedBlob:this.props.decryptedBlob?this.props.decryptedBlob:null},this._iframe=Object(i.createRef)(),this._dummyLink=Object(i.createRef)(),this._downloadImage=Object(i.createRef)()}presentableTextForFile(e){let t=Object(c.a)("Attachment");return e.body&&e.body.length>0&&(t=e.body),e.info&&e.info.size&&(t+=" ("+Vr()(e.info.size)+")"),t}_getContentUrl(){const e=this.props.mxEvent.getContent();return L.a.get().mxcUrlToHttp(e.url)}componentDidMount(){this.id=Ru++,ku[this.id]=this,this.tint()}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}componentWillUnmount(){delete ku[this.id]}render(){const e=this.props.mxEvent.getContent(),t=this.presentableTextForFile(e),s=void 0!==e.file,n=e.body&&e.body.length>0?e.body:Object(c.a)("Attachment"),i=this._getContentUrl(),r=d.getComponent("dialogs.ErrorDialog"),a=e.info?e.info.size:null,l=e.info?e.info.mimetype:"application/octet-stream";if(s){if(null===this.state.decryptedBlob){let s=!1;const n=t=>{if(s)return!1;s=!0,bu(e.file).then(e=>{this.setState({decryptedBlob:e})}).catch(e=>{console.warn("Unable to decrypt attachment: ",e),ke.a.createTrackedDialog("Error decrypting attachment","",r,{title:Object(c.a)("Error"),description:Object(c.a)("Error decrypting attachment")})}).finally(()=>{s=!1})};return o.a.createElement("span",{className:"mx_MFileBody"},o.a.createElement("div",{className:"mx_MFileBody_download"},o.a.createElement(Z.a,{onClick:n},Object(c.a)("Decrypt %(text)s",{text:t}))))}const s=e=>{e.target.contentWindow.postMessage({imgSrc:Cu,style:Iu(this._dummyLink.current),blob:this.state.decryptedBlob,download:n,textContent:Object(c.a)("Download %(text)s",{text:t}),auto:!this.props.decryptedBlob},"*")},i="usercontent/";return o.a.createElement("span",{className:"mx_MFileBody"},o.a.createElement("div",{className:"mx_MFileBody_download"},o.a.createElement("div",{style:{display:"none"}},o.a.createElement("a",{ref:this._dummyLink})),o.a.createElement("iframe",{src:`${i}?origin=${encodeURIComponent(window.location.origin)}`,onLoad:s,ref:this._iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})))}if(i){const s={target:"_blank",rel:"noreferrer noopener",href:i},r="number"!=typeof a||a>524288e3;return["application/pdf"].includes(l)&&!r?s.onClick=e=>{console.log(`Downloading ${l} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),fetch(i).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e),s=document.createElement("a");s.download=n,s.href=t,document.body.appendChild(s),s.click(),s.remove()})}:s.download=n,"file_grid"===this.props.tileShape?o.a.createElement("span",{className:"mx_MFileBody"},o.a.createElement("div",{className:"mx_MFileBody_download"},o.a.createElement("a",B()({className:"mx_MFileBody_downloadLink"},s),n),o.a.createElement("div",{className:"mx_MImageBody_size"},e.info&&e.info.size?Vr()(e.info.size):""))):o.a.createElement("span",{className:"mx_MFileBody"},o.a.createElement("div",{className:"mx_MFileBody_download"},o.a.createElement("a",s,o.a.createElement("img",{src:Cu,width:"12",height:"14",ref:this._downloadImage}),Object(c.a)("Download %(text)s",{text:t}))))}{const e=t?": "+t:"";return o.a.createElement("span",{className:"mx_MFileBody"},Object(c.a)("Invalid file%(extra)s",{extra:e}))}}}g()(Ou,"propTypes",{mxEvent:re.a.object.isRequired,decryptedBlob:re.a.object,onHeightChanged:re.a.func,tileShape:re.a.string});class Tu extends o.a.Component{constructor(e){super(e),this.state={playing:!1,decryptedUrl:null,decryptedBlob:null,error:null}}onPlayToggle(){this.setState({playing:!this.state.playing})}_getContentUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedUrl:L.a.get().mxcUrlToHttp(e.url)}componentDidMount(){const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t;bu(e.file).then((function(e){return t=e,URL.createObjectURL(t)})).then(e=>{this.setState({decryptedUrl:e,decryptedBlob:t})},e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl)}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return o.a.createElement("span",{className:"mx_MAudioBody"},o.a.createElement("img",{src:s(184),width:"16",height:"16"}),Object(c.a)("Error decrypting audio"));if(void 0!==e.file&&null===this.state.decryptedUrl)return o.a.createElement("span",{className:"mx_MAudioBody"},o.a.createElement(_t.a,null));const t=this._getContentUrl();return o.a.createElement("span",{className:"mx_MAudioBody"},o.a.createElement("audio",{src:t,controls:!0}),o.a.createElement(Ou,B()({},this.props,{decryptedBlob:this.state.decryptedBlob})))}}class xu extends o.a.Component{constructor(e){super(e),this.onImageError=this.onImageError.bind(this),this.onImageLoad=this.onImageLoad.bind(this),this.onImageEnter=this.onImageEnter.bind(this),this.onImageLeave=this.onImageLeave.bind(this),this.onClientSync=this.onClientSync.bind(this),this.onClick=this.onClick.bind(this),this._isGif=this._isGif.bind(this),this.state={decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,imgError:!1,imgLoaded:!1,loadedImageDimensions:null,hover:!1,showImage:w.a.getValue("showImages")},this._image=Object(i.createRef)()}onClientSync(e,t){if(this.unmounted)return;"ERROR"!==e&&t!==e&&this.state.imgError&&this.setState({imgError:!1})}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0})}onClick(e){if(0===e.button&&!e.metaKey){if(e.preventDefault(),!this.state.showImage)return void this.showImage();const t=this.props.mxEvent.getContent(),s=this._getContentUrl(),n=d.getComponent("elements.ImageView"),i={src:s,name:t.body&&t.body.length>0?t.body:Object(c.a)("Attachment"),mxEvent:this.props.mxEvent};t.info&&(i.width=t.info.w,i.height=t.info.h,i.fileSize=t.info.size),ke.a.createDialog(n,i,"mx_Dialog_lightbox")}}_isGif(){const e=this.props.mxEvent.getContent();return e&&e.info&&"image/gif"===e.info.mimetype}onImageEnter(e){if(this.setState({hover:!0}),!this.state.showImage||!this._isGif()||w.a.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getContentUrl()}onImageLeave(e){if(this.setState({hover:!1}),!this.state.showImage||!this._isGif()||w.a.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getThumbUrl()}onImageError(){this.setState({imgError:!0})}onImageLoad(){let e;if(this.props.onHeightChanged(),this._image.current){const{naturalWidth:t,naturalHeight:s}=this._image.current;e={naturalWidth:t,naturalHeight:s}}this.setState({imgLoaded:!0,loadedImageDimensions:e})}_getContentUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedUrl:this.context.mxcUrlToHttp(e.url)}_getThumbUrl(){const e=window.devicePixelRatio,t=Math.round(800*e),s=Math.round(600*e),n=this.props.mxEvent.getContent();if(void 0!==n.file)return this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.decryptedUrl;if(n.info&&"image/svg+xml"===n.info.mimetype&&n.info.thumbnail_url)return this.context.mxcUrlToHttp(n.info.thumbnail_url,t,s);{const i=n.info;if(!this._isGif()&&1!==e&&i&&i.w&&i.h&&i.size){const e=i.w>t||i.h>s;return i.size>1048576&&e?this.context.mxcUrlToHttp(n.url,t,s):this.context.mxcUrlToHttp(n.url)}return this.context.mxcUrlToHttp(n.url,t,s)}}componentDidMount(){this.unmounted=!1,this.context.on("sync",this.onClientSync);const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t,s=Promise.resolve(null);e.info&&e.info.thumbnail_file&&(s=bu(e.info.thumbnail_file).then((function(e){return URL.createObjectURL(e)}))),s.then(s=>bu(e.file).then((function(e){return t=e,URL.createObjectURL(e)})).then(e=>{this.unmounted||this.setState({decryptedUrl:e,decryptedThumbnailUrl:s,decryptedBlob:t})})).catch(e=>{this.unmounted||(console.warn("Unable to decrypt attachment: ",e),this.setState({error:e}))})}this.state.showImage||"true"!==localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId())||this.setState({showImage:!0}),this._afterComponentDidMount()}_afterComponentDidMount(){}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("sync",this.onClientSync),this._afterComponentWillUnmount(),this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}_afterComponentWillUnmount(){}_messageContent(e,t,s){let n,i;if(s&&s.info&&s.info.w&&s.info.h)n=s.info.w,i=s.info.h;else{if(!this.state.loadedImageDimensions){let n;return n=this.state.showImage?o.a.createElement("img",{style:{display:"none"},src:t,ref:this._image,alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad}):o.a.createElement(Nu,null),this.wrapImage(e,n)}n=this.state.loadedImageDimensions.naturalWidth,i=this.state.loadedImageDimensions.naturalHeight}const r=Math.min(this.props.maxImageHeight||600,i),a=n*r/i;let c=null,l=null,d=null;void 0!==s.file&&null===this.state.decryptedUrl?l=o.a.createElement(_t.a,{w:32,h:32}):this.state.imgLoaded||(l=this.getPlaceholder());let u=Boolean(l);t&&!this.state.imgError&&(c=o.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this._image,style:{maxWidth:a+"px"},alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(c=o.a.createElement(Nu,{style:{maxWidth:a+"px"}}),u=!1),!this._isGif()||w.a.getValue("autoplayGifsAndVideos")||this.state.hover||(d=o.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF"));const h=o.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:r+"px"}},o.a.createElement("div",{style:{paddingBottom:100*i/n+"%"}}),u&&o.a.createElement("div",{className:"mx_MImageBody_thumbnail",style:{maxWidth:n+"px"}},o.a.createElement("div",{className:"mx_MImageBody_thumbnail_spinner"},l)),o.a.createElement("div",{style:{display:u?"none":void 0}},c,d),this.state.hover&&this.getTooltip());return this.wrapImage(e,h)}wrapImage(e,t){return o.a.createElement("a",{href:e,onClick:this.onClick},t)}getPlaceholder(){return null}getTooltip(){return null}getFileBody(){return o.a.createElement(Ou,B()({},this.props,{decryptedBlob:this.state.decryptedBlob}))}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return o.a.createElement("span",{className:"mx_MImageBody"},o.a.createElement("img",{src:s(184),width:"16",height:"16"}),Object(c.a)("Error decrypting image"));const t=this._getContentUrl();let n;n=this._isGif()&&w.a.getValue("autoplayGifsAndVideos")?t:this._getThumbUrl();const i=this._messageContent(t,n,e),r=this.getFileBody();return o.a.createElement("span",{className:"mx_MImageBody"},i,r)}}g()(xu,"propTypes",{mxEvent:re.a.object.isRequired,onHeightChanged:re.a.func.isRequired,maxImageHeight:re.a.number}),g()(xu,"contextType",S.a);class Nu extends o.a.PureComponent{render(){let e="mx_HiddenImagePlaceholder";return this.props.hover&&(e+=" mx_HiddenImagePlaceholder_hover"),o.a.createElement("div",{className:e},o.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},o.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),o.a.createElement("span",null,Object(c.a)("Show image"))))}}g()(Nu,"propTypes",{hover:re.a.bool});class ju extends o.a.Component{constructor(e){super(e),g()(this,"_onRequestChanged",()=>{this.forceUpdate()}),g()(this,"_onTrustChanged",(e,t)=>{const{mxEvent:s}=this.props,n=s.verificationRequest;n&&n.otherUserId===e&&this.forceUpdate()})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this._onRequestChanged),L.a.get().on("userTrustStatusChanged",this._onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this._onRequestChanged);const t=L.a.get();t&&t.removeListener("userTrustStatusChanged",this._onTrustChanged)}_shouldRender(e,t){return!!t&&(!("m.key.verification.cancel"===e.getType()&&!t.cancelled)&&(!("m.key.verification.done"===e.getType()&&!t.done)&&(!t.pending&&!!L.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!this._shouldRender(e,t))return null;const s=L.a.get().getUserId();let n;if(t.done)n=Object(c.a)("You verified %(name)s",{name:qo(t.otherUserId,e)});else if(t.cancelled){const i=t.cancellingUserId;n=i===s?Object(c.a)("You cancelled verifying %(name)s",{name:qo(t.otherUserId,e)}):Object(c.a)("%(name)s cancelled verifying",{name:qo(i,e)})}if(n){const s=Go(t.otherUserId,e.getRoomId()),i=E()("mx_EventTile_bubble","mx_cryptoEvent","mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:t.done});return o.a.createElement("div",{className:i},o.a.createElement("div",{className:"mx_cryptoEvent_title"},n),o.a.createElement("div",{className:"mx_cryptoEvent_subtitle"},s))}return null}}ju.propTypes={mxEvent:re.a.object.isRequired};class Pu extends o.a.Component{constructor(e){super(e),g()(this,"_openRequest",()=>{const{verificationRequest:e}=this.props.mxEvent,t=L.a.get().getUser(e.otherUserId);u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Lt.b.EncryptionPanel,refireParams:{verificationRequest:e,member:t}})}),g()(this,"_onRequestChanged",()=>{this.forceUpdate()}),g()(this,"_onAcceptClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this._openRequest(),await e.accept()}catch(e){console.error(e.message)}}),g()(this,"_onRejectClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){console.error(e.message)}}),this.state={}}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this._onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this._onRequestChanged)}_acceptedLabel(e){return e===L.a.get().getUserId()?Object(c.a)("You accepted"):Object(c.a)("%(name)s accepted",{name:qo(e,this.props.mxEvent.getRoomId())})}_cancelledLabel(e){const t=L.a.get().getUserId(),{cancellationCode:s}=this.props.mxEvent.verificationRequest,n="m.user"===s;return e===t?n?Object(c.a)("You declined"):Object(c.a)("You cancelled"):n?Object(c.a)("%(name)s declined",{name:qo(e,this.props.mxEvent.getRoomId())}):Object(c.a)("%(name)s cancelled",{name:qo(e,this.props.mxEvent.getRoomId())})}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.FormButton"),{mxEvent:s}=this.props,n=s.verificationRequest;if(!n||n.invalid)return null;let i,r,a;if(!n.canAccept){let t;n.ready||n.started||n.done?t=o.a.createElement(e,{onClick:this._openRequest},this._acceptedLabel(n.receivingUserId)):n.cancelled?t=this._cancelledLabel(n.cancellingUserId):n.accepting?t=Object(c.a)("Accepting …"):n.declining&&(t=Object(c.a)("Declining …")),a=o.a.createElement("div",{className:"mx_cryptoEvent_state"},t)}if(n.initiatedByMe)i=o.a.createElement("div",{className:"mx_cryptoEvent_title"},Object(c.a)("You sent a verification request")),r=o.a.createElement("div",{className:"mx_cryptoEvent_subtitle"},Go(n.receivingUserId,s.getRoomId()));else{const e=qo(n.requestingUserId,s.getRoomId());i=o.a.createElement("div",{className:"mx_cryptoEvent_title"},Object(c.a)("%(name)s wants to verify",{name:e})),r=o.a.createElement("div",{className:"mx_cryptoEvent_subtitle"},Go(n.requestingUserId,s.getRoomId())),n.canAccept&&(a=o.a.createElement("div",{className:"mx_cryptoEvent_buttons"},o.a.createElement(t,{kind:"danger",onClick:this._onRejectClicked,label:Object(c.a)("Decline")}),o.a.createElement(t,{onClick:this._onAcceptClicked,label:Object(c.a)("Accept")})))}return i?o.a.createElement("div",{className:"mx_EventTile_bubble mx_cryptoEvent mx_cryptoEvent_icon"},i,r,a):null}}Pu.propTypes={mxEvent:re.a.object.isRequired};class Du extends xu{onClick(e){e.preventDefault(),this.state.showImage||this.showImage()}wrapImage(e,t){let s=null;return this.state.showImage||(s=this.onClick),o.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:s}," ",t," ")}getPlaceholder(){const e=d.getComponent("elements.TintableSvg");return o.a.createElement(e,{src:s(1131),width:"75",height:"75"})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();if(!(e&&e.body&&e.info&&e.info.w))return null;const t=d.getComponent("elements.Tooltip");return o.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},o.a.createElement(t,{label:e.body}))}getFileBody(){return null}}class Au extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null})}thumbScale(e,t,s,n){if(!e||!t)return;if(e<s&&t<n)return 1;const i=s/e,o=n/t;return i<o?i:o}_getContentUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedUrl:L.a.get().mxcUrlToHttp(e.url)}_getThumbUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedThumbnailUrl:e.info&&e.info.thumbnail_url?L.a.get().mxcUrlToHttp(e.info.thumbnail_url):null}componentDidMount(){const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t,s=Promise.resolve(null);e.info&&e.info.thumbnail_file&&(s=bu(e.info.thumbnail_file).then((function(e){return URL.createObjectURL(e)}))),s.then(s=>bu(e.file).then((function(e){return t=e,URL.createObjectURL(e)})).then(e=>{this.setState({decryptedUrl:e,decryptedThumbnailUrl:s,decryptedBlob:t}),this.props.onHeightChanged()})).catch(e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return o.a.createElement("span",{className:"mx_MVideoBody"},o.a.createElement("img",{src:s(184),width:"16",height:"16"}),Object(c.a)("Error decrypting video"));if(void 0!==e.file&&null===this.state.decryptedUrl)return o.a.createElement("span",{className:"mx_MVideoBody"},o.a.createElement("div",{className:"mx_MImageBody_thumbnail mx_MImageBody_thumbnail_spinner"},o.a.createElement(_t.a,null)));const t=this._getContentUrl(),n=this._getThumbUrl(),i=w.a.getValue("autoplayGifsAndVideos");let r=null,a=null,l=null,d="metadata";if(e.info){const t=this.thumbScale(e.info.w,e.info.h,480,360);t&&(a=Math.floor(e.info.w*t),r=Math.floor(e.info.h*t)),n&&(l=n,d="none")}return o.a.createElement("span",{className:"mx_MVideoBody"},o.a.createElement("video",{className:"mx_MVideoBody",src:t,alt:e.body,controls:!0,preload:d,muted:i,autoPlay:i,height:r,width:a,poster:l}),o.a.createElement(Ou,B()({},this.props,{decryptedBlob:this.state.decryptedBlob})))}}g()(Au,"propTypes",{mxEvent:re.a.object.isRequired,onHeightChanged:re.a.func.isRequired});var Uu=s(504);const Mu=({mxEvent:e,getTile:t,getReplyThread:s,permalinkCreator:r,onFocusChange:a})=>{const[l,u,h,m]=Object(n.o)(),[p,g,f]=Object(P.e)(u);let _;if(Object(i.useEffect)(()=>{a(l)},[a,l]),l){const i=d.getComponent("context_menus.MessageContextMenu"),a=t&&t(),c=s&&s(),l=u.current.getBoundingClientRect();_=o.a.createElement(n.b,B()({},Object(n.k)(l),{onFinished:m}),o.a.createElement(i,{mxEvent:e,permalinkCreator:r,eventTileOps:a&&a.getEventTileOps?a.getEventTileOps():void 0,collapseReplyThread:c&&c.canCollapse()?c.collapse:void 0,onFinished:m}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(n.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",title:Object(c.a)("Options"),onClick:h,isExpanded:l,inputRef:f,onFocus:p,tabIndex:g?0:-1}),_)},Lu=({mxEvent:e,reactions:t,onFocusChange:s})=>{const[r,a,l,u]=Object(n.o)(),[h,m,p]=Object(P.e)(a);let g;if(Object(i.useEffect)(()=>{s(r)},[s,r]),r){const s=a.current.getBoundingClientRect(),i=d.getComponent("emojipicker.ReactionPicker");g=o.a.createElement(n.b,B()({},Object(n.k)(s),{onFinished:u,managed:!1}),o.a.createElement(i,{mxEvent:e,reactions:t,onFinished:u}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(n.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton",title:Object(c.a)("React"),onClick:l,isExpanded:r,inputRef:p,onFocus:h,tabIndex:m?0:-1}),g)};class Fu extends o.a.PureComponent{constructor(...e){super(...e),g()(this,"onDecrypted",()=>{this.forceUpdate()}),g()(this,"onBeforeRedaction",()=>{this.forceUpdate()}),g()(this,"onSent",()=>{this.forceUpdate()}),g()(this,"onFocusChange",e=>{this.props.onFocusChange&&this.props.onFocusChange(e)}),g()(this,"onReplyClick",e=>{u.a.dispatch({action:"reply_to_event",event:this.props.mxEvent})}),g()(this,"onEditClick",e=>{u.a.dispatch({action:"edit_event",event:this.props.mxEvent})})}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==de.b.SENT&&this.props.mxEvent.on("Event.status",this.onSent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once("Event.decrypted",this.onDecrypted),this.props.mxEvent.on("Event.beforeRedaction",this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off("Event.status",this.onSent),this.props.mxEvent.off("Event.decrypted",this.onDecrypted),this.props.mxEvent.off("Event.beforeRedaction",this.onBeforeRedaction)}render(){let e,t,s;return ec(this.props.mxEvent)&&(this.context.canReact&&(e=o.a.createElement(Lu,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange})),this.context.canReply&&(t=o.a.createElement(P.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton",title:Object(c.a)("Reply"),onClick:this.onReplyClick}))),tc(this.props.mxEvent)&&(s=o.a.createElement(P.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_editButton",title:Object(c.a)("Edit"),onClick:this.onEditClick})),o.a.createElement(Jt,{className:"mx_MessageActionBar","aria-label":Object(c.a)("Message Actions"),"aria-live":"off"},e,t,s,o.a.createElement(Mu,{mxEvent:this.props.mxEvent,getReplyThread:this.props.getReplyThread,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange}))}}g()(Fu,"propTypes",{mxEvent:re.a.object.isRequired,reactions:re.a.object,permalinkCreator:re.a.object,getTile:re.a.func,getReplyThread:re.a.func,onFocusChange:re.a.func}),g()(Fu,"contextType",Uu.a);var Bu=s(515);class Vu extends o.a.Component{render(){const e=new Date(this.props.ts);return o.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(mr.b)(e,this.props.showTwelveHour),"aria-hidden":!0},Object(mr.d)(e,this.props.showTwelveHour))}}g()(Vu,"propTypes",{ts:re.a.number.isRequired,showTwelveHour:re.a.bool});class Ku extends o.a.Component{constructor(){super(),g()(this,"_onAllowClick",e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()})}render(){return o.a.createElement("div",{className:"mx_MjolnirBody"},o.a.createElement("i",null,Object(c.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>o.a.createElement("a",{href:"#",onClick:this._onAllowClick},e)})))}}g()(Ku,"propTypes",{mxEvent:re.a.object.isRequired,onMessageAllowed:re.a.func.isRequired});class qu extends o.a.PureComponent{constructor(e){super(e),g()(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),g()(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),e.reactions&&(e.reactions.on("Relations.add",this.onReactionsChange),e.reactions.on("Relations.remove",this.onReactionsChange),e.reactions.on("Relations.redaction",this.onReactionsChange)),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange),this.onReactionsChange())}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getMyReactions(){const e=this.props.reactions;if(!e)return null;const t=L.a.get().getUserId(),s=e.getAnnotationsBySender()[t];return s?[...s.values()]:null}render(){const{mxEvent:e,reactions:t}=this.props,{myReactions:s,showAll:n}=this.state;if(!t||!ec(e))return null;const i=d.getComponent("messages.ReactionsRowButton");let r,a=t.getSortedAnnotationsByKey().map(([t,n])=>{const r=n.size;if(!r)return null;const a=s&&s.find(e=>!e.isRedacted()&&e.getRelation().key===t);return o.a.createElement(i,{key:t,content:t,count:r,mxEvent:e,reactionEvents:n,myReactionEvent:a})}).filter(e=>!!e);return a.length>9&&!n&&(a=a.slice(0,8),r=o.a.createElement("a",{className:"mx_ReactionsRow_showAll",href:"#",onClick:this.onShowAllClick},Object(c.a)("Show all"))),o.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(c.a)("Reactions")},a,r)}}g()(qu,"propTypes",{mxEvent:re.a.object.isRequired,reactions:re.a.object});class Gu extends o.a.PureComponent{constructor(e){super(e),g()(this,"onClick",e=>{const{mxEvent:t,myReactionEvent:s,content:n}=this.props;s?L.a.get().redactEvent(t.getRoomId(),s.getId()):(L.a.get().sendEvent(t.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:t.getId(),key:n}}),u.a.dispatch({action:"message_sent"}))}),g()(this,"onMouseOver",()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})}),g()(this,"onMouseLeave",()=>{this.setState({tooltipVisible:!1})}),this.state={tooltipVisible:!1}}render(){const e=d.getComponent("messages.ReactionsRowButtonTooltip"),{mxEvent:t,content:s,count:n,reactionEvents:i,myReactionEvent:r}=this.props,a=E()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!r});let l;this.state.tooltipRendered&&(l=o.a.createElement(e,{mxEvent:this.props.mxEvent,content:s,reactionEvents:i,visible:this.state.tooltipVisible}));const u=L.a.get().getRoom(t.getRoomId());let h;if(u){const e=[];for(const t of i){const s=u.getMember(t.getSender()),n=s?s.name:t.getSender();e.push(n)}h=Object(c.a)("<reactors/><reactedWith> reacted with %(content)s</reactedWith>",{content:s},{reactors:()=>Object(T.b)(e,6),reactedWith:e=>s?e:null})}const m=d.getComponent("elements.AccessibleButton");return o.a.createElement(m,{className:a,"aria-label":h,onClick:this.onClick,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},o.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},s),o.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},n),l)}}g()(Gu,"propTypes",{mxEvent:re.a.object.isRequired,content:re.a.string.isRequired,count:re.a.number.isRequired,reactionEvents:re.a.object.isRequired,myReactionEvent:re.a.object});class Wu extends o.a.PureComponent{render(){const e=d.getComponent("elements.Tooltip"),{content:t,reactionEvents:s,mxEvent:n,visible:i}=this.props,r=L.a.get().getRoom(n.getRoomId());let a,l;if(r){const e=[];for(const t of s){const s=r.getMember(t.getSender()),n=s?s.name:t.getSender();e.push(n)}const n=Object(qn.i)(t);a=o.a.createElement("div",null,Object(c.a)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>o.a.createElement("div",{className:"mx_Tooltip_title"},Object(T.b)(e,6)),reactedWith:e=>n?o.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return a&&(l=o.a.createElement(e,{visible:i,label:a})),l}}g()(Wu,"propTypes",{mxEvent:re.a.object.isRequired,content:re.a.string.isRequired,reactionEvents:re.a.object.isRequired,visible:re.a.bool.isRequired});class Hu extends o.a.Component{constructor(...e){super(...e),g()(this,"onAvatarClick",()=>{const e=L.a.get(),t=this.props.mxEvent,s=e.mxcUrlToHttp(t.getContent().url),n=e.getRoom(this.props.mxEvent.getRoomId()),i=Object(c.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:n?n.name:""}),o=d.getComponent("elements.ImageView"),r={src:s,name:i};ke.a.createDialog(o,r,"mx_Dialog_lightbox")})}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=d.getComponent("avatars.RoomAvatar");if(!e.getContent().url||0===e.getContent().url.trim().length)return o.a.createElement("div",{className:"mx_TextualEvent"},Object(c.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const n=L.a.get().getRoom(e.getRoomId()),i={avatarUrl:e.getContent().url,name:n?n.name:""};return o.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(c.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>o.a.createElement(Z.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},o.a.createElement(s,{width:14,height:14,oobData:i}))}))}}g()(Hu,"propTypes",{mxEvent:re.a.object.isRequired});class $u extends o.a.Component{constructor(...e){super(...e),g()(this,"_onLinkClicked",e=>{e.preventDefault();const t=this.props.mxEvent.getContent().predecessor;u.a.dispatch({action:"view_room",event_id:t.event_id,highlighted:!0,room_id:t.room_id})})}render(){const e=this.props.mxEvent.getContent().predecessor;if(void 0===e)return o.a.createElement("div",null);const t=L.a.get().getRoom(e.room_id),s=new $n.a(t,e.room_id);s.load();const n=s.forEvent(e.event_id);return o.a.createElement("div",{className:"mx_CreateEvent"},o.a.createElement("div",{className:"mx_CreateEvent_image"}),o.a.createElement("div",{className:"mx_CreateEvent_header"},Object(c.a)("This room is a continuation of another conversation.")),o.a.createElement("a",{className:"mx_CreateEvent_link",href:n,onClick:this._onLinkClicked},Object(c.a)("Click here to see older messages.")))}}g()($u,"propTypes",{mxEvent:re.a.object.isRequired});class zu extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{userGroups:null,relatedGroups:[]}),g()(this,"onRoomStateEvents",e=>{"m.room.related_groups"===e.getType()&&e.getRoomId()===this.props.mxEvent.getRoomId()&&this._updateRelatedGroups()})}componentDidMount(){this.unmounted=!1,this._updateRelatedGroups(),Vt.a.getPublicisedGroupsCached(this.context,this.props.mxEvent.getSender()).then(e=>{this.unmounted||this.setState({userGroups:e})}),this.context.on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("RoomState.events",this.onRoomStateEvents)}_updateRelatedGroups(){if(this.unmounted)return;const e=this.context.getRoom(this.props.mxEvent.getRoomId());if(!e)return;const t=e.currentState.getStateEvents("m.room.related_groups","");this.setState({relatedGroups:t&&t.getContent().groups||[]})}_getDisplayedGroups(e,t){let s=e||[];return s=t&&t.length>0?t.filter(e=>s.includes(e)):[],s}render(){const{mxEvent:e}=this.props,t=Object(T.f)(e.getSender()),s=e.sender?e.sender.name:e.getSender(),{msgtype:n}=e.getContent();if("m.emote"===n)return o.a.createElement("span",null);let i=o.a.createElement("div",null);if(this.props.enableFlair){const t=this._getDisplayedGroups(this.state.userGroups,this.state.relatedGroups);i=o.a.createElement(Zl,{key:"flair",userId:e.getSender(),groups:t})}const r=s||"",a=o.a.createElement("span",null,o.a.createElement("span",{className:"mx_SenderProfile_name "+t},r),i),l=this.props.text?o.a.createElement("span",null,o.a.createElement("span",{className:"mx_SenderProfile_aux"},Object(c.a)(this.props.text,{senderName:()=>r}))):a;return o.a.createElement("div",{className:"mx_SenderProfile",dir:"auto",onClick:this.props.onClick},o.a.createElement("div",{className:"mx_SenderProfile_hover"},l))}}g()(zu,"propTypes",{mxEvent:re.a.object.isRequired,text:re.a.string,onClick:re.a.func}),g()(zu,"contextType",S.a);var Yu=s(1132);class Ju extends o.a.Component{render(){const e=pr.a(this.props.mxEvent);return null==e||0===e.length?null:o.a.createElement("div",{className:"mx_TextualEvent"},e)}}g()(Ju,"propTypes",{mxEvent:re.a.object.isRequired});class Qu extends o.a.Component{constructor(e){super(e),g()(this,"_onBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");e&&ke.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash-tile"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};return o.a.createElement("div",{className:E()(t)},o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("span",null,Object(c.a)("Can't load this message"),e&&` (${e.getType()})`,o.a.createElement("a",{onClick:this._onBugReport,href:"#"},Object(c.a)("Submit logs")))))}return this.props.children}}var Xu=s(516);class Zu extends o.a.PureComponent{constructor(e){super(e),g()(this,"onToggle",e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})}),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;e.isBeingDecrypted()&&e.once("Event.decrypted",()=>this.forceUpdate())}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let s;s=t?o.a.createElement("pre",null,JSON.stringify(e,null,4)):o.a.createElement("code",null,`{ "type": ${e.getType()} }`);const n=E()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return o.a.createElement("span",{className:n},s,o.a.createElement("a",{className:"mx_ViewSourceEvent_toggle",href:"#",onClick:this.onToggle}))}}g()(Zu,"propTypes",{mxEvent:re.a.object.isRequired});var eh=s(90);const th=(e,t,s)=>{const[n,o]=Object(i.useState)(s);return Object(i.useEffect)(()=>{e().then(o)},t),n};var sh=s(493),nh=s(494);function ih({userId:e,device:t}){const s=Object(i.useContext)(S.a),n=e===s.getUserId(),r=s.checkDeviceTrust(e,t.deviceId),a=s.checkUserTrust(e),l=n?r.isCrossSigningVerified():r.isVerified(),d=E()("mx_UserInfo_device",{mx_UserInfo_device_verified:l,mx_UserInfo_device_unverified:!l}),u=E()("mx_E2EIcon",{mx_E2EIcon_normal:!a.isVerified(),mx_E2EIcon_verified:l,mx_E2EIcon_warning:a.isVerified()&&!l}),h=()=>{Object(sh.c)(s.getUser(e),t)},m=t.ambiguous?(t.getDisplayName()?t.getDisplayName():"")+" ("+t.deviceId+")":t.getDisplayName();let p=null;return a.isVerified()&&(p=l?Object(c.a)("Trusted"):Object(c.a)("Not trusted")),l?o.a.createElement("div",{className:d,title:t.deviceId},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},m),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},p)):o.a.createElement(Z.a,{className:d,title:t.deviceId,onClick:h},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},m),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},p))}function oh({devices:e,userId:t,loading:s}){const n=d.getComponent("elements.Spinner"),r=Object(i.useContext)(S.a),a=r.checkUserTrust(t),[l,u]=Object(i.useState)(!1);if(s)return o.a.createElement(n,null);if(null===e)return Object(c.a)("Unable to load session list");const h=t===r.getUserId(),m=e.map(e=>r.checkDeviceTrust(t,e.deviceId));let p=[];const g=[];let f,_,v,y="mx_E2EIcon";if(a.isVerified()){for(let t=0;t<e.length;++t){const s=e[t],n=m[t];(h?n.isCrossSigningVerified():n.isVerified())?p.push(s):g.push(s)}f=Object(c.a)("%(count)s verified sessions",{count:p.length}),_=Object(c.a)("Hide verified sessions"),y+=" mx_E2EIcon_verified"}else p=e,f=Object(c.a)("%(count)s sessions",{count:e.length}),_=Object(c.a)("Hide sessions"),y+=" mx_E2EIcon_normal";p.length&&(v=l?o.a.createElement(Z.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>u(!1)},o.a.createElement("div",null,_)):o.a.createElement(Z.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>u(!0)},o.a.createElement("div",{className:y}),o.a.createElement("div",null,f)));let b=g.map((e,s)=>o.a.createElement(ih,{key:s,userId:t,device:e}));if(l){const e=g.length;b=b.concat(p.map((s,n)=>o.a.createElement(ih,{key:n+e,userId:t,device:s})))}return o.a.createElement("div",{className:"mx_UserInfo_devices"},o.a.createElement("div",null,b),o.a.createElement("div",null,v))}const rh=({member:e,isIgnored:t,canInvite:s,devices:n})=>{const r=Object(i.useContext)(S.a);let a=null,l=null,h=null,m=null;const p=e.userId===r.getUserId();if(!p){const n=()=>{const s=r.getIgnoredUsers();if(t){const t=s.indexOf(e.userId);-1!==t&&s.splice(t,1)}else s.push(e.userId);r.setIgnoredUsers(s)};if(a=o.a.createElement(Z.a,{onClick:n,className:E()("mx_UserInfo_field",{mx_UserInfo_destructive:!t})},t?Object(c.a)("Unignore"):Object(c.a)("Ignore")),e.roomId){const t=function(){const t=r.getRoom(e.roomId);u.a.dispatch({action:"view_room",highlighted:!0,event_id:t.getEventReadUpTo(e.userId),room_id:e.roomId})},s=function(){u.a.dispatch({action:"insert_mention",user_id:e.userId})};m=o.a.createElement(Z.a,{onClick:t,className:"mx_UserInfo_field"},Object(c.a)("Jump to read receipt")),l=o.a.createElement(Z.a,{onClick:s,className:"mx_UserInfo_field"},Object(c.a)("Mention"))}if(s&&(!e||!e.membership||"leave"===e.membership)){const t=e&&e.roomId?e.roomId:A.a.getRoomId(),s=async()=>{try{const s=new Kn.a(t);await s.invite([e.userId]).then(()=>{if("invited"!==s.getCompletionState(e.userId))throw new Error(s.getErrorText(e.userId))})}catch(e){const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to invite","",t,{title:Object(c.a)("Failed to invite"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}};h=o.a.createElement(Z.a,{onClick:s,className:"mx_UserInfo_field"},Object(c.a)("Invite"))}}const g=o.a.createElement(Z.a,{onClick:()=>{const t=d.getComponent("dialogs.ShareDialog");ke.a.createTrackedDialog("share room member dialog","",t,{target:e})},className:"mx_UserInfo_field"},Object(c.a)("Share Link to User"));let f;return p||(f=o.a.createElement(Z.a,{onClick:()=>async function(e,t){const s=eh.a.shared().getDMRoomsForUserId(t).reduce((t,s)=>{const n=e.getRoom(s);return n&&"leave"!==n.getMyMembership()&&(!t||t.getLastActiveTimestamp()<n.getLastActiveTimestamp())?n:t},null);if(s)return void u.a.dispatch({action:"view_room",room_id:s.roomId});const n={dmUserId:t};if(Object(et.e)()){const s=await e.downloadKeys([t]);Object.values(s).every(e=>Object.keys(e).length>0)&&(n.encryption=!0)}Object(et.b)(n)}(r,e.userId),className:"mx_UserInfo_field"},Object(c.a)("Direct message"))),o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Options")),o.a.createElement("div",null,f,m,g,l,h,a))},ah=async()=>{const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=ke.a.createTrackedDialog("Demoting Self","",e,{title:Object(c.a)("Demote yourself?"),description:o.a.createElement("div",null,Object(c.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(c.a)("Demote")}),[s]=await t;return s},ch=({children:e})=>o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Admin Tools")),o.a.createElement("div",{className:"mx_UserInfo_buttons"},e)),lh=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(i.useContext)(S.a);if("invite"!==e.membership&&"join"!==e.membership)return null;const r="invite"===e.membership?Object(c.a)("Disinvite"):Object(c.a)("Kick");return o.a.createElement(Z.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const i=d.getComponent("dialogs.ConfirmUserActionDialog"),{finished:o}=ke.a.createTrackedDialog("Confirm User Action Dialog","onKick",i,{member:e,action:"invite"===e.membership?Object(c.a)("Disinvite"):Object(c.a)("Kick"),title:"invite"===e.membership?Object(c.a)("Disinvite this user?"):Object(c.a)("Kick this user?"),askReason:"join"===e.membership,danger:!0}),[r,a]=await o;r&&(t(),n.kick(e.roomId,e.userId,a||void 0).then(()=>{console.log("Kick success")},(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Kick error: "+e),ke.a.createTrackedDialog("Failed to kick","",t,{title:Object(c.a)("Failed to kick"),description:e&&e.message?e.message:"Operation failed"})})).finally(()=>{s()}))}},r)},dh=({member:e})=>{const t=Object(i.useContext)(S.a);return o.a.createElement(Z.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{roomId:s,userId:n}=e,i=t.getRoom(s);if(!i)return;let r=i.getLiveTimeline(),a=[];for(;r;)a=r.getEvents().reduce((e,t)=>t.getSender()!==n||t.isRedacted()||t.isRedaction()||"m.room.create"===t.getType()?e:e.concat(t),a),r=r.getNeighbouringTimeline(de.c.BACKWARDS);const l=a.length,u=e.name;if(0===l){const e=d.getComponent("dialogs.InfoDialog");ke.a.createTrackedDialog("No user messages found to remove","",e,{title:Object(c.a)("No recent messages by %(user)s found",{user:u}),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Try scrolling up in the timeline to see if there are any earlier ones.")))})}else{const e=d.getComponent("dialogs.QuestionDialog"),{finished:n}=ke.a.createTrackedDialog("Remove recent messages by user","",e,{title:Object(c.a)("Remove recent messages by %(user)s",{user:u}),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are about to remove %(count)s messages by %(user)s. This cannot be undone. Do you wish to continue?",{count:l,user:u})),o.a.createElement("p",null,Object(c.a)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime."))),button:Object(c.a)("Remove %(count)s messages",{count:l})}),[i]=await n;if(!i)return;await Promise.resolve(),console.info(`Started redacting recent ${l} messages for ${u} in ${s}`),await Promise.all(a.map(async e=>{try{await t.redactEvent(s,e.getId())}catch(t){console.error("Could not redact",e.getId()),console.error(t)}})),console.info(`Finished redacting recent ${l} messages for ${u} in ${s}`)}}},Object(c.a)("Remove recent messages"))},uh=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(i.useContext)(S.a);let r=Object(c.a)("Ban");"ban"===e.membership&&(r=Object(c.a)("Unban"));const a=E()("mx_UserInfo_field",{mx_UserInfo_destructive:"ban"!==e.membership});return o.a.createElement(Z.a,{className:a,onClick:async()=>{const i=d.getComponent("dialogs.ConfirmUserActionDialog"),{finished:o}=ke.a.createTrackedDialog("Confirm User Action Dialog","onBanOrUnban",i,{member:e,action:"ban"===e.membership?Object(c.a)("Unban"):Object(c.a)("Ban"),title:"ban"===e.membership?Object(c.a)("Unban this user?"):Object(c.a)("Ban this user?"),askReason:"ban"!==e.membership,danger:"ban"!==e.membership}),[r,a]=await o;if(!r)return;let l;t(),l="ban"===e.membership?n.unban(e.roomId,e.userId):n.ban(e.roomId,e.userId,a||void 0),l.then(()=>{console.log("Ban success")},(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Ban error: "+e),ke.a.createTrackedDialog("Failed to ban user","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to ban user")})})).finally(()=>{s()})}},r)},hh=({member:e,room:t,powerLevels:s,startUpdating:n,stopUpdating:r})=>{const a=Object(i.useContext)(S.a);if("join"!==e.membership)return null;const l=((e,t)=>{if(!t||!e)return!1;const s=(t.events?t.events["m.room.message"]:null)||t.events_default;return e.powerLevel<s})(e,s),u=E()("mx_UserInfo_field",{mx_UserInfo_destructive:!l}),h=l?Object(c.a)("Unmute"):Object(c.a)("Mute");return o.a.createElement(Z.a,{className:u,onClick:async()=>{const s=d.getComponent("dialogs.ErrorDialog"),i=e.roomId,o=e.userId;if(o===a.getUserId())try{if(!await ah())return}catch(e){return void console.error("Failed to warn about self demotion: ",e)}const u=t.currentState.getStateEvents("m.room.power_levels","");if(!u)return;const h=u.getContent(),m=(h.events?h.events["m.room.message"]:null)||h.events_default;let p;p=l?m:m-1,p=parseInt(p),isNaN(p)||(n(),a.setPowerLevel(i,o,p,u).then(()=>{console.log("Mute toggle success")},(function(e){console.error("Mute error: "+e),ke.a.createTrackedDialog("Failed to mute user","",s,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to mute user")})})).finally(()=>{r()}))}},h)},mh=({room:e,children:t,member:s,startUpdating:n,stopUpdating:r,powerLevels:a})=>{const c=Object(i.useContext)(S.a);let l,d,u,h;const m=(a.events?a.events["m.room.power_levels"]:null)||a.state_default,{ban:p=50,kick:g=50,redact:f=50}=a,_=e.getMember(c.getUserId()),v=_.userId===s.userId,y=s.powerLevel<_.powerLevel||v;return y&&_.powerLevel>=g&&(l=o.a.createElement(lh,{member:s,startUpdating:n,stopUpdating:r})),_.powerLevel>=f&&(h=o.a.createElement(dh,{member:s,startUpdating:n,stopUpdating:r})),y&&_.powerLevel>=p&&(d=o.a.createElement(uh,{member:s,startUpdating:n,stopUpdating:r})),y&&_.powerLevel>=m&&(u=o.a.createElement(hh,{member:s,room:e,powerLevels:a,startUpdating:n,stopUpdating:r})),l||d||u||h||t?o.a.createElement(ch,null,u,l,d,h,t):o.a.createElement("div",null)},ph=({children:e,groupId:t,groupMember:s,startUpdating:n,stopUpdating:r})=>{const a=Object(i.useContext)(S.a),[l,m]=Object(i.useState)(!1),[p,g]=Object(i.useState)(!1);if(Object(i.useEffect)(()=>{let e=!1;const n=()=>{e||(m(Zo.a.isUserPrivileged(t)),g(Zo.a.getGroupInvitedMembers(t).some(e=>e.userId===s.userId)))};return Zo.a.registerListener(t,n),n(),()=>{e=!0,Zo.a.unregisterListener(n)}},[t,s.userId]),l){const i=async()=>{const e=d.getComponent("dialogs.ConfirmUserActionDialog"),{finished:i}=ke.a.createDialog(e,{matrixClient:a,groupMember:s,action:p?Object(c.a)("Disinvite"):Object(c.a)("Remove from community"),title:p?Object(c.a)("Disinvite this user from community?"):Object(c.a)("Remove this user from community?"),danger:!0}),[o]=await i;o&&(n(),a.removeUserFromGroup(t,s.userId).then(()=>{u.a.dispatch({action:h.a.ViewUser,member:null})}).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to remove user from group","",t,{title:Object(c.a)("Error"),description:p?Object(c.a)("Failed to withdraw invitation"):Object(c.a)("Failed to remove user from community")}),console.log(e)}).finally(()=>{r()}))},l=o.a.createElement(Z.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:i},p?Object(c.a)("Disinvite"):Object(c.a)("Remove from community"));return o.a.createElement(ch,null,l,e)}return o.a.createElement("div",null)},gh=re.a.shape({userId:re.a.string.isRequired,displayname:re.a.string,avatarUrl:re.a.string});const fh=({user:e,room:t,roomPermissions:s,powerLevels:n})=>{const[r,a]=Object(i.useState)(!1);if(t&&e.roomId){if(r)return o.a.createElement(_h,{user:e,room:t,roomPermissions:s,onFinished:()=>a(!1)});{const i=d.getComponent("elements.IconButton"),r=n.users_default||0,l=parseInt(e.powerLevel,10),u=s.canEdit?o.a.createElement(i,{icon:"edit",onClick:()=>a(!0)}):null,h=Object(rd.b)(l,r),m=Object(c.a)("<strong>%(role)s</strong> in %(roomName)s",{role:h,roomName:t.name},{strong:e=>o.a.createElement("strong",null,e)});return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement("div",{className:"mx_UserInfo_roleDescription"},m,u))}}return null},_h=({user:e,room:t,roomPermissions:s,onFinished:n})=>{const r=Object(i.useContext)(S.a),[a,l]=Object(i.useState)(!1),[u,h]=Object(i.useState)(parseInt(e.powerLevel,10)),[m,p]=Object(i.useState)(!1),g=Object(i.useCallback)(e=>{p(!0),h(parseInt(e,10))},[h,p]),f=Object(i.useCallback)(async()=>{const s=(e,t,s,n)=>r.setPowerLevel(e,t,parseInt(s),n).then((function(){console.log("Power change success")}),(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change power level "+e),ke.a.createTrackedDialog("Failed to change power level","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to change power level")})}));try{if(!m)return;l(!0);const i=u,a=e.roomId,h=e.userId,p=t.currentState.getStateEvents("m.room.power_levels","");if(!p)return;if(!p.getContent().users)return void s(a,h,i,p);const g=r.getUserId(),f=d.getComponent("dialogs.QuestionDialog");if(g===h){try{if(!await ah())return}catch(e){console.error("Failed to warn about self demotion: ",e)}return void await s(a,h,i,p)}const _=p.getContent().users[g];if(parseInt(_)===parseInt(i)){const{finished:e}=ke.a.createTrackedDialog("Promote to PL100 Warning","",f,{title:Object(c.a)("Warning!"),description:o.a.createElement("div",null,Object(c.a)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),o.a.createElement("br",null),Object(c.a)("Are you sure?")),button:Object(c.a)("Continue")}),[t]=await e;if(!t)return}await s(a,h,i,p)}finally{n()}},[e.roomId,e.userId,r,u,m,l,n,t]),_=t.currentState.getStateEvents("m.room.power_levels",""),v=_?_.getContent().users_default:0,y=d.getComponent("elements.IconButton"),b=d.getComponent("elements.Spinner"),E=a?o.a.createElement(b,{w:16,h:16}):o.a.createElement(y,{icon:"check",onClick:f}),w=d.getComponent("elements.PowerSelector");return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement(w,{label:null,value:u,maxValue:s.modifyLevelMax,usersDefault:v,onChange:g,disabled:a}),E)},vh=e=>{const t=Object(i.useContext)(S.a),[s,n]=Object(i.useState)(void 0);return Object(i.useEffect)(()=>{n(void 0);let s=!1;return async function(){try{await t.downloadKeys([e],!0);const i=t.getStoredDevicesForUser(e);if(s)return;(e=>{const t=Object.create(null);for(let s=0;s<e.length;s++){const n=e[s].getDisplayName(),i=t[n]||[];i.push(s),t[n]=i}for(const s in t)t[s].length>1&&t[s].forEach(t=>{e[t].ambiguous=!0})})(i),n(i)}catch(e){n(null)}}(),()=>{s=!0}},[t,e]),Object(i.useEffect)(()=>{let s=!1;const i=async()=>{const i=t.getStoredDevicesForUser(e);s||n(i)},o=t=>{t.includes(e)&&i()},r=(t,s)=>{t===e&&i()},a=(t,s)=>{t===e&&i()};return t.on("crypto.devicesUpdated",o),t.on("deviceVerificationChanged",r),t.on("userTrustStatusChanged",a),()=>{s=!0,t.removeListener("crypto.devicesUpdated",o),t.removeListener("deviceVerificationChanged",r),t.removeListener("userTrustStatusChanged",a)}},[t,e]),s},yh=({room:e,member:t,groupId:s,devices:n,isRoomEncrypted:r})=>{const a=Object(i.useContext)(S.a),l=((e,t)=>{const[s,n]=Object(i.useState)({}),o=Object(i.useCallback)(()=>{if(!t)return;const e=t.currentState.getStateEvents("m.room.power_levels","");return n(e?e.getContent():{}),()=>{n({})}},[t]);return Object(Zt.a)(e,"RoomState.members",o),Object(i.useEffect)(()=>(o(),()=>{n({})}),[o]),s})(a,e),u=(e=>{const[t,s]=Object(i.useState)(!1);return Object(i.useEffect)(()=>{e.isSynapseAdministrator().then(e=>{s(e)},()=>{s(!1)})},[e]),t})(a),[h,m]=Object(i.useState)(a.isUserIgnored(t.userId));Object(i.useEffect)(()=>{m(a.isUserIgnored(t.userId))},[a,t.userId]);const p=Object(i.useCallback)(e=>{"m.ignored_user_list"===e.getType()&&m(a.isUserIgnored(t.userId))},[a,t.userId]);Object(Zt.a)(a,"accountData",p);const[g,f]=Object(i.useState)(0),_=Object(i.useCallback)(()=>{f(g+1)},[g]),v=Object(i.useCallback)(()=>{f(g-1)},[g]),y=function(e,t,s){const[n,o]=Object(i.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),r=Object(i.useCallback)(()=>{if(!t)return;const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return;const i=n.getContent();if(!i)return;const r=t.getMember(e.getUserId());if(!r)return;const a=s,c=r.userId===a.userId;let l=-1;if(a.powerLevel<r.powerLevel||c){const e=(i.events?i.events["m.room.power_levels"]:null)||i.state_default;r.powerLevel>=e&&(c||r.powerLevel>a.powerLevel)&&(l=r.powerLevel)}o({canInvite:r.powerLevel>=i.invite,canEdit:l>=0,modifyLevelMax:l})},[e,s,t]);return Object(Zt.a)(e,"RoomState.members",r),Object(i.useEffect)(()=>(r(),()=>{o({maximalPowerLevel:-1,canEdit:!1,canInvite:!1})}),[r]),n}(a,e,t),b=Object(i.useCallback)(async()=>{const e=d.getComponent("views.dialogs.QuestionDialog"),{finished:s}=ke.a.createTrackedDialog("Synapse User Deactivation","",e,{title:Object(c.a)("Deactivate user?"),description:o.a.createElement("div",null,Object(c.a)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(c.a)("Deactivate user"),danger:!0}),[n]=await s;if(n)try{await a.deactivateSynapseUser(t.userId)}catch(e){console.error("Failed to deactivate user"),console.error(e);const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Failed to deactivate Synapse user","",t,{title:Object(c.a)("Failed to deactivate user"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}},[a,t.userId]);let E,w,C;if(u&&t.userId.endsWith(":"+L.a.getHomeserverName())&&(E=o.a.createElement(Z.a,{onClick:b,className:"mx_UserInfo_field mx_UserInfo_destructive"},Object(c.a)("Deactivate user"))),e&&t.roomId?C=o.a.createElement(mh,{powerLevels:l,member:t,room:e,startUpdating:_,stopUpdating:v},E):s?C=o.a.createElement(ph,{groupId:s,groupMember:t,startUpdating:_,stopUpdating:v},E):E&&(C=o.a.createElement(ch,null,E)),g>0){const e=d.getComponent("elements.Spinner");w=o.a.createElement(e,{imgClassName:"mx_ContextualMenu_spinner"})}const R=o.a.createElement(fh,{powerLevels:l,user:t,room:e,roomPermissions:y}),k=a.isCryptoEnabled();let I,O;r?I=Object(c.a)("Messages in this room are end-to-end encrypted."):k?e&&(I=Object(c.a)("Messages in this room are not end-to-end encrypted.")):I=Object(c.a)("This client does not support end-to-end encryption.");const T=(e=>th(async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),[e],!1))(a),x=k&&a.checkUserTrust(t.userId),N=k&&x.isCrossSigningVerified(),j=t.userId===a.getUserId(),P=k&&T&&!N&&!j,D=function(e,t,s,n){return th(async()=>{if(s){n(!0);try{await e.downloadKeys([t.userId]);const s=e.getStoredCrossSigningForUser(t.userId);return!!(s&&s.getId())}finally{n(!1)}}},[e,t,s],void 0)}(a,t,P,e=>{f(t=>t+(e?1:-1))}),A=void 0===n;if(P)if(void 0!==D)O=o.a.createElement(Z.a,{className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{D?Object(sh.d)(t):Object(sh.a)(t)}},Object(c.a)("Verify"));else if(!A){const e=d.getComponent("elements.Spinner");O=o.a.createElement(e,null)}const U=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(c.a)("Security")),o.a.createElement("p",null,I),O,k&&o.a.createElement(oh,{loading:A,devices:n,userId:t.userId}));return o.a.createElement(o.a.Fragment,null,R&&o.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator mx_UserInfo_memberDetailsContainer"},o.a.createElement("div",{className:"mx_UserInfo_memberDetails"},R)),U,o.a.createElement(rh,{devices:n,canInvite:y.canInvite,isIgnored:h,member:t}),C,w)},bh=({member:e,e2eStatus:t})=>{const s=Object(i.useContext)(S.a),n=Object(i.useCallback)(()=>{const t=e.getMxcAvatarUrl?e.getMxcAvatarUrl():e.avatarUrl;if(!t)return;const n=s.mxcUrlToHttp(t),i=d.getComponent("elements.ImageView"),o={src:n,name:e.name};ke.a.createDialog(i,o,"mx_Dialog_lightbox")},[s,e]),r=d.getComponent("avatars.MemberAvatar"),a=o.a.createElement("div",{className:"mx_UserInfo_avatar"},o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement(r,{key:e.userId,member:e,width:.6*window.innerHeight,height:.6*window.innerHeight,resizeMethod:"scale",fallbackUserId:e.userId,onClick:n,urls:e.avatarUrl?[e.avatarUrl]:void 0}))));let c,u,h,m;e instanceof de.k&&e.user&&(c=e.user.presence,u=e.user.lastActiveAgo,h=e.user.currentlyActive,w.a.getValue("feature_custom_status")&&(m=e.user._unstable_statusMessage));const p=l.a.get().enable_presence_by_hs_url;let g=!0;p&&void 0!==p[s.baseUrl]&&(g=p[s.baseUrl]);let f=null;if(g){const e=d.getComponent("rooms.PresenceLabel");f=o.a.createElement(e,{activeAgo:u,currentlyActive:h,presenceState:c})}let _,v=null;m&&(v=o.a.createElement("span",{className:"mx_UserInfo_statusMessage"},m)),t&&(_=o.a.createElement(wn.b,{size:18,status:t,isUser:!0}));const y=e.name||e.displayname;return o.a.createElement(o.a.Fragment,null,a,o.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},o.a.createElement("div",{className:"mx_UserInfo_profile"},o.a.createElement("div",null,o.a.createElement("h2",null,_,o.a.createElement("span",{title:y,"aria-label":y},y))),o.a.createElement("div",null,e.userId),o.a.createElement("div",{className:"mx_UserInfo_profileStatus"},f,v))))},Eh=e=>{let{user:t,groupId:s,room:n,onClose:r,phase:a=Lt.b.RoomMemberInfo}=e,c=K()(e,["user","groupId","room","onClose","phase"]);const l=Object(i.useContext)(S.a),d=Object(i.useMemo)(()=>n&&n.getMember(t.userId)||t,[n,t]),u=Object(nh.a)(l,n),h=vh(t.userId);let m;u&&h&&(m=((e,t,s)=>{const n=t===e.getUserId(),i=e.checkUserTrust(t);if(!i.isCrossSigningVerified())return i.wasCrossSigningVerified()?"warning":"normal";return s.some(s=>{const{deviceId:i}=s,o=e.checkDeviceTrust(t,i);return n?!o.isCrossSigningVerified():!o.isVerified()})?"warning":"verified"})(l,t.userId,h));const p=["mx_UserInfo"];let g,f;switch(a){case Lt.b.RoomMemberInfo:case Lt.b.GroupMemberInfo:g=o.a.createElement(yh,{room:n,member:d,groupId:s,devices:h,isRoomEncrypted:u});break;case Lt.b.EncryptionPanel:p.push("mx_UserInfo_smallAvatar"),g=o.a.createElement(In,B()({},c,{member:d,onClose:r,isRoomEncrypted:u}))}n&&(f=Lt.b.RoomMemberList);const _=o.a.createElement(bh,{member:d,e2eStatus:m,onClose:r});return o.a.createElement(hn.b,{className:p.join(" "),header:_,onClose:r,previousPhase:f},g)};Eh.propTypes={user:re.a.oneOfType([re.a.instanceOf(de.n),re.a.instanceOf(de.k),gh]).isRequired,group:re.a.instanceOf(de.e),groupId:re.a.string,room:re.a.instanceOf(de.j),onClose:re.a.func};var Sh,wh=Eh;let Ch=Object(bn.a)("views.room_settings.RoomPublishSetting")(Sh=class extends o.a.PureComponent{constructor(e){super(e),g()(this,"onRoomPublishChange",e=>{const t=this.state.isRoomPublished,s=!t;this.setState({isRoomPublished:s});L.a.get().setRoomDirectoryVisibility(this.props.roomId,s?"public":"private").catch(()=>{this.setState({isRoomPublished:t})})}),this.state={isRoomPublished:!1}}componentDidMount(){L.a.get().getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){const e=L.a.get();return o.a.createElement(De.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,disabled:!this.props.canSetCanonicalAlias,label:Object(c.a)("Publish this room to the public in %(domain)s's room directory?",{domain:e.getDomain()})})}})||Sh;class Rh extends Hl{constructor(e){super(e),g()(this,"_onAliasAdded",async()=>{await this._aliasField.current.validate({allowEmpty:!1}),this._aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this._aliasField.current.focus(),this._aliasField.current.validate({allowEmpty:!1,focused:!0}))}),this._aliasField=Object(i.createRef)()}_renderNewItemField(){if(!this.props.domain)return super._renderNewItemField();const e=d.getComponent("views.elements.RoomAliasField");return o.a.createElement("form",{onSubmit:this._onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},o.a.createElement(e,{ref:this._aliasField,onChange:e=>this._onNewItemChanged({target:{value:e}}),value:this.props.newItem||"",domain:this.props.domain}),o.a.createElement(Z.a,{onClick:this._onAliasAdded,kind:"primary"},Object(c.a)("Add")))}}class kh extends o.a.Component{constructor(e){super(e),g()(this,"onNewAliasChanged",e=>{this.setState({newAlias:e})}),g()(this,"onLocalAliasAdded",e=>{if(!e||0===e.length)return;const t=L.a.get().getDomain();e.includes(":")||(e+=":"+t),L.a.get().createAlias(e,this.props.roomId).then(()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)}).catch(e=>{console.error(e),ke.a.createTrackedDialog("Error creating address","",Ft.a,{title:Object(c.a)("Error creating address"),description:Object(c.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})})}),g()(this,"onLocalAliasDeleted",e=>{const t=this.state.localAliases[e];L.a.get().deleteAlias(t).then(()=>{const e=this.state.localAliases.filter(e=>e!==t);this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)}).catch(e=>{let t;console.error(e),t="M_FORBIDDEN"===e.errcode?Object(c.a)("You don't have permission to delete the address."):Object(c.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),ke.a.createTrackedDialog("Error removing address","",Ft.a,{title:Object(c.a)("Error removing address"),description:t})})}),g()(this,"onLocalAliasesToggled",e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.target.open})}),g()(this,"onCanonicalAliasChange",e=>{this.changeCanonicalAlias(e.target.value)}),g()(this,"onNewAltAliasChanged",e=>{this.setState({newAltAlias:e})}),g()(this,"onAltAliasAdded",e=>{const t=this.state.altAliases.slice();t.some(t=>t.trim()===e.trim())||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))}),g()(this,"onAltAliasDeleted",e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)});const t={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const s=e.canonicalAliasEvent.getContent(),n=s.alt_aliases;Array.isArray(n)&&(t.altAliases=n.slice()),t.canonicalAlias=s.alias}this.state=t}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=L.a.get();let t=[];if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const s=await e.unstableGetLocalAliases(this.props.roomId);Array.isArray(s.aliases)&&(t=s.aliases)}this.setState({localAliases:t})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const s={alt_aliases:this.state.altAliases};e&&(s.alias=e),L.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",s,"").catch(e=>{console.error(e),ke.a.createTrackedDialog("Error updating main address","",Ft.a,{title:Object(c.a)("Error updating main address"),description:Object(c.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0,altAliases:e});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),L.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",t,"").catch(e=>{console.error(e),ke.a.createTrackedDialog("Error updating alternative addresses","",Ft.a,{title:Object(c.a)("Error updating main address"),description:Object(c.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}_getAliases(){return this.state.altAliases.concat(this._getLocalNonAltAliases())}_getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter(t=>!e.includes(t))}render(){const e=L.a.get().getDomain();let t=!1;const s=this.state.canonicalAlias||"",n=o.a.createElement(le.a,{onChange:this.onCanonicalAliasChange,value:s,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(c.a)("Main address")},o.a.createElement("option",{value:"",key:"unset"},Object(c.a)("not specified")),this._getAliases().map((e,s)=>(e===this.state.canonicalAlias&&(t=!0),o.a.createElement("option",{value:e,key:s},e))),t||!this.state.canonicalAlias?"":o.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let i;if(this.state.localAliasesLoading){const e=d.getComponent("elements.Spinner");i=o.a.createElement(e,null)}else i=o.a.createElement(Rh,{id:"roomAliases",className:"mx_RoomSettings_localAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:Object(c.a)("This room has no local addresses"),placeholder:Object(c.a)("Local address"),domain:e});return o.a.createElement("div",{className:"mx_AliasSettings"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Published Addresses")),o.a.createElement("p",null,Object(c.a)("Published addresses can be used by anyone on any server to join your room. To publish an address, it needs to be set as a local address first.")),n,o.a.createElement(Ch,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),o.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this._getLocalNonAltAliases().map(e=>o.a.createElement("option",{value:e,key:e})),";"),o.a.createElement(Rh,{id:"roomAltAliases",className:"mx_RoomSettings_altAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(c.a)("Other published addresses:"),noItemsLabel:Object(c.a)("No other published addresses yet, add one below"),placeholder:Object(c.a)("New published address (e.g. #alias:server)")}),o.a.createElement("span",{className:"mx_SettingsTab_subheading mx_AliasSettings_localAliasHeader"},Object(c.a)("Local Addresses")),o.a.createElement("p",null,Object(c.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:e})),o.a.createElement("details",{onToggle:this.onLocalAliasesToggled},o.a.createElement("summary",null,this.state.detailsOpen?Object(c.a)("Show less"):Object(c.a)("Show more")),i))}}g()(kh,"propTypes",{roomId:re.a.string.isRequired,canSetCanonicalAlias:re.a.bool.isRequired,canSetAliases:re.a.bool.isRequired,canonicalAliasEvent:re.a.object}),g()(kh,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1,aliasEvents:[]});const Ih=/\+\S+:\S+/;class Oh extends o.a.Component{constructor(e){super(e),g()(this,"onNewGroupChanged",e=>{this.setState({newGroupId:e})}),g()(this,"onGroupAdded",e=>{if(0===e.length||!this.validateGroupId(e))return;const t=[...this.state.newGroupsList,e];this.setState({newGroupsList:t,newGroupId:""}),this.updateGroups(t)}),g()(this,"onGroupDeleted",e=>{const t=this.state.newGroupsList[e],s=this.state.newGroupsList.filter(e=>e!==t);this.setState({newGroupsList:s}),this.updateGroups(s)}),this.state={newGroupId:"",newGroupsList:e.relatedGroupsEvent&&e.relatedGroupsEvent.getContent().groups||[]}}updateGroups(e){this.context.sendStateEvent(this.props.roomId,"m.room.related_groups",{groups:e},"").catch(e=>{console.error(e),ke.a.createTrackedDialog("Error updating flair","",Ft.a,{title:Object(c.a)("Error updating flair"),description:Object(c.a)("There was an error updating the flair for this room. The server may not allow it or a temporary error occurred.")})})}validateGroupId(e){if(!Ih.test(e)){const t=d.getComponent("dialogs.ErrorDialog");return ke.a.createTrackedDialog("Invalid related community ID","",t,{title:Object(c.a)("Invalid community ID"),description:Object(c.a)("'%(groupId)s' is not a valid community ID",{groupId:e})}),!1}return!0}render(){const e=this.context.getDomain(),t=d.getComponent("elements.EditableItemList");return o.a.createElement("div",null,o.a.createElement(t,{id:"relatedGroups",items:this.state.newGroupsList,className:"mx_RelatedGroupSettings",newItem:this.state.newGroupId,canRemove:this.props.canSetRelatedGroups,canEdit:this.props.canSetRelatedGroups,onNewItemChanged:this.onNewGroupChanged,onItemAdded:this.onGroupAdded,onItemRemoved:this.onGroupDeleted,itemsLabel:Object(c.a)("Showing flair for these communities:"),noItemsLabel:Object(c.a)("This room is not showing flair for any communities"),placeholder:Object(c.a)("New community ID (e.g. +foo:%(localDomain)s)",{localDomain:e})}))}}g()(Oh,"propTypes",{roomId:re.a.string.isRequired,canSetRelatedGroups:re.a.bool.isRequired,relatedGroupsEvent:re.a.instanceOf(de.i)}),g()(Oh,"contextType",S.a),g()(Oh,"defaultProps",{canSetRelatedGroups:!1});class Th extends o.a.Component{constructor(...e){super(...e),g()(this,"_onClickUserSettings",e=>{e.preventDefault(),e.stopPropagation(),u.a.fire(h.a.ViewUserSettings)})}render(){const e=d.getComponent("elements.SettingsFlag"),t=this.props.room.roomId,s=L.a.get().isRoomEncrypted(t);let n=null,i=null;if(s)n=Object(c.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(n=w.a.getValueAt(je.a.ACCOUNT,"urlPreviewsEnabled")?Object(c.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>o.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}):Object(c.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>o.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}),w.a.canSetValue("urlPreviewsEnabled",t,"room"))i=o.a.createElement("label",null,o.a.createElement(e,{name:"urlPreviewsEnabled",level:je.a.ROOM,roomId:t,isExplicit:!0}));else{let e=Object(c.b)("URL previews are enabled by default for participants in this room.");w.a.getValueAt(je.a.ROOM,"urlPreviewsEnabled",t,!0)||(e=Object(c.b)("URL previews are disabled by default for participants in this room.")),i=o.a.createElement("label",null,Object(c.a)(e))}}const r=o.a.createElement(e,{name:s?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:je.a.ROOM_ACCOUNT,roomId:t});return o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},n),i,o.a.createElement("label",null,r))}}g()(Th,"propTypes",{room:re.a.object});var xh=s(550),Nh=s(517);function jh(e,t){const s=Math.min(e.length,t.length);for(let n=0;n<s;++n)if(e[n]!==t[n])return n;return s}function Ph(e,t,s){const n=s-(t.length-e.length);return function(e,t){const s=Math.min(e.length,t.length),n=e.substr(0,s)===t.substr(0,s);if(n&&e.length>t.length)return{removed:e.substr(s),at:s};if(n&&e.length<t.length)return{added:t.substr(s),at:s};{const s=jh(e,t);return{removed:e.substr(s),added:t.substr(s),at:s}}}(e.substr(0,n),t.substr(0,s))}class Dh{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,s){if(-1===this.index||-1===e.index)return;const[n,i]=this.compare(e)<0?[this,e]:[e,this];if(n.index===i.index)s(t.parts[this.index],n.offset,i.offset);else{const e=t.parts[n.index];s(e,n.offset,e.text.length);for(let e=n.index+1;e<i.index;++e){const n=t.parts[e];s(n,0,n.text.length)}s(t.parts[i.index],0,i.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const{parts:i}=e;for(;s<i.length;){const e=i[s];for(;n<e.text.length;){if(!t(s,n,e))return new Dh(s,n);n+=1}if(s===i.length-1)return new Dh(s,n);s+=1,n=0}}backwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const i=e.parts;for(;s>=0;){const e=i[s];for(;n>0;){if(!t(s,n-1,e))return new Dh(s,n);n-=1}if(0===s)return new Dh(s,n);s-=1,n=i[s].text.length}}asOffset(e){if(-1===this.index)return new Yi(0,!0);let t=0;for(let s=0;s<this.index;++s)t+=e.parts[s].text.length;t+=this.offset;const s=e.parts[this.index],n=!s||t>=s.text.length;return new Yi(t,n)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,s=e.parts[t];return this.index===t&&this.offset===s.text.length}isAtStart(){return 0===this.index&&0===this.offset}}class Ah{constructor(e,t,s=null){this.updateCallback=s,g()(this,"_parts",void 0),g()(this,"_partCreator",void 0),g()(this,"activePartIdx",null),g()(this,"_autoComplete",null),g()(this,"autoCompletePartIdx",null),g()(this,"autoCompletePartCount",0),g()(this,"transformCallback",null),g()(this,"onAutoComplete",({replaceParts:e,close:t})=>{let s;if(e){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...e),this.autoCompletePartCount=e.length;const t=e[e.length-1],n=this.autoCompletePartIdx+e.length-1;s=new Dh(n,t.text.length)}t&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),this.updateCallback(s)}),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce((e,t)=>e+t.text.length,0)}clone(){return new Ah(this._parts,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new Dh(e,t.text.length)}return new Dh(-1,0)}serializeParts(){return this._parts.map(e=>e.serialize())}diff(e,t,s){const n=this.parts.reduce((e,t)=>e+t.text,"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const s=jh(e,t),n=e.length-t.length;return{at:s,removed:e.substr(s,n)}}(n,e):Ph(n,e,s.offset)}reset(e,t,s){this._parts=e.map(e=>this._partCreator.deserializePart(e)),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,s)}insert(e,t){const s=this.splitAt(t);let n=0;for(let t=0;t<e.length;++t){const i=e[t];n+=i.text.length,this.insertPart(s+t,i)}return n}update(e,t,s){const n=this.diff(e,t,s),i=this.positionForOffset(n.at,s.atNodeEnd);let o=0;n.removed&&(o=this.removeText(i,n.removed.length));let r=0;n.added&&(r=this.addText(i,n.added,t)),this.mergeAdjacentParts();const a=n.at-o+r;let c=this.positionForOffset(a,!0);const l="insertFromPaste"!==t&&"insertFromDrop"!==t,d=this.setActivePart(c,l);if(this.transformCallback){const e=this.getTransformAddedLen(c,t,n);c=this.positionForOffset(a+e,!0)}return this.updateCallback(c,t,n),d}getTransformAddedLen(e,t,s){const n=this.transformCallback(e,t,s);return Number.isFinite(n)?n:0}setActivePart(e,t){const{index:s}=e,n=this._parts[s];if(n){if(s!==this.activePartIdx&&(this.activePartIdx=s,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=n.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=s,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(n,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let t=0;t<this._parts.length;++t){let s=this._parts[t];const n=!s.text.length,i=!n&&e&&e.merge(s);(n||i)&&(s=e,this.removePart(t),--t),e=s}}removeText(e,t){let{index:s,offset:n}=e,i=0;for(;t>0;){let e=this._parts[s];const o=Math.min(t,e.text.length-n);if(o)if(e.canEdit){const t=e.remove(n,o);"string"==typeof t&&this.replacePart(s,this._partCreator.createDefaultPart(t)),e=this._parts[s],e.text.length?s+=1:this.removePart(s)}else i+=n,this.removePart(s);else s+=1;t-=o,n=0}return i}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const s=t.split(e.offset);return this.insertPart(e.index+1,s),e.index+1}addText(e,t,s){let{index:n}=e;const{offset:i}=e;let o=t.length;const r=this._parts[n];if(r)if(r.canEdit)if(r.validateAndInsert(i,t,s))t=null;else{const e=r.split(i);n+=1,this.insertPart(n,e)}else 0!==i&&(o+=r.text.length-i,n+=1);else n<0&&(n=0);for(;t;){const e=this._partCreator.createPartForInput(t,n,s);t=e.appendUntilRejected(t,s),this.insertPart(n,e),n+=1}return o}positionForOffset(e,t){let s=0;const n=this._parts.findIndex(n=>{const i=n.text.length;return!!(t&&s+i>=e||!t&&s+i>e)||(s+=i,!1)});return-1===n?this.getPositionAtEnd():new Dh(n,e-s)}startRange(e,t=e){return new Fi(this,e,t)}replaceRange(e,t,s){const n=t.asOffset(this),i=this.splitAt(e);t=n.asPosition(this);for(let e=this.splitAt(t)-1;e>=i;--e)this.removePart(e);let o=i;for(const e of s)this.insertPart(o,e),o+=1;this.mergeAdjacentParts()}transform(e){const t=e();let s=null;return s=t instanceof Fi?Promise.resolve():this.setActivePart(t,!0),this.updateCallback(t),s}}function Uh(e,{forceHTML:t=!1}={}){const s=function(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":case"user-pill":return e+`[${t.text.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object($n.d)(t.resourceId)})`}},"")}(e),n=new Qc(s);return!n.isPlainText()||t?n.toHTML():s.indexOf("\\")>-1?n.toPlaintext():void 0}function Mh(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":case"user-pill":return e+""+t.text}},"")}function Lh(e){return Fh(e,"/me ",!1)}function Fh(e,t,s=!0){const n=e.parts[0];let i=n&&n.text;return s||(t=t.toLowerCase(),i=i.toLowerCase()),n&&("plain"===n.type||"command"===n.type)&&i.startsWith(t)}function Bh(e){return Vh(e,"/me ")}function Vh(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}var Kh=s(507);function qh(e,t){const s=Lh(e);s&&(e=Bh(e));const n=function(e){const t=e.getContent()["m.relates_to"];return!(!t||!t["m.in_reply_to"])}(t);let i="",o="";n&&(i=function(e){const t=e.getContent().body.split("\n").map(e=>e.trim());return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?t[0]+"\n\n":""}(t),o=function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(t));const r=Mh(e),a={msgtype:s?"m.emote":"m.text",body:r},c={msgtype:a.msgtype,body:`${i} * ${r}`},l=Uh(e,{forceHTML:n});return l&&(a.format="org.matrix.custom.html",a.formatted_body=l,c.format=a.format,c.formatted_body=`${o} * ${l}`),Object.assign({"m.new_content":a,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}},c)}class Gh extends o.a.Component{constructor(e,t){super(e,t),g()(this,"_setEditorRef",e=>{this._editorRef=e}),g()(this,"_onKeyDown",e=>{if(!this._editorRef.isComposing(e)&&!(e.metaKey||e.altKey||e.shiftKey))if(e.key===Yt.a.ENTER)this._sendEdit(),e.preventDefault();else if(e.key===Yt.a.ESCAPE)this._cancelEdit();else if(e.key===Yt.a.ARROW_UP){if(this._editorRef.isModified()||!this._editorRef.isCaretAtStart())return;const t=sc(this._getRoom(),!1,this.props.editState.getEvent().getId());t&&(u.a.dispatch({action:"edit_event",event:t}),e.preventDefault())}else if(e.key===Yt.a.ARROW_DOWN){if(this._editorRef.isModified()||!this._editorRef.isCaretAtEnd())return;const t=sc(this._getRoom(),!0,this.props.editState.getEvent().getId());t?u.a.dispatch({action:"edit_event",event:t}):(u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)),e.preventDefault()}}),g()(this,"_cancelEdit",()=>{u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)}),g()(this,"_sendEdit",()=>{const e=this.props.editState.getEvent(),t=qh(this.model,e),s=t["m.new_content"];if(this._isContentModified(s)){const s=e.getRoomId();this._cancelPreviousPendingEdit(),this.context.sendMessage(s,t),u.a.dispatch({action:"message_sent"})}u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)}),g()(this,"_onChange",()=>{this.state.saveDisabled&&this._editorRef&&this._editorRef.isModified()&&this.setState({saveDisabled:!1})}),this.model=null,this._editorRef=null,this.state={saveDisabled:!0},this._createEditorModel()}_getRoom(){return this.context.getRoom(this.props.editState.getEvent().getRoomId())}_isContentModified(e){const t=this.props.editState.getEvent().getContent();return!(!this._editorRef.isModified()||t.msgtype===e.msgtype&&t.body===e.body&&t.format===e.format&&t.formatted_body===e.formatted_body)}_cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==de.b.QUEUED&&e.status!==de.b.NOT_SENT||this.context.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;e.focusNode&&(t=Qi(this._editorRef,e).caret);const s=this.model.serializeParts();this.props.editState.setEditorState(t,s)}_createEditorModel(){const{editState:e}=this.props,t=this._getRoom(),s=new ho(t,this.context);let n;n=e.hasEditorState()?e.getSerializedParts().map(e=>s.deserializePart(e)):bo(e.getEvent(),s),this.model=new Ah(n,s)}_getInitialCaretPosition(){const{editState:e}=this.props;let t;if(e.hasEditorState()&&e.getCaret()){const s=e.getCaret();t=this.model.positionForOffset(s.offset,s.atNodeEnd)}else t=this.model.getPositionAtEnd();return t}render(){const e=d.getComponent("elements.AccessibleButton");return o.a.createElement("div",{className:E()("mx_EditMessageComposer",this.props.className),onKeyDown:this._onKeyDown},o.a.createElement(To,{ref:this._setEditorRef,model:this.model,room:this._getRoom(),initialCaret:this.props.editState.getCaret(),label:Object(c.a)("Edit message"),onChange:this._onChange}),o.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},o.a.createElement(e,{kind:"secondary",onClick:this._cancelEdit},Object(c.a)("Cancel")),o.a.createElement(e,{kind:"primary",onClick:this._sendEdit,disabled:this.state.saveDisabled},Object(c.a)("Save"))))}}g()(Gh,"propTypes",{editState:re.a.instanceOf(Kh.a).isRequired}),g()(Gh,"contextType",S.a);const Wh={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};class Hh extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{hover:!1})}shouldComponentUpdate(e,t){return this.state.hover!==t.hover||this.props.shouldComponentUpdate(e,t)}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let i;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"==t?n?Wh.offline+"_beenactive":Wh.offline+"_neveractive":t?Wh[t]:Wh.offline+"_neveractive")]=!0;const{name:r}=this.props;if(this.props.suppressOnHover)i=this.props.subtextLabel?o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},r),o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):o.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},r);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1,t=d.getComponent("rooms.PresenceLabel");let s=null;this.props.showPresence&&(s=o.a.createElement(t,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(s=o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),i=o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},r),s)}let a,l;this.props.showInviteButton&&(a=o.a.createElement("div",{className:"mx_EntityTile_invite"},o.a.createElement("img",{src:s(1133),width:"16",height:"16"})));const u=this.props.powerStatus;if(u){const e={[Hh.POWER_STATUS_MODERATOR]:Object(c.a)("Mod"),[Hh.POWER_STATUS_ADMIN]:Object(c.a)("Admin")}[u];l=o.a.createElement("div",{className:"mx_EntityTile_power"},e)}let h;const{e2eStatus:m}=this.props;m&&(h=o.a.createElement(wn.b,{status:m,isUser:!0,bordered:!0}));const p=d.getComponent("avatars.BaseAvatar"),g=this.props.avatarJsx||o.a.createElement(p,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return o.a.createElement("div",{ref:e=>this.container=e},o.a.createElement(Z.a,{className:E()(e),title:this.props.title,onClick:this.props.onClick},o.a.createElement("div",{className:"mx_EntityTile_avatar"},g,h),i,l,a))}}g()(Hh,"propTypes",{name:re.a.string,title:re.a.string,avatarJsx:re.a.any,className:re.a.string,presenceState:re.a.string,presenceLastActiveAgo:re.a.number,presenceLastTs:re.a.number,presenceCurrentlyActive:re.a.bool,showInviteButton:re.a.bool,shouldComponentUpdate:re.a.func,onClick:re.a.func,suppressOnHover:re.a.bool,showPresence:re.a.bool,subtextLabel:re.a.string,e2eStatus:re.a.string}),g()(Hh,"defaultProps",{shouldComponentUpdate:function(e,t){return!0},onClick:function(){},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!0}),Hh.POWER_STATUS_MODERATOR="moderator",Hh.POWER_STATUS_ADMIN="admin";var $h=Hh,zh=s(510),Yh=e=>{const t=E()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let s;return e.numUnreadMessages&&(s=React.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),React.createElement("div",{className:t},React.createElement(Z.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(c.a)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),s)},Jh=s(1134);class Qh extends o.a.Component{constructor(e){super(e),g()(this,"onImageClick",e=>{const t=this.state.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();const s=d.getComponent("elements.ImageView");let n=t["og:image"];n&&n.startsWith("mxc://")&&(n=L.a.get().mxcUrlToHttp(n));const i={src:n,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};ke.a.createDialog(s,i,"mx_Dialog_lightbox")}),this.state={preview:null},this.unmounted=!1,L.a.get().getUrlPreview(this.props.link,this.props.mxEvent.getTs()).then(e=>{this.unmounted||this.setState({preview:e},this.props.onHeightChanged)},e=>{console.error("Failed to get URL preview: "+e)}),this._description=Object(i.createRef)()}componentDidMount(){this._description.current&&Object(qn.e)(this._description.current)}componentDidUpdate(){this._description.current&&Object(qn.e)(this._description.current)}componentWillUnmount(){this.unmounted=!0}render(){const e=this.state.preview;if(!e||0===Object.keys(e).length)return o.a.createElement("div",null);let t=e["og:image"];w.a.getValue("showImages")||(t=null);t&&t.startsWith("mxc://")&&(t=L.a.get().mxcUrlToHttp(t,100,100));let n,i=100;e["og:image:width"]&&e["og:image:height"]&&(i=function(e,t,s,n){if(!e||!t)return;if(e<s&&t<n)return t;const i=s/e,o=n/t;return i<o?Math.floor(i*t):Math.floor(o*t)}(e["og:image:width"],e["og:image:height"],100,100)),t&&(n=o.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:i}},o.a.createElement("img",{style:{maxWidth:100,maxHeight:100},src:t,onClick:this.onImageClick})));const r=Jh.AllHtmlEntities.decode(e["og:description"]||""),a=d.getComponent("elements.AccessibleButton");return o.a.createElement("div",{className:"mx_LinkPreviewWidget"},n,o.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},o.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},o.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e["og:title"])),o.a.createElement("div",{className:"mx_LinkPreviewWidget_siteName"},e["og:site_name"]?" - "+e["og:site_name"]:null),o.a.createElement("div",{className:"mx_LinkPreviewWidget_description",ref:this._description},r)),o.a.createElement(a,{className:"mx_LinkPreviewWidget_cancel",onClick:this.props.onCancelClick,"aria-label":Object(c.a)("Close preview")},o.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:s(152),width:"18",height:"18"})))}}g()(Qh,"propTypes",{link:re.a.string.isRequired,mxEvent:re.a.object.isRequired,onCancelClick:re.a.func,onHeightChanged:re.a.func});var Xh=s(182);const Zh=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;class em extends o.a.Component{constructor(e){super(e),g()(this,"onUserPresenceChange",(e,t)=>{this.refs[t.userId]&&this._updateList()}),g()(this,"onRoom",e=>{e.roomId===this.props.roomId&&this._showMembersAccordingToMembershipWithLL()}),g()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.props.roomId&&"join"===t&&this._showMembersAccordingToMembershipWithLL()}),g()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.props.roomId&&this._updateList()}),g()(this,"onRoomMemberName",(e,t)=>{t.roomId===this.props.roomId&&this._updateList()}),g()(this,"onRoomStateEvent",(e,t)=>{e.getRoomId()===this.props.roomId&&"m.room.third_party_invite"===e.getType()&&this._updateList()}),g()(this,"_updateList",Object(Xh.a)(()=>{this._updateListNow()},500)),g()(this,"_createOverflowTileJoined",(e,t)=>this._createOverflowTile(e,t,this._showMoreJoinedMemberList)),g()(this,"_createOverflowTileInvited",(e,t)=>this._createOverflowTile(e,t,this._showMoreInvitedMemberList)),g()(this,"_createOverflowTile",(e,t,n)=>{const i=d.getComponent("rooms.EntityTile"),r=d.getComponent("avatars.BaseAvatar"),a=Object(c.a)("and %(count)s others...",{count:e});return o.a.createElement(i,{className:"mx_EntityTile_ellipsis",avatarJsx:o.a.createElement(r,{url:s(362),name:"...",width:36,height:36}),name:a,presenceState:"online",suppressOnHover:!0,onClick:n})}),g()(this,"_showMoreJoinedMemberList",()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})}),g()(this,"_showMoreInvitedMemberList",()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})}),g()(this,"memberSort",(e,t)=>{const s=e.user,n=t.user;if(!s&&!n)return 0;if(s&&!n)return-1;if(!s&&n)return 1;if(this._showPresence){const e=e=>"unavailable"===e?"online":e,t=t=>{const s=["active","online","offline"],n=s.indexOf(e(t));return-1===n?s.length:n},i=t(s.currentlyActive?"active":s.presence),o=t(n.currentlyActive?"active":n.presence);if(i!==o)return i-o}if(e.powerLevel!==t.powerLevel)return t.powerLevel-e.powerLevel;if(this._showPresence&&s.getLastActiveTs()!==n.getLastActiveTs())return n.getLastActiveTs()-s.getLastActiveTs();const i=("@"===e.name[0]?e.name.substr(1):e.name).replace(Zh,""),o=("@"===t.name[0]?t.name.substr(1):t.name).replace(Zh,"");return i.localeCompare(o,{ignorePunctuation:!0,sensitivity:"base"})}),g()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e,filteredJoinedMembers:this._filterMembers(this.state.members,"join",e),filteredInvitedMembers:this._filterMembers(this.state.members,"invite",e)})}),g()(this,"_onPending3pidInviteClick",e=>{u.a.dispatch({action:"view_3pid_invite",event:e})}),g()(this,"_getChildrenJoined",(e,t)=>this._makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t))),g()(this,"_getChildCountJoined",()=>this.state.filteredJoinedMembers.length),g()(this,"_getChildrenInvited",(e,t)=>{let s=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(s=s.concat(this._getPending3PidInvites())),this._makeMemberTiles(s.slice(e,t))}),g()(this,"_getChildCountInvited",()=>this.state.filteredInvitedMembers.length+(this._getPending3PidInvites()||[]).length),g()(this,"onInviteButtonClick",()=>{L.a.get().isGuest()?u.a.dispatch({action:"require_registration"}):u.a.dispatch({action:"view_invite",roomId:this.props.roomId})});const t=L.a.get();t.hasLazyLoadMembersEnabled()?this.state=this._getMembersState([]):this.state=this._getMembersState(this.roomMembers()),t.on("Room",this.onRoom);const n=l.a.get().enable_presence_by_hs_url,i=L.a.get().baseUrl;this._showPresence=!0,n&&void 0!==n[i]&&(this._showPresence=n[i])}UNSAFE_componentWillMount(){const e=L.a.get();this._mounted=!0,e.hasLazyLoadMembersEnabled()?(this._showMembersAccordingToMembershipWithLL(),e.on("Room.myMembership",this.onMyMembership)):this._listenForMembersChanges()}_listenForMembersChanges(){const e=L.a.get();e.on("RoomState.members",this.onRoomStateMember),e.on("RoomMember.name",this.onRoomMemberName),e.on("RoomState.events",this.onRoomStateEvent),e.on("User.lastPresenceTs",this.onUserPresenceChange),e.on("User.presence",this.onUserPresenceChange),e.on("User.currentlyActive",this.onUserPresenceChange)}componentWillUnmount(){this._mounted=!1;const e=L.a.get();e&&(e.removeListener("RoomState.members",this.onRoomStateMember),e.removeListener("RoomMember.name",this.onRoomMemberName),e.removeListener("Room.myMembership",this.onMyMembership),e.removeListener("RoomState.events",this.onRoomStateEvent),e.removeListener("Room",this.onRoom),e.removeListener("User.lastPresenceTs",this.onUserPresenceChange),e.removeListener("User.presence",this.onUserPresenceChange),e.removeListener("User.currentlyActive",this.onUserPresenceChange)),this._updateList.cancelPendingCall()}async _showMembersAccordingToMembershipWithLL(){if(L.a.get().hasLazyLoadMembersEnabled()){const e=L.a.get().getRoom(this.props.roomId),t=e&&e.getMyMembership();if("join"===t){this.setState({loading:!0});try{await e.loadMembersIfNeeded()}catch(e){}this._mounted&&(this.setState(this._getMembersState(this.roomMembers())),this._listenForMembersChanges())}else"invite"===t&&this.setState(this._getMembersState(this.roomMembers()))}}_getMembersState(e){return{loading:!1,members:e,filteredJoinedMembers:this._filterMembers(e,"join"),filteredInvitedMembers:this._filterMembers(e,"invite"),truncateAtJoined:30,truncateAtInvited:5,searchQuery:""}}_updateListNow(){const e={loading:!1,members:this.roomMembers()};e.filteredJoinedMembers=this._filterMembers(e.members,"join",this.state.searchQuery),e.filteredInvitedMembers=this._filterMembers(e.members,"invite",this.state.searchQuery),this.setState(e)}getMembersWithUser(){if(!this.props.roomId)return[];const e=L.a.get(),t=e.getRoom(this.props.roomId);if(!t)return[];const s=Object.values(t.currentState.members);return s.forEach((function(t){null===t.user&&(t.user=e.getUser(t.userId))})),s}roomMembers(){const e=Ns.a.getConferenceHandler(),t=this.getMembersWithUser().filter(t=>("join"===t.membership||"invite"===t.membership)&&(!e||e&&!e.isConferenceUser(t.userId)));return t.sort(this.memberSort),t}memberString(e){if(e){const t=e.user;return"("+e.name+", "+e.powerLevel+", "+(t?t.lastActiveAgo:"<null>")+", "+(t?t.getLastActiveTs():"<null>")+", "+(t?t.currentlyActive:"<null>")+", "+(t?t.presence:"<null>")+")"}return"(null)"}_filterMembers(e,t,s){return e.filter(e=>{if(s){s=s.toLowerCase();const t=-1!==e.name.toLowerCase().indexOf(s),n=-1!==e.userId.toLowerCase().indexOf(s);if(!t&&!n)return!1}return e.membership===t})}_getPending3PidInvites(){const e=L.a.get().getRoom(this.props.roomId);if(e)return e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(Mt.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())}))}_makeMemberTiles(e){const t=d.getComponent("rooms.MemberTile"),s=d.getComponent("rooms.EntityTile");return e.map(e=>e.userId?o.a.createElement(t,{key:e.userId,member:e,ref:e.userId,showPresence:this._showPresence}):o.a.createElement(s,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this._onPending3pidInviteClick(e)}))}render(){if(this.state.loading){const e=d.getComponent("elements.Spinner");return o.a.createElement(hn.b,{className:"mx_MemberList",onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary},o.a.createElement(e,null))}const e=d.getComponent("structures.SearchBox"),t=d.getComponent("elements.TruncatedList"),s=L.a.get(),n=s.getRoom(this.props.roomId);let i,r,a;if(n&&"join"===n.getMyMembership()){let e=!0;const t=n.currentState.getStateEvents("m.room.power_levels",""),r=n.getMember(s.getUserId());if(t&&r){const s=t.getContent();s&&s.invite>r.powerLevel&&(e=!1)}let a=Object(c.a)("Invite to this room");const l=Ut.a.instance.getSelectedCommunityGeneralChat();l&&l.roomId===this.props.roomId&&(a=Object(c.a)("Invite to this community"));const u=d.getComponent("elements.AccessibleButton");i=o.a.createElement(u,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!e},o.a.createElement("span",null,a))}this._getChildCountInvited()>0&&(r=o.a.createElement("h2",null,Object(c.a)("Invited")),a=o.a.createElement(t,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this._createOverflowTileInvited,getChildren:this._getChildrenInvited,getChildCount:this._getChildCountInvited}));const l=o.a.createElement(e,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Filter room members"),onSearch:this.onSearchQueryChanged});return o.a.createElement(hn.b,{className:"mx_MemberList",header:i,footer:l,onClose:this.props.onClose,previousPhase:Lt.b.RoomSummary},o.a.createElement("div",{className:"mx_MemberList_wrapper"},o.a.createElement(t,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this._createOverflowTileJoined,getChildren:this._getChildrenJoined,getChildCount:this._getChildCountJoined}),r,a))}}class tm extends o.a.Component{constructor(e){super(e),g()(this,"onRoomStateEvents",e=>{if("m.room.encryption"!==e.getType())return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;L.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()}),g()(this,"onUserTrustStatusChanged",(e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()}),g()(this,"onDeviceVerificationChanged",(e,t,s)=>{e===this.props.member.userId&&this.updateE2EStatus()}),g()(this,"_onStatusMessageCommitted",()=>{this.setState({statusMessage:this.getStatusMessage()})}),g()(this,"onClick",e=>{u.a.dispatch({action:h.a.ViewUser,member:this.props.member})}),this.state={statusMessage:this.getStatusMessage(),isRoomEncrypted:!1,e2eStatus:null}}componentDidMount(){const e=L.a.get();if(w.a.getValue("feature_custom_status")){const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}const{roomId:t}=this.props.member;if(t){const s=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:s}),s?(e.on("userTrustStatusChanged",this.onUserTrustStatusChanged),e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on("RoomState.events",this.onRoomStateEvents)}}componentWillUnmount(){const e=L.a.get(),{user:t}=this.props.member;t&&t.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted),e&&(e.removeListener("RoomState.events",this.onRoomStateEvents),e.removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged),e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=L.a.get(),{userId:t}=this.props.member,s=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?"warning":"normal"});const i=e.getStoredDevicesForUser(t).some(n=>{const{deviceId:i}=n,o=e.checkDeviceTrust(t,i);return s?!o.isCrossSigningVerified():!o.isVerified()});this.setState({e2eStatus:i?"warning":"verified"})}getStatusMessage(){const{user:e}=this.props.member;return e?e._unstable_statusMessage:""}shouldComponentUpdate(e,t){return void 0===this.member_last_modified_time||this.member_last_modified_time<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.user_last_modified_time||this.user_last_modified_time<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}_getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(c.a)("%(userName)s (power %(powerLevelNumber)s)",{userName:this.props.member.userId,powerLevelNumber:this.props.member.powerLevel})}render(){const e=d.getComponent("avatars.MemberAvatar"),t=d.getComponent("rooms.EntityTile"),s=this.props.member,n=this._getDisplayName(),i=s.user?s.user.presence:null;let r=null;s.user&&w.a.getValue("feature_custom_status")&&(r=this.state.statusMessage);const a=o.a.createElement(e,{member:s,width:36,height:36,"aria-hidden":"true"});s.user&&(this.user_last_modified_time=s.user.getLastModifiedTime()),this.member_last_modified_time=s.getLastModifiedTime();const c=new Map([[100,t.POWER_STATUS_ADMIN],[50,t.POWER_STATUS_MODERATOR]]);let l=this.props.member.powerLevel;for(const[e]of c)if(this.props.member.powerLevel>=e){l=e;break}const u=c.get(l);let h;return this.state.isRoomEncrypted&&(h=this.state.e2eStatus),o.a.createElement(t,B()({},this.props,{presenceState:i,presenceLastActiveAgo:s.user?s.user.lastActiveAgo:0,presenceLastTs:s.user?s.user.lastPresenceTs:0,presenceCurrentlyActive:!!s.user&&s.user.currentlyActive,avatarJsx:a,title:this.getPowerLabel(),name:n,powerStatus:u,showPresence:this.props.showPresence,subtextLabel:r,e2eStatus:h,onClick:this.onClick}))}}g()(tm,"propTypes",{member:re.a.any.isRequired,showPresence:re.a.bool}),g()(tm,"defaultProps",{showPresence:!0});var sm=s(93);class nm extends o.a.Component{constructor(e){super(e),this._onShowStickersClick=this._onShowStickersClick.bind(this),this._onHideStickersClick=this._onHideStickersClick.bind(this),this._launchManageIntegrations=this._launchManageIntegrations.bind(this),this._removeStickerpickerWidgets=this._removeStickerpickerWidgets.bind(this),this._updateWidget=this._updateWidget.bind(this),this._onWidgetAction=this._onWidgetAction.bind(this),this._onResize=this._onResize.bind(this),this._onFinished=this._onFinished.bind(this),this.popoverWidth=300,this.popoverHeight=300,this.scalarClient=null,this.state={showStickers:!1,imError:null,stickerpickerX:null,stickerpickerY:null,stickerpickerWidget:null,widgetId:null}}_acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):sm.a.sharedInstance().hasManager()?(this.scalarClient=sm.a.sharedInstance().getPrimaryManager().getScalarClient(),this.scalarClient.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this._imError(Object(c.b)("Failed to connect to integration manager"),e)})):void sm.a.sharedInstance().openNoManagerDialog()}async _removeStickerpickerWidgets(){const e=await this._acquireScalarClient();console.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(zn.a.STICKERPICKER,this.state.widgetId).then(()=>{console.log("Assets disabled")}).catch(e=>{console.error("Failed to disable assets")}):console.error("Cannot disable assets: no scalar client"):console.warn("No widget ID specified, not disabling assets"),this.setState({showStickers:!1}),Ls.a.removeStickerpickerWidgets().then(()=>{this.forceUpdate()}).catch(e=>{console.error("Failed to remove sticker picker widget",e)})}componentDidMount(){window.addEventListener("resize",this._onResize),this.dispatcherRef=u.a.register(this._onWidgetAction),L.a.get().on("accountData",this._updateWidget),this._updateWidget()}componentWillUnmount(){const e=L.a.get();e&&e.removeListener("accountData",this._updateWidget),window.removeEventListener("resize",this._onResize),this.dispatcherRef&&u.a.unregister(this.dispatcherRef)}componentDidUpdate(e,t){this._sendVisibilityToWidget(this.state.showStickers)}_imError(e,t){console.error(e,t),this.setState({showStickers:!1,imError:Object(c.a)(e)})}_updateWidget(){const e=Ls.a.getStickerpickerWidgets()[0];if(!e)return nm.currentWidget=null,void this.setState({stickerpickerWidget:null,widgetId:null});const t=nm.currentWidget;let s=null;t&&t.content&&t.content.url&&(s=t.content.url);let n=null;e&&e.content&&e.content.url&&(n=e.content.url),n!==s&&od.a.destroyElement("stickerPicker"),nm.currentWidget=e,this.setState({stickerpickerWidget:e,widgetId:e?e.id:null})}_onWidgetAction(e){switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":this.setState({showStickers:!1});break;case h.a.AfterRightPanelPhaseChange:case"show_left_panel":case"hide_left_panel":this.setState({showStickers:!1})}}_defaultStickerpickerContent(){return o.a.createElement(Z.a,{onClick:this._launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},o.a.createElement("p",null,Object(c.a)("You don't currently have any stickerpacks enabled")),o.a.createElement("p",{className:"mx_Stickers_addLink"},Object(c.a)("Add some now")),o.a.createElement("img",{src:s(1138),alt:""}))}_errorStickerpickerContent(){return o.a.createElement("div",{style:{"text-align":"center"},className:"error"},o.a.createElement("p",null," ",this.state.imError," "))}_sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=Ms.a.getWidgetMessaging(this.state.stickerpickerWidget.id);t&&e!==this._prevSentVisibility&&(t.sendVisibility(e),this._prevSentVisibility=e)}_getStickerpickerContent(){if(this.state._imError)return this._errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;const s=d.getComponent("elements.PersistedElement");if(e&&e.content&&e.content.url){e.content.name=e.name||Object(c.a)("Stickerpack");const n={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data};t=o.a.createElement("div",{className:"mx_Stickers_content_container"},o.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},o.a.createElement(s,{persistKey:"stickerPicker",style:{zIndex:3500}},o.a.createElement(Ml.a,{app:n,room:this.props.room,fullWidth:!0,userId:L.a.get().credentials.userId,creatorUserId:e.sender||L.a.get().credentials.userId,waitForIframeLoad:!0,show:!0,showMenubar:!0,onEditClick:this._launchManageIntegrations,onDeleteClick:this._removeStickerpickerWidgets,showTitle:!1,showMinimise:!0,showDelete:!1,showCancel:!1,showPopout:!1,onMinimiseClick:this._onHideStickersClick,handleMinimisePointerEvents:!0,whitelistCapabilities:["m.sticker","visibility"],userWidget:!0}))))}else t=this._defaultStickerpickerContent();return t}_onShowStickersClick(e){if(!w.a.getValue("integrationProvisioning"))return sm.a.sharedInstance().showDisabledDialog();const t=e.target.getBoundingClientRect();let s=t.right+window.pageXOffset-41;s=Math.min(s,document.body.clientWidth-312);const n=Math.max(10,2+window.pageXOffset+t.left-s),i=t.top+t.height/2+window.pageYOffset-19;this.setState({showStickers:!0,stickerPickerX:s,stickerPickerY:i,stickerPickerChevronOffset:n})}_onHideStickersClick(e){this.setState({showStickers:!1})}_onResize(){this.setState({showStickers:!1})}_onFinished(){this.setState({showStickers:!1})}_launchManageIntegrations(){w.a.getValue("feature_many_integration_managers")?sm.a.sharedInstance().openAll(this.props.room,"type_"+zn.a.STICKERPICKER.preferred,this.state.widgetId):sm.a.sharedInstance().getPrimaryManager().open(this.props.room,"type_"+zn.a.STICKERPICKER.preferred,this.state.widgetId)}render(){let e,t;const s=E()("mx_MessageComposer_button","mx_MessageComposer_stickers","mx_Stickers_hideStickers","mx_MessageComposer_button_highlight");if(this.state.showStickers){t=o.a.createElement(Z.a,{id:"stickersButton",key:"controls_hide_stickers",className:s,onClick:this._onHideStickersClick,active:this.state.showStickers,title:Object(c.a)("Hide Stickers")});const i=d.getComponent("context_menus.GenericElementContextMenu");e=o.a.createElement(n.b,{chevronOffset:this.state.stickerPickerChevronOffset,chevronFace:"bottom",left:this.state.stickerPickerX,top:this.state.stickerPickerY,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this._onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},o.a.createElement(i,{element:this._getStickerpickerContent(),onResize:this._onFinished}))}else t=o.a.createElement(C.a,{id:"stickersButton",key:"controls_show_stickers",className:"mx_MessageComposer_button mx_MessageComposer_stickers",onClick:this._onShowStickersClick,title:Object(c.a)("Show Stickers")});return o.a.createElement(o.a.Fragment,null,t,e)}}function im(){u.a.dispatch({action:"reply_to_event",event:null})}g()(nm,"currentWidget",void 0);class om extends o.a.Component{constructor(e){super(e),this.unmounted=!1,this.state={event:A.a.getQuotingEvent()},this._onRoomViewStoreUpdate=this._onRoomViewStoreUpdate.bind(this),this._roomStoreToken=A.a.addListener(this._onRoomViewStoreUpdate)}componentWillUnmount(){this.unmounted=!0,this._roomStoreToken&&this._roomStoreToken.remove()}_onRoomViewStoreUpdate(){if(this.unmounted)return;const e=A.a.getQuotingEvent();this.state.event!==e&&this.setState({event:e})}render(){if(!this.state.event)return null;const e=d.getComponent("rooms.EventTile");return o.a.createElement("div",{className:"mx_ReplyPreview"},o.a.createElement("div",{className:"mx_ReplyPreview_section"},o.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_title"},Object(c.a)("Replying")),o.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_cancel"},o.a.createElement("img",{className:"mx_filterFlipColor",src:s(152),width:"18",height:"18",onClick:im})),o.a.createElement("div",{className:"mx_ReplyPreview_clear"}),o.a.createElement(e,{last:!0,tileShape:"reply_preview",mxEvent:this.state.event,permalinkCreator:this.props.permalinkCreator,isTwelveHour:w.a.getValue("showTwelveHourTimestamps")})))}}function rm(e){const t=d.getComponent("avatars.MemberStatusMessageAvatar");return o.a.createElement("div",{className:"mx_MessageComposer_avatar"},o.a.createElement(t,{member:e.me,width:24,height:24}))}function am(e){return o.a.createElement(C.a,{className:"mx_MessageComposer_button mx_MessageComposer_voicecall",onClick:t=>{u.a.dispatch({action:"place_call",type:"voice",room_id:e.roomId})},title:Object(c.a)("Voice call")})}function cm(e){return o.a.createElement(C.a,{className:"mx_MessageComposer_button mx_MessageComposer_videocall",onClick:t=>{u.a.dispatch({action:"place_call",type:t.shiftKey?"screensharing":"video",room_id:e.roomId})},title:Object(c.a)("Video call")})}function lm(e){const t=d.getComponent("elements.AccessibleButton");return o.a.createElement(t,{className:"mx_MessageComposer_button mx_MessageComposer_hangup",onClick:()=>{const t=Ns.a.getCallForRoom(e.roomId);t&&u.a.dispatch({action:"hangup",room_id:t.roomId})},title:Object(c.a)("Hangup")})}g()(om,"propTypes",{permalinkCreator:re.a.instanceOf($n.a).isRequired}),rm.propTypes={me:re.a.object.isRequired},am.propTypes={roomId:re.a.string.isRequired},cm.propTypes={roomId:re.a.string.isRequired},lm.propTypes={roomId:re.a.string.isRequired};const dm=({addEmoji:e})=>{const[t,s,i,r]=Object(n.o)();let a;if(t){const t=s.current.getBoundingClientRect(),i=d.getComponent("emojipicker.EmojiPicker");a=o.a.createElement(n.b,B()({},Object(n.k)(t),{onFinished:r,catchTab:!1}),o.a.createElement(i,{onChoose:e,showQuickReactions:!0}))}const l=E()("mx_MessageComposer_button","mx_MessageComposer_emoji",{mx_MessageComposer_button_highlight:t});return o.a.createElement(o.a.Fragment,null,o.a.createElement(n.d,{className:l,onClick:i,isExpanded:t,title:Object(c.a)("Emoji picker"),inputRef:s}),a)};class um extends o.a.Component{constructor(e){super(e),g()(this,"onAction",e=>{"upload_file"===e.action&&this.onUploadClick()}),this.onUploadClick=this.onUploadClick.bind(this),this.onUploadFileInputChange=this.onUploadFileInputChange.bind(this),this._uploadInput=Object(i.createRef)(),this._dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){u.a.unregister(this._dispatcherRef)}onUploadClick(e){L.a.get().isGuest()?u.a.dispatch({action:"require_registration"}):this._uploadInput.current.click()}onUploadFileInputChange(e){if(0===e.target.files.length)return;const t=[];for(let s=0;s<e.target.files.length;++s)t.push(e.target.files[s]);Fr.a.sharedInstance().sendContentListToRoom(t,this.props.roomId,L.a.get()),e.target.value=""}render(){return o.a.createElement(C.a,{className:"mx_MessageComposer_button mx_MessageComposer_upload",onClick:this.onUploadClick,title:Object(c.a)("Upload file")},o.a.createElement("input",{ref:this._uploadInput,type:"file",style:{display:"none"},multiple:!0,onChange:this.onUploadFileInputChange}))}}g()(um,"propTypes",{roomId:re.a.string.isRequired});class hm extends o.a.Component{constructor(e){super(e),g()(this,"onAction",e=>{"reply_to_event"===e.action&&setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100)}),this.onInputStateChanged=this.onInputStateChanged.bind(this),this._onRoomStateEvents=this._onRoomStateEvents.bind(this),this._onRoomViewStoreUpdate=this._onRoomViewStoreUpdate.bind(this),this._onTombstoneClick=this._onTombstoneClick.bind(this),this.renderPlaceholderText=this.renderPlaceholderText.bind(this),this._dispatcherRef=null,this.state={isQuoting:Boolean(A.a.getQuotingEvent()),tombstone:this._getRoomTombstone(),canSendMessages:this.props.room.maySendMessage(),showCallButtons:w.a.getValue("showCallButtonsInComposer")}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),L.a.get().on("RoomState.events",this._onRoomStateEvents),this._roomStoreToken=A.a.addListener(this._onRoomViewStoreUpdate),this._waitForOwnMember()}_waitForOwnMember(){const e=this.props.room.getMember(L.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{const e=this.props.room.getMember(L.a.get().getUserId());this.setState({me:e})})}componentWillUnmount(){L.a.get()&&L.a.get().removeListener("RoomState.events",this._onRoomStateEvents),this._roomStoreToken&&this._roomStoreToken.remove(),u.a.unregister(this.dispatcherRef)}_onRoomStateEvents(e,t){e.getRoomId()===this.props.room.roomId&&("m.room.tombstone"===e.getType()&&this.setState({tombstone:this._getRoomTombstone()}),"m.room.power_levels"===e.getType()&&this.setState({canSendMessages:this.props.room.maySendMessage()}))}_getRoomTombstone(){return this.props.room.currentState.getStateEvents("m.room.tombstone","")}_onRoomViewStoreUpdate(){const e=Boolean(A.a.getQuotingEvent());this.state.isQuoting!==e&&this.setState({isQuoting:e})}onInputStateChanged(e){e=Object.assign({},this.state.inputState,e),this.setState({inputState:e})}_onTombstoneClick(e){e.preventDefault();const t=this.state.tombstone.getContent().replacement_room,s=L.a.get().getRoom(t);let n=null;if(s){const e=s.currentState.getStateEvents("m.room.create","");e&&e.getId()&&(n=e.getId())}const i=[this.state.tombstone.getSender().split(":").splice(1).join(":")];u.a.dispatch({action:"view_room",highlighted:!0,event_id:n,room_id:t,auto_join:!0,via_servers:i,opts:{viaServers:i}})}renderPlaceholderText(){return this.state.isQuoting?this.props.e2eStatus?Object(c.a)("Send an encrypted reply…"):Object(c.a)("Send a reply…"):this.props.e2eStatus?Object(c.a)("Send an encrypted message…"):Object(c.a)("Send a message…")}addEmoji(e){u.a.dispatch({action:"insert_emoji",emoji:e})}render(){const e=[this.state.me?o.a.createElement(rm,{key:"controls_avatar",me:this.state.me}):null,this.props.e2eStatus?o.a.createElement(wn.b,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}):null];if(!this.state.tombstone&&this.state.canSendMessages){const t=d.getComponent("rooms.SendMessageComposer"),s=this.props.callState&&"ended"!==this.props.callState;e.push(o.a.createElement(t,{ref:e=>this.messageComposerInput=e,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}),o.a.createElement(um,{key:"controls_upload",roomId:this.props.room.roomId}),o.a.createElement(dm,{key:"emoji_button",addEmoji:this.addEmoji}),o.a.createElement(nm,{key:"stickerpicker_controls_button",room:this.props.room})),this.state.showCallButtons&&(s?e.push(o.a.createElement(lm,{key:"controls_hangup",roomId:this.props.room.roomId})):e.push(o.a.createElement(am,{key:"controls_call",roomId:this.props.room.roomId}),o.a.createElement(cm,{key:"controls_videocall",roomId:this.props.room.roomId})))}else if(this.state.tombstone){const t=this.state.tombstone.getContent().replacement_room,n=t?o.a.createElement("a",{href:Object($n.f)(t),className:"mx_MessageComposer_roomReplaced_link",onClick:this._onTombstoneClick},Object(c.a)("The conversation continues here.")):"";e.push(o.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},o.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},o.a.createElement("img",{className:"mx_MessageComposer_roomReplaced_icon",src:s(1139)}),o.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(c.a)("This room has been replaced and is no longer active.")),o.a.createElement("br",null),n)))}else e.push(o.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(c.a)("You do not have permission to post to this room")));return o.a.createElement("div",{className:"mx_MessageComposer mx_GroupLayout"},o.a.createElement("div",{className:"mx_MessageComposer_wrapper"},o.a.createElement(om,{permalinkCreator:this.props.permalinkCreator}),o.a.createElement("div",{className:"mx_MessageComposer_row"},e)))}}hm.propTypes={room:re.a.object.isRequired,callState:re.a.string,showApps:re.a.bool};var mm=s(514),pm=s(549);class gm extends o.a.Component{getDuration(e){if(!e)return;const t=parseInt(e/1e3),s=t%60,n=parseInt(t/60)%60,i=parseInt(t/3600)%24,o=parseInt(t/86400);return t<60?t<0?Object(c.a)("%(duration)ss",{duration:0}):Object(c.a)("%(duration)ss",{duration:s}):t<3600?Object(c.a)("%(duration)sm",{duration:n}):t<86400?Object(c.a)("%(duration)sh",{duration:i}):Object(c.a)("%(duration)sd",{duration:o})}getPrettyPresence(e,t,s){if(!s&&void 0!==t&&t>0){const s=this.getDuration(t);return"online"===e?Object(c.a)("Online for %(duration)s",{duration:s}):"unavailable"===e?Object(c.a)("Idle for %(duration)s",{duration:s}):"offline"===e?Object(c.a)("Offline for %(duration)s",{duration:s}):Object(c.a)("Unknown for %(duration)s",{duration:s})}return"online"===e?Object(c.a)("Online"):"unavailable"===e?Object(c.a)("Idle"):"offline"===e?Object(c.a)("Offline"):Object(c.a)("Unknown")}render(){return o.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}}g()(gm,"propTypes",{activeAgo:re.a.number,currentlyActive:re.a.bool,presenceState:re.a.string}),g()(gm,"defaultProps",{activeAgo:-1,presenceState:null});var fm=s(1140);function _m(e){return e.canonicalAlias||(e.aliases?e.aliases[0]:"")}const vm=re.a.shape({name:re.a.string,topic:re.a.string,roomId:re.a.string,avatarUrl:re.a.string,numJoinedMembers:re.a.number,canonicalAlias:re.a.string,aliases:re.a.arrayOf(re.a.string),worldReadable:re.a.bool,guestCanJoin:re.a.bool});class ym extends o.a.Component{constructor(e){super(e),g()(this,"onClick",e=>{e.preventDefault(),this.props.onClick&&this.props.onClick(e,this.props.room)}),g()(this,"onTopicClick",e=>{e.stopPropagation()}),this._topic=Object(i.createRef)()}componentDidMount(){this._linkifyTopic()}componentDidUpdate(){this._linkifyTopic()}_linkifyTopic(){this._topic.current&&Object(qn.e)(this._topic.current)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.room,s=t.name||_m(t)||Object(c.a)("Unnamed room"),n=t.worldReadable?o.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(c.a)("World readable")):o.a.createElement("div",null),i=t.guestCanJoin?o.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(c.a)("Guests can join")):o.a.createElement("div",null),r=n||i?o.a.createElement("div",{className:"mx_RoomDirectory_perms"},n," ",i):o.a.createElement("div",null);return o.a.createElement("tr",{key:t.roomId,onClick:this.onClick,onMouseDown:this.props.onMouseDown},o.a.createElement("td",{className:"mx_RoomDirectory_roomAvatar"},o.a.createElement(e,{width:24,height:24,resizeMethod:"crop",name:s,idName:s,url:Object(No.a)(L.a.get().getHomeserverUrl(),t.avatarUrl,24,24,"crop")})),o.a.createElement("td",{className:"mx_RoomDirectory_roomDescription"},o.a.createElement("div",{className:"mx_RoomDirectory_name"},s)," ",r,o.a.createElement("div",{className:"mx_RoomDirectory_topic",ref:this._topic,onClick:this.onTopicClick},t.topic),o.a.createElement("div",{className:"mx_RoomDirectory_alias"},_m(t))),o.a.createElement("td",{className:"mx_RoomDirectory_roomMemberCount"},t.numJoinedMembers))}}g()(ym,"propTypes",{room:vm,onClick:re.a.func,onMouseDown:re.a.func});class bm extends o.a.Component{constructor(...e){super(...e),g()(this,"onDetailsClick",(e,t)=>{u.a.dispatch({action:"view_room",room_id:t.roomId,room_alias:t.canonicalAlias||(t.aliases||[])[0]})})}getRows(){if(!this.props.rooms)return[];const e=d.getComponent("rooms.RoomDetailRow");return this.props.rooms.map((t,s)=>o.a.createElement(e,{key:s,room:t,onClick:this.onDetailsClick}))}render(){let e;return e=0===this.getRows().length?o.a.createElement("i",null,Object(c.a)("No rooms to show")):o.a.createElement("table",{className:"mx_RoomDirectory_table"},o.a.createElement("tbody",null,this.getRows())),o.a.createElement("div",{className:E()("mx_RoomDetailList",this.props.className)},e)}}g()(bm,"propTypes",{rooms:re.a.arrayOf(vm),className:re.a.string});var Em=s(518),Sm=s(509),wm=s(513),Cm=s(512),Rm=s(511);class km extends o.a.Component{render(){const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("rooms.EventTile"),s=this.props.searchResult,n=s.context.getEvent(),i=n.getId(),r=n.getTs(),a=[o.a.createElement(e,{key:r+"-search",ts:r})],c=s.context.getTimeline();for(var l=0;l<c.length;l++){const e=c[l];var u;const n=l!=s.context.getOurEventIndex();n||(u=this.props.searchHighlights),Object($e.b)(e)&&a.push(o.a.createElement(t,{key:i+"+"+l,mxEvent:e,contextual:n,highlights:u,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged}))}return o.a.createElement("li",{"data-scroll-tokens":i+"+"+l},a)}}g()(km,"propTypes",{searchResult:re.a.object.isRequired,searchHighlights:re.a.array,resultLink:re.a.string,onHeightChanged:re.a.func});class Im{constructor(e,t){g()(this,"history",[]),g()(this,"prefix",void 0),g()(this,"lastIndex",0),g()(this,"currentIndex",0),this.prefix=t+e;let s,n=0;for(;s=sessionStorage.getItem(`${this.prefix}[${n}]`);){try{const e=JSON.parse(s);this.history.push(e)}catch(e){console.warn("Throwing away unserialisable history",e);break}++n}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}save(e){const t=e.serializeParts();this.history.push(t),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(t))}getItem(e){return this.currentIndex=Object(jt.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}function Om(e,t){const s=Lh(e);s&&(e=Bh(e)),Fh(e,"//")&&(e=Vh(e,"/")),e=function(e){const{parts:t}=e;if(t.length){const s=t[0];"plain"===s.type&&s.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}(e);const n=A.a.getQuotingEvent(),i={msgtype:s?"m.emote":"m.text",body:Mh(e)},o=Uh(e,{forceHTML:!!n});return o&&(i.format="org.matrix.custom.html",i.formatted_body=o),n&&function(e,t,s){const n=cd.a.makeReplyMixIn(t);Object.assign(e,n);const i=cd.a.getNestedReplyText(t,s);i&&(e.formatted_body&&(e.formatted_body=i.html+e.formatted_body),e.body=i.body+e.body)}(i,n,t),i}class Tm extends o.a.Component{constructor(e,t){super(e,t),g()(this,"_setEditorRef",e=>{this._editorRef=e}),g()(this,"_onKeyDown",e=>{if(this._editorRef.isComposing(e))return;const t=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey;e.key!==Yt.a.ENTER||t?e.key===Yt.a.ARROW_UP?this.onVerticalArrow(e,!0):e.key===Yt.a.ARROW_DOWN?this.onVerticalArrow(e,!1):this._prepareToEncrypt?this._prepareToEncrypt():e.key===Yt.a.ESCAPE&&u.a.dispatch({action:"reply_to_event",event:null}):(this._sendMessage(),e.preventDefault())}),g()(this,"_saveStoredEditorState",()=>{this.model.isEmpty?this._clearStoredEditorState():localStorage.setItem(this._editorStateKey,JSON.stringify(this.model.serializeParts()))}),g()(this,"onAction",e=>{switch(e.action){case"reply_to_event":case h.a.FocusComposer:this._editorRef&&this._editorRef.focus();break;case"insert_mention":this._insertMention(e.user_id);break;case"quote":this._insertQuotedMessage(e.event);break;case"insert_emoji":this._insertEmoji(e.emoji)}}),g()(this,"_insertEmoji",e=>{const{model:t}=this,{partCreator:s}=t,n=this._editorRef.getCaret(),i=t.positionForOffset(n.offset,n.atNodeEnd);t.transform(()=>{const o=t.insert([s.plain(e)],i);return t.positionForOffset(n.offset+o,!0)})}),g()(this,"_onPaste",e=>{const{clipboardData:t}=e;if(t.files.length&&!t.types.some(e=>"text/plain"===e))return Fr.a.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.context),!0}),this.model=null,this._editorRef=null,this.currentlyComposedEditorState=null;const s=L.a.get();s.isCryptoEnabled()&&s.isRoomEncrypted(this.props.room.roomId)&&(this._prepareToEncrypt=new Xh.a(()=>{s.prepareToEncrypt(this.props.room)},6e4))}onVerticalArrow(e,t){if(e.shiftKey||e.metaKey)return;const s=e.altKey&&e.ctrlKey,n=!e.altKey&&!e.ctrlKey&&t&&!A.a.getQuotingEvent();if(s){this.selectSendHistory(t)&&e.preventDefault()}else if(n&&this._editorRef.isSelectionCollapsed()&&this._editorRef.isCaretAtStart()){const t=sc(this.props.room,!1);t&&(e.preventDefault(),u.a.dispatch({action:"edit_event",event:t}))}}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),void(this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length);const s=this.sendHistoryManager.getItem(t);s&&(this.model.reset(s),this._editorRef.focus())}_isSlashCommand(){const e=this.model.parts[0];if(e){if("command"===e.type&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&("plain"===e.type||"pill-candidate"===e.type))return!0}return!1}_getSlashCommand(){const e=this.model.parts.reduce((e,t)=>"user-pill"===t.type?e+t.resourceId:e+t.text,"");return[di(this.props.room.roomId,e),e]}async _runSlashCommand(e){const t=e();let s=t.error;if(t.promise)try{await t.promise}catch(e){s=e}if(s){console.error("Command failure: %s",s);const e=d.getComponent("dialogs.ErrorDialog"),n=!!t.promise?Object(c.b)("Server error"):Object(c.b)("Command error");let i;i="string"==typeof s?s:s.message?s.message:Object(c.a)("Server unavailable, overloaded, or something else went wrong."),ke.a.createTrackedDialog(n,"",e,{title:Object(c.a)(n),description:i})}else console.log("Command success.")}async _sendMessage(){if(this.model.isEmpty)return;let e=!0;if(!Lh(this.model)&&this._isSlashCommand()){const[t,s]=this._getSlashCommand();if(t)e=!1,this._runSlashCommand(t);else{const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=ke.a.createTrackedDialog("Unknown command","",e,{title:Object(c.a)("Unknown Command"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Unrecognised command: %(commandText)s",{commandText:s})),o.a.createElement("p",null,Object(c.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>o.a.createElement("code",null,e)})),o.a.createElement("p",null,Object(c.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>o.a.createElement("code",null,e)}))),button:Object(c.a)("Send as message")}),[n]=await t;if(!n)return}}if(e){const e=!!A.a.getQuotingEvent(),{roomId:t}=this.props.room,s=Om(this.model,this.props.permalinkCreator);this.context.sendMessage(t,s),e&&u.a.dispatch({action:"reply_to_event",event:null}),u.a.dispatch({action:"message_sent"})}this.sendHistoryManager.save(this.model),this.model.reset([]),this._editorRef.clearUndoHistory(),this._editorRef.focus(),this._clearStoredEditorState()}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}UNSAFE_componentWillMount(){const e=new mo(this.props.room,this.context),t=this._restoreStoredEditorState(e)||[];this.model=new Ah(t,e),this.dispatcherRef=u.a.register(this.onAction),this.sendHistoryManager=new Im(this.props.room.roomId,"mx_cider_composer_history_")}get _editorStateKey(){return"cider_editor_state_"+this.props.room.roomId}_clearStoredEditorState(){localStorage.removeItem(this._editorStateKey)}_restoreStoredEditorState(e){const t=localStorage.getItem(this._editorStateKey);if(t){return JSON.parse(t).map(t=>e.deserializePart(t))}}_insertMention(e){const{model:t}=this,{partCreator:s}=t,n=this.props.room.getMember(e),i=n?n.rawDisplayName:e,o=this._editorRef.getCaret(),r=t.positionForOffset(o.offset,o.atNodeEnd),a=r.index>0?r.index:0,c=s.createMentionParts(a,i,e);t.transform(()=>{const e=t.insert(c,r);return t.positionForOffset(o.offset+e,!0)}),this._editorRef&&this._editorRef.focus()}_insertQuotedMessage(e){const{model:t}=this,{partCreator:s}=t,n=bo(e,s,{isQuotedMessage:!0});n.push(s.newline()),n.push(s.newline()),t.transform(()=>{const e=t.insert(n,t.positionForOffset(0));return t.positionForOffset(e,!0)}),this._editorRef&&this._editorRef.focus()}render(){return o.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this._onKeyDown},o.a.createElement(To,{ref:this._setEditorRef,model:this.model,room:this.props.room,label:this.props.placeholder,placeholder:this.props.placeholder,onChange:this._saveStoredEditorState,onPaste:this._onPaste}))}}g()(Tm,"propTypes",{room:re.a.object.isRequired,placeholder:re.a.string,permalinkCreator:re.a.object.isRequired}),g()(Tm,"contextType",S.a);var xm=s(519);class Nm extends o.a.Component{constructor(e){super(e),g()(this,"onRoomStateEvents",e=>{if("m.room.third_party_invite"===e.getType()&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,s={invited:Object(Mt.c)(e)};t&&(s.displayName=t),this.setState(s)}}),g()(this,"onCancel",()=>{u.a.dispatch({action:"view_3pid_invite",event:null})}),g()(this,"onKickClick",()=>{L.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch(e=>{console.error(e),this.setState({invited:!0});const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Revoke 3pid invite failed","",t,{title:Object(c.a)("Failed to revoke invite"),description:Object(c.a)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})}),this.setState({invited:!1})});const t=L.a.get().getRoom(this.props.event.getRoomId()),s=t.getMember(L.a.get().getUserId()),n=t.currentState.getStateEvents("m.room.power_levels","");let i=n?n.getContent().kick:50;"number"!=typeof i&&(i=50);const o=t.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!s&&s.powerLevel>i,senderName:o?o.name:this.props.event.getSender()}}componentDidMount(){L.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=L.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}render(){const e=d.getComponent("elements.AccessibleButton");let t=null;return this.state.canKick&&this.state.invited&&(t=o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("h3",null,Object(c.a)("Admin Tools")),o.a.createElement("div",{className:"mx_MemberInfo_buttons"},o.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(c.a)("Revoke invite"))))),o.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},o.a.createElement("div",{className:"mx_MemberInfo_name"},o.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(c.a)("Close")}),o.a.createElement("h2",null,this.state.displayName)),o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("div",{className:"mx_MemberInfo_profile"},o.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(c.a)("Invited by %(sender)s",{sender:this.state.senderName})))),t)}}g()(Nm,"propTypes",{event:re.a.instanceOf(de.i).isRequired});class jm extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},o.a.createElement(Z.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(c.a)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),o.a.createElement(Z.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(c.a)("Mark all as read"),onClick:this.props.onCloseClick}))}}function Pm(e,t){const s=[];void 0===t&&(t=[]);const n=Object.keys(e.currentState.members);for(let i=0;i<n.length;++i){const o=n[i];e.currentState.members[o].typing&&-1===t.indexOf(o)&&s.push(e.currentState.members[o])}return s}g()(jm,"propTypes",{onScrollUpClick:re.a.func,onCloseClick:re.a.func});var Dm=s(178);class Am extends o.a.Component{constructor(...e){var t;super(...e),g()(this,"state",{usersTyping:(t=this.props.room,Pm(t,[L.a.get().credentials.userId])),delayedStopTypingTimers:{}}),g()(this,"isVisible",()=>this._isVisible(this.state)),g()(this,"onRoomTimeline",(e,t)=>{if(t&&t.roomId===this.props.room.roomId){const t=e.getSender(),s=this.state.usersTyping.filter(e=>e.userId!==t);this.setState({usersTyping:s}),this._abortUserTimer(t)}}),g()(this,"onRoomMemberTyping",(e,t)=>{const s=function(e){return Pm(e,[L.a.get().credentials.userId].concat(L.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this._updateDelayedStopTypingTimers(s),usersTyping:s})})}componentDidMount(){L.a.get().on("RoomMember.typing",this.onRoomMemberTyping),L.a.get().on("Room.timeline",this.onRoomTimeline)}componentDidUpdate(e,t){const s=this._isVisible(t),n=this._isVisible(this.state);this.props.onShown&&!s&&n?this.props.onShown():this.props.onHidden&&s&&!n&&this.props.onHidden()}componentWillUnmount(){const e=L.a.get();e&&(e.removeListener("RoomMember.typing",this.onRoomMemberTyping),e.removeListener("Room.timeline",this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}_isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}_updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),s=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));s.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let n=Object.assign({},this.state.delayedStopTypingTimers);return n=s.reduce((e,t)=>(delete e[t.userId],e),n),n=t.reduce((e,t)=>{if(!e[t.userId]){const s=new Dm.a(5e3);e[t.userId]=s,s.start(),s.finished().then(()=>this._removeUserTimer(t.userId),()=>{})}return e},n),n}_abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this._removeUserTimer(e))}_removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}_renderTypingIndicatorAvatars(e,t){let s=0;e.length>t&&(s=e.length-t+1,e=e.slice(0,t-1));const n=e.map(e=>o.a.createElement(Xs.a,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0}));return s>0&&n.push(o.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",s)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map(e=>this.props.room.getMember(e));e=e.concat(t),e.sort((e,t)=>e.name.localeCompare(t.name));const s=function(e,t){let s=0;if(e.length>t&&(s=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(c.a)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map((function(e){return e.name}));if(s>=1)return Object(c.a)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:s});{const e=n.pop();return Object(c.a)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return s?o.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this._renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},s)):o.a.createElement("div",{className:"mx_WhoIsTypingTile_empty"})}}g()(Am,"propTypes",{room:re.a.object.isRequired,onShown:re.a.func,onHidden:re.a.func,whoIsTypingLimit:re.a.number}),g()(Am,"defaultProps",{whoIsTypingLimit:3});const Um=({avatarUrl:e,avatarAltText:t,avatarName:s,uploadAvatar:n,removeAvatar:r})=>{const a=d.getComponent("elements.AccessibleButton"),l=Object(i.useCallback)(()=>{const t=d.getComponent("elements.ImageView");ke.a.createDialog(t,{src:e,name:s},"mx_Dialog_lightbox")},[e,s]);let u,h,m=o.a.createElement("div",{className:"mx_AvatarSetting_avatarPlaceholder"});return e&&(m=o.a.createElement(a,{element:"img",src:e,alt:t,"aria-label":t,onClick:l})),n&&(u=o.a.createElement(a,{onClick:n,kind:"primary"},Object(c.a)("Upload"))),e&&r&&(h=o.a.createElement(a,{onClick:r,kind:"link_sm"},Object(c.a)("Remove"))),o.a.createElement("div",{className:"mx_AvatarSetting_avatar"},m,u,h)};Um.propTypes={avatarUrl:re.a.string,avatarName:re.a.string.isRequired,uploadAvatar:re.a.func,removeAvatar:re.a.func,avatarAltText:re.a.string.isRequired};var Mm=Um;class Lm extends o.a.Component{constructor(e){super(e),g()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&e.getSender()===L.a.get().getUserId()&&(e.getContent().url||(this.avatarSet=!1,this.setState({})))}),g()(this,"onFileSelected",e=>(this.avatarSet=!0,this.setAvatarFromFile(e.target.files[0]))),g()(this,"onError",e=>{this.setState({errorText:Object(c.a)("Failed to upload profile picture!")})}),this.state={avatarUrl:this.props.initialAvatarUrl,phase:Lm.Phases.Display}}componentDidMount(){L.a.get().on("RoomState.events",this.onRoomStateEvents)}UNSAFE_componentWillReceiveProps(e){this.avatarSet||this.setState({avatarUrl:e.initialAvatarUrl})}componentWillUnmount(){L.a.get()&&L.a.get().removeListener("RoomState.events",this.onRoomStateEvents)}setAvatarFromFile(e){let t=null;this.setState({phase:Lm.Phases.Uploading});const s=this,n=L.a.get().uploadContent(e).then((function(e){return t=e,s.props.room?L.a.get().sendStateEvent(s.props.room.roomId,"m.room.avatar",{url:e},""):L.a.get().setAvatarUrl(e)}));return n.then((function(){s.setState({phase:Lm.Phases.Display,avatarUrl:L.a.get().mxcUrlToHttp(t)})}),(function(e){s.setState({phase:Lm.Phases.Error}),s.onError(e)})),n}render(){let e,t;if(this.props.room&&!this.avatarSet){const t=d.getComponent("avatars.RoomAvatar");e=o.a.createElement(t,{room:this.props.room,width:this.props.width,height:this.props.height,resizeMethod:"crop"})}else{const t=d.getComponent("avatars.BaseAvatar");e=o.a.createElement(t,{width:this.props.width,height:this.props.height,resizeMethod:"crop",name:"?",idName:L.a.get().getUserIdLocalpart(),url:this.state.avatarUrl})}switch(this.props.showUploadSection&&(t=o.a.createElement("div",{className:this.props.className},Object(c.a)("Upload new:"),o.a.createElement("input",{type:"file",accept:"image/*",onChange:this.onFileSelected}),this.state.errorText)),this.state.phase){case Lm.Phases.Display:case Lm.Phases.Error:return o.a.createElement("div",null,o.a.createElement("div",{className:this.props.className},e),t);case Lm.Phases.Uploading:var s=d.getComponent("elements.Spinner");return o.a.createElement(s,null)}}}g()(Lm,"propTypes",{initialAvatarUrl:re.a.string,room:re.a.object,showUploadSection:re.a.bool,width:re.a.number,height:re.a.number,className:re.a.string}),g()(Lm,"Phases",{Display:"display",Uploading:"uploading",Error:"error"}),g()(Lm,"defaultProps",{showUploadSection:!0,className:"",width:80,height:80});class Fm extends o.a.Component{constructor(...e){super(...e),g()(this,"_getDisplayName",async()=>{const e=L.a.get();try{return(await e.getProfileInfo(e.getUserId())).displayname}catch(e){throw new Error("Failed to fetch display name")}}),g()(this,"_changeDisplayName",e=>L.a.get().setDisplayName(e).catch((function(e){throw new Error("Failed to set display name",e)})))}render(){const e=d.getComponent("elements.EditableTextContainer");return o.a.createElement(e,{getInitialValue:this._getDisplayName,placeholder:Object(c.a)("No display name"),blurToSubmit:!0,onSubmit:this._changeDisplayName})}}class Bm extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{phase:Bm.Phases.Edit,cachedPassword:null,oldPassword:"",newPassword:"",newPasswordConfirm:""}),g()(this,"_setStateFromSessionStore",()=>{this.setState({cachedPassword:this._sessionStore.getCachedPassword()})}),g()(this,"_onExportE2eKeysClicked",()=>{ke.a.createTrackedDialogAsync("Export E2E Keys","Change Password",s.e(1).then(s.bind(null,1165)),{matrixClient:L.a.get()})}),g()(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),g()(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),g()(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),g()(this,"onClickChange",e=>{e.preventDefault();const t=this.state.cachedPassword||this.state.oldPassword,s=this.state.newPassword,n=this.state.newPasswordConfirm,i=this.props.onCheckPassword(t,s,n);i?this.props.onError(i):this.changePassword(t,s)})}componentDidMount(){this._sessionStore=hs,this._sessionStoreToken=this._sessionStore.addListener(this._setStateFromSessionStore),this._setStateFromSessionStore()}componentWillUnmount(){this._sessionStoreToken&&this._sessionStoreToken.remove()}changePassword(e,t){const s=L.a.get();if(!this.props.confirm)return void this._changePassword(s,e,t);const n=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Change Password","",n,{title:Object(c.a)("Warning!"),description:o.a.createElement("div",null,Object(c.a)("Changing password will currently reset any end-to-end encryption keys on all sessions, making encrypted chat history unreadable, unless you first export your room keys and re-import them afterwards. In future this will be improved.")," ",o.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/2671",target:"_blank",rel:"noreferrer noopener"},"https://github.com/vector-im/element-web/issues/2671")),button:Object(c.a)("Continue"),extraButtons:[o.a.createElement("button",{className:"mx_Dialog_primary",onClick:this._onExportE2eKeysClicked},Object(c.a)("Export E2E room keys"))],onFinished:n=>{n&&this._changePassword(s,e,t)}})}_changePassword(e,t,s){const n={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:e.credentials.userId,password:t};this.setState({phase:Bm.Phases.Uploading}),e.setPassword(n,s).then(()=>{if(u.a.dispatch({action:"password_changed"}),this.props.shouldAskForEmail)return this._optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e})});this.props.onFinished()},e=>{this.props.onError(e)}).finally(()=>{this.setState({phase:Bm.Phases.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}_optionallySetEmail(){const e=d.getComponent("dialogs.SetEmailDialog");return ke.a.createTrackedDialog("Do you want to set an email address?","",e,{title:Object(c.a)("Do you want to set an email address?")}).finished.then(([e])=>e)}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;let s=null;switch(this.state.cachedPassword||(s=o.a.createElement("div",{className:e},o.a.createElement(le.a,{type:"password",label:Object(c.a)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword}))),this.state.phase){case Bm.Phases.Edit:const i=this.state.cachedPassword?Object(c.a)("Password"):Object(c.a)("New Password");return o.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},s,o.a.createElement("div",{className:e},o.a.createElement(le.a,{type:"password",label:i,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,autoComplete:"new-password"})),o.a.createElement("div",{className:e},o.a.createElement(le.a,{type:"password",label:Object(c.a)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,autoComplete:"new-password"})),o.a.createElement(Z.a,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},Object(c.a)("Change Password")));case Bm.Phases.Uploading:var n=d.getComponent("elements.Spinner");return o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(n,null))}}}g()(Bm,"propTypes",{onFinished:re.a.func,onError:re.a.func,onCheckPassword:re.a.func,rowClassName:re.a.string,buttonClassName:re.a.string,buttonKind:re.a.string,confirm:re.a.bool,autoFocusNewPasswordInput:re.a.bool}),g()(Bm,"Phases",{Edit:"edit",Uploading:"uploading",Error:"error"}),g()(Bm,"defaultProps",{onFinished(){},onError(){},onCheckPassword:(e,t,s)=>t!==s?{error:Object(c.a)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(c.a)("Passwords can't be empty")},confirm:!0});class Vm extends o.a.PureComponent{constructor(e){super(e),g()(this,"onAccountData",e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this._getUpdatedStatus()}),g()(this,"_onBootstrapClick",()=>{this._bootstrapSecureSecretStorage(!1)}),g()(this,"onStatusChanged",()=>{this._getUpdatedStatus()}),g()(this,"_bootstrapSecureSecretStorage",async(e=!1)=>{this.setState({error:null});try{await Object(xl.b)(()=>{},e)}catch(e){this.setState({error:e}),console.error("Error bootstrapping secret storage",e)}this._unmounted||this._getUpdatedStatus()}),g()(this,"onDestroyStorage",e=>{e&&this._bootstrapSecureSecretStorage(!0)}),g()(this,"_destroySecureSecretStorage",()=>{const e=d.getComponent("dialogs.ConfirmDestroyCrossSigningDialog");ke.a.createDialog(e,{onFinished:this.onDestroyStorage})}),this._unmounted=!1,this.state={error:null,crossSigningPublicKeysOnDevice:!1,crossSigningPrivateKeysInStorage:!1,masterPrivateKeyCached:!1,selfSigningPrivateKeyCached:!1,userSigningPrivateKeyCached:!1,sessionBackupKeyCached:!1,secretStorageKeyInAccount:!1}}componentDidMount(){const e=L.a.get();e.on("accountData",this.onAccountData),e.on("userTrustStatusChanged",this.onStatusChanged),e.on("crossSigning.keysChanged",this.onStatusChanged),this._getUpdatedStatus()}componentWillUnmount(){this._unmounted=!0;const e=L.a.get();e&&(e.removeListener("accountData",this.onAccountData),e.removeListener("userTrustStatusChanged",this.onStatusChanged),e.removeListener("crossSigning.keysChanged",this.onStatusChanged))}async _getUpdatedStatus(){const e=L.a.get(),t=e.getCrossSigningCacheCallbacks(),s=e._crypto._crossSigningInfo,n=e._crypto._secretStorage,i=s.getId(),o=await s.isStoredInSecretStorage(n),r=!(!t||!await t.getCrossSigningKeyCache("master")),a=!(!t||!await t.getCrossSigningKeyCache("self_signing")),c=!(!t||!await t.getCrossSigningKeyCache("user_signing")),l=await e._crypto.getSessionBackupPrivateKey(),d=!!l,u=l instanceof Uint8Array,h=await n.hasKey(),m=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),p=await e.isCrossSigningReady(),g=await e.isSecretStorageReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:o,masterPrivateKeyCached:r,selfSigningPrivateKeyCached:a,userSigningPrivateKeyCached:c,sessionBackupKeyCached:d,sessionBackupKeyWellFormed:u,secretStorageKeyInAccount:h,homeserverSupportsCrossSigning:m,crossSigningReady:p,secretStorageReady:g})}render(){const e=d.getComponent("elements.AccessibleButton"),{error:t,crossSigningPublicKeysOnDevice:s,crossSigningPrivateKeysInStorage:n,masterPrivateKeyCached:i,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:a,sessionBackupKeyCached:l,sessionBackupKeyWellFormed:u,secretStorageKeyInAccount:h,homeserverSupportsCrossSigning:m,crossSigningReady:p,secretStorageReady:g}=this.state;let f,_;t&&(f=o.a.createElement("div",{className:"error"},t.toString())),_=void 0===m?o.a.createElement(Ne.a,null):m?p&&g?o.a.createElement("p",null,"✅ ",Object(c.a)("Cross-signing and secret storage are ready for use.")):p&&!g?o.a.createElement("p",null,"✅ ",Object(c.a)("Cross-signing is ready for use, but secret storage is currently not being used to backup your keys.")):n?o.a.createElement("p",null,Object(c.a)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):o.a.createElement("p",null,Object(c.a)("Cross-signing and secret storage are not yet set up.")):o.a.createElement("p",null,Object(c.a)("Your homeserver does not support cross-signing."));const v=h&&n&&s;let y,b;(h||n||s)&&(y=o.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},o.a.createElement(e,{kind:"danger",onClick:this._destroySecureSecretStorage},Object(c.a)("Reset cross-signing and secret storage")))),!v&&m&&(b=o.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},o.a.createElement(e,{kind:"primary",onClick:this._onBootstrapClick},Object(c.a)("Bootstrap cross-signing and secret storage"))));let E="";return l&&(E=", ",E+=u?Object(c.a)("well formed"):Object(c.a)("unexpected type")),o.a.createElement("div",null,_,o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Cross-signing public keys:")),o.a.createElement("td",null,s?Object(c.a)("in memory"):Object(c.a)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Cross-signing private keys:")),o.a.createElement("td",null,n?Object(c.a)("in secret storage"):Object(c.a)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Master private key:")),o.a.createElement("td",null,i?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Self signing private key:")),o.a.createElement("td",null,r?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("User signing private key:")),o.a.createElement("td",null,a?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Session backup key:")),o.a.createElement("td",null,l?Object(c.a)("cached locally"):Object(c.a)("not found locally"),E)),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Secret storage public key:")),o.a.createElement("td",null,h?Object(c.a)("in account data"):Object(c.a)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(c.a)("Homeserver feature support:")),o.a.createElement("td",null,m?Object(c.a)("exists"):Object(c.a)("not found")))))),f,b,y)}}class Km extends o.a.Component{constructor(e){super(e),this.state={devices:void 0,deviceLoadError:void 0,selectedDevices:[],deleting:!1},this._unmounted=!1,this._renderDevice=this._renderDevice.bind(this),this._onDeviceSelectionToggled=this._onDeviceSelectionToggled.bind(this),this._onDeleteClick=this._onDeleteClick.bind(this)}componentDidMount(){this._loadDevices()}componentWillUnmount(){this._unmounted=!0}_loadDevices(){L.a.get().getDevices().then(e=>{this._unmounted||this.setState({devices:e.devices||[]})},e=>{if(this._unmounted)return;let t;404==e.httpStatus?t=Object(c.a)("Your homeserver does not support session management."):(console.error("Error loading sessions:",e),t=Object(c.a)("Unable to load session list")),this.setState({deviceLoadError:t})})}_deviceCompare(e,t){const s=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==s)return s;const n=e.device_id,i=t.device_id;return n<i?-1:n>i?1:0}_onDeviceSelectionToggled(e){if(this._unmounted)return;const t=e.device_id;this.setState((e,s)=>{const n=e.selectedDevices.slice(),i=n.indexOf(t);return-1===i?n.push(t):n.splice(i,1),{selectedDevices:n}})}_onDeleteClick(){this.setState({deleting:!0}),this._makeDeleteRequest(null).catch(e=>{if(this._unmounted)return;if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s=this.state.selectedDevices.length,n={[be.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm deleting these sessions by using Single Sign On to prove your identity.",{count:s}),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[be.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm deleting these sessions"),body:Object(c.a)("Click the button below to confirm deleting these sessions.",{count:s}),continueText:Object(c.a)("Delete sessions",{count:s}),continueKind:"danger"}};ke.a.createTrackedDialog("Delete Device Dialog","",t,{title:Object(c.a)("Authentication"),matrixClient:L.a.get(),authData:e.data,makeRequest:this._makeDeleteRequest.bind(this),aestheticsForStagePhases:{[be.c.LOGIN_TYPE]:n,[be.c.UNSTABLE_LOGIN_TYPE]:n}})}).catch(e=>{console.error("Error deleting sessions",e),this._unmounted}).finally(()=>{this.setState({deleting:!1})})}_makeDeleteRequest(e){return L.a.get().deleteMultipleDevices(this.state.selectedDevices,e).then(()=>{this.setState({devices:this.state.devices.filter(e=>!this.state.selectedDevices.includes(e.device_id)),selectedDevices:[]})})}_renderDevice(e){const t=d.getComponent("settings.DevicesPanelEntry");return o.a.createElement(t,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),onDeviceToggled:this._onDeviceSelectionToggled})}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("elements.AccessibleButton");if(void 0!==this.state.deviceLoadError){const e=E()(this.props.className,"error");return o.a.createElement("div",{className:e},this.state.deviceLoadError)}const s=this.state.devices;if(void 0===s){const t=this.props.className;return o.a.createElement(e,{className:t})}s.sort(this._deviceCompare);const n=this.state.deleting?o.a.createElement(e,{w:22,h:22}):o.a.createElement(t,{onClick:this._onDeleteClick,kind:"danger_sm"},Object(c.a)("Delete %(count)s sessions",{count:this.state.selectedDevices.length})),i=E()(this.props.className,"mx_DevicesPanel");return o.a.createElement("div",{className:i},o.a.createElement("div",{className:"mx_DevicesPanel_header"},o.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},Object(c.a)("ID")),o.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},Object(c.a)("Public Name")),o.a.createElement("div",{className:"mx_DevicesPanel_deviceLastSeen"},Object(c.a)("Last seen")),o.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},this.state.selectedDevices.length>0?n:null)),s.map(this._renderDevice))}}Km.propTypes={className:re.a.string};class qm extends o.a.Component{constructor(e){super(e),this._unmounted=!1,this.onDeviceToggled=this.onDeviceToggled.bind(this),this._onDisplayNameChanged=this._onDisplayNameChanged.bind(this)}componentWillUnmount(){this._unmounted=!0}_onDisplayNameChanged(e){const t=this.props.device;return L.a.get().setDeviceDetails(t.device_id,{display_name:e}).catch(e=>{throw console.error("Error setting session display name",e),new Error(Object(c.a)("Failed to set display name"))})}onDeviceToggled(){this.props.onDeviceToggled(this.props.device)}render(){const e=d.getComponent("elements.EditableTextContainer"),t=this.props.device;let s="";if(t.last_seen_ts){const e=Object(mr.a)(new Date(t.last_seen_ts));s=t.last_seen_ip+" @ "+e.toLocaleString()}let n="";return t.device_id===L.a.get().getDeviceId()&&(n=" mx_DevicesPanel_myDevice"),o.a.createElement("div",{className:"mx_DevicesPanel_device"+n},o.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},t.device_id),o.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},o.a.createElement(e,{initialValue:t.display_name,onSubmit:this._onDisplayNameChanged,placeholder:t.device_id})),o.a.createElement("div",{className:"mx_DevicesPanel_lastSeen"},s),o.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},o.a.createElement(we.a,{onChange:this.onDeviceToggled,checked:this.props.selected})))}}qm.propTypes={device:re.a.object.isRequired,onDeviceToggled:re.a.func},qm.defaultProps={onDeviceToggled:function(){}};var Gm=e=>{const t=d.getComponent("views.elements.SettingsFlag");return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Encryption")),o.a.createElement(t,{name:"e2ee.manuallyVerifyAllSessions",level:je.a.DEVICE}),o.a.createElement("div",{className:"mx_E2eAdvancedPanel_settingLongDescription"},Object(c.a)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")))};class Wm extends o.a.Component{constructor(){super(),g()(this,"updateCurrentRoom",async e=>{const t=$o.a.get();let s;try{s=await t.getStats()}catch{return}this.setState({eventIndexSize:s.size,roomCount:s.roomCount})}),g()(this,"_onManage",async()=>{ke.a.createTrackedDialogAsync("Message search","Message search",s.e(23).then(s.bind(null,1167)),{onFinished:()=>{}},null,!1,!0)}),g()(this,"_onEnable",async()=>{this.setState({enabling:!0}),await $o.a.initEventIndex(),await $o.a.get().addInitialCheckpoints(),await $o.a.get().startCrawler(),await w.a.setValue("enableEventIndexing",null,je.a.DEVICE,!0),await this.updateState()}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:w.a.getValueAt(je.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=$o.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}async componentDidMount(){this.updateState()}async updateState(){const e=$o.a.get(),t=w.a.getValueAt(je.a.DEVICE,"enableEventIndexing");let s=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);try{const t=await e.getStats();s=t.size,n=t.roomCount}catch{}}this.setState({enabling:!1,eventIndexSize:s,roomCount:n,eventIndexingEnabled:t})}render(){let e=null;const t=d.getComponent("elements.InlineSpinner"),s=l.a.get().brand;if(null!==$o.a.get())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results, using ")," ",Object(T.a)(this.state.eventIndexSize,0),Object(c.a)(" to store messages from "),Object(T.d)(this.state.roomCount)," ",Object(c.a)("rooms.")),o.a.createElement("div",null,o.a.createElement(Z.a,{kind:"primary",onClick:this._onManage},Object(c.a)("Manage"))));else if(!this.state.eventIndexingEnabled&&$o.a.supportIsInstalled())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results.")),o.a.createElement("div",null,o.a.createElement(Z.a,{kind:"primary",disabled:this.state.enabling,onClick:this._onEnable},Object(c.a)("Enable")),this.state.enabling?o.a.createElement(t,null):o.a.createElement("div",null)));else if($o.a.platformHasSupport()&&!$o.a.supportIsInstalled()){const t="https://github.com/vector-im/element-web/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:s},{nativeLink:e=>o.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:s},{desktopLink:e=>o.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}var Hm=s(436),$m=s(206);class zm extends o.a.PureComponent{constructor(e){super(e),g()(this,"_onKeyBackupSessionsRemaining",e=>{this.setState({sessionsRemaining:e})}),g()(this,"_onKeyBackupStatus",()=>{this._loadBackupStatus()}),g()(this,"_startNewBackup",()=>{ke.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(0).then(s.bind(null,544)),{onFinished:()=>{this._loadBackupStatus()}},null,!1,!0)}),g()(this,"_deleteBackup",()=>{const e=d.getComponent("dialogs.QuestionDialog");ke.a.createTrackedDialog("Delete Backup","",e,{title:Object(c.a)("Delete Backup"),description:Object(c.a)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(c.a)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),L.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then(()=>{this._loadBackupStatus()}))}})}),g()(this,"_restoreBackup",async()=>{const e=d.getComponent("dialogs.keybackup.RestoreKeyBackupDialog");ke.a.createTrackedDialog("Restore Backup","",e,null,null,!1,!0)}),this._unmounted=!1,this.state={loading:!0,error:null,backupInfo:null,backupSigStatus:null,backupKeyStored:null,sessionsRemaining:0}}componentDidMount(){this._checkKeyBackupStatus(),L.a.get().on("crypto.keyBackupStatus",this._onKeyBackupStatus),L.a.get().on("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining)}componentWillUnmount(){this._unmounted=!0,L.a.get()&&(L.a.get().removeListener("crypto.keyBackupStatus",this._onKeyBackupStatus),L.a.get().removeListener("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining))}async _checkKeyBackupStatus(){try{const{backupInfo:e,trustInfo:t}=await L.a.get().checkKeyBackup(),s=Boolean(await L.a.get().isKeyBackupKeyStored());this.setState({backupInfo:e,backupSigStatus:t,backupKeyStored:s,error:null,loading:!1})}catch(e){if(console.log("Unable to fetch check backup status",e),this._unmounted)return;this.setState({error:e,backupInfo:null,backupSigStatus:null,backupKeyStored:null,loading:!1})}}async _loadBackupStatus(){this.setState({loading:!0});try{const e=await L.a.get().getKeyBackupVersion(),t=await L.a.get().isKeyBackupTrusted(e),s=await L.a.get().isKeyBackupKeyStored();if(this._unmounted)return;this.setState({error:null,backupInfo:e,backupSigStatus:t,backupKeyStored:s,loading:!1})}catch(e){if(console.log("Unable to fetch key backup status",e),this._unmounted)return;this.setState({error:e,backupInfo:null,backupSigStatus:null,backupKeyStored:null,loading:!1})}}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("elements.AccessibleButton"),s=Object(c.a)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.");if(this.state.error)return o.a.createElement("div",{className:"error"},Object(c.a)("Unable to load key backup status"));if(this.state.loading)return o.a.createElement(e,null);if(this.state.backupInfo){let e,n,i,r=Object(c.a)("Restore from Backup");L.a.get().getKeyBackupEnabled()?e=o.a.createElement("div",null,o.a.createElement("p",null,s),o.a.createElement("p",null,"✅ ",Object(c.a)("This session is backing up your keys. "))):(e=o.a.createElement("div",null,o.a.createElement("p",null,s),o.a.createElement("p",null,Object(c.a)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(c.a)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),r=Object(c.a)("Connect this session to Key Backup")),n=!0===this.state.backupKeyStored?Object(c.a)("in secret storage"):Object(c.a)("not stored");const{sessionsRemaining:a}=this.state;i=L.a.get().getKeyBackupEnabled()?a>0?o.a.createElement("div",null,Object(c.a)("Backing up %(sessionsRemaining)s keys...",{sessionsRemaining:a})," ",o.a.createElement("br",null)):o.a.createElement("div",null,Object(c.a)("All keys backed up")," ",o.a.createElement("br",null)):"";let l,d,u=this.state.backupSigStatus.sigs.map((e,t)=>{const s=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>o.a.createElement("span",{className:e.valid?"mx_KeyBackupPanel_sigValid":"mx_KeyBackupPanel_sigInvalid"},t),i=t=>o.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_KeyBackupPanel_deviceVerified":"mx_KeyBackupPanel_deviceNotVerified"},t),r=e=>o.a.createElement("span",{className:"mx_KeyBackupPanel_deviceName"},s),a=e.device&&e.device.getFingerprint()===L.a.get().getDeviceEd25519Key(),l=e.crossSigningId&&e.deviceId===L.a.get().getCrossSigningId();let d;return e.valid&&l?d=Object(c.a)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&l?d=Object(c.a)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?d=Object(c.a)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}):e.device?e.valid&&a?d=Object(c.a)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&a?d=Object(c.a)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?d=Object(c.a)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:r}):e.valid&&!e.deviceTrust.isVerified()?d=Object(c.a)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:r}):!e.valid&&e.deviceTrust.isVerified()?d=Object(c.a)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:r}):e.valid||e.deviceTrust.isVerified()||(d=Object(c.a)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:r})):d=Object(c.a)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}),o.a.createElement("div",{key:t},d)});0===this.state.backupSigStatus.sigs.length&&(u=Object(c.a)("Backup is not signed by any of your sessions")),this.state.backupSigStatus.trusted_locally&&(l=Object(c.a)("This backup is trusted because it has been restored on this session")),Object($m.b)()||(d=o.a.createElement(t,{kind:"danger",onClick:this._deleteBackup},Object(c.a)("Delete Backup")));const h=o.a.createElement("div",{className:"mx_KeyBackupPanel_buttonRow"},o.a.createElement(t,{kind:"primary",onClick:this._restoreBackup},r),"   ",d);return o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement("details",null,o.a.createElement("summary",null,Object(c.a)("Advanced")),o.a.createElement("div",null,Object(c.a)("Backup version: "),this.state.backupInfo.version),o.a.createElement("div",null,Object(c.a)("Algorithm: "),this.state.backupInfo.algorithm),o.a.createElement("div",null,Object(c.a)("Backup key stored: "),n),i,o.a.createElement("div",null,u),o.a.createElement("div",null,l)),h)}return o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,s),o.a.createElement("p",null,Object(c.a)("Back up your keys before signing out to avoid losing them."))),o.a.createElement("div",{className:"mx_KeyBackupPanel_buttonRow"},o.a.createElement(t,{kind:"primary",onClick:this._startNewBackup},Object(c.a)("Start using Key Backup"))))}}let Ym,Jm,Qm,Xm;!function(e){e.AllMessages="all_messages",e.DirectMessagesMentionsKeywords="dm_mentions_keywords",e.MentionsKeywordsOnly="mentions_keywords",e.Never="never"}(Ym||(Ym={})),function(e){e.Notify="notify",e.DontNotify="dont_notify",e.Coalesce="coalesce",e.MarkUnread="mark_unread"}(Jm||(Jm={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(Qm||(Qm={})),function(e){e.MasterRule=".m.rule.master",e.MessageRule=".m.rule.message",e.EncryptedMessageRule=".m.rule.encrypted",e.RoomOneToOneRule=".m.rule.room_one_to_one",e.EncryptedRoomOneToOneRule=".m.rule.room_one_to_one"}(Xm||(Xm={}));class Zm{static encodeActions(e){const t=e.notify,s=e.sound,n=e.highlight;if(t){const e=[Jm.Notify];return s&&e.push({set_tweak:"sound",value:s}),n?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[Jm.DontNotify]}static decodeActions(e){let t=!1,s=null,n=!1;for(let i=0;i<e.length;++i){const o=e[i];if(o===Jm.Notify)t=!0;else if(o===Jm.DontNotify)t=!1;else{if("object"!=typeof o)return null;if("sound"===o.set_tweak)s=o.value;else{if("highlight"!==o.set_tweak)return null;n=o.value}}}void 0===n&&(n=!0);const i={notify:t,highlight:n};return null!==s&&(i.sound=s),i}}const ep=Zm.encodeActions;class tp{}let sp;g()(tp,"ACTION_NOTIFY",ep({notify:!0})),g()(tp,"ACTION_NOTIFY_DEFAULT_SOUND",ep({notify:!0,sound:"default"})),g()(tp,"ACTION_NOTIFY_RING_SOUND",ep({notify:!0,sound:"ring"})),g()(tp,"ACTION_HIGHLIGHT",ep({notify:!0,highlight:!0})),g()(tp,"ACTION_HIGHLIGHT_DEFAULT_SOUND",ep({notify:!0,sound:"default",highlight:!0})),g()(tp,"ACTION_DONT_NOTIFY",ep({notify:!1})),g()(tp,"ACTION_DISABLED",null),function(e){e.Off="off",e.On="on",e.Loud="loud"}(sp||(sp={}));class np{static actionsFor(e){return e===sp.On?tp.ACTION_NOTIFY:e===sp.Loud?tp.ACTION_HIGHLIGHT_DEFAULT_SOUND:void 0}static contentRuleVectorStateKind(e){const t=Zm.decodeActions(e.actions);if(!t)return null;let s=0;t.sound&&s++,t.highlight&&s++;let n=null;switch(s){case 0:n=sp.On;break;case 2:n=sp.Loud}return n}}g()(np,"OFF",sp.Off),g()(np,"ON",sp.On),g()(np,"LOUD",sp.Loud),g()(np,"states",sp);class ip{constructor(e){this.kind=e.kind,this.description=e.description,this.vectorStateToActions=e.vectorStateToActions}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const s in np.states){const n=np.states[s],i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(Zm.decodeActions(e.actions))===JSON.stringify(Zm.decodeActions(i)))return n}else if(!t)return n}console.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: `+JSON.stringify(this.vectorStateToActions))}}const op={".m.rule.contains_display_name":new ip({kind:"override",description:Object(c.b)("Messages containing my display name"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:tp.ACTION_DISABLED}}),".m.rule.contains_user_name":new ip({kind:"override",description:Object(c.b)("Messages containing my username"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:tp.ACTION_DISABLED}}),".m.rule.roomnotif":new ip({kind:"override",description:Object(c.b)("Messages containing @room"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_HIGHLIGHT,off:tp.ACTION_DISABLED}}),".m.rule.room_one_to_one":new ip({kind:"underride",description:Object(c.b)("Messages in one-to-one chats"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DONT_NOTIFY}}),".m.rule.encrypted_room_one_to_one":new ip({kind:"underride",description:Object(c.b)("Encrypted messages in one-to-one chats"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DONT_NOTIFY}}),".m.rule.message":new ip({kind:"underride",description:Object(c.b)("Messages in group chats"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DONT_NOTIFY}}),".m.rule.encrypted":new ip({kind:"underride",description:Object(c.b)("Encrypted messages in group chats"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new ip({kind:"underride",description:Object(c.b)("When I'm invited to a room"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DISABLED}}),".m.rule.call":new ip({kind:"underride",description:Object(c.b)("Call invitation"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_NOTIFY_RING_SOUND,off:tp.ACTION_DISABLED}}),".m.rule.suppress_notices":new ip({kind:"override",description:Object(c.b)("Messages sent by bot"),vectorStateToActions:{on:tp.ACTION_DISABLED,loud:tp.ACTION_NOTIFY_DEFAULT_SOUND,off:tp.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new ip({kind:"override",description:Object(c.b)("When rooms are upgraded"),vectorStateToActions:{on:tp.ACTION_NOTIFY,loud:tp.ACTION_HIGHLIGHT,off:tp.ACTION_DISABLED}})};const rp={"im.vector.rule.contains_display_name":".m.rule.contains_display_name","im.vector.rule.room_one_to_one":".m.rule.room_one_to_one","im.vector.rule.room_message":".m.rule.message","im.vector.rule.invite_for_me":".m.rule.invite_for_me","im.vector.rule.call":".m.rule.call","im.vector.rule.notices":".m.rule.suppress_notices"};function ap(e){const t=Zm.decodeActions(e);return null!==t?Zm.encodeActions(t):e}class cp extends o.a.Component{constructor(...e){super(...e),g()(this,"state",{phase:cp.phases.LOADING,masterPushRule:void 0,vectorPushRules:[],vectorContentRules:{vectorState:np.ON,rules:[]},externalPushRules:[],externalContentRules:[],threepids:[]}),g()(this,"onEnableNotificationsChange",e=>{const t=this;this.setState({phase:cp.phases.LOADING}),L.a.get().setPushRuleEnabled("global",t.state.masterPushRule.kind,t.state.masterPushRule.rule_id,!e).then((function(){t._refreshFromServer()}))}),g()(this,"onEnableDesktopNotificationsChange",e=>{w.a.setValue("notificationsEnabled",null,je.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),g()(this,"onEnableDesktopNotificationBodyChange",e=>{w.a.setValue("notificationBodyEnabled",null,je.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),g()(this,"onEnableAudioNotificationsChange",e=>{w.a.setValue("audioNotificationsEnabled",null,je.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),g()(this,"onEnableEmailNotificationsChange",(e,t)=>{let s;if(t){const t={};t.brand=l.a.get().brand,s=L.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:t,append:!0})}else{const t=this.getEmailPusher(this.state.pushers,e);t.kind=null,s=L.a.get().setPusher(t)}s.then(()=>{this._refreshFromServer()},e=>{const t=d.getComponent("dialogs.ErrorDialog");ke.a.createTrackedDialog("Error saving email notification preferences","",t,{title:Object(c.a)("Error saving email notification preferences"),description:Object(c.a)("An error occurred whilst saving your email notification preferences.")})})}),g()(this,"onNotifStateButtonClicked",e=>{const t=e.target.className.split("-")[0],s=e.target.className.split("-")[1];if("_keywords"===t)this._setKeywordsPushRuleVectorState(s);else{const e=this.getRule(t);e&&this._setPushRuleVectorState(e,s)}}),g()(this,"onKeywordsClicked",e=>{let t=[];for(const e in this.state.vectorContentRules.rules){const s=this.state.vectorContentRules.rules[e];t.push(s.pattern)}t.length?(t.sort(),t=t.join(", ")):t="";const s=d.getComponent("dialogs.TextInputDialog");ke.a.createTrackedDialog("Keywords Dialog","",s,{title:Object(c.a)("Keywords"),description:Object(c.a)("Enter keywords separated by a comma:"),button:Object(c.a)("OK"),value:t,onFinished:(e,s)=>{if(e&&s!==t){let e=s.split(",");for(const t in e)e[t]=e[t].trim();e=e.reduce((function(e,t){return""!==t&&e.indexOf(t)<0&&e.push(t),e}),[]),this._setKeywords(e)}}})}),g()(this,"_refreshFromServer",()=>{const e=this,t=L.a.get().getPushRules().then(e._portRulesToNewAPI).then((function(t){L.a.get().pushRules=t;const s={".m.rule.master":"master",".m.rule.contains_display_name":"vector",".m.rule.contains_user_name":"vector",".m.rule.roomnotif":"vector",".m.rule.room_one_to_one":"vector",".m.rule.encrypted_room_one_to_one":"vector",".m.rule.message":"vector",".m.rule.encrypted":"vector",".m.rule.invite_for_me":"vector",".m.rule.call":"vector",".m.rule.suppress_notices":"vector",".m.rule.tombstone":"vector"},n={master:[],vector:{},others:[]};for(const e in t.global)for(let i=0;i<Object.keys(t.global[e]).length;++i){const o=t.global[e][i],r=s[o.rule_id];o.kind=e,"."===o.rule_id[0]&&("vector"===r?n.vector[o.rule_id]=o:"master"===r?n.master.push(o):n.others.push(o))}n.master.length>0&&(e.state.masterPushRule=n.master[0]);const i=class{static parseContentRules(e){const t=this._categoriseContentRules(e);return t.loud.length?{vectorState:sp.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:sp.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:sp.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:sp.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:sp.On,rules:[],externalRules:t.other}}static _categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const s in e.global)for(let n=0;n<Object.keys(e.global[s]).length;++n){const i=e.global[s][n];if("."!==i.rule_id[0]&&"content"===s)switch(i.kind=s,np.contentRuleVectorStateKind(i)){case sp.On:i.enabled?t.on.push(i):t.on_but_disabled.push(i);break;case sp.Loud:i.enabled?t.loud.push(i):t.loud_but_disabled.push(i);break;default:t.other.push(i)}}return t}}.parseContentRules(t);e.state.vectorContentRules={vectorState:i.vectorState,rules:i.rules},e.state.externalContentRules=i.externalRules,e.state.vectorPushRules=[],e.state.externalPushRules=[];const r=[".m.rule.contains_display_name",".m.rule.contains_user_name",".m.rule.roomnotif","_keywords",".m.rule.room_one_to_one",".m.rule.encrypted_room_one_to_one",".m.rule.message",".m.rule.encrypted",".m.rule.invite_for_me",".m.rule.call",".m.rule.suppress_notices",".m.rule.tombstone"];for(const t in r){const s=r[t];if("_keywords"===s)e.state.vectorPushRules.push({vectorRuleId:"_keywords",description:o.a.createElement("span",null,Object(c.a)("Messages containing <span>keywords</span>",{},{span:t=>o.a.createElement("span",{className:"mx_UserNotifSettings_keywords",onClick:e.onKeywordsClicked},t)})),vectorState:e.state.vectorContentRules.vectorState});else{const t=op[s],i=n.vector[s],o=t.ruleToVectorState(i);e.state.vectorPushRules.push({vectorRuleId:s,description:Object(c.a)(t.description),rule:i,vectorState:o}),i&&!o&&(i.description=t.description,e.state.externalPushRules.push(i))}}const a={".m.rule.message":Object(c.a)("Notify for all other messages/rooms"),".m.rule.fallback":Object(c.a)("Notify me for anything else")};for(const t in n.others){const s=n.others[t],i=a[s.rule_id];i&&s.enabled&&!s.default&&(s.description=i,e.state.externalPushRules.push(s))}})),s=L.a.get().getPushers().then((function(t){e.setState({pushers:t.pushers})}));Promise.all([t,s]).then((function(){e.setState({phase:cp.phases.DISPLAY})}),(function(t){console.error(t),e.setState({phase:cp.phases.ERROR})})).finally(()=>{e.setState({masterPushRule:e.state.masterPushRule,vectorContentRules:e.state.vectorContentRules,vectorPushRules:e.state.vectorPushRules,externalContentRules:e.state.externalContentRules,externalPushRules:e.state.externalPushRules})}),L.a.get().getThreePids().then(e=>this.setState({threepids:e.threepids}))}),g()(this,"_onClearNotifications",()=>{const e=L.a.get();e.getRooms().forEach(t=>{if(t.getUnreadNotificationCount()>0){const s=t.getLiveTimeline().getEvents();s.length&&e.sendReadReceipt(s.pop())}})})}componentDidMount(){this._refreshFromServer()}getEmailPusher(e,t){if(void 0!==e)for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return e[s]}getRule(e){for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];if(s.vectorRuleId===e)return s}}_setPushRuleVectorState(e,t){if(e&&e.vectorState!==t){this.setState({phase:cp.phases.LOADING});const s=this,n=L.a.get(),i=[],o=op[e.vectorRuleId];if(e.rule){const s=o.vectorStateToActions[t];s?i.push(this._updatePushRuleActions(e.rule,s,!0)):i.push(n.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!1))}Promise.all(i).then((function(){s._refreshFromServer()}),(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change settings: "+e),ke.a.createTrackedDialog("Failed to change settings","",t,{title:Object(c.a)("Failed to change settings"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:s._refreshFromServer})}))}}_setKeywordsPushRuleVectorState(e){if(this.state.vectorContentRules.vectorState===e||0===this.state.vectorContentRules.rules.length)return;const t=this,s=L.a.get();this.setState({phase:cp.phases.LOADING});const n=[];for(const t in this.state.vectorContentRules.rules){const i=this.state.vectorContentRules.rules[t];let o,r;switch(e){case np.ON:1!==i.actions.length&&(r=np.actionsFor(np.ON)),this.state.vectorContentRules.vectorState===np.OFF&&(o=!0);break;case np.LOUD:3!==i.actions.length&&(r=np.actionsFor(np.LOUD)),this.state.vectorContentRules.vectorState===np.OFF&&(o=!0);break;case np.OFF:o=!1}r?n.push(this._updatePushRuleActions(i,r,o)):null!=o&&n.push(s.setPushRuleEnabled("global",i.kind,i.rule_id,o))}Promise.all(n).then((function(e){t._refreshFromServer()}),(function(e){const s=d.getComponent("dialogs.ErrorDialog");console.error("Can't update user notification settings: "+e),ke.a.createTrackedDialog("Can't update user notifcation settings","",s,{title:Object(c.a)("Can't update user notification settings"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:t._refreshFromServer})}))}_setKeywords(e){this.setState({phase:cp.phases.LOADING});const t=this,s=L.a.get(),n=[],i=[];for(const o in t.state.vectorContentRules.rules){const r=t.state.vectorContentRules.rules[o];i.push(r.pattern),e.indexOf(r.pattern)<0&&n.push(s.deletePushRule("global",r.kind,r.rule_id))}for(const i in t.state.externalContentRules){const o=t.state.externalContentRules[i];e.indexOf(o.pattern)>=0&&n.push(s.deletePushRule("global",o.kind,o.rule_id))}const o=function(e){const s=d.getComponent("dialogs.ErrorDialog");console.error("Failed to update keywords: "+e),ke.a.createTrackedDialog("Failed to update keywords","",s,{title:Object(c.a)("Failed to update keywords"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:t._refreshFromServer})};Promise.all(n).then((function(n){const r=[];let a=t.state.vectorContentRules.vectorState;a===np.OFF&&(a=t.state.vectorContentRules.rules.length?np.contentRuleVectorStateKind(t.state.vectorContentRules.rules[0]):np.ON);for(const n in e){const o=e[n];i.indexOf(o)<0&&(t.state.vectorContentRules.vectorState!==np.OFF?r.push(s.addPushRule("global","content",o,{actions:np.actionsFor(a),pattern:o})):r.push(t._addDisabledPushRule("global","content",o,{actions:np.actionsFor(a),pattern:o})))}Promise.all(r).then((function(e){t._refreshFromServer()}),o)}),o)}_addDisabledPushRule(e,t,s,n){const i=L.a.get();return i.addPushRule(e,t,s,n).then(()=>i.setPushRuleEnabled(e,t,s,!1))}_portRulesToNewAPI(e){const t=[],s=L.a.get();for(const n in e.global){const i=e.global[n];for(let e=0;e<i.length;++e){const o=i[e];o.rule_id in rp&&(console.log("Porting legacy rule",o),t.push(function(e,t){return s.setPushRuleActions("global",e,rp[t.rule_id],ap(t.actions)).then(()=>s.deletePushRule("global",e,t.rule_id)).catch(e=>{console.warn("Error when porting legacy rule: "+e)})}(n,o)))}}return t.length>0?Promise.all(t).then(()=>s.getPushRules()):e}_updatePushRuleActions(e,t,s){const n=L.a.get();return n.setPushRuleActions("global",e.kind,e.rule_id,t).then((function(){if(null!=s)return n.setPushRuleEnabled("global",e.kind,e.rule_id,s)}))}renderNotifRulesTableRow(e,t,s){return o.a.createElement("tr",{key:t},o.a.createElement("th",null,e),o.a.createElement("th",null,o.a.createElement("input",{className:t+"-"+np.OFF,type:"radio",checked:s===np.OFF,onChange:this.onNotifStateButtonClicked})),o.a.createElement("th",null,o.a.createElement("input",{className:t+"-"+np.ON,type:"radio",checked:s===np.ON,onChange:this.onNotifStateButtonClicked})),o.a.createElement("th",null,o.a.createElement("input",{className:t+"-"+np.LOUD,type:"radio",checked:s===np.LOUD,onChange:this.onNotifStateButtonClicked})))}renderNotifRulesTableRows(){const e=[];for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];void 0===s.rule&&s.vectorRuleId.startsWith(".m.")?console.warn(`Skipping render of rule ${s.vectorRuleId} due to no underlying rule`):e.push(this.renderNotifRulesTableRow(s.description,s.vectorRuleId,s.vectorState))}return e}hasEmailPusher(e,t){if(void 0===e)return!1;for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return!0;return!1}emailNotificationsRow(e,t){return o.a.createElement(De.a,{value:this.hasEmailPusher(this.state.pushers,e),onChange:this.onEnableEmailNotificationsChange.bind(this,e),label:t,key:"emailNotif_"+t})}render(){let e,t,s;if(this.state.phase===cp.phases.LOADING){const t=d.getComponent("elements.Spinner");e=o.a.createElement(t,null)}if(this.state.masterPushRule&&(t=o.a.createElement(De.a,{value:!this.state.masterPushRule.enabled,onChange:this.onEnableNotificationsChange,label:Object(c.a)("Enable notifications for this account")})),L.a.get().getRooms().some(e=>e.getUnreadNotificationCount()>0)&&(s=o.a.createElement(Z.a,{onClick:this._onClearNotifications,kind:"danger"},Object(c.a)("Clear notifications"))),this.state.masterPushRule&&this.state.masterPushRule.enabled)return o.a.createElement("div",null,t,o.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},Object(c.a)("All notifications are currently disabled for all targets.")),s);const n=this.state.threepids.filter(e=>"email"===e.medium);let i;i=0===n.length?o.a.createElement("div",null,Object(c.a)("Add an email address to configure email notifications")):n.map(e=>this.emailNotificationsRow(e.address,`${Object(c.a)("Enable email notifications")} (${e.address})`));const r=[];for(const e in this.state.externalPushRules){const t=this.state.externalPushRules[e];r.push(o.a.createElement("li",null,Object(c.a)(t.description)))}let a,u,h=[];for(const e in this.state.externalContentRules){const t=this.state.externalContentRules[e];h.push(t.pattern)}if(h.length&&(h=h.join(", "),r.push(o.a.createElement("li",null,Object(c.a)("Notifications on the following keywords follow rules which can’t be displayed here:")," ",h))),void 0===this.state.pushers)a=o.a.createElement("div",{className:"error"},Object(c.a)("Unable to fetch notification target list"));else if(0===this.state.pushers.length)a=null;else{const e=[];for(let t=0;t<this.state.pushers.length;++t)e.push(o.a.createElement("tr",{key:t},o.a.createElement("td",null,this.state.pushers[t].app_display_name),o.a.createElement("td",null,this.state.pushers[t].device_display_name)));a=o.a.createElement("table",{className:"mx_UserNotifSettings_devicesTable"},o.a.createElement("tbody",null,e))}if(a&&(a=o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Notification targets")),a)),r.length){const e=l.a.get().brand;u=o.a.createElement("div",null,o.a.createElement("h3",null,Object(c.a)("Advanced notification settings")),Object(c.a)("There are advanced notifications which are not shown here."),o.a.createElement("br",null),Object(c.a)("You might have configured them in a client other than %(brand)s. You cannot tune them in %(brand)s but they still apply.",{brand:e}),o.a.createElement("ul",null,r))}return o.a.createElement("div",null,t,o.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},e,o.a.createElement(De.a,{value:w.a.getValue("notificationsEnabled"),onChange:this.onEnableDesktopNotificationsChange,label:Object(c.a)("Enable desktop notifications for this session")}),o.a.createElement(De.a,{value:w.a.getValue("notificationBodyEnabled"),onChange:this.onEnableDesktopNotificationBodyChange,label:Object(c.a)("Show message in desktop notification")}),o.a.createElement(De.a,{value:w.a.getValue("audioNotificationsEnabled"),onChange:this.onEnableAudioNotificationsChange,label:Object(c.a)("Enable audible notifications for this session")}),i,o.a.createElement("div",{className:"mx_UserNotifSettings_pushRulesTableWrapper"},o.a.createElement("table",{className:"mx_UserNotifSettings_pushRulesTable"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",{width:"55%"}),o.a.createElement("th",{width:"15%"},Object(c.a)("Off")),o.a.createElement("th",{width:"15%"},Object(c.a)("On")),o.a.createElement("th",{width:"15%"},Object(c.a)("Noisy")))),o.a.createElement("tbody",null,this.renderNotifRulesTableRows()))),u,a,s))}}g()(cp,"phases",{LOADING:"LOADING",DISPLAY:"DISPLAY",ERROR:"ERROR"});class lp extends o.a.Component{constructor(){super(),g()(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:L.a.get().getIdentityServerUrl()})}),g()(this,"_onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t})}),g()(this,"_getTooltip",()=>{if(this.state.checking){const e=d.getComponent("views.elements.InlineSpinner");return o.a.createElement("div",null,o.a.createElement(e,null),Object(c.a)("Checking server"))}return this.state.error?o.a.createElement("span",{className:"warning"},this.state.error):null}),g()(this,"_idServerChangeEnabled",()=>!!this.state.idServer&&!this.state.busy),g()(this,"_saveIdServer",e=>{L.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:null,currentClientIdServer:e,idServer:""})}),g()(this,"_checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:s}=this.state;this.setState({busy:!0,checking:!0,error:null});const n=Object(Te.b)(t);let i=await async function(e){if("https:"!==he.a.parse(e).protocol)return Object(c.a)("Identity Server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/api/v1");return t.ok?null:t.status<200||t.status>=300?Object(c.a)("Not a valid Identity Server (status code %(code)s)",{code:t.status}):Object(c.a)("Could not connect to Identity Server")}catch(e){return Object(c.a)("Could not connect to Identity Server")}}(n);if(!i)try{this.setState({checking:!1});const e=new Oe.a(n);await e.getAccessToken();let i=!0;if(!await Object(Hn.b)(n)){const[e]=await this._showNoTermsWarning(n);i=e}if(i&&s&&n!==s){const[e]=await this._showServerChangeWarning({title:Object(c.a)("Change identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>o.a.createElement("b",null,Object(Te.a)(s)),new:e=>o.a.createElement("b",null,Object(Te.a)(t))}),button:Object(c.a)("Continue")});i=e}i&&this._saveIdServer(n)}catch(e){console.error(e),i=Object(c.a)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:i,currentClientIdServer:L.a.get().getIdentityServerUrl()})}),g()(this,"_onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this._showServerChangeWarning({title:Object(c.a)("Disconnect identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <idserver />?",{},{idserver:e=>o.a.createElement("b",null,Object(Te.a)(this.state.currentClientIdServer))}),button:Object(c.a)("Disconnect")});e&&this._disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),g()(this,"_disconnectIdServer",()=>{L.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(Hn.c)()&&(e=Object(Te.a)(Object(Hn.c)())),this.setState({busy:!1,error:null,currentClientIdServer:L.a.get().getIdentityServerUrl(),idServer:e})});let e="";!L.a.get().getIdentityServerUrl()&&Object(Hn.c)()&&(e=Object(Te.a)(Object(Hn.c)())),this.state={defaultIdServer:e,currentClientIdServer:L.a.get().getIdentityServerUrl(),idServer:"",error:null,busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}_showNoTermsWarning(e){const t=d.getComponent("views.dialogs.QuestionDialog"),{finished:s}=ke.a.createTrackedDialog("No Terms Warning","",t,{title:Object(c.a)("Identity server has no terms of service"),description:o.a.createElement("div",null,o.a.createElement("span",{className:"warning"},Object(c.a)("The identity server you have chosen does not have any terms of service.")),o.a.createElement("span",null," ",Object(c.a)("Only continue if you trust the owner of the server."))),button:Object(c.a)("Continue")});return s}async _showServerChangeWarning({title:e,unboundMessage:t,button:s}){const{currentClientIdServer:n}=this.state;let i=[],r=!0;try{i=await Object(Ze.d)(xe(L.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){r=!1,console.warn(`Unable to reach identity server at ${n} to check for 3PIDs during IS change flow`),console.warn(e)}const a=i.filter(e=>e.bound);let l,u=!1;const h={idserver:e=>o.a.createElement("b",null,Object(Te.a)(n)),b:e=>o.a.createElement("b",null,e)};r?a.length?(l=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},h)),o.a.createElement("p",null,Object(c.a)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),u=!0,s=Object(c.a)("Disconnect anyway")):l=t:(l=o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},h)),o.a.createElement("p",null,Object(c.a)("You should:")),o.a.createElement("ul",null,o.a.createElement("li",null,Object(c.a)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),o.a.createElement("li",null,Object(c.a)("contact the administrators of identity server <idserver />",{},{idserver:h.idserver})),o.a.createElement("li",null,Object(c.a)("wait and try again later")))),u=!0,s=Object(c.a)("Disconnect anyway"));const m=d.getComponent("dialogs.QuestionDialog"),{finished:p}=ke.a.createTrackedDialog("Identity Server Bound Warning","",m,{title:e,description:l,button:s,cancelButton:Object(c.a)("Go back"),danger:u});return p}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=d.getComponent("elements.Field"),s=this.state.currentClientIdServer;let n,i,r;if(s?(n=Object(c.a)("Identity Server (%(server)s)",{server:Object(Te.a)(s)}),i=Object(c.a)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:e=>o.a.createElement("b",null,Object(Te.a)(s))}),this.props.missingTerms&&(i=Object(c.a)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:e=>o.a.createElement("b",null,Object(Te.a)(s))}))):(n=Object(c.a)("Identity Server"),i=Object(c.a)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),s){let t=Object(c.a)("Disconnect"),s=Object(c.a)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");if(this.props.missingTerms&&(s=Object(c.a)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),t=Object(c.a)("Do not use an identity server")),this.state.disconnectBusy){const e=d.getComponent("views.elements.InlineSpinner");t=o.a.createElement(e,null)}r=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},s),o.a.createElement(e,{onClick:this._onDisconnectClicked,kind:"danger_sm"},t))}return o.a.createElement("form",{className:"mx_SettingsTab_section mx_SetIdServer",onSubmit:this._checkIdServer},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},n),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},i),o.a.createElement(t,{label:Object(c.a)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this._onIdentityServerChanged,tooltipContent:this._getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&null}),o.a.createElement(e,{type:"submit",kind:"primary_sm",onClick:this._checkIdServer,disabled:!this._idServerChangeEnabled()},Object(c.a)("Change")),r)}}g()(lp,"propTypes",{missingTerms:re.a.bool});class dp extends o.a.Component{constructor(){super(),g()(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;w.a.setValue("integrationProvisioning",null,je.a.ACCOUNT,!e).catch(t=>{console.error("Error changing integration manager provisioning"),console.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const e=sm.a.sharedInstance().getPrimaryManager();this.state={currentManager:e,provisioningEnabled:w.a.getValue("integrationProvisioning")}}render(){const e=d.getComponent("views.elements.ToggleSwitch"),t=this.state.currentManager;let s,n;return t?(s=`(${t.name})`,n=Object(c.a)("Use an Integration Manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:t.name},{b:e=>o.a.createElement("b",null,e)})):n=Object(c.a)("Use an Integration Manager to manage bots, widgets, and sticker packs."),o.a.createElement("div",{className:"mx_SetIntegrationManager"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},o.a.createElement("span",null,Object(c.a)("Manage integrations")),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},s),o.a.createElement(e,{checked:this.state.provisioningEnabled,onChange:this.onProvisioningToggled})),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},n,o.a.createElement("br",null),o.a.createElement("br",null),Object(c.a)("Integration Managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}}class up extends o.a.Component{constructor(){super(),g()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),g()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),g()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),L.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then(()=>this.props.onRemoved(this.props.email)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),ke.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(c.a)("Remove %(email)s?",{email:this.props.email.address})),o.a.createElement(Z.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Remove")),o.a.createElement(Z.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),o.a.createElement(Z.a,{onClick:this._onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}g()(up,"propTypes",{email:re.a.object.isRequired,onRemoved:re.a.func.isRequired});class hp extends o.a.Component{constructor(e){super(e),g()(this,"_onRemoved",e=>{const t=this.props.emails.filter(t=>t!==e);this.props.onEmailsChange(t)}),g()(this,"_onChangeNewEmailAddress",e=>{this.setState({newEmailAddress:e.target.value})}),g()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newEmailAddress;if(!Ga.a(s))return void ke.a.createTrackedDialog("Invalid email address","",t,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")});const n=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addEmailAddress(s).then(()=>{this.setState({continueDisabled:!1})}).catch(e=>{console.error("Unable to add email address "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog("Unable to add email address","",t,{title:Object(c.a)("Unable to add email address"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),g()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),this.state.addTask.checkEmailLinkClicked().then(()=>{const e=this.state.newEmailAddress;this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:""});const t=[...this.props.emails,{address:e,medium:"email"}];this.props.onEmailsChange(t)}).catch(e=>{this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?ke.a.createTrackedDialog("Email hasn't been verified yet","",t,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: ",e),ke.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))})}),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map(e=>o.a.createElement(up,{email:e,onRemoved:this._onRemoved,key:e.address}));let t=o.a.createElement(Z.a,{onClick:this._onAddClick,kind:"primary"},Object(c.a)("Add"));return this.state.verifying&&(t=o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),o.a.createElement(Z.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue")))),o.a.createElement("div",{className:"mx_EmailAddresses"},e,o.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},o.a.createElement(le.a,{type:"text",label:Object(c.a)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this._onChangeNewEmailAddress}),t))}}g()(hp,"propTypes",{emails:re.a.array.isRequired,onEmailsChange:re.a.func.isRequired});class mp extends o.a.Component{constructor(){super(),g()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),g()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),g()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),L.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then(()=>this.props.onRemoved(this.props.msisdn)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),ke.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(c.a)("Remove %(phone)s?",{phone:this.props.msisdn.address})),o.a.createElement(Z.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Remove")),o.a.createElement(Z.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),o.a.createElement(Z.a,{onClick:this._onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}g()(mp,"propTypes",{msisdn:re.a.object.isRequired,onRemoved:re.a.func.isRequired});class pp extends o.a.Component{constructor(e){super(e),g()(this,"_onRemoved",e=>{const t=this.props.msisdns.filter(t=>t!==e);this.props.onMsisdnsChange(t)}),g()(this,"_onChangeNewPhoneNumber",e=>{this.setState({newPhoneNumber:e.target.value})}),g()(this,"_onChangeNewPhoneNumberCode",e=>{this.setState({newPhoneNumberCode:e.target.value})}),g()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newPhoneNumber,n=this.state.phoneCountry,i=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:i}),i.addMsisdn(n,s).then(e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})}).catch(e=>{console.error("Unable to add phone number "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog("Add Phone Number Error","",t,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),g()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.newPhoneNumberCode,s=this.state.verifyMsisdn;this.state.addTask.haveMsisdnToken(t).then(()=>{this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:"",newPhoneNumberCode:""});const e=[...this.props.msisdns,{address:s,medium:"msisdn"}];this.props.onMsisdnsChange(e)}).catch(e=>{if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),ke.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}else this.setState({verifyError:Object(c.a)("Incorrect verification code")})})}),g()(this,"_onCountryChanged",e=>{this.setState({phoneCountry:e.iso2})}),this.state={verifying:!1,verifyError:!1,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map(e=>o.a.createElement(mp,{msisdn:e,onRemoved:this._onRemoved,key:e.address}));let t=o.a.createElement(Z.a,{onClick:this._onAddClick,kind:"primary"},Object(c.a)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=o.a.createElement("div",null,o.a.createElement("div",null,Object(c.a)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this._onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(le.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this._onChangeNewPhoneNumberCode}),o.a.createElement(Z.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue"))))}const s=o.a.createElement(Ua,{onOptionChange:this._onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return o.a.createElement("div",{className:"mx_PhoneNumbers"},e,o.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},o.a.createElement("div",{className:"mx_PhoneNumbers_input"},o.a.createElement(le.a,{type:"text",label:Object(c.a)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:s,value:this.state.newPhoneNumber,onChange:this._onChangeNewPhoneNumber}))),t)}}g()(pp,"propTypes",{msisdns:re.a.array.isRequired,onMsisdnsChange:re.a.func.isRequired});class gp extends o.a.Component{constructor(e){super(e),g()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for email address")})}),g()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share email address")})}),g()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{await this.state.addTask.checkEmailLinkClicked(),this.setState({addTask:null,continueDisabled:!1,verifying:!1})}catch(e){this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?ke.a.createTrackedDialog("E-mail hasn't been verified yet","",t,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: "+e),ke.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))}});const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.email;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await L.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.email;try{if(e){const e=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(o),this.setState({continueDisabled:!1})}else await L.a.get().unbindThreePid(i,o);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} email address ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.email,r=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:r});try{await L.a.get().deleteThreePid(i,o),e?await r.bindEmailAddress(o):await r.addEmailAddress(o),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} email address ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),{address:t}=this.props.email,{verifying:s,bound:n}=this.state;let i;return i=s?o.a.createElement("span",null,Object(c.a)("Verify the link in your inbox"),o.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick},Object(c.a)("Complete"))):n?o.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):o.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},t),i)}}g()(gp,"propTypes",{email:re.a.object.isRequired});class fp extends o.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map(e=>o.a.createElement(gp,{email:e,key:e.address})):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added an email above.")),o.a.createElement("div",{className:"mx_EmailAddresses"},e)}}g()(fp,"propTypes",{emails:re.a.array.isRequired});class _p extends o.a.Component{constructor(e){super(e),g()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for phone number")})}),g()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share phone number")})}),g()(this,"onVerificationCodeChange",e=>{this.setState({verificationCode:e.target.value})}),g()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{await this.state.addTask.haveMsisdnToken(t),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),ke.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}else this.setState({verifyError:Object(c.a)("Incorrect verification code")})}});const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.msisdn;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await L.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.msisdn;try{if(e){const e=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,"+"+o),this.setState({continueDisabled:!1})}else await L.a.get().unbindThreePid(i,o);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} phone number ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.msisdn,r=new fl;this.setState({verifying:!0,continueDisabled:!0,addTask:r});try{await L.a.get().deleteThreePid(i,o),e?await r.bindMsisdn(null,"+"+o):await r.addMsisdn(null,"+"+o),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} phone number ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),ke.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.Field"),{address:s}=this.props.msisdn,{verifying:n,bound:i}=this.state;let r;return r=n?o.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},o.a.createElement("span",null,Object(c.a)("Please enter verification code sent via text."),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(t,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):i?o.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):o.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",s),r)}}g()(_p,"propTypes",{msisdn:re.a.object.isRequired});class vp extends o.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map(e=>o.a.createElement(_p,{msisdn:e,key:e.address})):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added a phone number above.")),o.a.createElement("div",{className:"mx_PhoneNumbers"},e)}}g()(vp,"propTypes",{msisdns:re.a.array.isRequired});class yp extends o.a.Component{constructor(){super(),g()(this,"_togglePolicy",e=>{const t=Object(X.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),g()(this,"_onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const s=Object.values(t.policies);for(const t of s){const s=Object(c.j)(Object.keys(t).filter(e=>"version"!==e)),n={checked:!1,url:t[s].url,name:t[s].name};e.push(n)}}this.setState({policies:e})}_renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const s=this.state.policies[t],n=Object(c.a)("Accept <policyLink /> to continue:",{},{policyLink:()=>o.a.createElement("a",{href:s.url,rel:"noreferrer noopener",target:"_blank"},s.name,o.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(o.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},o.a.createElement("div",null,n),o.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},o.a.createElement(we.a,{onChange:()=>this._togglePolicy(t),checked:s.checked},Object(c.a)("Accept")))))}return e}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=!!this.state.policies.some(e=>!e.checked);return o.a.createElement("div",null,this.props.introElement,this._renderCheckboxes(),o.a.createElement(e,{onClick:this._onContinue,disabled:t||this.state.busy,kind:"primary_sm"},Object(c.a)("Continue")))}}g()(yp,"propTypes",{policiesAndServicePairs:re.a.array.isRequired,agreedUrls:re.a.array.isRequired,onFinished:re.a.func.isRequired,introElement:re.a.node});class bp extends o.a.Component{render(){const e=d.getComponent("views.elements.DialogButtons");return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("The other party cancelled the verification.")),o.a.createElement(e,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}g()(bp,"propTypes",{onDone:re.a.func.isRequired});class Ep extends o.a.Component{render(){const e=d.getComponent("views.elements.DialogButtons");return o.a.createElement("div",null,o.a.createElement("h2",null,Object(c.a)("Verified!")),o.a.createElement("p",null,Object(c.a)("You've successfully verified this user.")),o.a.createElement("p",null,Object(c.a)("Secure messages with this user are end-to-end encrypted and not able to be read by third parties.")),o.a.createElement(e,{onPrimaryButtonClick:this.props.onDone,primaryButton:Object(c.a)("Got It"),hasCancel:!1}))}}var Sp,wp,Cp;g()(Ep,"propTypes",{onDone:re.a.func.isRequired});let Rp=Object(bn.a)("views.verification.VerificationQREmojiOptions")((Cp=wp=class extends o.a.Component{render(){const{request:e}=this.props;let t;return t=e.otherPartySupportsMethod(yn.c)?o.a.createElement(En,{qrCodeData:e.qrCodeData}):o.a.createElement("div",{className:"mx_VerificationQREmojiOptions_noQR"},o.a.createElement(Ne.a,null)),o.a.createElement("div",null,Object(c.a)("Verify this session by completing one of the following:"),o.a.createElement("div",{className:"mx_IncomingSasDialog_startOptions"},o.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},o.a.createElement("p",null,Object(c.a)("Scan this unique code")),t),o.a.createElement("div",{className:"mx_IncomingSasDialog_betweenText"},Object(c.a)("or")),o.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},o.a.createElement("p",null,Object(c.a)("Compare unique emoji")),o.a.createElement("span",{className:"mx_IncomingSasDialog_helpText"},Object(c.a)("Compare a unique set of emoji if you don't have a camera on either device")),o.a.createElement(Z.a,{onClick:this.props.onStartEmoji,kind:"primary"},Object(c.a)("Start")))),o.a.createElement(Z.a,{onClick:this.props.onCancel,kind:"danger"},Object(c.a)("Cancel")))}},g()(wp,"propTypes",{request:re.a.object.isRequired,onCancel:re.a.func.isRequired,onStartEmoji:re.a.func.isRequired}),Sp=Cp))||Sp;class kp extends o.a.Component{constructor(e){super(e),g()(this,"onMatchClick",()=>{this.setState({pending:!0}),this.props.onDone()}),g()(this,"onDontMatchClick",()=>{this.setState({cancelling:!0}),this.props.onCancel()}),this.state={pending:!1}}componentWillMount(){as()}render(){let e,t,s;if(this.props.sas.emoji){const s=this.props.sas.emoji.map((e,t)=>{return o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(c.a)((s=e[1]).charAt(0).toUpperCase()+s.slice(1))));var s});e=o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},s.slice(0,4),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),s.slice(4)),t=this.props.isSelf?Object(c.a)("Confirm the emoji below are displayed on both sessions, in the same order:"):Object(c.a)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return o.a.createElement("div",null,Object(c.a)("Unable to find a supported verification method."),o.a.createElement(Z.a,{kind:"primary",onClick:this.props.onCancel,className:"mx_UserInfo_wideButton"},Object(c.a)("Cancel")));{const s=this.props.sas.decimal.map((e,t)=>o.a.createElement("span",{key:t},e));e=o.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},s),t=this.props.isSelf?Object(c.a)("Verify this session by confirming the following number appears on its screen."):Object(c.a)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending||this.state.cancelling){let e;if(this.state.pending)if(this.props.isSelf)e=this.props.device?Object(c.a)("Waiting for your other session, %(deviceName)s (%(deviceId)s), to verify…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(c.a)("Waiting for your other session to verify…");else{const{displayName:t}=this.props;e=Object(c.a)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(c.a)("Cancelling…");s=o.a.createElement(mn,{text:e})}else s=this.props.inDialog?o.a.createElement(Vl.a,{primaryButton:Object(c.a)("They match"),onPrimaryButtonClick:this.onMatchClick,primaryButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_matchButton",cancelButton:Object(c.a)("They don't match"),onCancel:this.onDontMatchClick,cancelButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_noMatchButton"}):o.a.createElement(o.a.Fragment,null,o.a.createElement(Z.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(c.a)("They don't match")),o.a.createElement(Z.a,{onClick:this.onMatchClick,kind:"primary"},Object(c.a)("They match")));return o.a.createElement("div",{className:"mx_VerificationShowSas"},o.a.createElement("p",null,t),e,o.a.createElement("p",null,this.props.isSelf?"":Object(c.a)("To be secure, do this in person or use a trusted way to communicate.")),s)}}g()(kp,"propTypes",{pending:re.a.bool,displayName:re.a.string,device:re.a.object,onDone:re.a.func.isRequired,onCancel:re.a.func.isRequired,sas:re.a.object.isRequired,isSelf:re.a.bool,inDialog:re.a.bool}),Object(c.b)("Dog"),Object(c.b)("Cat"),Object(c.b)("Lion"),Object(c.b)("Horse"),Object(c.b)("Unicorn"),Object(c.b)("Pig"),Object(c.b)("Elephant"),Object(c.b)("Rabbit"),Object(c.b)("Panda"),Object(c.b)("Rooster"),Object(c.b)("Penguin"),Object(c.b)("Turtle"),Object(c.b)("Fish"),Object(c.b)("Octopus"),Object(c.b)("Butterfly"),Object(c.b)("Flower"),Object(c.b)("Tree"),Object(c.b)("Cactus"),Object(c.b)("Mushroom"),Object(c.b)("Globe"),Object(c.b)("Moon"),Object(c.b)("Cloud"),Object(c.b)("Fire"),Object(c.b)("Banana"),Object(c.b)("Apple"),Object(c.b)("Strawberry"),Object(c.b)("Corn"),Object(c.b)("Pizza"),Object(c.b)("Cake"),Object(c.b)("Heart"),Object(c.b)("Smiley"),Object(c.b)("Robot"),Object(c.b)("Hat"),Object(c.b)("Glasses"),Object(c.b)("Spanner"),Object(c.b)("Santa"),Object(c.b)("Thumbs up"),Object(c.b)("Umbrella"),Object(c.b)("Hourglass"),Object(c.b)("Clock"),Object(c.b)("Gift"),Object(c.b)("Light bulb"),Object(c.b)("Book"),Object(c.b)("Pencil"),Object(c.b)("Paperclip"),Object(c.b)("Scissors"),Object(c.b)("Lock"),Object(c.b)("Key"),Object(c.b)("Hammer"),Object(c.b)("Telephone"),Object(c.b)("Flag"),Object(c.b)("Train"),Object(c.b)("Bicycle"),Object(c.b)("Aeroplane"),Object(c.b)("Rocket"),Object(c.b)("Trophy"),Object(c.b)("Ball"),Object(c.b)("Guitar"),Object(c.b)("Trumpet"),Object(c.b)("Bell"),Object(c.b)("Anchor"),Object(c.b)("Headphones"),Object(c.b)("Folder"),Object(c.b)("Pin");class Ip extends o.a.Component{constructor(e){super(e),g()(this,"onResize",e=>{this.props.onResize&&this.props.onResize(e)}),this._vid=Object(i.createRef)()}componentDidMount(){this._vid.current.addEventListener("resize",this.onResize)}componentWillUnmount(){this._vid.current.removeEventListener("resize",this.onResize)}render(){return o.a.createElement("video",{ref:this._vid,style:{maxHeight:this.props.maxHeight}})}}g()(Ip,"propTypes",{maxHeight:re.a.number,onResize:re.a.func});var Op=s(490);let Tp={};n.m&&(Tp["structures.ContextMenu"]=n.m),m&&(Tp["structures.HomePage"]=m),ss&&(Tp["structures.LeftPanel"]=ss),$s&&(Tp["structures.LoggedInView"]=$s),zs.a&&(Tp["structures.MatrixChat"]=zs.a),Gs&&(Tp["structures.NonUrgentToastContainer"]=Gs),Gt.a&&(Tp["structures.RoomSearch"]=Gt.a),Ys.a&&(Tp["structures.RoomView"]=Ys.a),ce&&(Tp["structures.TabbedView"]=ce),Js&&(Tp["structures.ToastContainer"]=Js),qt&&(Tp["structures.UserMenu"]=qt),Qs.a&&(Tp["views.auth.PassphraseField"]=Qs.a),q.a&&(Tp["views.avatars.BaseAvatar"]=q.a),$t.a&&(Tp["views.avatars.DecoratedRoomAvatar"]=$t.a),G&&(Tp["views.avatars.GroupAvatar"]=G),Xs.a&&(Tp["views.avatars.MemberAvatar"]=Xs.a),js.a&&(Tp["views.avatars.PulsedAvatar"]=js.a),Ps.a&&(Tp["views.avatars.RoomAvatar"]=Ps.a),At.e&&(Tp["views.context_menus.IconizedContextMenu"]=At.e),Zs.a&&(Tp["views.dialogs.CommunityPrototypeInviteDialog"]=Zs.a),en.a&&(Tp["views.dialogs.CreateCommunityPrototypeDialog"]=en.a),Kt&&(Tp["views.dialogs.EditCommunityPrototypeDialog"]=Kt),tn.a&&(Tp["views.dialogs.ServerOfflineDialog"]=tn.a),sn.a&&(Tp["views.dialogs.ShareDialog"]=sn.a),Z.a&&(Tp["views.elements.AccessibleButton"]=Z.a),C.a&&(Tp["views.elements.AccessibleTooltipButton"]=C.a),nn&&(Tp["views.elements.Draggable"]=nn),ze&&(Tp["views.elements.EventTilePreview"]=ze),le.a&&(Tp["views.elements.Field"]=le.a),on&&(Tp["views.elements.IRCTimelineProfileResizer"]=on),rn.a&&(Tp["views.elements.InfoTooltip"]=rn.a),an&&(Tp["views.elements.ProgressBar"]=an),cn.a&&(Tp["views.elements.QRCode"]=cn.a),Ge&&(Tp["views.elements.SettingsFlag"]=Ge),Fe&&(Tp["views.elements.Slider"]=Fe),we.a&&(Tp["views.elements.StyledCheckbox"]=we.a),Ke.a&&(Tp["views.elements.StyledRadioButton"]=Ke.a),Ye&&(Tp["views.elements.StyledRadioGroup"]=Ye),qe.a&&(Tp["views.elements.ToggleSwitch"]=qe.a),ln.a&&(Tp["views.elements.Tooltip"]=ln.a),R&&(Tp["views.elements.UserTagTile"]=R),dn.a&&(Tp["views.elements.Validation"]=dn.a),un.a&&(Tp["views.messages.RedactedBody"]=un.a),hn.b&&(Tp["views.right_panel.BaseCard"]=hn.b),_n&&(Tp["views.right_panel.EncryptionInfo"]=_n),In&&(Tp["views.right_panel.EncryptionPanel"]=In),jn&&(Tp["views.right_panel.GroupHeaderButtons"]=jn),On.a&&(Tp["views.right_panel.HeaderButton"]=On.a),Tn.b&&(Tp["views.right_panel.HeaderButtons"]=Tn.b),Pn.a&&(Tp["views.right_panel.RoomHeaderButtons"]=Pn.a),Dn.a&&(Tp["views.right_panel.RoomSummaryCard"]=Dn.a),Rn&&(Tp["views.right_panel.VerificationPanel"]=Rn),An.a&&(Tp["views.right_panel.WidgetCard"]=An.a),Ti&&(Tp["views.rooms.Autocomplete"]=Ti),To&&(Tp["views.rooms.BasicMessageComposer"]=To),W.a&&(Tp["views.rooms.NotificationBadge"]=W.a),Qt&&(Tp["views.rooms.RoomBreadcrumbs"]=Qt),ie&&(Tp["views.rooms.RoomList"]=ie),es&&(Tp["views.rooms.RoomListNumResults"]=es),M.b&&(Tp["views.rooms.RoomSublist"]=M.b),xo.a&&(Tp["views.rooms.RoomTile"]=xo.a),H&&(Tp["views.rooms.TemporaryTile"]=H),bt&&(Tp["views.settings.UpdateCheckButton"]=bt),Bo&&(Tp["views.settings.tabs.room.BridgeSettingsTab"]=Bo),Xe&&(Tp["views.settings.tabs.user.AppearanceUserSettingsTab"]=Xe),Vo.a&&(Tp["views.toasts.GenericExpiringToast"]=Vo.a),Rs.a&&(Tp["views.toasts.GenericToast"]=Rs.a),Ko.a&&(Tp["views.toasts.NonUrgentEchoFailureToast"]=Ko.a),Wo&&(Tp["views.toasts.VerificationRequestToast"]=Wo),Ks&&(Tp["views.voip.CallContainer"]=Ks),Bs&&(Tp["views.voip.CallPreview"]=Bs),Us.a&&(Tp["views.voip.CallView"]=Us.a),As&&(Tp["views.voip.IncomingCallBox"]=As),r.a&&(Tp["structures.AutoHideScrollbar"]=r.a),j&&(Tp["structures.CustomRoomTagPanel"]=j),Ho.a&&(Tp["structures.EmbeddedPage"]=Ho.a),Yo&&(Tp["structures.FilePanel"]=Yo),Jo&&(Tp["structures.GenericErrorPage"]=Jo),lr&&(Tp["structures.GroupView"]=lr),Xt&&(Tp["structures.IndicatorScrollbar"]=Xt),Se&&(Tp["structures.InteractiveAuth"]=Se),Qo.a&&(Tp["structures.MainSplit"]=Qo.a),_r&&(Tp["structures.MessagePanel"]=_r),Er&&(Tp["structures.MyGroups"]=Er),wr&&(Tp["structures.NotificationPanel"]=wr),Xo.a&&(Tp["structures.RightPanel"]=Xo.a),Nr&&(Tp["structures.RoomDirectory"]=Nr),Ar&&(Tp["structures.RoomStatusBar"]=Ar),Ur.a&&(Tp["structures.ScrollPanel"]=Ur.a),Mr&&(Tp["structures.SearchBox"]=Mr),I&&(Tp["structures.TagPanel"]=I),Lr.a&&(Tp["structures.TimelinePanel"]=Lr.a),Kr&&(Tp["structures.UploadBar"]=Kr),qr&&(Tp["structures.UserView"]=qr),Hr&&(Tp["structures.ViewSource"]=Hr),Yr&&(Tp["structures.auth.CompleteSecurity"]=Yr),Qr&&(Tp["structures.auth.E2eSetup"]=Qr),sa&&(Tp["structures.auth.ForgotPassword"]=sa),la&&(Tp["structures.auth.Login"]=la),da&&(Tp["structures.auth.PostRegistration"]=da),fa&&(Tp["structures.auth.Registration"]=fa),zr.a&&(Tp["structures.auth.SetupEncryptionBody"]=zr.a),wa&&(Tp["structures.auth.SoftLogout"]=wa),Ca&&(Tp["views.auth.AuthBody"]=Ca),Ra&&(Tp["views.auth.AuthFooter"]=Ra),ka&&(Tp["views.auth.AuthHeader"]=ka),Ia&&(Tp["views.auth.AuthHeaderLogo"]=Ia),ta&&(Tp["views.auth.AuthPage"]=ta),Oa.a&&(Tp["views.auth.CaptchaForm"]=Oa.a),Ta&&(Tp["views.auth.CompleteSecurityBody"]=Ta),Ua&&(Tp["views.auth.CountryDropdown"]=Ua),Ma&&(Tp["views.auth.CustomServerDialog"]=Ma),be.d&&(Tp["views.auth.InteractiveAuthEntryComponents"]=be.d),Fa&&(Tp["views.auth.LanguageSelector"]=Fa),Ka&&(Tp["views.auth.ModularServerConfig"]=Ka),qa&&(Tp["views.auth.PasswordLogin"]=qa),Ha&&(Tp["views.auth.RegistrationForm"]=Ha),Va&&(Tp["views.auth.ServerConfig"]=Va),pa&&(Tp["views.auth.ServerTypeSelector"]=pa),$a&&(Tp["views.auth.SignInToText"]=$a),za&&(Tp["views.auth.Welcome"]=za),Ja&&(Tp["views.avatars.MemberStatusMessageAvatar"]=Ja),Qa&&(Tp["views.context_menus.GenericElementContextMenu"]=Qa),Xa&&(Tp["views.context_menus.GenericTextContextMenu"]=Xa),Za&&(Tp["views.context_menus.GroupInviteTileContextMenu"]=Za),ic&&(Tp["views.context_menus.MessageContextMenu"]=ic),Ya&&(Tp["views.context_menus.StatusMessageContextMenu"]=Ya),oc&&(Tp["views.context_menus.TagTileContextMenu"]=oc),rc&&(Tp["views.context_menus.WidgetContextMenu"]=rc),cc&&(Tp["views.dialogs.AddressPickerDialog"]=cc),lc&&(Tp["views.dialogs.AskInviteAnywayDialog"]=lc),Bt.a&&(Tp["views.dialogs.BaseDialog"]=Bt.a),Xn&&(Tp["views.dialogs.BugReportDialog"]=Xn),dc.a&&(Tp["views.dialogs.ChangelogDialog"]=dc.a),uc&&(Tp["views.dialogs.ConfirmAndWaitRedactDialog"]=uc),hc&&(Tp["views.dialogs.ConfirmDestroyCrossSigningDialog"]=hc),mc&&(Tp["views.dialogs.ConfirmRedactDialog"]=mc),gc&&(Tp["views.dialogs.ConfirmUserActionDialog"]=gc),fc&&(Tp["views.dialogs.ConfirmWipeDeviceDialog"]=fc),_c&&(Tp["views.dialogs.CreateGroupDialog"]=_c),vc&&(Tp["views.dialogs.CreateRoomDialog"]=vc),yc&&(Tp["views.dialogs.CryptoStoreTooNewDialog"]=yc),Ce&&(Tp["views.dialogs.DeactivateAccountDialog"]=Ce),Nc&&(Tp["views.dialogs.DevtoolsDialog"]=Nc),Ft.a&&(Tp["views.dialogs.ErrorDialog"]=Ft.a),jc&&(Tp["views.dialogs.IncomingSasDialog"]=jc),Pc.a&&(Tp["views.dialogs.InfoDialog"]=Pc.a),Dc.a&&(Tp["views.dialogs.IntegrationsDisabledDialog"]=Dc.a),Ac.a&&(Tp["views.dialogs.IntegrationsImpossibleDialog"]=Ac.a),Uc&&(Tp["views.dialogs.InteractiveAuthDialog"]=Uc),Mc.c&&(Tp["views.dialogs.InviteDialog"]=Mc.c),Lc&&(Tp["views.dialogs.KeySignatureUploadFailedDialog"]=Lc),Fc&&(Tp["views.dialogs.LazyLoadingDisabledDialog"]=Fc),Bc&&(Tp["views.dialogs.LazyLoadingResyncDialog"]=Bc),xt&&(Tp["views.dialogs.LogoutDialog"]=xt),Vc&&(Tp["views.dialogs.ManualDeviceKeyVerificationDialog"]=Vc),Kc&&(Tp["views.dialogs.MessageEditHistoryDialog"]=Kc),qc.a&&(Tp["views.dialogs.NewSessionReviewDialog"]=qc.a),Ot.a&&(Tp["views.dialogs.QuestionDialog"]=Ot.a),Tt&&(Tp["views.dialogs.RedesignFeedbackDialog"]=Tt),Xc&&(Tp["views.dialogs.ReportEventDialog"]=Xc),ul&&(Tp["views.dialogs.RoomSettingsDialog"]=ul),hl&&(Tp["views.dialogs.RoomUpgradeDialog"]=hl),ml&&(Tp["views.dialogs.RoomUpgradeWarningDialog"]=ml),pl&&(Tp["views.dialogs.SessionRestoreErrorDialog"]=pl),_l&&(Tp["views.dialogs.SetEmailDialog"]=_l),vl&&(Tp["views.dialogs.SetMxIdDialog"]=vl),Cs&&(Tp["views.dialogs.SetPasswordDialog"]=Cs),yl.a&&(Tp["views.dialogs.SetupEncryptionDialog"]=yl.a),bl&&(Tp["views.dialogs.SlashCommandHelpDialog"]=bl),El&&(Tp["views.dialogs.StorageEvictedDialog"]=El),Sl.a&&(Tp["views.dialogs.TabbedIntegrationManagerDialog"]=Sl.a),Cl&&(Tp["views.dialogs.TermsDialog"]=Cl),Rl&&(Tp["views.dialogs.TextInputDialog"]=Rl),kl&&(Tp["views.dialogs.UploadConfirmDialog"]=kl),Il&&(Tp["views.dialogs.UploadFailureDialog"]=Il),It&&(Tp["views.dialogs.UserSettingsDialog"]=It),Ol.a&&(Tp["views.dialogs.VerificationRequestDialog"]=Ol.a),Tl.a&&(Tp["views.dialogs.WidgetOpenIDPermissionsDialog"]=Tl.a),Nl&&(Tp["views.dialogs.keybackup.RestoreKeyBackupDialog"]=Nl),jl&&(Tp["views.dialogs.secretstorage.AccessSecretStorageDialog"]=jl),Tr&&(Tp["views.directory.NetworkDropdown"]=Tr),Pl&&(Tp["views.elements.ActionButton"]=Pl),Dl&&(Tp["views.elements.AddressSelector"]=Dl),Al&&(Tp["views.elements.AddressTile"]=Al),Ul.a&&(Tp["views.elements.AppPermission"]=Ul.a),Ml.a&&(Tp["views.elements.AppTile"]=Ml.a),Ll.a&&(Tp["views.elements.AppWarning"]=Ll.a),Bl&&(Tp["views.elements.DNDTagTile"]=Bl),Vl.a&&(Tp["views.elements.DialogButtons"]=Vl.a),Kl&&(Tp["views.elements.DirectorySearchBox"]=Kl),Gl&&(Tp["views.elements.Dropdown"]=Gl),Hl&&(Tp["views.elements.EditableItemList"]=Hl),$l&&(Tp["views.elements.EditableText"]=$l),zl&&(Tp["views.elements.EditableTextContainer"]=zl),Yl.a&&(Tp["views.elements.ErrorBoundary"]=Yl.a),Ql&&(Tp["views.elements.EventListSummary"]=Ql),Zl&&(Tp["views.elements.Flair"]=Zl),Ds.a&&(Tp["views.elements.FormButton"]=Ds.a),ed&&(Tp["views.elements.IconButton"]=ed),td.a&&(Tp["views.elements.ImageView"]=td.a),_t.a&&(Tp["views.elements.InlineSpinner"]=_t.a),De.a&&(Tp["views.elements.LabelledToggleSwitch"]=De.a),_e&&(Tp["views.elements.LanguageDropdown"]=_e),nd&&(Tp["views.elements.LazyRenderList"]=nd),id&&(Tp["views.elements.MemberEventListSummary"]=id),od.a&&(Tp["views.elements.PersistedElement"]=od.a),Fs&&(Tp["views.elements.PersistentApp"]=Fs),Mo&&(Tp["views.elements.Pill"]=Mo),ad&&(Tp["views.elements.PowerSelector"]=ad),cd.a&&(Tp["views.elements.ReplyThread"]=cd.a),_s&&(Tp["views.elements.ResizeHandle"]=_s),ld&&(Tp["views.elements.RoomAliasField"]=ld),ud&&(Tp["views.elements.RoomDirectoryButton"]=ud),oa&&(Tp["views.elements.SSOButton"]=oa),Ne.a&&(Tp["views.elements.Spinner"]=Ne.a),hd&&(Tp["views.elements.Spoiler"]=hd),pd&&(Tp["views.elements.StartChatButton"]=pd),Wr&&(Tp["views.elements.SyntaxHighlight"]=Wr),Fl&&(Tp["views.elements.TagTile"]=Fl),gd.a&&(Tp["views.elements.TextWithTooltip"]=gd.a),fd.a&&(Tp["views.elements.TintableSvg"]=fd.a),_d&&(Tp["views.elements.TintableSvgButton"]=_d),vd&&(Tp["views.elements.TooltipButton"]=vd),yd&&(Tp["views.elements.TruncatedList"]=yd),En&&(Tp["views.elements.crypto.VerificationQRCode"]=En),kd&&(Tp["views.emojipicker.Category"]=kd),Od&&(Tp["views.emojipicker.Emoji"]=Od),Cd&&(Tp["views.emojipicker.EmojiPicker"]=Cd),xd&&(Tp["views.emojipicker.Header"]=xd),jd&&(Tp["views.emojipicker.Preview"]=jd),Ad&&(Tp["views.emojipicker.QuickReactions"]=Ad),Md&&(Tp["views.emojipicker.ReactionPicker"]=Md),Fd&&(Tp["views.emojipicker.Search"]=Fd),Bd&&(Tp["views.groups.GroupInviteTile"]=Bd),Vd&&(Tp["views.groups.GroupMemberList"]=Vd),Kd&&(Tp["views.groups.GroupMemberTile"]=Kd),qd&&(Tp["views.groups.GroupPublicityToggle"]=qd),Gd&&(Tp["views.groups.GroupRoomInfo"]=Gd),Wd&&(Tp["views.groups.GroupRoomList"]=Wd),$d&&(Tp["views.groups.GroupRoomTile"]=$d),Jd&&(Tp["views.groups.GroupTile"]=Jd),St&&(Tp["views.groups.GroupUserSettings"]=St),Qd&&(Tp["views.messages.DateSeparator"]=Qd),gu&&(Tp["views.messages.EditHistoryMessage"]=gu),fu&&(Tp["views.messages.EncryptionEvent"]=fu),Tu&&(Tp["views.messages.MAudioBody"]=Tu),Ou&&(Tp["views.messages.MFileBody"]=Ou),xu&&(Tp["views.messages.MImageBody"]=xu),ju&&(Tp["views.messages.MKeyVerificationConclusion"]=ju),Pu&&(Tp["views.messages.MKeyVerificationRequest"]=Pu),Du&&(Tp["views.messages.MStickerBody"]=Du),Au&&(Tp["views.messages.MVideoBody"]=Au),Fu&&(Tp["views.messages.MessageActionBar"]=Fu),Bu.a&&(Tp["views.messages.MessageEvent"]=Bu.a),Vu&&(Tp["views.messages.MessageTimestamp"]=Vu),Ku&&(Tp["views.messages.MjolnirBody"]=Ku),qu&&(Tp["views.messages.ReactionsRow"]=qu),Gu&&(Tp["views.messages.ReactionsRowButton"]=Gu),Wu&&(Tp["views.messages.ReactionsRowButtonTooltip"]=Wu),Hu&&(Tp["views.messages.RoomAvatarEvent"]=Hu),$u&&(Tp["views.messages.RoomCreate"]=$u),zu&&(Tp["views.messages.SenderProfile"]=zu),Yu.a&&(Tp["views.messages.TextualBody"]=Yu.a),Ju&&(Tp["views.messages.TextualEvent"]=Ju),Qu&&(Tp["views.messages.TileErrorBoundary"]=Qu),Xu.a&&(Tp["views.messages.UnknownBody"]=Xu.a),Zu&&(Tp["views.messages.ViewSourceEvent"]=Zu),wh&&(Tp["views.right_panel.UserInfo"]=wh),kh&&(Tp["views.room_settings.AliasSettings"]=kh),Oh&&(Tp["views.room_settings.RelatedGroupSettings"]=Oh),rl&&(Tp["views.room_settings.RoomProfileSettings"]=rl),Ch&&(Tp["views.room_settings.RoomPublishSetting"]=Ch),Th&&(Tp["views.room_settings.UrlPreviewSettings"]=Th),xh.a&&(Tp["views.rooms.AppsDrawer"]=xh.a),Nh.a&&(Tp["views.rooms.AuxPanel"]=Nh.a),wn.b&&(Tp["views.rooms.E2EIcon"]=wn.b),Gh&&(Tp["views.rooms.EditMessageComposer"]=Gh),$h&&(Tp["views.rooms.EntityTile"]=$h),$e.a&&(Tp["views.rooms.EventTile"]=$e.a),zh.a&&(Tp["views.rooms.ForwardMessage"]=zh.a),Yh&&(Tp["views.rooms.JumpToBottomButton"]=Yh),Qh&&(Tp["views.rooms.LinkPreviewWidget"]=Qh),em&&(Tp["views.rooms.MemberList"]=em),tm&&(Tp["views.rooms.MemberTile"]=tm),hm&&(Tp["views.rooms.MessageComposer"]=hm),So&&(Tp["views.rooms.MessageComposerFormatBar"]=So),mm.a&&(Tp["views.rooms.PinnedEventTile"]=mm.a),pm.a&&(Tp["views.rooms.PinnedEventsPanel"]=pm.a),gm&&(Tp["views.rooms.PresenceLabel"]=gm),fm.a&&(Tp["views.rooms.ReadReceiptMarker"]=fm.a),om&&(Tp["views.rooms.ReplyPreview"]=om),bm&&(Tp["views.rooms.RoomDetailList"]=bm),ym&&(Tp["views.rooms.RoomDetailRow"]=ym),Em.a&&(Tp["views.rooms.RoomHeader"]=Em.a),Sm.a&&(Tp["views.rooms.RoomPreviewBar"]=Sm.a),wm.a&&(Tp["views.rooms.RoomRecoveryReminder"]=wm.a),Cm.a&&(Tp["views.rooms.RoomUpgradeWarningBar"]=Cm.a),Rm.a&&(Tp["views.rooms.SearchBar"]=Rm.a),km&&(Tp["views.rooms.SearchResultTile"]=km),Tm&&(Tp["views.rooms.SendMessageComposer"]=Tm),xm.b&&(Tp["views.rooms.SimpleRoomHeader"]=xm.b),nm&&(Tp["views.rooms.Stickerpicker"]=nm),Nm&&(Tp["views.rooms.ThirdPartyMemberInfo"]=Nm),jm&&(Tp["views.rooms.TopUnreadMessagesBar"]=jm),Am&&(Tp["views.rooms.WhoIsTypingTile"]=Am),Mm&&(Tp["views.settings.AvatarSetting"]=Mm),Lo&&(Tp["views.settings.BridgeTile"]=Lo),Lm&&(Tp["views.settings.ChangeAvatar"]=Lm),Fm&&(Tp["views.settings.ChangeDisplayName"]=Fm),Bm&&(Tp["views.settings.ChangePassword"]=Bm),Vm&&(Tp["views.settings.CrossSigningPanel"]=Vm),Km&&(Tp["views.settings.DevicesPanel"]=Km),qm&&(Tp["views.settings.DevicesPanelEntry"]=qm),Gm&&(Tp["views.settings.E2eAdvancedPanel"]=Gm),Wm&&(Tp["views.settings.EventIndexPanel"]=Wm),Hm.a&&(Tp["views.settings.IntegrationManager"]=Hm.a),zm&&(Tp["views.settings.KeyBackupPanel"]=zm),cp&&(Tp["views.settings.Notifications"]=cp),fe&&(Tp["views.settings.ProfileSettings"]=fe),lp&&(Tp["views.settings.SetIdServer"]=lp),dp&&(Tp["views.settings.SetIntegrationManager"]=dp),hp&&(Tp["views.settings.account.EmailAddresses"]=hp),pp&&(Tp["views.settings.account.PhoneNumbers"]=pp),fp&&(Tp["views.settings.discovery.EmailAddresses"]=fp),vp&&(Tp["views.settings.discovery.PhoneNumbers"]=vp),el&&(Tp["views.settings.tabs.room.AdvancedRoomSettingsTab"]=el),al&&(Tp["views.settings.tabs.room.GeneralRoomSettingsTab"]=al),dl&&(Tp["views.settings.tabs.room.NotificationSettingsTab"]=dl),ol&&(Tp["views.settings.tabs.room.RolesRoomSettingsTab"]=ol),cl&&(Tp["views.settings.tabs.room.SecurityRoomSettingsTab"]=cl),wt&&(Tp["views.settings.tabs.user.FlairUserSettingsTab"]=wt),Pe&&(Tp["views.settings.tabs.user.GeneralUserSettingsTab"]=Pe),Et&&(Tp["views.settings.tabs.user.HelpUserSettingsTab"]=Et),Ue&&(Tp["views.settings.tabs.user.LabsUserSettingsTab"]=Ue),kt&&(Tp["views.settings.tabs.user.MjolnirUserSettingsTab"]=kt),nt&&(Tp["views.settings.tabs.user.NotificationUserSettingsTab"]=nt),it&&(Tp["views.settings.tabs.user.PreferencesUserSettingsTab"]=it),st&&(Tp["views.settings.tabs.user.SecurityUserSettingsTab"]=st),pt&&(Tp["views.settings.tabs.user.VoiceUserSettingsTab"]=pt),yp&&(Tp["views.terms.InlineTermsAgreement"]=yp),bp&&(Tp["views.verification.VerificationCancelled"]=bp),Ep&&(Tp["views.verification.VerificationComplete"]=Ep),Rp&&(Tp["views.verification.VerificationQREmojiOptions"]=Rp),kp&&(Tp["views.verification.VerificationShowSas"]=kp),Ip&&(Tp["views.voip.VideoFeed"]=Ip),Op.a&&(Tp["views.voip.VideoView"]=Op.a)},function(e,t,s){"use strict";s.d(t,"b",(function(){return T})),s.d(t,"a",(function(){return N}));var n=s(2),i=s.n(n),o=s(1),r=s(90),a=s(10),c=s(3),l=s(431),d=s(71),u=s(244),h=s(139),m=s(169);var p=s(47),g=s(434);const f={[m.b.Recent]:new class{async sortRooms(e,t){let s="";p.a.get()&&(s=p.a.get().getUserId());const n={},i=e=>{if(n[e.roomId])return n[e.roomId];const t=(()=>{if(!e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(h.b)(e.getMyMembership())!==h.a.Join){const t=e.currentState.getStateEvents("m.room.member",s);if(t&&!Array.isArray(t))return t.getTs()}for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getTs()&&(n.getSender()===s||g.b(n)))return n.getTs()}return e.timeline.length&&e.timeline[0].getTs()?e.timeline[0].getTs():Number.MAX_SAFE_INTEGER})();return n[e.roomId]=t,t};return e.sort((e,t)=>i(t)-i(e))}},[m.b.Alphabetic]:new class{async sortRooms(e,t){return e.sort((e,t)=>e.name.localeCompare(t.name))}},[m.b.Manual]:new class{async sortRooms(e,t){const s=e=>e.tags[t].order||0;return e.sort((e,t)=>s(e)-s(t))}}};function _(e,t,s){return function(e){if(!f[e])throw new Error(e+" is not a known algorithm");return f[e]}(s).sortRooms(e,t)}var v=s(441),y=s.n(v);class b{constructor(e,t){this.tagId=e,i()(this,"cachedOrderedRooms",void 0),i()(this,"sortingAlgorithm",void 0),i()(this,"updateLock",new y.a),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}async setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,await this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(console.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex(t=>t.roomId===e.roomId)),t}}var E=s(174),S=s(131);const w=[E.a.Red,E.a.Grey,E.a.Bold,E.a.None];class C extends b{constructor(e,t){super(e,t),i()(this,"indices",{})}categorizeRooms(e){const t={[E.a.Red]:[],[E.a.Grey]:[],[E.a.Bold]:[],[E.a.None]:[]};for(const s of e){t[this.getRoomCategory(s)].push(s)}return t}getRoomCategory(e){return S.a.instance.getRoomState(e).color}async setRooms(e){if(this.sortingAlgorithm===m.b.Manual)this.cachedOrderedRooms=await _(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const s=t[e];t[e]=await _(s,this.tagId,this.sortingAlgorithm)}const s=[],n={};for(const e of w)n[e]=s.length,s.push(...t[e]);this.indices=n,this.cachedOrderedRooms=s}}async handleSplice(e,t){if(t===d.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),await this.sortCategory(t)}else{if(t!==d.c.RoomRemoved)throw new Error("Unhandled splice: "+t);{const t=this.getRoomIndex(e);if(-1===t)return console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const s=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(s,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}async handleRoomUpdate(e,t){try{if(await this.updateLock.acquireAsync(),t===d.c.NewRoom||t===d.c.RoomRemoved)return this.handleSplice(e,t);if(t!==d.c.Timeline&&t!==d.c.ReadReceipt)throw new Error("Unsupported update cause: "+t);const s=this.getRoomCategory(e);if(this.sortingAlgorithm===m.b.Manual)return;const n=this.getRoomIndex(e);if(-1===n)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const i=this.getCategoryFromIndices(n,this.indices);return i!==s&&(this.moveRoomIndexes(1,i,s,this.indices),this.cachedOrderedRooms.splice(n,1),this.cachedOrderedRooms.splice(this.indices[s],0,e)),await this.sortCategory(s),!0}finally{await this.updateLock.release()}}async sortCategory(e){const t=e===w[w.length-1]?Number.MAX_SAFE_INTEGER:this.indices[w[w.indexOf(e)+1]],s=this.indices[e],n=t-s,i=this.cachedOrderedRooms.splice(s,n),o=await _(i,this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(s,0,...o)}getCategoryFromIndices(e,t){for(let s=0;s<w.length;s++){const n=w[s],i=s===w.length-1,o=t[n],r=i?Number.MAX_SAFE_INTEGER:t[w[s+1]];if(e>=o&&e<r)return n}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,s,n){this.alterCategoryPositionBy(t,-e,n),this.alterCategoryPositionBy(s,+e,n)}alterCategoryPositionBy(e,t,s){const n=w.indexOf(e)+1;if(t>0)for(let e=n;e<w.length;e++){s[w[e]]+=Math.abs(t)}else if(t<0)for(let e=n;e<w.length;e++){s[w[e]]-=Math.abs(t)}for(let e=1;e<=w.length;e++){const t=w[e-1],n=w[e];s[t]>s[n]&&console.warn(`!! Room list index corruption: ${t} (i:${s[t]}) is greater than ${n} (i:${s[n]}) - category indices are likely desynced from reality`)}}}class R extends b{constructor(e,t){super(e,t)}async setRooms(e){this.cachedOrderedRooms=await _(e,this.tagId,this.sortingAlgorithm)}async handleRoomUpdate(e,t){try{await this.updateLock.acquireAsync();const s=t===d.c.NewRoom||t===d.c.RoomRemoved,n=t===d.c.Timeline||t===d.c.ReadReceipt;if(!s&&!n)throw new Error("Unsupported update cause: "+t);if(t===d.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===d.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=await _(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}finally{await this.updateLock.release()}}}const k={[m.a.Natural]:(e,t)=>new R(e,t),[m.a.Importance]:(e,t)=>new C(e,t)};function I(e,t,s){if(!k[e])throw new Error(e+" is not a known algorithm");return k[e](t,s)}var O=s(50);const T="list_updated_event",x=[d.c.Timeline,d.c.ReadReceipt];class N extends a.EventEmitter{constructor(){super(),i()(this,"_cachedRooms",{}),i()(this,"_cachedStickyRooms",{}),i()(this,"filteredRooms",{}),i()(this,"_stickyRoom",null),i()(this,"_lastStickyRoom",null),i()(this,"sortAlgorithms",void 0),i()(this,"listAlgorithms",void 0),i()(this,"algorithms",void 0),i()(this,"rooms",[]),i()(this,"roomIdsToTags",{}),i()(this,"allowedByFilter",new Map),i()(this,"allowedRoomsByFilters",new Set)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get hasFilters(){return this.allowedByFilter.size>0}set cachedRooms(e){this._cachedRooms=e,this.recalculateFilteredRooms(),this.recalculateStickyRoom()}get cachedRooms(){return this._cachedRooms}async setStickyRoom(e){await this.updateStickyRoom(e)}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}async setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.sortAlgorithms[e]=t;const s=this.algorithms[e];await s.setSortAlgorithm(t),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}async setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.listAlgorithms[e]=t;const s=I(t,e,this.sortAlgorithms[e]);this.algorithms[e]=s,await s.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}addFilterCondition(e){this.allowedByFilter.set(e,this.rooms.filter(t=>e.isVisible(t))),this.recalculateFilteredRooms(),e.on(u.a,this.handleFilterChange.bind(this))}removeFilterCondition(e){e.off(u.a,this.handleFilterChange.bind(this)),this.allowedByFilter.has(e)&&(this.allowedByFilter.delete(e),this.recalculateFilteredRooms(),this.hasFilters||this.emit(T))}async handleFilterChange(){await this.recalculateFilteredRooms(),this.emit(u.a)}async updateStickyRoom(e){try{return await this.doUpdateStickyRoom(e)}finally{this._lastStickyRoom=null}}async doUpdateStickyRoom(e){if(this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void await this.handleRoomUpdate(e,d.c.NewRoom)}return}let t=this.roomIdsToTags[e.roomId][0];if(!t)throw new Error(e.roomId+" does not belong to a tag and cannot be sticky");let s=(this.getOrderedRoomsWithoutSticky()[t]||[]).indexOf(e);const n=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&t!==this._lastStickyRoom.tag&&n&&s<0&&(console.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),s=0),s<0)throw new Error(e.roomId+" does not appear to be known and cannot be sticky");const i=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),i&&i.room&&i.room.roomId!==e.roomId&&await this.handleRoomUpdate(i.room,d.c.NewRoom),await this.handleRoomUpdate(e,d.c.RoomRemoved),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");console.warn("Sticky room changed references")}console.warn(`Sticky room changed tag & position from ${t} / ${s} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),t=this._stickyRoom.tag,s=this._stickyRoom.position}i&&i.tag===t&&i.position<=s&&s++,this._stickyRoom={room:e,position:s,tag:t},this.recalculateFilteredRoomsForTag(t),i&&i.tag!==t&&this.recalculateFilteredRoomsForTag(i.tag),this.recalculateStickyRoom(),this.emit(T)}recalculateFilteredRooms(){if(!this.hasFilters)return;console.warn("Recalculating filtered room list");const e=Array.from(this.allowedByFilter.keys()),t=new c.a(e).groupBy(e=>e.relativePriority).orderBy(Object(l.a)(u.b)).value,s={};for(const e of Object.keys(this.cachedRooms)){const n=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(n,e);let i=n.map(e=>e),o=[],r=t[0].relativePriority;for(const e of t){e.relativePriority!==r&&(i=o,o=[],r=e.relativePriority);const t=i.filter(t=>e.isVisible(t));for(const e of t){const t=i.indexOf(e);t>=0&&i.splice(t,1),o.push(e)}}s[e]=o,O.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${s[e].length}/${n.length} rooms filtered into ${e}`)}const n=Object.values(s).reduce((e,t)=>(e.push(...t),e),[]);this.allowedRoomsByFilters=new Set(n),this.filteredRooms=s,this.emit(T)}recalculateFilteredRoomsForTag(e){if(!this.hasFilters)return;O.a.getValue("advancedRoomListLogging")&&console.log("Recalculating filtered rooms for "+e),delete this.filteredRooms[e];const t=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(t,e);const s=t.filter(e=>this.allowedRoomsByFilters.has(e));s.length>0&&(this.filteredRooms[e]=s),O.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${s.length}/${t.length} rooms filtered into ${e}`)}tryInsertStickyRoomToFilterSet(e,t){if(!this._stickyRoom||!this._stickyRoom.room||this._stickyRoom.tag!==t)return;const s=this._stickyRoom.position;s>=e.length?e.push(this._stickyRoom.room):e.splice(s,0,this._stickyRoom.room)}recalculateStickyRoom(e=null){if(!this._stickyRoom)return void(this._cachedStickyRooms&&(this._cachedStickyRooms=null,this.emit(T)));if(!this._cachedStickyRooms||!e){O.a.getValue("advancedRoomListLogging")&&console.log("Generating clone of cached rooms for sticky room handling");const e={};for(const t of Object.keys(this.cachedRooms))e[t]=this.cachedRooms[t].map(e=>e);this._cachedStickyRooms=e}e&&(O.a.getValue("advancedRoomListLogging")&&console.log("Replacing cached sticky rooms for "+e),this._cachedStickyRooms[e]=this.cachedRooms[e].map(e=>e));const t=this._stickyRoom;e&&e!==t.tag||(O.a.getValue("advancedRoomListLogging")&&console.log(`Inserting sticky room ${t.room.roomId} at position ${t.position} in ${t.tag}`),this._cachedStickyRooms[t.tag].splice(t.position,0,t.room)),this.emit(T)}async populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(c.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=I(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this.hasFilters?this.filteredRooms:this._cachedStickyRooms||this.cachedRooms}getUnfilteredRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.hasFilters?this.filteredRooms:this.cachedRooms}async setKnownRooms(e){if(Object(o.r)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");console.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;await this.updateStickyRoom(null),this.rooms=e;const s={};for(const e in this.sortAlgorithms)s[e]=[];if(!e.length)return await this.generateFreshTags(s),void(this.cachedRooms=s);const n=Object(h.d)(e);for(const e of n[h.a.Invite])s[d.a.Invite].push(e);for(const e of n[h.a.Leave])s[d.a.Archived].push(e);for(const e of n[h.a.Join]){const t=this.getTagsOfJoinedRoom(e);let n=!1;if(t.length>0)for(const i of t)Object(o.r)(s[i])||(s[i].push(e),n=!0);n||(r.a.shared().getUserIdForRoomId(e.roomId)?s[d.a.DM].push(e):s[d.a.Untagged].push(e))}await this.generateFreshTags(s),this.cachedRooms=s,this.updateTagsFromCache(),this.recalculateFilteredRooms(),t&&t.room&&(await this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],s=Object(h.b)(e.getMyMembership());return s===h.a.Invite?t.push(d.a.Invite):s===h.a.Leave?t.push(d.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||t.push(d.a.Untagged),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&r.a.shared().getUserIdForRoomId(e.roomId)&&(t=[d.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const s of t){const t=this.cachedRooms[s];for(const n of t)e[n.roomId]||(e[n.roomId]=[]),e[n.roomId].push(s)}this.roomIdsToTags=e}async generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.setRooms(e[t]),e[t]=s.orderedRooms}}async handleRoomUpdate(e,t){if(O.a.getValue("advancedRoomListLogging")&&console.log(`Handle room update for ${e.roomId} called with cause ${t}`),!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const s=this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.room.roomId===e.roomId;if(t===d.c.NewRoom){const n=this._lastStickyRoom&&this._lastStickyRoom.room===e,i=this.roomIdsToTags[e.roomId],o=i&&i.length>0;o&&!n&&(console.warn(e.roomId+" is reportedly new but is already known - assuming TagChange instead"),t=d.c.PossibleTagChange);let r=this.rooms.includes(e);if(o&&!r&&(console.warn(e.roomId+" might be a reference change - attempting to update reference"),this.rooms=this.rooms.map(t=>t.roomId===e.roomId?e:t),r=this.rooms.includes(e),r||console.warn(e.roomId+" is still not referenced. It may be sticky.")),o&&!r&&!s)throw new Error(e.roomId+" is missing from room array but is known - trying to find duplicate");o&&s&&(this._stickyRoom.room=e),t!==d.c.NewRoom||s||r||this.rooms.push(e)}let n=!1;if(t===d.c.PossibleTagChange){const i=this.roomIdsToTags[e.roomId]||[],o=this.getTagsForRoom(e),r=Object(c.b)(i,o);if(r.removed.length>0||r.added.length>0){for(const t of r.removed){O.a.getValue("advancedRoomListLogging")&&console.log(`Removing ${e.roomId} from ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,d.c.RoomRemoved),this._cachedRooms[t]=s.orderedRooms,this.recalculateFilteredRoomsForTag(t),this.recalculateStickyRoom(t)}for(const t of r.added){O.a.getValue("advancedRoomListLogging")&&console.log(`Adding ${e.roomId} to ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,d.c.NewRoom),this._cachedRooms[t]=s.orderedRooms}this.roomIdsToTags[e.roomId]=o,O.a.getValue("advancedRoomListLogging")&&console.log(`Changing update cause for ${e.roomId} to Timeline to sort rooms`),t=d.c.Timeline,n=!0}else O.a.getValue("advancedRoomListLogging")&&console.log(`Received no-op update for ${e.roomId} - changing to Timeline update`),t=d.c.Timeline;n&&s&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:await this.setStickyRoom(e))}if(t!==d.c.NewRoom&&t!==d.c.RoomRemoved&&this.stickyRoom===e)return O.a.getValue("advancedRoomListLogging")&&console.warn(`[RoomListDebug] Received ${t} update for sticky room ${e.roomId} - ignoring`),!1;if(!this.roomIdsToTags[e.roomId]){if(x.includes(t))return O.a.getValue("advancedRoomListLogging")&&console.warn(`Skipping tag update for ${e.roomId} because we don't know about the room`),!1;O.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updating tags for room ${e.roomId} (${e.name})`);const s=this.getTagsForRoom(e).filter(e=>!Object(o.r)(this.cachedRooms[e]));if(!s.length)throw new Error("Tags cannot be determined for "+e.roomId);this.roomIdsToTags[e.roomId]=s,O.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updated tags for ${e.roomId}:`,s)}O.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Reached algorithmic handling for ${e.roomId} and cause ${t}`);const i=this.roomIdsToTags[e.roomId];if(!i)return console.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let r=n;for(const s of i){const n=this.algorithms[s];if(!n)throw new Error("No algorithm for "+s);await n.handleRoomUpdate(e,t),this._cachedRooms[s]=n.orderedRooms,this.recalculateFilteredRoomsForTag(s),this.recalculateStickyRoom(s),r=!0}return O.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Finished handling ${e.roomId} with cause ${t} (changed=${r})`),r}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return y})),s.d(t,"a",(function(){return S}));var n=s(2),i=s.n(n),o=s(103),r=s(48),a=s(44),c=s(47),l=s(71);function d(e){const t=c.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function u(e,t){if(t!==l.a.DM)return!0;const s=c.a.get().getRoom(e);return!s||2!==s.currentState.getJoinedMemberCount()}function h(e){return e.sender?e.sender.name:e.getSender()}var m=s(170),p=s(77);var g=s(1);var f=s(50),_=s(90);var v=s(86);const y="room_preview_changed",b={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t){let s=e.getContent();if(e.isRelation("m.replace")&&(s=e.getContent()["m.new_content"]),!s||!s.body)return null;let n=(s.body||"").trim();const i=s.msgtype;if(!n||!i)return null;const o="org.matrix.custom.html"===s.format&&s.formatted_body;o&&(n=s.formatted_body);const r=e.getWireContent()["m.relates_to"];return r&&r["m.in_reply_to"]&&(n=o?(m.a.stripHTMLReply(n)||"").trim():(m.a.stripPlainReply(n)||"").trim(),!n)?null:(o&&(n=Object(p.g)(n)),"m.emote"===i?Object(a.a)("* %(senderName)s %(emote)s",{senderName:h(e),emote:n}):d(e)||!u(e.getRoomId(),t)?n:Object(a.a)("%(senderName)s: %(message)s",{senderName:h(e),message:n}))}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(a.a)("You started a call"):Object(a.a)("%(senderName)s started a call",{senderName:h(e)}):d(e)?Object(a.a)("Waiting for answer"):Object(a.a)("%(senderName)s is calling",{senderName:h(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(a.a)("You joined the call"):Object(a.a)("%(senderName)s joined the call",{senderName:h(e)}):Object(a.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(a.a)("You left the call"):Object(a.a)("%(senderName)s left the call",{senderName:h(e)}):Object(a.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t){const s=e.getContent().body;return s?d(e)||!u(e.getRoomId(),t)?s:Object(a.a)("%(senderName)s: %(stickerName)s",{senderName:h(e),stickerName:s}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t){const s=f.a.getValue("feature_roomlist_preview_reactions_dms");if(!f.a.getValue("feature_roomlist_preview_reactions_all")&&(!s||_.a.shared().getUserIdForRoomId(e.getRoomId())))return null;const n=e.getRelation();if(!n)return null;const i=n.key;return i?d(e)||!u(e.getRoomId(),t)?i:Object(a.a)("%(senderName)s: %(reaction)s",{senderName:h(e),reaction:i}):null}}}},E="im.vector.any";class S extends o.a{constructor(){super(r.a,{}),i()(this,"previews",new Map)}static get instance(){return S.internalInstance}getPreviewForRoom(e,t){if(!e)return null;this.previews.has(e.roomId)||this.generatePreview(e,t);const s=this.previews.get(e.roomId);return s?s.has(t)?s.get(t):s.get(E):null}generatePreview(e,t){const s=e.timeline;if(!s)return;let n=this.previews.get(e.roomId);n||(n=new Map,this.previews.set(e.roomId,n)),n.has(E)||n.set(E,null),t&&!n.has(t)&&n.set(t,null);let i=!1;for(let t=s.length-1;t>=0;t--){if(t===s.length-50)return;const o=s[t],r=b[o.getType()];if(!r)continue;if(r.isState&&Object(g.r)(o.getStateKey()))continue;const a=r.previewer.getTextFor(o,null);if(!a)continue;i=i||a!==n.get(E),n.set(E,a);const c=Array.from(n.keys()).filter(e=>e!==E);for(const e of c){const t=e===E?null:e,s=r.previewer.getTextFor(o,t);s===a?(i=i||a!==n.get(e),n.delete(e)):(i=i||s!==n.get(e),n.set(e,s))}return void(i&&(this.previews.set(e.roomId,n),this.emit(v.b,this),this.emit(y,e)))}this.previews.set(e.roomId,new Map),this.emit(v.b,this),this.emit(y,e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event;if(!this.previews.has(t.getRoomId()))return;this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),E)}}}i()(S,"internalInstance",new S)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1);function i(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}function o(e,t){this.rank=e,this.context=t}i.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},i.prototype.getTimeline=function(){return this._timeline},i.prototype.getOurEventIndex=function(){return this._ourEventIndex},i.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},i.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},i.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)},o.fromJson=function(e,t){const s=e.context||{},r=s.events_before||[],a=s.events_after||[],c=new i(t(e.result));return c.setPaginateToken(s.start,!0),c.addEvents(n.u(r,t),!0),c.addEvents(n.u(a,t),!1),c.setPaginateToken(s.end,!1),new o(e.rank,c)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(2),i=s.n(n),o=s(110),r=s(244),a=s(10),c=s(67),l=s(3),d=s(90);class u extends a.EventEmitter{constructor(e){super(),this.community=e,i()(this,"roomIds",[]),i()(this,"userIds",[]),i()(this,"onStoreUpdate",async()=>{const e=this.roomIds;this.roomIds=(await c.a.getGroupRooms(this.community.groupId)).map(e=>e.roomId);const t=this.userIds;this.userIds=(await c.a.getGroupMembers(this.community.groupId)).map(e=>e.userId),(Object(l.d)(e,this.roomIds)||Object(l.d)(t,this.userIds))&&this.emit(r.a)}),c.a.on("update",this.onStoreUpdate),this.onStoreUpdate()}get relativePriority(){return r.b.Lowest}isVisible(e){return this.roomIds.includes(e.roomId)||this.userIds.includes(d.a.shared().getUserIdForRoomId(e.roomId))}destroy(){c.a.off("update",this.onStoreUpdate)}}class h{constructor(e){this.store=e,i()(this,"filters",new Map),i()(this,"onTagsUpdated",()=>{const e=Array.from(this.filters.keys()),t=o.a.getSelectedTags();if(Object(l.d)(e,t)){if(!this.store.matrixClient)return void console.warn("Tag update without an associated matrix client - ignoring");const s=new Map,n=t.filter(e=>e.startsWith("+"));for(const e of n){const t=this.store.matrixClient.getGroup(e);if(!t){console.warn("Group selected with no group object available: "+e);continue}let n=this.filters.get(e);n||(n=new u(t)),s.set(e,n)}const i=Object(l.b)(e,t);for(const e of i.added){const t=s.get(e);t&&this.store.addFilter(t)}for(const e of i.removed){const t=this.filters.get(e);t&&(this.store.removeFilter(t),t.destroy())}this.filters=s}}),o.a.addListener(this.onTagsUpdated)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(66),i=s.n(n),o=s(48);class r{constructor(e,t){if(!e)throw new Error("No widgetId specified in widgetMessageEndpoint constructor");if(!t)throw new Error("No endpoint specified in widgetMessageEndpoint constructor");this.widgetId=e,this.endpointUrl=t}}var a=s(142),c=s(47),l=s(74),d=s(93),u=s(50),h=s(7),m=s(11);const p=["0.0.1","0.0.2"];class g{constructor(){this.widgetMessagingEndpoints=[],this.widgetListeners={},this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.onPostMessage=this.onPostMessage.bind(this)}start(){window.addEventListener("message",this.onPostMessage)}stop(){window.removeEventListener("message",this.onPostMessage)}addListener(e,t){this.widgetListeners[e]||(this.widgetListeners[e]=[]),this.widgetListeners[e].push(t)}removeListener(e,t){if(!this.widgetListeners[e])return;const s=this.widgetListeners[e].indexOf(t);-1!==s&&this.widgetListeners[e].splice(s,1)}addEndpoint(e,t){const s=i.a.parse(t);if(!s||!s.protocol||!s.host)return void console.warn("Add FromWidgetPostMessageApi endpoint - Invalid origin:",t);const n=s.protocol+"//"+s.host,o=new r(e,n);this.widgetMessagingEndpoints.some((function(s){return s.widgetId===e&&s.endpointUrl===t}))?console.warn("Add FromWidgetPostMessageApi - Endpoint already registered"):(console.log("Adding fromWidget messaging endpoint for "+e,o),this.widgetMessagingEndpoints.push(o))}removeEndpoint(e,t){const s=i.a.parse(t);if(!s||!s.protocol||!s.host)return void console.warn("Remove widget messaging endpoint - Invalid origin");const n=s.protocol+"//"+s.host;if(this.widgetMessagingEndpoints&&this.widgetMessagingEndpoints.length>0){const t=this.widgetMessagingEndpoints.length;return this.widgetMessagingEndpoints=this.widgetMessagingEndpoints.filter(t=>t.widgetId!==e||t.endpointUrl!==n),t>this.widgetMessagingEndpoints.length}return!1}onPostMessage(e){if(e.origin||(e.origin=e.originalEvent.origin),0===e.origin.length||!this.trustedEndpoint(e.origin)||"fromWidget"!==e.data.api||!e.data.widgetId)return;if(this.widgetListeners[e.data.action])for(const t of this.widgetListeners[e.data.action])t(e.data,e);e.data.requestId||console.warn("fromWidget action '"+e.data.action+"' does not have a requestId");const t=e.data.action,s=e.data.widgetId;if("content_loaded"===t)console.log("Widget reported content loaded for",s),o.a.dispatch({action:"widget_content_loaded",widgetId:s}),this.sendResponse(e,{success:!0});else if("supported_api_versions"===t)this.sendResponse(e,{api:"fromWidget",supported_versions:p});else if("api_version"===t)this.sendResponse(e,{api:"fromWidget",version:"0.0.2"});else if("m.sticker"===t){const t=e.data.data||e.data.widgetData;o.a.dispatch({action:"m.sticker",data:t,widgetId:e.data.widgetId})}else if("integration_manager_open"===t){o.a.dispatch({action:"stickerpicker_close"});const t=e.data.data||e.data.widgetData,s=t&&t.integType?t.integType:null,n=t&&t.integId?t.integId:null;u.a.getValue("feature_many_integration_managers")?d.a.sharedInstance().openAll(c.a.get().getRoom(l.a.getRoomId()),"type_"+s,n):d.a.sharedInstance().getPrimaryManager().open(c.a.get().getRoom(l.a.getRoomId()),"type_"+s,n)}else if("set_always_on_screen"===t){const t=e.data.data.value;a.a.widgetHasCapability(s,h.a.AlwaysOnScreen)&&a.a.setWidgetPersistence(s,t)}else"get_openid"===t||(console.warn("Widget postMessage event unhandled"),this.sendError(e,{message:"The postMessage was unhandled"}))}trustedEndpoint(e){return!!e&&this.widgetMessagingEndpoints.some(t=>t.endpointUrl===e)}sendResponse(e,t){const s=Object(m.a)(e.data);s.response=t,e.source.postMessage(s,e.origin)}sendError(e,t,s){console.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(m.a)(e.data);n.response={error:{message:t}},s&&(n.response.error._error=s),e.source.postMessage(n,e.origin)}}}]]);
//# sourceMappingURL=init.js.map